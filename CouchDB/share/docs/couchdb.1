.\" Man page generated from reStructuredText.
.
.
.nr rst2man-indent-level 0
.
.de1 rstReportMargin
\\$1 \\n[an-margin]
level \\n[rst2man-indent-level]
level margin: \\n[rst2man-indent\\n[rst2man-indent-level]]
-
\\n[rst2man-indent0]
\\n[rst2man-indent1]
\\n[rst2man-indent2]
..
.de1 INDENT
.\" .rstReportMargin pre:
. RS \\$1
. nr rst2man-indent\\n[rst2man-indent-level] \\n[an-margin]
. nr rst2man-indent-level +1
.\" .rstReportMargin post:
..
.de UNINDENT
. RE
.\" indent \\n[an-margin]
.\" old: \\n[rst2man-indent\\n[rst2man-indent-level]]
.nr rst2man-indent-level -1
.\" new: \\n[rst2man-indent\\n[rst2man-indent-level]]
.in \\n[rst2man-indent\\n[rst2man-indent-level]]u
..
.TH "APACHECOUCHDB" "1" "Nov 29, 2023" "3.3" "Apache CouchDB®"
.SH NAME
apachecouchdb \- Apache CouchDB® 3.3.0
.SH INTRODUCTION
.sp
CouchDB is a database that completely embraces the web. Store your data with
JSON documents. Access your documents with your web browser, \fI\%via HTTP\fP\&. \fI\%Query\fP, \fI\%combine\fP, and
\fI\%transform\fP your documents with \fI\%JavaScript\fP\&. CouchDB works well with modern web and mobile apps.  You
can distribute your data, efficiently using CouchDB’s \fI\%incremental
replication\fP\&. CouchDB supports master\-master setups with
\fI\%automatic conflict\fP detection.
.sp
CouchDB comes with a suite of features, such as on\-the\-fly document
transformation and real\-time \fI\%change notifications\fP, that make
web development a breeze. It even comes with an easy to use web administration
console, served directly out of CouchDB! We care a lot about \fI\%distributed
scaling\fP\&.  CouchDB is highly available and partition tolerant, but is also
\fI\%eventually consistent\fP\&. And we care \fIa lot\fP about
your data.  CouchDB has a fault\-tolerant storage engine that puts the safety
of your data first.
.sp
In this section you’ll learn about every basic bit of CouchDB, see upon what
conceptions and technologies it built and walk through short tutorial that
teach how to use CouchDB.
.SS Technical Overview
.SS Document Storage
.sp
A CouchDB server hosts named databases, which store \fBdocuments\fP\&.
Each document is uniquely named in the database, and CouchDB provides
a \fI\%RESTful\fP \fI\%HTTP API\fP for reading and updating (add, edit,
delete)  database documents.
.sp
Documents are the primary unit of data in CouchDB and consist of any number
of fields and attachments. Documents also include metadata that’s maintained
by the database system. Document fields are uniquely named and contain values
of \fI\%varying types\fP (text, number, boolean, lists, etc),
and there is no set limit to text size or element count.
.sp
The CouchDB document update model is lockless and optimistic.
Document edits are made by client applications loading documents,
applying changes, and saving them back to the database. If another client
editing the same document saves their changes first, the client gets an edit
conflict error on save. To resolve the update conflict, the latest document
version can be opened, the edits reapplied and the update tried again.
.sp
Single document updates (add, edit, delete) are all or nothing, either succeeding
entirely or failing completely. The database never contains partially saved
or edited documents.
.SS ACID Properties
.sp
The CouchDB file layout and commitment system features all \fIAtomic Consistent
Isolated Durable\fP (\fI\%ACID\fP) properties. On\-disk, CouchDB never overwrites
committed data or associated structures, ensuring the database file is always
in a consistent state. This is a “crash\-only” design where the CouchDB
server does not go through a shut down process, it’s simply terminated.
.sp
Document updates (add, edit, delete) are serialized, except for binary blobs
which are written concurrently. Database readers are never locked out and
never have to wait on writers or other readers. Any number of clients can be
reading documents without being locked out or interrupted by concurrent
updates, even on the same document. CouchDB read operations use a
\fIMulti\-Version Concurrency Control\fP (\fI\%MVCC\fP) model where each client sees a
consistent snapshot of the database from the beginning to the end of the read
operation. This means that CouchDB can guarantee transactional semantics on
a per\-document basis.
.sp
Documents are indexed in \fI\%B\-trees\fP by their name (DocID) and a Sequence ID.
Each update to a database instance generates a new sequential number.
Sequence IDs are used later for incrementally finding changes in a database.
These B\-tree indexes are updated simultaneously when documents are saved or
deleted. The index updates always occur at the end of the file (append\-only
updates).
.sp
Documents have the advantage of data being already conveniently packaged for
storage rather than split out across numerous tables and rows in most
database systems. When documents are committed to disk, the document fields
and metadata are packed into buffers, sequentially one document after another
(helpful later for efficient building of views).
.sp
When CouchDB documents are updated, all data and associated indexes are
flushed to disk and the transactional commit always leaves the database
in a completely consistent state. Commits occur in two steps:
.INDENT 0.0
.IP 1. 3
All document data and associated index updates are synchronously flushed
to disk.
.IP 2. 3
The updated database header is written in two consecutive, identical chunks
to make up the first 4k of the file, and then synchronously flushed to disk.
.UNINDENT
.sp
In the event of an OS crash or power failure during step 1,
the partially flushed updates are simply forgotten on restart. If such a
crash happens during step 2 (committing the header), a surviving copy of the
previous identical headers will remain, ensuring coherency of all previously
committed data. Excepting the header area, consistency checks or fix\-ups
after a crash or a power failure are never necessary.
.SS Compaction
.sp
Wasted space is recovered by occasional compaction. On schedule, or when the
database file exceeds a certain amount of wasted space, the compaction process
clones all the active data to a new file and then discards the old file.
The database remains completely online the entire time and all updates and
reads are allowed to complete successfully. The old database file is deleted
only when all the data has been copied and all users transitioned to the new
file.
.SS Views
.sp
ACID properties only deal with storage and updates, but we also need the ability
to show our data in interesting and useful ways. Unlike SQL databases where
data must be carefully decomposed into tables, data in CouchDB is stored in
semi\-structured documents. CouchDB documents are flexible and each has its
own implicit structure, which alleviates the most difficult problems and
pitfalls of bi\-directionally replicating table schemas and their contained data.
.sp
But beyond acting as a fancy file server, a simple document model for data
storage and sharing is too simple to build real applications on – it simply
doesn’t do enough of the things we want and expect. We want to slice and dice
and see our data in many different ways. What is needed is a way to filter,
organize and report on data that hasn’t been decomposed into tables.
.sp
\fBSEE ALSO:\fP
.INDENT 0.0
.INDENT 3.5
\fI\%Guide to Views\fP
.UNINDENT
.UNINDENT
.SS View Model
.sp
To address this problem of adding structure back to unstructured and
semi\-structured data, CouchDB integrates a view model. Views are the method
of aggregating and reporting on the documents in a database, and are built
on\-demand to aggregate, join and report on database documents. Because views
are built dynamically and don’t affect the underlying document, you can have
as many different view representations of the same data as you like.
.sp
View definitions are strictly virtual and only display the documents from the
current database instance, making them separate from the data they display
and compatible with replication. CouchDB views are defined inside special
\fBdesign documents\fP and can replicate across database instances like
regular documents, so that not only data replicates in CouchDB,
but entire application designs replicate too.
.SS JavaScript View Functions
.sp
Views are defined using JavaScript functions acting as the map part in a
\fI\%map\-reduce system\fP\&. A \fI\%view function\fP takes a CouchDB document
as an argument and then does whatever computation it needs to do to determine
the data that is to be made available through the view, if any.
It can add multiple rows to the view based on a single document,
or it can add no rows at all.
.sp
\fBSEE ALSO:\fP
.INDENT 0.0
.INDENT 3.5
\fI\%View Functions\fP
.UNINDENT
.UNINDENT
.SS View Indexes
.sp
Views are a dynamic representation of the actual document contents of a
database, and CouchDB makes it easy to create useful views of data.
But generating a view of a database with hundreds of thousands or millions of
documents is time and resource consuming, it’s not something the system
should do from scratch each time.
.sp
To keep view querying fast, the view engine maintains indexes of its views,
and incrementally updates them to reflect changes in the database.
CouchDB’s core design is largely optimized around the need for efficient,
incremental creation of views and their indexes.
.sp
Views and their functions are defined inside special “design” documents,
and a design document may contain any number of uniquely named view functions.
When a user opens a view and its index is automatically updated, all the views
in the same design document are indexed as a single group.
.sp
The view builder uses the database sequence ID to determine if the view group
is fully up\-to\-date with the database. If not, the view engine examines
all database documents (in packed sequential order) changed since the last
refresh. Documents are read in the order they occur in the disk file,
reducing the frequency and cost of disk head seeks.
.sp
The views can be read and queried simultaneously while also being refreshed.
If a client is slowly streaming out the contents of a large view,
the same view can be concurrently opened and refreshed for another client
without blocking the first client. This is true for any number of
simultaneous client readers, who can read and query the view while the index
is concurrently being refreshed for other clients without causing problems
for the readers.
.sp
As documents are processed by the view engine through your ‘map’ and ‘reduce’
functions, their previous row values are removed from the view indexes, if
they exist. If the document is selected by a view function, the function results
are inserted into the view as a new row.
.sp
When view index changes are written to disk, the updates are always appended
at the end of the file, serving to both reduce disk head seek times during
disk commits and to ensure crashes and power failures can not cause
corruption of indexes. If a crash occurs while updating a view index,
the incomplete index updates are simply lost and rebuilt incrementally from
its previously committed state.
.SS Security and Validation
.sp
To protect who can read and update documents, CouchDB has a simple reader
access and update validation model that can be extended to implement custom
security models.
.sp
\fBSEE ALSO:\fP
.INDENT 0.0
.INDENT 3.5
\fI\%/db/_security\fP
.UNINDENT
.UNINDENT
.SS Administrator Access
.sp
CouchDB database instances have administrator accounts. Administrator
accounts can create other administrator accounts and update design documents.
Design documents are special documents containing view definitions and other
special formulas, as well as regular fields and blobs.
.SS Update Validation
.sp
As documents are written to disk, they can be validated dynamically by
JavaScript functions for both security and data validation. When the document
passes all the formula validation criteria, the update is allowed to continue.
If the validation fails, the update is aborted and the user client gets an
error response.
.sp
Both the user’s credentials and the updated document are given as inputs to
the validation formula, and can be used to implement custom security models
by validating a user’s permissions to update a document.
.sp
A basic “author only” update document model is trivial to implement,
where document updates are validated to check if the user is listed in an
“author” field in the existing document. More dynamic models are also possible,
like checking a separate user account profile for permission settings.
.sp
The update validations are enforced for both live usage and replicated
updates, ensuring security and data validation in a shared, distributed system.
.sp
\fBSEE ALSO:\fP
.INDENT 0.0
.INDENT 3.5
\fI\%Validate Document Update Functions\fP
.UNINDENT
.UNINDENT
.SS Distributed Updates and Replication
.sp
CouchDB is a peer\-based distributed database system. It allows users and servers
to access and update the same shared data while disconnected. Those changes can
then be replicated bi\-directionally later.
.sp
The CouchDB document storage, view and security models are designed to work
together to make true bi\-directional replication efficient and reliable.
Both documents and designs can replicate, allowing full database applications
(including application design, logic and data) to be replicated to laptops
for offline use, or replicated to servers in remote offices where slow or
unreliable connections make sharing data difficult.
.sp
The replication process is incremental. At the database level,
replication only examines documents updated since the last replication.
If replication fails at any step, due to network
problems or crash for example, the next replication restarts at the last
checkpoint.
.sp
Partial replicas can be created and maintained. Replication can be filtered
by a JavaScript function, so that only particular documents or those meeting
specific criteria are replicated. This can allow users to take subsets of a
large shared database application offline for their own use, while maintaining
normal interaction with the application and that subset of data.
.SS Conflicts
.sp
Conflict detection and management are key issues for any distributed edit
system. The CouchDB storage system treats edit conflicts as a common state,
not an exceptional one. The conflict handling model is simple and
“non\-destructive” while preserving single document semantics and allowing for
decentralized conflict resolution.
.sp
CouchDB allows for any number of conflicting documents to exist
simultaneously in the database, with each database instance deterministically
deciding which document is the “winner” and which are conflicts. Only the
winning document can appear in views, while “losing” conflicts are still
accessible and remain in the database until deleted or purged during
database compaction. Because conflict documents are still regular documents,
they replicate just like regular documents and are subject to the same
security and validation rules.
.sp
When distributed edit conflicts occur, every database replica sees the same
winning revision and each has the opportunity to resolve the conflict.
Resolving conflicts can be done manually or, depending on the nature of the
data and the conflict, by automated agents. The system makes decentralized
conflict resolution possible while maintaining single document database
semantics.
.sp
Conflict management continues to work even if multiple disconnected users or
agents attempt to resolve the same conflicts. If resolved conflicts result in
more conflicts, the system accommodates them in the same manner, determining
the same winner on each machine and maintaining single document semantics.
.sp
\fBSEE ALSO:\fP
.INDENT 0.0
.INDENT 3.5
\fI\%Replication and conflict model\fP
.UNINDENT
.UNINDENT
.SS Applications
.sp
Using just the basic replication model, many traditionally single server
database applications can be made distributed with almost no extra work.
CouchDB replication is designed to be immediately useful for basic database
applications, while also being extendable for more elaborate and full\-featured
uses.
.sp
With very little database work, it is possible to build a distributed
document management application with granular security and full revision
histories. Updates to documents can be implemented to exploit incremental
field and blob replication, where replicated updates are nearly as efficient
and incremental as the actual edit differences (“diffs”).
.SS Implementation
.sp
CouchDB is built on the \fI\%Erlang OTP platform\fP, a functional,
concurrent programming language and development platform. Erlang was
developed for real\-time telecom applications with an extreme emphasis on
reliability and availability.
.sp
Both in syntax and semantics, Erlang is very different from conventional
programming languages like C or Java. Erlang uses lightweight “processes” and
message passing for concurrency, it has no shared state threading and all
data is immutable. The robust, concurrent nature of Erlang is ideal for a
database server.
.sp
CouchDB is designed for lock\-free concurrency, in the conceptual model and
the actual Erlang implementation. Reducing bottlenecks and avoiding locks
keeps the entire system working predictably under heavy loads. CouchDB can
accommodate many clients replicating changes, opening and updating documents,
and querying views whose indexes are simultaneously being refreshed for
other clients, without needing locks.
.sp
For higher availability and more concurrent users, CouchDB is designed for
“shared nothing” clustering. In a “shared nothing” cluster, each machine
is independent and replicates data with its cluster mates, allowing individual
server failures with zero downtime. And because consistency scans
and fix\-ups aren’t needed on restart,
if the entire cluster fails – due to a power outage in a datacenter,
for example – the entire CouchDB distributed system becomes immediately
available after a restart.
.sp
CouchDB is built from the start with a consistent vision of a distributed
document database system. Unlike cumbersome attempts to bolt distributed
features on top of the same legacy models and databases,
it is the result of careful ground\-up design, engineering and integration.
The document, view, security and replication models, the special purpose query
language, the efficient and robust disk layout and the concurrent and reliable
nature of the Erlang platform are all carefully integrated for a reliable
and efficient system.
.SS Why CouchDB?
.sp
Apache CouchDB is one of a new breed of database management systems.
This topic explains why there’s a need for new systems as well as the
motivations behind building CouchDB.
.sp
As CouchDB developers, we’re naturally very excited to be using CouchDB.
In this topic we’ll share with you the reasons for our enthusiasm.
We’ll show you how CouchDB’s schema\-free document model is a better fit
for common applications, how the built\-in query engine is a powerful way
to use and process your data, and how CouchDB’s design lends itself
to modularization and scalability.
.SS Relax
.sp
If there’s one word to describe CouchDB, it is \fIrelax\fP\&. It is the byline
to CouchDB’s official logo and when you start CouchDB, you see:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
Apache CouchDB has started. Time to relax.
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Why is relaxation important? Developer productivity roughly doubled in the
last five years. The chief reason for the boost is more powerful tools that
are easier to use. Take Ruby on Rails as an example. It is an infinitely
complex framework, but it’s easy to get started with. Rails is a success
story because of the core design focus on ease of use. This is one reason why
CouchDB is relaxing: learning CouchDB and understanding its core concepts
should feel natural to most everybody who has been doing any work on the Web.
And it is still pretty easy to explain to non\-technical people.
.sp
Getting out of the way when creative people try to build specialized
solutions is in itself a core feature and one thing that CouchDB aims to get
right. We found existing tools too cumbersome to work with during development
or in production, and decided to focus on making CouchDB easy, even a pleasure,
to use.
.sp
Another area of relaxation for CouchDB users is the production setting.
If you have a live running application, CouchDB again goes out of its way
to avoid troubling you. Its internal architecture is fault\-tolerant,
and failures occur in a controlled environment and are dealt with gracefully.
Single problems do not cascade through an entire server system but stay
isolated in single requests.
.sp
CouchDB’s core concepts are simple (yet powerful) and well understood.
Operations teams (if you have a team; otherwise, that’s you) do not have to
fear random behavior and untraceable errors. If anything should go wrong,
you can easily find out what the problem is, but these situations are rare.
.sp
CouchDB is also designed to handle varying traffic gracefully. For instance,
if a website is experiencing a sudden spike in traffic, CouchDB will generally
absorb a lot of concurrent requests without falling over. It may take a little
more time for each request, but they all get answered. When the spike is over,
CouchDB will work with regular speed again.
.sp
The third area of relaxation is growing and shrinking the underlying hardware
of your application. This is commonly referred to as scaling. CouchDB enforces
a set of limits on the programmer. On first look, CouchDB might seem
inflexible, but some features are left out by design for the simple reason
that if CouchDB supported them, it would allow a programmer to create
applications that couldn’t deal with scaling up or down.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
CouchDB doesn’t let you do things that would get you in trouble later on.
This sometimes means you’ll have to unlearn best practices you might have
picked up in your current or past work.
.UNINDENT
.UNINDENT
.SS A Different Way to Model Your Data
.sp
We believe that CouchDB will drastically change the way you build
document\-based applications. CouchDB combines an intuitive document storage
model with a powerful query engine in a way that’s so simple you’ll probably
be tempted to ask, “Why has no one built something like this before?”
.INDENT 0.0
.INDENT 3.5
Django may be built for the Web, but CouchDB is built of the Web. I’ve
never seen software that so completely embraces the philosophies behind
HTTP. CouchDB makes Django look old\-school in the same way that Django
makes ASP look outdated.
\(em Jacob Kaplan\-Moss, Django developer
.UNINDENT
.UNINDENT
.sp
CouchDB’s design borrows heavily from web architecture and the concepts of
resources, methods, and representations. It augments this with powerful ways
to query, map, combine, and filter your data. Add fault tolerance, extreme
scalability, and incremental replication, and CouchDB defines a sweet spot
for document databases.
.SS A Better Fit for Common Applications
.sp
We write software to improve our lives and the lives of others. Usually this
involves taking some mundane information such as contacts, invoices,
or receipts and manipulating it using a computer application. CouchDB is a
great fit for common applications like this because it embraces the natural
idea of evolving, self\-contained documents as the very core of its data model.
.SS Self\-Contained Data
.sp
An invoice contains all the pertinent information about a single transaction
the seller, the buyer, the date, and a list of the items or services sold.
As shown in \fI\%Figure 1. Self\-contained documents\fP, there’s no abstract reference on this
piece of paper that points to some other piece of paper with the seller’s
name and address. Accountants appreciate the simplicity of having everything
in one place. And given the choice, programmers appreciate that, too.
.INDENT 0.0
.INDENT 2.5
[image: Self-contained documents]
[image]
Figure 1. Self\-contained documents.UNINDENT
.UNINDENT
.sp
Yet using references is exactly how we model our data in a relational
database! Each invoice is stored in a table as a row that refers to other
rows in other tables one row for seller information, one for the buyer,
one row for each item billed, and more rows still to describe the item
details, manufacturer details, and so on and so forth.
.sp
This isn’t meant as a detraction of the relational model, which is widely
applicable and extremely useful for a number of reasons. Hopefully, though, it
illustrates the point that sometimes your model may not “fit” your data
in the way it occurs in the real world.
.sp
Let’s take a look at the humble contact database to illustrate a different
way of modeling data, one that more closely “fits” its real\-world counterpart
– a pile of business cards. Much like our invoice example, a business card
contains all the important information, right there on the cardstock.
We call this “self\-contained” data, and it’s an important concept
in understanding document databases like CouchDB.
.SS Syntax and Semantics
.sp
Most business cards contain roughly the same information – someone’s identity,
an affiliation, and some contact information. While the exact form of this
information can vary between business cards, the general information being
conveyed remains the same, and we’re easily able to recognize it as a
business card. In this sense, we can describe a business card as a \fIreal\-world
document\fP\&.
.sp
Jan’s business card might contain a phone number but no fax number,
whereas J. Chris’s business card contains both a phone and a fax number. Jan
does not have to make his lack of a fax machine explicit by writing something
as ridiculous as “Fax: None” on the business card. Instead, simply omitting
a fax number implies that he doesn’t have one.
.sp
We can see that real\-world documents of the same type, such as business cards,
tend to be very similar in \fIsemantics\fP – the sort of information they carry,
but can vary hugely in \fIsyntax\fP, or how that information is structured. As human
beings, we’re naturally comfortable dealing with this kind of variation.
.sp
While a traditional relational database requires you to model your data
\fIup front\fP, CouchDB’s schema\-free design unburdens you with a powerful way to
aggregate your data \fIafter the fact\fP, just like we do with real\-world
documents. We’ll look in depth at how to design applications with this
underlying storage paradigm.
.SS Building Blocks for Larger Systems
.sp
CouchDB is a storage system useful on its own. You can build many applications
with the tools CouchDB gives you. But CouchDB is designed with a bigger picture
in mind. Its components can be used as building blocks that solve storage
problems in slightly different ways for larger and more complex systems.
.sp
Whether you need a system that’s crazy fast but isn’t too concerned with
reliability (think logging), or one that guarantees storage in two or more
physically separated locations for reliability, but you’re willing to take a
performance hit, CouchDB lets you build these systems.
.sp
There are a multitude of knobs you could turn to make a system work better in
one area, but you’ll affect another area when doing so. One example would be
the CAP theorem discussed in \fI\%Eventual Consistency\fP\&. To give you an idea of
other things that affect storage systems, see
\fI\%Figure 2\fP and \fI\%Figure 3\fP\&.
.sp
By reducing latency for a given system (and that is true not only for storage
systems), you affect concurrency and throughput capabilities.
.INDENT 0.0
.INDENT 2.5
[image: Throughput, latency, or concurrency]
[image]
Figure 2. Throughput, latency, or concurrency.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 2.5
[image: Scaling: read requests, write requests, or data]
[image]
Figure 3. Scaling: read requests, write requests, or data.UNINDENT
.UNINDENT
.sp
When you want to scale out, there are three distinct issues to deal with:
scaling read requests, write requests, and data. Orthogonal to all three and
to the items shown in \fI\%Figure 2\fP and \fI\%Figure 3\fP are many more attributes like reliability or simplicity.
You can draw many of these graphs that show how different features or attributes
pull into different directions and thus shape the system they describe.
.sp
CouchDB is very flexible and gives you enough building blocks to create a
system shaped to suit your exact problem. That’s not saying that CouchDB can
be bent to solve any problem – CouchDB is no silver bullet – but in the
area of data storage, it can get you a long way.
.SS CouchDB Replication
.sp
CouchDB replication is one of these building blocks. Its fundamental function
is to synchronize two or more CouchDB databases. This may sound simple,
but the simplicity is key to allowing replication to solve a number of
problems: reliably synchronize databases between multiple machines for
redundant data storage; distribute data to a cluster of CouchDB instances
that share a subset of the total number of requests that hit the cluster
(load balancing); and distribute data between physically distant locations,
such as one office in New York and another in Tokyo.
.sp
CouchDB replication uses the same REST API all clients use. HTTP is
ubiquitous and well understood. Replication works incrementally; that is,
if during replication anything goes wrong, like dropping your network
connection, it will pick up where it left off the next time it runs. It also
only transfers data that is needed to synchronize databases.
.sp
A core assumption CouchDB makes is that things can go wrong,
like network connection troubles, and it is designed for graceful error
recovery instead of assuming all will be well. The replication system’s
incremental design shows that best. The ideas behind “things that can go
wrong” are embodied in the \fI\%Fallacies of Distributed Computing\fP:
.INDENT 0.0
.IP \(bu 2
The network is reliable.
.IP \(bu 2
Latency is zero.
.IP \(bu 2
Bandwidth is infinite.
.IP \(bu 2
The network is secure.
.IP \(bu 2
Topology doesn’t change.
.IP \(bu 2
There is one administrator.
.IP \(bu 2
Transport cost is zero.
.IP \(bu 2
The network is homogeneous.
.UNINDENT
.sp
Existing tools often try to hide the fact that there is a network and that
any or all of the previous conditions don’t exist for a particular system.
This usually results in fatal error scenarios when something finally goes
wrong. In contrast, CouchDB doesn’t try to hide the network; it just handles
errors gracefully and lets you know when actions on your end are required.
.SS Local Data Is King
.sp
CouchDB takes quite a few lessons learned from the Web,
but there is one thing that could be improved about the Web: latency.
Whenever you have to wait for an application to respond or a website to
render, you almost always wait for a network connection that isn’t as fast as
you want it at that point. Waiting a few seconds instead of milliseconds
greatly affects user experience and thus user satisfaction.
.sp
What do you do when you are offline? This happens all the time – your DSL or
cable provider has issues, or your iPhone, G1, or Blackberry has no bars,
and no connectivity means no way to get to your data.
.sp
CouchDB can solve this scenario as well, and this is where scaling is
important again. This time it is scaling down. Imagine CouchDB installed on
phones and other mobile devices that can synchronize data with centrally
hosted CouchDBs when they are on a network. The synchronization is not bound
by user interface constraints like sub\-second response times. It is easier to
tune for high bandwidth and higher latency than for low bandwidth and very
low latency. Mobile applications can then use the local CouchDB to fetch
data, and since no remote networking is required for that,
latency is low by default.
.sp
Can you really use CouchDB on a phone? Erlang, CouchDB’s implementation
language has been designed to run on embedded devices magnitudes smaller and
less powerful than today’s phones.
.SS Wrapping Up
.sp
The next document \fI\%Eventual Consistency\fP further explores the distributed
nature of CouchDB. We should have given you enough bites to whet your interest.
Let’s go!
.SS Eventual Consistency
.sp
In the previous document \fI\%Why CouchDB?\fP, we saw that CouchDB’s flexibility
allows us to evolve our data as our applications grow and change. In this topic,
we’ll explore how working “with the grain” of CouchDB promotes simplicity in
our applications and helps us naturally build scalable, distributed systems.
.SS Working with the Grain
.sp
A \fIdistributed system\fP is a system that operates robustly over a wide network.
A particular feature of network computing is that network links can
potentially disappear, and there are plenty of strategies for managing this
type of network segmentation. CouchDB differs from others by accepting
eventual consistency, as opposed to putting absolute consistency ahead of raw
availability, like \fI\%RDBMS\fP or \fI\%Paxos\fP\&. What these systems have in common is
an awareness that data acts differently when many people are accessing it
simultaneously. Their approaches differ when it comes to which aspects of
\fIconsistency\fP, \fIavailability\fP, or \fIpartition\fP tolerance they prioritize.
.sp
Engineering distributed systems is tricky. Many of the caveats and “gotchas”
you will face over time aren’t immediately obvious. We don’t have all the
solutions, and CouchDB isn’t a panacea, but when you work with CouchDB’s
grain rather than against it, the path of least resistance leads you to
naturally scalable applications.
.sp
Of course, building a distributed system is only the beginning. A website
with a database that is available only half the time is next to worthless.
Unfortunately, the traditional relational database approach to consistency
makes it very easy for application programmers to rely on global state,
global clocks, and other high availability no\-nos, without even realizing
that they’re doing so. Before examining how CouchDB promotes scalability,
we’ll look at the constraints faced by a distributed system. After we’ve seen
the problems that arise when parts of your application can’t rely on being
in constant contact with each other, we’ll see that CouchDB provides an
intuitive and useful way for modeling applications around high availability.
.SS The CAP Theorem
.sp
The CAP theorem describes a few different strategies for distributing
application logic across networks. CouchDB’s solution uses replication to
propagate application changes across participating nodes. This is a
fundamentally different approach from consensus algorithms and relational
databases, which operate at different intersections of consistency,
availability, and partition tolerance.
.sp
The CAP theorem, shown in \fI\%Figure 1. The CAP theorem\fP,
identifies three distinct concerns:
.INDENT 0.0
.IP \(bu 2
\fBConsistency\fP:
All database clients see the same data, even with concurrent updates.
.IP \(bu 2
\fBAvailability\fP:
All database clients are able to access some version of the data.
.IP \(bu 2
\fBPartition tolerance\fP:
The database can be split over multiple servers.
.UNINDENT
.sp
Pick two.
.INDENT 0.0
.INDENT 2.5
[image: The CAP theorem]
[image]
Figure 1. The CAP theorem.UNINDENT
.UNINDENT
.sp
When a system grows large enough that a single database node is unable to
handle the load placed on it, a sensible solution is to add more servers.
When we add nodes, we have to start thinking about how to partition data
between them. Do we have a few databases that share exactly the same data?
Do we put different sets of data on different database servers?
Do we let only certain database servers write data and let others handle
the reads?
.sp
Regardless of which approach we take, the one problem we’ll keep bumping into
is that of keeping all these database servers in sync. If you write some
information to one node, how are you going to make sure that a read request
to another database server reflects this newest information? These events
might be milliseconds apart. Even with a modest collection of database
servers, this problem can become extremely complex.
.sp
When it’s absolutely critical that all clients see a consistent view of the
database, the users of one node will have to wait for any other nodes to come
into agreement before being able to read or write to the database.
In this instance, we see that availability takes a backseat to consistency.
However, there are situations where availability trumps consistency:
.INDENT 0.0
.INDENT 3.5
Each node in a system should be able to make decisions purely based on
local state. If you need to do something under high load with failures
occurring and you need to reach agreement, you’re lost. If you’re
concerned about scalability, any algorithm that forces you to run
agreement will eventually become your bottleneck. Take that as a given.
\(em Werner Vogels, Amazon CTO and Vice President
.UNINDENT
.UNINDENT
.sp
If availability is a priority, we can let clients write data to one node of
the database without waiting for other nodes to come into agreement.
If the database knows how to take care of reconciling these operations between
nodes, we achieve a sort of “eventual consistency” in exchange for high
availability. This is a surprisingly applicable trade\-off for many applications.
.sp
Unlike traditional relational databases, where each action performed is
necessarily subject to database\-wide consistency checks,
CouchDB makes it really simple to build applications that sacrifice immediate
consistency for the huge performance improvements that come with simple
distribution.
.SS Local Consistency
.sp
Before we attempt to understand how CouchDB operates in a cluster,
it’s important that we understand the inner workings of a single CouchDB node.
The CouchDB API is designed to provide a convenient but thin wrapper around
the database core. By taking a closer look at the structure of the database
core, we’ll have a better understanding of the API that surrounds it.
.SS The Key to Your Data
.sp
At the heart of CouchDB is a powerful \fIB\-tree\fP storage engine.
A B\-tree is a sorted data structure that allows for searches, insertions,
and deletions in logarithmic time. As \fI\%Figure 2. Anatomy of a view request\fP
illustrates, CouchDB uses this B\-tree storage engine for all internal data,
documents, and views. If we understand one, we will understand them all.
.INDENT 0.0
.INDENT 2.5
[image: Anatomy of a view request]
[image]
Figure 2. Anatomy of a view request.UNINDENT
.UNINDENT
.sp
CouchDB uses MapReduce to compute the results of a view. MapReduce makes use
of two functions, “map” and “reduce”, which are applied to each document in
isolation. Being able to isolate these operations means that view computation
lends itself to parallel and incremental computation. More important,
because these functions produce key/value pairs, CouchDB is able to insert
them into the B\-tree storage engine, sorted by key. Lookups by key,
or key range, are extremely efficient operations with a B\-tree,
described in \fIbig O\fP notation as \fBO(log N)\fP and \fBO(log N + K)\fP,
respectively.
.sp
In CouchDB, we access documents and view results by key or key range.
This is a direct mapping to the underlying operations performed on CouchDB’s
B\-tree storage engine. Along with document inserts and updates,
this direct mapping is the reason we describe CouchDB’s API as being a thin
wrapper around the database core.
.sp
Being able to access results by key alone is a very important restriction
because it allows us to make huge performance gains. As well as the massive
speed improvements, we can partition our data over multiple nodes,
without affecting our ability to query each node in isolation.
\fI\%BigTable\fP, \fI\%Hadoop\fP, \fI\%SimpleDB\fP, and \fI\%memcached\fP restrict object lookups
by key for  exactly these reasons.
.SS No Locking
.sp
A table in a relational database is a single data structure. If you want to
modify a table – say, update a row – the database system must ensure
that nobody else is trying to update that row and that nobody can read from
that row while it is being updated. The common way to handle this uses what’s
known as a lock. If multiple clients want to access a table, the first client
gets the lock, making everybody else wait. When the first client’s request is
processed, the next client is given access while everybody else waits,
and so on. This serial execution of requests, even when they arrived in
parallel, wastes a significant amount of your server’s processing power.
Under high load, a relational database can spend more time figuring out who
is allowed to do what, and in which order, than it does doing any actual work.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Modern relational databases avoid locks by implementing MVCC under
the hood, but hide it from the end user, requiring them to coordinate
concurrent changes of single rows or fields.
.UNINDENT
.UNINDENT
.sp
Instead of locks, CouchDB uses \fIMulti\-Version Concurrency Control\fP (MVCC) to
manage concurrent access to the database. \fI\%Figure 3. MVCC means no locking\fP
illustrates the differences between MVCC and traditional locking mechanisms.
MVCC means that CouchDB can run at full speed, all the time,
even under high load. Requests are run in parallel, making excellent use of
every last drop of processing power your server has to offer.
.INDENT 0.0
.INDENT 2.5
[image: MVCC means no locking]
[image]
Figure 3. MVCC means no locking.UNINDENT
.UNINDENT
.sp
Documents in CouchDB are versioned, much like they would be in a regular
version control system such as \fI\%Subversion\fP\&. If you want to change
a value in a document, you create an entire new version of that document
and save it over the old one. After doing this, you end up with two versions
of the same document, one old and one new.
.sp
How does this offer an improvement over locks? Consider a set of requests
wanting to access a document. The first request reads the document.
While this is being processed, a second request changes the document.
Since the second request includes a completely new version of the document,
CouchDB can simply append it to the database without having to wait for the
read request to finish.
.sp
When a third request wants to read the same document, CouchDB will point it
to the new version that has just been written. During this whole process,
the first request could still be reading the original version.
.sp
A read request will always see the most recent snapshot of your database at
the time of the beginning of the request.
.SS Validation
.sp
As application developers, we have to think about what sort of input we
should accept and what we should reject. The expressive power to do this type
of validation over complex data within a traditional relational database
leaves a lot to be desired. Fortunately, CouchDB provides a powerful way to
perform per\-document validation from within the database.
.sp
CouchDB can validate documents using JavaScript functions similar to those
used for MapReduce. Each time you try to modify a document,
CouchDB will pass the validation function a copy of the existing document,
a copy of the new document, and a collection of additional information,
such as user authentication details. The validation function now has the
opportunity to approve or deny the update.
.sp
By working with the grain and letting CouchDB do this for us,
we save ourselves a tremendous amount of CPU cycles that would otherwise have
been spent serializing object graphs from SQL, converting them into domain
objects, and using those objects to do application\-level validation.
.SS Distributed Consistency
.sp
Maintaining consistency within a single database node is relatively easy for
most databases. The real problems start to surface when you try to maintain
consistency between multiple database servers. If a client makes a write
operation on server \fIA\fP, how do we make sure that this is consistent with
server \fIB\fP, or \fIC\fP, or \fID\fP? For relational databases, this is a very complex
problem with entire books devoted to its solution. You could use
multi\-master, single\-master, partitioning, sharding, write\-through caches,
and all sorts of other complex techniques.
.SS Incremental Replication
.sp
CouchDB’s operations take place within the context of a single document.
As CouchDB achieves eventual consistency between multiple databases by using
incremental replication you no longer have to worry about your database
servers being able to stay in constant communication. Incremental replication
is a process where document changes are periodically copied between servers.
We are able to build what’s known as a \fIshared nothing\fP cluster of databases
where each node is independent and self\-sufficient, leaving no single point
of contention across the system.
.sp
Need to scale out your CouchDB database cluster? Just throw in another server.
.sp
As illustrated in \fI\%Figure 4. Incremental replication between CouchDB nodes\fP, with CouchDB’s incremental
replication, you can synchronize your data between any two databases however
you like and whenever you like. After replication, each database is able
to work independently.
.sp
You could use this feature to synchronize database servers within a cluster
or between data centers using a job scheduler such as cron,
or you could use it to synchronize data with your laptop for offline work as
you travel. Each database can be used in the usual fashion,
and changes between databases can be synchronized later in both directions.
.INDENT 0.0
.INDENT 2.5
[image: Incremental replication between CouchDB nodes]
[image]
Figure 4. Incremental replication between CouchDB nodes.UNINDENT
.UNINDENT
.sp
What happens when you change the same document in two different databases and
want to synchronize these with each other? CouchDB’s replication system
comes with automatic conflict detection and resolution. When CouchDB detects
that a document has been changed in both databases, it flags this document
as being in conflict, much like they would be in a regular version control
system.
.sp
This isn’t as troublesome as it might first sound. When two versions of a
document conflict during replication, the winning version is saved as the
most recent version in the document’s history. Instead of throwing the losing
version away, as you might expect, CouchDB saves this as a previous version
in the document’s history, so that you can access it if you need to. This
happens automatically and consistently, so both databases will make exactly
the same choice.
.sp
It is up to you to handle conflicts in a way that makes sense for your
application. You can leave the chosen document versions in place,
revert to the older version, or try to merge the two versions and save the
result.
.SS Case Study
.sp
Greg Borenstein, a friend and coworker, built a small library for converting
Songbird playlists to JSON objects and decided to store these in CouchDB as
part of a backup application. The completed software uses CouchDB’s MVCC and
document revisions to ensure that Songbird playlists are backed up robustly
between nodes.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
\fI\%Songbird\fP is a free software media player with an integrated web browser,
based on the Mozilla XULRunner platform. Songbird is available for Microsoft
Windows, Apple Mac OS X, Solaris, and Linux.
.UNINDENT
.UNINDENT
.sp
Let’s examine the workflow of the Songbird backup application,
first as a user backing up from a single computer, and then using Songbird to
synchronize playlists between multiple computers. We’ll see how document
revisions turn what could have been a hairy problem into something that \fIjust
works\fP\&.
.sp
The first time we use this backup application, we feed our playlists to the
application and initiate a backup. Each playlist is converted to a JSON
object and handed to a CouchDB database. As illustrated in
\fI\%Figure 5. Backing up to a single database\fP, CouchDB hands back the document ID and
revision of each playlist as it’s saved to the database.
.INDENT 0.0
.INDENT 2.5
[image: Backing up to a single database]
[image]
Figure 5. Backing up to a single database.UNINDENT
.UNINDENT
.sp
After a few days, we find that our playlists have been updated and we want to
back up our changes. After we have fed our playlists to the backup
application, it fetches the latest versions from CouchDB,
along with the corresponding document revisions. When the application hands
back the new playlist document, CouchDB requires that the document revision
is included in the request.
.sp
CouchDB then makes sure that the document revision handed to it in the
request matches the current revision held in the database. Because CouchDB
updates the revision with every modification, if these two are out of sync it
suggests that someone else has made changes to the document between the time
we requested it from the database and the time we sent our updates. Making
changes to a document after someone else has modified it without first
inspecting those changes is usually a bad idea.
.sp
Forcing clients to hand back the correct document revision is the heart of
CouchDB’s optimistic concurrency.
.sp
We have a laptop we want to keep synchronized with our desktop computer.
With all our playlists on our desktop, the first step is to
“restore from backup” onto our laptop. This is the first time we’ve done this,
so afterward our laptop  should hold an exact replica of our desktop playlist
collection.
.sp
After editing our Argentine Tango playlist on our laptop to add a few new
songs we’ve purchased, we want to save our changes. The backup application
replaces the playlist document in our laptop CouchDB database and a new
document revision is generated. A few days later, we remember our new songs
and want to copy the playlist across to our desktop computer. As illustrated
in \fI\%Figure 6. Synchronizing between two databases\fP, the backup application copies the new document
and the new revision to the desktop CouchDB database. Both CouchDB databases
now have the same document revision.
.INDENT 0.0
.INDENT 2.5
[image: Synchronizing between two databases]
[image]
Figure 6. Synchronizing between two databases.UNINDENT
.UNINDENT
.sp
Because CouchDB tracks document revisions, it ensures that updates like these
will work only if they are based on current information. If we had made
modifications to the playlist backups between synchronization,
things wouldn’t go as smoothly.
.sp
We back up some changes on our laptop and forget to synchronize. A few days
later, we’re editing playlists on our desktop computer, make a backup,
and want to synchronize this to our laptop. As illustrated in
\fI\%Figure 7. Synchronization conflicts between two databases\fP, when our backup application tries to replicate
between the two databases, CouchDB sees that the changes being sent from our
desktop computer are modifications of out\-of\-date documents and helpfully
informs us that there has been a conflict.
.sp
Recovering from this error is easy to accomplish from an application
perspective. Just download CouchDB’s version of the playlist and provide an
opportunity to merge the changes or save local modifications into a new
playlist.
.INDENT 0.0
.INDENT 2.5
[image: Synchronization conflicts between two databases]
[image]
Figure 7. Synchronization conflicts between two databases.UNINDENT
.UNINDENT
.SS Wrapping Up
.sp
CouchDB’s design borrows heavily from web architecture and the lessons
learned deploying massively distributed systems on that architecture.
By understanding why this architecture works the way it does,
and by learning to spot which parts of your application can be easily
distributed and which parts cannot, you’ll enhance your ability to design
distributed and scalable applications, with CouchDB or without it.
.sp
We’ve covered the main issues surrounding CouchDB’s consistency model and
hinted at some of the benefits to be had when you work \fIwith\fP CouchDB and not
against it. But enough theory – let’s get up and running and see what all the
fuss is about!
.SS cURL: Your Command Line Friend
.sp
The \fBcurl\fP utility is a command line tool available on Unix, Linux, Mac OS X,
Windows, and many other platforms. \fBcurl\fP provides easy access to the HTTP
protocol (among others) directly from the command line and is therefore an
ideal way of interacting with CouchDB over the HTTP REST API.
.sp
For simple \fBGET\fP requests you can supply the URL of the request. For example,
to get the database information:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
shell> curl http://admin:password@127.0.0.1:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This returns the database information (formatted in the output below for
clarity):
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
  \(dqcouchdb\(dq: \(dqWelcome\(dq,
  \(dqversion\(dq: \(dq3.0.0\(dq,
  \(dqgit_sha\(dq: \(dq83bdcf693\(dq,
  \(dquuid\(dq: \(dq56f16e7c93ff4a2dc20eb6acc7000b71\(dq,
  \(dqfeatures\(dq: [
    \(dqaccess\-ready\(dq,
    \(dqpartitioned\(dq,
    \(dqpluggable\-storage\-engines\(dq,
    \(dqreshard\(dq,
    \(dqscheduler\(dq
  ],
  \(dqvendor\(dq: {
    \(dqname\(dq: \(dqThe Apache Software Foundation\(dq
  }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
For some URLs, especially those that include special characters such as
ampersand, exclamation mark, or question mark, you should quote the URL you
are specifying on the command line. For example:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
shell> curl \(aqhttp://couchdb:5984/_uuids?count=5\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
On Microsoft Windows, use double\-quotes anywhere you see single\-quotes in
the following examples. Use doubled double\-quotes (“”) anywhere you see
single double\-quotes. For example, if you see:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
shell> curl \-X PUT \(aqhttp://127.0.0.1:5984/demo/doc\(aq \-d \(aq{\(dqmotto\(dq: \(dqI love gnomes\(dq}\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
you should replace it with:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
shell> curl \-X PUT \(dqhttp://127.0.0.1:5984/demo/doc\(dq \-d \(dq{\(dq\(dqmotto\(dq\(dq: \(dq\(dqI love gnomes\(dq\(dq}\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If you prefer, \fB^\(dq\fP and \fB\e\(dq\fP may be used to escape the double\-quote
character in quoted strings instead.
.UNINDENT
.UNINDENT
.sp
You can explicitly set the HTTP command using the \fB\-X\fP command line option.
For example, when creating a database, you set the name of the database in the
URL you send using a PUT request:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
shell> curl \-X PUT http://user:pass@127.0.0.1:5984/demo
{\(dqok\(dq:true}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
But to obtain the database information you use a \fBGET\fP request (with
the return information formatted for clarity):
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
shell> curl \-X GET http://user:pass@127.0.0.1:5984/demo
{
    \(dqcompact_running\(dq : false,
    \(dqdoc_count\(dq : 0,
    \(dqdb_name\(dq : \(dqdemo\(dq,
    \(dqpurge_seq\(dq : 0,
    \(dqcommitted_update_seq\(dq : 0,
    \(dqdoc_del_count\(dq : 0,
    \(dqdisk_format_version\(dq : 5,
    \(dqupdate_seq\(dq : 0,
    \(dqinstance_start_time\(dq : \(dq0\(dq,
    \(dqdisk_size\(dq : 79
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
For certain operations, you must specify the content type of request, which you
do by specifying the \fBContent\-Type\fP header using the \fB\-H\fP command\-line
option:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
shell> curl \-H \(aqContent\-Type: application/json\(aq http://127.0.0.1:5984/_uuids
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You can also submit ‘payload’ data, that is, data in the body of the HTTP
request using the \fB\-d\fP option. This is useful if you need to submit JSON
structures, for example document data, as part of the request. For example, to
submit a simple document to the \fBdemo\fP database:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
shell> curl \-H \(aqContent\-Type: application/json\(aq \e
            \-X POST http://user:pass@127.0.0.1:5984/demo \e
            \-d \(aq{\(dqcompany\(dq: \(dqExample, Inc.\(dq}\(aq
{\(dqok\(dq:true,\(dqid\(dq:\(dq8843faaf0b831d364278331bc3001bd8\(dq,
 \(dqrev\(dq:\(dq1\-33b9fbce46930280dab37d672bbc8bb9\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
In the above example, the argument after the \fB\-d\fP option is the JSON of the
document we want to submit.
.sp
The document can be accessed by using the automatically generated document ID
that was returned:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
shell> curl \-X GET http://user:pass@127.0.0.1:5984/demo/8843faaf0b831d364278331bc3001bd8
{\(dq_id\(dq:\(dq8843faaf0b831d364278331bc3001bd8\(dq,
 \(dq_rev\(dq:\(dq1\-33b9fbce46930280dab37d672bbc8bb9\(dq,
 \(dqcompany\(dq:\(dqExample, Inc.\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The API samples in the \fI\%API Basics\fP show the HTTP command, URL and any
payload information that needs to be submitted (and the expected return value).
All of these examples can be reproduced using \fBcurl\fP with the command\-line
examples shown above.
.SS Security
.sp
In this document, we’ll look at the basic security mechanisms in CouchDB:
\fIBasic Authentication\fP and \fICookie Authentication\fP\&. This is how CouchDB
handles users and protects their credentials.
.SS Authentication
.sp
CouchDB has the idea of an \fIadmin user\fP (e.g. an administrator, a super user,
or root) that is allowed to do anything to a CouchDB installation. By default,
one admin user \fBmust\fP be created for CouchDB to start up successfully.
.sp
CouchDB also defines a set of requests that only admin users are allowed to
do. If you have defined one or more specific admin users, CouchDB will ask for
identification for certain requests:
.INDENT 0.0
.IP \(bu 2
Creating a database (\fI\%PUT /database\fP)
.IP \(bu 2
Deleting a database (\fI\%DELETE /database\fP)
.IP \(bu 2
Setup a database security (\fI\%PUT /database/_security\fP)
.IP \(bu 2
Creating a design document (\fI\%PUT /database/_design/app\fP)
.IP \(bu 2
Updating a design document (\fI\%PUT /database/_design/app?rev=1\-4E2\fP)
.IP \(bu 2
Deleting a design document (\fI\%DELETE /database/_design/app?rev=2\-6A7\fP)
.IP \(bu 2
Triggering compaction (\fI\%POST /database/_compact\fP)
.IP \(bu 2
Reading the task status list (\fI\%GET /_active_tasks\fP)
.IP \(bu 2
Restarting the server on a given node (\fI\%POST /_node/{node\-name}/_restart\fP)
.IP \(bu 2
Reading the active configuration (\fI\%GET /_node/{node\-name}/_config\fP)
.IP \(bu 2
Updating the active configuration (\fI\%PUT /_node/{node\-name}/_config/{section}/{key}\fP)
.UNINDENT
.SS Creating a New Admin User
.sp
If your installation process did not set up an admin user, you will have to add
one to the configuration file by hand and restart CouchDB first. For the purposes of
this example, we’ll create a default \fBadmin\fP user with the password \fBpassword\fP\&.
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
Don’t just type in the following without thinking! Pick a good name for your
administrator user that isn’t easily guessable, and pick a secure password.
.UNINDENT
.UNINDENT
.sp
To the end of your \fBetc/local.ini\fP file, after the \fB[admins]\fP line, add the text
\fBadmin = password\fP, so it looks like this:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[admins]
admin = password
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
(Don’t worry about the password being in plain text; we’ll come back to this.)
.sp
Now, restart CouchDB using the method appropriate for your operating system.
You should now be able to access CouchDB using your new administrator account:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
> curl http://admin:password@127.0.0.1:5984/_up
{\(dqstatus\(dq:\(dqok\(dq,\(dqseeds\(dq:{}}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Great!
.sp
Let’s create an admin user through the HTTP API. We’ll call her \fBanna\fP, and
her password is \fBsecret\fP\&.  Note the double quotes in the following code; they
are needed to denote a string value for the \fI\%configuration API\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
> HOST=\(dqhttp://admin:password@127.0.0.1:5984\(dq
> NODENAME=\(dq_local\(dq
> curl \-X PUT $HOST/_node/$NODENAME/_config/admins/anna \-d \(aq\(dqsecret\(dq\(aq
\(dq\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
As per the \fI\%_config\fP API’s behavior, we’re getting the previous value
for the config item we just wrote. Since our admin user didn’t exist, we get an empty
string.
.sp
Please note that \fB_local\fP serves as an  alias for the local node name, so for all
configuration URLs, \fBNODENAME\fP may be set to \fB_local\fP, to interact with the local
node’s configuration.
.sp
\fBSEE ALSO:\fP
.INDENT 0.0
.INDENT 3.5
\fI\%Node Management\fP
.UNINDENT
.UNINDENT
.SS Hashing Passwords
.sp
Seeing the plain\-text password is scary, isn’t it? No worries, CouchDB doesn’t
show the plain\-text password anywhere. It gets hashed right away. Go ahead and
look at your \fBlocal.ini\fP file now. You’ll see that CouchDB has rewritten the
plain text passwords so they are hashed:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[admins]
admin = \-pbkdf2\-71c01cb429088ac1a1e95f3482202622dc1e53fe,226701bece4ae0fc9a373a5e02bf5d07,10
anna = \-pbkdf2\-2d86831c82b440b8887169bd2eebb356821d621b,5e11b9a9228414ab92541beeeacbf125,10
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The hash is that big, ugly, long string that starts out with \fB\-pbkdf2\-\fP\&.
.sp
To compare a plain\-text password during authentication with the stored hash,
the hashing algorithm is run and the resulting hash is compared to the stored
hash. The probability of two identical hashes for different passwords is too
insignificant to mention (c.f. \fI\%Bruce Schneier\fP). Should the stored hash fall
into the hands of an attacker, it is, by current standards, way too inconvenient
(i.e., it’d take a lot of money and time) to find the plain\-text password from
the hash.
.sp
When CouchDB starts up, it reads a set of \fB\&.ini\fP files with config settings. It
loads these settings into an internal data store (not a database). The config
API lets you read the current configuration as well as change it and create new
entries. CouchDB writes any changes back to the \fB\&.ini\fP files.
.sp
The \fB\&.ini\fP files can also be edited by hand when CouchDB is not running.
Instead of creating the admin user as we showed previously, you could have
stopped CouchDB, opened your \fBlocal.ini\fP, added \fBanna = secret\fP to the
\fI\%admins\fP, and restarted CouchDB. Upon reading the new line from
\fBlocal.ini\fP, CouchDB would run the hashing algorithm and write back the hash
to \fBlocal.ini\fP, replacing the plain\-text password — just as it did for our
original \fBadmin\fP user. To make sure CouchDB only hashes plain\-text passwords
and not an existing hash a second time, it prefixes the hash with \fB\-pbkdf2\-\fP,
to distinguish between plain\-text passwords and \fI\%PBKDF2\fP hashed passwords. This
means your plain\-text password can’t start with the characters \fB\-pbkdf2\-\fP,
but that’s pretty unlikely to begin with.
.SS Basic Authentication
.sp
CouchDB will not allow us to create new databases unless we give the correct admin user
credentials. Let’s verify:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
> HOST=\(dqhttp://127.0.0.1:5984\(dq
> curl \-X PUT $HOST/somedatabase
{\(dqerror\(dq:\(dqunauthorized\(dq,\(dqreason\(dq:\(dqYou are not a server admin.\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
That looks about right. Now we try again with the correct credentials:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
> HOST=\(dqhttp://anna:secret@127.0.0.1:5984\(dq
> curl \-X PUT $HOST/somedatabase
{\(dqok\(dq:true}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If you have ever accessed a website or FTP server that was password\-protected,
the \fBusername:password@\fP URL variant should look familiar.
.sp
If you are security conscious, the missing \fBs\fP in \fBhttp://\fP will make you
nervous. We’re sending our password to CouchDB in plain text. This is a bad
thing, right? Yes, but consider our scenario: CouchDB listens on \fB127.0.0.1\fP
on a development box that we’re the sole user of. Who could possibly sniff our
password?
.sp
If you are in a production environment, however, you need to reconsider. Will
your CouchDB instance communicate over a public network? Even a LAN shared
with other collocation customers is public. There are multiple ways to secure
communication between you or your application and CouchDB that exceed the
scope of this documentation. CouchDB as of version \fI\%1.1.0\fP
comes with \fI\%SSL built in\fP\&.
.sp
\fBSEE ALSO:\fP
.INDENT 0.0
.INDENT 3.5
\fI\%Basic Authentication API Reference\fP
.UNINDENT
.UNINDENT
.SS Cookie Authentication
.sp
Basic authentication that uses plain\-text passwords is nice and convenient,
but not very secure if no extra measures are taken. It is also a very poor
user experience. If you use basic authentication to identify admins,
your application’s users need to deal with an ugly, unstylable browser modal
dialog that says non\-professional at work more than anything else.
.sp
To remedy some of these concerns, CouchDB supports cookie authentication.
With cookie authentication your application doesn’t have to include the ugly
login dialog that the users’ browsers come with. You can use a regular HTML
form to submit logins to CouchDB. Upon receipt, CouchDB will generate a
one\-time token that the client can use in its next request to CouchDB. When
CouchDB sees the token in a subsequent request, it will authenticate the user
based on the token without the need to see the password again. By default,
a token is valid for 10 minutes.
.sp
To obtain the first token and thus authenticate a user for the first time,
the username and password must be sent to the \fI\%_session\fP
API. The API is smart enough to decode HTML form submissions, so you don’t have
to resort to any smarts in your application.
.sp
If you are not using HTML forms to log in, you need to send an HTTP request
that looks as if an HTML form generated it. Luckily, this is super simple:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
> HOST=\(dqhttp://127.0.0.1:5984\(dq
> curl \-vX POST $HOST/_session \e
       \-H \(aqContent\-Type:application/x\-www\-form\-urlencoded\(aq \e
       \-d \(aqname=anna&password=secret\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB replies, and we’ll give you some more detail:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
< HTTP/1.1 200 OK
< Set\-Cookie: AuthSession=YW5uYTo0QUIzOTdFQjrC4ipN\-D\-53hw1sJepVzcVxnriEw;
< Version=1; Path=/; HttpOnly
> ...
<
{\(dqok\(dq:true}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
A \fI\%200 OK\fP response code tells us all is well, a \fI\%Set\-Cookie\fP
header includes the token we can use for the next request, and the standard JSON
response tells us again that the request was successful.
.sp
Now we can use this token to make another request as the same user without
sending the username and password again:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
> curl \-vX PUT $HOST/mydatabase \e
       \-\-cookie AuthSession=YW5uYTo0QUIzOTdFQjrC4ipN\-D\-53hw1sJepVzcVxnriEw \e
       \-H \(dqX\-CouchDB\-WWW\-Authenticate: Cookie\(dq \e
       \-H \(dqContent\-Type:application/x\-www\-form\-urlencoded\(dq
{\(dqok\(dq:true}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You can keep using this token for 10 minutes by default. After 10 minutes you
need to authenticate your user again. The token lifetime can be configured
with the timeout (in seconds) setting in the \fI\%chttpd_auth\fP configuration section.
.sp
\fBSEE ALSO:\fP
.INDENT 0.0
.INDENT 3.5
\fI\%Cookie Authentication API Reference\fP
.UNINDENT
.UNINDENT
.SS Authentication Database
.sp
You may already note that CouchDB administrators are defined within the config
file and are wondering if regular users are also stored there. No, they are not.
CouchDB has a special \fIauthentication database\fP, named \fB_users\fP by default,
that stores all registered users as JSON documents.
.sp
This special database is a \fIsystem database\fP\&. This means that while it shares
the common \fI\%database API\fP, there are some
special security\-related constraints applied. Below is a list of how the
\fIauthentication database\fP is different from the other databases.
.INDENT 0.0
.IP \(bu 2
Only administrators may browse list of all documents
(\fI\%GET /_users/_all_docs\fP)
.IP \(bu 2
Only administrators may listen to \fI\%changes feed\fP (\fI\%GET /_users/_changes\fP)
.IP \(bu 2
Only administrators may execute design functions like \fI\%views\fP\&.
.IP \(bu 2
There is a special design document \fB_auth\fP that cannot be modified
.IP \(bu 2
Every document except the \fIdesign documents\fP represent registered
CouchDB users and belong to them
.IP \(bu 2
By default, the \fB_security\fP settings of the \fB_users\fP database disallow
users from accessing or modifying documents
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Settings can be changed so that users do have access to the \fB_users\fP database,
but even then they may only access (\fI\%GET /_users/org.couchdb.user:Jan\fP) or modify (\fI\%PUT /_users/org.couchdb.user:Jan\fP) documents that they own. This will not be possible in CouchDB 4.0.
.UNINDENT
.UNINDENT
.sp
These draconian rules are necessary since CouchDB cares about its users’
personal information and will not disclose it to just anyone. Often, user
documents contain system information like \fIlogin\fP, \fIpassword hash\fP and \fIroles\fP,
apart from sensitive personal information like real name, email, phone, special
internal identifications and more. This is not information that you
want to share with the World.
.SS Users Documents
.sp
Each CouchDB user is stored in document format. These documents contain
several \fImandatory\fP fields, that CouchDB needs for authentication:
.INDENT 0.0
.IP \(bu 2
\fB_id\fP (\fIstring\fP): Document ID. Contains user’s login with special prefix
\fI\%Why the org.couchdb.user: prefix?\fP
.IP \(bu 2
\fBderived_key\fP (\fIstring\fP): \fI\%PBKDF2\fP key derived from salt/iterations.
.IP \(bu 2
\fBname\fP (\fIstring\fP): User’s name aka login. \fBImmutable\fP e.g. you cannot
rename an existing user \- you have to create new one
.IP \(bu 2
\fBroles\fP (\fIarray\fP of \fIstring\fP): List of user roles. CouchDB doesn’t provide
any built\-in roles, so you’re free to define your own depending on your needs.
However, you cannot set system roles like \fB_admin\fP there. Also, only
administrators may assign roles to users \- by default all users have no roles
.IP \(bu 2
\fBpassword\fP (\fIstring\fP): A plaintext password can be provided, but will be replaced
by hashed fields before the document is actually stored.
.IP \(bu 2
\fBpassword_sha\fP (\fIstring\fP): Hashed password with salt. Used for \fBsimple\fP
\fIpassword_scheme\fP
.IP \(bu 2
\fBpassword_scheme\fP (\fIstring\fP): Password hashing scheme. May be \fBsimple\fP or
\fBpbkdf2\fP
.IP \(bu 2
\fBsalt\fP (\fIstring\fP): Hash salt. Used for both \fBsimple\fP and \fBpbkdf2\fP
\fBpassword_scheme\fP options.
.IP \(bu 2
\fBiterations\fP (\fIinteger\fP): Number of iterations to derive key, used for \fBpbkdf2\fP
\fBpassword_scheme\fP See the \fI\%configuration API\fP:: for details.
.IP \(bu 2
\fBtype\fP (\fIstring\fP): Document type. Constantly has the value \fBuser\fP
.UNINDENT
.sp
Additionally, you may specify any custom fields that relate to the target
user.
.SS Why the \fBorg.couchdb.user:\fP prefix?
.sp
The reason there is a special prefix before a user’s login name is to have
namespaces that users belong to. This prefix is designed to prevent
replication conflicts when you try merging two or more \fI_user\fP databases.
.sp
For current CouchDB releases, all users belong to the same
\fBorg.couchdb.user\fP namespace and this cannot be changed. This may be changed
in future releases.
.SS Creating a New User
.sp
Creating a new user is a very trivial operation. You just need to do a
\fI\%PUT\fP request with the user’s data to CouchDB. Let’s create a user with
login \fIjan\fP and password \fIapple\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X PUT http://localhost:5984/_users/org.couchdb.user:jan \e
     \-H \(dqAccept: application/json\(dq \e
     \-H \(dqContent\-Type: application/json\(dq \e
     \-d \(aq{\(dqname\(dq: \(dqjan\(dq, \(dqpassword\(dq: \(dqapple\(dq, \(dqroles\(dq: [], \(dqtype\(dq: \(dquser\(dq}\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This \fIcurl\fP command will produce the following HTTP request:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
PUT /_users/org.couchdb.user:jan HTTP/1.1
Accept: application/json
Content\-Length: 62
Content\-Type: application/json
Host: localhost:5984
User\-Agent: curl/7.31.0
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
And CouchDB responds with:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Cache\-Control: must\-revalidate
Content\-Length: 83
Content\-Type: application/json
Date: Fri, 27 Sep 2013 07:33:28 GMT
ETag: \(dq1\-e0ebfb84005b920488fc7a8cc5470cc0\(dq
Location: http://localhost:5984/_users/org.couchdb.user:jan
Server: CouchDB (Erlang OTP)

{\(dqok\(dq:true,\(dqid\(dq:\(dqorg.couchdb.user:jan\(dq,\(dqrev\(dq:\(dq1\-e0ebfb84005b920488fc7a8cc5470cc0\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The document was successfully created! The user \fIjan\fP should now exist in our
database. Let’s check if this is true:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X POST http://localhost:5984/_session \-d \(aqname=jan&password=apple\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB should respond with:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqok\(dq:true,\(dqname\(dq:\(dqjan\(dq,\(dqroles\(dq:[]}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This means that the username was recognized and the password’s hash matches
with the stored one. If we specify an incorrect login and/or password, CouchDB
will notify us with the following error message:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqerror\(dq:\(dqunauthorized\(dq,\(dqreason\(dq:\(dqName or password is incorrect.\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Password Changing
.sp
Let’s define what is password changing from the point of view of CouchDB and
the authentication database. Since “users” are “documents”, this operation is
just updating the document with a special field \fBpassword\fP which contains
the \fIplain text password\fP\&. Scared? No need to be. The authentication database
has a special internal hook on document update which looks for this field and
replaces it with the \fIsecured hash\fP depending on the chosen \fBpassword_scheme\fP\&.
.sp
Summarizing the above process \- we need to get the document’s content, add
the \fBpassword\fP field with the new password in plain text and then store the
JSON result to the authentication database.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X GET http://localhost:5984/_users/org.couchdb.user:jan
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dqorg.couchdb.user:jan\(dq,
    \(dq_rev\(dq: \(dq1\-e0ebfb84005b920488fc7a8cc5470cc0\(dq,
    \(dqderived_key\(dq: \(dqe579375db0e0c6a6fc79cd9e36a36859f71575c3\(dq,
    \(dqiterations\(dq: 10,
    \(dqname\(dq: \(dqjan\(dq,
    \(dqpassword_scheme\(dq: \(dqpbkdf2\(dq,
    \(dqroles\(dq: [],
    \(dqsalt\(dq: \(dq1112283cf988a34f124200a050d308a1\(dq,
    \(dqtype\(dq: \(dquser\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Here is our user’s document. We may strip hashes from the stored document to
reduce the amount of posted data:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X PUT http://localhost:5984/_users/org.couchdb.user:jan \e
     \-H \(dqAccept: application/json\(dq \e
     \-H \(dqContent\-Type: application/json\(dq \e
     \-H \(dqIf\-Match: 1\-e0ebfb84005b920488fc7a8cc5470cc0\(dq \e
     \-d \(aq{\(dqname\(dq:\(dqjan\(dq, \(dqroles\(dq:[], \(dqtype\(dq:\(dquser\(dq, \(dqpassword\(dq:\(dqorange\(dq}\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqok\(dq:true,\(dqid\(dq:\(dqorg.couchdb.user:jan\(dq,\(dqrev\(dq:\(dq2\-ed293d3a0ae09f0c624f10538ef33c6f\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Updated! Now let’s check that the password was really changed:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X POST http://localhost:5984/_session \-d \(aqname=jan&password=apple\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB should respond with:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqerror\(dq:\(dqunauthorized\(dq,\(dqreason\(dq:\(dqName or password is incorrect.\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Looks like the password \fBapple\fP is wrong, what about \fBorange\fP?
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X POST http://localhost:5984/_session \-d \(aqname=jan&password=orange\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB should respond with:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqok\(dq:true,\(dqname\(dq:\(dqjan\(dq,\(dqroles\(dq:[]}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Hooray! You may wonder why this was so complex \- we need to retrieve user’s
document, add a special field to it, and post it back.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
There is no password confirmation for API request: you should implement it
in your application layer.
.UNINDENT
.UNINDENT
.SS Authorization
.sp
Now that you have a few users who can log in, you probably want to set up some
restrictions on what actions they can perform based on their identity and their
roles.  Each database on a CouchDB server can contain its own set of
authorization rules that specify which users are allowed to read and write
documents, create design documents, and change certain database configuration
parameters.  The authorization rules are set up by a server admin and can be
modified at any time.
.sp
Database authorization rules assign a user into one of two classes:
.INDENT 0.0
.IP \(bu 2
\fImembers\fP, who are allowed to read all documents and create and modify any
document except for design documents.
.IP \(bu 2
\fIadmins\fP, who can read and write all types of documents, modify which users
are members or admins, and set certain per\-database configuration options.
.UNINDENT
.sp
Note that a database admin is not the same as a server admin – the actions
of a database admin are restricted to a specific database.
.sp
All databases are created as admin\-only by default. That is, only database
admins may read or write. The default behavior can be configured with the
\fB[couchdb] default_security\fP \fI\%option\fP\&. If you set that
option to \fBeveryone\fP, HTTP requests that have no authentication credentials
or have credentials for a normal user are treated as members, and those with
server admin credentials are treated as database admins.
.sp
You can also modify the permissions after the database is created by modifying the
\fI\%security\fP document in the database:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
> curl \-X PUT http://localhost:5984/mydatabase/_security \e
     \-u anna:secret \e
     \-H \(dqContent\-Type: application/json\(dq \e
     \-d \(aq{\(dqadmins\(dq: { \(dqnames\(dq: [], \(dqroles\(dq: [] }, \(dqmembers\(dq: { \(dqnames\(dq: [\(dqjan\(dq], \(dqroles\(dq: [] } }\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The HTTP request to create or update the \fI_security\fP document must contain the
credentials of a server admin.  CouchDB will respond with:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqok\(dq:true}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The database is now secured against anonymous reads and writes:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
> curl http://localhost:5984/mydatabase/
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqerror\(dq:\(dqunauthorized\(dq,\(dqreason\(dq:\(dqYou are not authorized to access this db.\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You declared user “jan” as a member in this database, so he is able to read and
write normal documents:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
> curl \-u jan:apple http://localhost:5984/mydatabase/
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqdb_name\(dq:\(dqmydatabase\(dq,\(dqdoc_count\(dq:1,\(dqdoc_del_count\(dq:0,\(dqupdate_seq\(dq:3,\(dqpurge_seq\(dq:0,
\(dqcompact_running\(dq:false,\(dqsizes\(dq:{\(dqactive\(dq:272,\(dqdisk\(dq:12376,\(dqexternal\(dq:350},
\(dqinstance_start_time\(dq:\(dq0\(dq,\(dqdisk_format_version\(dq:6,\(dqcommitted_update_seq\(dq:3}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If Jan attempted to create a design doc, however, CouchDB would return a
401 Unauthorized error because the username “jan” is not in the list of
admin names and the \fI/_users/org.couchdb.user:jan\fP document doesn’t contain
a role that matches any of the declared admin roles.  If you want to promote
Jan to an admin, you can update the security document to add \fI“jan”\fP to
the \fInames\fP array under \fIadmin\fP\&.  Keeping track of individual database
admin usernames is tedious, though, so you would likely prefer to create a
database admin role and assign that role to the \fIorg.couchdb.user:jan\fP user
document:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
> curl \-X PUT http://localhost:5984/mydatabase/_security \e
     \-u anna:secret \e
     \-H \(dqContent\-Type: application/json\(dq \e
     \-d \(aq{\(dqadmins\(dq: { \(dqnames\(dq: [], \(dqroles\(dq: [\(dqmydatabase_admin\(dq] }, \(dqmembers\(dq: { \(dqnames\(dq: [], \(dqroles\(dq: [] } }\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
See the \fI\%_security document reference page\fP for
additional details about specifying database members and admins.
.SS Getting Started
.sp
In this document, we’ll take a quick tour of CouchDB’s features.
We’ll create our first document and experiment with CouchDB views.
.SS All Systems Are Go!
.sp
We’ll have a very quick look at CouchDB’s bare\-bones Application Programming
Interface (API) by using the command\-line utility curl. Please note that this
is not the only way of talking to CouchDB. We will show you plenty more
throughout the rest of the documents. What’s interesting about curl is that it
gives you control over raw HTTP requests, and you can see exactly what is
going on “underneath the hood” of your database.
.sp
Make sure CouchDB is still running, and then do:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl http://127.0.0.1:5984/
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This issues a GET request to your newly installed CouchDB instance.
.sp
The reply should look something like:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
  \(dqcouchdb\(dq: \(dqWelcome\(dq,
  \(dqversion\(dq: \(dq3.0.0\(dq,
  \(dqgit_sha\(dq: \(dq83bdcf693\(dq,
  \(dquuid\(dq: \(dq56f16e7c93ff4a2dc20eb6acc7000b71\(dq,
  \(dqfeatures\(dq: [
    \(dqaccess\-ready\(dq,
    \(dqpartitioned\(dq,
    \(dqpluggable\-storage\-engines\(dq,
    \(dqreshard\(dq,
    \(dqscheduler\(dq
  ],
  \(dqvendor\(dq: {
    \(dqname\(dq: \(dqThe Apache Software Foundation\(dq
  }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Not all that spectacular. CouchDB is saying “hello” with the running version
number.
.sp
Next, we can get a list of databases:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X GET http://admin:password@127.0.0.1:5984/_all_dbs
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
All we added to the previous request is the _all_dbs string, and our admin user
name and password (set when installing CouchDB).
.sp
The response should look like:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[\(dq_replicator\(dq,\(dq_users\(dq]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
In case this returns an empty Array for you, it means you haven’t finished
installation correctly. Please refer to \fI\%Setup\fP for further
information on this.
.sp
For the purposes of this example, we’ll not be showing the system databases
past this point. In \fIyour\fP installation, any time you \fBGET /_all_dbs\fP,
you should see the system databases in the list, too.
.UNINDENT
.UNINDENT
.sp
Oh, that’s right, we didn’t create any user databases yet!
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
The curl command issues GET requests by default. You can issue POST requests
using \fBcurl \-X POST\fP\&. To make it easy to work with our terminal history,
we usually use the \fB\-X\fP option even when issuing GET requests.
If we want to send a POST next time, all we have to change is the method.
.sp
HTTP does a bit more under the hood than you can see in the examples here.
If you’re interested in every last detail that goes over the wire,
pass in the \fB\-v\fP option (e.g., \fBcurl \-vX GET\fP), which will show you
the server curl tries to connect to, the request headers it sends,
and response headers it receives back. Great for debugging!
.UNINDENT
.UNINDENT
.sp
Let’s create a database:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X PUT http://admin:password@127.0.0.1:5984/baseball
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB will reply with:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqok\(dq:true}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Retrieving the list of databases again shows some useful results this time:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X GET http://admin:password@127.0.0.1:5984/_all_dbs
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[\(dqbaseball\(dq]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
We should mention JavaScript Object Notation (JSON) here, the data format
CouchDB speaks. JSON is a lightweight data interchange format based on
JavaScript syntax. Because JSON is natively compatible with JavaScript, your
web browser is an ideal client for CouchDB.
.sp
Brackets (\fB[]\fP) represent ordered lists, and curly braces (\fB{}\fP)
represent key/value dictionaries. Keys must be strings, delimited by quotes
(\fB\(dq\fP), and values can be strings, numbers, booleans, lists, or key/value
dictionaries. For a more detailed description of JSON, see Appendix E, JSON
Primer.
.UNINDENT
.UNINDENT
.sp
Let’s create another database:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X PUT http://admin:password@127.0.0.1:5984/baseball
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB will reply with:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqerror\(dq:\(dqfile_exists\(dq,\(dqreason\(dq:\(dqThe database could not be created,
the file already exists.\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
We already have a database with that name, so CouchDB will respond with an
error. Let’s try again with a different database name:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X PUT http://admin:password@127.0.0.1:5984/plankton
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB will reply with:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqok\(dq:true}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Retrieving the list of databases yet again shows some useful results:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X GET http://admin:password@127.0.0.1:5984/_all_dbs
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB will respond with:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[\(dqbaseball\(dq, \(dqplankton\(dq]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
To round things off, let’s delete the second database:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X DELETE http://admin:password@127.0.0.1:5984/plankton
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB will reply with:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqok\(dq:true}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The list of databases is now the same as it was before:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X GET http://admin:password@127.0.0.1:5984/_all_dbs
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB will respond with:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[\(dqbaseball\(dq]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
For brevity, we’ll skip working with documents, as the next section covers a
different and potentially easier way of working with CouchDB that should
provide experience with this. As we work through the example,
keep in mind that “under the hood” everything is being done by the
application exactly as you have been doing here manually.
Everything is done using GET, PUT, POST, and DELETE with a URI.
.SS Welcome to Fauxton
.sp
After having seen CouchDB’s raw API, let’s get our feet wet by playing with
Fauxton, the built\-in administration interface. Fauxton provides full access
to all of CouchDB’s features and makes it easy to work with some of the more
complex ideas involved. With Fauxton we can create and destroy databases; view
and edit documents; compose and run MapReduce views; and trigger replication
between databases.
.sp
To load Fauxton in your browser, visit:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
http://127.0.0.1:5984/_utils/
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
and log in when prompted with your admin password.
.sp
In later documents, we’ll focus on using CouchDB from server\-side languages
such as Ruby and Python. As such, this document is a great opportunity to
showcase an example of natively serving up a dynamic web application using
nothing more than CouchDB’s integrated web server, something you may wish to do
with your own applications.
.sp
The first thing we should do with a fresh installation of CouchDB is run the
test suite to verify that everything is working properly. This assures us
that any problems we may run into aren’t due to bothersome issues with our
setup. By the same token, failures in the Fauxton test suite are a red flag,
telling us to double\-check our installation before attempting to use a
potentially broken database server, saving us the confusion when nothing
seems to be working quite like we expect!
.sp
To validate your installation, click on the \fIVerify\fP link on the left\-hand
side, then press the green \fIVerify Installation\fP button. All tests should
pass with a check mark. If any fail, re\-check your installation steps.
.SS Your First Database and Document
.sp
Creating a database in Fauxton is simple. From the overview page,
click “Create Database.” When asked for a name, enter \fBhello\-world\fP and click
the Create button.
.sp
After your database has been created, Fauxton will display a list of all its
documents. This list will start out empty, so let’s
create our first document. Click the plus sign next to “All Documents” and
select the “New Doc” link. CouchDB will generate a UUID for you.
.sp
For demoing purposes, having CouchDB assign a UUID is fine. When you write
your first programs, we recommend assigning your own UUIDs. If you rely on
the server to generate the UUID and you end up making two POST requests
because the first POST request bombed out, you might generate two docs and
never find out about the first one because only the second one will be
reported back. Generating your own UUIDs makes sure that you’ll never end up
with duplicate documents.
.sp
Fauxton will display the newly created document, with its _id field. To create
a new field, simply use the editor to write valid JSON. Add a new field by
appending a comma to the \fB_id\fP value, then adding the text:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\(dqhello\(dq: \(dqmy new value\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Click the green Create Document button to finalize creating the
document.
.sp
You can experiment with other JSON values; e.g., \fB[1, 2, \(dqc\(dq]\fP or
\fB{\(dqfoo\(dq: \(dqbar\(dq}\fP\&.
.sp
You’ll notice that the document’s _rev has been added. We’ll go into more detail
about this in later documents, but for now, the important thing to note is
that _rev acts like a safety feature when saving a document. As long as you
and CouchDB agree on the most recent _rev of a document, you can successfully
save your changes.
.sp
For clarity, you may want to display the contents of the document in the all
document view. To enable this, from the upper\-right corner of the window,
select Options, then check the Include Docs option. Finally, press the Run
Query button. The full document should be displayed along with the \fB_id\fP
and \fB_rev\fP values.
.SS Running a Mango Query
.sp
Now that we have stored documents successfully, we want to be able to query
them. The easiest way to do this in CouchDB is running a Mango Query. There are
always two parts to a Mango Query: the index and the selector.
.sp
The index specifies which fields we want to be able to query on, and the
selector includes the actual query parameters that define what we are looking
for exactly.
.sp
Indexes are stored as rows that are kept sorted by the fields you specify. This
makes retrieving data from a range of keys efficient even when there are
thousands or millions of rows.
.sp
Before we can run an example query, we’ll need some data to run it on. We’ll
create documents with information about movies. Let’s create documents for
three movies. (Allow CouchDB to generate the \fB_id\fP and \fB_rev\fP fields.) Use Fauxton
to create documents that have a final JSON structure that look like this:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dq00a271787f89c0ef2e10e88a0c0001f4\(dq,
    \(dqtype\(dq: \(dqmovie\(dq,
    \(dqtitle\(dq: \(dqMy Neighbour Totoro\(dq,
    \(dqyear\(dq: 1988,
    \(dqdirector\(dq: \(dqmiyazaki\(dq,
    \(dqrating\(dq: 8.2
}
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dq00a271787f89c0ef2e10e88a0c0003f0\(dq,
    \(dqtype\(dq: \(dqmovie\(dq,
    \(dqtitle\(dq: \(dqKikis Delivery Service\(dq,
    \(dqyear\(dq: 1989,
    \(dqdirector\(dq: \(dqmiyazaki\(dq,
    \(dqrating\(dq: 7.8
}
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dq00a271787f89c0ef2e10e88a0c00048b\(dq,
    \(dqtype\(dq: \(dqmovie\(dq,
    \(dqtitle\(dq: \(dqPrincess Mononoke\(dq,
    \(dqyear\(dq: 1997,
    \(dqdirector\(dq: \(dqmiyazaki\(dq,
    \(dqrating\(dq: 8.4
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Now we want to be able to find a movie by its release year, we need to create a
Mango Index. To do this, go to “Run A Query with Mango” in the Database
overview. Then click on “manage indexes”, and change the index field on the
left to look like this:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
   \(dqindex\(dq: {
      \(dqfields\(dq: [
         \(dqyear\(dq
      ]
   },
   \(dqname\(dq: \(dqyear\-json\-index\(dq,
   \(dqtype\(dq: \(dqjson\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This defines an index on the field \fByear\fP and allows us to send queries for
documents from a specific year.
.sp
Next, click on “edit query” and change the Mango Query to look like this:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
   \(dqselector\(dq: {
      \(dqyear\(dq: {
         \(dq$eq\(dq: 1988
      }
   }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Then click on ”Run Query”.
.sp
The result should be a single result, the movie “My Neighbour Totoro” which
has the year value of 1988. \fB$eq\fP here stands for “equal”.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Note that if you skip adding the index, the query will still return the
correct results, although you will see a warning about not using a
pre\-existing index. Not using an index will work fine on small databases
and is acceptable for testing out queries in development or training, but
we very strongly discourage doing this in any other case, since an index is
absolutely vital to good query performance.
.UNINDENT
.UNINDENT
.sp
You can also query for all movies during the 1980s, with this selector:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
   \(dqselector\(dq: {
      \(dqyear\(dq: {
         \(dq$lt\(dq: 1990,
         \(dq$gte\(dq: 1980
      }
   }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The result are the two movies from 1988 and 1989. \fB$lt\fP here means “lower
than”, and \fB$gte\fP means “greater than or equal to”. The latter currently
doesn’t have any effect, given that all of our movies are more recent than
1980, but this makes the query future\-proof and allows us to add older
movies later.
.SS Triggering Replication
.sp
Fauxton can trigger replication between two local databases,
between a local and remote database, or even between two remote databases.
We’ll show you how to replicate data from one local database to another,
which is a simple way of making backups of your databases as we’re working
through the examples.
.sp
First we’ll need to create an empty database to be the target of replication.
Return to the Databases overview and create a database called
\fBhello\-replication\fP\&. Now click “Replication” in the sidebar and choose
\fBhello\-world\fP as the source and \fBhello\-replication\fP as the target. Click
“Replicate” to replicate your database.
.sp
To view the result of your replication, click on the Databases tab again.
You should see the \fBhello\-replication\fP database has the same number of documents
as the \fBhello\-world\fP database, and it should take up roughly the same size as
well.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
For larger databases, replication can take much longer. It is important to
leave the browser window open while replication is taking place.
As an alternative, you can trigger replication via curl or some other HTTP
client that can handle long\-running connections. If your client closes the
connection before replication finishes, you’ll have to retrigger it.
Luckily, CouchDB’s replication can take over from where it left off
instead of starting from scratch.
.UNINDENT
.UNINDENT
.SS Wrapping Up
.sp
Now that you’ve seen most of Fauxton’s features, you’ll be prepared to dive in
and inspect your data as we build our example application in the next few
documents. Fauxton’s pure JavaScript approach to managing CouchDB shows how
it’s possible to build a fully featured web application using only CouchDB’s
HTTP API and integrated web server.
.sp
But before we get there, we’ll have another look at CouchDB’s HTTP API – now
with a magnifying glass. Let’s curl up on the couch and relax.
.SS The Core API
.sp
This document explores the CouchDB in minute detail. It shows all the
nitty\-gritty and clever bits. We show you best practices and guide you around
common pitfalls.
.sp
We start out by revisiting the basic operations we ran in the previous document
\fI\%Getting Started\fP, looking behind the scenes. We also show what Fauxton needs to
do behind its user interface to give us the nice features we saw earlier.
.sp
This document is both an introduction to the core CouchDB API as well as a
reference. If you can’t remember how to run a particular request or why some
parameters are needed, you can always come back here and look things up (we
are probably the heaviest users of this document).
.sp
While explaining the API bits and pieces, we sometimes need to take a larger
detour to explain the reasoning for a particular request. This is a good
opportunity for us to tell you why CouchDB works the way it does.
.sp
The API can be subdivided into the following sections. We’ll explore them
individually:
.INDENT 0.0
.IP \(bu 2
\fI\%Server\fP
.IP \(bu 2
\fI\%Databases\fP
.IP \(bu 2
\fI\%Documents\fP
.IP \(bu 2
\fI\%Replication\fP
.IP \(bu 2
\fI\%Wrapping Up\fP
.UNINDENT
.SS Server
.sp
This one is basic and simple. It can serve as a sanity check to see if
CouchDB is running at all. It can also act as a safety guard for libraries
that require a certain version of CouchDB. We’re using the \fI\%curl\fP utility
again:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl http://127.0.0.1:5984/
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB replies, all excited to get going:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
  \(dqcouchdb\(dq: \(dqWelcome\(dq,
  \(dqversion\(dq: \(dq3.0.0\(dq,
  \(dqgit_sha\(dq: \(dq83bdcf693\(dq,
  \(dquuid\(dq: \(dq56f16e7c93ff4a2dc20eb6acc7000b71\(dq,
  \(dqfeatures\(dq: [
    \(dqaccess\-ready\(dq,
    \(dqpartitioned\(dq,
    \(dqpluggable\-storage\-engines\(dq,
    \(dqreshard\(dq,
    \(dqscheduler\(dq
  ],
  \(dqvendor\(dq: {
    \(dqname\(dq: \(dqThe Apache Software Foundation\(dq
  }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You get back a JSON string, that, if parsed into a native object or data
structure of your programming language, gives you access to the welcome
string and version information.
.sp
This is not terribly useful, but it illustrates nicely the way CouchDB
behaves. You send an HTTP request and you receive a JSON string in the HTTP
response as a result.
.SS Databases
.sp
Now let’s do something a little more useful: \fIcreate databases\fP\&.
For the strict, CouchDB is a \fIdatabase management system\fP (DMS). That means it
can hold multiple databases. A database is a bucket that holds “related data”.
We’ll explore later what that means exactly. In practice, the terminology is
overlapping – often people refer to a DMS as “a database” and also a database
within the DMS as “a database.” We might follow that slight oddity, so don’t
get confused by it. In general, it should be clear from the context if we are
talking about the whole of CouchDB or a single database within CouchDB.
.sp
Now let’s make one! We want to store our favorite music albums,
and we creatively give our database the name albums. Note that we’re now
using the \fB\-X\fP option again to tell curl to send a \fI\%PUT\fP request
instead of the default \fI\%GET\fP request:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X PUT http://admin:password@127.0.0.1:5984/albums
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB replies:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqok\(dq:true}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
That’s it. You created a database and CouchDB told you that all went well.
What happens if you try to create a database that already exists? Let’s try
to create that database again:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X PUT http://admin:password@127.0.0.1:5984/albums
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB replies:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqerror\(dq:\(dqfile_exists\(dq,\(dqreason\(dq:\(dqThe database could not be created, the file already exists.\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
We get back an error. This is pretty convenient. We also learn a little bit
about how CouchDB works. CouchDB stores each database in a single file.
Very simple.
.sp
Let’s create another database, this time with curl’s \fB\-v\fP (for “verbose”)
option. The verbose option tells curl to show us not only the essentials –
the HTTP response body – but all the underlying request and response details:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-vX PUT http://admin:password@127.0.0.1:5984/albums\-backup
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
curl elaborates:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
* About to connect() to 127.0.0.1 port 5984 (#0)
*   Trying 127.0.0.1... connected
* Connected to 127.0.0.1 (127.0.0.1) port 5984 (#0)
> PUT /albums\-backup HTTP/1.1
> User\-Agent: curl/7.16.3 (powerpc\-apple\-darwin9.0) libcurl/7.16.3 OpenSSL/0.9.7l zlib/1.2.3
> Host: 127.0.0.1:5984
> Accept: */*
>
< HTTP/1.1 201 Created
< Server: CouchDB (Erlang/OTP)
< Date: Sun, 05 Jul 2009 22:48:28 GMT
< Content\-Type: text/plain;charset=utf\-8
< Content\-Length: 12
< Cache\-Control: must\-revalidate
<
{\(dqok\(dq:true}
* Connection #0 to host 127.0.0.1 left intact
* Closing connection #0
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
What a mouthful. Let’s step through this line by line to understand what’s
going on and find out what’s important. Once you’ve seen this output a few
times, you’ll be able to spot the important bits more easily.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
* About to connect() to 127.0.0.1 port 5984 (#0)
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This is curl telling us that it is going to establish a TCP connection to the
CouchDB server we specified in our request URI. Not at all important,
except when debugging networking issues.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
*   Trying 127.0.0.1... connected
* Connected to 127.0.0.1 (127.0.0.1) port 5984 (#0)
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
curl tells us it successfully connected to CouchDB. Again,
not important if you aren’t trying to find problems with your network.
.sp
The following lines are prefixed with \fB>\fP and \fB<\fP characters.
The \fB>\fP means the line was sent to CouchDB verbatim (without the actual
\fB>\fP). The \fB<\fP means the line was sent back to curl by CouchDB.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
> PUT /albums\-backup HTTP/1.1
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This initiates an HTTP request. Its \fImethod\fP is \fI\%PUT\fP, the \fIURI\fP is
\fB/albums\-backup\fP, and the HTTP version is \fBHTTP/1.1\fP\&. There is also
\fBHTTP/1.0\fP, which is simpler in some cases, but for all practical reasons
you should be using \fBHTTP/1.1\fP\&.
.sp
Next, we see a number of \fIrequest headers\fP\&. These are used to provide
additional details about the request to CouchDB.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
> User\-Agent: curl/7.16.3 (powerpc\-apple\-darwin9.0) libcurl/7.16.3 OpenSSL/0.9.7l zlib/1.2.3
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The User\-Agent header tells CouchDB which piece of client software is doing
the HTTP request. We don’t learn anything new: it’s curl. This header is
often useful in web development when there are known errors in client
implementations that a server might want to prepare the response for.
It also helps to determine which platform a user is on. This information
can be used for technical and statistical reasons. For CouchDB, the
\fI\%User\-Agent\fP header is irrelevant.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
> Host: 127.0.0.1:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The \fI\%Host\fP header is required by \fBHTTP 1.1\fP\&. It tells the server
the hostname that came with the request.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
> Accept: */*
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The \fI\%Accept\fP header tells CouchDB that curl accepts any media type.
We’ll look into why this is useful a little later.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
>
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
An empty line denotes that the request headers are now finished and the rest
of the request contains data we’re sending to the server. In this case,
we’re not sending any data, so the rest of the curl output is dedicated to
the HTTP response.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
< HTTP/1.1 201 Created
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The first line of CouchDB’s HTTP response includes the HTTP version
information (again, to acknowledge that the requested version could be
processed), an HTTP \fIstatus code\fP, and a \fIstatus code message\fP\&.
Different requests trigger different response codes. There’s a whole range of
them telling the client (curl in our case) what effect the request had on the
server. Or, if an error occurred, what kind of error. \fI\%RFC 2616\fP (the HTTP 1.1
specification) defines clear behavior for response codes. CouchDB fully
follows the RFC.
.sp
The \fI\%201 Created\fP status code tells the client that the resource
the request was made against was successfully created. No surprise here,
but if you remember that we got an error message when we tried to create this
database twice, you now know that this response could include a different
response code. Acting upon responses based on response codes is a common
practice. For example, all response codes of \fI\%400 Bad Request\fP or larger
tell you that some error occurred. If you want to shortcut your logic and
immediately deal with the error, you could just check a >= \fB400\fP response
code.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
< Server: CouchDB (Erlang/OTP)
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The \fI\%Server\fP header is good for diagnostics. It tells us which
CouchDB version and which underlying Erlang version we are talking to.
In general, you can ignore this header, but it is good to know it’s there if
you need it.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
< Date: Sun, 05 Jul 2009 22:48:28 GMT
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The \fI\%Date\fP header tells you the time of the server. Since client
and server time are not necessarily synchronized, this header is purely
informational. You shouldn’t build any critical application logic on top
of this!
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
< Content\-Type: text/plain;charset=utf\-8
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The \fI\%Content\-Type\fP header tells you which MIME type
the HTTP response body is and its encoding. We already know CouchDB returns
JSON strings. The appropriate \fI\%Content\-Type\fP header is
\fIapplication/json\fP\&. Why do we see \fItext/plain\fP?
This is where pragmatism wins over purity. Sending an
\fIapplication/json\fP \fI\%Content\-Type\fP header will make
a browser offer you the returned JSON for download instead of
just displaying it. Since it is extremely useful to be able to test CouchDB
from a browser, CouchDB sends a \fItext/plain\fP content type, so all
browsers will display the JSON as text.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
There are some extensions that make your browser JSON\-aware,
but they are not installed by default. For more information, look at
the popular \fI\%JSONView\fP extension, available for both Firefox and Chrome.
.UNINDENT
.UNINDENT
.sp
Do you remember the \fI\%Accept\fP request header and how it is set to
\fB*/*\fP to express interest in any MIME type? If you send \fBAccept:
application/json\fP in your request, CouchDB knows that you can deal with a pure
JSON response with the proper \fI\%Content\-Type\fP header and will
use it instead of \fItext/plain\fP\&.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
< Content\-Length: 12
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The \fI\%Content\-Length\fP header simply tells us how many bytes
the response body has.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
< Cache\-Control: must\-revalidate
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This \fI\%Cache\-Control\fP header tells you, or any proxy server between
CouchDB and you, not to cache this response.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
<
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This empty line tells us we’re done with the response headers and what
follows now is the response body.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqok\(dq:true}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
We’ve seen this before.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
* Connection #0 to host 127.0.0.1 left intact
* Closing connection #0
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The last two lines are curl telling us that it kept the TCP connection it
opened in the beginning open for a moment, but then closed it after it
received the entire response.
.sp
Throughout the documents, we’ll show more requests with the \fB\-v\fP option,
but we’ll omit some of the headers we’ve seen here and include only those
that are important for the particular request.
.sp
Creating databases is all fine, but how do we get rid of one? Easy – just
change the HTTP method:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
> curl \-vX DELETE http://admin:password@127.0.0.1:5984/albums\-backup
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This deletes a CouchDB database. The request will remove the file that the
database contents are stored in. There is no \fI“Are you sure?”\fP safety net or
any \fI“Empty the trash”\fP magic you’ve got to do to delete a database. Use this
command with care. Your data will be deleted without a chance to bring it
back easily if you don’t have a backup copy.
.sp
This section went knee\-deep into HTTP and set the stage for discussing the
rest of the core CouchDB API. Next stop: documents.
.SS Documents
.sp
Documents are CouchDB’s central data structure. The idea behind a document
is, unsurprisingly, that of a real\-world document – a sheet of paper such as
an invoice, a recipe, or a business card. We already learned that CouchDB uses
the JSON format to store documents. Let’s see how this storing works at the
lowest level.
.sp
Each document in CouchDB has an \fIID\fP\&. This ID is unique per database. You are
free to choose any string to be the ID, but for best results we recommend a
\fI\%UUID\fP (or \fI\%GUID\fP), i.e., a Universally (or Globally) Unique IDentifier.
UUIDs are random numbers that have such a low collision probability that
everybody can make thousands of UUIDs a minute for millions of years without
ever creating a duplicate. This is a great way to ensure two independent people
cannot create two different documents with the same ID. Why should you care
what somebody else is doing? For one, that somebody else could be you at a
later time or on a different computer; secondly, CouchDB replication lets you
share documents with others and using UUIDs ensures that it all works.
But more on that later; let’s make some documents:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X PUT http://admin:password@127.0.0.1:5984/albums/6e1295ed6c29495e54cc05947f18c8af \-d \(aq{\(dqtitle\(dq:\(dqThere is Nothing Left to Lose\(dq,\(dqartist\(dq:\(dqFoo Fighters\(dq}\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB replies:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqok\(dq:true,\(dqid\(dq:\(dq6e1295ed6c29495e54cc05947f18c8af\(dq,\(dqrev\(dq:\(dq1\-2902191555\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The curl command appears complex, but let’s break it down.
First, \fB\-X PUT\fP tells curl to make a \fI\%PUT\fP request.
It is followed by the URL that specifies your CouchDB IP address and port.
The resource part of the URL \fB/albums/6e1295ed6c29495e54cc05947f18c8af\fP
specifies the location of a document inside our albums database.
The wild collection of numbers and characters is a UUID. This UUID is your
document’s ID. Finally, the \fB\-d\fP flag tells curl to use the following
string as the body for the \fI\%PUT\fP request. The string is a simple JSON
structure including \fBtitle\fP and \fBartist\fP attributes with their respective
values.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
If you don’t have a UUID handy, you can ask CouchDB to give you one (in
fact, that is what we did just now without showing you). Simply send a
\fI\%GET /_uuids\fP request:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X GET http://127.0.0.1:5984/_uuids
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB replies:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dquuids\(dq:[\(dq6e1295ed6c29495e54cc05947f18c8af\(dq]}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Voilà, a UUID. If you need more than one, you can pass in the \fB?count=10\fP
HTTP parameter to request 10 UUIDs, or really, any number you need.
.UNINDENT
.UNINDENT
.sp
To double\-check that CouchDB isn’t lying about having saved your document (it
usually doesn’t), try to retrieve it by sending a GET request:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X GET http://admin:password@127.0.0.1:5984/albums/6e1295ed6c29495e54cc05947f18c8af
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
We hope you see a pattern here. Everything in CouchDB has an address, a URI,
and you use the different HTTP methods to operate on these URIs.
.sp
CouchDB replies:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dq_id\(dq:\(dq6e1295ed6c29495e54cc05947f18c8af\(dq,\(dq_rev\(dq:\(dq1\-2902191555\(dq,\(dqtitle\(dq:\(dqThere is Nothing Left to Lose\(dq,\(dqartist\(dq:\(dqFoo Fighters\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This looks a lot like the document you asked CouchDB to save, which is good.
But you should notice that CouchDB added two fields to your JSON structure.
The first is \fB_id\fP, which holds the UUID we asked CouchDB to save our document
under. We always know the ID of a document if it is included, which is very
convenient.
.sp
The second field is \fB_rev\fP\&. It stands for \fIrevision\fP\&.
.SS Revisions
.sp
If you want to change a document in CouchDB, you don’t tell it to go and find
a field in a specific document and insert a new value. Instead, you load
the full document out of CouchDB, make your changes in the JSON structure
(or object, when you are doing actual programming), and save the entire new
revision (or version) of that document back into CouchDB. Each revision is
identified by a new \fB_rev\fP value.
.sp
If you want to update or delete a document, CouchDB expects you to include
the \fB_rev\fP field of the revision you wish to change. When CouchDB accepts
the change, it will generate a new revision number. This mechanism ensures that,
in case somebody else made a change without you knowing before you got to
request the document update, CouchDB will not accept your update because you
are likely to overwrite data you didn’t know existed. Or simplified: whoever
saves a change to a document first, wins. Let’s see what happens if we don’t
provide a \fB_rev\fP field (which is equivalent to providing a outdated value):
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X PUT http://admin:password@127.0.0.1:5984/albums/6e1295ed6c29495e54cc05947f18c8af \e
     \-d \(aq{\(dqtitle\(dq:\(dqThere is Nothing Left to Lose\(dq,\(dqartist\(dq:\(dqFoo Fighters\(dq,\(dqyear\(dq:\(dq1997\(dq}\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB replies:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqerror\(dq:\(dqconflict\(dq,\(dqreason\(dq:\(dqDocument update conflict.\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If you see this, add the latest revision number of your document to the JSON
structure:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X PUT http://admin:password@127.0.0.1:5984/albums/6e1295ed6c29495e54cc05947f18c8af \e
     \-d \(aq{\(dq_rev\(dq:\(dq1\-2902191555\(dq,\(dqtitle\(dq:\(dqThere is Nothing Left to Lose\(dq,\(dqartist\(dq:\(dqFoo Fighters\(dq,\(dqyear\(dq:\(dq1997\(dq}\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Now you see why it was handy that CouchDB returned that \fB_rev\fP when we made
the initial request. CouchDB replies:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqok\(dq:true,\(dqid\(dq:\(dq6e1295ed6c29495e54cc05947f18c8af\(dq,\(dqrev\(dq:\(dq2\-8aff9ee9d06671fa89c99d20a4b3ae\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB accepted your write and also generated a new revision number.
The revision number is the \fIMD5 hash\fP of the transport representation of a
document with an \fBN\-\fP prefix denoting the number of times a document got
updated. This is useful for replication. See \fI\%Replication and conflict model\fP for
more information.
.sp
There are multiple reasons why CouchDB uses this revision system,
which is also called Multi\-Version Concurrency Control (\fI\%MVCC\fP). They all work
hand\-in\-hand, and this is a good opportunity to explain some of them.
.sp
One of the aspects of the HTTP protocol that CouchDB uses is that it is
stateless. What does that mean? When talking to CouchDB you need to make
requests. Making a request includes opening a network connection to CouchDB,
exchanging bytes, and closing the connection. This is done every time you
make a request. Other protocols allow you to open a connection, exchange bytes,
keep the connection open, exchange more bytes later – maybe depending on the
bytes you exchanged at the beginning – and eventually close the connection.
Holding a connection open for later use requires the server to do extra work.
One common pattern is that for the lifetime of a connection, the client has
a consistent and static view of the data on the server. Managing huge amounts
of parallel connections is a significant amount of work. HTTP connections are
usually short\-lived, and making the same guarantees is a lot easier.
As a result, CouchDB can handle many more concurrent connections.
.sp
Another reason CouchDB uses MVCC is that this model is simpler conceptually
and, as a consequence, easier to program. CouchDB uses less code to make this
work, and less code is always good because the ratio of defects per lines of
code is static.
.sp
The revision system also has positive effects on replication and storage
mechanisms, but we’ll explore these later in the documents.
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
The terms \fIversion\fP and \fIrevision\fP might sound familiar (if you are
programming without version control, stop reading this guide right now and
start learning one of the popular systems). Using new versions for document
changes works a lot like version control, but there’s an important
difference: \fBCouchDB does not guarantee that older versions are kept
around. Don’t use the \(ga\(ga_rev\(ga\(ga token in CouchDB as a revision control system
for your documents.\fP
.UNINDENT
.UNINDENT
.SS Documents in Detail
.sp
Now let’s have a closer look at our document creation requests with the curl
\fB\-v\fP flag that was helpful when we explored the database API earlier.
This is also a good opportunity to create more documents that we can use in
later examples.
.sp
We’ll add some more of our favorite music albums. Get a fresh UUID from the
\fB/_uuids\fP resource. If you don’t remember how that works, you can look it up
a few pages back.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-vX PUT http://admin:password@127.0.0.1:5984/albums/70b50bfa0a4b3aed1f8aff9e92dc16a0 \e
     \-d \(aq{\(dqtitle\(dq:\(dqBlackened Sky\(dq,\(dqartist\(dq:\(dqBiffy Clyro\(dq,\(dqyear\(dq:2002}\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
By the way, if you happen to know more information about your favorite
albums, don’t hesitate to add more properties. And don’t worry about not
knowing all the information for all the albums. CouchDB’s schema\-less
documents can contain whatever you know. After all, you should relax and not
worry about data.
.UNINDENT
.UNINDENT
.sp
Now with the \fB\-v\fP option, CouchDB’s reply (with only the important bits shown)
looks like this:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
> PUT /albums/70b50bfa0a4b3aed1f8aff9e92dc16a0 HTTP/1.1
>
< HTTP/1.1 201 Created
< Location: http://127.0.0.1:5984/albums/70b50bfa0a4b3aed1f8aff9e92dc16a0
< ETag: \(dq1\-e89c99d29d06671fa0a4b3ae8aff9e\(dq
<
{\(dqok\(dq:true,\(dqid\(dq:\(dq70b50bfa0a4b3aed1f8aff9e92dc16a0\(dq,\(dqrev\(dq:\(dq1\-e89c99d29d06671fa0a4b3ae8aff9e\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
We’re getting back the \fI\%201 Created\fP HTTP status code in the response
headers, as we saw earlier when we created a database. The \fI\%Location\fP
header gives us a full URL to our newly created document. And there’s a new
header. An \fI\%ETag\fP in HTTP\-speak identifies a specific version of a
resource. In this case, it identifies a specific version (the first one) of our
new document. Sound familiar? Yes, conceptually, an \fI\%ETag\fP is the same
as a CouchDB document revision number, and it shouldn’t come as a surprise that
CouchDB uses revision numbers for ETags. ETags are useful for caching
infrastructures.
.SS Attachments
.sp
CouchDB documents can have attachments just like an email message can have
attachments. An attachment is identified by a name and includes its MIME type
(or \fI\%Content\-Type\fP) and the number of bytes the attachment
contains. Attachments can be any data. It is easiest to think about attachments
as files attached to a document. These files can be text, images, Word
documents, music, or movie files. Let’s make one.
.sp
Attachments get their own URL where you can upload data. Say we want to add
the album artwork to the \fB6e1295ed6c29495e54cc05947f18c8af\fP document
(\fI“There is Nothing Left to Lose”\fP), and let’s also say the artwork is in a file
\fIartwork.jpg\fP in the current directory:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-vX PUT http://admin:password@127.0.0.1:5984/albums/6e1295ed6c29495e54cc05947f18c8af/artwork.jpg?rev=2\-2739352689 \e
     \-\-data\-binary @artwork.jpg \-H \(dqContent\-Type:image/jpg\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
The \fB\-\-data\-binary\fP \fB@\fP option tells curl to read a file’s contents into
the HTTP request body. We’re using the \fB\-H\fP option to tell CouchDB that
we’re uploading a JPEG file. CouchDB will keep this information around and
will send the appropriate header when requesting this attachment; in case of
an image like this, a browser will render the image instead of offering you
the data for download. This will come in handy later. Note that you need
to provide the current revision number of the document you’re attaching
the artwork to, just as if you would update the document. Because, after
all, attaching some data is changing the document.
.UNINDENT
.UNINDENT
.sp
You should now see your artwork image if you point your browser to
\fI\%http://127.0.0.1:5984/albums/6e1295ed6c29495e54cc05947f18c8af/artwork.jpg\fP
.sp
If you request the document again, you’ll see a new member:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl http://admin:password@127.0.0.1:5984/albums/6e1295ed6c29495e54cc05947f18c8af
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB replies:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dq6e1295ed6c29495e54cc05947f18c8af\(dq,
    \(dq_rev\(dq: \(dq3\-131533518\(dq,
    \(dqtitle\(dq: \(dqThere is Nothing Left to Lose\(dq,
    \(dqartist\(dq: \(dqFoo Fighters\(dq,
    \(dqyear\(dq: \(dq1997\(dq,
    \(dq_attachments\(dq: {
        \(dqartwork.jpg\(dq: {
            \(dqstub\(dq: true,
            \(dqcontent_type\(dq: \(dqimage/jpg\(dq,
            \(dqlength\(dq: 52450
        }
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fB_attachments\fP is a list of keys and values where the values are JSON objects
containing the attachment metadata. \fBstub=true\fP tells us that this entry is
just the metadata. If we use the \fB?attachments=true\fP HTTP option when
requesting this document, we’d get a \fI\%Base64\fP encoded string containing the
attachment data.
.sp
We’ll have a look at more document request options later as we explore more
features of CouchDB, such as replication, which is the next topic.
.SS Replication
.sp
CouchDB replication is a mechanism to synchronize databases. Much like \fI\%rsync\fP
synchronizes two directories locally or over a network, replication synchronizes
two databases locally or remotely.
.sp
In a simple \fI\%POST\fP request, you tell CouchDB the \fIsource\fP and the
\fItarget\fP of a replication and CouchDB will figure out which documents and new
document revisions are on \fIsource\fP that are not yet on \fItarget\fP, and will
proceed  to move the missing documents and revisions over.
.sp
We’ll take an in\-depth look at replication in the document
\fI\%Introduction to Replication\fP; in this document, we’ll just show you how to use it.
.sp
First, we’ll create a target database. Note that CouchDB won’t automatically
create a target database for you, and will return a replication failure if
the target doesn’t exist (likewise for the source, but that mistake isn’t as
easy to make):
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X PUT http://admin:password@127.0.0.1:5984/albums\-replica
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Now we can use the database \fIalbums\-replica\fP as a replication target:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-vX POST http://admin:password@127.0.0.1:5984/_replicate \e
     \-d \(aq{\(dqsource\(dq:\(dqhttp://127.0.0.1:5984/albums\(dq,\(dqtarget\(dq:\(dqhttp://127.0.0.1:5984/albums\-replica\(dq}\(aq \e
     \-H \(dqContent\-Type: application/json\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
As of CouchDB 2.0.0, fully qualified URLs are required for both the
replication \fBsource\fP and \fBtarget\fP parameters.
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
CouchDB supports the option \fB\(dqcreate_target\(dq:true\fP placed in the JSON
POSTed to the \fI\%_replicate\fP URL. It implicitly
creates the target database if it doesn’t exist.
.UNINDENT
.UNINDENT
.sp
CouchDB replies (this time we formatted the output so you can read it more
easily):
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqhistory\(dq: [
        {
            \(dqstart_last_seq\(dq: 0,
            \(dqmissing_found\(dq: 2,
            \(dqdocs_read\(dq: 2,
            \(dqend_last_seq\(dq: 5,
            \(dqmissing_checked\(dq: 2,
            \(dqdocs_written\(dq: 2,
            \(dqdoc_write_failures\(dq: 0,
            \(dqend_time\(dq: \(dqSat, 11 Jul 2009 17:36:21 GMT\(dq,
            \(dqstart_time\(dq: \(dqSat, 11 Jul 2009 17:36:20 GMT\(dq
        }
    ],
    \(dqsource_last_seq\(dq: 5,
    \(dqsession_id\(dq: \(dq924e75e914392343de89c99d29d06671\(dq,
    \(dqok\(dq: true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB maintains a \fIsession history\fP of replications. The response for a
replication request contains the history entry for this \fIreplication session\fP\&.
It is also worth noting that the request for replication will stay open until
replication closes. If you have a lot of documents, it’ll take a while until
they are all replicated and you won’t get back the replication response
until all documents are replicated. It is important to note that
replication replicates the database only as it was at the point in time
when replication was started. So, any additions, modifications,
or deletions subsequent to the start of replication will not be replicated.
.sp
We’ll punt on the details again – the \fB\(dqok\(dq: true\fP at the end tells us all
went well. If you now have a look at the albums\-replica database,
you should see all the documents that you created in the albums database.
Neat, eh?
.sp
What you just did is called local replication in CouchDB terms. You created a
local copy of a database. This is useful for backups or to keep snapshots of
a specific state of your data around for later. You might want to do this
if you are developing your applications but want to be able to roll back to
a stable version of your code and data.
.sp
There are more types of replication useful in other situations. The source
and target members of our replication request are actually links (like in
HTML) and so far we’ve seen links relative to the server we’re working on
(hence local). You can also specify a remote database as the target:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-vX POST http://admin:password@127.0.0.1:5984/_replicate \e
     \-d \(aq{\(dqsource\(dq:\(dqhttp://127.0.0.1:5984/albums\(dq,\(dqtarget\(dq:\(dqhttp://example.org:5984/albums\-replica\(dq}\(aq \e
     \-H \(dqContent\-Type:application/json\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Using a \fIlocal source\fP and a \fIremote target\fP database is called \fIpush
replication\fP\&. We’re pushing changes to a remote server.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Since we don’t have a second CouchDB server around just yet, we’ll just use
the absolute address of our single server, but you should be able to infer
from this that you can put any remote server in there.
.UNINDENT
.UNINDENT
.sp
This is great for sharing local changes with remote servers or buddies next
door.
.sp
You can also use a \fIremote source\fP and a \fIlocal target\fP to do a \fIpull
replication\fP\&. This is great for getting the latest changes from a server that
is used by others:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-vX POST http://admin:password@127.0.0.1:5984/_replicate \e
     \-d \(aq{\(dqsource\(dq:\(dqhttp://example.org:5984/albums\-replica\(dq,\(dqtarget\(dq:\(dqhttp://127.0.0.1:5984/albums\(dq}\(aq \e
     \-H \(dqContent\-Type:application/json\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Finally, you can run remote replication, which is mostly useful for management
operations:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-vX POST http://admin:password@127.0.0.1:5984/_replicate \e
     \-d \(aq{\(dqsource\(dq:\(dqhttp://example.org:5984/albums\(dq,\(dqtarget\(dq:\(dqhttp://example.org:5984/albums\-replica\(dq}\(aq \e
     \-H\(dqContent\-Type: application/json\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
\fBCouchDB and REST\fP
.sp
CouchDB prides itself on having a \fI\%RESTful\fP API, but these replication
requests don’t look very RESTy to the trained eye. What’s up with that?
While CouchDB’s core database, document, and attachment API are RESTful,
not all of CouchDB’s API is. The replication API is one example. There are
more, as we’ll see later in the documents.
.sp
Why are there RESTful and non\-RESTful APIs mixed up here? Have the
developers been too lazy to go REST all the way? Remember, REST is an
architectural style that lends itself to certain architectures (such as the
CouchDB document API). But it is not a one\-size\-fits\-all. Triggering an
event like replication does not make a whole lot of sense in the REST world.
It is more like a traditional remote procedure call. And there is nothing
wrong with this.
.sp
We very much believe in the “use the right tool for the job” philosophy,
and REST does not fit every job. For support, we refer to Leonard Richardson
and Sam Ruby who wrote \fI\%RESTful Web Services\fP (O’Reilly), as they share our
view.
.UNINDENT
.UNINDENT
.SS Wrapping Up
.sp
This is still not the full CouchDB API, but we discussed the essentials in
great detail. We’re going to fill in the blanks as we go. For now, we believe
you’re ready to start building CouchDB applications.
.sp
\fBSEE ALSO:\fP
.INDENT 0.0
.INDENT 3.5
\fI\%Complete HTTP API Reference\fP:
.INDENT 0.0
.IP \(bu 2
\fI\%Server API Reference\fP
.IP \(bu 2
\fI\%Database API Reference\fP
.IP \(bu 2
\fI\%Document API Reference\fP
.IP \(bu 2
\fI\%Replication API\fP
.UNINDENT
.UNINDENT
.UNINDENT
.SH REPLICATION
.sp
Replication is an incremental one way process involving two databases
(a source and a destination).
.sp
The aim of replication is that at the end of the process, all active
documents in the source database are also in the destination database
and all documents that were deleted in the source database are also
deleted in the destination database (if they even existed).
.sp
The replication process only copies the last revision of a document, so all
previous revisions that were only in the source database are not copied to the
destination database.
.SS Introduction to Replication
.sp
One of CouchDB’s strengths is the ability to synchronize two copies of the same
database. This enables users to distribute data across several nodes or
data centers, but also to move data more closely to clients.
.sp
Replication involves a source and a destination database, which can be on the
same or on different CouchDB instances. The aim of replication is that at
the end of the process, all active documents in the source database are also in
the destination database and all documents that were deleted in the source
database are also deleted in the destination database (if they even existed).
.SS Transient and Persistent Replication
.sp
There are two different ways to set up a replication. The first one that was
introduced into CouchDB leads to a replication that could be called \fItransient\fP\&.
Transient means that there are no documents backing up the replication. So after a
restart of the CouchDB server the replication will disappear. Later, the
\fI\%_replicator\fP database was introduced, which keeps documents
containing your replication parameters. Such a replication can be called \fIpersistent\fP\&.
Transient replications were kept for backward compatibility. Both replications can
have different \fI\%replication states\fP\&.
.SS Triggering, Stopping and Monitoring Replications
.sp
A persistent replication is controlled through a document in the
\fI\%_replicator\fP database, where each document describes one
replication process (see \fI\%Replication Settings\fP). For setting up a
transient replication the api endpoint
\fI\%/_replicate\fP can be used. A replication is triggered
by sending a JSON object either to the \fB_replicate\fP endpoint or storing it as a
document into the \fB_replicator\fP database.
.sp
If a replication is currently running its status can be inspected through the
active tasks API (see \fI\%/_active_tasks\fP, \fI\%Replication Status\fP
and \fI\%/_scheduler/jobs\fP).
.sp
For document based\-replications, \fI\%/_scheduler/docs\fP can be used to
get a complete state summary. This API is preferred as it will show the state of the
replication document before it becomes a replication job.
.sp
For transient replications there is no way to query their state when the job is
finished.
.sp
A replication can be stopped by deleting the document, or by updating it with
its \fBcancel\fP property set to \fBtrue\fP\&.
.SS Replication Procedure
.sp
During replication, CouchDB will compare the source and the destination
database to determine which documents differ between the source and the
destination database. It does so by following the \fI\%Changes Feeds\fP on the source
and comparing the documents to the destination. Changes are submitted to the
destination in batches where they can introduce conflicts. Documents that
already exist on the destination in the same revision are not transferred. As
the deletion of documents is represented by a new revision, a document deleted
on the source will also be deleted on the target.
.sp
A replication task will finish once it reaches the end of the changes feed. If
its \fBcontinuous\fP property is set to true, it will wait for new changes to
appear until the task is canceled. Replication tasks also create checkpoint
documents on the destination to ensure that a restarted task can continue from
where it stopped, for example after it has crashed.
.sp
When a replication task is initiated on the sending node, it is called \fIpush\fP
replication, if it is initiated by the receiving node, it is called \fIpull\fP
replication.
.SS Master \- Master replication
.sp
One replication task will only transfer changes in one direction. To achieve
master\-master replication, it is possible to set up two replication tasks in
opposite direction. When a change is replicated from database A to B by the
first task, the second task from B to A will discover that the new change on
B already exists in A and will wait for further changes.
.SS Controlling which Documents to Replicate
.sp
There are three options for controlling which documents are replicated,
and which are skipped:
.INDENT 0.0
.IP 1. 3
Defining documents as being local.
.IP 2. 3
Using \fI\%Selector Objects\fP\&.
.IP 3. 3
Using \fI\%Filter Functions\fP\&.
.UNINDENT
.sp
Local documents are never replicated (see \fI\%Local (non\-replicating) Documents\fP).
.sp
\fI\%Selector Objects\fP can be included in a replication document (see
\fI\%Replication Settings\fP). A selector object contains a query expression
that is used to test whether a document should be replicated.
.sp
\fI\%Filter Functions\fP can be used in a replication (see
\fI\%Replication Settings\fP). The replication task evaluates
the filter function for each document in the changes feed. The document is
only replicated if the filter returns \fBtrue\fP\&.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Using a selector provides performance benefits when compared with using a
\fI\%Filter Functions\fP\&. You should use \fI\%Selector Objects\fP where possible.
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
When using replication filters that depend on the document’s content,
deleted documents may pose a problem, since the document passed to the
filter will not contain any of the document’s content. This can be
resolved by adding a \fB_deleted:true\fP field to the document instead
of using the DELETE HTTP method, paired with the use of a
\fI\%validate document update\fP handler to ensure the fields
required for replication filters are always present. Take note, though,
that the deleted document will still contain all of its data (including
attachments)!
.UNINDENT
.UNINDENT
.SS Migrating Data to Clients
.sp
Replication can be especially useful for bringing data closer to clients.
\fI\%PouchDB\fP implements the replication algorithm of CouchDB
in JavaScript, making it possible to make data from a CouchDB database
available in an offline browser application, and synchronize changes back to
CouchDB.
.SS Replicator Database
.sp
Changed in version 2.1.0: Scheduling replicator was introduced.
Replication states, by default are not written back to documents
anymore. There are new replication job states and new API endpoints
\fB_scheduler/jobs\fP and \fB_scheduler/docs\fP\&.

.sp
Changed in version 3.2.0: Fair share scheduling was introduced. Multiple
\fB_replicator\fP databases get an equal chance (configurable) of running
their jobs. Previously replication jobs were scheduled without any regard of
their originating database.

.sp
Changed in version 3.3.0: \fBwinning_revs_only: true\fP replicator option to
replicate the winning document revisions.

.sp
The \fB_replicator\fP database works like any other in CouchDB, but
documents added to it will trigger replications. Create (\fBPUT\fP or
\fBPOST\fP) a document to start replication. \fBDELETE\fP a replication
document to cancel an ongoing replication.
.sp
These documents have exactly the same content as the JSON objects we used to
\fBPOST\fP to \fB_replicate\fP (fields \fBsource\fP, \fBtarget\fP, \fBcreate_target\fP,
\fBcreate_target_params\fP, \fBcontinuous\fP, \fBdoc_ids\fP, \fBfilter\fP,
\fBquery_params\fP, \fBuse_checkpoints\fP, \fBcheckpoint_interval\fP).
.sp
Replication documents can have a user defined \fB_id\fP (handy for finding
a specific replication request later). Design Documents (and \fB_local\fP
documents) added to the replicator database are ignored.
.sp
The default replicator database is \fB_replicator\fP\&. Additional
replicator databases can be created. To be recognized as such by the
system, their database names should end with \fB/_replicator\fP\&.
.SS Basics
.sp
Let’s say you POST the following document into \fB_replicator\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dqmy_rep\(dq,
    \(dqsource\(dq: \(dqhttp://myserver.com/foo\(dq,
    \(dqtarget\(dq: {
        \(dqurl\(dq: \(dqhttp://localhost:5984/bar\(dq,
        \(dqauth\(dq: {
            \(dqbasic\(dq: {
                \(dqusername\(dq: \(dquser\(dq,
                \(dqpassword\(dq: \(dqpass\(dq
            }
        }
    },
    \(dqcreate_target\(dq:  true,
    \(dqcontinuous\(dq: true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
In the couch log you’ll see 2 entries like these:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[notice] 2017\-04\-05T17:16:19.646716Z node1@127.0.0.1 <0.29432.0> \-\-\-\-\-\-\-\- Replication \(ga\(dqa81a78e822837e66df423d54279c15fe+continuous+create_target\(dq\(ga is using:
    4 worker processes
    a worker batch size of 500
    20 HTTP connections
    a connection timeout of 30000 milliseconds
    10 retries per request
    socket options are: [{keepalive,true},{nodelay,false}]
[notice] 2017\-04\-05T17:16:19.646759Z node1@127.0.0.1 <0.29432.0> \-\-\-\-\-\-\-\- Document \(gamy_rep\(ga triggered replication \(gaa81a78e822837e66df423d54279c15fe+continuous+create_target\(ga
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Replication state of this document can then be queried from
\fBhttp://adm:pass@localhost:5984/_scheduler/docs/_replicator/my_rep\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqdatabase\(dq: \(dq_replicator\(dq,
    \(dqdoc_id\(dq: \(dqmy_rep\(dq,
    \(dqerror_count\(dq: 0,
    \(dqid\(dq: \(dqa81a78e822837e66df423d54279c15fe+continuous+create_target\(dq,
    \(dqinfo\(dq: {
        \(dqrevisions_checked\(dq: 113,
        \(dqmissing_revisions_found\(dq: 113,
        \(dqdocs_read\(dq: 113,
        \(dqdocs_written\(dq: 113,
        \(dqchanges_pending\(dq: 0,
        \(dqdoc_write_failures\(dq: 0,
        \(dqcheckpointed_source_seq\(dq: \(dq113\-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV0MDQy1zMAQsMckEQiQ1L9____szKYE01ygQLsZsYGqcamiZjKcRqRxwIkGRqA1H\-oSbZgk1KMLCzTDE0wdWUBAF6HJIQ\(dq,
        \(dqsource_seq\(dq: \(dq113\-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV0MDQy1zMAQsMckEQiQ1L9____szKYE01ygQLsZsYGqcamiZjKcRqRxwIkGRqA1H\-oSbZgk1KMLCzTDE0wdWUBAF6HJIQ\(dq,
        \(dqthrough_seq\(dq: \(dq113\-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV0MDQy1zMAQsMckEQiQ1L9____szKYE01ygQLsZsYGqcamiZjKcRqRxwIkGRqA1H\-oSbZgk1KMLCzTDE0wdWUBAF6HJIQ\(dq
    },
    \(dqlast_updated\(dq: \(dq2017\-04\-05T19:18:15Z\(dq,
    \(dqnode\(dq: \(dqnode1@127.0.0.1\(dq,
    \(dqsource_proxy\(dq: null,
    \(dqtarget_proxy\(dq: null,
    \(dqsource\(dq: \(dqhttp://myserver.com/foo/\(dq,
    \(dqstart_time\(dq: \(dq2017\-04\-05T19:18:15Z\(dq,
    \(dqstate\(dq: \(dqrunning\(dq,
    \(dqtarget\(dq: \(dqhttp://localhost:5984/bar/\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The state is \fBrunning\fP\&. That means replicator has scheduled this
replication job to run. Replication document contents stay the same.
Previously, before version 2.1, it was updated with the \fBtriggered\fP
state.
.sp
The replication job will also appear in
.sp
\fBhttp://adm:pass@localhost:5984/_scheduler/jobs\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqjobs\(dq: [
        {
            \(dqdatabase\(dq: \(dq_replicator\(dq,
            \(dqdoc_id\(dq: \(dqmy_rep\(dq,
            \(dqhistory\(dq: [
                {
                    \(dqtimestamp\(dq: \(dq2017\-04\-05T19:18:15Z\(dq,
                    \(dqtype\(dq: \(dqstarted\(dq
                },
                {
                    \(dqtimestamp\(dq: \(dq2017\-04\-05T19:18:15Z\(dq,
                    \(dqtype\(dq: \(dqadded\(dq
                }
            ],
            \(dqid\(dq: \(dqa81a78e822837e66df423d54279c15fe+continuous+create_target\(dq,
            \(dqinfo\(dq: {
                \(dqchanges_pending\(dq: 0,
                \(dqcheckpointed_source_seq\(dq: \(dq113\-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV0MDQy1zMAQsMckEQiQ1L9____szKYE01ygQLsZsYGqcamiZjKcRqRxwIkGRqA1H\-oSbZgk1KMLCzTDE0wdWUBAF6HJIQ\(dq,
                \(dqdoc_write_failures\(dq: 0,
                \(dqdocs_read\(dq: 113,
                \(dqdocs_written\(dq: 113,
                \(dqmissing_revisions_found\(dq: 113,
                \(dqrevisions_checked\(dq: 113,
                \(dqsource_seq\(dq: \(dq113\-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV0MDQy1zMAQsMckEQiQ1L9____szKYE01ygQLsZsYGqcamiZjKcRqRxwIkGRqA1H\-oSbZgk1KMLCzTDE0wdWUBAF6HJIQ\(dq,
                \(dqthrough_seq\(dq: \(dq113\-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV0MDQy1zMAQsMckEQiQ1L9____szKYE01ygQLsZsYGqcamiZjKcRqRxwIkGRqA1H\-oSbZgk1KMLCzTDE0wdWUBAF6HJIQ\(dq
            },
            \(dqnode\(dq: \(dqnode1@127.0.0.1\(dq,
            \(dqpid\(dq: \(dq<0.1174.0>\(dq,
            \(dqsource\(dq: \(dqhttp://myserver.com/foo/\(dq,
            \(dqstart_time\(dq: \(dq2017\-04\-05T19:18:15Z\(dq,
            \(dqtarget\(dq: \(dqhttp://localhost:5984/bar/\(dq,
            \(dquser\(dq: null
        }
    ],
    \(dqoffset\(dq: 0,
    \(dqtotal_rows\(dq: 1
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fB_scheduler/jobs\fP shows more information, such as a detailed history of
state changes. If a persistent replication has not yet started,
has failed, or is completed, information about its state can only be found
in \fB_scheduler/docs\fP\&. Keep in mind that some replication documents could be
invalid and could not become a replication job. Others might be delayed
because they are fetching data from a slow source database.
.sp
If there is an error, for example if the source database is missing, the
replication job will crash and retry after a wait period. Each
successive crash will result in a longer waiting period.
.sp
For example, POST\-ing this document
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dqmy_rep_crashing\(dq,
    \(dqsource\(dq: \(dqhttp://myserver.com/missing\(dq,
    \(dqtarget\(dq: {
        \(dqurl\(dq: \(dqhttp://localhost:5984/bar\(dq,
        \(dqauth\(dq: {
            \(dqbasic\(dq: {
                \(dqusername\(dq: \(dquser\(dq,
                \(dqpassword\(dq: \(dqpass\(dq
            }
        }
    },
    \(dqcreate_target\(dq:  true,
    \(dqcontinuous\(dq: true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
when source database is missing, will result in periodic starts and
crashes with an increasingly larger interval. The \fBhistory\fP list from
\fB_scheduler/jobs\fP for this replication would look something like this:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
      {
          \(dqreason\(dq: \(dqdb_not_found: could not open http://adm:*****@localhost:5984/missing/\(dq,
          \(dqtimestamp\(dq: \(dq2017\-04\-05T20:55:10Z\(dq,
          \(dqtype\(dq: \(dqcrashed\(dq
      },
      {
          \(dqtimestamp\(dq: \(dq2017\-04\-05T20:55:10Z\(dq,
          \(dqtype\(dq: \(dqstarted\(dq
      },
      {
          \(dqreason\(dq: \(dqdb_not_found: could not open http://adm:*****@localhost:5984/missing/\(dq,
          \(dqtimestamp\(dq: \(dq2017\-04\-05T20:47:10Z\(dq,
          \(dqtype\(dq: \(dqcrashed\(dq
      },
      {
          \(dqtimestamp\(dq: \(dq2017\-04\-05T20:47:10Z\(dq,
          \(dqtype\(dq: \(dqstarted\(dq
      }
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fB_scheduler/docs\fP shows a shorter summary:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
      \(dqdatabase\(dq: \(dq_replicator\(dq,
      \(dqdoc_id\(dq: \(dqmy_rep_crashing\(dq,
      \(dqerror_count\(dq: 6,
      \(dqid\(dq: \(dqcb78391640ed34e9578e638d9bb00e44+create_target\(dq,
      \(dqinfo\(dq: {
           \(dqerror\(dq: \(dqdb_not_found: could not open http://myserver.com/missing/\(dq
      },
      \(dqlast_updated\(dq: \(dq2017\-04\-05T20:55:10Z\(dq,
      \(dqnode\(dq: \(dqnode1@127.0.0.1\(dq,
      \(dqsource_proxy\(dq: null,
      \(dqtarget_proxy\(dq: null,
      \(dqsource\(dq: \(dqhttp://myserver.com/missing/\(dq,
      \(dqstart_time\(dq: \(dq2017\-04\-05T20:38:34Z\(dq,
      \(dqstate\(dq: \(dqcrashing\(dq,
      \(dqtarget\(dq: \(dqhttp://localhost:5984/bar/\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Repeated crashes are described as a \fBcrashing\fP state. \fB\-ing\fP suffix
implies this is a temporary state. User at any moment could create the
missing database and then replication job could return back to the
normal.
.SS Documents describing the same replication
.sp
Lets suppose 2 documents are added to the \fB_replicator\fP database in
the following order:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dqmy_rep\(dq,
    \(dqsource\(dq: \(dqhttp://myserver.com/foo\(dq,
    \(dqtarget\(dq:  \(dqhttp://user:pass@localhost:5984/bar\(dq,
    \(dqcreate_target\(dq:  true,
    \(dqcontinuous\(dq: true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
and
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dqmy_rep_dup\(dq,
    \(dqsource\(dq: \(dqhttp://myserver.com/foo\(dq,
    \(dqtarget\(dq:  \(dqhttp://user:pass@localhost:5984/bar\(dq,
    \(dqcreate_target\(dq:  true,
    \(dqcontinuous\(dq: true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Both describe exactly the same replication (only their \fB_ids\fP differ).
In this case document \fBmy_rep\fP triggers the replication, while
\fBmy_rep_dup\(ga\fP will fail. Inspecting \fB_scheduler/docs\fP explains
exactly why it failed:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqdatabase\(dq: \(dq_replicator\(dq,
    \(dqdoc_id\(dq: \(dqmy_rep_dup\(dq,
    \(dqerror_count\(dq: 1,
    \(dqid\(dq: null,
    \(dqinfo\(dq: {
        \(dqerror\(dq: \(dqReplication \(gaa81a78e822837e66df423d54279c15fe+continuous+create_target\(ga specified by document \(gamy_rep_dup\(ga already started, triggered by document \(gamy_rep\(ga from db \(ga_replicator\(ga\(dq
    },
    \(dqlast_updated\(dq: \(dq2017\-04\-05T21:41:51Z\(dq,
    \(dqsource\(dq: \(dqhttp://myserver.com/foo/\(dq,
    \(dqstart_time\(dq: \(dq2017\-04\-05T21:41:51Z\(dq,
    \(dqstate\(dq: \(dqfailed\(dq,
    \(dqtarget\(dq: \(dqhttp://user:****@localhost:5984/bar\(dq,
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Notice the state for this replication is \fBfailed\fP\&. Unlike
\fBcrashing\fP, \fBfailed\fP state is terminal. As long as both documents
are present the replicator will not retry to run \fBmy_rep_dup\fP
replication. Another reason could be malformed documents. For example if
worker process count is specified as a string (\fB\(dqworker_processes\(dq: \(dqa
few\(dq\fP) instead of an integer, failure will occur.
.SS Replication Scheduler
.sp
Once replication jobs are created they are managed by the scheduler. The
scheduler is the replication component which periodically stops some
jobs and starts others. This behavior makes it possible to have a
larger number of jobs than the cluster could run simultaneously.
Replication jobs which keep failing will be penalized and forced to
wait. The wait time increases exponentially with each consecutive
failure.
.sp
When deciding which jobs to stop and which to start, the scheduler uses
a round\-robin algorithm to ensure fairness. Jobs which have been running
the longest time will be stopped, and jobs which have been waiting the
longest time will be started.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Non\-continuous (normal) replication are treated differently
once they start running. See \fI\%Normal vs Continuous Replications\fP section for more information.
.UNINDENT
.UNINDENT
.sp
The behavior of the scheduler can configured via \fBmax_jobs\fP,
\fBinterval\fP and \fBmax_churn\fP options. See \fI\%Replicator
configuration section\fP for additional information.
.SS Replication states
.sp
Replication jobs during their life\-cycle pass through various states.
This is a diagram of all the states and transitions between them:
.INDENT 0.0
.INDENT 2.5
[image: Replication state diagram]
[image]
Replication state diagram.UNINDENT
.UNINDENT
.sp
Blue and yellow shapes represent replication job states.
.sp
Trapezoidal shapes represent external APIs, that’s how users interact
with the replicator. Writing documents to \fB_replicator\fP is the
preferred way of creating replications, but posting to the
\fB_replicate\fP HTTP endpoint is also supported.
.sp
Six\-sided shapes are internal API boundaries. They are optional for this
diagram and are only shown as additional information to help clarify how the
replicator works. There are two processing stages: the first is where
replication documents are parsed and become replication jobs, and the second is
the scheduler itself. The scheduler runs replication jobs, periodically
stopping and starting some. Jobs posted via the \fB_replicate\fP endpoint bypass
the first component and go straight to the scheduler.
.SS States descriptions
.sp
Before explaining the details of each state, it is worth noticing that
color and shape of each state in the diagram:
.sp
\fIBlue\fP vs \fIyellow\fP partitions states into “healthy” and “unhealthy”,
respectively. Unhealthy states indicate something has gone wrong and it
might need user’s attention.
.sp
\fIRectangle\fP vs \fIoval\fP separates “terminal” states from “non\-terminal”
ones. Terminal states are those which will not transition to other
states any more. Informally, jobs in a terminal state will not be
retried and don’t consume memory or CPU resources.
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.IP \(bu 2
\fBInitializing\fP: Indicates replicator has noticed the change from
the replication document. Jobs should transition quickly through this
state. Being stuck here for a while could mean there is an internal
error.
.IP \(bu 2
\fBFailed\fP: Replication document could not be processed and turned
into a valid replication job for the scheduler. This state is
terminal and requires user intervention to fix the problem. A typical
reason for ending up in this state is a malformed document. For
example, specifying an integer for a parameter which accepts a
boolean. Another reason for failure could be specifying a duplicate
replication. A duplicate replication is a replication with identical
parameters but a different document ID.
.IP \(bu 2
\fBError\fP: Replication document update could not be turned into a
replication job. Unlike the \fBFailed\fP state, this one is temporary,
and replicator will keep retrying periodically. There is an
exponential backoff applied in case of consecutive failures. The main
reason this state exists is to handle filtered replications with
custom user functions. Filter function content is needed in order to
calculate the replication ID. A replication job could not be created
until the function code is retrieved. Because retrieval happens over
the network, temporary failures have to be handled.
.IP \(bu 2
\fBRunning\fP: Replication job is running normally. This means, there
might be a change feed open, and if changes are noticed, they would
be processed and posted to the target. Job is still considered
\fBRunning\fP even if its workers are currently not streaming changes
from source to target and are just waiting on the change feed.
Continuous replications will most likely end up in this state.
.IP \(bu 2
\fBPending\fP: Replication job is not running and is waiting its turn.
This state is reached when the number of replication jobs added to
the scheduler exceeds \fBreplicator.max_jobs\fP\&. In that case scheduler
will periodically stop and start subsets of jobs trying to give each
one a fair chance at making progress.
.IP \(bu 2
\fBCrashing\fP: Replication job has been successfully added to the
replication scheduler. However an error was encountered during the
last run. Error could be a network failure, a missing source
database, a permissions error, etc. Repeated consecutive crashes
result in an exponential backoff. This state is considered temporary
(non\-terminal) and replication jobs will be periodically retried.
.IP \(bu 2
\fBCompleted\fP: This is a terminal, successful state for
non\-continuous replications. Once in this state the replication is
“forgotten” by the scheduler and it doesn’t consume any more CPU or
memory resources. Continuous replication jobs will never reach this
state.
.UNINDENT
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Maximum backoff interval for states \fBError\fP and \fBCrashing\fP
is calculated based on the \fBreplicator.max_history\fP option.
See \fI\%Replicator configuration section\fP
for additional information.
.UNINDENT
.UNINDENT
.SS Normal vs Continuous Replications
.sp
Normal (non\-continuous) replications once started will be allowed to run
to completion. That behavior is to preserve their semantics of
replicating a snapshot of the source database to the target. For example
if new documents are added to the source after the replication are
started, those updates should not show up on the target database.
Stopping and restring a normal replication would violate that
constraint.
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
When there is a mix of continuous and normal replications,
once normal replication are scheduled to run, they might temporarily
starve continuous replication jobs.
.UNINDENT
.UNINDENT
.sp
However, normal replications will still be stopped and rescheduled if an
operator reduces the value for the maximum number of replications. This
is so that if an operator decides replications are overwhelming a node
that it has the ability to recover. Any stopped replications will be
resubmitted to the queue to be rescheduled.
.SS Compatibility Mode
.sp
Previous version of CouchDB replicator wrote state updates back to
replication documents. In cases where user code programmatically read
those states, there is compatibility mode enabled via a configuration
setting:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
update_docs = true
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
In this mode replicator will continue to write state updates to the
documents.
.sp
To effectively disable the scheduling behavior, which periodically stop
and starts jobs, set \fBmax_jobs\fP configuration setting to a large
number. For example:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
max_jobs = 9999999
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
See \fI\%Replicator configuration section\fP for
other replicator configuration options.
.SS Canceling replications
.sp
To cancel a replication simply \fBDELETE\fP the document which triggered
the replication. To update a replication, for example, change the number
of worker or the source, simply update the document with new data. If
there is extra application\-specific data in the replication documents,
that data is ignored by the replicator.
.SS Server restart
.sp
When CouchDB is restarted, it checks its \fB_replicator\fP databases and
restarts replications described by documents if they are not already in
in a \fBcompleted\fP or \fBfailed\fP state. If they are, they are ignored.
.SS Clustering
.sp
In a cluster, replication jobs are balanced evenly among all the nodes
nodes such that a replication job runs on only one node at a time.
.sp
Every time there is a cluster membership change, that is when nodes are
added or removed, as it happens in a rolling reboot, replicator
application will notice the change, rescan all the document and running
replication, and re\-evaluate their cluster placement in light of the new
set of live nodes. This mechanism also provides replication fail\-over in
case a node fails. Replication jobs started from replication documents
(but not those started from \fB_replicate\fP HTTP endpoint) will
automatically migrate one of the live nodes.
.SS Additional Replicator Databases
.sp
Imagine replicator database (\fB_replicator\fP) has these two documents
which represent pull replications from servers A and B:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dqrep_from_A\(dq,
    \(dqsource\(dq:  \(dqhttp://aserver.com:5984/foo\(dq,
    \(dqtarget\(dq: {
        \(dqurl\(dq: \(dqhttp://localhost:5984/foo_a\(dq,
        \(dqauth\(dq: {
            \(dqbasic\(dq: {
                \(dqusername\(dq: \(dquser\(dq,
                \(dqpassword\(dq: \(dqpass\(dq
            }
        }
    },
    \(dqcontinuous\(dq:  true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dqrep_from_B\(dq,
    \(dqsource\(dq:  \(dqhttp://bserver.com:5984/foo\(dq,
    \(dqtarget\(dq: {
        \(dqurl\(dq: \(dqhttp://localhost:5984/foo_b\(dq,
        \(dqauth\(dq: {
            \(dqbasic\(dq: {
                \(dqusername\(dq: \(dquser\(dq,
                \(dqpassword\(dq: \(dqpass\(dq
            }
        }
    },
    \(dqcontinuous\(dq:  true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Now without stopping and restarting CouchDB, add another replicator
database. For example \fBanother/_replicator\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \-X PUT http://user:pass@localhost:5984/another%2F_replicator/
{\(dqok\(dq:true}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
A / character in a database name, when used in a URL, should be escaped.
.UNINDENT
.UNINDENT
.sp
Then add a replication document to the new replicator database:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dqrep_from_X\(dq,
    \(dqsource\(dq:  \(dqhttp://xserver.com:5984/foo\(dq,
    \(dqtarget\(dq:  \(dqhttp://user:pass@localhost:5984/foo_x\(dq,
    \(dqcontinuous\(dq:  true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
From now on, there are three replications active in the system: two
replications from A and B, and a new one from X.
.sp
Then remove the additional replicator database:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \-X DELETE http://user:pass@localhost:5984/another%2F_replicator/
{\(dqok\(dq:true}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
After this operation, replication pulling from server X will be stopped
and the replications in the \fB_replicator\fP database (pulling from
servers A and B) will continue.
.SS Fair Share Job Scheduling
.sp
When multiple \fB_replicator\fP databases are used, and the total number
of jobs on any node is greater than \fBmax_jobs\fP, replication jobs
will be scheduled such that each of the \fB_replicator\fP databases by
default get an equal chance of running their jobs.
.sp
This is accomplished by assigning a number of “shares” to each
\fB_replicator\fP database and then automatically adjusting the
proportion of running jobs to match each database’s proportion of
shares. By default, each \fB_replicator\fP database is assigned 100
shares. It is possible to alter the share assignments for each
individual \fB_replicator\fP database in the \fI\%[replicator.shares]\fP configuration section.
.sp
The fair share behavior is perhaps easier described with a set of
examples. Each example assumes the default of \fBmax_jobs = 500\fP, and
two replicator databases: \fB_replicator\fP and \fBanother/_replicator\fP\&.
.sp
Example 1: If \fB_replicator\fP has 1000 jobs and
\fBanother/_replicator\fP has 10, the scheduler will run about 490 jobs
from \fB_replicator\fP and 10 jobs from \fBanother/_replicator\fP\&.
.sp
Example 2: If \fB_replicator\fP has 200 jobs and \fBanother/_replicator\fP
also has 200 jobs, all 400 jobs will get to run as the sum of all the
jobs is less than the \fBmax_jobs\fP limit.
.sp
Example 3: If both replicator databases have 1000 jobs each, the
scheduler will run about 250 jobs from each database on average.
.sp
Example 4: If both replicator databases have 1000 jobs each, but
\fB_replicator\fP was assigned 400 shares, then on average the scheduler
would run about 400 jobs from \fB_replicator\fP and 100 jobs from
\fB_another/replicator\fP\&.
.sp
The proportions described in the examples are approximate and might
oscillate a bit, and also might take anywhere from tens of minutes to
an hour to converge.
.SS Replicating the replicator database
.sp
Imagine you have in server C a replicator database with the two
following pull replication documents in it:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
     \(dq_id\(dq: \(dqrep_from_A\(dq,
     \(dqsource\(dq:  \(dqhttp://aserver.com:5984/foo\(dq,
     \(dqtarget\(dq:  \(dqhttp://user:pass@localhost:5984/foo_a\(dq,
     \(dqcontinuous\(dq:  true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
     \(dq_id\(dq: \(dqrep_from_B\(dq,
     \(dqsource\(dq:  \(dqhttp://bserver.com:5984/foo\(dq,
     \(dqtarget\(dq:  \(dqhttp://user:pass@localhost:5984/foo_b\(dq,
     \(dqcontinuous\(dq:  true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Now you would like to have the same pull replications going on in server
D, that is, you would like to have server D pull replicating from
servers A and B. You have two options:
.INDENT 0.0
.IP \(bu 2
Explicitly add two documents to server’s D replicator database
.IP \(bu 2
Replicate server’s C replicator database into server’s D replicator
database
.UNINDENT
.sp
Both alternatives accomplish exactly the same goal.
.SS Delegations
.sp
Replication documents can have a custom \fBuser_ctx\fP property. This
property defines the user context under which a replication runs. For
the old way of triggering a replication (POSTing to \fB/_replicate/\fP),
this property is not needed. That’s because information about the
authenticated user is readily available during the replication, which is
not persistent in that case. Now, with the replicator database, the
problem is that information about which user is starting a particular
replication is only present when the replication document is written.
The information in the replication document and the replication itself
are persistent, however. This implementation detail implies that in the
case of a non\-admin user, a \fBuser_ctx\fP property containing the user’s
name and a subset of their roles must be defined in the replication
document. This is enforced by the document update validation function
present in the default design document of the replicator database. The
validation function also ensures that non\-admin users are unable to set
the value of the user context’s \fBname\fP property to anything other than
their own user name. The same principle applies for roles.
.sp
For admins, the \fBuser_ctx\fP property is optional, and if it’s missing
it defaults to a user context with name \fBnull\fP and an empty list of
roles, which means design documents won’t be written to local targets.
If writing design documents to local targets is desired, the role
\fB_admin\fP must be present in the user context’s list of roles.
.sp
Also, for admins the \fBuser_ctx\fP property can be used to trigger a
replication on behalf of another user. This is the user context that
will be passed to local target database document validation functions.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
The \fBuser_ctx\fP property only has effect for local endpoints.
.UNINDENT
.UNINDENT
.sp
Example delegated replication document:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dqmy_rep\(dq,
    \(dqsource\(dq:  \(dqhttp://bserver.com:5984/foo\(dq,
    \(dqtarget\(dq:  \(dqhttp://user:pass@localhost:5984/bar\(dq,
    \(dqcontinuous\(dq:  true,
    \(dquser_ctx\(dq: {
        \(dqname\(dq: \(dqjoe\(dq,
        \(dqroles\(dq: [\(dqerlanger\(dq, \(dqresearcher\(dq]
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
As stated before, the \fBuser_ctx\fP property is optional for admins,
while being mandatory for regular (non\-admin) users. When the roles
property of \fBuser_ctx\fP is missing, it defaults to the empty list
\fB[]\fP\&.
.SS Selector Objects
.sp
Including a Selector Object in the replication document enables you to
use a query expression to determine if a document should be included in
the replication.
.sp
The selector specifies fields in the document, and provides an expression
to evaluate with the field content or other data. If the expression resolves
to \fBtrue\fP, the document is replicated.
.sp
The selector object must:
.INDENT 0.0
.IP \(bu 2
Be structured as valid JSON.
.IP \(bu 2
Contain a valid query expression.
.UNINDENT
.sp
The syntax for a selector is the same as the
\fI\%selectorsyntax\fP used for \fI\%_find\fP\&.
.sp
Using a selector is significantly more efficient than using a JavaScript
filter function, and is the recommended option if filtering on document
attributes only.
.SS Specifying Usernames and Passwords
.sp
There are multiple ways to specify usernames and passwords for replication endpoints:
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.IP \(bu 2
In an \fB{\(dqauth\(dq: {\(dqbasic\(dq: ...}}\fP object:
.INDENT 2.0
.INDENT 3.5
New in version 3.2.0.

.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqtarget\(dq: {
        \(dqurl\(dq: \(dqhttp://someurl.com/mydb\(dq,
        \(dqauth\(dq: {
            \(dqbasic\(dq: {
                \(dqusername\(dq: \(dq$username\(dq,
                \(dqpassword\(dq: \(dq$password\(dq
             }
        }
    },
    ...
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
This is the prefererred format as it allows including characters like \fB@\fP, \fB:\fP
and others in the username and password fields.
.IP \(bu 2
In the userinfo part of the endpoint URL. This allows for a more compact
endpoint represention however, it prevents using characters like \fB@\fP and \fB:\fP
in usernames or passwords:
.INDENT 2.0
.INDENT 3.5
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqtarget\(dq:  \(dqhttp://user:pass@localhost:5984/bar\(dq
    ...
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
Specifying credentials in the userinfo part of the URL is deprecated as per
\fI\%RFC3986\fP\&.
CouchDB still supports this way of specifying credentials and doesn’t yet
have a target release when support will be removed.
.IP \(bu 2
In an \fB\(dqAuthorization: Basic $b64encoded_username_and_password\(dq\fP header:
.INDENT 2.0
.INDENT 3.5
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqtarget\(dq: {
        \(dqurl\(dq: \(dqhttp://someurl.com/mydb\(dq,
            \(dqheaders\(dq: {
                \(dqAuthorization\(dq: \(dqBasic dXNlcjpwYXNz\(dq
            }
        },
    ...
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This method has the downside of the going through the extra step of base64
encoding. In addition, it could give the impression that it encrypts or
hides the credentials so it could encourage invadvertent sharing and
leaking credentials.
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
When credentials are provided in multiple forms, they are selected in the following order:
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.IP \(bu 2
\fB\(dqauth\(dq: {\(dqbasic\(dq: {...}}\fP object
.IP \(bu 2
URL userinfo
.IP \(bu 2
\fB\(dqAuthorization: Basic ...\(dq\fP header.
.UNINDENT
.UNINDENT
.UNINDENT
.sp
First, the \fBauth\fP object is checked, and if credentials are defined there,
they are used. If they are not, then URL userinfo is checked. If credentials
are found there, then those credentials are used, otherwise basic auth header
is used.
.SS Replicate Winning Revisions Only
.sp
Use the \fBwinning_revs_only: true\fP option to replicate “winning” document
revisions only. These are the revisions that would be returned by the \fBGET
db/doc\fP API endpoint by default, or appear in the \fB_changes\fP feed with the
default parameters.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST http://couchdb:5984/_replicate HTTP/1.1
Accept: application/json
Content\-Type: application/json

{
    \(dqwinning_revs_only\(dq : true
    \(dqsource\(dq : \(dqhttp://source:5984/recipes\(dq,
    \(dqtarget\(dq : \(dqhttp://target:5984/recipes\(dq,
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Replication with this mode discards conflicting revisions, so it could be one
way to remove conflicts through replication.
.sp
Replication IDs and checkpoint IDs, generated by \fBwinning_revs_only: true\fP
replications will be different than those generated by default, so it is
possible to first replicate the winning revisions, then later, to
“backfill” the rest of the revisions with a regular replication job.
.sp
\fBwinning_revs_only: true\fP option can be combined with filters or other
options like \fBcontinuous: true\fP or \fBcreate_target: true\fP\&.
.SS Replication and conflict model
.sp
Let’s take the following example to illustrate replication and conflict
handling.
.INDENT 0.0
.IP \(bu 2
Alice has a document containing Bob’s business card;
.IP \(bu 2
She synchronizes it between her desktop PC and her laptop;
.IP \(bu 2
On the desktop PC, she updates Bob’s E\-mail address;
Without syncing again, she updates Bob’s mobile number on the laptop;
.IP \(bu 2
Then she replicates the two to each other again.
.UNINDENT
.sp
So on the desktop the document has Bob’s new E\-mail address and his old mobile
number, and on the laptop it has his old E\-mail address and his new mobile
number.
.sp
The question is, what happens to these conflicting updated documents?
.SS CouchDB replication
.sp
CouchDB works with JSON documents inside databases. Replication of databases
takes place over HTTP, and can be either a “pull” or a “push”, but is
unidirectional. So the easiest way to perform a full sync is to do a “push”
followed by a “pull” (or vice versa).
.sp
So, Alice creates v1 and sync it. She updates to v2a on one side and v2b on the
other, and then replicates. What happens?
.sp
The answer is simple: both versions exist on both sides!
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
  DESKTOP                          LAPTOP
+\-\-\-\-\-\-\-\-\-+
| /db/bob |                                     INITIAL
|   v1    |                                     CREATION
+\-\-\-\-\-\-\-\-\-+

+\-\-\-\-\-\-\-\-\-+                      +\-\-\-\-\-\-\-\-\-+
| /db/bob |  \-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\->  | /db/bob |     PUSH
|   v1    |                      |   v1    |
+\-\-\-\-\-\-\-\-\-+                      +\-\-\-\-\-\-\-\-\-+

+\-\-\-\-\-\-\-\-\-+                      +\-\-\-\-\-\-\-\-\-+  INDEPENDENT
| /db/bob |                      | /db/bob |     LOCAL
|   v2a   |                      |   v2b   |     EDITS
+\-\-\-\-\-\-\-\-\-+                      +\-\-\-\-\-\-\-\-\-+

+\-\-\-\-\-\-\-\-\-+                      +\-\-\-\-\-\-\-\-\-+
| /db/bob |  \-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\->  | /db/bob |     PUSH
|   v2a   |                      |   v2a   |
+\-\-\-\-\-\-\-\-\-+                      |   v2b   |
                                 +\-\-\-\-\-\-\-\-\-+

+\-\-\-\-\-\-\-\-\-+                      +\-\-\-\-\-\-\-\-\-+
| /db/bob |  <\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-  | /db/bob |     PULL
|   v2a   |                      |   v2a   |
|   v2b   |                      |   v2b   |
+\-\-\-\-\-\-\-\-\-+                      +\-\-\-\-\-\-\-\-\-+
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
After all, this is not a file system, so there’s no restriction that only one
document can exist with the name /db/bob. These are just “conflicting” revisions
under the same name.
.sp
Because the changes are always replicated, the data is safe. Both machines have
identical copies of both documents, so failure of a hard drive on either side
won’t lose any of the changes.
.sp
Another thing to notice is that peers do not have to be configured or tracked.
You can do regular replications to peers, or you can do one\-off, ad\-hoc pushes
or pulls. After the replication has taken place, there is no record kept of
which peer any particular document or revision came from.
.sp
So the question now is: what happens when you try to read /db/bob? By default,
CouchDB picks one arbitrary revision as the “winner”, using a deterministic
algorithm so that the same choice will be made on all peers. The same happens
with views: the deterministically\-chosen winner is the only revision fed into
your map function.
.sp
Let’s say that the winner is v2a. On the desktop, if Alice reads the document
she’ll see v2a, which is what she saved there. But on the laptop, after
replication, she’ll also see only v2a. It could look as if the changes she made
there have been lost \- but of course they have not, they have just been hidden
away as a conflicting revision. But eventually she’ll need these changes merged
into Bob’s business card, otherwise they will effectively have been lost.
.sp
Any sensible business\-card application will, at minimum, have to present the
conflicting versions to Alice and allow her to create a new version
incorporating information from them all. Ideally it would merge the updates
itself.
.SS Conflict avoidance
.sp
When working on a single node, CouchDB will avoid creating conflicting revisions
by returning a \fI\%409 Conflict\fP error. This is because, when you
PUT a new version of a document, you must give the \fB_rev\fP of the previous
version. If that \fB_rev\fP has already been superseded, the update is rejected
with a \fI\%409 Conflict\fP response.
.sp
So imagine two users on the same node are fetching Bob’s business card, updating
it concurrently, and writing it back:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
USER1    \-\-\-\-\-\-\-\-\-\-\->  GET /db/bob
         <\-\-\-\-\-\-\-\-\-\-\-  {\(dq_rev\(dq:\(dq1\-aaa\(dq, ...}

USER2    \-\-\-\-\-\-\-\-\-\-\->  GET /db/bob
         <\-\-\-\-\-\-\-\-\-\-\-  {\(dq_rev\(dq:\(dq1\-aaa\(dq, ...}

USER1    \-\-\-\-\-\-\-\-\-\-\->  PUT /db/bob?rev=1\-aaa
         <\-\-\-\-\-\-\-\-\-\-\-  {\(dq_rev\(dq:\(dq2\-bbb\(dq, ...}

USER2    \-\-\-\-\-\-\-\-\-\-\->  PUT /db/bob?rev=1\-aaa
         <\-\-\-\-\-\-\-\-\-\-\-  409 Conflict  (not saved)
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
User2’s changes are rejected, so it’s up to the app to fetch /db/bob again,
and either:
.INDENT 0.0
.IP 1. 3
apply the same changes as were applied to the earlier revision, and submit
a new PUT
.IP 2. 3
redisplay the document so the user has to edit it again
.IP 3. 3
just overwrite it with the document being saved before (which is not
advisable, as user1’s changes will be silently lost)
.UNINDENT
.sp
So when working in this mode, your application still has to be able to handle
these conflicts and have a suitable retry strategy, but these conflicts never
end up inside the database itself.
.SS Revision tree
.sp
When you update a document in CouchDB, it keeps a list of the previous
revisions. In the case where conflicting updates are introduced, this history
branches into a tree, where the current conflicting revisions for this document
form the tips (leaf nodes) of this tree:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
  ,\-\-> r2a
r1 \-\-> r2b
  \(ga\-\-> r2c
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Each branch can then extend its history \- for example if you read revision r2b
and then PUT with ?rev=r2b then you will make a new revision along that
particular branch.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
  ,\-\-> r2a \-> r3a \-> r4a
r1 \-\-> r2b \-> r3b
  \(ga\-\-> r2c \-> r3c
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Here, (r4a, r3b, r3c) are the set of conflicting revisions. The way you resolve
a conflict is to delete the leaf nodes along the other branches. So when you
combine (r4a+r3b+r3c) into a single merged document, you would replace r4a and
delete r3b and r3c.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
  ,\-\-> r2a \-> r3a \-> r4a \-> r5a
r1 \-\-> r2b \-> r3b \-> (r4b deleted)
  \(ga\-\-> r2c \-> r3c \-> (r4c deleted)
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Note that r4b and r4c still exist as leaf nodes in the history tree, but as
deleted docs. You can retrieve them but they will be marked \fB\(dq_deleted\(dq:true\fP\&.
.sp
When you compact a database, the bodies of all the non\-leaf documents are
discarded. However, the list of historical _revs is retained, for the benefit of
later conflict resolution in case you meet any old replicas of the database at
some time in future. There is “revision pruning” to stop this getting
arbitrarily large.
.SS Working with conflicting documents
.sp
The basic \fI\%GET /{db}/{docid}\fP operation will not show you any
information about conflicts. You see only the deterministically\-chosen winner,
and get no indication as to whether other conflicting revisions exist or not:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq:\(dqtest\(dq,
    \(dq_rev\(dq:\(dq2\-b91bb807b4685080c6a651115ff558f5\(dq,
    \(dqhello\(dq:\(dqbar\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If you do \fBGET /db/test?conflicts=true\fP, and the document is in a conflict
state, then you will get the winner plus a _conflicts member containing an array
of the revs of the other, conflicting revision(s). You can then fetch them
individually using subsequent \fBGET /db/test?rev=xxxx\fP operations:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq:\(dqtest\(dq,
    \(dq_rev\(dq:\(dq2\-b91bb807b4685080c6a651115ff558f5\(dq,
    \(dqhello\(dq:\(dqbar\(dq,
    \(dq_conflicts\(dq:[
        \(dq2\-65db2a11b5172bf928e3bcf59f728970\(dq,
        \(dq2\-5bc3c6319edf62d4c624277fdd0ae191\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If you do \fBGET /db/test?open_revs=all\fP then you will get all the leaf nodes of
the revision tree. This will give you all the current conflicts, but will also
give you leaf nodes which have been deleted (i.e. parts of the conflict history
which have since been resolved). You can remove these by filtering out documents
with \fB\(dq_deleted\(dq:true\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    {\(dqok\(dq:{\(dq_id\(dq:\(dqtest\(dq,\(dq_rev\(dq:\(dq2\-5bc3c6319edf62d4c624277fdd0ae191\(dq,\(dqhello\(dq:\(dqfoo\(dq}},
    {\(dqok\(dq:{\(dq_id\(dq:\(dqtest\(dq,\(dq_rev\(dq:\(dq2\-65db2a11b5172bf928e3bcf59f728970\(dq,\(dqhello\(dq:\(dqbaz\(dq}},
    {\(dqok\(dq:{\(dq_id\(dq:\(dqtest\(dq,\(dq_rev\(dq:\(dq2\-b91bb807b4685080c6a651115ff558f5\(dq,\(dqhello\(dq:\(dqbar\(dq}}
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The \fB\(dqok\(dq\fP tag is an artifact of \fBopen_revs\fP, which also lets you list
explicit revisions as a JSON array, e.g. \fBopen_revs=[rev1,rev2,rev3]\fP\&. In this
form, it would be possible to request a revision which is now missing, because
the database has been compacted.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
The order of revisions returned by \fBopen_revs=all\fP is \fBNOT\fP related to
the deterministic “winning” algorithm. In the above example, the winning
revision is 2\-b91b… and happens to be returned last, but in other cases it
can be returned in a different position.
.UNINDENT
.UNINDENT
.sp
Once you have retrieved all the conflicting revisions, your application can then
choose to display them all to the user. Or it could attempt to merge them, write
back the merged version, and delete the conflicting versions \- that is, to
resolve the conflict permanently.
.sp
As described above, you need to update one revision and delete all the
conflicting revisions explicitly. This can be done using a single \fIPOST\fP to
\fB_bulk_docs\fP, setting \fB\(dq_deleted\(dq:true\fP on those revisions you wish to
delete.
.SS Multiple document API
.SS Finding conflicted documents with Mango
.sp
New in version 2.2.0.

.sp
CouchDB’s \fI\%Mango system\fP allows easy querying of
documents with conflicts, returning the full body of each document as well.
.sp
Here’s how to use it to find all conflicts in a database:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \-X POST http://127.0.0.1/dbname/_find \e
    \-d \(aq{\(dqselector\(dq: {\(dq_conflicts\(dq: { \(dq$exists\(dq: true}}, \(dqconflicts\(dq: true}\(aq \e
    \-Hcontent\-type:application/json
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqdocs\(dq: [
{\(dq_id\(dq:\(dqdoc\(dq,\(dq_rev\(dq:\(dq1\-3975759ccff3842adf690a5c10caee42\(dq,\(dqa\(dq:2,\(dq_conflicts\(dq:[\(dq1\-23202479633c2b380f79507a776743d5\(dq]}
],
\(dqbookmark\(dq: \(dqg1AAAABheJzLYWBgYMpgSmHgKy5JLCrJTq2MT8lPzkzJBYozA1kgKQ6YVA5QkBFMgKSVDHWNjI0MjEzMLc2MjZONkowtDNLMLU0NzBPNzc3MTYxTTLOysgCY2ReV\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The \fBbookmark\fP value can be used to navigate through additional pages of
results if necessary. Mango by default only returns 25 results per request.
.sp
If you expect to run this query often, be sure to create a Mango secondary
index to speed the query:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \-X POST http://127.0.0.1/dbname/_index \e
    \-d \(aq{\(dqindex\(dq:{\(dqfields\(dq: [\(dq_conflicts\(dq]}}\(aq \e
    \-Hcontent\-type:application/json
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Of course, the selector can be enhanced to filter documents on additional
keys in the document. Be sure to add those keys to your secondary index as
well, or a full database scan will be triggered.
.SS Finding conflicted documents using the \fB_all_docs\fP index
.sp
You can fetch multiple documents at once using \fBinclude_docs=true\fP on a view.
However, a \fBconflicts=true\fP request is ignored; the “doc” part of the value
never includes a \fB_conflicts\fP member. Hence you would need to do another query
to determine for each document whether it is in a conflicting state:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \(aqhttp://127.0.0.1:5984/conflict_test/_all_docs?include_docs=true&conflicts=true\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqtotal_rows\(dq:1,
    \(dqoffset\(dq:0,
    \(dqrows\(dq:[
        {
            \(dqid\(dq:\(dqtest\(dq,
            \(dqkey\(dq:\(dqtest\(dq,
            \(dqvalue\(dq:{\(dqrev\(dq:\(dq2\-b91bb807b4685080c6a651115ff558f5\(dq},
            \(dqdoc\(dq:{
                \(dq_id\(dq:\(dqtest\(dq,
                \(dq_rev\(dq:\(dq2\-b91bb807b4685080c6a651115ff558f5\(dq,
                \(dqhello\(dq:\(dqbar\(dq
            }
        }
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \(aqhttp://127.0.0.1:5984/conflict_test/test?conflicts=true\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq:\(dqtest\(dq,
    \(dq_rev\(dq:\(dq2\-b91bb807b4685080c6a651115ff558f5\(dq,
    \(dqhello\(dq:\(dqbar\(dq,
    \(dq_conflicts\(dq:[
        \(dq2\-65db2a11b5172bf928e3bcf59f728970\(dq,
        \(dq2\-5bc3c6319edf62d4c624277fdd0ae191\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS View map functions
.sp
Views only get the winning revision of a document. However they do also get a
\fB_conflicts\fP member if there are any conflicting revisions. This means you can
write a view whose job is specifically to locate documents with conflicts.
Here is a simple map function which achieves this:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    if (doc._conflicts) {
        emit(null, [doc._rev].concat(doc._conflicts));
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
which gives the following output:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqtotal_rows\(dq:1,
    \(dqoffset\(dq:0,
    \(dqrows\(dq:[
        {
            \(dqid\(dq:\(dqtest\(dq,
            \(dqkey\(dq:null,
            \(dqvalue\(dq:[
                \(dq2\-b91bb807b4685080c6a651115ff558f5\(dq,
                \(dq2\-65db2a11b5172bf928e3bcf59f728970\(dq,
                \(dq2\-5bc3c6319edf62d4c624277fdd0ae191\(dq
            ]
        }
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If you do this, you can have a separate “sweep” process which periodically scans
your database, looks for documents which have conflicts, fetches the conflicting
revisions, and resolves them.
.sp
Whilst this keeps the main application simple, the problem with this approach is
that there will be a window between a conflict being introduced and it being
resolved. From a user’s viewpoint, this may appear that the document they just
saved successfully may suddenly lose their changes, only to be resurrected some
time later. This may or may not be acceptable.
.sp
Also, it’s easy to forget to start the sweeper, or not to implement it properly,
and this will introduce odd behaviour which will be hard to track down.
.sp
CouchDB’s “winning” revision algorithm may mean that information drops out of a
view until a conflict has been resolved. Consider Bob’s business card again;
suppose Alice has a view which emits mobile numbers, so that her telephony
application can display the caller’s name based on caller ID. If there are
conflicting documents with Bob’s old and new mobile numbers, and they happen to
be resolved in favour of Bob’s old number, then the view won’t be able to
recognise his new one. In this particular case, the application might have
preferred to put information from both the conflicting documents into the view,
but this currently isn’t possible.
.sp
Suggested algorithm to fetch a document with conflict resolution:
.INDENT 0.0
.IP 1. 3
Get document via \fBGET docid?conflicts=true\fP request
.IP 2. 3
For each member in the \fB_conflicts\fP array call \fBGET docid?rev=xxx\fP\&.
If any errors occur at this stage, restart from step 1.
(There could be a race where someone else has already resolved this conflict
and deleted that rev)
.IP 3. 3
Perform application\-specific merging
.IP 4. 3
Write \fB_bulk_docs\fP with an update to the first rev and deletes of the other
revs.
.UNINDENT
.sp
This could either be done on every read (in which case you could replace all
calls to GET in your application with calls to a library which does the above),
or as part of your sweeper code.
.sp
And here is an example of this in Ruby using the low\-level \fI\%RestClient\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
require \(aqrubygems\(aq
require \(aqrest_client\(aq
require \(aqjson\(aq
DB=\(dqhttp://127.0.0.1:5984/conflict_test\(dq

# Write multiple documents
def writem(docs)
    JSON.parse(RestClient.post(\(dq#{DB}/_bulk_docs\(dq, {
        \(dqdocs\(dq => docs,
    }.to_json))
end

# Write one document, return the rev
def write1(doc, id=nil, rev=nil)
    doc[\(aq_id\(aq] = id if id
    doc[\(aq_rev\(aq] = rev if rev
    writem([doc]).first[\(aqrev\(aq]
end

# Read a document, return *all* revs
def read1(id)
    retries = 0
    loop do
        # FIXME: escape id
        res = [JSON.parse(RestClient.get(\(dq#{DB}/#{id}?conflicts=true\(dq))]
        if revs = res.first.delete(\(aq_conflicts\(aq)
            begin
                revs.each do |rev|
                    res << JSON.parse(RestClient.get(\(dq#{DB}/#{id}?rev=#{rev}\(dq))
                end
            rescue
                retries += 1
                raise if retries >= 5
                next
            end
        end
        return res
    end
end

# Create DB
RestClient.delete DB rescue nil
RestClient.put DB, {}.to_json

# Write a document
rev1 = write1({\(dqhello\(dq=>\(dqxxx\(dq},\(dqtest\(dq)
p read1(\(dqtest\(dq)

# Make three conflicting versions
write1({\(dqhello\(dq=>\(dqfoo\(dq},\(dqtest\(dq,rev1)
write1({\(dqhello\(dq=>\(dqbar\(dq},\(dqtest\(dq,rev1)
write1({\(dqhello\(dq=>\(dqbaz\(dq},\(dqtest\(dq,rev1)

res = read1(\(dqtest\(dq)
p res

# Now let\(aqs replace these three with one
res.first[\(aqhello\(aq] = \(dqfoo+bar+baz\(dq
res.each_with_index do |r,i|
    unless i == 0
        r.replace({\(aq_id\(aq=>r[\(aq_id\(aq], \(aq_rev\(aq=>r[\(aq_rev\(aq], \(aq_deleted\(aq=>true})
    end
end
writem(res)

p read1(\(dqtest\(dq)
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
An application written this way never has to deal with a \fBPUT 409\fP, and is
automatically multi\-master capable.
.sp
You can see that it’s straightforward enough when you know what you’re doing.
It’s just that CouchDB doesn’t currently provide a convenient HTTP API for
“fetch all conflicting revisions”, nor “PUT to supersede these N revisions”, so
you need to wrap these yourself. At the time of writing, there are no known
client\-side libraries which provide support for this.
.SS Merging and revision history
.sp
Actually performing the merge is an application\-specific function. It depends
on the structure of your data. Sometimes it will be easy: e.g. if a document
contains a list which is only ever appended to, then you can perform a union of
the two list versions.
.sp
Some merge strategies look at the changes made to an object, compared to its
previous version. This is how Git’s merge function works.
.sp
For example, to merge Bob’s business card versions v2a and v2b, you could look
at the differences between v1 and v2b, and then apply these changes to v2a as
well.
.sp
With CouchDB, you can sometimes get hold of old revisions of a document.
For example, if you fetch \fB/db/bob?rev=v2b&revs_info=true\fP you’ll get a list
of the previous revision ids which ended up with revision v2b. Doing the same
for v2a you can find their common ancestor revision. However if the database
has been compacted, the content of that document revision will have been lost.
\fBrevs_info\fP will still show that v1 was an ancestor, but report it as
“missing”:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
BEFORE COMPACTION           AFTER COMPACTION

     ,\-> v2a                     v2a
   v1
     \(ga\-> v2b                     v2b
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
So if you want to work with diffs, the recommended way is to store those diffs
within the new revision itself. That is: when you replace v1 with v2a, include
an extra field or attachment in v2a which says which fields were changed from
v1 to v2a. This unfortunately does mean additional book\-keeping for your
application.
.SS Comparison with other replicating data stores
.sp
The same issues arise with other replicating systems, so it can be instructive
to look at these and see how they compare with CouchDB. Please feel free to add
other examples.
.SS Unison
.sp
\fI\%Unison\fP is a bi\-directional file synchronisation tool. In this case, the
business card would be a file, say \fIbob.vcf\fP\&.
.sp
When you run unison, changes propagate both ways. If a file has changed on one
side but not the other, the new replaces the old. Unison maintains a local state
file so that it knows whether a file has changed since the last successful
replication.
.sp
In our example it has changed on both sides. Only one file called \fIbob.vcf\fP
can exist within the file system. Unison solves the problem by simply ducking
out: the user can choose to replace the remote version with the local version,
or vice versa (both of which would lose data), but the default action is to
leave both sides unchanged.
.sp
From Alice’s point of view, at least this is a simple solution. Whenever she’s
on the desktop she’ll see the version she last edited on the desktop, and
whenever she’s on the laptop she’ll see the version she last edited there.
.sp
But because no replication has actually taken place, the data is not protected.
If her laptop hard drive dies, she’ll lose all her changes made on the laptop;
ditto if her desktop hard drive dies.
.sp
It’s up to her to copy across one of the versions manually (under a different
filename), merge the two, and then finally push the merged version to the other
side.
.sp
Note also that the original file (version v1) has been lost at this point.
So it’s not going to be known from inspection alone whether v2a or v2b has the
most up\-to\-date E\-mail address for Bob, or which version has the most up\-to\-date
mobile number. Alice has to remember which one she entered last.
.SS Git
.sp
\fI\%Git\fP is a well\-known distributed source control system. Like Unison, Git deals
with files. However, Git considers the state of a whole set of files as a single
object, the “tree”. Whenever you save an update, you create a “commit” which
points to both the updated tree and the previous commit(s), which in turn point
to the previous tree(s). You therefore have a full history of all the states of
the files. This history forms a branch, and a pointer is kept to the tip of the
branch, from which you can work backwards to any previous state. The “pointer”
is an SHA1 hash of the tip commit.
.sp
If you are replicating with one or more peers, a separate branch is made for
each of those peers. For example, you might have:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
main               \-\- my local branch
remotes/foo/main   \-\- branch on peer \(aqfoo\(aq
remotes/bar/main   \-\- branch on peer \(aqbar\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
In the regular workflow, replication is a “pull”, importing changes from
a remote peer into the local repository. A “pull” does two things: first “fetch”
the state of the peer into the remote tracking branch for that peer; and then
attempt to “merge” those changes into the local branch.
.sp
Now let’s consider the business card. Alice has created a Git repo containing
\fBbob.vcf\fP, and cloned it across to the other machine. The branches look like
this, where \fBAAAAAAAA\fP is the SHA1 of the commit:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\-\-\-\-\-\-\-\-\-\- desktop \-\-\-\-\-\-\-\-\-\-           \-\-\-\-\-\-\-\-\-\- laptop \-\-\-\-\-\-\-\-\-\-
main: AAAAAAAA                        main: AAAAAAAA
remotes/laptop/main: AAAAAAAA         remotes/desktop/main: AAAAAAAA
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Now she makes a change on the desktop, and commits it into the desktop repo;
then she makes a different change on the laptop, and commits it into the laptop
repo:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\-\-\-\-\-\-\-\-\-\- desktop \-\-\-\-\-\-\-\-\-\-           \-\-\-\-\-\-\-\-\-\- laptop \-\-\-\-\-\-\-\-\-\-
main: BBBBBBBB                        main: CCCCCCCC
remotes/laptop/main: AAAAAAAA         remotes/desktop/main: AAAAAAAA
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Now on the desktop she does \fBgit pull laptop\fP\&. First, the remote objects
are copied across into the local repo and the remote tracking branch is
updated:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\-\-\-\-\-\-\-\-\-\- desktop \-\-\-\-\-\-\-\-\-\-           \-\-\-\-\-\-\-\-\-\- laptop \-\-\-\-\-\-\-\-\-\-
main: BBBBBBBB                        main: CCCCCCCC
remotes/laptop/main: CCCCCCCC         remotes/desktop/main: AAAAAAAA
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
The repo still contains AAAAAAAA because commits BBBBBBBB and CCCCCCCC
point to it.
.UNINDENT
.UNINDENT
.sp
Then Git will attempt to merge the changes in. Knowing that
the parent commit to \fBCCCCCCCC\fP is \fBAAAAAAAA\fP, it takes a diff between
\fBAAAAAAAA\fP and \fBCCCCCCCC\fP and tries to apply it to \fBBBBBBBBB\fP\&.
.sp
If this is successful, then you’ll get a new version with a merge commit:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\-\-\-\-\-\-\-\-\-\- desktop \-\-\-\-\-\-\-\-\-\-           \-\-\-\-\-\-\-\-\-\- laptop \-\-\-\-\-\-\-\-\-\-
main: DDDDDDDD                        main: CCCCCCCC
remotes/laptop/main: CCCCCCCC         remotes/desktop/main: AAAAAAAA
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Then Alice has to logon to the laptop and run \fBgit pull desktop\fP\&. A similar
process occurs. The remote tracking branch is updated:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\-\-\-\-\-\-\-\-\-\- desktop \-\-\-\-\-\-\-\-\-\-           \-\-\-\-\-\-\-\-\-\- laptop \-\-\-\-\-\-\-\-\-\-
main: DDDDDDDD                        main: CCCCCCCC
remotes/laptop/main: CCCCCCCC         remotes/desktop/main: DDDDDDDD
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Then a merge takes place. This is a special case: \fBCCCCCCCC\fP is one of the
parent commits of \fBDDDDDDDD\fP, so the laptop can \fIfast forward\fP update from
\fBCCCCCCCC\fP to \fBDDDDDDDD\fP directly without having to do any complex merging.
This leaves the final state as:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\-\-\-\-\-\-\-\-\-\- desktop \-\-\-\-\-\-\-\-\-\-           \-\-\-\-\-\-\-\-\-\- laptop \-\-\-\-\-\-\-\-\-\-
main: DDDDDDDD                        main: DDDDDDDD
remotes/laptop/main: CCCCCCCC         remotes/desktop/main: DDDDDDDD
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Now this is all and good, but you may wonder how this is relevant when thinking
about CouchDB.
.sp
First, note what happens in the case when the merge algorithm fails.
The changes are still propagated from the remote repo into the local one, and
are available in the remote tracking branch. So, unlike Unison, you know the
data is protected. It’s just that the local working copy may fail to update, or
may diverge from the remote version. It’s up to you to create and commit the
combined version yourself, but you are guaranteed to have all the history you
might need to do this.
.sp
Note that while it is possible to build new merge algorithms into Git,
the standard ones are focused on line\-based changes to source code. They don’t
work well for XML or JSON if it’s presented without any line breaks.
.sp
The other interesting consideration is multiple peers. In this case you have
multiple remote tracking branches, some of which may match your local branch,
some of which may be behind you, and some of which may be ahead of you
(i.e. contain changes that you haven’t yet merged):
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
main: AAAAAAAA
remotes/foo/main: BBBBBBBB
remotes/bar/main: CCCCCCCC
remotes/baz/main: AAAAAAAA
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Note that each peer is explicitly tracked, and therefore has to be explicitly
created. If a peer becomes stale or is no longer needed, it’s up to you to
remove it from your configuration and delete the remote tracking branch.
This is different from CouchDB, which doesn’t keep any peer state in the
database.
.sp
Another difference between CouchDB and Git is that it maintains all history
back to time
zero \- Git compaction keeps diffs between all those versions in order to reduce
size, but CouchDB discards them. If you are constantly updating a document,
the size of a Git repo would grow forever. It is possible (with some effort)
to use “history rewriting” to make Git forget commits earlier than a particular
one.
.SS What is the CouchDB replication protocol? Is it like Git?
.INDENT 0.0
.TP
.B Author
Jason Smith
.TP
.B Date
2011\-01\-29
.TP
.B Source
\fI\%StackOverflow\fP
.UNINDENT
.sp
\fBKey points\fP
.sp
\fBIf you know Git, then you know how Couch replication works.\fP Replicating is
\fIvery\fP similar to pushing or pulling with distributed source managers like Git.
.sp
\fBCouchDB replication does not have its own protocol.\fP A replicator simply
connects to two DBs as a client, then reads from one and writes to the other.
Push replication is reading the local data and updating the remote DB;
pull replication is vice versa.
.INDENT 0.0
.IP \(bu 2
\fBFun fact 1\fP: The replicator is actually an independent Erlang application,
in its own process. It connects to both couches, then reads records from one
and writes them to the other.
.IP \(bu 2
\fBFun fact 2\fP: CouchDB has no way of knowing who is a normal client and who
is a replicator (let alone whether the replication is push or pull).
It all looks like client connections. Some of them read records. Some of them
write records.
.UNINDENT
.sp
\fBEverything flows from the data model\fP
.sp
The replication algorithm is trivial, uninteresting. A trained monkey could
design it. It’s simple because the cleverness is the data model, which has these
useful characteristics:
.INDENT 0.0
.IP 1. 3
Every record in CouchDB is completely independent of all others. That sucks
if you want to do a JOIN or a transaction, but it’s awesome if you want to
write a replicator. Just figure out how to replicate one record, and then
repeat that for each record.
.IP 2. 3
Like Git, records have a linked\-list revision history. A record’s revision ID
is the checksum of its own data. Subsequent revision IDs are checksums of:
the new data, plus the revision ID of the previous.
.IP 3. 3
In addition to application data (\fB{\(dqname\(dq: \(dqJason\(dq, \(dqawesome\(dq: true}\fP),
every record stores the evolutionary time line of all previous revision IDs
leading up to itself.
.INDENT 3.0
.IP \(bu 2
Exercise: Take a moment of quiet reflection. Consider any two different
records, A and B. If A’s revision ID appears in B’s time line, then B
definitely evolved from A. Now consider Git’s fast\-forward merges.
Do you hear that? That is the sound of your mind being blown.
.UNINDENT
.IP 4. 3
Git isn’t really a linear list. It has forks, when one parent has multiple
children. CouchDB has that too.
.INDENT 3.0
.IP \(bu 2
Exercise: Compare two different records, A and B. A’s revision ID does not
appear in B’s time line; however, one revision ID, C, is in both A’s and
B’s time line. Thus A didn’t evolve from B. B didn’t evolve from A. But
rather, A and B have a common ancestor C. In Git, that is a “fork.” In
CouchDB, it’s a “conflict.”
.IP \(bu 2
In Git, if both children go on to develop their time lines independently,
that’s cool. Forks totally support that.
.IP \(bu 2
In CouchDB, if both children go on to develop their time lines
independently, that cool too. Conflicts totally support that.
.IP \(bu 2
\fBFun fact 3\fP: CouchDB “conflicts” do not correspond to Git “conflicts.”
A Couch conflict is a divergent revision history, what Git calls a “fork.”
For this reason the CouchDB community pronounces “conflict” with a silent
\fIn\fP: “co\-flicked.”
.UNINDENT
.IP 5. 3
Git also has merges, when one child has multiple parents. CouchDB \fIsort\fP of
has that too.
.INDENT 3.0
.IP \(bu 2
\fBIn the data model, there is no merge.\fP The client simply marks one
time line as deleted and continues to work with the only extant time line.
.IP \(bu 2
\fBIn the application, it feels like a merge.\fP Typically, the client merges
the \fIdata\fP from each time line in an application\-specific way.
Then it writes the new data to the time line. In Git, this is like copying
and pasting the changes from branch A into branch B, then committing to
branch B and deleting branch A. The data was merged, but there was no
\fIgit merge\fP\&.
.IP \(bu 2
These behaviors are different because, in Git, the time line itself is
important; but in CouchDB, the data is important and the time line is
incidental—it’s just there to support replication. That is one reason why
CouchDB’s built\-in revisioning is inappropriate for storing revision data
like a wiki page.
.UNINDENT
.UNINDENT
.sp
\fBFinal notes\fP
.sp
At least one sentence in this writeup (possibly this one) is complete BS.
.SS CouchDB Replication Protocol
.INDENT 0.0
.TP
.B Version
3
.UNINDENT
.sp
The \fICouchDB Replication Protocol\fP is a protocol for synchronising JSON
documents between 2 peers over HTTP/1.1 by using the public \fI\%CouchDB REST
API\fP and is based on the Apache CouchDB \fI\%MVCC\fP Data model.
.SS Preface
.SS Language
.sp
The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”,
“SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL” in this
document are to be interpreted as described in \fI\%RFC 2119\fP\&.
.SS Goals
.sp
The primary goal of this specification is to describe the \fICouchDB Replication
Protocol\fP under the hood.
.sp
The secondary goal is to provide enough detailed information about the protocol
to make it easy to build tools on any language and platform that can synchronize
data with CouchDB.
.SS Definitions
.INDENT 0.0
.TP
.B JSON:
JSON is a text format for the
serialization of structured data. It is described in \fI\%ECMA\-262\fP and
\fI\%RFC 4627\fP\&.
.TP
.B URI:
A URI is defined by \fI\%RFC 3986\fP\&. It can be a URL as defined
in \fI\%RFC 1738\fP\&.
.TP
.B ID:
An identifier (could be a UUID) as described in \fI\%RFC 4122\fP\&.
.TP
.B Revision:
A \fI\%MVCC\fP token value of following pattern: \fBN\-sig\fP where \fBN\fP is ALWAYS
a positive integer and \fBsig\fP is the Document signature (custom).
Don’t mix it up with the revision in version control systems!
.TP
.B Leaf Revision:
The last Document Revision in a series of changes. Documents may have
multiple Leaf Revisions (aka Conflict Revisions) due to concurrent updates.
.TP
.B Document:
A document is a JSON object with an ID and Revision defined in \fB_id\fP and
\fB_rev\fP fields respectively. A Document’s ID MUST be unique within
the Database where it is stored.
.TP
.B Database:
A collection of Documents with a unique URI.
.TP
.B Changes Feed:
A stream of Document\-changing events (create, update, delete) for
the specified Database.
.TP
.B Sequence ID:
An ID provided by the Changes Feed. It MUST be incremental,
but MAY NOT always be an integer.
.TP
.B Source:
Database from where the Documents are replicated.
.TP
.B Target:
Database where the Documents are replicated to.
.TP
.B Replication:
The one\-way directed synchronization process of Source and Target endpoints.
.TP
.B Checkpoint:
Intermediate Recorded Sequence ID used for Replication recovery.
.TP
.B Replicator:
A service or an application which initiates and runs Replication.
.TP
.B Filter Function:
A special function of any programming language that is used to filter
Documents during Replication (see \fI\%Filter Functions\fP)
.TP
.B Filter Function Name:
An ID of a Filter Function that may be used as a symbolic reference (aka
callback function) to apply the related Filter Function to Replication.
.TP
.B Filtered Replication:
Replication of Documents from Source to Target using a Filter Function.
.TP
.B Full Replication:
Replication of all Documents from Source to Target.
.TP
.B Push Replication:
Replication process where Source is a local endpoint and Target is remote.
.TP
.B Pull Replication:
Replication process where Source is a remote endpoint and Target is local.
.TP
.B Continuous Replication:
Replication that “never stops”: after processing all events from the
Changes Feed, the Replicator doesn’t close the connection, but awaits new
change events from the Source. The connection is kept alive by periodic
heartbeats.
.TP
.B Replication Log:
A special Document that holds Replication history (recorded Checkpoints
and a few more statistics) between Source and Target.
.TP
.B Replication ID:
A unique value that unambiguously identifies the Replication Log.
.UNINDENT
.SS Replication Protocol Algorithm
.sp
The \fICouchDB Replication Protocol\fP is not \fImagical\fP, but
an agreement on usage of the public \fI\%CouchDB HTTP REST API\fP to
enable Documents to be replicated from Source to Target.
.sp
The reference implementation, written in \fI\%Erlang\fP, is provided by the
\fI\%couch_replicator\fP module in Apache CouchDB.
.sp
It is RECOMMENDED that one follow this algorithm specification, use the same
HTTP endpoints, and run requests with the same parameters to provide a
completely compatible implementation. Custom Replicator implementations MAY use
different HTTP API endpoints and request parameters depending on their local
specifics and they MAY implement only part of the Replication Protocol to run
only Push or Pull Replication. However, while such solutions could also run the
Replication process, they loose compatibility with the CouchDB Replicator.
.SS Verify Peers
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- +
\(aq Verify Peers:                                                             \(aq
\(aq                                                                           \(aq
\(aq                404 Not Found   +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+         \(aq
\(aq       +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\- |     Check Source Existence     |         \(aq
\(aq       |                        +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+         \(aq
\(aq       |                        |          HEAD /source          |         \(aq
\(aq       |                        +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+         \(aq
\(aq       |                          |                                        \(aq
\(aq       |                          | 200 OK                                 \(aq
\(aq       |                          v                                        \(aq
\(aq       |                        +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+         \(aq
\(aq       |                        |     Check Target Existence     | \-\-\-\-+   \(aq
\(aq       |                        +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+     |   \(aq
\(aq       |                        |         HEAD /target           |     |   \(aq
\(aq       |                        +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+     |   \(aq
\(aq       |                          |                                    |   \(aq
\(aq       |                          | 404 Not Found                      |   \(aq
\(aq       v                          v                                    |   \(aq
\(aq   +\-\-\-\-\-\-\-+    No              +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+     |   \(aq
\(aq   | Abort | <\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\- |         Create Target?         |     |   \(aq
\(aq   +\-\-\-\-\-\-\-+                    +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+     |   \(aq
\(aq       ^                          |                                    |   \(aq
\(aq       |                          | Yes                                |   \(aq
\(aq       |                          v                                    |   \(aq
\(aq       |        Failure         +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+     |   \(aq
\(aq       +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\- |          Create Target         |     |   \(aq
\(aq                                +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+     |   \(aq
\(aq                                |           PUT /target          |     |   \(aq
\(aq                                +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+     |   \(aq
\(aq                                  |                                    |   \(aq
\(aq                                  | 201 Created                 200 OK |   \(aq
\(aq                                  |                                    |   \(aq
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \-  | \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \-  | \- +
                                   |                                    |
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \-  | \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \-  | \- +
\(aq Get Peers Information:           |                                    |   \(aq
\(aq                                  +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+   \(aq
\(aq                                  |                                        \(aq
\(aq                                  v                                        \(aq
\(aq                                +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+         \(aq
\(aq                                |     Get Source Information     |         \(aq
\(aq                                +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+         \(aq
\(aq                                                                           \(aq
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- +
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The Replicator MUST ensure that both Source and Target exist
by using \fI\%HEAD /{db}\fP requests.
.SS Check Source Existence
.INDENT 0.0
.INDENT 3.5
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HEAD /source HTTP/1.1
Host: localhost:5984
User\-Agent: CouchDB
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Sat, 05 Oct 2013 08:50:39 GMT
Server: CouchDB (Erlang/OTP)
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Check Target Existence
.INDENT 0.0
.INDENT 3.5
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HEAD /target HTTP/1.1
Host: localhost:5984
User\-Agent: CouchDB
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Sat, 05 Oct 2013 08:51:11 GMT
Server: CouchDB (Erlang/OTP)
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Create Target?
.sp
In case of a non\-existent Target, the Replicator MAY make a \fI\%PUT /{db}\fP
request to create the Target:
.INDENT 0.0
.INDENT 3.5
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
PUT /target HTTP/1.1
Accept: application/json
Host: localhost:5984
User\-Agent: CouchDB
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Content\-Length: 12
Content\-Type: application/json
Date: Sat, 05 Oct 2013 08:58:41 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqok\(dq: true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
However, the Replicator’s PUT request MAY NOT succeeded due to insufficient
privileges (which are granted by the provided credential) and so receive a
\fI\%401 Unauthorized\fP or a \fI\%403 Forbidden\fP error. Such errors SHOULD be expected
and well handled:
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 500 Internal Server Error
Cache\-Control: must\-revalidate
Content\-Length: 108
Content\-Type: application/json
Date: Fri, 09 May 2014 13:50:32 GMT
Server: CouchDB (Erlang OTP)

{
    \(dqerror\(dq: \(dqunauthorized\(dq,
    \(dqreason\(dq: \(dqunauthorized to access or create database http://localhost:5984/target\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Abort
.sp
In case of a non\-existent Source or Target, Replication SHOULD be aborted with
an HTTP error response:
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 500 Internal Server Error
Cache\-Control: must\-revalidate
Content\-Length: 56
Content\-Type: application/json
Date: Sat, 05 Oct 2013 08:55:29 GMT
Server: CouchDB (Erlang OTP)

{
    \(dqerror\(dq: \(dqdb_not_found\(dq,
    \(dqreason\(dq: \(dqcould not open source\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Get Peers Information
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \-+
\(aq Verify Peers:                                                    \(aq
\(aq                         +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+               \(aq
\(aq                         | Check Target Existence |               \(aq
\(aq                         +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+               \(aq
\(aq                                     |                            \(aq
\(aq                                     | 200 OK                     \(aq
\(aq                                     |                            \(aq
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- | \- \- \- \- \- \- \- \- \- \- \- \- \- \-+
                                      |
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- | \- \- \- \- \- \- \- \- \- \- \- \- \- \-+
\(aq Get Peers Information:              |                            \(aq
\(aq                                     v                            \(aq
\(aq                         +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+               \(aq
\(aq                         | Get Source Information |               \(aq
\(aq                         +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+               \(aq
\(aq                         |      GET /source       |               \(aq
\(aq                         +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+               \(aq
\(aq                                     |                            \(aq
\(aq                                     | 200 OK                     \(aq
\(aq                                     v                            \(aq
\(aq                         +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+               \(aq
\(aq                         | Get Target Information |               \(aq
\(aq                         +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+               \(aq
\(aq                         |      GET /target       |               \(aq
\(aq                         +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+               \(aq
\(aq                                     |                            \(aq
\(aq                                     | 200 OK                     \(aq
\(aq                                     |                            \(aq
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- | \- \- \- \- \- \- \- \- \- \- \- \- \- \-+
                                      |
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- | \- \- \- \- \- \- \- \- \- \- \- \- \- \-+
\(aq Find Common Ancestry:               |                            \(aq
\(aq                                     |                            \(aq
\(aq                                     v                            \(aq
\(aq                         +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+              \(aq
\(aq                         | Generate Replication ID |              \(aq
\(aq                         +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+              \(aq
\(aq                                                                  \(aq
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \-+
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The Replicator retrieves basic information both from Source and Target using
\fI\%GET /{db}\fP requests. The GET response MUST contain JSON objects with
the following mandatory fields:
.INDENT 0.0
.IP \(bu 2
\fBinstance_start_time\fP (\fIstring\fP): Always \fB\(dq0\(dq\fP\&. (Returned for legacy
reasons.)
.IP \(bu 2
\fBupdate_seq\fP (\fInumber\fP / \fIstring\fP): The current database Sequence ID.
.UNINDENT
.sp
Any other fields are optional. The information that the Replicator needs
is the \fBupdate_seq\fP field: this value will be used to define a \fItemporary\fP
(because Database data is subject to change) upper bound for changes feed
listening and statistic calculating to show proper Replication progress.
.SS Get Source Information
.INDENT 0.0
.INDENT 3.5
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /source HTTP/1.1
Accept: application/json
Host: localhost:5984
User\-Agent: CouchDB
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 256
Content\-Type: application/json
Date: Tue, 08 Oct 2013 07:53:08 GMT
Server: CouchDB (Erlang OTP)

{
    \(dqcommitted_update_seq\(dq: 61772,
    \(dqcompact_running\(dq: false,
    \(dqdb_name\(dq: \(dqsource\(dq,
    \(dqdisk_format_version\(dq: 6,
    \(dqdoc_count\(dq: 41961,
    \(dqdoc_del_count\(dq: 3807,
    \(dqinstance_start_time\(dq: \(dq0\(dq,
    \(dqpurge_seq\(dq: 0,
    \(dqsizes\(dq: {
      \(dqactive\(dq: 70781613961,
      \(dqdisk\(dq: 79132913799,
      \(dqexternal\(dq: 72345632950
    },
    \(dqupdate_seq\(dq: 61772
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Get Target Information
.INDENT 0.0
.INDENT 3.5
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /target/ HTTP/1.1
Accept: application/json
Host: localhost:5984
User\-Agent: CouchDB
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Content\-Length: 363
Content\-Type: application/json
Date: Tue, 08 Oct 2013 12:37:01 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqcompact_running\(dq: false,
    \(dqdb_name\(dq: \(dqtarget\(dq,
    \(dqdisk_format_version\(dq: 5,
    \(dqdoc_count\(dq: 1832,
    \(dqdoc_del_count\(dq: 1,
    \(dqinstance_start_time\(dq: \(dq0\(dq,
    \(dqpurge_seq\(dq: 0,
    \(dqsizes\(dq: {
      \(dqactive\(dq: 50829452,
      \(dqdisk\(dq: 77001455,
      \(dqexternal\(dq: 60326450
    },
    \(dqupdate_seq\(dq: \(dq1841\-g1AAAADveJzLYWBgYMlgTmGQT0lKzi9KdUhJMtbLSs1LLUst0k\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Find Common Ancestry
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- +
\(aq Get Peers Information:                                                    \(aq
\(aq                                                                           \(aq
\(aq                             +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+ \(aq
\(aq                             |           Get Target Information          | \(aq
\(aq                             +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+ \(aq
\(aq                               |                                           \(aq
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- | \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- +
                                |
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- | \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- +
\(aq Find Common Ancestry:         v                                           \(aq
\(aq                             +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+ \(aq
\(aq                             |          Generate Replication ID          | \(aq
\(aq                             +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+ \(aq
\(aq                               |                                           \(aq
\(aq                               |                                           \(aq
\(aq                               v                                           \(aq
\(aq                             +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+ \(aq
\(aq                             |      Get Replication Log from Source      | \(aq
\(aq                             +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+ \(aq
\(aq                             |     GET /source/_local/replication\-id     | \(aq
\(aq                             +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+ \(aq
\(aq                               |                                           \(aq
\(aq                               | 200 OK                                    \(aq
\(aq                               | 404 Not Found                             \(aq
\(aq                               v                                           \(aq
\(aq                             +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+ \(aq
\(aq                             |      Get Replication Log from Target      | \(aq
\(aq                             +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+ \(aq
\(aq                             |     GET /target/_local/replication\-id     | \(aq
\(aq                             +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+ \(aq
\(aq                               |                                           \(aq
\(aq                               | 200 OK                                    \(aq
\(aq                               | 404 Not Found                             \(aq
\(aq                               v                                           \(aq
\(aq                             +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+ \(aq
\(aq                             |          Compare Replication Logs         | \(aq
\(aq                             +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+ \(aq
\(aq                               |                                           \(aq
\(aq                               | Use latest common sequence as start point \(aq
\(aq                               |                                           \(aq
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- | \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- +
                                |
                                |
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- | \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- +
\(aq Locate Changed Documents:     |                                           \(aq
\(aq                               |                                           \(aq
\(aq                               v                                           \(aq
\(aq                             +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+ \(aq
\(aq                             |        Listen Source Changes Feed         | \(aq
\(aq                             +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+ \(aq
\(aq                                                                           \(aq
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- +
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Generate Replication ID
.sp
Before Replication is started, the Replicator MUST generate a Replication ID.
This value is used to track Replication History, resume and continue previously
interrupted Replication process.
.sp
The Replication ID generation algorithm is implementation specific. Whatever
algorithm is used it MUST uniquely identify the Replication process. CouchDB’s
Replicator, for example, uses the following factors in generating a Replication
ID:
.INDENT 0.0
.IP \(bu 2
Persistent Peer UUID value. For CouchDB, the local
\fI\%Server UUID\fP is used
.IP \(bu 2
Source and Target URI and if Source or Target are local or remote Databases
.IP \(bu 2
If Target needed to be created
.IP \(bu 2
If Replication is Continuous
.IP \(bu 2
Any custom headers
.IP \(bu 2
\fI\%Filter function\fP code if used
.IP \(bu 2
Changes Feed query parameters, if any
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
See \fI\%couch_replicator_ids.erl\fP for an example of a Replication ID generation
implementation.
.UNINDENT
.UNINDENT
.SS Retrieve Replication Logs from Source and Target
.sp
Once the Replication ID has been generated, the Replicator SHOULD retrieve
the Replication Log from both Source and Target using
\fI\%GET /{db}/_local/{docid}\fP:
.INDENT 0.0
.INDENT 3.5
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /source/_local/b3e44b920ee2951cb2e123b63044427a HTTP/1.1
Accept: application/json
Host: localhost:5984
User\-Agent: CouchDB
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 1019
Content\-Type: application/json
Date: Thu, 10 Oct 2013 06:18:56 GMT
ETag: \(dq0\-8\(dq
Server: CouchDB (Erlang OTP)

{
    \(dq_id\(dq: \(dq_local/b3e44b920ee2951cb2e123b63044427a\(dq,
    \(dq_rev\(dq: \(dq0\-8\(dq,
    \(dqhistory\(dq: [
        {
            \(dqdoc_write_failures\(dq: 0,
            \(dqdocs_read\(dq: 2,
            \(dqdocs_written\(dq: 2,
            \(dqend_last_seq\(dq: 5,
            \(dqend_time\(dq: \(dqThu, 10 Oct 2013 05:56:38 GMT\(dq,
            \(dqmissing_checked\(dq: 2,
            \(dqmissing_found\(dq: 2,
            \(dqrecorded_seq\(dq: 5,
            \(dqsession_id\(dq: \(dqd5a34cbbdafa70e0db5cb57d02a6b955\(dq,
            \(dqstart_last_seq\(dq: 3,
            \(dqstart_time\(dq: \(dqThu, 10 Oct 2013 05:56:38 GMT\(dq
        },
        {
            \(dqdoc_write_failures\(dq: 0,
            \(dqdocs_read\(dq: 1,
            \(dqdocs_written\(dq: 1,
            \(dqend_last_seq\(dq: 3,
            \(dqend_time\(dq: \(dqThu, 10 Oct 2013 05:56:12 GMT\(dq,
            \(dqmissing_checked\(dq: 1,
            \(dqmissing_found\(dq: 1,
            \(dqrecorded_seq\(dq: 3,
            \(dqsession_id\(dq: \(dq11a79cdae1719c362e9857cd1ddff09d\(dq,
            \(dqstart_last_seq\(dq: 2,
            \(dqstart_time\(dq: \(dqThu, 10 Oct 2013 05:56:12 GMT\(dq
        },
        {
            \(dqdoc_write_failures\(dq: 0,
            \(dqdocs_read\(dq: 2,
            \(dqdocs_written\(dq: 2,
            \(dqend_last_seq\(dq: 2,
            \(dqend_time\(dq: \(dqThu, 10 Oct 2013 05:56:04 GMT\(dq,
            \(dqmissing_checked\(dq: 2,
            \(dqmissing_found\(dq: 2,
            \(dqrecorded_seq\(dq: 2,
            \(dqsession_id\(dq: \(dq77cdf93cde05f15fcb710f320c37c155\(dq,
            \(dqstart_last_seq\(dq: 0,
            \(dqstart_time\(dq: \(dqThu, 10 Oct 2013 05:56:04 GMT\(dq
        }
    ],
    \(dqreplication_id_version\(dq: 3,
    \(dqsession_id\(dq: \(dqd5a34cbbdafa70e0db5cb57d02a6b955\(dq,
    \(dqsource_last_seq\(dq: 5
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
The Replication Log SHOULD contain the following fields:
.INDENT 0.0
.IP \(bu 2
\fBhistory\fP (\fIarray\fP of \fIobject\fP): Replication history. \fBRequired\fP
.INDENT 2.0
.IP \(bu 2
\fBdoc_write_failures\fP (\fInumber\fP): Number of failed writes
.IP \(bu 2
\fBdocs_read\fP (\fInumber\fP): Number of read documents
.IP \(bu 2
\fBdocs_written\fP (\fInumber\fP): Number of written documents
.IP \(bu 2
\fBend_last_seq\fP (\fInumber\fP): Last processed Update Sequence ID
.IP \(bu 2
\fBend_time\fP (\fIstring\fP): Replication completion timestamp in \fI\%RFC 5322\fP
format
.IP \(bu 2
\fBmissing_checked\fP (\fInumber\fP): Number of checked revisions on Source
.IP \(bu 2
\fBmissing_found\fP (\fInumber\fP): Number of missing revisions found on Target
.IP \(bu 2
\fBrecorded_seq\fP (\fInumber\fP): Recorded intermediate Checkpoint. \fBRequired\fP
.IP \(bu 2
\fBsession_id\fP (\fIstring\fP): Unique session ID. Commonly, a random UUID value
is used. \fBRequired\fP
.IP \(bu 2
\fBstart_last_seq\fP (\fInumber\fP): Start update Sequence ID
.IP \(bu 2
\fBstart_time\fP (\fIstring\fP): Replication start timestamp in \fI\%RFC 5322\fP format
.UNINDENT
.IP \(bu 2
\fBreplication_id_version\fP (\fInumber\fP): Replication protocol version. Defines
Replication ID calculation algorithm, HTTP API calls and the others
routines. \fBRequired\fP
.IP \(bu 2
\fBsession_id\fP (\fIstring\fP): Unique ID of the last session. Shortcut to
the \fBsession_id\fP field of the latest \fBhistory\fP object. \fBRequired\fP
.IP \(bu 2
\fBsource_last_seq\fP (\fInumber\fP): Last processed Checkpoint. Shortcut to
the \fBrecorded_seq\fP field of the latest \fBhistory\fP object. \fBRequired\fP
.UNINDENT
.sp
This request MAY fall with a \fI\%404 Not Found\fP response:
.INDENT 0.0
.INDENT 3.5
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /source/_local/b6cef528f67aa1a8a014dd1144b10e09 HTTP/1.1
Accept: application/json
Host: localhost:5984
User\-Agent: CouchDB
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 404 Object Not Found
Cache\-Control: must\-revalidate
Content\-Length: 41
Content\-Type: application/json
Date: Tue, 08 Oct 2013 13:31:10 GMT
Server: CouchDB (Erlang OTP)

{
    \(dqerror\(dq: \(dqnot_found\(dq,
    \(dqreason\(dq: \(dqmissing\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
That’s OK. This means that there is no information about the current Replication
so it must not have been run previously and as such the Replicator MUST run
a Full Replication.
.SS Compare Replication Logs
.sp
If the Replication Logs are successfully retrieved from both Source and Target
then the Replicator MUST determine their common ancestry by following the next
algorithm:
.INDENT 0.0
.IP \(bu 2
Compare \fBsession_id\fP values for the chronological last session \- if they
match both Source and Target have a common Replication history and it seems
to be valid. Use \fBsource_last_seq\fP value for the startup Checkpoint
.IP \(bu 2
In case of mismatch, iterate over the \fBhistory\fP collection to search for
the latest (chronologically) common \fBsession_id\fP for Source and Target.
Use value of \fBrecorded_seq\fP field as startup Checkpoint
.UNINDENT
.sp
If Source and Target has no common ancestry, the Replicator MUST run
Full Replication.
.SS Locate Changed Documents
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- +
\(aq Find Common Ancestry:                                                     \(aq
\(aq                                                                           \(aq
\(aq             +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                              \(aq
\(aq             |   Compare Replication Logs   |                              \(aq
\(aq             +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                              \(aq
\(aq                                          |                                \(aq
\(aq                                          |                                \(aq
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \-  |  \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- +
                                           |
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \-  |  \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- +
\(aq Locate Changed Documents:                |                                \(aq
\(aq                                          |                                \(aq
\(aq                                          |                                \(aq
\(aq                                          v                                \(aq
\(aq            +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                              \(aq
\(aq   +\-\-\-\-\-\-> |     Listen to Changes Feed    | \-\-\-\-\-+                       \(aq
\(aq   |        +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+      |                       \(aq
\(aq   |        |     GET  /source/_changes     |      |                       \(aq
\(aq   |        |     POST /source/_changes     |      |                       \(aq
\(aq   |        +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+      |                       \(aq
\(aq   |                                      |        |                       \(aq
\(aq   |                                      |        |                       \(aq
\(aq   |                There are new changes |        | No more changes       \(aq
\(aq   |                                      |        |                       \(aq
\(aq   |                                      v        v                       \(aq
\(aq   |        +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+    +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+ \(aq
\(aq   |        |     Read Batch of Changes     |    | Replication Completed | \(aq
\(aq   |        +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+    +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+ \(aq
\(aq   |                                      |                                \(aq
\(aq   | No                                   |                                \(aq
\(aq   |                                      v                                \(aq
\(aq   |        +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                              \(aq
\(aq   |        |  Compare Documents Revisions  |                              \(aq
\(aq   |        +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                              \(aq
\(aq   |        |    POST /target/_revs_diff    |                              \(aq
\(aq   |        +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                              \(aq
\(aq   |                                      |                                \(aq
\(aq   |                               200 OK |                                \(aq
\(aq   |                                      v                                \(aq
\(aq   |        +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                              \(aq
\(aq   +\-\-\-\-\-\-\- |     Any Differences Found?    |                              \(aq
\(aq            +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                              \(aq
\(aq                                          |                                \(aq
\(aq                                      Yes |                                \(aq
\(aq                                          |                                \(aq
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \-  |  \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- +
                                           |
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \-  |  \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- +
\(aq Replicate Changes:                       |                                \(aq
\(aq                                          v                                \(aq
\(aq            +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                              \(aq
\(aq            |  Fetch Next Changed Document  |                              \(aq
\(aq            +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                              \(aq
\(aq                                                                           \(aq
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- +
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Listen to Changes Feed
.sp
When the start up Checkpoint has been defined, the Replicator SHOULD read
the Source’s \fI\%Changes Feed\fP by using a \fI\%GET /{db}/_changes\fP
request. This request MUST be made with the following query parameters:
.INDENT 0.0
.IP \(bu 2
\fBfeed\fP parameter defines the Changes Feed response style: for Continuous
Replication the \fBcontinuous\fP value SHOULD be used, otherwise \- \fBnormal\fP\&.
.IP \(bu 2
\fBstyle=all_docs\fP query parameter tells the Source that it MUST include
all Revision leaves for each document’s event in output.
.IP \(bu 2
For Continuous Replication the \fBheartbeat\fP parameter defines the heartbeat
period in \fImilliseconds\fP\&. The RECOMMENDED value by default is \fB10000\fP
(10 seconds).
.IP \(bu 2
If a startup Checkpoint was found during the Replication Logs comparison,
the \fBsince\fP query parameter MUST be passed with this value.
In case of Full Replication it MAY be \fB0\fP (number zero) or
be omitted.
.UNINDENT
.sp
Additionally, the \fBfilter\fP query parameter MAY be specified to enable a
\fI\%filter function\fP on Source side. Other
custom parameters MAY also be provided.
.SS Read Batch of Changes
.sp
Reading the whole feed in a single shot may not be an optimal use of resources.
It is RECOMMENDED to process the feed in small chunks. However, there is
no specific recommendation on chunk size since it is heavily dependent on
available resources: large chunks requires more memory while they reduce
I/O operations and vice versa.
.sp
Note, that Changes Feed output format is different for a request with
\fI\%feed=normal\fP and with
\fI\%feed=continuous\fP query parameter.
.sp
Normal Feed:
.INDENT 0.0
.INDENT 3.5
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /source/_changes?feed=normal&style=all_docs&heartbeat=10000 HTTP/1.1
Accept: application/json
Host: localhost:5984
User\-Agent: CouchDB
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Fri, 09 May 2014 16:20:41 GMT
Server: CouchDB (Erlang OTP)
Transfer\-Encoding: chunked

{\(dqresults\(dq:[
{\(dqseq\(dq:14,\(dqid\(dq:\(dqf957f41e\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq3\-46a3\(dq}],\(dqdeleted\(dq:true}
{\(dqseq\(dq:29,\(dqid\(dq:\(dqddf339dd\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq10\-304b\(dq}]}
{\(dqseq\(dq:37,\(dqid\(dq:\(dqd3cc62f5\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq2\-eec2\(dq}],\(dqdeleted\(dq:true}
{\(dqseq\(dq:39,\(dqid\(dq:\(dqf13bd08b\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-b35d\(dq}]}
{\(dqseq\(dq:41,\(dqid\(dq:\(dqe0a99867\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq2\-c1c6\(dq}]}
{\(dqseq\(dq:42,\(dqid\(dq:\(dqa75bdfc5\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-967a\(dq}]}
{\(dqseq\(dq:43,\(dqid\(dq:\(dqa5f467a0\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-5575\(dq}]}
{\(dqseq\(dq:45,\(dqid\(dq:\(dq470c3004\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq11\-c292\(dq}]}
{\(dqseq\(dq:46,\(dqid\(dq:\(dqb1cb8508\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq10\-ABC\(dq}]}
{\(dqseq\(dq:47,\(dqid\(dq:\(dq49ec0489\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq157\-b01f\(dq},{\(dqrev\(dq:\(dq123\-6f7c\(dq}]}
{\(dqseq\(dq:49,\(dqid\(dq:\(dqdad10379\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-9346\(dq},{\(dqrev\(dq:\(dq6\-5b8a\(dq}]}
{\(dqseq\(dq:50,\(dqid\(dq:\(dq73464877\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-9f08\(dq}]}
{\(dqseq\(dq:51,\(dqid\(dq:\(dq7ae19302\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-57bf\(dq}]}
{\(dqseq\(dq:63,\(dqid\(dq:\(dq6a7a6c86\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq5\-acf6\(dq}],\(dqdeleted\(dq:true}
{\(dqseq\(dq:64,\(dqid\(dq:\(dqdfb9850a\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-102f\(dq}]}
{\(dqseq\(dq:65,\(dqid\(dq:\(dqc532afa7\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-6491\(dq}]}
{\(dqseq\(dq:66,\(dqid\(dq:\(dqaf8a9508\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-3db2\(dq}]}
{\(dqseq\(dq:67,\(dqid\(dq:\(dqcaa3dded\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-6491\(dq}]}
{\(dqseq\(dq:68,\(dqid\(dq:\(dq79f3b4e9\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-102f\(dq}]}
{\(dqseq\(dq:69,\(dqid\(dq:\(dq1d89d16f\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-3db2\(dq}]}
{\(dqseq\(dq:71,\(dqid\(dq:\(dqabae7348\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq2\-7051\(dq}]}
{\(dqseq\(dq:77,\(dqid\(dq:\(dq6c25534f\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq9\-CDE\(dq},{\(dqrev\(dq:\(dq3\-00e7\(dq},{\(dqrev\(dq:\(dq1\-ABC\(dq}]}
{\(dqseq\(dq:78,\(dqid\(dq:\(dqSpaghettiWithMeatballs\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq22\-5f95\(dq}]}
],
\(dqlast_seq\(dq:78}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
Continuous Feed:
.INDENT 0.0
.INDENT 3.5
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /source/_changes?feed=continuous&style=all_docs&heartbeat=10000 HTTP/1.1
Accept: application/json
Host: localhost:5984
User\-Agent: CouchDB
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Fri, 09 May 2014 16:22:22 GMT
Server: CouchDB (Erlang OTP)
Transfer\-Encoding: chunked

{\(dqseq\(dq:14,\(dqid\(dq:\(dqf957f41e\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq3\-46a3\(dq}],\(dqdeleted\(dq:true}
{\(dqseq\(dq:29,\(dqid\(dq:\(dqddf339dd\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq10\-304b\(dq}]}
{\(dqseq\(dq:37,\(dqid\(dq:\(dqd3cc62f5\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq2\-eec2\(dq}],\(dqdeleted\(dq:true}
{\(dqseq\(dq:39,\(dqid\(dq:\(dqf13bd08b\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-b35d\(dq}]}
{\(dqseq\(dq:41,\(dqid\(dq:\(dqe0a99867\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq2\-c1c6\(dq}]}
{\(dqseq\(dq:42,\(dqid\(dq:\(dqa75bdfc5\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-967a\(dq}]}
{\(dqseq\(dq:43,\(dqid\(dq:\(dqa5f467a0\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-5575\(dq}]}
{\(dqseq\(dq:45,\(dqid\(dq:\(dq470c3004\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq11\-c292\(dq}]}
{\(dqseq\(dq:46,\(dqid\(dq:\(dqb1cb8508\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq10\-ABC\(dq}]}
{\(dqseq\(dq:47,\(dqid\(dq:\(dq49ec0489\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq157\-b01f\(dq},{\(dqrev\(dq:\(dq123\-6f7c\(dq}]}
{\(dqseq\(dq:49,\(dqid\(dq:\(dqdad10379\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-9346\(dq},{\(dqrev\(dq:\(dq6\-5b8a\(dq}]}
{\(dqseq\(dq:50,\(dqid\(dq:\(dq73464877\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-9f08\(dq}]}
{\(dqseq\(dq:51,\(dqid\(dq:\(dq7ae19302\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-57bf\(dq}]}
{\(dqseq\(dq:63,\(dqid\(dq:\(dq6a7a6c86\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq5\-acf6\(dq}],\(dqdeleted\(dq:true}
{\(dqseq\(dq:64,\(dqid\(dq:\(dqdfb9850a\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-102f\(dq}]}
{\(dqseq\(dq:65,\(dqid\(dq:\(dqc532afa7\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-6491\(dq}]}
{\(dqseq\(dq:66,\(dqid\(dq:\(dqaf8a9508\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-3db2\(dq}]}
{\(dqseq\(dq:67,\(dqid\(dq:\(dqcaa3dded\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-6491\(dq}]}
{\(dqseq\(dq:68,\(dqid\(dq:\(dq79f3b4e9\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-102f\(dq}]}
{\(dqseq\(dq:69,\(dqid\(dq:\(dq1d89d16f\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-3db2\(dq}]}
{\(dqseq\(dq:71,\(dqid\(dq:\(dqabae7348\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq2\-7051\(dq}]}
{\(dqseq\(dq:75,\(dqid\(dq:\(dqSpaghettiWithMeatballs\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq21\-5949\(dq}]}
{\(dqseq\(dq:77,\(dqid\(dq:\(dq6c255\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq9\-CDE\(dq},{\(dqrev\(dq:\(dq3\-00e7\(dq},{\(dqrev\(dq:\(dq1\-ABC\(dq}]}
{\(dqseq\(dq:78,\(dqid\(dq:\(dqSpaghettiWithMeatballs\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq22\-5f95\(dq}]}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
For both Changes Feed formats record\-per\-line style is preserved to simplify
iterative fetching and decoding JSON objects with less memory footprint.
.SS Calculate Revision Difference
.sp
After reading the batch of changes from the Changes Feed, the Replicator forms a
JSON mapping object for Document ID and related leaf Revisions and sends
the result to Target via a \fI\%POST /{db}/_revs_diff\fP request:
.INDENT 0.0
.INDENT 3.5
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST /target/_revs_diff HTTP/1.1
Accept: application/json
Content\-Length: 287
Content\-Type: application/json
Host: localhost:5984
User\-Agent: CouchDB

{
    \(dqbaz\(dq: [
        \(dq2\-7051cbe5c8faecd085a3fa619e6e6337\(dq
    ],
    \(dqfoo\(dq: [
        \(dq3\-6a540f3d701ac518d3b9733d673c5484\(dq
    ],
    \(dqbar\(dq: [
        \(dq1\-d4e501ab47de6b2000fc8a02f84a0c77\(dq,
        \(dq1\-967a00dff5e02add41819138abb3284d\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 88
Content\-Type: application/json
Date: Fri, 25 Oct 2013 14:44:41 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqbaz\(dq: {
        \(dqmissing\(dq: [
            \(dq2\-7051cbe5c8faecd085a3fa619e6e6337\(dq
        ]
    },
    \(dqbar\(dq: {
        \(dqmissing\(dq: [
            \(dq1\-d4e501ab47de6b2000fc8a02f84a0c77\(dq
        ]
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
In the response the Replicator receives a Document ID – Revisions mapping,
but only for Revisions that do not exist in Target and are REQUIRED to be
transferred from Source.
.sp
If all Revisions in the request match the current state of the Documents then
the response will contain an empty JSON object:
.INDENT 0.0
.INDENT 3.5
\fBRequest\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST /target/_revs_diff HTTP/1.1
Accept: application/json
Content\-Length: 160
Content\-Type: application/json
Host: localhost:5984
User\-Agent: CouchDB

{
    \(dqfoo\(dq: [
        \(dq3\-6a540f3d701ac518d3b9733d673c5484\(dq
    ],
    \(dqbar\(dq: [
        \(dq1\-967a00dff5e02add41819138abb3284d\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 2
Content\-Type: application/json
Date: Fri, 25 Oct 2013 14:45:00 GMT
Server: CouchDB (Erlang/OTP)

{}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Replication Completed
.sp
When there are no more changes left to process and no more Documents left to
replicate, the Replicator finishes the Replication process. If Replication
wasn’t Continuous, the Replicator MAY return a response to client with
statistics about the process.
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 414
Content\-Type: application/json
Date: Fri, 09 May 2014 15:14:19 GMT
Server: CouchDB (Erlang OTP)

{
    \(dqhistory\(dq: [
        {
            \(dqdoc_write_failures\(dq: 2,
            \(dqdocs_read\(dq: 2,
            \(dqdocs_written\(dq: 0,
            \(dqend_last_seq\(dq: 2939,
            \(dqend_time\(dq: \(dqFri, 09 May 2014 15:14:19 GMT\(dq,
            \(dqmissing_checked\(dq: 1835,
            \(dqmissing_found\(dq: 2,
            \(dqrecorded_seq\(dq: 2939,
            \(dqsession_id\(dq: \(dq05918159f64842f1fe73e9e2157b2112\(dq,
            \(dqstart_last_seq\(dq: 0,
            \(dqstart_time\(dq: \(dqFri, 09 May 2014 15:14:18 GMT\(dq
        }
    ],
    \(dqok\(dq: true,
    \(dqreplication_id_version\(dq: 3,
    \(dqsession_id\(dq: \(dq05918159f64842f1fe73e9e2157b2112\(dq,
    \(dqsource_last_seq\(dq: 2939
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Replicate Changes
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- +
\(aq Locate Changed Documents:                                                       \(aq
\(aq                                                                                 \(aq
\(aq               +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                           \(aq
\(aq               |      Any Differences Found?         |                           \(aq
\(aq               +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                           \(aq
\(aq                                                   |                             \(aq
\(aq                                                   |                             \(aq
\(aq                                                   |                             \(aq
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- | \- \- \- \- \- \- \- \- \- \- \- \- \- \- +
                                                    |
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- | \- \- \- \- \- \- \- \- \- \- \- \- \- \- +
\(aq Replicate Changes:                                |                             \(aq
\(aq                                                   v                             \(aq
\(aq               +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                           \(aq
\(aq   +\-\-\-\-\-\-\-\-\-> |     Fetch Next Changed Document     | <\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+   \(aq
\(aq   |           +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                       |   \(aq
\(aq   |           |          GET /source/docid          |                       |   \(aq
\(aq   |           +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                       |   \(aq
\(aq   |             |                                                           |   \(aq
\(aq   |             |                                                           |   \(aq
\(aq   |             |                                          201 Created      |   \(aq
\(aq   |             | 200 OK                                   401 Unauthorized |   \(aq
\(aq   |             |                                          403 Forbidden    |   \(aq
\(aq   |             |                                                           |   \(aq
\(aq   |             v                                                           |   \(aq
\(aq   |           +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                       |   \(aq
\(aq   |   +\-\-\-\-\-\- |  Document Has Changed Attachments?  |                       |   \(aq
\(aq   |   |       +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                       |   \(aq
\(aq   |   |         |                                                           |   \(aq
\(aq   |   |         |                                                           |   \(aq
\(aq   |   |         | Yes                                                       |   \(aq
\(aq   |   |         |                                                           |   \(aq
\(aq   |   |         v                                                           |   \(aq
\(aq   |   |       +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+   Yes    +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+ \(aq
\(aq   |   | No    |  Are They Big Enough?  | \-\-\-\-\-\-\-> | Update Document on Target | \(aq
\(aq   |   |       +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+          +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+ \(aq
\(aq   |   |         |                                 |     PUT /target/docid     | \(aq
\(aq   |   |         |                                 +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+ \(aq
\(aq   |   |         |                                                               \(aq
\(aq   |   |         | No                                                            \(aq
\(aq   |   |         |                                                               \(aq
\(aq   |   |         v                                                               \(aq
\(aq   |   |       +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                           \(aq
\(aq   |   +\-\-\-\-\-> |     Put Document Into the Stack     |                           \(aq
\(aq   |           +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                           \(aq
\(aq   |             |                                                               \(aq
\(aq   |             |                                                               \(aq
\(aq   |             v                                                               \(aq
\(aq   |     No    +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                           \(aq
\(aq   +\-\-\-\-\-\-\-\-\-\- |           Stack is Full?            |                           \(aq
\(aq   |           +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                           \(aq
\(aq   |             |                                                               \(aq
\(aq   |             | Yes                                                           \(aq
\(aq   |             |                                                               \(aq
\(aq   |             v                                                               \(aq
\(aq   |           +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                           \(aq
\(aq   |           | Upload Stack of Documents to Target |                           \(aq
\(aq   |           +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                           \(aq
\(aq   |           |       POST /target/_bulk_docs       |                           \(aq
\(aq   |           +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                           \(aq
\(aq   |             |                                                               \(aq
\(aq   |             | 201 Created                                                   \(aq
\(aq   |             v                                                               \(aq
\(aq   |           +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                           \(aq
\(aq   |           |          Ensure in Commit           |                           \(aq
\(aq   |           +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                           \(aq
\(aq   |           |  POST /target/_ensure_full_commit   |                           \(aq
\(aq   |           +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                           \(aq
\(aq   |             |                                                               \(aq
\(aq   |             | 201 Created                                                   \(aq
\(aq   |             v                                                               \(aq
\(aq   |           +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                           \(aq
\(aq   |           |    Record Replication Checkpoint    |                           \(aq
\(aq   |           +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                           \(aq
\(aq   |           |  PUT /source/_local/replication\-id  |                           \(aq
\(aq   |           |  PUT /target/_local/replication\-id  |                           \(aq
\(aq   |           +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                           \(aq
\(aq   |             |                                                               \(aq
\(aq   |             | 201 Created                                                   \(aq
\(aq   |             v                                                               \(aq
\(aq   |     No    +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                           \(aq
\(aq   +\-\-\-\-\-\-\-\-\-\- | All Documents from Batch Processed? |                           \(aq
\(aq               +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                           \(aq
\(aq                                                   |                             \(aq
\(aq                                               Yes |                             \(aq
\(aq                                                   |                             \(aq
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- | \- \- \- \- \- \- \- \- \- \- \- \- \- \- +
                                                    |
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- | \- \- \- \- \- \- \- \- \- \- \- \- \- \- +
\(aq Locate Changed Documents:                         |                             \(aq
\(aq                                                   v                             \(aq
\(aq               +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                           \(aq
\(aq               |       Listen to Changes Feed        |                           \(aq
\(aq               +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-+                           \(aq
\(aq                                                                                 \(aq
+ \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- \- +
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Fetch Changed Documents
.sp
At this step the Replicator MUST fetch all Document Leaf Revisions from Source
that are missed at Target. This operation is effective if Replication WILL
use previously calculated Revision differences since they define
missing Documents and their Revisions.
.sp
To fetch the Document the Replicator will make a \fI\%GET /{db}/{docid}\fP request
with the following query parameters:
.INDENT 0.0
.IP \(bu 2
\fBrevs=true\fP: Instructs the Source to include the list of all known revisions
into the Document in the \fB_revisions\fP field. This information is needed to
synchronize the Document’s ancestors history between Source and Target
.IP \(bu 2
The \fBopen_revs\fP query parameter contains a JSON array with a list of
Leaf Revisions that are needed to be fetched. If the specified Revision
exists then the Document MUST be returned for this Revision. Otherwise,
Source MUST return an object with the single field \fBmissing\fP with the
missed Revision as the value. In case the Document contains attachments,
Source MUST return information only for those ones that had been changed
(added or updated) since the specified Revision values. If an attachment
was deleted, the Document MUST NOT have stub information for it
.IP \(bu 2
\fBlatest=true\fP: Ensures, that Source will return the latest Document Revision
regardless of which one was specified in the \fBopen_revs\fP query parameter.
This parameter solves a race condition problem where the requested Document
may be changed in between this step and handling related events on the
Changes Feed
.UNINDENT
.sp
In the response Source SHOULD return \fImultipart/mixed\fP or respond
instead with \fIapplication/json\fP unless the \fI\%Accept\fP header
specifies a different mime type. The \fImultipart/mixed\fP content type
allows handling the response data as a stream, since there could be multiple
documents (one per each Leaf Revision) plus several attachments. These
attachments are mostly binary and JSON has no way to handle such data except as
base64 encoded strings which are very ineffective for transfer and processing
operations.
.sp
With a \fImultipart/mixed\fP response the Replicator handles multiple
Document Leaf Revisions and their attachments one by one as raw data without
any additional encoding applied. There is also one agreement to make data
processing more effective: the Document ALWAYS goes before its attachments, so
the Replicator has no need to process all the data to map related
Documents\-Attachments and may handle it as stream with lesser memory footprint.
.INDENT 0.0
.INDENT 3.5
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /source/SpaghettiWithMeatballs?revs=true&open_revs=[%225\-00ecbbc%22,%221\-917fa23%22,%223\-6bcedf1%22]&latest=true HTTP/1.1
Accept: multipart/mixed
Host: localhost:5984
User\-Agent: CouchDB
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Content\-Type: multipart/mixed; boundary=\(dq7b1596fc4940bc1be725ad67f11ec1c4\(dq
Date: Thu, 07 Nov 2013 15:10:16 GMT
Server: CouchDB (Erlang OTP)
Transfer\-Encoding: chunked

\-\-7b1596fc4940bc1be725ad67f11ec1c4
Content\-Type: application/json

{
    \(dq_id\(dq: \(dqSpaghettiWithMeatballs\(dq,
    \(dq_rev\(dq: \(dq1\-917fa23\(dq,
    \(dq_revisions\(dq: {
        \(dqids\(dq: [
            \(dq917fa23\(dq
        ],
        \(dqstart\(dq: 1
    },
    \(dqdescription\(dq: \(dqAn Italian\-American delicious dish\(dq,
    \(dqingredients\(dq: [
        \(dqspaghetti\(dq,
        \(dqtomato sauce\(dq,
        \(dqmeatballs\(dq
    ],
    \(dqname\(dq: \(dqSpaghetti with meatballs\(dq
}
\-\-7b1596fc4940bc1be725ad67f11ec1c4
Content\-Type: multipart/related; boundary=\(dqa81a77b0ca68389dda3243a43ca946f2\(dq

\-\-a81a77b0ca68389dda3243a43ca946f2
Content\-Type: application/json

{
    \(dq_attachments\(dq: {
      \(dqrecipe.txt\(dq: {
          \(dqcontent_type\(dq: \(dqtext/plain\(dq,
          \(dqdigest\(dq: \(dqmd5\-R5CrCb6fX10Y46AqtNn0oQ==\(dq,
          \(dqfollows\(dq: true,
          \(dqlength\(dq: 87,
          \(dqrevpos\(dq: 7
      }
    },
    \(dq_id\(dq: \(dqSpaghettiWithMeatballs\(dq,
    \(dq_rev\(dq: \(dq7\-474f12e\(dq,
    \(dq_revisions\(dq: {
        \(dqids\(dq: [
            \(dq474f12e\(dq,
            \(dq5949cfc\(dq,
            \(dq00ecbbc\(dq,
            \(dqfc997b6\(dq,
            \(dq3552c87\(dq,
            \(dq404838b\(dq,
            \(dq5defd9d\(dq,
            \(dqdc1e4be\(dq
        ],
        \(dqstart\(dq: 7
    },
    \(dqdescription\(dq: \(dqAn Italian\-American delicious dish\(dq,
    \(dqingredients\(dq: [
        \(dqspaghetti\(dq,
        \(dqtomato sauce\(dq,
        \(dqmeatballs\(dq,
        \(dqlove\(dq
    ],
    \(dqname\(dq: \(dqSpaghetti with meatballs\(dq
}
\-\-a81a77b0ca68389dda3243a43ca946f2
Content\-Disposition: attachment; filename=\(dqrecipe.txt\(dq
Content\-Type: text/plain
Content\-Length: 87

1. Cook spaghetti
2. Cook meetballs
3. Mix them
4. Add tomato sauce
5. ...
6. PROFIT!

\-\-a81a77b0ca68389dda3243a43ca946f2\-\-
\-\-7b1596fc4940bc1be725ad67f11ec1c4
Content\-Type: application/json; error=\(dqtrue\(dq

{\(dqmissing\(dq:\(dq3\-6bcedf1\(dq}
\-\-7b1596fc4940bc1be725ad67f11ec1c4\-\-
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
After receiving the response, the Replicator puts all the received data into a
local stack for further bulk upload to utilize network bandwidth effectively.
The local stack size could be limited by number of Documents or bytes of
handled JSON data. When the stack is full the Replicator uploads all the
handled Document in bulk mode to the Target. While bulk operations are highly
RECOMMENDED to be used, in certain cases the Replicator MAY upload Documents to
Target one by one.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Alternative Replicator implementations MAY use alternative ways to retrieve
Documents from Source. For instance, \fI\%PouchDB\fP doesn’t use the Multipart
API
and fetches only the latest Document Revision with inline attachments as a
single
JSON object. While this is still valid CouchDB HTTP API usage, such
solutions MAY require a different API implementation for non\-CouchDB
Peers.
.UNINDENT
.UNINDENT
.SS Upload Batch of Changed Documents
.sp
To upload multiple Documents in a single shot the Replicator sends a
\fI\%POST /{db}/_bulk_docs\fP request to Target with payload containing a JSON object
with the following mandatory fields:
.INDENT 0.0
.IP \(bu 2
\fBdocs\fP (\fIarray\fP of \fIobjects\fP): List of Document objects to update on Target.
These Documents MUST contain the \fB_revisions\fP field that holds a list of the
full Revision history to let Target create Leaf Revisions that correctly
preserve ancestry
.IP \(bu 2
\fBnew_edits\fP (\fIboolean\fP): Special flag that instructs Target to store
Documents with the specified Revision (field \fB_rev\fP) value as\-is without
generating a new revision. Always \fBfalse\fP
.UNINDENT
.sp
The request also MAY contain \fIX\-Couch\-Full\-Commit\fP that used to control
CouchDB <3.0 behavior when delayed commits were enabled. Other Peers MAY ignore
this header or use it to control similar local feature.
.INDENT 0.0
.INDENT 3.5
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST /target/_bulk_docs HTTP/1.1
Accept: application/json
Content\-Length: 826
Content\-Type:application/json
Host: localhost:5984
User\-Agent: CouchDB
X\-Couch\-Full\-Commit: false

{
    \(dqdocs\(dq: [
        {
            \(dq_id\(dq: \(dqSpaghettiWithMeatballs\(dq,
            \(dq_rev\(dq: \(dq1\-917fa2381192822767f010b95b45325b\(dq,
            \(dq_revisions\(dq: {
                \(dqids\(dq: [
                    \(dq917fa2381192822767f010b95b45325b\(dq
                ],
                \(dqstart\(dq: 1
            },
            \(dqdescription\(dq: \(dqAn Italian\-American delicious dish\(dq,
            \(dqingredients\(dq: [
                \(dqspaghetti\(dq,
                \(dqtomato sauce\(dq,
                \(dqmeatballs\(dq
            ],
            \(dqname\(dq: \(dqSpaghetti with meatballs\(dq
        },
        {
            \(dq_id\(dq: \(dqLambStew\(dq,
            \(dq_rev\(dq: \(dq1\-34c318924a8f327223eed702ddfdc66d\(dq,
            \(dq_revisions\(dq: {
                \(dqids\(dq: [
                    \(dq34c318924a8f327223eed702ddfdc66d\(dq
                ],
                \(dqstart\(dq: 1
            },
            \(dqservings\(dq: 6,
            \(dqsubtitle\(dq: \(dqDelicious with scone topping\(dq,
            \(dqtitle\(dq: \(dqLamb Stew\(dq
        },
        {
            \(dq_id\(dq: \(dqFishStew\(dq,
            \(dq_rev\(dq: \(dq1\-9c65296036141e575d32ba9c034dd3ee\(dq,
            \(dq_revisions\(dq: {
                \(dqids\(dq: [
                    \(dq9c65296036141e575d32ba9c034dd3ee\(dq
                ],
                \(dqstart\(dq: 1
            },
            \(dqservings\(dq: 4,
            \(dqsubtitle\(dq: \(dqDelicious with fresh bread\(dq,
            \(dqtitle\(dq: \(dqFish Stew\(dq
        }
    ],
    \(dqnew_edits\(dq: false
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
In its response Target MUST return a JSON array with a list of Document update
statuses. If the Document has been stored successfully, the list item MUST
contain the field \fBok\fP with \fBtrue\fP value. Otherwise it MUST contain
\fBerror\fP and \fBreason\fP fields with error type and a human\-friendly reason
description.
.sp
Document updating failure isn’t fatal as Target MAY reject the update for its
own reasons. It’s RECOMMENDED to use error type \fBforbidden\fP for rejections,
but other error types can also be used (like invalid field name etc.). The
Replicator SHOULD NOT retry uploading rejected documents unless there are
good reasons for doing so (e.g. there is special error type for that).
.sp
Note that while a update may fail for one Document in the response,
Target can still return a \fI\%201 Created\fP response. Same will be true if all
updates fail for all uploaded Documents.
.INDENT 0.0
.INDENT 3.5
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Cache\-Control: must\-revalidate
Content\-Length: 246
Content\-Type: application/json
Date: Sun, 10 Nov 2013 19:02:26 GMT
Server: CouchDB (Erlang/OTP)

[
    {
        \(dqok\(dq: true,
        \(dqid\(dq: \(dqSpaghettiWithMeatballs\(dq,
        \(dqrev\(dq:\(dq 1\-917fa2381192822767f010b95b45325b\(dq
    },
    {
        \(dqok\(dq: true,
        \(dqid\(dq: \(dqFishStew\(dq,
        \(dqrev\(dq: \(dq1\-9c65296036141e575d32ba9c034dd3ee\(dq
    },
    {
        \(dqerror\(dq: \(dqforbidden\(dq,
        \(dqid\(dq: \(dqLambStew\(dq,
        \(dqreason\(dq: \(dqsorry\(dq,
        \(dqrev\(dq: \(dq1\-34c318924a8f327223eed702ddfdc66d\(dq
    }
]
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Upload Document with Attachments
.sp
There is a special optimization case when then Replicator WILL NOT use bulk
upload of changed Documents. This case is applied when Documents contain a
lot of attached files or the files are too big to be efficiently encoded with
Base64.
.sp
For this case the Replicator issues a \fI\%/{db}/{docid}?new_edits=false\fP request with \fImultipart/related\fP content type. Such
a request allows one to easily stream the Document and all its attachments
one by one without any serialization overhead.
.INDENT 0.0
.INDENT 3.5
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
PUT /target/SpaghettiWithMeatballs?new_edits=false HTTP/1.1
Accept: application/json
Content\-Length: 1030
Content\-Type: multipart/related; boundary=\(dq864d690aeb91f25d469dec6851fb57f2\(dq
Host: localhost:5984
User\-Agent: CouchDB

\-\-2fa48cba80d0cdba7829931fe8acce9d
Content\-Type: application/json

{
    \(dq_attachments\(dq: {
        \(dqrecipe.txt\(dq: {
            \(dqcontent_type\(dq: \(dqtext/plain\(dq,
            \(dqdigest\(dq: \(dqmd5\-R5CrCb6fX10Y46AqtNn0oQ==\(dq,
            \(dqfollows\(dq: true,
            \(dqlength\(dq: 87,
            \(dqrevpos\(dq: 7
        }
    },
    \(dq_id\(dq: \(dqSpaghettiWithMeatballs\(dq,
    \(dq_rev\(dq: \(dq7\-474f12eb068c717243487a9505f6123b\(dq,
    \(dq_revisions\(dq: {
        \(dqids\(dq: [
            \(dq474f12eb068c717243487a9505f6123b\(dq,
            \(dq5949cfcd437e3ee22d2d98a26d1a83bf\(dq,
            \(dq00ecbbc54e2a171156ec345b77dfdf59\(dq,
            \(dqfc997b62794a6268f2636a4a176efcd6\(dq,
            \(dq3552c87351aadc1e4bea2461a1e8113a\(dq,
            \(dq404838bc2862ce76c6ebed046f9eb542\(dq,
            \(dq5defd9d813628cea6e98196eb0ee8594\(dq
        ],
        \(dqstart\(dq: 7
    },
    \(dqdescription\(dq: \(dqAn Italian\-American delicious dish\(dq,
    \(dqingredients\(dq: [
        \(dqspaghetti\(dq,
        \(dqtomato sauce\(dq,
        \(dqmeatballs\(dq,
        \(dqlove\(dq
    ],
    \(dqname\(dq: \(dqSpaghetti with meatballs\(dq
}
\-\-2fa48cba80d0cdba7829931fe8acce9d
Content\-Disposition: attachment; filename=\(dqrecipe.txt\(dq
Content\-Type: text/plain
Content\-Length: 87

1. Cook spaghetti
2. Cook meetballs
3. Mix them
4. Add tomato sauce
5. ...
6. PROFIT!

\-\-2fa48cba80d0cdba7829931fe8acce9d\-\-
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Cache\-Control: must\-revalidate
Content\-Length: 105
Content\-Type: application/json
Date: Fri, 08 Nov 2013 16:35:27 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqok\(dq: true,
    \(dqid\(dq: \(dqSpaghettiWithMeatballs\(dq,
    \(dqrev\(dq: \(dq7\-474f12eb068c717243487a9505f6123b\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
Unlike bulk updating via \fI\%POST /{db}/_bulk_docs\fP endpoint, the response MAY
come with a different status code. For instance, in the case when the Document
is rejected, Target SHOULD respond with a \fI\%403 Forbidden\fP:
.INDENT 0.0
.INDENT 3.5
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 403 Forbidden
Cache\-Control: must\-revalidate
Content\-Length: 39
Content\-Type: application/json
Date: Fri, 08 Nov 2013 16:35:27 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqerror\(dq: \(dqforbidden\(dq,
    \(dqreason\(dq: \(dqsorry\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
Replicator SHOULD NOT retry requests in case of a \fI\%401 Unauthorized\fP,
\fI\%403 Forbidden\fP, \fI\%409 Conflict\fP or \fI\%412 Precondition Failed\fP since repeating
the request couldn’t solve the issue with user credentials or uploaded data.
.SS Ensure In Commit
.sp
Once a batch of changes has been successfully uploaded to Target, the
Replicator issues a \fI\%POST /{db}/_ensure_full_commit\fP request to ensure that
every transferred bit is laid down on disk or other \fIpersistent\fP storage place.
Target MUST return \fI\%201 Created\fP response with a JSON object containing the
following mandatory fields:
.INDENT 0.0
.IP \(bu 2
\fBinstance_start_time\fP (\fIstring\fP): Timestamp of when the database was
opened, expressed in \fImicroseconds\fP since the epoch
.IP \(bu 2
\fBok\fP (\fIboolean\fP): Operation status. Constantly \fBtrue\fP
.sp
\fBRequest\fP:
.INDENT 2.0
.INDENT 3.5
.sp
.nf
.ft C
POST /target/_ensure_full_commit HTTP/1.1
Accept: application/json
Content\-Type: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 2.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Cache\-Control: must\-revalidate
Content\-Length: 53
Content\-Type: application/json
Date: Web, 06 Nov 2013 18:20:43 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqinstance_start_time\(dq: \(dq0\(dq,
    \(dqok\(dq: true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS Record Replication Checkpoint
.sp
Since batches of changes were uploaded and committed successfully, the
Replicator updates the Replication Log both on Source and Target recording
the current Replication state. This operation is REQUIRED so that in the case
of Replication failure the replication can resume from last point of success,
not from the very beginning.
.sp
Replicator updates Replication Log on Source:
.INDENT 0.0
.INDENT 3.5
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
PUT /source/_local/afa899a9e59589c3d4ce5668e3218aef HTTP/1.1
Accept: application/json
Content\-Length: 591
Content\-Type: application/json
Host: localhost:5984
User\-Agent: CouchDB

{
    \(dq_id\(dq: \(dq_local/afa899a9e59589c3d4ce5668e3218aef\(dq,
    \(dq_rev\(dq: \(dq0\-1\(dq,
    \(dq_revisions\(dq: {
        \(dqids\(dq: [
            \(dq31f36e40158e717fbe9842e227b389df\(dq
        ],
        \(dqstart\(dq: 1
    },
    \(dqhistory\(dq: [
        {
            \(dqdoc_write_failures\(dq: 0,
            \(dqdocs_read\(dq: 6,
            \(dqdocs_written\(dq: 6,
            \(dqend_last_seq\(dq: 26,
            \(dqend_time\(dq: \(dqThu, 07 Nov 2013 09:42:17 GMT\(dq,
            \(dqmissing_checked\(dq: 6,
            \(dqmissing_found\(dq: 6,
            \(dqrecorded_seq\(dq: 26,
            \(dqsession_id\(dq: \(dq04bf15bf1d9fa8ac1abc67d0c3e04f07\(dq,
            \(dqstart_last_seq\(dq: 0,
            \(dqstart_time\(dq: \(dqThu, 07 Nov 2013 09:41:43 GMT\(dq
        }
    ],
    \(dqreplication_id_version\(dq: 3,
    \(dqsession_id\(dq: \(dq04bf15bf1d9fa8ac1abc67d0c3e04f07\(dq,
    \(dqsource_last_seq\(dq: 26
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Cache\-Control: must\-revalidate
Content\-Length: 75
Content\-Type: application/json
Date: Thu, 07 Nov 2013 09:42:17 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqid\(dq: \(dq_local/afa899a9e59589c3d4ce5668e3218aef\(dq,
    \(dqok\(dq: true,
    \(dqrev\(dq: \(dq0\-2\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
…and on Target too:
.INDENT 0.0
.INDENT 3.5
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
PUT /target/_local/afa899a9e59589c3d4ce5668e3218aef HTTP/1.1
Accept: application/json
Content\-Length: 591
Content\-Type: application/json
Host: localhost:5984
User\-Agent: CouchDB

{
    \(dq_id\(dq: \(dq_local/afa899a9e59589c3d4ce5668e3218aef\(dq,
    \(dq_rev\(dq: \(dq1\-31f36e40158e717fbe9842e227b389df\(dq,
    \(dq_revisions\(dq: {
        \(dqids\(dq: [
            \(dq31f36e40158e717fbe9842e227b389df\(dq
        ],
        \(dqstart\(dq: 1
    },
    \(dqhistory\(dq: [
        {
            \(dqdoc_write_failures\(dq: 0,
            \(dqdocs_read\(dq: 6,
            \(dqdocs_written\(dq: 6,
            \(dqend_last_seq\(dq: 26,
            \(dqend_time\(dq: \(dqThu, 07 Nov 2013 09:42:17 GMT\(dq,
            \(dqmissing_checked\(dq: 6,
            \(dqmissing_found\(dq: 6,
            \(dqrecorded_seq\(dq: 26,
            \(dqsession_id\(dq: \(dq04bf15bf1d9fa8ac1abc67d0c3e04f07\(dq,
            \(dqstart_last_seq\(dq: 0,
            \(dqstart_time\(dq: \(dqThu, 07 Nov 2013 09:41:43 GMT\(dq
        }
    ],
    \(dqreplication_id_version\(dq: 3,
    \(dqsession_id\(dq: \(dq04bf15bf1d9fa8ac1abc67d0c3e04f07\(dq,
    \(dqsource_last_seq\(dq: 26
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Cache\-Control: must\-revalidate
Content\-Length: 106
Content\-Type: application/json
Date: Thu, 07 Nov 2013 09:42:17 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqid\(dq: \(dq_local/afa899a9e59589c3d4ce5668e3218aef\(dq,
    \(dqok\(dq: true,
    \(dqrev\(dq: \(dq2\-9b5d1e36bed6ae08611466e30af1259a\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Continue Reading Changes
.sp
Once a batch of changes had been processed and transferred to Target
successfully, the Replicator can continue to listen to the Changes Feed for new
changes. If there are no new changes to process the Replication is considered
to be done.
.sp
For Continuous Replication, the Replicator MUST continue to wait for new changes
from Source.
.SS Protocol Robustness
.sp
Since the \fICouchDB Replication Protocol\fP works on top of HTTP, which is based on
TCP/IP, the Replicator SHOULD expect to be working within an unstable
environment with delays, losses and other bad surprises that might eventually
occur. The Replicator SHOULD NOT count every HTTP request failure as a \fIfatal
error\fP\&. It SHOULD be smart enough to detect timeouts, repeat failed requests,
be ready to process incomplete or malformed data and so on. \fIData must flow\fP
\- that’s the rule.
.SS Error Responses
.sp
In case something goes wrong the Peer MUST respond with a JSON object with
the following REQUIRED fields:
.INDENT 0.0
.IP \(bu 2
\fBerror\fP (\fIstring\fP): Error type for programs and developers
.IP \(bu 2
\fBreason\fP (\fIstring\fP): Error description for humans
.UNINDENT
.SS Bad Request
.sp
If a request contains malformed data (like invalid JSON) the Peer MUST respond
with a HTTP \fI\%400 Bad Request\fP and \fBbad_request\fP as error type:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqerror\(dq: \(dqbad_request\(dq,
    \(dqreason\(dq: \(dqinvalid json\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Unauthorized
.sp
If a Peer REQUIRES credentials be included with the request and the request
does not contain acceptable credentials then the Peer MUST respond with the
HTTP \fI\%401 Unauthorized\fP and \fBunauthorized\fP as error type:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqerror\(dq: \(dqunauthorized\(dq,
    \(dqreason\(dq: \(dqName or password is incorrect\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Forbidden
.sp
If a Peer receives valid user credentials, but the requester does not have
sufficient permissions to perform the operation then the Peer
MUST respond with a HTTP \fI\%403 Forbidden\fP and \fBforbidden\fP as error type:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqerror\(dq: \(dqforbidden\(dq,
    \(dqreason\(dq: \(dqYou may only update your own user document.\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Resource Not Found
.sp
If the requested resource, Database or Document wasn’t found on a Peer, the Peer
MUST respond with a HTTP \fI\%404 Not Found\fP and \fBnot_found\fP as error type:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqerror\(dq: \(dqnot_found\(dq,
    \(dqreason\(dq: \(dqdatabase \e\(dqtarget\e\(dq does not exists\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Method Not Allowed
.sp
If an unsupported method was used then the Peer MUST respond with a
HTTP \fI\%405 Method Not Allowed\fP and \fBmethod_not_allowed\fP as error type:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqerror\(dq: \(dqmethod_not_allowed\(dq,
    \(dqreason\(dq: \(dqOnly GET, PUT, DELETE allowed\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Resource Conflict
.sp
A resource conflict error occurs when there are concurrent updates of the same
resource by multiple clients. In this case the Peer MUST respond with a HTTP
\fI\%409 Conflict\fP and \fBconflict\fP as error type:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqerror\(dq: \(dqconflict\(dq,
    \(dqreason\(dq: \(dqdocument update conflict\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Precondition Failed
.sp
The HTTP \fI\%412 Precondition Failed\fP response may be sent in case of an attempt to
create a Database (error type \fBdb_exists\fP) that already exists
or some attachment information is missing (error type \fBmissing_stub\fP).
There is no explicit error type restrictions, but it is RECOMMEND to use error
types that are previously mentioned:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqerror\(dq: \(dqdb_exists\(dq,
    \(dqreason\(dq: \(dqdatabase \e\(dqtarget\e\(dq exists\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Server Error
.sp
Raised in case an error is \fIfatal\fP and the Replicator cannot do anything to
continue Replication. In this case the Replicator MUST return a HTTP
\fI\%500 Internal Server Error\fP response with an error description (no restrictions on error
type applied):
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqerror\(dq: \(dqworker_died\(dq,
    \(dqreason\(dq: \(dqkaboom!\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Optimisations
.sp
There are RECOMMENDED approaches to optimize the Replication process:
.INDENT 0.0
.IP \(bu 2
Keep the number of HTTP requests at a reasonable minimum
.IP \(bu 2
Try to work with a connection pool and make parallel/multiple requests
whenever possible
.IP \(bu 2
Don’t close sockets after each request: respect the keep\-alive option
.IP \(bu 2
Use continuous sessions (cookies, etc.) to reduce authentication overhead
.IP \(bu 2
Try to use bulk requests for every operations with Documents
.IP \(bu 2
Find out optimal batch size for Changes feed processing
.IP \(bu 2
Preserve Replication Logs and resume Replication from the last Checkpoint
whenever possible
.IP \(bu 2
Optimize filter functions: let them run as fast as possible
.IP \(bu 2
Get ready for surprises: networks are very unstable environments
.UNINDENT
.SS API Reference
.SS Common Methods
.INDENT 0.0
.IP \(bu 2
\fI\%HEAD /{db}\fP – Check Database existence
.IP \(bu 2
\fI\%GET /{db}\fP – Retrieve Database information
.IP \(bu 2
\fI\%GET /{db}/_local/{docid}\fP – Read the last Checkpoint
.IP \(bu 2
\fI\%PUT /{db}/_local/{docid}\fP – Save a new Checkpoint
.UNINDENT
.SS For Target
.INDENT 0.0
.IP \(bu 2
\fI\%PUT /{db}\fP – Create Target if it not exists and the option was provided
.IP \(bu 2
\fI\%POST /{db}/_revs_diff\fP – Locate Revisions that are not known to Target
.IP \(bu 2
\fI\%POST /{db}/_bulk_docs\fP – Upload Revisions to Target
.IP \(bu 2
\fI\%PUT /{db}/{docid}\fP – Upload a single Document with attachments to Target
.IP \(bu 2
\fI\%POST /{db}/_ensure_full_commit\fP – Ensure that all changes are stored
on disk
.UNINDENT
.SS For Source
.INDENT 0.0
.IP \(bu 2
\fI\%GET /{db}/_changes\fP – Fetch changes since the last pull of Source
.IP \(bu 2
\fI\%POST /{db}/_changes\fP – Fetch changes for specified Document IDs since
the last pull of Source
.IP \(bu 2
\fI\%GET /{db}/{docid}\fP – Retrieve a single Document from Source
with attachments
.UNINDENT
.SS Reference
.INDENT 0.0
.IP \(bu 2
\fI\%Refuge RCouch wiki\fP
.IP \(bu 2
\fI\%CouchBase Lite IOS wiki\fP
.UNINDENT
.SH DESIGN DOCUMENTS
.sp
CouchDB supports special documents within databases known as “design
documents”. These documents, mostly driven by JavaScript you write, are used
to build indexes, validate document updates, format query results, and filter
replications.
.SS Design Documents
.sp
In this section we’ll show how to write design documents, using the built\-in
\fI\%JavaScript Query Server\fP\&.
.sp
But before we start to write our first document, let’s take a look at the list
of common objects that will be used during our code journey \- we’ll be using
them extensively within each function:
.INDENT 0.0
.IP \(bu 2
\fI\%Database information object\fP
.IP \(bu 2
\fI\%Request object\fP
.IP \(bu 2
\fI\%Response object\fP
.IP \(bu 2
\fI\%UserCtx object\fP
.IP \(bu 2
\fI\%Database Security object\fP
.IP \(bu 2
\fI\%Guide to JavaScript Query Server\fP
.UNINDENT
.SS Creation and Structure
.sp
Design documents contain functions such as view and update functions. These functions
are executed when requested.
.sp
Design documents are denoted by an id field with the format \fB_design/{name}\fP\&. Their
structure follows the example below.
.sp
\fBExample\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dq_design/example\(dq,
    \(dqviews\(dq: {
        \(dqview\-number\-one\(dq: {
            \(dqmap\(dq: \(dqfunction (doc) {/* function code here \- see below */}\(dq
        },
        \(dqview\-number\-two\(dq: {
            \(dqmap\(dq: \(dqfunction (doc) {/* function code here \- see below */}\(dq,
            \(dqreduce\(dq: \(dqfunction (keys, values, rereduce) {/* function code here \- see below */}\(dq
        }
    },
    \(dqupdates\(dq: {
        \(dqupdatefun1\(dq: \(dqfunction(doc,req) {/* function code here \- see below */}\(dq,
        \(dqupdatefun2\(dq: \(dqfunction(doc,req) {/* function code here \- see below */}\(dq
    },
    \(dqfilters\(dq: {
        \(dqfilterfunction1\(dq: \(dqfunction(doc, req){ /* function code here \- see below */ }\(dq
    },
    \(dqvalidate_doc_update\(dq: \(dqfunction(newDoc, oldDoc, userCtx, secObj) { /* function code here \- see below */ }\(dq,
    \(dqlanguage\(dq: \(dqjavascript\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
As you can see, a design document can include multiple functions of the same type. The
example defines two views, both of which have a map function and one of which has a
reduce function. It also defines two update functions and one filter function. The
Validate Document Update function is a special case, as each design document cannot
contain more than one of those.
.SS View Functions
.sp
Views are the primary tool used for querying and reporting on CouchDB databases.
.SS Map Functions
.INDENT 0.0
.TP
.B mapfun(doc)
.INDENT 7.0
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
\fBdoc\fP – The document that is being processed
.UNINDENT
.UNINDENT
.UNINDENT
.sp
Map functions accept a single document as the argument and (optionally)
\fI\%emit()\fP key/value pairs that are stored in a view.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function (doc) {
  if (doc.type === \(aqpost\(aq && doc.tags && Array.isArray(doc.tags)) {
    doc.tags.forEach(function (tag) {
      emit(tag.toLowerCase(), 1);
    });
  }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
In this example a key/value pair is emitted for each value in the \fItags\fP array
of a document with a \fItype\fP of “post”. Note that \fI\%emit()\fP may be called many
times for a single document, so the same document may be available by several
different keys.
.sp
Also keep in mind that each document is \fIsealed\fP to prevent the situation where
one map function changes document state and another receives a modified version.
.sp
For efficiency reasons, documents are passed to a group of map functions \- each
document is processed by a group of map functions from all views of the related
design document. This means that if you trigger an index update for one view in
the design document, all others will get updated too.
.sp
Since version \fI1.1.0\fP, \fImap\fP supports \fI\%CommonJS\fP modules and
the \fI\%require()\fP function.
.SS Reduce and Rereduce Functions
.INDENT 0.0
.TP
.B redfun(keys, values[, rereduce])
.INDENT 7.0
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
\fBkeys\fP – Array of pairs of key\-docid for related map function results.
Always \fBnull\fP if rereduce is running (has \fBtrue\fP value).
.IP \(bu 2
\fBvalues\fP – Array of map function result values.
.IP \(bu 2
\fBrereduce\fP – Boolean flag to indicate a rereduce run.
.UNINDENT
.TP
.B Returns
Reduces \fIvalues\fP
.UNINDENT
.UNINDENT
.sp
Reduce functions take two required arguments of keys and values lists \- the
result of the related map function \- and an optional third value which indicates
if \fIrereduce\fP mode is active or not. \fIRereduce\fP is used for additional reduce
values list, so when it is \fBtrue\fP there is no information about related \fIkeys\fP
(first argument is \fBnull\fP).
.sp
Note that if the result of a \fIreduce\fP function is longer than the initial
values list then a Query Server error will be raised. However, this behavior
can be disabled by setting \fBreduce_limit\fP config option to \fBfalse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[query_server_config]
reduce_limit = false
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
While disabling \fBreduce_limit\fP might be useful for debug proposes, remember
that the main task of reduce functions is to \fIreduce\fP the mapped result, not to
make it bigger. Generally, your reduce function should converge rapidly to a
single value \- which could be an array or similar object.
.SS Built\-in Reduce Functions
.sp
Additionally, CouchDB has a set of built\-in reduce functions. These are
implemented in Erlang and run inside CouchDB, so they are much faster than the
equivalent JavaScript functions.
.INDENT 0.0
.TP
.B _approx_count_distinct
.UNINDENT
.sp
New in version 2.2.

.sp
Approximates the number of distinct keys in a view index using a variant of the
\fI\%HyperLogLog\fP algorithm. This algorithm enables an efficient, parallelizable
computation of cardinality using fixed memory resources. CouchDB has configured
the underlying data structure to have a relative error of ~2%.
.sp
As this reducer ignores the emitted values entirely, an invocation with
\fBgroup=true\fP will simply return a value of 1 for every distinct key in the
view. In the case of array keys, querying the view with a \fBgroup_level\fP
specified will return the number of distinct keys that share the common group
prefix in each row. The algorithm is also cognizant of the \fBstartkey\fP and
\fBendkey\fP boundaries and will return the number of distinct keys within the
specified key range.
.sp
A final note regarding Unicode collation: this reduce function uses the binary
representation of each key in the index directly as input to the HyperLogLog
filter. As such, it will (incorrectly) consider keys that are not byte identical
but that compare equal according to the Unicode collation rules to be distinct
keys, and thus has the potential to overestimate the cardinality of the key
space if a large number of such keys exist.
.INDENT 0.0
.TP
.B _count
.UNINDENT
.sp
Counts the number of values in the index with a given key. This could be
implemented in JavaScript as:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
// could be replaced by _count
function(keys, values, rereduce) {
    if (rereduce) {
        return sum(values);
    } else {
        return values.length;
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B _stats
.UNINDENT
.sp
Computes the following quantities for numeric values associated with each key:
\fBsum\fP, \fBmin\fP, \fBmax\fP, \fBcount\fP, and \fBsumsqr\fP\&. The behavior of the
\fB_stats\fP function varies depending on the output of the map function. The
simplest case is when the map phase emits a single numeric value for each key.
In this case the \fB_stats\fP function is equivalent to the following JavaScript:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
// could be replaced by _stats
function(keys, values, rereduce) {
    if (rereduce) {
        return {
            \(aqsum\(aq: values.reduce(function(a, b) { return a + b.sum }, 0),
            \(aqmin\(aq: values.reduce(function(a, b) { return Math.min(a, b.min) }, Infinity),
            \(aqmax\(aq: values.reduce(function(a, b) { return Math.max(a, b.max) }, \-Infinity),
            \(aqcount\(aq: values.reduce(function(a, b) { return a + b.count }, 0),
            \(aqsumsqr\(aq: values.reduce(function(a, b) { return a + b.sumsqr }, 0)
        }
    } else {
        return {
            \(aqsum\(aq: sum(values),
            \(aqmin\(aq: Math.min.apply(null, values),
            \(aqmax\(aq: Math.max.apply(null, values),
            \(aqcount\(aq: values.length,
            \(aqsumsqr\(aq: (function() {
            var sumsqr = 0;

            values.forEach(function (value) {
                sumsqr += value * value;
            });

            return sumsqr;
            })(),
        }
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The \fB_stats\fP function will also work with “pre\-aggregated” values from a map
phase. A map function that emits an object containing \fBsum\fP, \fBmin\fP, \fBmax\fP,
\fBcount\fP, and \fBsumsqr\fP keys and numeric values for each can use the
\fB_stats\fP function to combine these results with the data from other documents.
The emitted object may contain other keys (these are ignored by the reducer),
and it is also possible to mix raw numeric values and pre\-aggregated objects
in a single view and obtain the correct aggregated statistics.
.sp
Finally, \fB_stats\fP can operate on key\-value pairs where each value is an array
comprised of numbers or pre\-aggregated objects. In this case \fBevery\fP value
emitted from the map function must be an array, and the arrays must all be the
same length, as \fB_stats\fP will compute the statistical quantities above
\fIindependently\fP for each element in the array. Users who want to compute
statistics on multiple values from a single document should either \fBemit\fP each
value into the index separately, or compute the statistics for the set of values
using the JavaScript example above and emit a pre\-aggregated object.
.INDENT 0.0
.TP
.B _sum
.UNINDENT
.sp
In its simplest variation, \fB_sum\fP sums the numeric values associated with each
key, as in the following JavaScript:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
// could be replaced by _sum
function(keys, values) {
    return sum(values);
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
As with \fB_stats\fP, the \fB_sum\fP function offers a number of extended
capabilities. The \fB_sum\fP function requires that map values be numbers, arrays
of numbers, or objects. When presented with array output from a map function,
\fB_sum\fP will compute the sum for every element of the array. A bare numeric
value will be treated as an array with a single element, and arrays with fewer
elements will be treated as if they contained zeroes for every additional
element in the longest emitted array. As an example, consider the following map
output:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqtotal_rows\(dq:5, \(dqoffset\(dq:0, \(dqrows\(dq: [
    {\(dqid\(dq:\(dqid1\(dq, \(dqkey\(dq:\(dqabc\(dq, \(dqvalue\(dq: 2},
    {\(dqid\(dq:\(dqid2\(dq, \(dqkey\(dq:\(dqabc\(dq, \(dqvalue\(dq: [3,5,7]},
    {\(dqid\(dq:\(dqid2\(dq, \(dqkey\(dq:\(dqdef\(dq, \(dqvalue\(dq: [0,0,0,42]},
    {\(dqid\(dq:\(dqid2\(dq, \(dqkey\(dq:\(dqghi\(dq, \(dqvalue\(dq: 1},
    {\(dqid\(dq:\(dqid1\(dq, \(dqkey\(dq:\(dqghi\(dq, \(dqvalue\(dq: 3}
]}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The \fB_sum\fP for this output without any grouping would be:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqrows\(dq: [
    {\(dqkey\(dq:null, \(dqvalue\(dq: [9,5,7,42]}
]}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
while the grouped output would be
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqrows\(dq: [
    {\(dqkey\(dq:\(dqabc\(dq, \(dqvalue\(dq: [5,5,7]},
    {\(dqkey\(dq:\(dqdef\(dq, \(dqvalue\(dq: [0,0,0,42]},
    {\(dqkey\(dq:\(dqghi\(dq, \(dqvalue\(dq: 4
]}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This is in contrast to the behavior of the \fB_stats\fP function which requires
that all emitted values be arrays of identical length if any array is emitted.
.sp
It is also possible to have \fB_sum\fP recursively descend through an emitted
object and compute the sums for every field in the object. Objects \fIcannot\fP be
mixed with other data structures. Objects can be arbitrarily nested, provided
that the values for all fields are themselves numbers, arrays of numbers, or
objects.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
\fBWhy don’t reduce functions support CommonJS modules?\fP
.sp
While \fImap\fP functions have limited access to stored modules through
\fI\%require()\fP, there is no such feature for \fIreduce\fP functions.
The reason lies deep inside the way \fImap\fP and \fIreduce\fP
functions are processed by the Query Server. Let’s take a look at \fImap\fP
functions first:
.INDENT 0.0
.IP 1. 3
CouchDB sends all \fImap\fP functions in a processed design document to the
Query Server.
.IP 2. 3
the Query Server handles them one by one, compiles and puts them onto an
internal stack.
.IP 3. 3
after all \fImap\fP functions have been processed, CouchDB will send the
remaining documents for indexing, one by one.
.IP 4. 3
the Query Server receives the document object and applies it to every
function from the stack. The emitted results are then joined into a
single array and sent back to CouchDB.
.UNINDENT
.sp
Now let’s see how \fIreduce\fP functions are handled:
.INDENT 0.0
.IP 1. 3
CouchDB sends \fIas a single command\fP the list of available \fIreduce\fP
functions with the result list of key\-value pairs that were previously
returned from the \fImap\fP functions.
.IP 2. 3
the Query Server compiles the reduce functions and applies them to the
key\-value lists. The reduced result is sent back to CouchDB.
.UNINDENT
.sp
As you may note, \fIreduce\fP functions are applied in a single shot to the map
results while \fImap\fP functions are applied to documents one by one. This
means that it’s possible for \fImap\fP functions to precompile CommonJS
libraries and use them during the entire view processing, but for \fIreduce\fP
functions they would be compiled again and again for each view result
reduction, which would lead to performance degradation.
.UNINDENT
.UNINDENT
.SS Show Functions
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
Show functions are deprecated in CouchDB 3.0, and will be removed in CouchDB 4.0.
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B showfun(doc, req)
.INDENT 7.0
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
\fBdoc\fP – The document that is being processed; may be omitted.
.IP \(bu 2
\fBreq\fP – \fI\%Request object\fP\&.
.UNINDENT
.TP
.B Returns
\fI\%Response object\fP
.TP
.B Return type
object or string
.UNINDENT
.UNINDENT
.sp
Show functions are used to represent documents in various formats, commonly as
HTML pages with nice formatting. They can also be used to run server\-side
functions without requiring a pre\-existing document.
.sp
Basic example of show function could be:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc, req){
    if (doc) {
        return \(dqHello from \(dq + doc._id + \(dq!\(dq;
    } else {
        return \(dqHello, world!\(dq;
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Also, there is more simple way to return json encoded data:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc, req){
    return {
        \(aqjson\(aq: {
            \(aqid\(aq: doc[\(aq_id\(aq],
            \(aqrev\(aq: doc[\(aq_rev\(aq]
        }
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
and even files (this one is CouchDB logo):
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc, req){
    return {
        \(aqheaders\(aq: {
            \(aqContent\-Type\(aq : \(aqimage/png\(aq,
        },
        \(aqbase64\(aq: \(aq\(aq.concat(
            \(aqiVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAsV\(aq,
            \(aqBMVEUAAAD////////////////////////5ur3rEBn////////////////wDBL/\(aq,
            \(aqAADuBAe9EB3IEBz/7+//X1/qBQn2AgP/f3/ilpzsDxfpChDtDhXeCA76AQH/v7\(aq,
            \(aq/84eLyWV/uc3bJPEf/Dw/uw8bRWmP1h4zxSlD6YGHuQ0f6g4XyQkXvCA36MDH6\(aq,
            \(aqwMH/z8/yAwX64ODeh47BHiv/Ly/20dLQLTj98PDXWmP/Pz//39/wGyJ7Iy9JAA\(aq,
            \(aqAADHRSTlMAbw8vf08/bz+Pv19jK/W3AAAAg0lEQVR4Xp3LRQ4DQRBD0QqTm4Y5\(aq,
            \(aqzMxw/4OleiJlHeUtv2X6RbNO1Uqj9g0RMCuQO0vBIg4vMFeOpCWIWmDOw82fZx\(aq,
            \(aqvaND1c8OG4vrdOqD8YwgpDYDxRgkSm5rwu0nQVBJuMg++pLXZyr5jnc1BaH4GT\(aq,
            \(aqLvEliY253nA3pVhQqdPt0f/erJkMGMB8xucAAAAASUVORK5CYII=\(aq)
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
But what if you need to represent data in different formats via a single
function? Functions \fI\%registerType()\fP and \fI\%provides()\fP are your the best
friends in that question:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc, req){
    provides(\(aqjson\(aq, function(){
        return {\(aqjson\(aq: doc}
    });
    provides(\(aqhtml\(aq, function(){
        return \(aq<pre>\(aq + toJSON(doc) + \(aq</pre>\(aq
    })
    provides(\(aqxml\(aq, function(){
        return {
            \(aqheaders\(aq: {\(aqContent\-Type\(aq: \(aqapplication/xml\(aq},
            \(aqbody\(aq : \(aq\(aq.concat(
                \(aq<?xml version=\(dq1.0\(dq encoding=\(dqutf\-8\(dq?>\en\(aq,
                \(aq<doc>\(aq,
                (function(){
                    escape = function(s){
                        return s.replace(/&quot;/g, \(aq\(dq\(aq)
                                .replace(/&gt;/g, \(aq>\(aq)
                                .replace(/&lt;/g, \(aq<\(aq)
                                .replace(/&amp;/g, \(aq&\(aq);
                    };
                    var content = \(aq\(aq;
                    for(var key in doc){
                        if(!doc.hasOwnProperty(key)) continue;
                        var value = escape(toJSON(doc[key]));
                        var key = escape(key);
                        content += \(aq\(aq.concat(
                            \(aq<\(aq + key + \(aq>\(aq,
                            value
                            \(aq</\(aq + key + \(aq>\(aq
                        )
                    }
                    return content;
                })(),
                \(aq</doc>\(aq
            )
        }
    })
    registerType(\(aqtext\-json\(aq, \(aqtext/json\(aq)
    provides(\(aqtext\-json\(aq, function(){
        return toJSON(doc);
    })
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This function may return \fIhtml\fP, \fIjson\fP , \fIxml\fP or our custom \fItext json\fP format
representation of same document object with same processing rules. Probably,
the \fIxml\fP provider in our function needs more care to handle nested objects
correctly, and keys with invalid characters, but you’ve got the idea!
.sp
\fBSEE ALSO:\fP
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.TP
.B CouchDB Guide:
.INDENT 7.0
.IP \(bu 2
\fI\%Show Functions\fP
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS List Functions
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
List functions are deprecated in CouchDB 3.0, and will be removed in CouchDB 4.0.
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B listfun(head, req)
.INDENT 7.0
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
\fBhead\fP – \fI\%View Head Information\fP
.IP \(bu 2
\fBreq\fP – \fI\%Request object\fP\&.
.UNINDENT
.TP
.B Returns
Last chunk.
.TP
.B Return type
string
.UNINDENT
.UNINDENT
.sp
While \fI\%Show Functions\fP are used to customize document presentation, \fI\%List Functions\fP
are used for the same purpose, but on \fI\%View Functions\fP results.
.sp
The following list function formats the view and represents it as a very simple
HTML page:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(head, req){
    start({
        \(aqheaders\(aq: {
            \(aqContent\-Type\(aq: \(aqtext/html\(aq
        }
    });
    send(\(aq<html><body><table>\(aq);
    send(\(aq<tr><th>ID</th><th>Key</th><th>Value</th></tr>\(aq);
    while(row = getRow()){
        send(\(aq\(aq.concat(
            \(aq<tr>\(aq,
            \(aq<td>\(aq + toJSON(row.id) + \(aq</td>\(aq,
            \(aq<td>\(aq + toJSON(row.key) + \(aq</td>\(aq,
            \(aq<td>\(aq + toJSON(row.value) + \(aq</td>\(aq,
            \(aq</tr>\(aq
        ));
    }
    send(\(aq</table></body></html>\(aq);
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Templates and styles could obviously be used to present data in a nicer fashion,
but this is an excellent starting point. Note that you may also use
\fI\%registerType()\fP and \fI\%provides()\fP functions in a similar way as for
\fI\%Show Functions\fP! However, note that \fI\%provides()\fP expects the return value to
be a string when used inside a list function, so you’ll need to use
\fI\%start()\fP to set any custom headers and stringify your JSON before
returning it.
.sp
\fBSEE ALSO:\fP
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.TP
.B CouchDB Guide:
.INDENT 7.0
.IP \(bu 2
\fI\%Transforming Views with List Functions\fP
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Update Functions
.INDENT 0.0
.TP
.B updatefun(doc, req)
.INDENT 7.0
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
\fBdoc\fP – The document that is being processed.
.IP \(bu 2
\fBreq\fP – \fI\%Request object\fP
.UNINDENT
.TP
.B Returns
Two\-element array: the first element is the (updated or new)
document, which is committed to the database. If the first element
is \fBnull\fP no document will be committed to the database.
If you are updating an existing document, it should already have an
\fB_id\fP set, and if you are creating a new document, make sure to set its
\fB_id\fP to something, either generated based on the input or the
\fBreq.uuid\fP provided. The second element is the response that will
be sent back to the caller.
.UNINDENT
.UNINDENT
.sp
Update handlers are functions that clients can request to invoke server\-side
logic that will create or update a document. This feature allows a range of use
cases such as providing a server\-side last modified timestamp, updating
individual fields in a document without first getting the latest revision, etc.
.sp
When the request to an update handler includes a document ID in the URL, the
server will provide the function with the most recent version of that document.
You can provide any other values needed by the update handler function via the
\fBPOST\fP/\fBPUT\fP entity body or query string parameters of the request.
.sp
A basic example that demonstrates all use\-cases of update handlers:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc, req){
    if (!doc){
        if (\(aqid\(aq in req && req[\(aqid\(aq]){
            // create new document
            return [{\(aq_id\(aq: req[\(aqid\(aq]}, \(aqNew World\(aq]
        }
        // change nothing in database
        return [null, \(aqEmpty World\(aq]
    }
    doc[\(aqworld\(aq] = \(aqhello\(aq;
    doc[\(aqedited_by\(aq] = req[\(aquserCtx\(aq][\(aqname\(aq]
    return [doc, \(aqEdited World!\(aq]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Filter Functions
.INDENT 0.0
.TP
.B filterfun(doc, req)
.INDENT 7.0
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
\fBdoc\fP – The document that is being processed
.IP \(bu 2
\fBreq\fP – \fI\%Request object\fP
.UNINDENT
.TP
.B Returns
Boolean value: \fBtrue\fP means that \fIdoc\fP passes the filter rules,
\fBfalse\fP means that it does not.
.UNINDENT
.UNINDENT
.sp
Filter functions mostly act like \fI\%Show Functions\fP and \fI\%List Functions\fP: they
format, or \fIfilter\fP the \fI\%changes feed\fP\&.
.SS Classic Filters
.sp
By default the changes feed emits all database documents changes. But if you’re
waiting for some special changes, processing all documents is inefficient.
.sp
Filters are special design document functions that allow the changes feed to
emit only specific documents that pass filter rules.
.sp
Let’s assume that our database is a mailbox and we need to handle only new mail
events (documents with the status \fInew\fP). Our filter function would look like
this:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc, req){
    // we need only \(gamail\(ga documents
    if (doc.type != \(aqmail\(aq){
        return false;
    }
    // we\(aqre interested only in \(ganew\(ga ones
    if (doc.status != \(aqnew\(aq){
        return false;
    }
    return true; // passed!
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Filter functions must return \fBtrue\fP if a document passed all the rules.  Now,
if you apply this function to the changes feed it will emit only changes about
“new mails”:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /somedatabase/_changes?filter=mailbox/new_mail HTTP/1.1
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqresults\(dq:[
{\(dqseq\(dq:\(dq1\-g1AAAAF9eJzLYWBg4MhgTmHgz8tPSTV0MDQy1zMAQsMcoARTIkOS_P___7MymBMZc4EC7MmJKSmJqWaYynEakaQAJJPsoaYwgE1JM0o1TjQ3T2HgLM1LSU3LzEtNwa3fAaQ_HqQ_kQG3qgSQqnoCqvJYgCRDA5ACKpxPWOUCiMr9hFUegKi8T1jlA4hKkDuzAC2yZRo\(dq,\(dqid\(dq:\(dqdf8eca9da37dade42ee4d7aa3401f1dd\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-c2e0085a21d34fa1cecb6dc26a4ae657\(dq}]},
{\(dqseq\(dq:\(dq9\-g1AAAAIreJyVkEsKwjAURUMrqCOXoCuQ5MU0OrI70XyppcaRY92J7kR3ojupaSPUUgqWwAu85By4t0AITbJYo5k7aUNSAnyJ_SGFf4gEkvOyLPMsFtHRL8ZKaC1M0v3eq5ALP\-X2a0G1xYKhgnONpmenjT04o_v5tOJ3LV5itTES_uP3FX9ppcAACaVsQAo38hNd_eVFt8ZklVljPqSPYLoH06PJhG0Cxq7\-yhQcz\-B4_fQCjFuqBjjewVF3E9cORoExSrpU_gHBTo5m\(dq,\(dqid\(dq:\(dqdf8eca9da37dade42ee4d7aa34024714\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-29d748a6e87b43db967fe338bcb08d74\(dq}]},
],
\(dqlast_seq\(dq:\(dq10\-g1AAAAIreJyVkEsKwjAURR9tQR25BF2B5GMaHdmdaNIk1FLjyLHuRHeiO9Gd1LQRaimFlsALvOQcuLcAgGkWKpjbs9I4wYSvkDu4cA\-BALkoyzLPQhGc3GKSCqWEjrvfexVy6abc_SxQWwzRVHCuYHaxSpuj1aqfTyp\-3\-IlSrdakmH8oeKvrRSIkJhSNiKFjdyEm7uc6N6YTKo3iI_pw5se3vRsMiETE23WgzJ5x8s73n\-9EMYNTUc4Pt5RdxPVDkYJYxR3qfwLwW6OZw\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Note that the value of \fBlast_seq\fP is \fI10\-..\fP, but we received only two records.
Seems like any other changes were for documents that haven’t passed our filter.
.sp
We probably need to filter the changes feed of our mailbox by more than a single
status value. We’re also interested in statuses like “spam” to update
spam\-filter heuristic rules, “outgoing” to let a mail daemon actually send
mails, and so on. Creating a lot of similar functions that actually do similar
work isn’t good idea \- so we need a dynamic filter.
.sp
You may have noticed that filter functions take a second argument named
\fI\%request\fP\&. This allows the creation of dynamic filters
based on query parameters, \fI\%user context\fP and more.
.sp
The dynamic version of our filter looks like this:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc, req){
    // we need only \(gamail\(ga documents
    if (doc.type != \(aqmail\(aq){
        return false;
    }
    // we\(aqre interested only in requested status
    if (doc.status != req.query.status){
        return false;
    }
    return true; // passed!
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
and now we have passed the \fIstatus\fP query parameter in the request to let our
filter match only the required documents:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /somedatabase/_changes?filter=mailbox/by_status&status=new HTTP/1.1
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqresults\(dq:[
{\(dqseq\(dq:\(dq1\-g1AAAAF9eJzLYWBg4MhgTmHgz8tPSTV0MDQy1zMAQsMcoARTIkOS_P___7MymBMZc4EC7MmJKSmJqWaYynEakaQAJJPsoaYwgE1JM0o1TjQ3T2HgLM1LSU3LzEtNwa3fAaQ_HqQ_kQG3qgSQqnoCqvJYgCRDA5ACKpxPWOUCiMr9hFUegKi8T1jlA4hKkDuzAC2yZRo\(dq,\(dqid\(dq:\(dqdf8eca9da37dade42ee4d7aa3401f1dd\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-c2e0085a21d34fa1cecb6dc26a4ae657\(dq}]},
{\(dqseq\(dq:\(dq9\-g1AAAAIreJyVkEsKwjAURUMrqCOXoCuQ5MU0OrI70XyppcaRY92J7kR3ojupaSPUUgqWwAu85By4t0AITbJYo5k7aUNSAnyJ_SGFf4gEkvOyLPMsFtHRL8ZKaC1M0v3eq5ALP\-X2a0G1xYKhgnONpmenjT04o_v5tOJ3LV5itTES_uP3FX9ppcAACaVsQAo38hNd_eVFt8ZklVljPqSPYLoH06PJhG0Cxq7\-yhQcz\-B4_fQCjFuqBjjewVF3E9cORoExSrpU_gHBTo5m\(dq,\(dqid\(dq:\(dqdf8eca9da37dade42ee4d7aa34024714\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-29d748a6e87b43db967fe338bcb08d74\(dq}]},
],
\(dqlast_seq\(dq:\(dq10\-g1AAAAIreJyVkEsKwjAURR9tQR25BF2B5GMaHdmdaNIk1FLjyLHuRHeiO9Gd1LQRaimFlsALvOQcuLcAgGkWKpjbs9I4wYSvkDu4cA\-BALkoyzLPQhGc3GKSCqWEjrvfexVy6abc_SxQWwzRVHCuYHaxSpuj1aqfTyp\-3\-IlSrdakmH8oeKvrRSIkJhSNiKFjdyEm7uc6N6YTKo3iI_pw5se3vRsMiETE23WgzJ5x8s73n\-9EMYNTUc4Pt5RdxPVDkYJYxR3qfwLwW6OZw\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
and we can easily change filter behavior with:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /somedatabase/_changes?filter=mailbox/by_status&status=spam HTTP/1.1
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqresults\(dq:[
{\(dqseq\(dq:\(dq6\-g1AAAAIreJyVkM0JwjAYQD9bQT05gk4gaWIaPdlNNL_UUuPJs26im\-gmuklMjVClFFoCXyDJe_BSAsA4jxVM7VHpJEswWyC_ktJfRBzEzDlX5DGPDv5gJLlSXKfN560KMfdTbL4W\-FgM1oQzpmByskqbvdWqnc8qfvvHCyTXWuBu_K7iz38VCOOUENqjwg79hIvfvOhamQahROoVYn3\-I5huwXSvm5BJsTbLTk3B8QiO58\-_YMoMkT0cr\-BwdRElmFKSNKniDcAcjmM\(dq,\(dqid\(dq:\(dq8960e91220798fc9f9d29d24ed612e0d\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq3\-cc6ff71af716ddc2ba114967025c0ee0\(dq}]},
],
\(dqlast_seq\(dq:\(dq10\-g1AAAAIreJyVkEsKwjAURR9tQR25BF2B5GMaHdmdaNIk1FLjyLHuRHeiO9Gd1LQRaimFlsALvOQcuLcAgGkWKpjbs9I4wYSvkDu4cA\-BALkoyzLPQhGc3GKSCqWEjrvfexVy6abc_SxQWwzRVHCuYHaxSpuj1aqfTyp\-3\-IlSrdakmH8oeKvrRSIkJhSNiKFjdyEm7uc6N6YTKo3iI_pw5se3vRsMiETE23WgzJ5x8s73n\-9EMYNTUc4Pt5RdxPVDkYJYxR3qfwLwW6OZw\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Combining filters with a \fIcontinuous\fP feed allows creating powerful event\-driven
systems.
.SS View Filters
.sp
View filters are the same as classic filters above, with one small difference:
they use the \fImap\fP instead of the \fIfilter\fP function of a view, to filter the
changes feed. Each time a key\-value pair is emitted from the \fImap\fP function, a
change is returned. This allows avoiding filter functions that mostly do the
same work as views.
.sp
To use them just pass \fIfilter=_view\fP and \fIview=designdoc/viewname\fP as request
parameters to the \fI\%changes feed\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /somedatabase/_changes?filter=_view&view=dname/viewname  HTTP/1.1
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Since view filters use \fImap\fP functions as filters, they can’t show any
dynamic behavior since \fI\%request object\fP is not
available.
.UNINDENT
.UNINDENT
.sp
\fBSEE ALSO:\fP
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.TP
.B CouchDB Guide:
.INDENT 7.0
.IP \(bu 2
\fI\%Guide to filter change notification\fP
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Validate Document Update Functions
.INDENT 0.0
.TP
.B validatefun(newDoc, oldDoc, userCtx, secObj)
.INDENT 7.0
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
\fBnewDoc\fP – New version of document that will be stored.
.IP \(bu 2
\fBoldDoc\fP – Previous version of document that is already stored.
.IP \(bu 2
\fBuserCtx\fP – \fI\%User Context Object\fP
.IP \(bu 2
\fBsecObj\fP – \fI\%Security Object\fP
.UNINDENT
.TP
.B Throws
\fBforbidden\fP error to gracefully prevent document storing.
.TP
.B Throws
\fBunauthorized\fP error to prevent storage and allow the user to
re\-auth.
.UNINDENT
.UNINDENT
.sp
A design document may contain a function named \fIvalidate_doc_update\fP
which can be used to prevent invalid or unauthorized document update requests
from being stored.  The function is passed the new document from the update
request, the current document stored in the database, a \fI\%User Context Object\fP
containing information about the user writing the document (if present), and
a \fI\%Security Object\fP with lists of database security roles.
.sp
Validation functions typically examine the structure of the new document to
ensure that required fields are present and to verify that the requesting user
should be allowed to make changes to the document properties.  For example,
an application may require that a user must be authenticated in order to create
a new document or that specific document fields be present when a document
is updated. The validation function can abort the pending document write
by throwing one of two error objects:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
// user is not authorized to make the change but may re\-authenticate
throw({ unauthorized: \(aqError message here.\(aq });

// change is not allowed
throw({ forbidden: \(aqError message here.\(aq });
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Document validation is optional, and each design document in the database may
have at most one validation function.  When a write request is received for
a given database, the validation function in each design document in that
database is called in an unspecified order.  If any of the validation functions
throw an error, the write will not succeed.
.sp
\fBExample\fP: The \fB_design/_auth\fP ddoc from \fI_users\fP database uses a validation
function to ensure that documents contain some required fields and are only
modified by a user with the \fB_admin\fP role:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(newDoc, oldDoc, userCtx, secObj) {
    if (newDoc._deleted === true) {
        // allow deletes by admins and matching users
        // without checking the other fields
        if ((userCtx.roles.indexOf(\(aq_admin\(aq) !== \-1) ||
            (userCtx.name == oldDoc.name)) {
            return;
        } else {
            throw({forbidden: \(aqOnly admins may delete other user docs.\(aq});
        }
    }

    if ((oldDoc && oldDoc.type !== \(aquser\(aq) || newDoc.type !== \(aquser\(aq) {
        throw({forbidden : \(aqdoc.type must be user\(aq});
    } // we only allow user docs for now

    if (!newDoc.name) {
        throw({forbidden: \(aqdoc.name is required\(aq});
    }

    if (!newDoc.roles) {
        throw({forbidden: \(aqdoc.roles must exist\(aq});
    }

    if (!isArray(newDoc.roles)) {
        throw({forbidden: \(aqdoc.roles must be an array\(aq});
    }

    if (newDoc._id !== (\(aqorg.couchdb.user:\(aq + newDoc.name)) {
        throw({
            forbidden: \(aqDoc ID must be of the form org.couchdb.user:name\(aq
        });
    }

    if (oldDoc) { // validate all updates
        if (oldDoc.name !== newDoc.name) {
            throw({forbidden: \(aqUsernames can not be changed.\(aq});
        }
    }

    if (newDoc.password_sha && !newDoc.salt) {
        throw({
            forbidden: \(aqUsers with password_sha must have a salt.\(aq +
                \(aqSee /_utils/script/couch.js for example code.\(aq
        });
    }

    var is_server_or_database_admin = function(userCtx, secObj) {
        // see if the user is a server admin
        if(userCtx.roles.indexOf(\(aq_admin\(aq) !== \-1) {
            return true; // a server admin
        }

        // see if the user a database admin specified by name
        if(secObj && secObj.admins && secObj.admins.names) {
            if(secObj.admins.names.indexOf(userCtx.name) !== \-1) {
                return true; // database admin
            }
        }

        // see if the user a database admin specified by role
        if(secObj && secObj.admins && secObj.admins.roles) {
            var db_roles = secObj.admins.roles;
            for(var idx = 0; idx < userCtx.roles.length; idx++) {
                var user_role = userCtx.roles[idx];
                if(db_roles.indexOf(user_role) !== \-1) {
                    return true; // role matches!
                }
            }
        }

        return false; // default to no admin
    }

    if (!is_server_or_database_admin(userCtx, secObj)) {
        if (oldDoc) { // validate non\-admin updates
            if (userCtx.name !== newDoc.name) {
                throw({
                    forbidden: \(aqYou may only update your own user document.\(aq
                });
            }
            // validate role updates
            var oldRoles = oldDoc.roles.sort();
            var newRoles = newDoc.roles.sort();

            if (oldRoles.length !== newRoles.length) {
                throw({forbidden: \(aqOnly _admin may edit roles\(aq});
            }

            for (var i = 0; i < oldRoles.length; i++) {
                if (oldRoles[i] !== newRoles[i]) {
                    throw({forbidden: \(aqOnly _admin may edit roles\(aq});
                }
            }
        } else if (newDoc.roles.length > 0) {
            throw({forbidden: \(aqOnly _admin may set roles\(aq});
        }
    }

    // no system roles in users db
    for (var i = 0; i < newDoc.roles.length; i++) {
        if (newDoc.roles[i][0] === \(aq_\(aq) {
            throw({
                forbidden:
                \(aqNo system roles (starting with underscore) in users db.\(aq
            });
        }
    }

    // no system names as names
    if (newDoc.name[0] === \(aq_\(aq) {
        throw({forbidden: \(aqUsername may not start with underscore.\(aq});
    }

    var badUserNameChars = [\(aq:\(aq];

    for (var i = 0; i < badUserNameChars.length; i++) {
        if (newDoc.name.indexOf(badUserNameChars[i]) >= 0) {
            throw({forbidden: \(aqCharacter \(ga\(aq + badUserNameChars[i] +
                    \(aq\(ga is not allowed in usernames.\(aq});
        }
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
The \fBreturn\fP statement is used only for function, it has no impact on
the validation process.
.UNINDENT
.UNINDENT
.sp
\fBSEE ALSO:\fP
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.TP
.B CouchDB Guide:
.INDENT 7.0
.IP \(bu 2
\fI\%Validation Functions\fP
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Guide to Views
.sp
Views are the primary tool used for querying and reporting on CouchDB documents.
There you’ll learn how they work and how to use them to build effective
applications with CouchDB.
.SS Introduction to Views
.sp
Views are useful for many purposes:
.INDENT 0.0
.IP \(bu 2
Filtering the documents in your database to find those relevant to a
particular process.
.IP \(bu 2
Extracting data from your documents and presenting it in a specific order.
.IP \(bu 2
Building efficient indexes to find documents by any value or structure that
resides in them.
.IP \(bu 2
Use these indexes to represent relationships among documents.
.IP \(bu 2
Finally, with views you can make all sorts of calculations on the data in your
documents. For example, if documents represent your company’s financial
transactions, a view can answer the question of what the spending was in the
last week, month, or year.
.UNINDENT
.SS What Is a View?
.sp
Let’s go through the different use cases. First is extracting data that you
might need for a special purpose in a specific order. For a front page, we want
a list of blog post titles sorted by date. We’ll work with a set of example
documents as we walk through how views work:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq:\(dqbiking\(dq,
    \(dq_rev\(dq:\(dqAE19EBC7654\(dq,

    \(dqtitle\(dq:\(dqBiking\(dq,
    \(dqbody\(dq:\(dqMy biggest hobby is mountainbiking. The other day...\(dq,
    \(dqdate\(dq:\(dq2009/01/30 18:04:11\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq:\(dqbought\-a\-cat\(dq,
    \(dq_rev\(dq:\(dq4A3BBEE711\(dq,

    \(dqtitle\(dq:\(dqBought a Cat\(dq,
    \(dqbody\(dq:\(dqI went to the the pet store earlier and brought home a little kitty...\(dq,
    \(dqdate\(dq:\(dq2009/02/17 21:13:39\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq:\(dqhello\-world\(dq,
    \(dq_rev\(dq:\(dq43FBA4E7AB\(dq,

    \(dqtitle\(dq:\(dqHello World\(dq,
    \(dqbody\(dq:\(dqWell hello and welcome to my new blog...\(dq,
    \(dqdate\(dq:\(dq2009/01/15 15:52:20\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Three will do for the example. Note that the documents are sorted by “_id”,
which is how they are stored in the database. Now we define a view.
Bear with us without an explanation while we show you some code:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    if(doc.date && doc.title) {
        emit(doc.date, doc.title);
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This is a \fImap function\fP, and it is written in JavaScript. If you are not
familiar with JavaScript but have used C or any other C\-like language such as
Java, PHP, or C#, this should look familiar. It is a simple function definition.
.sp
You provide CouchDB with view functions as strings stored inside the \fBviews\fP
field of a design document. To create this view you can use this command:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X PUT http://admin:password@127.0.0.1:5984/db/_design/my_ddoc
     \-d \(aq{\(dqviews\(dq:{\(dqmy_filter\(dq:{\(dqmap\(dq:
         \(dqfunction(doc) { if(doc.date && doc.title) { emit(doc.date, doc.title); }}\(dq}}}\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You don’t run the JavaScript function yourself. Instead, when you
\fIquery your view\fP, CouchDB takes the source code and runs it for you on every
document in the database your view was defined in. You \fIquery your view\fP to
retrieve the \fIview result\fP using the following command:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X GET http://admin:password@127.0.0.1:5984/db/_design/my_ddoc/_view/my_filter
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
All map functions have a single parameter doc. This is a single document in
the database. Our map function checks whether our document has a \fBdate\fP and
a \fBtitle\fP attribute — luckily, all of our documents have them — and then calls
the built\-in \fI\%emit()\fP function with these two attributes as arguments.
.sp
The \fI\%emit()\fP function always takes two arguments: the first is \fBkey\fP,
and the second is \fBvalue\fP\&. The \fBemit(key, value)\fP function creates an entry
in our \fIview result\fP\&. One more thing: the \fBemit()\fP function can be called
multiple times in the map function to create multiple entries in the view
results from a single document, but we are not doing that yet.
.sp
CouchDB takes whatever you pass into the emit() function and puts it into a list
(see Table 1, “View results” below). Each row in that list includes the \fIkey\fP
and \fIvalue\fP\&. More importantly, the list is sorted by key (by \fBdoc.date\fP
in our case).  The most important feature of a view result is that it is sorted
by \fIkey\fP\&. We will come back to that over and over again to do neat things. Stay
tuned.
.sp
Table 1. View results:
.TS
center;
|l|l|.
_
T{
Key
T}	T{
Value
T}
_
T{
“2009/01/15 15:52:20”
T}	T{
“Hello World”
T}
_
T{
“2009/01/30 18:04:11”
T}	T{
“Biking”
T}
_
T{
“2009/02/17 21:13:39”
T}	T{
“Bought a Cat”
T}
_
.TE
.sp
When you query your view, CouchDB takes the source code and runs it for you on
every document in the database. If you have a lot of documents, that takes
quite a bit of time and you might wonder if it is not horribly inefficient
to do this. Yes, it would be, but CouchDB is designed to avoid any extra costs:
it only runs through all documents once, when you first query your view.
If a document is changed, the map function is only run once, to recompute
the keys and values for that single document.
.sp
The view result is stored in a B\-tree, just like the structure that is
responsible for holding your documents. View B\-trees are stored in their
own file, so that for high\-performance CouchDB usage, you can keep views on
their own disk. The B\-tree provides very fast lookups of rows by key, as well
as efficient streaming of rows in a key range. In our example, a single view
can answer all questions that involve time: “Give me all the blog posts from
last week” or “last month” or “this year.” Pretty neat.
.sp
When we query our view, we get back a list of all documents sorted by date.
Each row also includes the post title so we can construct links to posts.
Table 1 is just a graphical representation of the view result.
The actual result is JSON\-encoded and contains a little more metadata:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqtotal_rows\(dq: 3,
    \(dqoffset\(dq: 0,
    \(dqrows\(dq: [
        {
            \(dqkey\(dq: \(dq2009/01/15 15:52:20\(dq,
            \(dqid\(dq: \(dqhello\-world\(dq,
            \(dqvalue\(dq: \(dqHello World\(dq
        },

        {
            \(dqkey\(dq: \(dq2009/01/30 18:04:11\(dq,
            \(dqid\(dq: \(dqbiking\(dq,
            \(dqvalue\(dq: \(dqBiking\(dq
        },

        {
            \(dqkey\(dq: \(dq2009/02/17 21:13:39\(dq,
            \(dqid\(dq: \(dqbought\-a\-cat\(dq,
            \(dqvalue\(dq: \(dqBought a Cat\(dq
        }

    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Now, the actual result is not as nicely formatted and doesn’t include any
superfluous whitespace or newlines, but this is better for you (and us!)
to read and understand. Where does that “id” member in the result rows come
from? That wasn’t there before. That’s because we omitted it earlier to avoid
confusion. CouchDB automatically includes the document ID of the document that
created the entry in the view result. We’ll use this as well when constructing
links to the blog post pages.
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
Do not emit the entire document as the value of your \fBemit(key, value)\fP
statement unless you’re sure you know you want it. This stores an entire
additional copy of your document in the view’s secondary index. Views with
\fBemit(key, doc)\fP take longer to update, longer to write to disk, and
consume significantly more disk space. The only advantage is that they
are faster to query than using the \fB?include_docs=true\fP parameter when
querying a view.
.sp
Consider the trade\-offs before emitting the entire document. Often it is
sufficient to emit only a portion of the document, or just a single key /
value pair, in your views.
.UNINDENT
.UNINDENT
.SS Efficient Lookups
.sp
Let’s move on to the second use case for views: “building efficient indexes to
find documents by any value or structure that resides in them.” We already
explained the efficient indexing, but we skipped a few details. This is a good
time to finish this discussion as we are looking at map functions that are a
little more complex.
.sp
First, back to the B\-trees! We explained that the B\-tree that backs the
key\-sorted view result is built only once, when you first query a view,
and all subsequent queries will just read the B\-tree instead of executing
the map function for all documents again. What happens, though, when you change
a document, add a new one, or delete one? Easy: CouchDB is smart enough
to find the rows in the view result that were created by a specific document.
It marks them invalid so that they no longer show up in view results.
If the document was deleted, we’re good — the resulting B\-tree reflects the
state of the database. If a document got updated, the new document is run
through the map function and the resulting new lines are inserted into
the B\-tree at the correct spots. New documents are handled in the same way.
The B\-tree is a very efficient data structure for our needs, and the crash\-only
design of CouchDB databases is carried over to the view indexes as well.
.sp
To add one more point to the efficiency discussion: usually multiple documents
are updated between view queries. The mechanism explained in the previous
paragraph gets applied to all changes in the database since the last time
the view was queried in a batch operation, which makes things even faster and
is generally a better use of your resources.
.SS Find One
.sp
On to more complex map functions. We said “find documents by any value or
structure that resides in them.” We already explained how to extract a value
by which to sort a list of views (our date field). The same mechanism is used
for fast lookups. The URI to query to get a view’s result is
\fB/database/_design/designdocname/_view/viewname\fP\&. This gives you a list of all
rows in the view. We have only three documents, so things are small, but with
thousands of documents, this can get long. You can add view parameters to the
URI to constrain the result set. Say we know the date of a blog post.
To find a single document, we would use
\fB/blog/_design/docs/_view/by_date?key=\(dq2009/01/30 18:04:11\(dq\fP
to get the “Biking” blog post. Remember that you can place whatever you like
in the key parameter to the emit() function. Whatever you put in there, we can
now use to look up exactly — and fast.
.sp
Note that in the case where multiple rows have the same key (perhaps we design
a view where the key is the name of the post’s author), key queries can return
more than one row.
.SS Find Many
.sp
We talked about “getting all posts for last month.” If it’s February now,
this is as easy as:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
/blog/_design/docs/_view/by_date?startkey=\(dq2010/01/01 00:00:00\(dq&endkey=\(dq2010/02/00 00:00:00\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The \fBstartkey\fP and \fBendkey\fP parameters specify an inclusive range on which
we can search.
.sp
To make things a little nicer and to prepare for a future example, we are going
to change the format of our date field. Instead of a string, we are going to use
an array, where individual members are part of a timestamp in decreasing
significance. This sounds fancy, but it is rather easy. Instead of:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqdate\(dq: \(dq2009/01/31 00:00:00\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
we use:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqdate\(dq: [2009, 1, 31, 0, 0, 0]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Our map function does not have to change for this, but our view result looks
a little different:
.sp
Table 2. New view results:
.TS
center;
|l|l|.
_
T{
Key
T}	T{
Value
T}
_
T{
[2009, 1, 15, 15, 52, 20]
T}	T{
“Hello World”
T}
_
T{
[2009, 2, 17, 21, 13, 39]
T}	T{
“Biking”
T}
_
T{
[2009, 1, 30, 18, 4, 11]
T}	T{
“Bought a Cat”
T}
_
.TE
.sp
And our queries change to:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
/blog/_design/docs/_view/by_date?startkey=[2010, 1, 1, 0, 0, 0]&endkey=[2010, 2, 1, 0, 0, 0]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
For all you care, this is just a change in syntax, not meaning. But it shows
you the power of views. Not only can you construct an index with scalar values
like strings and integers, you can also use JSON structures as keys for your
views. Say we tag our documents with a list of tags and want to see all tags,
but we don’t care for documents that have not been tagged.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    ...
    tags: [\(dqcool\(dq, \(dqfreak\(dq, \(dqplankton\(dq],
    ...
}
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    ...
    tags: [],
    ...
}
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    if(doc.tags.length > 0) {
        for(var idx in doc.tags) {
            emit(doc.tags[idx], null);
        }
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This shows a few new things. You can have conditions on structure
(\fBif(doc.tags.length > 0)\fP) instead of just values. This is also an example of
how a map function calls \fI\%emit()\fP multiple times per document.
And finally, you can pass null instead of a value to the value parameter.
The same is true for the key parameter. We’ll see in a bit how that is useful.
.SS Reversed Results
.sp
To retrieve view results in reverse order, use the \fBdescending=true\fP query
parameter. If you are using a \fBstartkey\fP parameter, you will find that CouchDB
returns different rows or no rows at all. What’s up with that?
.sp
It’s pretty easy to understand when you see how view query options work under
the hood. A view is stored in a tree structure for fast lookups. Whenever you
query a view, this is how CouchDB operates:
.INDENT 0.0
.IP 1. 3
Starts reading at the top, or at the position that \fBstartkey\fP specifies,
if present.
.IP 2. 3
Returns one row at a time until the end or until it hits \fBendkey\fP,
if present.
.UNINDENT
.sp
If you specify \fBdescending=true\fP, the reading direction is reversed,
not the sort  order of the rows in the view. In addition, the same two\-step
procedure is followed.
.sp
Say you have a view result that looks like this:
.TS
center;
|l|l|.
_
T{
Key
T}	T{
Value
T}
_
T{
0
T}	T{
“foo”
T}
_
T{
1
T}	T{
“bar”
T}
_
T{
2
T}	T{
“baz”
T}
_
.TE
.sp
Here are potential query options: \fB?startkey=1&descending=true\fP\&. What will
CouchDB do? See #1 above: it jumps to \fBstartkey\fP, which is the row with the
key \fB1\fP, and starts reading backward until it hits the end of the view.
So the particular result would be:
.TS
center;
|l|l|.
_
T{
Key
T}	T{
Value
T}
_
T{
1
T}	T{
“bar”
T}
_
T{
0
T}	T{
“foo”
T}
_
.TE
.sp
This is very likely not what you want. To get the rows with the indexes \fB1\fP
and \fB2\fP in reverse order, you need to switch the \fBstartkey\fP to \fBendkey\fP:
\fBendkey=1&descending=true\fP:
.TS
center;
|l|l|.
_
T{
Key
T}	T{
Value
T}
_
T{
2
T}	T{
“baz”
T}
_
T{
1
T}	T{
“bar”
T}
_
.TE
.sp
Now that looks a lot better. CouchDB started reading at the bottom of the view
and went backward until it hit \fBendkey\fP\&.
.SS The View to Get Comments for Posts
.sp
We use an array key here to support the \fBgroup_level\fP reduce query parameter.
CouchDB’s views are stored in the B\-tree file structure. Because of the way
B\-trees are structured, we can cache the intermediate reduce results in the
non\-leaf nodes of the tree, so reduce queries can be computed along arbitrary
key ranges in logarithmic time. See Figure 1, “Comments map function”.
.sp
In the blog app, we use \fBgroup_level\fP reduce queries to compute the count of
comments both on a per\-post and total basis, achieved by querying the same view
index with different methods. With some array keys, and assuming each key has
the value \fB1\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[\(dqa\(dq,\(dqb\(dq,\(dqc\(dq]
[\(dqa\(dq,\(dqb\(dq,\(dqe\(dq]
[\(dqa\(dq,\(dqc\(dq,\(dqm\(dq]
[\(dqb\(dq,\(dqa\(dq,\(dqc\(dq]
[\(dqb\(dq,\(dqa\(dq,\(dqg\(dq]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
the reduce view:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(keys, values, rereduce) {
    return sum(values)
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
or:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
_sum
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
which is a built\-in CouchDB reduce function (the others are \fB_count\fP and
\fB_stats\fP). \fB_sum\fP here returns the total number of rows between the start
and end key. So with \fBstartkey=[\(dqa\(dq,\(dqb\(dq]&endkey=[\(dqb\(dq]\fP (which includes the
first three of the above keys) the result would equal \fB3\fP\&. The effect is to
count rows.  If you’d like to count rows without depending on the row value,
you can switch on the \fBrereduce\fP parameter:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(keys, values, rereduce) {
    if (rereduce) {
        return sum(values);
    } else {
        return values.length;
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
The JavaScript function above could be effectively replaced by the built\-in
\fB_count\fP\&.
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 2.5
[image: Comments map function]
[image]
Figure 1. Comments map function.UNINDENT
.UNINDENT
.sp
This is the reduce view used by the example app to count comments, while
utilizing the map to output the comments, which are more useful than just
\fB1\fP over and over. It pays to spend some time playing around with map and
reduce functions. Fauxton is OK for this, but it doesn’t give full access to
all the query parameters. Writing your own test code for views in your language
of choice is a great way to explore the nuances and capabilities of CouchDB’s
incremental MapReduce system.
.sp
Anyway, with a \fBgroup_level\fP query, you’re basically running a series of
reduce range queries: one for each group that shows up at the level you query.
Let’s reprint the key list from earlier, grouped at level \fB1\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[\(dqa\(dq]   3
[\(dqb\(dq]   2
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
And at \fBgroup_level=2\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[\(dqa\(dq,\(dqb\(dq]   2
[\(dqa\(dq,\(dqc\(dq]   1
[\(dqb\(dq,\(dqa\(dq]   2
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Using the parameter \fBgroup=true\fP makes it behave as though it were
\fBgroup_level=999\fP, so in the case of our current example, it would give the
number \fB1\fP for each key, as there are no exactly duplicated keys.
.SS Reduce/Rereduce
.sp
We briefly talked about the \fBrereduce\fP parameter to the reduce function.
We’ll explain what’s up with it in this section. By now, you should have learned
that your view result is stored in B\-tree index structure for efficiency.
The existence and use of the \fBrereduce\fP parameter is tightly coupled to how
the B\-tree index works.
.sp
Consider the map result are:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\(dqafrikaans\(dq, 1
\(dqafrikaans\(dq, 1
\(dqchinese\(dq, 1
\(dqchinese\(dq, 1
\(dqchinese\(dq, 1
\(dqchinese\(dq, 1
\(dqfrench\(dq, 1
\(dqitalian\(dq, 1
\(dqitalian\(dq, 1
\(dqspanish\(dq, 1
\(dqvietnamese\(dq, 1
\(dqvietnamese\(dq, 1
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Example 1. Example view result (mmm, food)
.sp
When we want to find out how many dishes there are per origin, we can reuse
the simple reduce function shown earlier:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(keys, values, rereduce) {
    return sum(values);
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Figure 2, “The B\-tree index” shows a simplified version of what the B\-tree index
looks like. We abbreviated the key strings.
.INDENT 0.0
.INDENT 2.5
[image: The B-tree index]
[image]
Figure 2. The B\-tree index.UNINDENT
.UNINDENT
.sp
The view result is what computer science grads call a “pre\-order” walk through
the tree. We look at each element in each node starting from the left. Whenever
we see that there is a subnode to descend into, we descend and start reading
the elements in that subnode. When we have walked through the entire tree,
we’re done.
.sp
You can see that CouchDB stores both keys and values inside each leaf node.
In our case, it is simply always \fB1\fP, but you might have a value where you
count other results and then all rows have a different value. What’s important
is that CouchDB runs all elements that are within a node into the reduce
function (setting the \fBrereduce\fP parameter to false) and stores the result
inside the parent node along with the edge to the subnode. In our case, each
edge has a 3 representing the reduce value for the node it points to.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
In reality, nodes have more than 1,600 elements in them. CouchDB computes
the result for all the elements in multiple iterations over the elements in
a single node, not all at once (which would be disastrous for memory
consumption).
.UNINDENT
.UNINDENT
.sp
Now let’s see what happens when we run a query. We want to know how many
“chinese” entries we have. The query option is simple: \fB?key=\(dqchinese\(dq\fP\&.
See Figure 3, “The B\-tree index reduce result”.
.INDENT 0.0
.INDENT 2.5
[image: The B-tree index reduce result]
[image]
Figure 3. The B\-tree index reduce result.UNINDENT
.UNINDENT
.sp
CouchDB detects that all values in the subnode include the “chinese” key.
It concludes that it can take just the 3 values associated with that node to
compute the final result. It then finds the node left to it and sees that it’s
a node with keys outside the requested range (\fBkey=\fP requests a range where
the beginning and the end are the same value). It concludes that it has to use
the “chinese” element’s value and the other node’s value and run them through
the reduce function with the \fBrereduce\fP parameter set to true.
.sp
The reduce function effectively calculates 3 + 1 at query time and returns the
desired result. The next example shows some pseudocode that shows the last
invocation of the reduce function with actual values:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(null, [3, 1], true) {
    return sum([3, 1]);
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Now, we said your reduce function must actually reduce your values. If you see
the B\-tree, it should become obvious what happens when you don’t reduce your
values. Consider the following map result and reduce function. This time we
want to get a list of all the unique labels in our view:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\(dqabc\(dq, \(dqafrikaans\(dq
\(dqcef\(dq, \(dqafrikaans\(dq
\(dqfhi\(dq, \(dqchinese\(dq
\(dqhkl\(dq, \(dqchinese\(dq
\(dqino\(dq, \(dqchinese\(dq
\(dqlqr\(dq, \(dqchinese\(dq
\(dqmtu\(dq, \(dqfrench\(dq
\(dqowx\(dq, \(dqitalian\(dq
\(dqqza\(dq, \(dqitalian\(dq
\(dqtdx\(dq, \(dqspanish\(dq
\(dqxfg\(dq, \(dqvietnamese\(dq
\(dqzul\(dq, \(dqvietnamese\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
We don’t care for the key here and only list all the labels we have. Our reduce
function removes duplicates:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(keys, values, rereduce) {
    var unique_labels = {};
    values.forEach(function(label) {
        if(!unique_labels[label]) {
            unique_labels[label] = true;
        }
    });

    return unique_labels;
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This translates to Figure 4, “An overflowing reduce index”.
.sp
We hope you get the picture. The way the B\-tree storage works means that if you
don’t actually reduce your data in the reduce function, you end up having
CouchDB copy huge amounts of data around that grow linearly, if not faster,
with the number of rows in your view.
.sp
CouchDB will be able to compute the final result, but only for views with a few
rows. Anything larger will experience a ridiculously slow view build time.
To help with that, CouchDB since version 0.10.0 will throw an error if your
reduce function does not reduce its input values.
.INDENT 0.0
.INDENT 2.5
[image: An overflowing reduce index]
[image]
Figure 4. An overflowing reduce index.UNINDENT
.UNINDENT
.SS One vs. Multiple Design Documents
.sp
A common question is: when should I split multiple views into multiple design
documents, or keep them together?
.sp
Each view you create corresponds to one B\-tree. All views in a single design
document will live in the same set of index files on disk (one file per
database shard; in 2.0+ by default, 8 files per node).
.sp
The most practical consideration for separating views into separate documents
is how often you change those views. Views that change often, and are in the
same design document as other views, will invalidate those other views’
indexes when the design document is written, forcing them all to rebuild from
scratch. Obviously you will want to avoid this in production!
.sp
However, when you have multiple views with the same map function in the same
design document, CouchDB will optimize and only calculate that map function
once. This lets you have two views with different \fIreduce\fP functions (say,
one with \fB_sum\fP and one with \fB_stats\fP) but build only a single copy
of the mapped index. It also saves disk space and the time to write multiple
copies to disk.
.sp
Another benefit of having multiple views in the same design document is that
the index files can keep a single index of backwards references from docids
to rows. CouchDB needs these “back refs” to invalidate rows in a view when a
document is deleted (otherwise, a delete would force a total rebuild!)
.sp
One other consideration is that each separate design document will spawn
another (set of) \fBcouchjs\fP processes to generate the view, one per shard.
Depending on the number of cores on your server(s), this may be efficient
(using all of the idle cores you have) or inefficient (overloading the CPU on
your servers). The exact situation will depend on your deployment architecture.
.sp
So, should you use one or multiple design documents? The choice is yours.
.SS Lessons Learned
.INDENT 0.0
.IP \(bu 2
If you don’t use the key field in the map function, you are probably doing it
wrong.
.IP \(bu 2
If you are trying to make a list of values unique in the reduce functions,
you are probably doing it wrong.
.IP \(bu 2
If you don’t reduce your values to a single scalar value or a small
fixed\-sized object or array with a fixed number of scalar values of small
sizes, you are probably doing it wrong.
.UNINDENT
.SS Wrapping Up
.sp
Map functions are side effect–free functions that take a document as argument
and \fIemit\fP key/value pairs. CouchDB stores the emitted rows by constructing a
sorted B\-tree index, so row lookups by key, as well as streaming operations
across a range of rows, can be accomplished in a small memory and processing
footprint, while writes avoid seeks. Generating a view takes \fBO(N)\fP, where
\fBN\fP is the total number of rows in the view. However, querying a view is very
quick, as the B\-tree remains shallow even when it contains many, many keys.
.sp
Reduce functions operate on the sorted rows emitted by map view functions.
CouchDB’s reduce functionality takes advantage of one of the fundamental
properties of B\-tree indexes: for every leaf node (a sorted row), there is a
chain of internal nodes reaching back to the root. Each leaf node in the B\-tree
carries a few rows (on the order of tens, depending on row size), and each
internal node may link to a few leaf nodes or other internal nodes.
.sp
The reduce function is run on every node in the tree in order to calculate
the final reduce value. The end result is a reduce function that can be
incrementally updated upon changes to the map function, while recalculating
the reduction values for a minimum number of nodes. The initial reduction is
calculated once per each node (inner and leaf) in the tree.
.sp
When run on leaf nodes (which contain actual map rows), the reduce function’s
third parameter, \fBrereduce\fP, is false. The arguments in this case are the keys
and values as output by the map function. The function has a single returned
reduction value, which is stored on the inner node that a working set of leaf
nodes have in common, and is used as a cache in future reduce calculations.
.sp
When the reduce function is run on inner nodes, the \fBrereduce\fP flag is
\fBtrue\fP\&. This allows the function to account for the fact that it will be
receiving its own prior output. When \fBrereduce\fP is true, the values passed to
the function are intermediate reduction values as cached from previous
calculations. When the tree is more than two levels deep, the \fIrereduce\fP phase
is repeated, consuming chunks of the previous level’s output until the final
reduce value is calculated at the root node.
.sp
A common mistake new CouchDB users make is attempting to construct complex
aggregate values with a reduce function. Full reductions should result in a
scalar value, like 5, and not, for instance, a JSON hash with a set of unique
keys and the count of each. The problem with this approach is that you’ll end
up with a very large final value. The number of unique keys can be nearly as
large as the number of total keys, even for a large set. It is fine to combine
a few scalar calculations into one reduce function; for instance, to find the
total, average, and standard deviation of a set of numbers in a single function.
.sp
If you’re interested in pushing the edge of CouchDB’s incremental reduce
functionality, have a look at \fI\%Google’s paper on Sawzall\fP, which gives examples
of some of the more exotic reductions that can be accomplished in a system with
similar constraints.
.SS Views Collation
.SS Basics
.sp
View functions specify a key and a value to be returned for each row. CouchDB
collates the view rows by this key. In the following example, the \fBLastName\fP
property serves as the key, thus the result will be sorted by \fBLastName\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    if (doc.Type == \(dqcustomer\(dq) {
        emit(doc.LastName, {FirstName: doc.FirstName, Address: doc.Address});
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB allows arbitrary JSON structures to be used as keys. You can use JSON
arrays as keys for fine\-grained control over sorting and grouping.
.SS Examples
.sp
The following clever trick would return both customer and order documents.
The key is composed of a customer \fB_id\fP and a sorting token. Because the key
for order documents begins with the \fB_id\fP of a customer document, all the
orders will be sorted by customer. Because the sorting token for customers is
lower than the token for orders, the customer document will come before the
associated orders. The values 0 and 1 for the sorting token are arbitrary.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    if (doc.Type == \(dqcustomer\(dq) {
        emit([doc._id, 0], null);
    } else if (doc.Type == \(dqorder\(dq) {
        emit([doc.customer_id, 1], null);
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
To list a specific customer with \fB_id\fP XYZ, and all of that customer’s orders,
limit the startkey and endkey ranges to cover only documents for that customer’s
\fB_id\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
startkey=[\(dqXYZ\(dq]&endkey=[\(dqXYZ\(dq, {}]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
It is not recommended to emit the document itself in the view. Instead, to
include the bodies of the documents when requesting the view, request the view
with \fB?include_docs=true\fP\&.
.SS Sorting by Dates
.sp
It maybe be convenient to store date attributes in a human readable format
(i.e. as a \fIstring\fP), but still sort by date. This can be done by converting
the date to a \fInumber\fP in the \fI\%emit()\fP function. For example, given
a document with a created_at attribute of \fB\(aqWed Jul 23 16:29:21 +0100 2013\(aq\fP,
the following emit function would sort by date:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
emit(Date.parse(doc.created_at).getTime(), null);
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Alternatively, if you use a date format which sorts lexicographically,
such as \fB\(dq2013/06/09 13:52:11 +0000\(dq\fP you can just
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
emit(doc.created_at, null);
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
and avoid the conversion. As a bonus, this date format is compatible with the
JavaScript date parser, so you can use \fBnew Date(doc.created_at)\fP in your
client side JavaScript to make date sorting easy in the browser.
.SS String Ranges
.sp
If you need start and end keys that encompass every string with a given prefix,
it is better to use a high value Unicode character, than to use a \fB\(aqZZZZ\(aq\fP
suffix.
.sp
That is, rather than:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
startkey=\(dqabc\(dq&endkey=\(dqabcZZZZZZZZZ\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You should use:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
startkey=\(dqabc\(dq&endkey=\(dqabc\eufff0\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Collation Specification
.sp
This section is based on the view_collation function in \fI\%view_collation.js\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
// special values sort before all other types
null
false
true

// then numbers
1
2
3.0
4

// then text, case sensitive
\(dqa\(dq
\(dqA\(dq
\(dqaa\(dq
\(dqb\(dq
\(dqB\(dq
\(dqba\(dq
\(dqbb\(dq

// then arrays. compared element by element until different.
// Longer arrays sort after their prefixes
[\(dqa\(dq]
[\(dqb\(dq]
[\(dqb\(dq,\(dqc\(dq]
[\(dqb\(dq,\(dqc\(dq, \(dqa\(dq]
[\(dqb\(dq,\(dqd\(dq]
[\(dqb\(dq,\(dqd\(dq, \(dqe\(dq]

// then object, compares each key value in the list until different.
// larger objects sort after their subset objects.
{a:1}
{a:2}
{b:1}
{b:2}
{b:2, a:1} // Member order does matter for collation.
           // CouchDB preserves member order
           // but doesn\(aqt require that clients will.
           // this test might fail if used with a js engine
           // that doesn\(aqt preserve order
{b:2, c:2}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Comparison of strings is done using \fI\%ICU\fP which implements the
\fI\%Unicode Collation Algorithm\fP, giving a dictionary sorting of keys.
This can give surprising results if you were expecting ASCII ordering.
Note that:
.INDENT 0.0
.IP \(bu 2
All symbols sort before numbers and letters (even the “high” symbols like
tilde, \fB0x7e\fP)
.IP \(bu 2
Differing sequences of letters are compared without regard to case, so
\fBa < aa\fP but also \fBA < aa\fP and \fBa < AA\fP
.IP \(bu 2
Identical sequences of letters are compared with regard to case, with
lowercase before uppercase, so \fBa < A\fP
.UNINDENT
.sp
You can demonstrate the collation sequence for 7\-bit ASCII characters like this:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
require \(aqrubygems\(aq
require \(aqrestclient\(aq
require \(aqjson\(aq

DB=\(dqhttp://127.0.0.1:5984/collator\(dq

RestClient.delete DB rescue nil
RestClient.put \(dq#{DB}\(dq,\(dq\(dq

(32..126).each do |c|
    RestClient.put \(dq#{DB}/#{c.to_s(16)}\(dq, {\(dqx\(dq=>c.chr}.to_json
end

RestClient.put \(dq#{DB}/_design/test\(dq, <<EOS
{
    \(dqviews\(dq:{
        \(dqone\(dq:{
            \(dqmap\(dq:\(dqfunction (doc) { emit(doc.x,null); }\(dq
        }
    }
}
EOS

puts RestClient.get(\(dq#{DB}/_design/test/_view/one\(dq)
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This shows the collation sequence to be:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\(ga ^ _ \- , ; : ! ? . \(aq \(dq ( ) [ ] { } @ * / \e & # % + < = > | ~ $ 0 1 2 3 4 5 6 7 8 9
a A b B c C d D e E f F g G h H i I j J k K l L m M n N o O p P q Q r R s S t T u U v V w W x X y Y z Z
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Key ranges
.sp
Take special care when querying key ranges. For example: the query:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
startkey=\(dqAbc\(dq&endkey=\(dqAbcZZZZ\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
will match “ABC” and “abc1”, but not “abc”. This is because UCA sorts as:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
abc < Abc < ABC < abc1 < AbcZZZZZ
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
For most applications, to avoid problems you should lowercase the \fIstartkey\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
startkey=\(dqabc\(dq&endkey=\(dqabcZZZZZZZZ\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
will match all keys starting with \fB[aA][bB][cC]\fP
.SS Complex keys
.sp
The query \fBstartkey=[\(dqfoo\(dq]&endkey=[\(dqfoo\(dq,{}]\fP will match most array keys
with “foo” in the first element, such as \fB[\(dqfoo\(dq,\(dqbar\(dq]\fP and
\fB[\(dqfoo\(dq,[\(dqbar\(dq,\(dqbaz\(dq]]\fP\&. However it will not match \fB[\(dqfoo\(dq,{\(dqan\(dq:\(dqobject\(dq}]\fP
.SS _all_docs
.sp
The \fI\%_all_docs\fP  view is a special case because it uses
ASCII collation for doc ids, not UCA:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
startkey=\(dq_design/\(dq&endkey=\(dq_design/ZZZZZZZZ\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
will not find \fB_design/abc\fP because \fI‘Z’\fP comes before \fI‘a’\fP in the ASCII
sequence. A better solution is:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
startkey=\(dq_design/\(dq&endkey=\(dq_design0\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Raw collation
.sp
To squeeze a little more performance out of views, you can specify
\fB\(dqoptions\(dq:{\(dqcollation\(dq:\(dqraw\(dq}\fP  within the view definition for native Erlang
collation, especially if you don’t require UCA. This gives a different collation
sequence:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
1
false
null
true
{\(dqa\(dq:\(dqa\(dq},
[\(dqa\(dq]
\(dqa\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Beware that \fB{}\fP is no longer a suitable “high” key sentinel value. Use a
string like \fB\(dq\eufff0\(dq\fP instead.
.SS Joins With Views
.SS Linked Documents
.sp
If your \fI\%map function\fP emits an object value which has
\fB{\(aq_id\(aq: XXX}\fP and you \fI\%query view\fP with
\fBinclude_docs=true\fP parameter, then CouchDB will fetch the document with id
\fBXXX\fP rather than the document which was processed to emit the key/value pair.
.sp
This means that if one document contains the ids of other documents, it can
cause those documents to be fetched in the view too, adjacent to the same key
if required.
.sp
For example, if you have the following hierarchically\-linked documents:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    { \(dq_id\(dq: \(dq11111\(dq },
    { \(dq_id\(dq: \(dq22222\(dq, \(dqancestors\(dq: [\(dq11111\(dq], \(dqvalue\(dq: \(dqhello\(dq },
    { \(dq_id\(dq: \(dq33333\(dq, \(dqancestors\(dq: [\(dq22222\(dq,\(dq11111\(dq], \(dqvalue\(dq: \(dqworld\(dq }
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You can emit the values with the ancestor documents adjacent to them in the view
like this:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    if (doc.value) {
        emit([doc.value, 0], null);
        if (doc.ancestors) {
            for (var i in doc.ancestors) {
                emit([doc.value, Number(i)+1], {_id: doc.ancestors[i]});
            }
        }
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The result you get is:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqtotal_rows\(dq: 5,
    \(dqoffset\(dq: 0,
    \(dqrows\(dq: [
        {
            \(dqid\(dq: \(dq22222\(dq,
            \(dqkey\(dq: [
                \(dqhello\(dq,
                0
            ],
            \(dqvalue\(dq: null,
            \(dqdoc\(dq: {
                \(dq_id\(dq: \(dq22222\(dq,
                \(dq_rev\(dq: \(dq1\-0eee81fecb5aa4f51e285c621271ff02\(dq,
                \(dqancestors\(dq: [
                    \(dq11111\(dq
                ],
                \(dqvalue\(dq: \(dqhello\(dq
            }
        },
        {
            \(dqid\(dq: \(dq22222\(dq,
            \(dqkey\(dq: [
                \(dqhello\(dq,
                1
            ],
            \(dqvalue\(dq: {
                \(dq_id\(dq: \(dq11111\(dq
            },
            \(dqdoc\(dq: {
                \(dq_id\(dq: \(dq11111\(dq,
                \(dq_rev\(dq: \(dq1\-967a00dff5e02add41819138abb3284d\(dq
            }
        },
        {
            \(dqid\(dq: \(dq33333\(dq,
            \(dqkey\(dq: [
                \(dqworld\(dq,
                0
            ],
            \(dqvalue\(dq: null,
            \(dqdoc\(dq: {
                \(dq_id\(dq: \(dq33333\(dq,
                \(dq_rev\(dq: \(dq1\-11e42b44fdb3d3784602eca7c0332a43\(dq,
                \(dqancestors\(dq: [
                    \(dq22222\(dq,
                    \(dq11111\(dq
                ],
                \(dqvalue\(dq: \(dqworld\(dq
            }
        },
        {
            \(dqid\(dq: \(dq33333\(dq,
            \(dqkey\(dq: [
                \(dqworld\(dq,
                1
            ],
            \(dqvalue\(dq: {
                \(dq_id\(dq: \(dq22222\(dq
            },
            \(dqdoc\(dq: {
                \(dq_id\(dq: \(dq22222\(dq,
                \(dq_rev\(dq: \(dq1\-0eee81fecb5aa4f51e285c621271ff02\(dq,
                \(dqancestors\(dq: [
                    \(dq11111\(dq
                ],
                \(dqvalue\(dq: \(dqhello\(dq
            }
        },
        {
            \(dqid\(dq: \(dq33333\(dq,
            \(dqkey\(dq: [
                \(dqworld\(dq,
                2
            ],
            \(dqvalue\(dq: {
                \(dq_id\(dq: \(dq11111\(dq
            },
            \(dqdoc\(dq: {
                \(dq_id\(dq: \(dq11111\(dq,
                \(dq_rev\(dq: \(dq1\-967a00dff5e02add41819138abb3284d\(dq
            }
        }
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
which makes it very cheap to fetch a document plus all its ancestors in one
query.
.sp
Note that the \fB\(dqid\(dq\fP in the row is still that of the originating document.
The only difference is that \fBinclude_docs\fP fetches a different doc.
.sp
The current revision of the document is resolved at query time, not at the time
the view is generated. This means that if a new revision of the linked document
is added later, it will appear in view queries even though the view itself
hasn’t changed. To force a specific revision of a linked document to be used,
emit a \fB\(dq_rev\(dq\fP property as well as \fB\(dq_id\(dq\fP\&.
.SS Using View Collation
.INDENT 0.0
.TP
.B Author
Christopher Lenz
.TP
.B Date
2007\-10\-05
.TP
.B Source
\fI\%http://www.cmlenz.net/archives/2007/10/couchdb\-joins\fP
.UNINDENT
.sp
Just today, there was a discussion on IRC on how you’d go about modeling a
simple blogging system with “post” and “comment” entities, where any blog
post might have N comments. If you’d be using an SQL database, you’d obviously
have two tables with foreign keys and you’d be using joins. (At least until you
needed to add some \fI\%denormalization\fP).
.sp
But what would the “obvious” approach in CouchDB look like?
.SS Approach #1: Comments Inlined
.sp
A simple approach would be to have one document per blog post, and store the
comments inside that document:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dqmyslug\(dq,
    \(dq_rev\(dq: \(dq123456\(dq,
    \(dqauthor\(dq: \(dqjohn\(dq,
    \(dqtitle\(dq: \(dqMy blog post\(dq,
    \(dqcontent\(dq: \(dqBla bla bla …\(dq,
    \(dqcomments\(dq: [
        {\(dqauthor\(dq: \(dqjack\(dq, \(dqcontent\(dq: \(dq…\(dq},
        {\(dqauthor\(dq: \(dqjane\(dq, \(dqcontent\(dq: \(dq…\(dq}
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Of course the model of an actual blogging system would be more extensive,
you’d have tags, timestamps, etc, etc. This is just to demonstrate the basics.
.UNINDENT
.UNINDENT
.sp
The obvious advantage of this approach is that the data that belongs together
is stored in one place. Delete the post, and you automatically delete the
corresponding comments, and so on.
.sp
You may be thinking that putting the comments inside the blog post document
would not allow us to query for the comments themselves, but you’d be wrong.
You could trivially write a CouchDB view that would return all comments across
all blog posts, keyed by author:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    for (var i in doc.comments) {
        emit(doc.comments[i].author, doc.comments[i].content);
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Now you could list all comments by a particular user by invoking the view and
passing it a \fB?key=\(dqusername\(dq\fP query string parameter.
.sp
However, this approach has a drawback that can be quite significant for many
applications: To add a comment to a post, you need to:
.INDENT 0.0
.IP \(bu 2
Fetch the blog post document
.IP \(bu 2
Add the new comment to the JSON structure
.IP \(bu 2
Send the updated document to the server
.UNINDENT
.sp
Now if you have multiple client processes adding comments at roughly the same
time, some of them will get a \fIHTTP 409 Conflict\fP error on step 3 (that’s
optimistic concurrency in action). For some applications this makes sense, but
in many other apps, you’d want to append new related data regardless of whether
other data has been added in the meantime.
.sp
The only way to allow non\-conflicting addition of related data is by putting
that related data into separate documents.
.SS Approach #2: Comments Separate
.sp
Using this approach you’d have one document per blog post, and one document per
comment. The comment documents would have a “backlink” to the post they belong
to.
.sp
The blog post document would look similar to the above, minus the comments
property. Also, we’d now have a type property on all our documents so that we
can tell the difference between posts and comments:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dqmyslug\(dq,
    \(dq_rev\(dq: \(dq123456\(dq,
    \(dqtype\(dq: \(dqpost\(dq,
    \(dqauthor\(dq: \(dqjohn\(dq,
    \(dqtitle\(dq: \(dqMy blog post\(dq,
    \(dqcontent\(dq: \(dqBla bla bla …\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The comments themselves are stored in separate documents, which also have a type
property (this time with the value “comment”), and additionally feature a post
property containing the ID of the post document they belong to:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dqABCDEF\(dq,
    \(dq_rev\(dq: \(dq123456\(dq,
    \(dqtype\(dq: \(dqcomment\(dq,
    \(dqpost\(dq: \(dqmyslug\(dq,
    \(dqauthor\(dq: \(dqjack\(dq,
    \(dqcontent\(dq: \(dq…\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dqDEFABC\(dq,
    \(dq_rev\(dq: \(dq123456\(dq,
    \(dqtype\(dq: \(dqcomment\(dq,
    \(dqpost\(dq: \(dqmyslug\(dq,
    \(dqauthor\(dq: \(dqjane\(dq,
    \(dqcontent\(dq: \(dq…\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
To list all comments per blog post, you’d add a simple view, keyed by blog post
ID:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    if (doc.type == \(dqcomment\(dq) {
        emit(doc.post, {author: doc.author, content: doc.content});
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
And you’d invoke that view passing it a \fB?key=\(dqpost_id\(dq\fP query string
parameter.
.sp
Viewing all comments by author is just as easy as before:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    if (doc.type == \(dqcomment\(dq) {
        emit(doc.author, {post: doc.post, content: doc.content});
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
So this is better in some ways, but it also has a disadvantage.
Imagine you want to display a blog post with all the associated comments on the
same web page. With our first approach, we needed just a single request to the
CouchDB server, namely a \fBGET\fP request to the document. With this second
approach, we need two requests: a \fBGET\fP request to the post document, and a
\fBGET\fP request to the view that returns all comments for the post.
.sp
That is okay, but not quite satisfactory. Just imagine you wanted to add
threaded comments: you’d now need an additional fetch per comment. What we’d
probably want then would be a way to join the blog post and the various comments
together to be able to retrieve them with a single HTTP request.
.sp
This was when Damien Katz, the author of CouchDB, chimed in to the discussion
on IRC to show us the way.
.SS Optimization: Using the Power of View Collation
.sp
Obvious to Damien, but not at all obvious to the rest of us: it’s fairly simple
to make a view that includes both the content of the blog post document, and
the content of all the comments associated with that post. The way you do that
is by using \fIcomplex keys\fP\&. Until now we’ve been using simple string values for
the view keys, but in fact they can be arbitrary JSON values, so let’s make
some use of that:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    if (doc.type == \(dqpost\(dq) {
        emit([doc._id, 0], null);
    } else if (doc.type == \(dqcomment\(dq) {
        emit([doc.post, 1], null);
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Okay, this may be confusing at first. Let’s take a step back and look at what
views in CouchDB are really about.
.sp
CouchDB views are basically highly efficient on\-disk dictionaries that map keys
to values, where the key is automatically indexed and can be used to filter
and/or sort the results you get back from your views. When you “invoke” a view,
you can say that you’re only interested in a subset of the view rows by
specifying a \fB?key=foo\fP query string parameter. Or you can specify
\fB?startkey=foo\fP and/or \fB?endkey=bar\fP query string parameters to fetch rows
over a range of keys. Finally, by adding \fB?include_docs=true\fP to the query,
the result will include the full body of each emitted document.
.sp
It’s also important to note that keys are always used for collating (i.e.
sorting) the rows. CouchDB has well defined (but as of yet undocumented) rules
for comparing arbitrary JSON objects for collation. For example, the JSON value
\fB[\(dqfoo\(dq, 2]\fP is sorted after (considered “greater than”) the values
\fB[\(dqfoo\(dq]\fP or \fB[\(dqfoo\(dq, 1, \(dqbar\(dq]\fP, but before e.g. \fB[\(dqfoo\(dq, 2, \(dqbar\(dq]\fP\&.
This feature enables a whole class of tricks that are rather non\-obvious…
.sp
\fBSEE ALSO:\fP
.INDENT 0.0
.INDENT 3.5
\fI\%Views Collation\fP
.UNINDENT
.UNINDENT
.sp
With that in mind, let’s return to the view function above. First note that,
unlike the previous view functions we’ve used here, this view handles both
“post” and “comment” documents, and both of them end up as rows in the same
view. Also, the key in this view is not just a simple string, but an array.
The first element in that array is always the ID of the post, regardless of
whether we’re processing an actual post document, or a comment associated with
a post. The second element is 0 for post documents, and 1 for comment documents.
.sp
Let’s assume we have two blog posts in our database. Without limiting the view
results via \fBkey\fP, \fBstartkey\fP, or \fBendkey\fP, we’d get back something like
the following:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqtotal_rows\(dq: 5, \(dqoffset\(dq: 0, \(dqrows\(dq: [{
            \(dqid\(dq: \(dqmyslug\(dq,
            \(dqkey\(dq: [\(dqmyslug\(dq, 0],
            \(dqvalue\(dq: null
        }, {
            \(dqid\(dq: \(dqABCDEF\(dq,
            \(dqkey\(dq: [\(dqmyslug\(dq, 1],
            \(dqvalue\(dq: null
        }, {
            \(dqid\(dq: \(dqDEFABC\(dq,
            \(dqkey\(dq: [\(dqmyslug\(dq, 1],
            \(dqvalue\(dq: null
        }, {
            \(dqid\(dq: \(dqother_slug\(dq,
            \(dqkey\(dq: [\(dqother_slug\(dq, 0],
            \(dqvalue\(dq: null
        }, {
            \(dqid\(dq: \(dqCDEFAB\(dq,
            \(dqkey\(dq: [\(dqother_slug\(dq, 1],
            \(dqvalue\(dq: null
        },
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
The \fB\&...\fP placeholders here would contain the complete JSON encoding of the
corresponding documents
.UNINDENT
.UNINDENT
.sp
Now, to get a specific blog post and all associated comments, we’d invoke that
view with the query string:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
?startkey=[\(dqmyslug\(dq]&endkey=[\(dqmyslug\(dq, 2]&include_docs=true
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
We’d get back the first three rows, those that belong to the \fBmyslug\fP post,
but not the others, along with the full bodies of each document. Et voila, we
now have the data we need to display a post with all associated comments,
retrieved via a single \fBGET\fP request.
.sp
You may be asking what the 0 and 1 parts of the keys are for. They’re simply
to ensure that the post document is always sorted before the the associated
comment documents. So when you get back the results from this view for a
specific post, you’ll know that the first row contains the data for the blog
post itself, and the remaining rows contain the comment data.
.sp
One remaining problem with this model is that comments are not ordered, but
that’s simply because we don’t have date/time information associated with them.
If we had, we’d add the timestamp as third element of the key array, probably
as ISO date/time strings. Now we would continue using the query string
\fB?startkey=[\(dqmyslug\(dq]&endkey=[\(dqmyslug\(dq, 2]&include_docs=true\fP to fetch the
blog post and all associated comments, only now they’d be in chronological
order.
.SS View Cookbook for SQL Jockeys
.sp
This is a collection of some common SQL queries and how to get the same result
in CouchDB. The key to remember here is that CouchDB does not work like an SQL
database at all, and that best practices from the SQL world do not translate
well or at all to CouchDB. This document’s “cookbook” assumes that you are
familiar with the CouchDB basics such as creating and updating databases and
documents.
.SS Using Views
.sp
How you would do this in SQL:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
CREATE TABLE
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
or:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
ALTER TABLE
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
How you can do this in CouchDB?
.sp
Using views is a two\-step process. First you define a view; then you query it.
This is analogous to defining a table structure (with indexes) using
\fBCREATE TABLE\fP or \fBALTER TABLE\fP and querying it using an SQL query.
.SS Defining a View
.sp
Defining a view is done by creating a special document in a CouchDB database.
The only real specialness is the \fB_id\fP of the document, which starts with
\fB_design/\fP — for example, _design/application. Other than that, it is just a
regular CouchDB document. To make sure CouchDB understands that you are defining
a view, you need to prepare the contents of that design document in a special
format. Here is an example:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dq_design/application\(dq,
    \(dq_rev\(dq: \(dq1\-C1687D17\(dq,
    \(dqviews\(dq: {
        \(dqviewname\(dq: {
            \(dqmap\(dq: \(dqfunction(doc) { ... }\(dq,
            \(dqreduce\(dq: \(dqfunction(keys, values) { ... }\(dq
        }
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
We are defining a view \fIviewname\fP\&. The definition of the view consists of two
functions: the map function and the reduce function. Specifying a reduce
function is optional. We’ll look at the nature of the functions later. Note that
\fIviewname\fP can be whatever you like: \fBusers\fP, \fBby\-name\fP, or \fBby\-date\fP are
just some examples.
.sp
A single design document can also include multiple view definitions, each
identified by a unique name:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dq_design/application\(dq,
    \(dq_rev\(dq: \(dq1\-C1687D17\(dq,
    \(dqviews\(dq: {
        \(dqviewname\(dq: {
            \(dqmap\(dq: \(dqfunction(doc) { ... }\(dq,
            \(dqreduce\(dq: \(dqfunction(keys, values) { ... }\(dq
        },
        \(dqanotherview\(dq: {
            \(dqmap\(dq: \(dqfunction(doc) { ... }\(dq,
            \(dqreduce\(dq: \(dqfunction(keys, values) { ... }\(dq
        }
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Querying a View
.sp
The name of the design document and the name of the view are significant for
querying the view. To query the view \fIviewname\fP, you perform an HTTP \fBGET\fP
request to the following URI:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
/database/_design/application/_view/viewname
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
database is the name of the database you created your design document in. Next
up is the design document name, and then the view name prefixed with \fB_view/\fP\&.
To query \fIanotherview\fP, replace \fIviewname\fP in that URI with \fIanotherview\fP\&.
If you want to query a view in a different design document, adjust the design
document name.
.SS MapReduce Functions
.sp
MapReduce is a concept that solves problems by applying a two\-step process,
aptly named the map phase and the reduce phase. The map phase looks at all
documents in CouchDB separately one after the other and creates a \fImap result\fP\&.
The map result is an ordered list of key/value pairs. Both key and value can
be specified by the user writing the map function. A map function may call the
built\-in \fBemit(key, value)\fP function 0 to N times per document, creating a row
in the map result per invocation.
.sp
CouchDB is smart enough to run a map function only once for every document, even
on subsequent queries on a view. Only changes to documents or new documents need
to be processed anew.
.SS Map functions
.sp
Map functions run in isolation for every document. They can’t modify the
document, and they can’t talk to the outside world—they can’t have side effects.
This is required so that CouchDB can guarantee correct results without having
to recalculate a complete result when only one document gets changed.
.sp
The map result looks like this:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqtotal_rows\(dq:3,\(dqoffset\(dq:0,\(dqrows\(dq:[
{\(dqid\(dq:\(dqfc2636bf50556346f1ce46b4bc01fe30\(dq,\(dqkey\(dq:\(dqLena\(dq,\(dqvalue\(dq:5},
{\(dqid\(dq:\(dq1fb2449f9b9d4e466dbfa47ebe675063\(dq,\(dqkey\(dq:\(dqLisa\(dq,\(dqvalue\(dq:4},
{\(dqid\(dq:\(dq8ede09f6f6aeb35d948485624b28f149\(dq,\(dqkey\(dq:\(dqSarah\(dq,\(dqvalue\(dq:6}
]}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
It is a list of rows sorted by the value of key. The id is added automatically
and refers back to the document that created this row. The value is the data
you’re looking for. For example purposes, it’s the girl’s age.
.sp
The map function that produces this result is:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    if(doc.name && doc.age) {
        emit(doc.name, doc.age);
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
It includes the if statement as a sanity check to ensure that we’re operating
on the right fields and calls the emit function with the name and age as the key
and value.
.SS Look Up by Key
.sp
How you would do this in SQL:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
SELECT field FROM table WHERE value=\(dqsearchterm\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
How you can do this in CouchDB?
.sp
Use case: get a result (which can be a record or set of records) associated
with a key (“searchterm”).
.sp
To look something up quickly, regardless of the storage mechanism, an index is
needed. An index is a data structure optimized for quick search and retrieval.
CouchDB’s map result is stored in such an index, which happens to be a B+ tree.
.sp
To look up a value by “searchterm”, we need to put all values into the key of a
view. All we need is a simple map function:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    if(doc.value) {
        emit(doc.value, null);
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This creates a list of documents that have a value field sorted by the data in
the value field. To find all the records that match “searchterm”, we query the
view and specify the search term as a query parameter:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
/database/_design/application/_view/viewname?key=\(dqsearchterm\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Consider the documents from the previous section, and say we’re indexing on the
age field of the documents to find all the five\-year\-olds:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    if(doc.age && doc.name) {
        emit(doc.age, doc.name);
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Query:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
/ladies/_design/ladies/_view/age?key=5
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Result:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqtotal_rows\(dq:3,\(dqoffset\(dq:1,\(dqrows\(dq:[
{\(dqid\(dq:\(dqfc2636bf50556346f1ce46b4bc01fe30\(dq,\(dqkey\(dq:5,\(dqvalue\(dq:\(dqLena\(dq}
]}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Easy.
.sp
Note that you have to emit a value. The view result includes the associated
document ID in every row. We can use it to look up more data from the document
itself. We can also use the \fB?include_docs=true\fP parameter to have CouchDB
fetch the individual documents for us.
.SS Look Up by Prefix
.sp
How you would do this in SQL:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
SELECT field FROM table WHERE value LIKE \(dqsearchterm%\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
How you can do this in CouchDB?
.sp
Use case: find all documents that have a field value that starts with
\fIsearchterm\fP\&. For example, say you stored a MIME type (like \fItext/html\fP or
\fIimage/jpg\fP) for each document and now you want to find all documents that are
images according to the MIME type.
.sp
The solution is very similar to the previous example: all we need is a map
function that is a little more clever than the first one. But first, an example
document:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dqHugh Laurie\(dq,
    \(dq_rev\(dq: \(dq1\-9fded7deef52ac373119d05435581edf\(dq,
    \(dqmime\-type\(dq: \(dqimage/jpg\(dq,
    \(dqdescription\(dq: \(dqsome dude\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The clue lies in extracting the prefix that we want to search for from our
document and putting it into our view index. We use a regular expression to
match our prefix:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    if(doc[\(dqmime\-type\(dq]) {
        // from the start (^) match everything that is not a slash ([^\e/]+) until
        // we find a slash (\e/). Slashes needs to be escaped with a backslash (\e/)
        var prefix = doc[\(dqmime\-type\(dq].match(/^[^\e/]+\e//);
        if(prefix) {
          emit(prefix, null);
        }
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
We can now query this view with our desired MIME type prefix and not only find
all images, but also text, video, and all other formats:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
/files/_design/finder/_view/by\-mime\-type?key=\(dqimage/\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Aggregate Functions
.sp
How you would do this in SQL:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
SELECT COUNT(field) FROM table
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
How you can do this in CouchDB?
.sp
Use case: calculate a derived value from your data.
.sp
We haven’t explained reduce functions yet. Reduce functions are similar to
aggregate functions in SQL. They compute a value over multiple documents.
.sp
To explain the mechanics of reduce functions, we’ll create one that doesn’t make
a whole lot of sense. But this example is easy to understand. We’ll explore more
useful reductions later.
.sp
Reduce functions operate on the output of the map function (also called the map
result or intermediate result). The reduce function’s job, unsurprisingly, is to
reduce the list that the map function produces.
.sp
Here’s what our summing reduce function looks like:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(keys, values) {
    var sum = 0;
    for(var idx in values) {
        sum = sum + values[idx];
    }
    return sum;
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Here’s an alternate, more idiomatic JavaScript version:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(keys, values) {
    var sum = 0;
    values.forEach(function(element) {
        sum = sum + element;
    });
    return sum;
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Don’t miss effective built\-in \fI\%reduce functions\fP like
\fB_sum\fP and \fB_count\fP
.UNINDENT
.UNINDENT
.sp
This reduce function takes two arguments: a list of keys and a list of values.
For our summing purposes we can ignore the keys\-list and consider only the value
list. We’re looping over the list and add each item to a running total that
we’re returning at the end of the function.
.sp
You’ll see one difference between the map and the reduce function. The map
function uses \fBemit()\fP to create its result, whereas the reduce function
returns a value.
.sp
For example, from a list of integer values that specify the age, calculate the
sum of all years of life for the news headline,
\fI“786 life years present at event.”\fP A little contrived, but very simple and
thus good for demonstration purposes. Consider the documents and the map view we
used earlier in this document.
.sp
The reduce function to calculate the total age of all girls is:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(keys, values) {
    return sum(values);
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Note that, instead of the two earlier versions, we use CouchDB’s predefined
\fI\%sum()\fP function. It does the same thing as the other two, but it is such
a common piece of code that CouchDB has it included.
.sp
The result for our reduce view now looks like this:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqrows\(dq:[
    {\(dqkey\(dq:null,\(dqvalue\(dq:15}
]}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The total sum of all age fields in all our documents is 15. Just what we wanted.
The key member of the result object is null, as we can’t know anymore which
documents took part in the creation of the reduced result. We’ll cover more
advanced reduce cases later on.
.sp
As a rule of thumb, the reduce function should reduce to a single scalar value.
That is, an integer; a string; or a small, fixed\-size list or object that
includes an aggregated value (or values) from the values argument.
It should never just return values or similar. CouchDB will give you a warning
if you try to use reduce “the wrong way”:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqerror\(dq:\(dqreduce_overflow_error\(dq,
    \(dqmessage\(dq:\(dqReduce output must shrink more rapidly: Current output: ...\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Get Unique Values
.sp
How you would do this in SQL:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
SELECT DISTINCT field FROM table
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
How you can do this in CouchDB?
.sp
Getting unique values is not as easy as adding a keyword. But a reduce view and
a special query parameter give us the same result. Let’s say you want a list of
tags that your users have tagged themselves with and no duplicates.
.sp
First, let’s look at the source documents. We punt on \fB_id\fP and \fB_rev\fP
attributes here:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqname\(dq:\(dqChris\(dq,
    \(dqtags\(dq:[\(dqmustache\(dq, \(dqmusic\(dq, \(dqcouchdb\(dq]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqname\(dq:\(dqNoah\(dq,
    \(dqtags\(dq:[\(dqhypertext\(dq, \(dqphilosophy\(dq, \(dqcouchdb\(dq]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqname\(dq:\(dqJan\(dq,
    \(dqtags\(dq:[\(dqdrums\(dq, \(dqbike\(dq, \(dqcouchdb\(dq]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Next, we need a list of all tags. A map function will do the trick:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    if(doc.name && doc.tags) {
        doc.tags.forEach(function(tag) {
            emit(tag, null);
        });
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The result will look like this:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqtotal_rows\(dq:9,\(dqoffset\(dq:0,\(dqrows\(dq:[
{\(dqid\(dq:\(dq3525ab874bc4965fa3cda7c549e92d30\(dq,\(dqkey\(dq:\(dqbike\(dq,\(dqvalue\(dq:null},
{\(dqid\(dq:\(dq3525ab874bc4965fa3cda7c549e92d30\(dq,\(dqkey\(dq:\(dqcouchdb\(dq,\(dqvalue\(dq:null},
{\(dqid\(dq:\(dq53f82b1f0ff49a08ac79a9dff41d7860\(dq,\(dqkey\(dq:\(dqcouchdb\(dq,\(dqvalue\(dq:null},
{\(dqid\(dq:\(dqda5ea89448a4506925823f4d985aabbd\(dq,\(dqkey\(dq:\(dqcouchdb\(dq,\(dqvalue\(dq:null},
{\(dqid\(dq:\(dq3525ab874bc4965fa3cda7c549e92d30\(dq,\(dqkey\(dq:\(dqdrums\(dq,\(dqvalue\(dq:null},
{\(dqid\(dq:\(dq53f82b1f0ff49a08ac79a9dff41d7860\(dq,\(dqkey\(dq:\(dqhypertext\(dq,\(dqvalue\(dq:null},
{\(dqid\(dq:\(dqda5ea89448a4506925823f4d985aabbd\(dq,\(dqkey\(dq:\(dqmusic\(dq,\(dqvalue\(dq:null},
{\(dqid\(dq:\(dqda5ea89448a4506925823f4d985aabbd\(dq,\(dqkey\(dq:\(dqmustache\(dq,\(dqvalue\(dq:null},
{\(dqid\(dq:\(dq53f82b1f0ff49a08ac79a9dff41d7860\(dq,\(dqkey\(dq:\(dqphilosophy\(dq,\(dqvalue\(dq:null}
]}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
As promised, these are all the tags, including duplicates. Since each document
gets run through the map function in isolation, it cannot know if the same key
has been emitted already. At this stage, we need to live with that. To achieve
uniqueness, we need a reduce:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(keys, values) {
    return true;
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This reduce doesn’t do anything, but it allows us to specify a special query
parameter when querying the view:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
/dudes/_design/dude\-data/_view/tags?group=true
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB replies:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqrows\(dq:[
{\(dqkey\(dq:\(dqbike\(dq,\(dqvalue\(dq:true},
{\(dqkey\(dq:\(dqcouchdb\(dq,\(dqvalue\(dq:true},
{\(dqkey\(dq:\(dqdrums\(dq,\(dqvalue\(dq:true},
{\(dqkey\(dq:\(dqhypertext\(dq,\(dqvalue\(dq:true},
{\(dqkey\(dq:\(dqmusic\(dq,\(dqvalue\(dq:true},
{\(dqkey\(dq:\(dqmustache\(dq,\(dqvalue\(dq:true},
{\(dqkey\(dq:\(dqphilosophy\(dq,\(dqvalue\(dq:true}
]}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
In this case, we can ignore the value part because it is always true, but the
result includes a list of all our tags and no duplicates!
.sp
With a small change we can put the reduce to good use, too. Let’s see how many
of the non\-unique tags are there for each tag. To calculate the tag frequency,
we just use the summing up we already learned about. In the map function,
we emit a 1 instead of null:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    if(doc.name && doc.tags) {
        doc.tags.forEach(function(tag) {
            emit(tag, 1);
        });
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
In the reduce function, we return the sum of all values:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(keys, values) {
    return sum(values);
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Now, if we query the view with the \fB?group=true\fP parameter, we get back the
count for each tag:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqrows\(dq:[
{\(dqkey\(dq:\(dqbike\(dq,\(dqvalue\(dq:1},
{\(dqkey\(dq:\(dqcouchdb\(dq,\(dqvalue\(dq:3},
{\(dqkey\(dq:\(dqdrums\(dq,\(dqvalue\(dq:1},
{\(dqkey\(dq:\(dqhypertext\(dq,\(dqvalue\(dq:1},
{\(dqkey\(dq:\(dqmusic\(dq,\(dqvalue\(dq:1},
{\(dqkey\(dq:\(dqmustache\(dq,\(dqvalue\(dq:1},
{\(dqkey\(dq:\(dqphilosophy\(dq,\(dqvalue\(dq:1}
]}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Enforcing Uniqueness
.sp
How you would do this in SQL:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
UNIQUE KEY(column)
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
How you can do this in CouchDB?
.sp
Use case: your applications require that a certain value exists only once in a
database.
.sp
This is an easy one: within a CouchDB database, each document must have a
unique \fB_id\fP field. If you require unique values in a database, just assign
them to a document’s \fB_id\fP field and CouchDB will enforce uniqueness for you.
.sp
There’s one caveat, though: in the distributed case, when you are running more
than one CouchDB node that accepts write requests, uniqueness can be guaranteed
only per node or outside of CouchDB. CouchDB will allow two identical IDs to be
written to two different nodes. On replication, CouchDB will detect a conflict
and flag the document accordingly.
.SS Pagination Recipe
.sp
This recipe explains how to paginate over view results.
Pagination is a user interface (UI) pattern that allows the display of a
large number of rows (\fIthe result set\fP) without loading all the rows into the
UI at once. A fixed\-size subset, the \fIpage\fP, is displayed along with next and
previous links or buttons that can move the \fIviewport\fP over the result set to
an adjacent page.
.sp
We assume you’re familiar with creating and querying documents and views as
well as the multiple view query options.
.SS Example Data
.sp
To have some data to work with, we’ll create a list of bands,
one document per band:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{ \(dqname\(dq:\(dqBiffy Clyro\(dq }

{ \(dqname\(dq:\(dqFoo Fighters\(dq }

{ \(dqname\(dq:\(dqTool\(dq }

{ \(dqname\(dq:\(dqNirvana\(dq }

{ \(dqname\(dq:\(dqHelmet\(dq }

{ \(dqname\(dq:\(dqTenacious D\(dq }

{ \(dqname\(dq:\(dqFuture of the Left\(dq }

{ \(dqname\(dq:\(dqA Perfect Circle\(dq }

{ \(dqname\(dq:\(dqSilverchair\(dq }

{ \(dqname\(dq:\(dqQueens of the Stone Age\(dq }

{ \(dqname\(dq:\(dqKerub\(dq }
.ft P
.fi
.UNINDENT
.UNINDENT
.SS A View
.sp
We need a simple map function that gives us an alphabetical list of band
names. This should be easy, but we’re adding extra smarts to filter out “The”
and “A” in front of band names to put them into the right position:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    if(doc.name) {
        var name = doc.name.replace(/^(A|The) /, \(dq\(dq);
        emit(name, null);
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The views result is an alphabetical list of band names. Now say we want to
display band names five at a time and have a link pointing to the next five
names that make up one page, and a link for the previous five,
if we’re not on the first page.
.sp
We learned how to use the \fBstartkey\fP, \fBlimit\fP, and \fBskip\fP parameters in
earlier documents. We’ll use these again here. First, let’s have a look at
the full result set:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqtotal_rows\(dq:11,\(dqoffset\(dq:0,\(dqrows\(dq:[
    {\(dqid\(dq:\(dqa0746072bba60a62b01209f467ca4fe2\(dq,\(dqkey\(dq:\(dqBiffy Clyro\(dq,\(dqvalue\(dq:null},
    {\(dqid\(dq:\(dqb47d82284969f10cd1b6ea460ad62d00\(dq,\(dqkey\(dq:\(dqFoo Fighters\(dq,\(dqvalue\(dq:null},
    {\(dqid\(dq:\(dq45ccde324611f86ad4932555dea7fce0\(dq,\(dqkey\(dq:\(dqTenacious D\(dq,\(dqvalue\(dq:null},
    {\(dqid\(dq:\(dqd7ab24bb3489a9010c7d1a2087a4a9e4\(dq,\(dqkey\(dq:\(dqFuture of the Left\(dq,\(dqvalue\(dq:null},
    {\(dqid\(dq:\(dqad2f85ef87f5a9a65db5b3a75a03cd82\(dq,\(dqkey\(dq:\(dqHelmet\(dq,\(dqvalue\(dq:null},
    {\(dqid\(dq:\(dqa2f31cfa68118a6ae9d35444fcb1a3cf\(dq,\(dqkey\(dq:\(dqNirvana\(dq,\(dqvalue\(dq:null},
    {\(dqid\(dq:\(dq67373171d0f626b811bdc34e92e77901\(dq,\(dqkey\(dq:\(dqKerub\(dq,\(dqvalue\(dq:null},
    {\(dqid\(dq:\(dq3e1b84630c384f6aef1a5c50a81e4a34\(dq,\(dqkey\(dq:\(dqPerfect Circle\(dq,\(dqvalue\(dq:null},
    {\(dqid\(dq:\(dq84a371a7b8414237fad1b6aaf68cd16a\(dq,\(dqkey\(dq:\(dqQueens of the Stone Age\(dq,\(dqvalue\(dq:null},
    {\(dqid\(dq:\(dqdcdaf08242a4be7da1a36e25f4f0b022\(dq,\(dqkey\(dq:\(dqSilverchair\(dq,\(dqvalue\(dq:null},
    {\(dqid\(dq:\(dqfd590d4ad53771db47b0406054f02243\(dq,\(dqkey\(dq:\(dqTool\(dq,\(dqvalue\(dq:null}
]}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Setup
.sp
The mechanics of paging are very simple:
.INDENT 0.0
.IP \(bu 2
Display first page
.IP \(bu 2
If there are more rows to show, show next link
.IP \(bu 2
Draw subsequent page
.IP \(bu 2
If this is not the first page, show a previous link
.IP \(bu 2
If there are more rows to show, show next link
.UNINDENT
.sp
Or in a pseudo\-JavaScript snippet:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
var result = new Result();
var page = result.getPage();

page.display();

if(result.hasPrev()) {
    page.display_link(\(aqprev\(aq);
}

if(result.hasNext()) {
    page.display_link(\(aqnext\(aq);
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Paging
.sp
To get the first five rows from the view result, you use the \fB?limit=5\fP
query parameter:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X GET http://127.0.0.1:5984/artists/_design/artists/_view/by\-name?limit=5
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The result:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqtotal_rows\(dq:11,\(dqoffset\(dq:0,\(dqrows\(dq:[
    {\(dqid\(dq:\(dqa0746072bba60a62b01209f467ca4fe2\(dq,\(dqkey\(dq:\(dqBiffy Clyro\(dq,\(dqvalue\(dq:null},
    {\(dqid\(dq:\(dqb47d82284969f10cd1b6ea460ad62d00\(dq,\(dqkey\(dq:\(dqFoo Fighters\(dq,\(dqvalue\(dq:null},
    {\(dqid\(dq:\(dq45ccde324611f86ad4932555dea7fce0\(dq,\(dqkey\(dq:\(dqTenacious D\(dq,\(dqvalue\(dq:null},
    {\(dqid\(dq:\(dqd7ab24bb3489a9010c7d1a2087a4a9e4\(dq,\(dqkey\(dq:\(dqFuture of the Left\(dq,\(dqvalue\(dq:null},
    {\(dqid\(dq:\(dqad2f85ef87f5a9a65db5b3a75a03cd82\(dq,\(dqkey\(dq:\(dqHelmet\(dq,\(dqvalue\(dq:null}
]}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
By comparing the \fBtotal_rows\fP value to our \fBlimit\fP value,
we can determine if there are more pages to display. We also know by the
\fIoffset\fP member that we are on the first page. We can calculate the value for
\fBskip=\fP to get the results for the next page:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
var rows_per_page = 5;
var page = (offset / rows_per_page) + 1; // == 1
var skip = page * rows_per_page; // == 5 for the first page, 10 for the second ...
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
So we query CouchDB with:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X GET \(aqhttp://127.0.0.1:5984/artists/_design/artists/_view/by\-name?limit=5&skip=5\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Note we have to use \fB\(aq\fP (single quotes) to escape the \fB&\fP character that is
special to the shell we execute curl in.
.sp
The result:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqtotal_rows\(dq:11,\(dqoffset\(dq:5,\(dqrows\(dq:[
    {\(dqid\(dq:\(dqa2f31cfa68118a6ae9d35444fcb1a3cf\(dq,\(dqkey\(dq:\(dqNirvana\(dq,\(dqvalue\(dq:null},
    {\(dqid\(dq:\(dq67373171d0f626b811bdc34e92e77901\(dq,\(dqkey\(dq:\(dqKerub\(dq,\(dqvalue\(dq:null},
    {\(dqid\(dq:\(dq3e1b84630c384f6aef1a5c50a81e4a34\(dq,\(dqkey\(dq:\(dqPerfect Circle\(dq,\(dqvalue\(dq:null},
    {\(dqid\(dq:\(dq84a371a7b8414237fad1b6aaf68cd16a\(dq,\(dqkey\(dq:\(dqQueens of the Stone Age\(dq,
    \(dqvalue\(dq:null},
    {\(dqid\(dq:\(dqdcdaf08242a4be7da1a36e25f4f0b022\(dq,\(dqkey\(dq:\(dqSilverchair\(dq,\(dqvalue\(dq:null}
]}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Implementing the \fBhasPrev()\fP and \fBhasNext()\fP method is pretty
straightforward:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function hasPrev()
{
    return page > 1;
}

function hasNext()
{
    var last_page = Math.floor(total_rows / rows_per_page) +
        (total_rows % rows_per_page);
    return page != last_page;
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Paging (Alternate Method)
.sp
The method described above performed poorly with large skip values until
CouchDB 1.2. Additionally, some use cases may call for the following
alternate method even with newer versions of CouchDB. One such case is when
duplicate results should be prevented. Using skip alone it is possible for
new documents to be inserted during pagination which could change the offset
of the start of the subsequent page.
.sp
A correct solution is not much harder. Instead of slicing the result set
into equally sized pages, we look at 10 rows at a time and use \fBstartkey\fP to
jump to the next 10 rows. We even use skip, but only with the value 1.
.sp
Here is how it works:
.INDENT 0.0
.IP \(bu 2
Request \fIrows_per_page + 1\fP rows from the view
.IP \(bu 2
Display \fIrows_per_page\fP rows, \fIstore + 1\fP row as \fBnext_startkey\fP and
\fBnext_startkey_docid\fP
.IP \(bu 2
As page information, keep \fBstartkey\fP and \fBnext_startkey\fP
.IP \(bu 2
Use the \fBnext_*\fP values to create the next link, and use the others to
create the previous link
.UNINDENT
.sp
The trick to finding the next page is pretty simple. Instead of requesting 10
rows for a page, you request 11 rows, but display only 10 and use the values
in the 11th row as the \fBstartkey\fP for the next page. Populating the link to
the previous page is as simple as carrying the current \fBstartkey\fP over to the
next page. If there’s no previous \fBstartkey\fP, we are on the first page. We
stop displaying the link to the next page if we get \fIrows_per_page\fP or less
rows back. This is called linked list pagination, as we go from page to
page, or list item to list item, instead of jumping directly to a
pre\-computed page. There is one caveat, though. Can you spot it?
.sp
CouchDB view keys do not have to be unique; you can have multiple index
entries read. What if you have more index entries for a key than rows that
should be on a page? \fBstartkey\fP jumps to the first row, and you’d be screwed
if CouchDB didn’t have an additional parameter for you to use. All view keys
with the same value are internally sorted by \fIdocid\fP, that is, the ID of
the document that created that view row. You can use the \fBstartkey_docid\fP
and \fBendkey_docid\fP parameters to get subsets of these rows. For
pagination, we still don’t need \fBendkey_docid\fP, but \fBstartkey_docid\fP is very
handy. In addition to \fBstartkey\fP and \fBlimit\fP, you also use
\fBstartkey_docid\fP for pagination if, and only if, the extra row you fetch to
find the next page has the same key as the current \fBstartkey\fP\&.
.sp
It is important to note that the \fB*_docid\fP parameters only work in addition to
the \fB*key\fP parameters and are only useful to further narrow down the result set
of a view for a single key. They do not work on their own (the one exception
being the built\-in \fI\%_all_docs view\fP  that already sorts
by document ID).
.sp
The advantage of this approach is that all the key operations can be
performed on the super\-fast B\-tree index behind the view. Looking up a page
doesn’t include scanning through hundreds and thousands of rows unnecessarily.
.SS Jump to Page
.sp
One drawback of the linked list style pagination is that you can’t
pre\-compute the rows for a particular page from the page number and the rows
per page. Jumping to a specific page doesn’t really work. Our gut reaction,
if that concern is raised, is, “Not even Google is doing that!” and we tend
to get away with it. Google always pretends on the first page to find 10 more
pages of results. Only if you click on the second page (something very few
people actually do) might Google display a reduced set of pages. If you page
through the results, you get links for the previous and next 10 pages,
but no more. Pre\-computing the necessary \fBstartkey\fP and \fBstartkey_docid\fP
for 20 pages is a feasible operation and a pragmatic optimization to know the
rows for every page in a result set that is potentially tens of thousands
of rows long, or more.
.sp
If you really do need to jump to a page over the full range of documents (we
have seen applications that require that), you can still maintain an integer
value index as the view index and take a hybrid approach at solving pagination.
.SS Search
.sp
Search indexes enable you to query a database by using the
\fI\%Lucene Query Parser Syntax.\fP
A search index uses one, or multiple, fields from your documents. You can use a search
index to run queries, find documents based on the content they contain, or work with
groups, facets, or geographical searches.
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
Search cannot function unless it has a functioning, cluster\-connected
Clouseau instance. See \fI\%Search Plugin Installation\fP
for details.
.UNINDENT
.UNINDENT
.sp
To create a search index, you add a JavaScript function to a design document in the
database. An index builds after processing one search request or after the server detects
a document update. The \fBindex\fP function takes the following parameters:
.INDENT 0.0
.IP 1. 3
Field name \- The name of the field you want to use when you query the index.
If you set this parameter to \fBdefault\fP, then this field is queried if no field is
specified in the query syntax.
.IP 2. 3
Data that you want to index, for example, \fBdoc.address.country\fP\&.
.IP 3. 3
(Optional) The third parameter includes the following fields: \fBboost\fP, \fBfacet\fP,
\fBindex\fP, and \fBstore\fP\&. These fields are described in more detail later.
.UNINDENT
.sp
By default, a search index response returns 25 rows. The number of rows that is returned
can be changed by using the \fBlimit\fP parameter. Each response includes a \fBbookmark\fP
field. You can include the value of the \fBbookmark\fP field in later queries to look
through the responses.
.sp
\fIExample design document that defines a search index:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dq_design/search_example\(dq,
    \(dqindexes\(dq: {
        \(dqanimals\(dq: {
            \(dqindex\(dq: \(dqfunction(doc){ ... }\(dq
        }
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
A search index will inherit the partitioning type from the \fBoptions.partitioned\fP field
of the design document that contains it.
.SS Index functions
.sp
Attempting to index by using a data field that does not exist fails. To avoid
this problem, use the appropriate
\fI\%guard clause\fP\&.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Your indexing functions operate in a memory\-constrained environment
where the document itself forms a part of the memory that is used
in that environment. Your code’s stack and document must fit inside this
memory. In other words, a document must be loaded in order to be indexed.
Documents are limited to a maximum size of 64 MB.
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Within a search index, do not index the same field name with more than one data
type. If the same field name is indexed with different data types in the same search
index function, you might get an error when querying the search index that says the
field “was indexed without position data.” For example, do not include both of these
lines in the same search index function, as they index the \fBmyfield\fP field as two
different data types: a string \fB\(dqthis is a string\(dq\fP and a number \fB123\fP\&.
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
index(\(dqmyfield\(dq, \(dqthis is a string\(dq);
index(\(dqmyfield\(dq, 123);
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The function that is contained in the index field is a JavaScript function
that is called for each document in the database.
The function takes the document as a parameter,
extracts some data from it, and then calls the function that is defined
in the \fBindex\fP field to index that data.
.sp
The \fBindex\fP function takes three parameters, where the third parameter is optional.
.INDENT 0.0
.IP 1. 3
The first parameter is the name of the field you intend to use when querying the index,
and which is specified in the Lucene syntax portion of subsequent queries.
An example appears in the following query:
.INDENT 3.0
.INDENT 3.5
.sp
.nf
.ft C
query=color:red
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The Lucene field name \fBcolor\fP is the first parameter of the \fBindex\fP function.
.sp
The \fBquery\fP parameter can be abbreviated to \fBq\fP,
so another way of writing the query is as follows:
.INDENT 3.0
.INDENT 3.5
.sp
.nf
.ft C
q=color:red
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If the special value \fB\(dqdefault\(dq\fP is used when you define the name,
you do not have to specify a field name at query time.
The effect is that the query can be simplified:
.INDENT 3.0
.INDENT 3.5
.sp
.nf
.ft C
query=red
.ft P
.fi
.UNINDENT
.UNINDENT
.IP 2. 3
The second parameter is the data to be indexed. Keep the following information
in mind when you index your data:
.INDENT 3.0
.IP \(bu 2
This data must be only a string, number, or boolean. Other types will cause
an error to be thrown by the index function call.
.IP \(bu 2
If an error is thrown when running your function, for this reason or others,
the document will not be added to that search index.
.UNINDENT
.IP 3. 3
The third, optional, parameter is a JavaScript object with the following fields:
.sp
\fIIndex function (optional parameter)\fP
.INDENT 3.0
.IP \(bu 2
\fBboost\fP \- A number that specifies the relevance in search results. Content that is
indexed with a boost value greater than 1 is more relevant than content that is
indexed without a boost value. Content with a boost value less than one is not so
relevant. Value is a positive floating point number. Default is 1 (no boosting).
.IP \(bu 2
\fBfacet\fP \- Creates a faceted index. See \fI\%Faceting\fP\&.
Values are \fBtrue\fP or \fBfalse\fP\&. Default is \fBfalse\fP\&.
.IP \(bu 2
\fBindex\fP \- Whether the data is indexed, and if so, how. If set to \fBfalse\fP, the
data cannot be used for searches, but can still be retrieved from the index if
\fBstore\fP is set to \fBtrue\fP\&. See \fI\%Analyzers\fP\&.
Values are \fBtrue\fP or \fBfalse\fP\&. Default is \fBtrue\fP
.IP \(bu 2
\fBstore\fP \- If \fBtrue\fP, the value is returned in the search result; otherwise,
the value is not returned. Values are \fBtrue\fP or \fBfalse\fP\&. Default is \fBfalse\fP\&.
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 3.0
.INDENT 3.5
If you do not set the \fBstore\fP parameter,
the index data results for the document are not returned in response to a query.
.UNINDENT
.UNINDENT
.UNINDENT
.sp
\fIExample search index function:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    index(\(dqdefault\(dq, doc._id);
    if (doc.min_length) {
        index(\(dqmin_length\(dq, doc.min_length, {\(dqstore\(dq: true});
    }
    if (doc.diet) {
        index(\(dqdiet\(dq, doc.diet, {\(dqstore\(dq: true});
    }
    if (doc.latin_name) {
        index(\(dqlatin_name\(dq, doc.latin_name, {\(dqstore\(dq: true});
    }
    if (doc.class) {
        index(\(dqclass\(dq, doc.class, {\(dqstore\(dq: true});
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Index guard clauses
.sp
The \fBindex\fP function requires the name of the data field to index as the second
parameter. However, if that data field does not exist for the document, an error occurs.
The solution is to use an appropriate ‘guard clause’ that checks if the field exists, and
contains the expected type of data, \fIbefore\fP any attempt to create the corresponding
index.
.sp
\fIExample of failing to check whether the index data field exists:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
if (doc.min_length) {
    index(\(dqmin_length\(dq, doc.min_length, {\(dqstore\(dq: true});
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You might use the JavaScript \fBtypeof\fP function to implement the guard clause test. If
the field exists \fIand\fP has the expected type, the correct type name is returned, so the
guard clause test succeeds and it is safe to use the index function. If the field does
\fInot\fP exist, you would not get back the expected type of the field, therefore you would
not attempt to index the field.
.sp
JavaScript considers a result to be false if one of the following values is tested:
.INDENT 0.0
.IP \(bu 2
‘undefined’
.IP \(bu 2
null
.IP \(bu 2
The number +0
.IP \(bu 2
The number \-0
.IP \(bu 2
NaN (not a number)
.IP \(bu 2
“” (the empty string)
.UNINDENT
.sp
\fIUsing a guard clause to check whether the required data field exists, and holds a number,
before an attempt to index:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
if (typeof(doc.min_length) === \(aqnumber\(aq) {
    index(\(dqmin_length\(dq, doc.min_length, {\(dqstore\(dq: true});
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Use a generic guard clause test to ensure that the type of the candidate data field is
defined.
.sp
\fIExample of a ‘generic’ guard clause:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
if (typeof(doc.min_length) !== \(aqundefined\(aq) {
    // The field exists, and does have a type, so we can proceed to index using it.
    ...
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Analyzers
.sp
Analyzers are settings that define how to recognize terms within text. Analyzers can be
helpful if you need to
\fI\%index multiple languages\fP\&.
.sp
Here’s the list of generic analyzers, and their descriptions, that are supported by
search:
.INDENT 0.0
.IP \(bu 2
\fBclassic\fP \- The standard Lucene analyzer, circa release 3.1.
.IP \(bu 2
\fBemail\fP \- Like the \fBstandard\fP analyzer, but tries harder to
match an email address as a complete token.
.IP \(bu 2
\fBkeyword\fP \- Input is not tokenized at all.
.IP \(bu 2
\fBsimple\fP \- Divides text at non\-letters.
.IP \(bu 2
\fBstandard\fP \- The default analyzer. It implements the Word Break
rules from the \fI\%Unicode Text Segmentation algorithm\fP
.IP \(bu 2
\fBwhitespace\fP \- Divides text at white space boundaries.
.UNINDENT
.sp
\fIExample analyzer document:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dq_design/analyzer_example\(dq,
    \(dqindexes\(dq: {
        \(dqINDEX_NAME\(dq: {
            \(dqindex\(dq: \(dqfunction (doc) { ... }\(dq,
            \(dqanalyzer\(dq: \(dq$ANALYZER_NAME\(dq
        }
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Language\-specific analyzers
.sp
These analyzers omit common words in the specific language,
and many also \fI\%remove prefixes and suffixes\fP\&.
The name of the language is also the name of the analyzer. See
\fI\%package org.apache.lucene.analysis\fP
for more information.
.TS
center;
|l|l|.
_
T{
Language
T}	T{
Analyzer
T}
_
T{
\fBarabic\fP
T}	T{
org.apache.lucene.analysis.ar.ArabicAnalyzer
T}
_
T{
\fBarmenian\fP
T}	T{
org.apache.lucene.analysis.hy.ArmenianAnalyzer
T}
_
T{
\fBbasque\fP
T}	T{
org.apache.lucene.analysis.eu.BasqueAnalyzer
T}
_
T{
\fBbulgarian\fP
T}	T{
org.apache.lucene.analysis.bg.BulgarianAnalyzer
T}
_
T{
\fBbrazilian\fP
T}	T{
org.apache.lucene.analysis.br.BrazilianAnalyzer
T}
_
T{
\fBcatalan\fP
T}	T{
org.apache.lucene.analysis.ca.CatalanAnalyzer
T}
_
T{
\fBcjk\fP
T}	T{
org.apache.lucene.analysis.cjk.CJKAnalyzer
T}
_
T{
\fBchinese\fP
T}	T{
org.apache.lucene.analysis.cn.smart.SmartChineseAnalyzer
T}
_
T{
\fBczech\fP
T}	T{
org.apache.lucene.analysis.cz.CzechAnalyzer
T}
_
T{
\fBdanish\fP
T}	T{
org.apache.lucene.analysis.da.DanishAnalyzer
T}
_
T{
\fBdutch\fP
T}	T{
org.apache.lucene.analysis.nl.DutchAnalyzer
T}
_
T{
\fBenglish\fP
T}	T{
org.apache.lucene.analysis.en.EnglishAnalyzer
T}
_
T{
\fBfinnish\fP
T}	T{
org.apache.lucene.analysis.fi.FinnishAnalyzer
T}
_
T{
\fBfrench\fP
T}	T{
org.apache.lucene.analysis.fr.FrenchAnalyzer
T}
_
T{
\fBgerman\fP
T}	T{
org.apache.lucene.analysis.de.GermanAnalyzer
T}
_
T{
\fBgreek\fP
T}	T{
org.apache.lucene.analysis.el.GreekAnalyzer
T}
_
T{
\fBgalician\fP
T}	T{
org.apache.lucene.analysis.gl.GalicianAnalyzer
T}
_
T{
\fBhindi\fP
T}	T{
org.apache.lucene.analysis.hi.HindiAnalyzer
T}
_
T{
\fBhungarian\fP
T}	T{
org.apache.lucene.analysis.hu.HungarianAnalyzer
T}
_
T{
\fBindonesian\fP
T}	T{
org.apache.lucene.analysis.id.IndonesianAnalyzer
T}
_
T{
\fBirish\fP
T}	T{
org.apache.lucene.analysis.ga.IrishAnalyzer
T}
_
T{
\fBitalian\fP
T}	T{
org.apache.lucene.analysis.it.ItalianAnalyzer
T}
_
T{
\fBjapanese\fP
T}	T{
org.apache.lucene.analysis.ja.JapaneseAnalyzer
T}
_
T{
\fBjapanese\fP
T}	T{
org.apache.lucene.analysis.ja.JapaneseTokenizer
T}
_
T{
\fBlatvian\fP
T}	T{
org.apache.lucene.analysis.lv.LatvianAnalyzer
T}
_
T{
\fBnorwegian\fP
T}	T{
org.apache.lucene.analysis.no.NorwegianAnalyzer
T}
_
T{
\fBpersian\fP
T}	T{
org.apache.lucene.analysis.fa.PersianAnalyzer
T}
_
T{
\fBpolish\fP
T}	T{
org.apache.lucene.analysis.pl.PolishAnalyzer
T}
_
T{
\fBportuguese\fP
T}	T{
org.apache.lucene.analysis.pt.PortugueseAnalyzer
T}
_
T{
\fBromanian\fP
T}	T{
org.apache.lucene.analysis.ro.RomanianAnalyzer
T}
_
T{
\fBrussian\fP
T}	T{
org.apache.lucene.analysis.ru.RussianAnalyzer
T}
_
T{
\fBspanish\fP
T}	T{
org.apache.lucene.analysis.es.SpanishAnalyzer
T}
_
T{
\fBswedish\fP
T}	T{
org.apache.lucene.analysis.sv.SwedishAnalyzer
T}
_
T{
\fBthai\fP
T}	T{
org.apache.lucene.analysis.th.ThaiAnalyzer
T}
_
T{
\fBturkish\fP
T}	T{
org.apache.lucene.analysis.tr.TurkishAnalyzer
T}
_
.TE
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
The \fBjapanese\fP analyzer, org.apache.lucene.analysis.ja.JapaneseTokenizer,
includes DEFAULT_MODE and defaultStopTags.
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Language\-specific analyzers are optimized for the specified language. You cannot
combine a generic analyzer with a language\-specific analyzer. Instead, you might use a
\fI\%per field analyzer\fP to select different
analyzers for different fields within the documents.
.UNINDENT
.UNINDENT
.SS Per\-field analyzers
.sp
The \fBperfield\fP analyzer configures multiple analyzers for different fields.
.sp
\fIExample of defining different analyzers for different fields:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dq_design/analyzer_example\(dq,
    \(dqindexes\(dq: {
        \(dqINDEX_NAME\(dq: {
            \(dqanalyzer\(dq: {
                \(dqname\(dq: \(dqperfield\(dq,
                \(dqdefault\(dq: \(dqenglish\(dq,
                \(dqfields\(dq: {
                    \(dqspanish\(dq: \(dqspanish\(dq,
                    \(dqgerman\(dq: \(dqgerman\(dq
                }
            },
            \(dqindex\(dq: \(dqfunction (doc) { ... }\(dq
        }
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Stop words
.sp
Stop words are words that do not get indexed. You define them within a design document by
turning the analyzer string into an object.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
The \fBkeyword\fP, \fBsimple\fP, and \fBwhitespace\fP analyzers do not support stop words.
.UNINDENT
.UNINDENT
.sp
The default stop words for the \fBstandard\fP analyzer are included below:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\(dqa\(dq, \(dqan\(dq, \(dqand\(dq, \(dqare\(dq, \(dqas\(dq, \(dqat\(dq, \(dqbe\(dq, \(dqbut\(dq, \(dqby\(dq, \(dqfor\(dq, \(dqif\(dq,
\(dqin\(dq, \(dqinto\(dq, \(dqis\(dq, \(dqit\(dq, \(dqno\(dq, \(dqnot\(dq, \(dqof\(dq, \(dqon\(dq, \(dqor\(dq, \(dqsuch\(dq,
\(dqthat\(dq, \(dqthe\(dq, \(dqtheir\(dq, \(dqthen\(dq, \(dqthere\(dq, \(dqthese\(dq, \(dqthey\(dq, \(dqthis\(dq,
\(dqto\(dq, \(dqwas\(dq, \(dqwill\(dq, \(dqwith\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fIExample of defining non\-indexed (‘stop’) words:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dq_design/stop_words_example\(dq,
    \(dqindexes\(dq: {
        \(dqINDEX_NAME\(dq: {
            \(dqanalyzer\(dq: {
                \(dqname\(dq: \(dqportuguese\(dq,
                \(dqstopwords\(dq: [
                    \(dqfoo\(dq,
                    \(dqbar\(dq,
                    \(dqbaz\(dq
                ]
            },
            \(dqindex\(dq: \(dqfunction (doc) { ... }\(dq
        }
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Testing analyzer tokenization
.sp
You can test the results of analyzer tokenization by posting sample data to the
\fB_search_analyze\fP endpoint.
.sp
\fIExample of using HTTP to test the keyword analyzer:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST /_search_analyze HTTP/1.1
Content\-Type: application/json
{\(dqanalyzer\(dq:\(dqkeyword\(dq, \(dqtext\(dq:\(dqablanks@renovations.com\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fIExample of using the command line to test the keyword analyzer:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \(aqhttps://$HOST:5984/_search_analyze\(aq \-H \(aqContent\-Type: application/json\(aq
    \-d \(aq{\(dqanalyzer\(dq:\(dqkeyword\(dq, \(dqtext\(dq:\(dqablanks@renovations.com\(dq}\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fIResult of testing the keyword analyzer:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqtokens\(dq: [
        \(dqablanks@renovations.com\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fIExample of using HTTP to test the standard analyzer:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST /_search_analyze HTTP/1.1
Content\-Type: application/json
{\(dqanalyzer\(dq:\(dqstandard\(dq, \(dqtext\(dq:\(dqablanks@renovations.com\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fIExample of using the command line to test the standard analyzer:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \(aqhttps://$HOST:5984/_search_analyze\(aq \-H \(aqContent\-Type: application/json\(aq
    \-d \(aq{\(dqanalyzer\(dq:\(dqstandard\(dq, \(dqtext\(dq:\(dqablanks@renovations.com\(dq}\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fIResult of testing the standard analyzer:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqtokens\(dq: [
        \(dqablanks\(dq,
        \(dqrenovations.com\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Queries
.sp
After you create a search index, you can query it.
.INDENT 0.0
.IP \(bu 2
Issue a partition query using:
\fBGET /$DATABASE/_partition/$PARTITION_KEY/_design/$DDOC/_search/$INDEX_NAME\fP
.IP \(bu 2
Issue a global query using:
\fBGET /$DATABASE/_design/$DDOC/_search/$INDEX_NAME\fP
.UNINDENT
.sp
Specify your search by using the \fBquery\fP parameter.
.sp
\fIExample of using HTTP to query a partitioned index:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /$DATABASE/_partition/$PARTITION_KEY/_design/$DDOC/_search/$INDEX_NAME?include_docs=true&query=\(dq*:*\(dq&limit=1 HTTP/1.1
Content\-Type: application/json
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fIExample of using HTTP to query a global index:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /$DATABASE/_design/$DDOC/_search/$INDEX_NAME?include_docs=true&query=\(dq*:*\(dq&limit=1 HTTP/1.1
Content\-Type: application/json
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fIExample of using the command line to query a partitioned index:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl https://$HOST:5984/$DATABASE/_partition/$PARTITION_KEY/_design/$DDOC/
_search/$INDEX_NAME?include_docs=true\e&query=\(dq*:*\(dq\e&limit=1 \e
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fIExample of using the command line to query a global index:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl https://$HOST:5984/$DATABASE/_design/$DDOC/_search/$INDEX_NAME?
include_docs=true\e&query=\(dq*:*\(dq\e&limit=1 \e
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Query Parameters
.sp
A full list of query parameters can be found in the
\fI\%API Reference\fP\&.
.sp
You must enable \fI\%faceting\fP before you can use the
following parameters:
.INDENT 0.0
.IP \(bu 2
\fBcounts\fP
.IP \(bu 2
\fBdrilldown\fP
.IP \(bu 2
\fBranges\fP
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Do not combine the \fBbookmark\fP and \fBstale\fP options. These options
constrain the choice of shard replicas to use for the response. When used
together, the options might cause problems when contact is attempted
with replicas that are slow or not available.
.UNINDENT
.UNINDENT
.SS Relevance
.sp
When more than one result might be returned, it is possible for them to be sorted. By
default, the sorting order is determined by ‘relevance’.
.sp
Relevance is measured according to
\fI\%Apache Lucene Scoring\fP\&.
As an example, if you search a simple database for the word \fBexample\fP, two documents
might contain the word. If one document mentions the word \fBexample\fP 10 times, but the
second document mentions it only twice, then the first document is considered to be more
‘relevant’.
.sp
If you do not provide a \fBsort\fP parameter, relevance is used by default. The highest
scoring matches are returned first.
.sp
If you provide a \fBsort\fP parameter, then matches are returned in that order, ignoring
relevance.
.sp
If you want to use a \fBsort\fP parameter, and also include ordering by relevance in your
search results, use the special fields \fB\-<score>\fP or \fB<score>\fP within the \fBsort\fP
parameter.
.SS POSTing search queries
.sp
Instead of using the \fBGET\fP HTTP method, you can also use \fBPOST\fP\&. The main advantage of
\fBPOST\fP queries is that they can have a request body, so you can specify the request as a
JSON object. Each parameter in the query string of a \fBGET\fP request corresponds to a
field in the JSON object in the request body.
.sp
\fIExample of using HTTP to POST a search request:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST /db/_design/ddoc/_search/searchname HTTP/1.1
Content\-Type: application/json
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fIExample of using the command line to POST a search request:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \(aqhttps://$HOST:5984/db/_design/ddoc/_search/searchname\(aq \-X POST \-H \(aqContent\-Type: application/json\(aq \-d @search.json
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fIExample JSON document that contains a search request:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqq\(dq: \(dqindex:my query\(dq,
    \(dqsort\(dq: \(dqfoo\(dq,
    \(dqlimit\(dq: 3
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Query syntax
.sp
The CouchDB search query syntax is based on the
\fI\%Lucene syntax.\fP
Search queries take the form of \fBname:value\fP unless the name is omitted, in which case
they use the default field, as demonstrated in the following examples:
.sp
\fIExample search query expressions:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
// Birds
class:bird
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
// Animals that begin with the letter \(dql\(dq
l*
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
// Carnivorous birds
class:bird AND diet:carnivore
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
// Herbivores that start with letter \(dql\(dq
l* AND diet:herbivore
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
// Medium\-sized herbivores
min_length:[1 TO 3] AND diet:herbivore
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
// Herbivores that are 2m long or less
diet:herbivore AND min_length:[\-Infinity TO 2]
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
// Mammals that are at least 1.5m long
class:mammal AND min_length:[1.5 TO Infinity]
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
// Find \(dqMeles meles\(dq
latin_name:\(dqMeles meles\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
// Mammals who are herbivore or carnivore
diet:(herbivore OR omnivore) AND class:mammal
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
// Return all results
*:*
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Queries over multiple fields can be logically combined, and groups and fields can be
further grouped. The available logical operators are case\-sensitive and are \fBAND\fP,
\fB+\fP, \fBOR\fP, \fBNOT\fP and \fB\-\fP\&. Range queries can run over strings or numbers.
.sp
If you want a fuzzy search, you can run a query with \fB~\fP to find terms like the search
term. For instance, \fBlook~\fP finds the terms \fBbook\fP and \fBtook\fP\&.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
If the lower and upper bounds of a range query are both strings that
contain only numeric digits, the bounds are treated as numbers not as
strings. For example, if you search by using the query
\fBmod_date:[\(dq20170101\(dq TO \(dq20171231\(dq]\fP, the results include documents
for which \fBmod_date\fP is between the numeric values 20170101 and
20171231, not between the strings “20170101” and “20171231”.
.UNINDENT
.UNINDENT
.sp
You can alter the importance of a search term by adding \fB^\fP and a positive number. This
alteration makes matches containing the term more or less relevant, proportional to the
power of the boost value. The default value is 1, which means no increase or decrease in
the strength of the match. A decimal value of 0 \- 1 reduces importance. making the match
strength weaker. A value greater than one increases importance, making the match strength
stronger.
.sp
Wildcard searches are supported, for both single (\fB?\fP) and multiple (\fB*\fP) character
searches. For example, \fBdat?\fP would match \fBdate\fP and \fBdata\fP, whereas \fBdat*\fP would
match \fBdate\fP, \fBdata\fP, \fBdatabase\fP, and \fBdates\fP\&. Wildcards must come after the
search term.
.sp
Use \fB*:*\fP to return all results.
.sp
If the search query does \fInot\fP specify the \fB\(dqgroup_field\(dq\fP argument, the response
contains a bookmark. If this bookmark is later provided as a URL parameter, the response
skips the rows that were seen already, making it quick and easy to get the next set of
results.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
The response never includes a bookmark if the \fB\(dqgroup_field\(dq\fP
parameter is included in the search query.
See \fI\%group_field parameter\fP\&.
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
The \fBgroup_field\fP, \fBgroup_limit\fP, and \fBgroup_sort\fP options
are only available when making global queries.
.UNINDENT
.UNINDENT
.sp
The following characters require escaping if you want to search on them:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
+ \- && || ! ( ) { } [ ] ^ \(dq ~ * ? : \e /
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
To escape one of these characters, use a preceding backslash character (\fB\e\fP).
.sp
The response to a search query contains an \fBorder\fP field for each of the results. The
\fBorder\fP field is an array where the first element is the field or fields that are
specified in the \fBsort\fP parameter. See the
\fI\%sort parameter\fP\&. If no \fBsort\fP parameter is included
in the query, then the \fBorder\fP field contains the \fI\%Lucene relevance score\fP\&. If you use the ‘sort by distance’
feature as described in \fI\%geographical searches\fP,
then the first element is the distance from a point. The distance is measured by using
either kilometers or miles.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
The second element in the order array can be ignored.
It is used for troubleshooting purposes only.
.UNINDENT
.UNINDENT
.SS Faceting
.sp
CouchDB Search also supports faceted searching, enabling discovery of aggregate
information about matches quickly and easily. You can match all documents by using the
special \fB?q=*:*\fP query syntax, and use the returned facets to refine your query. To
indicate that a field must be indexed for faceted queries, set \fB{\(dqfacet\(dq: true}\fP in its
options.
.sp
\fIExample of search query, specifying that faceted search is enabled:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    index(\(dqtype\(dq, doc.type, {\(dqfacet\(dq: true});
    index(\(dqprice\(dq, doc.price, {\(dqfacet\(dq: true});
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
To use facets, all the documents in the index must include all the fields that have
faceting enabled. If your documents do not include all the fields, you receive a
\fBbad_request\fP error with the following reason, “The \fBfield_name\fP does not exist.” If
each document does not contain all the fields for facets, create separate indexes for each
field. If you do not create separate indexes for each field, you must include only
documents that contain all the fields. Verify that the fields exist in each document by
using a single \fBif\fP statement.
.sp
\fIExample if statement to verify that the required fields exist in each document:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
if (typeof doc.town == \(dqstring\(dq && typeof doc.name == \(dqstring\(dq) {
    index(\(dqtown\(dq, doc.town, {facet: true});
    index(\(dqname\(dq, doc.name, {facet: true});
   }
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Counts
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
The \fBcounts\fP option is only available when making global queries.
.UNINDENT
.UNINDENT
.sp
The \fBcounts\fP facet syntax takes a list of fields, and returns the number of query
results for each unique value of each named field.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
The \fBcount\fP operation works only if the indexed values are strings.
The indexed values cannot be mixed types. For example,
if 100 strings are indexed, and one number,
then the index cannot be used for \fBcount\fP operations.
You can check the type by using the \fBtypeof\fP operator, and convert it
by using the \fBparseInt\fP,
\fBparseFloat\fP, or \fB\&.toString()\fP functions.
.UNINDENT
.UNINDENT
.sp
\fIExample of a query using the counts facet syntax:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
?q=*:*&counts=[\(dqtype\(dq]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fIExample response after using of the counts facet syntax:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqtotal_rows\(dq:100000,
    \(dqbookmark\(dq:\(dqg...\(dq,
    \(dqrows\(dq:[...],
    \(dqcounts\(dq:{
        \(dqtype\(dq:{
            \(dqsofa\(dq: 10,
            \(dqchair\(dq: 100,
            \(dqlamp\(dq: 97
        }
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Drilldown
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
The \fBdrilldown\fP option is only available when making global queries.
.UNINDENT
.UNINDENT
.sp
You can restrict results to documents with a dimension equal to the specified label.
Restrict the results by adding \fBdrilldown=[\(dqdimension\(dq,\(dqlabel\(dq]\fP to a search query. You
can include multiple \fBdrilldown\fP parameters to restrict results along multiple
dimensions.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /things/_design/inventory/_search/fruits?q=*:*&drilldown=[\(dqstate\(dq,\(dqold\(dq]&drilldown=[\(dqitem\(dq,\(dqapple\(dq]&include_docs=true HTTP/1.1
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
For better language interoperability, you can achieve the same by supplying a list of lists:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /things/_design/inventory/_search/fruits?q=*:*&drilldown=[[\(dqstate\(dq,\(dqold\(dq],[\(dqitem\(dq,\(dqapple\(dq]]&include_docs=true HTTP/1.1
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You can also supply a list of lists for \fBdrilldown\fP in bodies of POST requests.
.sp
Note that, multiple values for a single key in a \fBdrilldown\fP means an
\fBOR\fP relation between them and there is an \fBAND\fP relation between multiple keys.
.sp
Using a \fBdrilldown\fP parameter is similar to using \fBkey:value\fP in the \fBq\fP parameter,
but the \fBdrilldown\fP parameter returns values that the analyzer might skip.
.sp
For example, if the analyzer did not index a stop word like \fB\(dqa\(dq\fP, using \fBdrilldown\fP
returns it when you specify \fBdrilldown=[\(dqkey\(dq,\(dqa\(dq]\fP\&.
.SS Ranges
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
The \fBranges\fP option is only available when making global queries.
.UNINDENT
.UNINDENT
.sp
The \fBrange\fP facet syntax reuses the standard Lucene syntax for ranges to return counts
of results that fit into each specified category. Inclusive range queries are denoted by
brackets (\fB[\fP, \fB]\fP). Exclusive range queries are denoted by curly brackets (\fB{\fP,
\fB}\fP).
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
The \fBrange\fP operation works only if the indexed values are numbers. The indexed
values cannot be mixed types. For example, if 100 strings are indexed, and one number,
then the index cannot be used for \fBrange\fP operations. You can check the type by
using the \fBtypeof\fP operator, and convert it by using the \fBparseInt\fP,
\fBparseFloat\fP, or \fB\&.toString()\fP functions.
.UNINDENT
.UNINDENT
.sp
\fIExample of a request that uses faceted search for matching ranges:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
?q=*:*&ranges={\(dqprice\(dq:{\(dqcheap\(dq:\(dq[0 TO 100]\(dq,\(dqexpensive\(dq:\(dq{100 TO Infinity}\(dq}}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fIExample results after a ranges check on a faceted search:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqtotal_rows\(dq:100000,
    \(dqbookmark\(dq:\(dqg...\(dq,
    \(dqrows\(dq:[...],
    \(dqranges\(dq: {
        \(dqprice\(dq: {
            \(dqexpensive\(dq: 278682,
            \(dqcheap\(dq: 257023
        }
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Geographical searches
.sp
In addition to searching by the content of textual fields, you can also sort your results
by their distance from a geographic coordinate using Lucene’s built\-in geospatial
capabilities.
.sp
To sort your results in this way, you must index two numeric fields, representing the
longitude and latitude.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
You can also sort your results by their distance from a geographic coordinate
using Lucene’s built\-in geospatial capabilities.
.UNINDENT
.UNINDENT
.sp
You can then query by using the special \fB<distance...>\fP sort field, which takes five
parameters:
.INDENT 0.0
.IP \(bu 2
Longitude field name: The name of your longitude field (\fBmylon\fP in the example).
.IP \(bu 2
Latitude field name: The name of your latitude field (\fBmylat\fP in the example).
.IP \(bu 2
Longitude of origin: The longitude of the place you want to sort by distance from.
.IP \(bu 2
Latitude of origin: The latitude of the place you want to sort by distance from.
.IP \(bu 2
Units: The units to use: \fBkm\fP for kilometers or \fBmi\fP for miles.
The distance is returned in the order field.
.UNINDENT
.sp
You can combine sorting by distance with any other search query, such as range searches on
the latitude and longitude, or queries that involve non\-geographical information.
.sp
That way, you can search in a bounding box, and narrow down the search with extra
criteria.
.sp
\fIExample geographical data:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqname\(dq:\(dqAberdeen, Scotland\(dq,
    \(dqlat\(dq:57.15,
    \(dqlon\(dq:\-2.15,
    \(dqtype\(dq:\(dqcity\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fIExample of a design document that contains a search index for the geographic data:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    if (doc.type && doc.type == \(aqcity\(aq) {
        index(\(aqcity\(aq, doc.name, {\(aqstore\(aq: true});
        index(\(aqlat\(aq, doc.lat, {\(aqstore\(aq: true});
        index(\(aqlon\(aq, doc.lon, {\(aqstore\(aq: true});
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fIAn example of using HTTP for a query that sorts cities in the northern hemisphere by
their distance to New York:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /examples/_design/cities\-designdoc/_search/cities?q=lat:[0+TO+90]&sort=\(dq<distance,lon,lat,\-74.0059,40.7127,km>\(dq HTTP/1.1
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fIAn example of using the command line for a query that sorts cities in the northern
hemisphere by their distance to New York:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \(aqhttps://$HOST:5984/examples/_design/cities\-designdoc/_search/cities?q=lat:[0+TO+90]&sort=\(dq<distance,lon,lat,\-74.0059,40.7127,km>\(dq\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fIExample (abbreviated) response, containing a list of northern hemisphere
cities sorted by distance to New York:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqtotal_rows\(dq: 205,
    \(dqbookmark\(dq: \(dqg1A...XIU\(dq,
    \(dqrows\(dq: [
        {
            \(dqid\(dq: \(dqcity180\(dq,
            \(dqorder\(dq: [
                8.530665755719783,
                18
            ],
            \(dqfields\(dq: {
                \(dqcity\(dq: \(dqNew York, N.Y.\(dq,
                \(dqlat\(dq: 40.78333333333333,
                \(dqlon\(dq: \-73.96666666666667
            }
        },
        {
            \(dqid\(dq: \(dqcity177\(dq,
            \(dqorder\(dq: [
                13.756343205985946,
                17
            ],
            \(dqfields\(dq: {
                \(dqcity\(dq: \(dqNewark, N.J.\(dq,
                \(dqlat\(dq: 40.733333333333334,
                \(dqlon\(dq: \-74.16666666666667
            }
        },
        {
            \(dqid\(dq: \(dqcity178\(dq,
            \(dqorder\(dq: [
                113.53603438866077,
                26
            ],
            \(dqfields\(dq: {
                \(dqcity\(dq: \(dqNew Haven, Conn.\(dq,
                \(dqlat\(dq: 41.31666666666667,
                \(dqlon\(dq: \-72.91666666666667
            }
        }
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Highlighting search terms
.sp
Sometimes it is useful to get the context in which a search term was mentioned so that you
can display more emphasized results to a user.
.sp
To get more emphasized results, add the \fBhighlight_fields\fP parameter to the search
query. Specify the field names for which you would like excerpts, with the highlighted
search term returned.
.sp
By default, the search term is placed in \fB<em>\fP tags to highlight it, but the highlight
can be overridden by using the \fBhighlights_pre_tag\fP and \fBhighlights_post_tag\fP
parameters.
.sp
The length of the fragments is 100 characters by default. A different length can be
requested with the \fBhighlights_size\fP parameter.
.sp
The \fBhighlights_number\fP parameter controls the number of fragments that are returned,
and defaults to 1.
.sp
In the response, a \fBhighlights\fP field is added, with one subfield per field name.
.sp
For each field, you receive an array of fragments with the search term highlighted.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
For highlighting to work, store the field in the index by
using the \fBstore: true\fP option.
.UNINDENT
.UNINDENT
.sp
\fIExample of using HTTP to search with highlighting enabled:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /movies/_design/searches/_search/movies?q=movie_name:Azazel&highlight_fields=[\(dqmovie_name\(dq]&highlight_pre_tag=\(dq**\(dq&highlight_post_tag=\(dq**\(dq&highlights_size=30&highlights_number=2 HTTP/1.1
Authorization: ...
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fIExample of using the command line to search with
highlighting enabled:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \(dqhttps://$HOST:5984/movies/_design/searches/_search/movies?q=movie_name:Azazel&highlight_fields=\e[\e\(dqmovie_name\e\(dq\e]&highlight_pre_tag=\e\(dq**\e\(dq&highlight_post_tag=\e\(dq**\e\(dq&highlights_size=30&highlights_number=2
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fIExample of highlighted search results:\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqhighlights\(dq: {
        \(dqmovie_name\(dq: [
            \(dq on the Azazel Orient Express\(dq,
            \(dq Azazel manuals, you\(dq
        ]
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fINote\fP: Previously, the functionality provided by CouchDB’s design documents,
in combination with document attachments, was referred to as “CouchApps.” The
general principle was that entire web applications could be hosted in CouchDB,
without need for an additional application server.
.sp
Use of CouchDB as a combined standalone database and application server is no
longer recommended. There are significant limitations to a pure CouchDB web
server application stack, including but not limited to: fully\-fledged
fine\-grained security, robust templating and scaffolding, complete developer
tooling, and most importantly, a thriving ecosystem of developers, modules and
frameworks to choose from.
.sp
The developers of CouchDB believe that web developers should pick “the right
tool for the right job”. Use CouchDB as your database layer, in conjunction
with any number of other server\-side web application frameworks, such as the
entire Node.JS ecosystem, Python’s Django and Flask, PHP’s Drupal, Java’s
Apache Struts, and more.
.SH BEST PRACTICES
.sp
In this chapter, we present some of the best ways to use Apache CouchDB. These
usage patterns reflect many years of real\-world use. We hope that these will
jump\-start your next project, or improve the performance of your current
system.
.SS Document Design Considerations
.sp
When designing your database, and your document structure, there are a number of
best practices to take into consideration. Especially for people accustomed to
relational databases, some of these techniques may be non\-obvious.
.SS Don’t rely on CouchDB’s auto\-UUID generation
.sp
While CouchDB will generate a unique identifier for the \fB_id\fP field of any doc
that you create, in most cases you are better off generating them yourself for
a few reasons:
.INDENT 0.0
.IP \(bu 2
If for any reason you miss the \fB200 OK\fP reply from CouchDB, and storing the
document is attempted again, you would end up with the same document content
stored under multiple \fB_id\fPs. This could easily happen with intermediary
proxies and cache systems that may not inform developers that the failed
transaction is being retried.
.IP \(bu 2
\fB_id\fPs are the only unique enforced value within CouchDB so you might
as well make use of this. CouchDB stores its documents in a B+ tree. Each
additional or updated document is stored as a leaf node, and may require
re\-writing intermediary and parent nodes. You may be able to take advantage of
sequencing your own ids more effectively than the automatically generated ids
if you can arrange them to be sequential yourself.
.UNINDENT
.SS Alternatives to auto\-incrementing sequences
.sp
Because of replication, as well as the distributed nature of CouchDB, it is not
practical to use auto\-incrementing sequences with CouchDB. These are often used
to ensure unique identifiers for each row in a database table. CouchDB generates
unique ids on its own and you can specify your own as well, so you don’t really
need a sequence here. If you use a sequence for something else, you will be
better off finding another way to express it in CouchDB in another way.
.SS Pre\-aggregating your data
.sp
If your intent for CouchDB is as a collect\-and\-report model, not a real\-time view,
you may not need to store a single document for every event you’re recording.
In this case, pre\-aggregating your data may be a good idea. You probably don’t
need 1000 documents per second if all you are trying to do is to track
summary statistics about those documents. This reduces the computational pressure
on CouchDB’s MapReduce engine(s), as well as reduces its storage requirements.
.sp
In this case, using an in\-memory store to summarize your statistical information,
then writing out to CouchDB every 10 seconds / 1 minute / whatever level of
granularity you need would greatly reduce the number of documents you’ll put in
your database.
.sp
Later, you can then further \fI\%decimate\fP your data by
walking the entire database and generating documents to be stored in a new
database with a lower level of granularity (say, 1 document a day). You can then
delete the older, more fine\-grained database when you’re done with it.
.SS Designing an application to work with replication
.sp
Whilst CouchDB includes replication and a conflict\-flagging mechanism, this is
not the whole story for building an application which replicates in a way which
users expect.
.sp
Here we consider a simple example of a bookmarks application. The idea is that
a user can replicate their own bookmarks, work with them on another machine,
and then synchronise their changes later.
.sp
Let’s start with a very simple definition of bookmarks: an ordered, nestable
mapping of name to URL. Internally the application might represent it like
this:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
  {\(dqname\(dq:\(dqWeather\(dq, \(dqurl\(dq:\(dqhttp://www.bbc.co.uk/weather\(dq},
  {\(dqname\(dq:\(dqNews\(dq, \(dqurl\(dq:\(dqhttp://news.bbc.co.uk/\(dq},
  {\(dqname\(dq:\(dqTech\(dq, \(dqbookmarks\(dq: [
    {\(dqname\(dq:\(dqRegister\(dq, \(dqurl\(dq:\(dqhttp://www.theregister.co.uk/\(dq},
    {\(dqname\(dq:\(dqCouchDB\(dq, \(dqurl\(dq:\(dqhttp://couchdb.apache.org/\(dq}
  ]}
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
It can then present the bookmarks menu and sub\-menus by traversing this structure.
.sp
Now consider this scenario: the user has a set of bookmarks on her PC, and then
replicates it to her laptop. On the laptop, she changes the News link to point
to CNN, renames “Register” to “The Register”, and adds a new link to slashdot
just after it. On the desktop, her husband deletes the Weather link, and adds a
new link to CNET in the Tech folder.
.sp
So after these changes, the laptop has:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
  {\(dqname\(dq:\(dqWeather\(dq, \(dqurl\(dq:\(dqhttp://www.bbc.co.uk/weather\(dq},
  {\(dqname\(dq:\(dqNews\(dq, \(dqurl\(dq:\(dqhttp://www.cnn.com/\(dq},
  {\(dqname\(dq:\(dqTech\(dq, \(dqbookmarks\(dq: [
    {\(dqname\(dq:\(dqThe Register\(dq, \(dqurl\(dq:\(dqhttp://www.theregister.co.uk/\(dq},
    {\(dqname\(dq:\(dqSlashdot\(dq, \(dqurl\(dq:\(dqhttp://www.slashdot.new/\(dq},
    {\(dqname\(dq:\(dqCouchDB\(dq, \(dqurl\(dq:\(dqhttp://couchdb.apache.org/\(dq}
  ]}
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
and the PC has:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
  {\(dqname\(dq:\(dqNews\(dq, \(dqurl\(dq:\(dqhttp://www.cnn.com/\(dq},
  {\(dqname\(dq:\(dqTech\(dq, \(dqbookmarks\(dq: [
    {\(dqname\(dq:\(dqRegister\(dq, \(dqurl\(dq:\(dqhttp://www.theregister.co.uk/\(dq},
    {\(dqname\(dq:\(dqCouchDB\(dq, \(dqurl\(dq:\(dqhttp://couchdb.apache.org/\(dq},
    {\(dqname\(dq:\(dqCNET\(dq, \(dqurl\(dq:\(dqhttp://news.cnet.com/\(dq}
  ]}
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Upon the next synchronisation, we want the expected merge to take place. That
is: links which were changed, added or deleted on one side are also changed,
added or deleted on the other side \- with no human intervention required unless
absolutely necessary.
.sp
We will also assume that both sides are doing a CouchDB “compact” operation
periodically, and are disconnected for more than this time before they
resynchronise.
.sp
All of the approaches below which allow automated merging of changes rely on
having some sort of history, back to the point where the replicas diverged.
.sp
CouchDB does not provide a mechanism for this itself. It stores arbitrary
numbers of old _ids for one document (trunk now has a mechanism for pruning the
_id history), for the purposes of replication. However it will not keep the
documents themselves through a compaction cycle, except where there are
conflicting versions of a document.
.sp
\fIDo not rely on the CouchDB revision history mechanism to help you build an
application\-level version history.\fP Its sole purpose is to ensure eventually
consistent replication between databases. It is up to you to maintain history
explicitly in whatever form makes sense for your application, and to prune it
to avoid excessive storage utilisation, whilst not pruning past the point where
live replicas last diverged.
.SS Approach 1: Single JSON doc
.sp
The above structure is already valid JSON, and so could be represented in
CouchDB just by wrapping it in an object and storing as a single document:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
  \(dqbookmarks\(dq:
  // ... same as above
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This makes life very easy for the application, as the ordering and nesting is
all taken care of. The trouble here is that on replication, only two sets of
bookmarks will be visible: example B and example C. One will be chosen as the
main revision, and the other will be stored as a conflicting revision.
.sp
At this point, the semantics are very unsatisfactory from the user’s point of
view. The best that can be offered is a choice saying “Which of these two sets
of bookmarks do you wish to keep: B or C?” However neither represents the
desired outcome. There is also insufficient data to be able to correctly merge
them, since the base revision A is lost.
.sp
This is going to be highly unsatisfactory for the user, who will have to apply
one set of changes again manually.
.SS Approach 2: Separate document per bookmark
.sp
An alternative solution is to make each field (bookmark) a separate document in
its own right. Adding or deleting a bookmark is then just a case of adding or
deleting a document, which will never conflict (although if the same bookmark
is added on both sides, then you will end up with two copies of it). Changing a
bookmark will only conflict if both sides made changes to the same one, and
then it is reasonable to ask the user to choose between them.
.sp
Since there will now be lots of small documents, you may either wish to keep a
completely separate database for bookmarks, or else add an attribute to
distinguish bookmarks from other kinds of document in the database. In the
latter case, a view can be made to return only bookmark documents.
.sp
Whilst replication is now fixed, care is needed with the “ordered” and
“nestable” properties of bookmarks.
.sp
For ordering, one suggestion is to give each item a floating\-point index, and
then when inserting an object between A and B, give it an index which is the
average of A and B’s indices. Unfortunately, this will fail after a while when
you run out of precision, and the user will be bemused to find that their most
recent bookmarks no longer remember the exact position they were put in.
.sp
A better way is to keep a string representation of index, which can grow as the
tree is subdivided. This will not suffer the above problem, but it may result
in this string becoming arbitrarily long after time. They could be renumbered,
but the renumbering operation could introduce a lot of conflicts, especially if
attempted by both sides independently.
.sp
For “nestable”, you can have a separate doc which represents a list of
bookmarks, and each bookmark can have a “belongs to” field which identifies the
list. It may be useful anyway to be able to have multiple top\-level bookmark
sets (Bob’s bookmarks, Jill’s bookmarks etc). Some care is needed when deleting
a list or sub\-list, to ensure that all associated bookmarks are also deleted,
otherwise they will become orphaned.
.sp
Building the entire bookmark set can be performed through the use of emitting
a compound key that describes the path to the document, then using group levels
to retrieve the position of the tree in the document. The following code
excerpt describes a tree of files, where the path to the file is stored in
the document under the \fB\(dqpath\(dq\fP key:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
// map function
function(doc) {
  if (doc.type === \(dqfile\(dq) {
    if (doc.path.substr(\-1) === \(dq/\(dq) {
      var raw_path = doc.path.slice(0, \-1);
    } else {
      var raw_path = doc.path;
    }
    emit (raw_path.split(\(aq/\(aq), 1);
  }
}

// reduce
_sum
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This will emit rows into the view of the form \fB[\(dqopt\(dq, \(dqcouchdb\(dq, \(dqetc\(dq,
\(dqlocal.ini\(dq]\fP for a \fBdoc.path\fP of \fB/opt/couchdb/etc/local.ini\fP\&. You can
then query a list of files in the \fB/opt/couchdb/etc\fP directory by specifying
a \fBstartkey\fP of \fB[\(dqopt\(dq, \(dqcouchdb\(dq, \(dqetc\(dq]\fP and an \fBendkey\fP of \fB[\(dqopt\(dq,
\(dqcouchdb\(dq, \(dqetc\(dq, {}]\fP\&.
.SS Approach 3: Immutable history / event sourcing
.sp
Another approach to consider is \fI\%Event Sourcing\fP or Command Logging, as
implemented in many NoSQL databases and as used in many \fI\%operational
transformation\fP
systems.
.sp
In this model, instead of storing individual bookmarks, you store records of
changes made \- “Bookmark added”, “Bookmark changed”, “Bookmark moved”,
“Bookmark deleted”. These are stored in an append\-only fashion. Since records
are never modified or deleted, only added to, there are never any replication
conflicts.
.sp
These records can also be stored as an array in a single CouchDB document.
Replication can cause a conflict, but in this case it is easy to resolve by
simply combining elements from the two arrays.
.sp
In order to see the full set of bookmarks, you need to start with a baseline
set (initially empty) and run all the change records since the baseline was
created; and/or you need to maintain a most\-recent version and update it with
changes not yet seen.
.sp
Care is needed after replication when merging together history from multiple
sources. You may get different results depending on how you order them \-
consider taking all A’s changes before B’s, taking all B’s before A’s, or
interleaving them (e.g. if each change has a timestamp).
.sp
Also, over time the amount of storage used can grow arbitrarily large, even if
the set of bookmarks itself is small. This can be controlled by moving the
baseline version forwards and then keeping only the changes after that point.
However, care is needed not to move the baseline version forward so far that
there are active replicas out there which last synchronised before that time,
as this may result in conflicts which cannot be resolved automatically.
.sp
If there is any uncertainty, it is best to present the user with a prompt to
assist with merging the content in the application itself.
.SS Approach 4: Keep historic versions explicitly
.sp
If you are going to keep a command log history, then it may be simpler just to
keep old revisions of the bookmarks list itself around. The intention is to
subvert CouchDB’s automatic behaviour of purging old revisions, by keeping
these revisions as separate documents.
.sp
You can keep a pointer to the ‘most current’ revision, and each revision can
point to its predecessor. On replication, merging can take place by diffing
each of the previous versions (in effect synthesising the command logs) back to
a common ancestor.
.sp
This is the sort of behaviour which revision control systems such as \fI\%Git\fP implement as a matter of routine, although generally
comparing text files line\-by\-line rather than comparing JSON objects
field\-by\-field.
.sp
Systems like Git will accumulate arbitrarily large amounts of history (although
they will attempt to compress it by packing multiple revisions so that only
their diffs are stored). With Git you can use “history rewriting” to remove old
history, but this may prohibit merging if history doesn’t go back far enough in
time.
.SS Adding client\-side security with a translucent database
.sp
Many applications do not require a thick layer of security at the server. It is
possible to use a modest amount of encryption and one\-way functions to obscure
the sensitive columns or key\-value pairs, a technique often called a
translucent database. (See \fI\%a description\fP\&.)
.sp
The simplest solutions use a one\-way function like SHA\-256 at the client to
scramble the name and password before storing the information.  This solution
gives the client control of the data in the database without requiring a thick
layer on the database to test each transaction. Some advantages are:
.INDENT 0.0
.IP \(bu 2
Only the client or someone with the knowledge of the name and password can compute
the value of SHA256 and recover the data.
.IP \(bu 2
Some columns are still left in the clear, an advantage for computing aggregated
statistics.
.IP \(bu 2
Computation of SHA256 is left to the client side computer which usually has cycles
to spare.
.IP \(bu 2
The system prevents server\-side snooping by insiders and any attacker who might
penetrate the OS or any of the tools running upon it.
.UNINDENT
.sp
There are limitations:
.INDENT 0.0
.IP \(bu 2
There is no root password. If the person forgets their name and password, their
access is gone forever. This limits its use to databases that can continue by
issuing a new user name and password.
.UNINDENT
.sp
There are many variations on this theme detailed in the book \fI\%Translucent Databases\fP, including:
.INDENT 0.0
.IP \(bu 2
Adding a backdoor with public\-key cryptography.
.IP \(bu 2
Adding a second layer with steganography.
.IP \(bu 2
Dealing with typographical errors.
.IP \(bu 2
Mixing encryption with one\-way functions.
.UNINDENT
.SS Document submission using HTML Forms
.sp
It is possible to write to a CouchDB document directly from an HTML form by
using a document \fI\%update function\fP\&. Here’s how:
.SS The HTML form
.sp
First, write an HTML form. Here’s a simple “Contact Us” form excerpt:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
<form action=\(dq/dbname/_design/ddocname/_update/contactform\(dq method=\(dqpost\(dq>
    <div>
        <label for=\(dqname\(dq>Name:</label>
        <input type=\(dqtext\(dq id=\(dqname\(dq name=\(dqname\(dq />
    </div>
    <div>
        <label for=\(dqmail\(dq>Email:</label>
        <input type=\(dqtext\(dq id=\(dqmail\(dq name=\(dqemail\(dq />
    </div>
    <div>
        <label for=\(dqmsg\(dq>Message:</label>
        <textarea id=\(dqmsg\(dq name=\(dqmessage\(dq></textarea>
    </div>
</form>
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Customize the \fB/dbname/_design/ddocname/_update/contactform\fP portion of the
form action URL to reflect the exact path to your database, design document
and update function (see below).
.sp
As CouchDB
\fI\%no longer recommends the use of CouchDB\-hosted web applications\fP
, you may want to use a reverse proxy to expose CouchDB as a subdirectory of
your web application.  If so, add that prefix to the \fBaction\fP destination in
the form.
.sp
Another option is to alter CouchDB’s \fI\%CORS\fP settings and use a
cross\-domain POST. \fIBe sure you understand all security implications before
doing this!\fP
.SS The update function
.sp
Then, write an update function. This is the server\-side JavaScript function
that will receive the \fBPOST\fP\-ed data.
.sp
The first argument to the function will be the document that is being processed
(if it exists). Because we are using \fBPOST\fP and not \fBPUT\fP, this should be
empty in our scenario \- but we should check to be sure. The \fBPOST\fP\-ed data
will be passed as the second parameter to the function, along with any query
parameters and the full request headers.
.sp
Here’s a sample handler that extracts the form data, generates a document _id
based on the email address and timestamp, and saves the document. It then
returns a JSON success response back to the browser.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc, req) {

    if (doc) {
        return [doc, toJSON({\(dqerror\(dq: \(dqrequest already filed\(dq})]
    }

    if !(req.form && req.form.email) {
        return [null, toJSON({\(dqerror\(dq: \(dqincomplete form\(dq})]
    }

    var date = new Date()
    var newdoc = req.form
    newdoc._id = req.form.email + \(dq_\(dq + date.toISOString()

    return [newdoc, toJSON({\(dqsuccess\(dq:\(dqok\(dq})]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Place the above function in your design document under the \fBupdates\fP key.
.sp
Note that this function does not attempt any sort of input validation or
sanitization. That is best handled by a
\fI\%validate document update function\fP instead.  (A “VDU” will
validate any document written to the database, not just those that use your
update function.)
.sp
If the first element passed to \fBreturn\fP is a document, the HTTP response
headers will include \fBX\-Couch\-Id\fP, the \fB_id\fP value for the newly created
document, and \fBX\-Couch\-Update\-NewRev\fP, the \fB_rev\fP value for the newly
created document. This is handy if your client\-side code wants to access or
update the document in a future call.
.SS Example output
.sp
Here’s the worked sample above, using \fBcurl\fP to simulate the form POST.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \-X PUT localhost:5984/testdb/_design/myddoc \-d \(aq{ \(dqupdates\(dq: { \(dqcontactform\(dq: \(dqfunction(doc, req) { ... }\(dq } }\(aq
{\(dqok\(dq:true,\(dqid\(dq:\(dq_design/myddoc\(dq,\(dqrev\(dq:\(dq1\-2a2b0951fcaf7287817573b03bba02ed\(dq}

$ curl \-\-data \(dqname=Lin&email=lin@example.com&message=I Love CouchDB\(dq http://localhost:5984/testdb/_design/myddoc/_update/contactform
*   Trying 127.0.0.1...
* TCP_NODELAY set
* Connected to localhost (127.0.0.1) port 5984 (#1)
> POST /testdb/_design/myddoc/_update/contactform HTTP/1.1
> Host: localhost:5984
> User\-Agent: curl/7.59.0
> Accept: */*
> Content\-Length: 53
> Content\-Type: application/x\-www\-form\-urlencoded
>
* upload completely sent off: 53 out of 53 bytes
< HTTP/1.1 201 Created
< Content\-Length: 16
< Content\-Type: text/html; charset=utf\-8
< Date: Thu, 05 Apr 2018 19:56:42 GMT
< Server: CouchDB/2.2.0\-948a1311c (Erlang OTP/19)
< X\-Couch\-Id: lin%40example.com_2018\-04\-05T19:51:22.278Z
< X\-Couch\-Request\-ID: 03a5f4fbe0
< X\-Couch\-Update\-NewRev: 1\-34483732407fcc6cfc5b60ace48b9da9
< X\-CouchDB\-Body\-Time: 0
<
* Connection #1 to host localhost left intact
{\(dqsuccess\(dq:\(dqok\(dq}

$ curl http://localhost:5984/testdb/lin\e@example.com_2018\-04\-05T19:51:22.278Z
{\(dq_id\(dq:\(dqlin@example.com_2018\-04\-05T19:51:22.278Z\(dq,\(dq_rev\(dq:\(dq1\-34483732407fcc6cfc5b60ace48b9da9\(dq,\(dqname\(dq:\(dqLin\(dq,\(dqemail\(dq:\(dqlin@example.com\(dq,\(dqmessage\(dq:\(dqI Love CouchDB\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Using an ISO Formatted Date for Document IDs
.sp
The \fI\%ISO 8601 date standard\fP describes a useful
scheme for representing a date string in a Year\-Month\-DayTHour:Minute:Second.microsecond
format. For time\-bound documents in a CouchDB database this can be a very handy way to
create a unique identifier, since JavaScript can directly use it to create a Date object.
Using this sample \fBmap\fP function:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
  var dt = new Date(doc._id);
  emit([dt.getDate(), doc.widget], 1);
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
simply use \fBgroup_level\fP to zoom in on whatever time you wish to use.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X GET \(dqhttp://localhost:5984/transactions/_design/widget_count/_view/toss?group_level=1\(dq

{\(dqrows\(dq:[
{\(dqkey\(dq:[20],\(dqvalue\(dq:10},
{\(dqkey\(dq:[21],\(dqvalue\(dq:20}
]}

curl \-X GET \(dqhttp://localhost:5984/transactions/_design/widget_count/_view/toss?group_level=2\(dq

{\(dqrows\(dq:[
{\(dqkey\(dq:[20,widget],\(dqvalue\(dq:10},
{\(dqkey\(dq:[21,widget],\(dqvalue\(dq:10},
{\(dqkey\(dq:[21,thing],\(dqvalue\(dq:10}
]}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Another method is using \fBparseint()\fP and \fBdatetime.substr()\fP to cut out useful values
for a return key:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function (doc) {
  var datetime = doc._id;
  var year = parseInt(datetime.substr(0, 4));
  var month = parseInt(datetime.substr(5, 2), 10);
  var day = parseInt(datetime.substr(8, 2), 10);
  var hour = parseInt(datetime.substr(11, 2), 10);
  var minute = parseInt(datetime.substr(14, 2), 10);
  emit([doc.widget, year, month, day, hour, minute], 1);
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS JavaScript development tips
.sp
Working with Apache CouchDB’s JavaScript environment is a lot different than
working with traditional JavaScript development environments. Here are some
tips and tricks that will ease the difficulty.
.INDENT 0.0
.IP \(bu 2
Check the JavaScript version being used by your CouchDB. As of version 3.2.0,
this is reported in the output of \fBGET /_node/_local/_versions\fP\&. Prior to
version 3.2.0, you will   need to see which JavaScript library is installed by
your CouchDB binary   distribution, provided by your operating system, or
linked by your compilation process.
.sp
If the version is 1.8.5, this is an \fBold\fP version of JavaScript, only
supporting the ECMA\-262 5th edition (“ES5”) of the language. ES6/2015 and
newer constructs \fBcannot\fP be used.
.sp
Fortunately, there are many tools available for transpiling modern JavaScript
into code compatible with older JS engines. The \fI\%Babel Project website\fP, for example, offers an in\-browser text editor
which transpiles JavaScript in real\-time. Configuring CouchDB\-compatibility
is as easy as enabling the \fBENV PRESET\fP option, and typing “firefox 4.0”
into the \fITARGETS\fP field.
.IP \(bu 2
The \fBlog()\fP function will log output to the CouchDB log file or stream.
You can log strings, objects, and arrays directly, without first converting
to JSON.  Use this in conjunction with a local CouchDB instance for best
results.
.IP \(bu 2
Be sure to guard all document accesses to avoid exceptions when fields
or subfields are missing: \fBif (doc && doc.myarray && doc.myarray.length)...\fP
.UNINDENT
.SS View recommendations
.sp
Here are some tips and tricks for working with CouchDB’s (JavaScript\-based)
views.
.SS Deploying a view change in a live environment
.sp
It is possible to change the definition of a view, build the index, then make
those changes go live without causing downtime for your application. The trick
to making this work is that CouchDB’s JavaScript view index files are based on
the contents of the design document \- not its name, \fB_id\fP or revision. This
means that two design documents with identical view code will share the same
on\-disk view index files.
.sp
Here is a worked example, assuming your \fB/db/_design/ddoc\fP needs to be updated.
.INDENT 0.0
.IP 1. 3
Upload the old design doc to \fB/db/_design/ddoc\-old\fP (or copy the document)
if you want an easy way to rollback in case of problems. The \fBddoc\-old\fP
document will reference the same view indexes already built for \fB_design/ddoc\fP\&.
.IP 2. 3
Upload the updated design doc to \fB/db/_design/ddoc\-new\fP\&.
.IP 3. 3
Query a view in the new design document to trigger secondary index generation.
You can track the indexing progress via the \fB/_active_tasks\fP endpoint, or
through the \fI\%Fauxton\fP web interface.
.IP 4. 3
When the index is done being built, re\-upload the updated design document to
\fB/db/_design/ddoc\fP (or copy the document). The \fBddoc\fP document will now
reference the same view indexes already built for \fB_design/ddoc\-new\fP\&.
.IP 5. 3
Delete \fB/db/_design/ddoc\-new\fP and/or \fB/db/_design/ddoc\-old\fP at your
discretion. Don’t forget to trigger \fI\%Views cleanup\fP to reclaim
disk space after deleting \fBddoc\-old\fP\&.
.UNINDENT
.sp
The \fI\%COPY\fP HTTP verb can be used to copy the design document
with a single command:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X COPY <URL of source design document> \-H \(dqDestination: <ID of destination design document>\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Reverse Proxies
.SS Reverse proxying with HAProxy
.sp
CouchDB recommends the use of \fI\%HAProxy\fP as a load balancer and reverse proxy.
The team’s experience with using it in production has shown it to be superior
for configuration and monitoring capabilities, as well as overall performance.
.sp
CouchDB’s sample haproxy configuration is present in the \fI\%code repository\fP and
release tarball as \fBrel/haproxy.cfg\fP\&. It is included below. This example
is for a 3 node CouchDB cluster:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
global
    maxconn 512
    spread\-checks 5

defaults
    mode http
    log global
    monitor\-uri /_haproxy_health_check
    option log\-health\-checks
    option httplog
    balance roundrobin
    option forwardfor
    option redispatch
    retries 4
    option http\-server\-close
    timeout client 150000
    timeout server 3600000
    timeout connect 500

    stats enable
    stats uri /_haproxy_stats
    # stats auth admin:admin # Uncomment for basic auth

frontend http\-in
     # This requires HAProxy 1.5.x
     # bind *:$HAPROXY_PORT
     bind *:5984
     default_backend couchdbs

backend couchdbs
    option httpchk GET /_up
    http\-check disable\-on\-404
    server couchdb1 x.x.x.x:5984 check inter 5s
    server couchdb2 x.x.x.x:5984 check inter 5s
    server couchdb2 x.x.x.x:5984 check inter 5s
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Reverse proxying with nginx
.SS Basic Configuration
.sp
Here’s a basic excerpt from an nginx config file in
\fB<nginx config directory>/sites\-available/default\fP\&. This will proxy all
requests from \fBhttp://domain.com/...\fP to \fBhttp://localhost:5984/...\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
location / {
    proxy_pass http://localhost:5984;
    proxy_redirect off;
    proxy_buffering off;
    proxy_set_header Host $host;
    proxy_set_header X\-Forwarded\-For $proxy_add_x_forwarded_for;
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Proxy buffering \fBmust\fP be disabled, or continuous replication will not
function correctly behind nginx.
.SS Reverse proxying CouchDB in a subdirectory with nginx
.sp
It can be useful to provide CouchDB as a subdirectory of your overall domain,
especially to avoid CORS concerns. Here’s an excerpt of a basic nginx
configuration that proxies the URL \fBhttp://domain.com/couchdb\fP to
\fBhttp://localhost:5984\fP so that requests appended to the subdirectory, such
as \fBhttp://domain.com/couchdb/db1/doc1\fP are proxied to
\fBhttp://localhost:5984/db1/doc1\fP\&.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
location /couchdb {
    rewrite ^ $request_uri;
    rewrite ^/couchdb/(.*) /$1 break;
    proxy_pass http://localhost:5984$uri;
    proxy_redirect off;
    proxy_buffering off;
    proxy_set_header Host $host;
    proxy_set_header X\-Forwarded\-For $proxy_add_x_forwarded_for;
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Session based replication is default functionality since CouchDB 2.3.0. To enable session based replication with reverse proxied CouchDB in a subdirectory.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
location /_session {
    proxy_pass http://localhost:5984/_session;
    proxy_redirect off;
    proxy_buffering off;
    proxy_set_header Host $host;
    proxy_set_header X\-Forwarded\-For $proxy_add_x_forwarded_for;
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Authentication with nginx as a reverse proxy
.sp
Here’s a sample config setting with basic authentication enabled, placing
CouchDB in the \fB/couchdb\fP subdirectory:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
location /couchdb {
    auth_basic \(dqRestricted\(dq;
    auth_basic_user_file htpasswd;
    rewrite /couchdb/(.*) /$1 break;
    proxy_pass http://localhost:5984;
    proxy_redirect off;
    proxy_buffering off;
    proxy_set_header Host $host;
    proxy_set_header X\-Forwarded\-For $proxy_add_x_forwarded_for;
    proxy_set_header Authorization \(dq\(dq;
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This setup leans entirely on nginx performing authorization, and forwarding
requests to CouchDB with no authentication (with CouchDB in Admin Party mode),
which isn’t sufficient in CouchDB 3.0 anymore as Admin Party has been removed.
You’d need to at the very least hard\-code user credentials into this version
with headers.
.sp
For a better solution, see \fI\%Proxy Authentication\fP\&.
.SS SSL with nginx
.sp
In order to enable SSL, just enable the nginx SSL module, and add another
proxy header:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
ssl on;
ssl_certificate PATH_TO_YOUR_PUBLIC_KEY.pem;
ssl_certificate_key PATH_TO_YOUR_PRIVATE_KEY.key;
ssl_protocols SSLv3;
ssl_session_cache shared:SSL:1m;

location / {
    proxy_pass http://localhost:5984;
    proxy_redirect off;
    proxy_set_header Host $host;
    proxy_buffering off;
    proxy_set_header X\-Forwarded\-For $proxy_add_x_forwarded_for;
    proxy_set_header X\-Forwarded\-Ssl on;
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The \fBX\-Forwarded\-Ssl\fP header tells CouchDB that it should use the \fBhttps\fP
scheme instead of the \fBhttp\fP scheme. Otherwise, all CouchDB\-generated
redirects will fail.
.SS Reverse Proxying with Caddy 2
.sp
Caddy is \fBhttps\-by\-default\fP, and will automatically acquire, install,
activate and, when necessary, renew a trusted SSL certificate for you
\- all in the background.
Certificates are issued by the \fBLet’s Encrypt\fP certificate authority.
.SS Basic configuration
.sp
Here’s a basic excerpt from a Caddyfile in
\fB/etc/caddy/Caddyfile\fP\&. This will proxy all
requests from \fBhttp(s)://domain.com/...\fP to \fBhttp://localhost:5984/...\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
domain.com {

   reverse_proxy localhost:5984

}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Reverse proxying CouchDB in a subdirectory with Caddy 2
.sp
It can be useful to provide CouchDB as a subdirectory of your overall domain,
especially to avoid CORS concerns. Here’s an excerpt of a basic Caddy
configuration that proxies the URL \fBhttp(s)://domain.com/couchdb\fP to
\fBhttp://localhost:5984\fP so that requests appended to the subdirectory, such
as \fBhttp(s)://domain.com/couchdb/db1/doc1\fP are proxied to
\fBhttp://localhost:5984/db1/doc1\fP\&.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
domain.com {

    reverse_proxy /couchdb/* localhost:5984

}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Reverse proxying + load balancing for CouchDB clusters
.sp
Here’s a basic excerpt from a Caddyfile in
\fB/<path>/<to>/<site>/Caddyfile\fP\&. This will proxy and evenly distribute all
requests from \fBhttp(s)://domain.com/...\fP among 3 CouchDB cluster nodes
at \fBlocalhost:15984\fP, \fBlocalhost:25984\fP and \fBlocalhost:35984\fP\&.
.sp
Caddy will check the status, i.e. health, of each node every 5 seconds;
if a node goes down, Caddy will avoid proxying requests to that node until it
comes back online.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
domain.com {

    reverse_proxy http://localhost:15984 http://localhost:25984 http://localhost:35984 {
    lb_policy round_robin
    lb_try_interval 500ms

    health_interval 5s
    }

}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Authentication with Caddy 2 as a reverse proxy
.sp
Here’s a sample config setting with basic authentication enabled, placing
CouchDB in the \fB/couchdb\fP subdirectory:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
domain.com {

    basicauth /couchdb/* {
        couch_username couchdb_hashed_password_base64
    }

    reverse_proxy /couchdb/* localhost:5984

}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This setup leans entirely on nginx performing authorization, and forwarding
requests to CouchDB with no authentication (with CouchDB in Admin Party mode),
which isn’t sufficient in CouchDB 3.0 anymore as Admin Party has been removed.
You’d need to at the very least hard\-code user credentials into this version
with headers.
.sp
For a better solution, see \fI\%Proxy Authentication\fP\&.
.SS Reverse Proxying with Apache HTTP Server
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
As of this writing, there is no way to fully disable the buffering between
Apache HTTPD Server and CouchDB. This may present problems with continuous
replication. The Apache CouchDB team strongly recommend the use of an
alternative reverse proxy such as \fBhaproxy\fP or \fBnginx\fP, as described
earlier in this section.
.UNINDENT
.UNINDENT
.SS Basic Configuration
.sp
Here’s a basic excerpt for using a \fBVirtualHost\fP block config to use Apache
as a reverse proxy for CouchDB. You need at least to configure Apache with the
\fB\-\-enable\-proxy \-\-enable\-proxy\-http\fP options and use a version equal to or
higher than Apache 2.2.7 in order to use the \fBnocanon\fP option in the
\fBProxyPass\fP directive. The \fBProxyPass\fP directive adds the \fBX\-Forwarded\-For\fP
header needed by CouchDB, and the \fBProxyPreserveHost\fP directive ensures the
original client \fBHost\fP header is preserved.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
<VirtualHost *:80>
   ServerAdmin webmaster@dummy\-host.example.com
   DocumentRoot \(dq/opt/websites/web/www/dummy\(dq
   ServerName couchdb.localhost
   AllowEncodedSlashes On
   ProxyRequests Off
   KeepAlive Off
   <Proxy *>
      Order deny,allow
      Deny from all
      Allow from 127.0.0.1
   </Proxy>
   ProxyPass / http://localhost:5984 nocanon
   ProxyPassReverse / http://localhost:5984
   ProxyPreserveHost On
   ErrorLog \(dqlogs/couchdb.localhost\-error_log\(dq
   CustomLog \(dqlogs/couchdb.localhost\-access_log\(dq common
</VirtualHost>
.ft P
.fi
.UNINDENT
.UNINDENT
.SH INSTALLATION
.SS Installation on Unix\-like systems
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
CouchDB 3.0+ will not run without an admin user being created first.
Be sure to \fI\%create an admin user\fP before starting
CouchDB!
.UNINDENT
.UNINDENT
.SS Installation using the Apache CouchDB convenience binary packages
.sp
If you are running one of the following operating systems, the easiest way
to install CouchDB is to use the convenience binary packages:
.INDENT 0.0
.IP \(bu 2
CentOS/RHEL 7
.IP \(bu 2
CentOS/RHEL 8
.IP \(bu 2
Debian 10 (buster)
.IP \(bu 2
Debian 11 (bullseye)
.IP \(bu 2
Ubuntu 18.04 (bionic)
.IP \(bu 2
Ubuntu 20.04 (focal)
.UNINDENT
.sp
These RedHat\-style rpm packages and Debian\-style deb packages will install CouchDB at
\fB/opt/couchdb\fP and ensure CouchDB is run at system startup by the appropriate init
subsystem (SysV\-style initd or systemd).
.sp
The Debian\-style deb packages \fIalso\fP pre\-configure CouchDB as a standalone or clustered
node, prompt for the address to which it will bind, and a password for the admin user.
Responses to these prompts may be pre\-seeded using standard \fBdebconf\fP tools. Further
details are in the \fI\%README.Debian\fP file.
.sp
For distributions lacking a compatible SpiderMonkey library, Apache CouchDB
also provides packages for the 1.8.5 version.
.SS Enabling the Apache CouchDB package repository
.sp
\fBDebian or Ubuntu\fP: Run the following commands:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
sudo apt update && sudo apt install \-y curl apt\-transport\-https gnupg
curl https://couchdb.apache.org/repo/keys.asc | gpg \-\-dearmor | sudo tee /usr/share/keyrings/couchdb\-archive\-keyring.gpg >/dev/null 2>&1
source /etc/os\-release
echo \(dqdeb [signed\-by=/usr/share/keyrings/couchdb\-archive\-keyring.gpg] https://apache.jfrog.io/artifactory/couchdb\-deb/ ${VERSION_CODENAME} main\(dq \e
    | sudo tee /etc/apt/sources.list.d/couchdb.list >/dev/null
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBRedHat or CentOS\fP: Run the following commands:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
sudo yum install \-y yum\-utils
sudo yum\-config\-manager \-\-add\-repo https://couchdb.apache.org/repo/couchdb.repo
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Installing the Apache CouchDB packages
.sp
\fBDebian or Ubuntu\fP: Run the following commands:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
sudo apt update
sudo apt install \-y couchdb
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Debian/Ubuntu installs from binaries can be pre\-configured for single node or
clustered installations. For clusters, multiple nodes will still need to be
joined together and configured consistently across all machines; \fBfollow the\fP
\fI\%Cluster Setup\fP \fBwalkthrough\fP to complete the process.
.sp
\fBRedHat/CentOS\fP: Run the command:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
sudo yum install \-y couchdb
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Once installed, \fI\%create an admin user\fP by hand before
starting CouchDB, if your installer didn’t do this for you already.
.sp
You can now start the service.
.sp
\fBYour installation is not complete. Be sure to complete the\fP
\fI\%Setup\fP \fBsteps for a single node or clustered installation.\fP
.sp
\fBRelax!\fP CouchDB is installed and running.
.SS GPG keys used for signing the CouchDB repositories
.sp
As of 2021.04.25, the \fIrepository\fP signing key for both types of supported packages
is:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
pub   rsa8192 2015\-01\-19 [SC]
      390EF70BB1EA12B2773962950EE62FB37A00258D
uid           The Apache Software Foundation (Package repository signing key) <root@apache.org>
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
As of 2021.04.25, the \fIpackage\fP signing key (only used for \fBrpm\fP packages) is:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
pub   rsa4096 2017\-07\-28 [SC] [expires: 2022\-07\-27]
      2EC788AE3F239FA13E82D215CDE711289384AE37
uid           Joan Touzet (Apache Code Signing Key) <wohali@apache.org>
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
As of 2021.11.13, the \fIpackage\fP signing key (only used for \fBrpm\fP packages) is:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
pub   rsa4096 2019\-09\-05 [SC] [expires: 2039\-01\-02]
      0BD7A98499C4AB41C910EE65FC04DFBC9657A78E
uid           Nicolae Vatamaniuc <vatamane@apache.org>
uid           default <vatamane@gmail.com>
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
All are available from most popular GPG key servers. The \fBrpm\fP
signing keys should be listed in the \fI\%KEYS\fP list as well.
.SS Installation from source
.sp
The remainder of this document describes the steps required to install CouchDB
directly from source code.
.sp
This guide, as well as the INSTALL.Unix document in the official tarball
release are the canonical sources of installation information. However, many
systems have gotchas that you need to be aware of. In addition, dependencies
frequently change as distributions update their archives.
.SS Dependencies
.sp
You should have the following installed:
.INDENT 0.0
.IP \(bu 2
\fI\%Erlang OTP (20.x >= 20.3.8.11, 21.x >= 21.2.3, 22.x >= 22.0.5, 23.x, 24.x)\fP
.IP \(bu 2
\fI\%ICU\fP
.IP \(bu 2
\fI\%OpenSSL\fP
.IP \(bu 2
\fI\%Mozilla SpiderMonkey (1.8.5, 60, 68, 78, 91)\fP
.IP \(bu 2
\fI\%GNU Make\fP
.IP \(bu 2
\fI\%GNU Compiler Collection\fP
.IP \(bu 2
\fI\%libcurl\fP
.IP \(bu 2
\fI\%help2man\fP
.IP \(bu 2
\fI\%Python (>=3.6) for docs and tests\fP
.IP \(bu 2
\fI\%Python Sphinx (>=1.1.3)\fP
.UNINDENT
.sp
You will only need libcurl if you plan to run the JavaScript test suite. And
help2man is only need if you plan on installing the CouchDB man pages.
Sphinx is only required for building the online documentation.
Documentation build can be disabled by adding the \fB\-\-disable\-docs\fP flag to
the \fBconfigure\fP script.
.SS Debian\-based Systems
.sp
You can install the dependencies by running:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
sudo apt\-get \-\-no\-install\-recommends \-y install \e
    build\-essential pkg\-config erlang \e
    libicu\-dev libmozjs185\-dev libcurl4\-openssl\-dev
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Be sure to update the version numbers to match your system’s available
packages.
.SS RedHat\-based (Fedora, CentOS, RHEL) Systems
.sp
You can install the dependencies by running:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
sudo yum install autoconf autoconf\-archive automake \e
    curl\-devel erlang\-asn1 erlang\-erts erlang\-eunit gcc\-c++ \e
    erlang\-os_mon erlang\-xmerl erlang\-erl_interface help2man \e
    libicu\-devel libtool perl\-Test\-Harness
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Warning: To build a release for CouchDB the erlang\-reltool package is required,
yet on CentOS/RHEL this package depends on erlang\-wx which pulls in wxGTK
and several X11 libraries. If CouchDB is being built on a console only
server it might be a good idea to install this in a separate step to the
rest of the dependencies, so that the package and all its dependencies
can be removed using the \fByum history\fP tool after the release is built.
(reltool is needed only during release build but not for CouchDB functioning)
.sp
The package can be installed by running:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
sudo yum install erlang\-reltool
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Fedora 36
.sp
On Fedora 36, you may need these packages in addition to the ones listed above:
.INDENT 0.0
.IP \(bu 2
\fImozjs91\-devel\fP
.IP \(bu 2
\fIerlang\-rebar\fP
.UNINDENT
.sp
If the system contains dangling links to Erlang chunk files, the compiler will
abort. They can be deleted with the following command:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
find \-L /usr/lib64/erlang/lib/ \-type l \-name chunks | xargs rm \-f
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Fauxton is not built on the Node.js version (v16) shipped by the system. The
installation of v12.22.12 can be done via:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
wget https://nodejs.org/download/release/v12.22.12/node\-v12.22.12\-linux\-x64.tar.gz
mkdir \-p /usr/local/lib/nodejs
tar \-xvf node\-v12.22.12\-linux\-x64.tar.gz \-C /usr/local/lib/nodejs
export PATH=/usr/local/lib/nodejs/node\-v12.22.12\-linux\-x64/bin:$PATH
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Note that due to a problem with the Python package sphinx\-build, it is not
possible to compile the documentation on Fedora 36. You can skip compiling the
documentation via:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\&./configure \-\-disable\-docs \-\-spidermonkey\-version 91
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Mac OS X
.sp
Follow \fI\%Installation with Homebrew\fP reference for Mac App installation.
.sp
If you are installing from source, you will need to install the Command
Line Tools:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
xcode\-select \-\-install
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You can then install the other dependencies by running:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
brew install autoconf autoconf\-archive automake libtool \e
    erlang icu4c spidermonkey curl pkg\-config
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You will need \fIHomebrew\fP installed to use the \fBbrew\fP command.
.sp
Some versions of Mac OS X ship a problematic OpenSSL library. If
you’re experiencing troubles with CouchDB crashing intermittently with
a segmentation fault or a bus error, you will need to install your own
version of OpenSSL. See the wiki, mentioned above, for more information.
.sp
\fBSEE ALSO:\fP
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.IP \(bu 2
\fI\%Homebrew\fP
.UNINDENT
.UNINDENT
.UNINDENT
.SS FreeBSD
.sp
FreeBSD requires the use of GNU Make. Where \fBmake\fP is specified in this
documentation, substitute \fBgmake\fP\&.
.sp
You can install this by running:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
pkg install gmake
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Installing
.sp
Once you have satisfied the dependencies you should run:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\&./configure
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If you wish to customize the installation, pass \fB\-\-help\fP to this script.
.sp
If everything was successful you should see the following message:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
You have configured Apache CouchDB, time to relax.
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Relax.
.sp
To build CouchDB you should run:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
make release
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Try \fBgmake\fP if \fBmake\fP is giving you any problems.
.sp
If include paths or other compiler options must be specified, they can be passed to rebar, which compiles CouchDB, with the ERL_CFLAGS environment variable. Likewise, options may be passed to the linker with the ERL_LDFLAGS environment variable:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
make release ERL_CFLAGS=\(dq\-I/usr/local/include/js \-I/usr/local/lib/erlang/usr/include\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If everything was successful you should see the following message:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\&... done
You can now copy the rel/couchdb directory anywhere on your system.
Start CouchDB with ./bin/couchdb from within that directory.
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Relax.
.sp
Note: a fully\-fledged \fB\&./configure\fP with the usual GNU Autotools options
for package managers and a corresponding \fBmake install\fP are in
development, but not part of the 2.0.0 release.
.SS User Registration and Security
.sp
For OS X, in the steps below, substitute \fB/Users/couchdb\fP for
\fB/home/couchdb\fP\&.
.sp
You should create a special \fBcouchdb\fP user for CouchDB.
.sp
On many Unix\-like systems you can run:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
adduser \-\-system \e
        \-\-shell /bin/bash \e
        \-\-group \-\-gecos \e
        \(dqCouchDB Administrator\(dq couchdb
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
On Mac OS X you can use the Workgroup Manager to create users up to version
10.9, and dscl or sysadminctl after version 10.9. Search Apple’s support
site to find the documentation appropriate for your system. As of recent
versions of OS X, this functionality is also included in Server.app,
available through the App Store only as part of OS X Server.
.sp
You must make sure that the user has a working POSIX shell and a writable
home directory.
.sp
You can test this by:
.INDENT 0.0
.IP \(bu 2
Trying to log in as the \fBcouchdb\fP user
.IP \(bu 2
Running \fBpwd\fP and checking the present working directory
.UNINDENT
.sp
As a recommendation, copy the \fBrel/couchdb\fP directory into
\fB/home/couchdb\fP or \fB/Users/couchdb\fP\&.
.sp
Ex: copy the built couchdb release to the new user’s home directory:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
cp \-R /path/to/couchdb/rel/couchdb /home/couchdb
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Change the ownership of the CouchDB directories by running:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
chown \-R couchdb:couchdb /home/couchdb
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Change the permission of the CouchDB directories by running:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
find /home/couchdb \-type d \-exec chmod 0770 {} \e;
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Update the permissions for your ini files:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
chmod 0644 /home/couchdb/etc/*
.ft P
.fi
.UNINDENT
.UNINDENT
.SS First Run
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Be sure to \fI\%create an admin user\fP before trying to
start CouchDB!
.UNINDENT
.UNINDENT
.sp
You can start the CouchDB server by running:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
sudo \-i \-u couchdb /home/couchdb/bin/couchdb
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This uses the \fBsudo\fP command to run the \fBcouchdb\fP command as the
\fBcouchdb\fP user.
.sp
When CouchDB starts it should eventually display following messages:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{database_does_not_exist,[{mem3_shards,load_shards_from_db,\(dq_users\(dq ...
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Don’t be afraid, we will fix this in a moment.
.sp
To check that everything has worked, point your web browser to:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
http://127.0.0.1:5984/_utils/index.html
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
From here you should verify your installation by pointing your web browser to:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
http://localhost:5984/_utils/index.html#verifyinstall
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBYour installation is not complete. Be sure to complete the\fP
\fI\%Setup\fP \fBsteps for a single node or clustered installation.\fP
.SS Running as a Daemon
.sp
CouchDB no longer ships with any daemonization scripts.
.sp
The CouchDB team recommends \fI\%runit\fP to
run CouchDB persistently and reliably. According to official site:
.INDENT 0.0
.INDENT 3.5
\fIrunit\fP is a cross\-platform Unix init scheme with service supervision,
a replacement for sysvinit, and other init schemes. It runs on
GNU/Linux, *BSD, MacOSX, Solaris, and can easily be adapted to
other Unix operating systems.
.UNINDENT
.UNINDENT
.sp
Configuration of runit is straightforward; if you have questions, contact
the CouchDB \fI\%user mailing list\fP
or \fI\%IRC\-channel #couchdb\fP
in FreeNode network.
.sp
Let’s consider configuring runit on Ubuntu 18.04. The following
steps should be considered only as an example. Details will vary
by operating system and distribution. Check your system’s package
management tools for specifics.
.sp
Install runit:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
sudo apt\-get install runit
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Create a directory where logs will be written:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
sudo mkdir /var/log/couchdb
sudo chown couchdb:couchdb /var/log/couchdb
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Create directories that will contain runit configuration for CouchDB:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
sudo mkdir /etc/sv/couchdb
sudo mkdir /etc/sv/couchdb/log
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Create /etc/sv/couchdb/log/run script:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
#!/bin/sh
exec svlogd \-tt /var/log/couchdb
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Basically it determines where and how exactly logs will be written.
See \fBman svlogd\fP for more details.
.sp
Create /etc/sv/couchdb/run:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
#!/bin/sh
export HOME=/home/couchdb
exec 2>&1
exec chpst \-u couchdb /home/couchdb/bin/couchdb
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This script determines how exactly CouchDB will be launched.
Feel free to add any additional arguments and environment
variables here if necessary.
.sp
Make scripts executable:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
sudo chmod u+x /etc/sv/couchdb/log/run
sudo chmod u+x /etc/sv/couchdb/run
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Then run:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
sudo ln \-s /etc/sv/couchdb/ /etc/service/couchdb
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
In a few seconds runit will discover a new symlink and start CouchDB.
You can control CouchDB service like this:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
sudo sv status couchdb
sudo sv stop couchdb
sudo sv start couchdb
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Naturally now CouchDB will start automatically shortly after system starts.
.sp
You can also configure systemd, launchd or SysV\-init daemons to launch
CouchDB and keep it running using standard configuration files. Consult
your system documentation for more information.
.SS Installation on Windows
.sp
There are two ways to install CouchDB on Windows.
.SS Installation from binaries
.sp
This is the simplest way to go.
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
Windows 8, 8.1, and 10 require the \fI\%\&.NET Framework v3.5\fP to be installed.
.UNINDENT
.UNINDENT
.INDENT 0.0
.IP 1. 3
Get \fI\%the latest Windows binaries\fP from the \fI\%CouchDB web site\fP\&.
Old releases are available at \fI\%archive\fP\&.
.IP 2. 3
Follow the installation wizard steps. \fBBe sure to install CouchDB to a
path with no spaces, such as\fP \fBC:\eCouchDB\fP\&.
.IP 3. 3
\fBYour installation is not complete. Be sure to complete the\fP
\fI\%Setup\fP \fBsteps for a single node or clustered installation.\fP
.IP 4. 3
\fI\%Open up Fauxton\fP
.IP 5. 3
It’s time to Relax!
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
In some cases you might been asked to reboot Windows to complete
installation process, because of using on different Microsoft Visual C++
runtimes by CouchDB.
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
\fBUpgrading note\fP
.sp
It’s recommended to uninstall previous CouchDB version before upgrading,
especially if the new one is built against different Erlang release.
The reason is simple: there may be leftover libraries with alternative or
incompatible versions from old Erlang release that may create conflicts,
errors and weird crashes.
.sp
In this case, make sure you backup of your \fIlocal.ini\fP config and CouchDB
database/index files.
.UNINDENT
.UNINDENT
.SS Silent Install
.sp
The Windows installer supports silent installs. Here are some sample commands, supporting
the new features of the 3.0 installer.
.sp
Install CouchDB without a service, but with an admin user:password of \fBadmin:hunter2\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
msiexec /i apache\-couchdb\-3.0.0.msi /quiet ADMINUSER=admin ADMINPASSWORD=hunter2 /norestart
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The same as above, but also install and launch CouchDB as a service:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
msiexec /i apache\-couchdb\-3.0.0.msi /quiet INSTALLSERVICE=1 ADMINUSER=admin ADMINPASSWORD=hunter2 /norestart
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Unattended uninstall of CouchDB to target directory \fID:CouchDB\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
msiexec /x apache\-couchdb\-3.0.0.msi INSTALLSERVICE=1 APPLICATIONFOLDER=\(dqD:\eCouchDB\(dq ADMINUSER=admin ADMINPASSWORD=hunter2 /quiet /norestart
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Unattended uninstall if the installer file is unavailable:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
msiexec /x {4CD776E0\-FADF\-4831\-AF56\-E80E39F34CFC} /quiet /norestart
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Add \fB/l* log.txt\fP to any of the above to generate a useful logfile for debugging.
.SS Installation from sources
.sp
\fBSEE ALSO:\fP
.INDENT 0.0
.INDENT 3.5
\fI\%Glazier: Automate building of CouchDB from source on Windows\fP
.UNINDENT
.UNINDENT
.SS Installation on macOS
.SS Installation using the Apache CouchDB native application
.sp
The easiest way to run CouchDB on macOS is through the native macOS
application. Just follow the below instructions:
.INDENT 0.0
.IP 1. 3
\fI\%Download Apache CouchDB for macOS\fP\&.
Old releases are available at \fI\%archive\fP\&.
.IP 2. 3
Double click on the Zip file
.IP 3. 3
Drag and drop the Apache CouchDB.app into Applications folder
.UNINDENT
.sp
That’s all, now CouchDB is installed on your Mac:
.INDENT 0.0
.IP 1. 3
Run Apache CouchDB application
.IP 2. 3
\fI\%Open up Fauxton\fP, the CouchDB admin interface
.IP 3. 3
Verify the install by clicking on \fIVerify\fP, then \fIVerify Installation\fP\&.
.IP 4. 3
\fBYour installation is not complete. Be sure to complete the\fP
\fI\%Setup\fP \fBsteps for a single node or clustered installation.\fP
.IP 5. 3
Time to Relax!
.UNINDENT
.SS Installation with Homebrew
.sp
CouchDB can be installed via \fI\%Homebrew\fP\&.  Fetch the newest version of Homebrew
and all formulae and install CouchDB with the following commands:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
brew update
brew install couchdb
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Installation from source
.sp
Installation on macOS is possible from source. Download the \fI\%source tarball\fP,
extract it, and follow the instructions in the \fBINSTALL.Unix.md\fP file.
.SS Running as a Daemon
.sp
CouchDB itself no longer ships with any daemonization scripts.
.sp
The CouchDB team recommends \fI\%runit\fP to
run CouchDB persistently and reliably. Configuration of runit is
straightforward; if you have questions, reach out to the CouchDB
user mailing list.
.sp
Naturally, you can configure launchd or other init daemons to launch CouchDB
and keep it running using standard configuration files.
.sp
Consult your system documentation for more information.
.SS Installation on FreeBSD
.SS Installation from ports
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
cd /usr/ports/databases/couchdb
make install clean
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This will install CouchDB from the ports collection.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Be sure to \fI\%create an admin user\fP before starting
CouchDB for the first time!
.UNINDENT
.UNINDENT
.SS Start script
.sp
The following options for \fB/etc/rc.conf\fP or \fB/etc/rc.conf.local\fP are
supported by the start script (defaults shown):
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
couchdb_enable=\(dqNO\(dq
couchdb_enablelogs=\(dqYES\(dq
couchdb_user=\(dqcouchdb\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
After enabling the couchdb rc service use the following command to start CouchDB:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
/usr/local/etc/rc.d/couchdb start
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This script responds to the arguments \fIstart\fP, \fIstop\fP, \fIstatus\fP, \fIrcvar\fP etc..
.sp
The start script will also use settings from the following config files:
.INDENT 0.0
.IP \(bu 2
/usr/local/etc/couchdb/default.ini
.IP \(bu 2
/usr/local/etc/couchdb/local.ini
.UNINDENT
.sp
Administrators should use \fBdefault.ini\fP as reference and only modify the
\fBlocal.ini\fP file.
.SS Post install
.sp
\fBYour installation is not complete. Be sure to complete the\fP
\fI\%Setup\fP \fBsteps for a single node or clustered installation.\fP
.sp
In case the install script fails to install a non\-interactive user “couchdb” to
be used for the database, the user needs to be created manually:
.sp
I used the \fBpw\fP command to add a user “couchdb” in group “couchdb”:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
pw user add couchdb
pw user mod couchdb \-c \(aqCouchDB, time to relax\(aq \-s /usr/sbin/nologin \-d /var/lib/couchdb
pw group add couchdb
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The user is added to \fB/etc/passwd\fP and should look similar to the following:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
shell#  grep couchdb /etc/passwd
couchdb:*:1013:1013:Couchdb, time to relax:/var/lib/couchdb/:/usr/sbin/nologin
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
To change any of these settings, please refrain from editing \fI/etc/passwd\fP and
instead use \fBpw user mod ...\fP or \fBvipw\fP\&. Make sure that the user has no
shell, but instead uses \fB/usr/sbin/nologin\fP\&. The ‘*’ in the second field means
that this user can not login via password authorization. For details use
\fI\%man 5 passwd\fP\&.
.SS Installation via Docker
.sp
Apache CouchDB provides ‘convenience binary’ Docker images through
Docker Hub at \fBapache/couchdb\fP\&. This is our upstream release; it
is usually mirrored downstream at Docker’s top\-level \fBcouchdb\fP
as well.
.sp
At least these tags are always available on the image:
.INDENT 0.0
.IP \(bu 2
\fBlatest\fP \- always the latest
.IP \(bu 2
\fB3\fP: always the latest 3.x version
.IP \(bu 2
\fB2\fP: always the latest 2.x version
.IP \(bu 2
\fB1\fP, \fB1.7\fP, \fB1.7.2\fP: CouchDB 1.7.2 (convenience only; no longer supported)
.IP \(bu 2
\fB1\-couchperuser\fP, \fB1.7\-couchperuser\fP, \fB1.7.2\-couchperuser\fP: CouchDB
1.7.2 with couchperuser plugin (convenience only; no longer supported)
.UNINDENT
.sp
These images expose CouchDB on port \fB5984\fP of the container, run everything
as user \fBcouchdb\fP (uid \fB5984\fP), and support use of a Docker volume for data
at \fB/opt/couchdb/data\fP\&.
.sp
\fBYour installation is not complete. Be sure to complete the\fP
\fI\%Setup\fP \fBsteps for a single node or clustered installation.\fP
.sp
Further details on the Docker configuration are available in our
\fI\%couchdb\-docker git repository\fP\&.
.SS Installation via Snap
.sp
Apache CouchDB provides ‘convenience binary’ Snap builds through the
Ubuntu snapcraft repository under the name \fBcouchdb\fP\&. Only snaps built
from official stable CouchDB releases (\fB2.0\fP, \fB2.1\fP, etc.) are available
through this channel. There are separate snap channels for each major
release stream, e.g. \fB2.x\fP, \fB3.x\fP, as well as a \fBlatest\fP stream.
.sp
After \fI\%installing snapd\fP, the CouchDB snap can be installed via:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ sudo snap install couchdb
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB will be installed at \fB/snap/couchdb\fP\&. Data will be stored at
\fB/var/snap/couchdb/\fP\&.
.sp
Please note that all other file system paths are \fBrelative to the snap
\(gachroot\(ga\fP instead of the system root. In addition, the exact path
depends on your system. For example, when you normally want to
reference \fI/opt/couchdb/etc/local.ini\fP, under snap, this could live at
\fI/snap/couchdb/5/opt/couchdb/etc/local.ini\fP\&.
.sp
\fBYour installation is not complete. Be sure to complete the\fP
\fI\%Setup\fP \fBsteps for a single node or clustered installation.\fP
.sp
Further details on the snap build process are available in our
\fI\%couchdb\-pkg git repository\fP\&.
.SS Installation on Kubernetes
.sp
Apache CouchDB provides a \fI\%Helm chart\fP to enable deployment to
Kubernetes.
.sp
To install the chart with the release name \fBmy\-release\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
helm repo add couchdb https://apache.github.io/couchdb\-helm

helm repo update

helm install \-\-name my\-release couchdb/couchdb
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Further details on the configuration options are available in
the \fI\%Helm chart\fP readme.
.SS Search Plugin Installation
.sp
New in version 3.0.

.sp
CouchDB can build and query full\-text search indexes using an external Java
service that embeds \fI\%Apache Lucene\fP\&. Typically, this
service is installed on the same host as CouchDB and communicates with it over
the loopback network.
.sp
The search plugin is runtime\-compatible with Java JDKs 6, 7 and 8. Building a
release from source requires JDK 6. \fBIt will not work with any newer version of
Java.\fP Sorry about that.
.SS Installation of Binary Packages
.sp
Binary packages that bundle all the necessary dependencies of the search plugin are
available on \fI\%GitHub\fP\&.  The files in each release should be unpacked into a directory on
the Java classpath. If you do not have a classpath already set, or you wish to explicitly
set the classpath location for Clouseau, then add the line:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\-classpath \(aq/path/to/clouseau/*\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
to the server command below. If clouseau is installed in \fB/opt/clouseau\fP the line would be:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\-classpath \(aq/opt/clouseau/*\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The service expects to find a couple of configuration files
conventionally called \fBclouseau.ini\fP and \fBlog4j.properties\fP with the following
content:
.sp
\fBclouseau.ini\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[clouseau]

; the name of the Erlang node created by the service, leave this unchanged
name=clouseau@127.0.0.1

; set this to the same distributed Erlang cookie used by the CouchDB nodes
cookie=monster

; the path where you would like to store the search index files
dir=/path/to/index/storage

; the number of search indexes that can be open simultaneously
max_indexes_open=500
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBlog4j.properties\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
log4j.rootLogger=debug, CONSOLE
log4j.appender.CONSOLE=org.apache.log4j.ConsoleAppender
log4j.appender.CONSOLE.layout=org.apache.log4j.PatternLayout
log4j.appender.CONSOLE.layout.ConversionPattern=%d{ISO8601} %c [%p] %m%n
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Once these files are in place the service can be started with an invocation like
the following:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
java \-server \e
     \-Xmx2G \e
     \-Dsun.net.inetaddr.ttl=30 \e
     \-Dsun.net.inetaddr.negative.ttl=30 \e
     \-Dlog4j.configuration=file:/path/to/log4j.properties \e
     \-XX:OnOutOfMemoryError=\(dqkill \-9 %p\(dq \e
     \-XX:+UseConcMarkSweepGC \e
     \-XX:+CMSParallelRemarkEnabled \e
     com.cloudant.clouseau.Main \e
     /path/to/clouseau.ini
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Chef
.sp
The CouchDB \fI\%cookbook\fP can build the search plugin from source and install it
on a server alongside CouchDB.
.SS Kubernetes
.sp
Users running CouchDB on Kubernetes via the \fI\%Helm chart\fP can add the search
service to each CouchDB Pod by setting \fBenableSearch: true\fP in the chart
values.
.SS Additional Details
.sp
The \fI\%Search User Guide\fP provides detailed information on
creating and querying full\-text indexes using this plugin.
.sp
The source code for the plugin and additional configuration documentation is
available on GitHub at \fI\%https://github.com/cloudant\-labs/clouseau\fP\&.
.SS Upgrading from prior CouchDB releases
.SS Important Notes
.INDENT 0.0
.IP \(bu 2
\fBAlways back up your\fP \fBdata/\fP \fBand\fP \fBetc/\fP \fBdirectories prior to
upgrading CouchDB.\fP
.IP \(bu 2
We recommend that you overwrite your \fBetc/default.ini\fP file with the
version provided by the new release. New defaults sometimes contain
mandatory changes to enable default functionality. Always places your
customizations in \fBetc/local.ini\fP or any \fBetc/local.d/*.ini\fP file.
.UNINDENT
.SS Upgrading from CouchDB 2.x
.sp
If you are coming from a prior release of CouchDB 2.x, upgrading is simple.
.SS Standalone (single) node upgrades
.sp
If you are running a standalone (single) CouchDB node:
.INDENT 0.0
.IP 1. 3
Plan for downtime.
.IP 2. 3
Backup everything.
.IP 3. 3
Check for new recommended settings in the shipped \fBetc/local.ini\fP file,
and merge any changes desired into your own local settings file(s).
.IP 4. 3
Stop CouchDB.
.IP 5. 3
Upgrade CouchDB in place.
.IP 6. 3
Be sure to \fI\%create an admin user\fP if you do not have
one. CouchDB 3.0+ \fBrequire\fP an admin user to start (the admin party has
ended).
.IP 7. 3
Start CouchDB.
.IP 8. 3
Relax! You’re done.
.UNINDENT
.SS Cluster upgrades
.sp
CouchDB 2.x and 3.x are explicitly designed to allow “mixed clusters” during
the upgrade process. This allows you to perform a rolling restart across
a cluster, upgrading one node at a time, for a \fIzero downtime upgrade\fP\&.
The process is also entirely scriptable within your configuration
management tool of choice.
.sp
We’re proud of this feature, and you should be, too!
.sp
If you are running a CouchDB cluster:
.INDENT 0.0
.IP 1. 3
Backup everything.
.IP 2. 3
Check for new recommended settings in the shipped \fBetc/local.ini\fP file,
and merge any changes desired into your own local settings file(s),
staging these changes to occur as you upgrade the node.
.IP 3. 3
Stop CouchDB on a single node.
.IP 4. 3
Upgrade that CouchDB install in place.
.IP 5. 3
Start CouchDB.
.IP 6. 3
Double\-check that the node has re\-joined the cluster through the
\fI\%/_membership\fP endpoint. If your load balancer has
health check functionality driven by the \fI\%/_up\fP endpoint,
check whether it thinks the node is healthy as well.
.IP 7. 3
Repeat the last 4 steps on the remaining nodes in the cluster.
.IP 8. 3
Relax! You’re done.
.UNINDENT
.SS Upgrading from CouchDB 1.x
.sp
To upgrade from CouchDB 1.x, first upgrade to a version of CouchDB 2.x.  You
will need to convert all databases to CouchDB 2.x format first; see the Upgrade
Notes there for instructions. Then, upgrade to CouchDB 3.x.
.SS Troubleshooting an Installation
.SS First Install
.sp
If your CouchDB doesn’t start after you’ve just installed, check the following
things:
.INDENT 0.0
.IP \(bu 2
On UNIX\-like systems, this is usually this is a permissions issue. Ensure
that you’ve followed the \fI\%User Registration and Security\fP
\fBchown\fP/\fBchmod\fP commands. This problem is indicated by the presence of
the keyword \fBeacces\fP somewhere in the error output from CouchDB itself.
.IP \(bu 2
Some Linux distributions split up Erlang into multiple packages. For your
distribution, check that you \fBreally\fP installed all the required Erlang
modules. This varies from platform to platform, so you’ll just have to
work it out for yourself. For example, on recent versions of Ubuntu/Debian,
the \fBerlang\fP package includes all Erlang modules.
.IP \(bu 2
Confirm that Erlang itself starts up with crypto (SSL) support:
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
## what version of erlang are you running? Ensure it is supported
erl \-noshell \-eval \(aqio:put_chars(erlang:system_info(otp_release)).\(aq \-s erlang halt
## are the erlang crypto (SSL) libraries working?
erl \-noshell \-eval \(aqcase application:load(crypto) of ok \-> io:put_chars(\(dqyay_crypto\en\(dq) ; _ \-> exit(no_crypto) end.\(aq \-s init stop
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.IP \(bu 2
Next, identify where your Erlang CouchDB libraries are installed. This will
typically be the lib/ subdirectory of the release that you have installed.
.IP \(bu 2
Use this to start up Erlang with the CouchDB libraries in its path:
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
erl \-env ERL_LIBS $ERL_LIBS:/path/to/couchdb/lib \-couch_ini \-s crypto
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.IP \(bu 2
In that Erlang shell, let’s check that the key libraries are running. The
\fB%%\fP lines are comments, so you can skip them:
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
%% test SSL support. If this fails, ensure you have the OTP erlang\-crypto library installed
crypto:md5_init().

%% test Snappy compression. If this fails, check your CouchDB configure script output or alternatively
%% if your distro comes with erlang\-snappy make sure you\(aqre using only the CouchDB supplied version
snappy:compress(\(dqgogogogogogogogogogogogogogo\(dq).

%% test the CouchDB JSON encoder. CouchDB uses different encoders in each release, this one matches
%% what is used in 2.0.x.
jiffy:decode(jiffy:encode(<<\(dq[1,2,3,4,5]\(dq>>)).

%% this is how you quit the erlang shell.
q().
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.IP \(bu 2
The output should resemble this, or an error will be thrown:
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
Erlang/OTP 17 [erts\-6.2] [source] [64\-bit] [smp:2:2] [async\-threads:10] [kernel\-poll:false]

Eshell V6.2  (abort with ^G)
1> crypto:md5_init().
<<1,35,69,103,137,171,205,239,254,220,186,152,118,84,50,
  16,0,0,0,0,0,0,0,0,0,0,0,0,0,...>>
2> snappy:compress(\(dqgogogogogogogogogogogogogogo\(dq).
{ok,<<28,4,103,111,102,2,0>>}
3> jiffy:decode(jiffy:encode(<<\(dq[1,2,3,4,5]\(dq>>)).
<<\(dq[1,2,3,4,5]\(dq>>
4> q().
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.IP \(bu 2
At this point the only remaining dependency is your system’s Unicode support
library, ICU, and the Spidermonkey Javascript VM from Mozilla. Make sure that
your \fBLD_LIBRARY_PATH\fP or equivalent for non\-Linux systems
(\fBDYLD_LIBRARY_PATH\fP on macOS) makes these available to CouchDB.
Linux example running as normal user:
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
  LD_LIBRARY_PATH=/usr/local/lib:/usr/local/spidermonkey/lib couchdb

Linux example running as couchdb user:
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
echo LD_LIBRARY_PATH=/usr/local/lib:/usr/local/spidermonkey/lib couchdb | sudo \-u couchdb sh
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.IP \(bu 2
If you receive an error message including the key word \fBeaddrinuse\fP,
such as this:
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
  Failure to start Mochiweb: eaddrinuse

edit your \(ga\(gaetc/default.ini\(ga\(ga or \(ga\(gaetc/local.ini\(ga\(ga file and change the
\(ga\(ga[chttpd] port = 5984\(ga\(ga line to an available port.
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.IP \(bu 2
If you receive an error including the string:
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
… OS Process Error … {os_process_error,{exit_status,127}}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
then it is likely your SpiderMonkey JavaScript VM installation is not
correct. Please recheck your build dependencies and try again.
.INDENT 0.0
.IP \(bu 2
If you receive an error including the string:
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
… OS Process Error … {os_process_error,{exit_status,139}}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
this is caused by the fact that SELinux blocks access to certain areas of
the file system. You must re\-configure SELinux, or you can fully disable
SELinux using the command:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
setenforce 0
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.IP \(bu 2
If you are still not able to get CouchDB to start at this point, keep
reading.
.UNINDENT
.SS Quick Build
.sp
Having problems getting CouchDB to run for the first time? Follow this simple
procedure and report back to the user mailing list or IRC with the output
of each step. Please put the output of these steps into a paste service (such
as \fI\%https://paste.ee/\fP) rather than including the output of your entire
run in IRC or the mailing list directly.
.INDENT 0.0
.IP 1. 3
Note down the name and version of your operating system and your processor
architecture.
.IP 2. 3
Note down the installed versions of CouchDB’s dependencies.
.IP 3. 3
Follow the checkout instructions to get a fresh copy of CouchDB’s trunk.
.IP 4. 3
Configure from the couchdb directory:
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\&./configure
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.IP 5. 3
Build the release:
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
make release
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.IP 6. 3
Run the couchdb command and log the output:
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
cd rel/couchdb
bin/couchdb
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.IP 7. 3
Use your system’s kernel trace tool and log the output of the above command.
.INDENT 3.0
.IP a. 3
For example, linux systems should use \fBstrace\fP:
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
strace bin/couchdb 2> strace.out
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.IP 8. 3
Report back to the mailing list (or IRC) with the output of each step.
.UNINDENT
.SS Upgrading
.sp
Are you upgrading from CouchDB 1.x? Install CouchDB into a fresh directory.
CouchDB’s directory layout has changed and may be confused by libraries
present from previous releases.
.SS Runtime Errors
.SS Erlang stack trace contains \fBsystem_limit\fP, \fBopen_port\fP, or \fBemfile\fP
.sp
Modern Erlang has a default limit of 65536 ports (8196 on Windows), where each
open file handle, tcp connection, and linked\-in driver uses one port. OSes have
different soft and hard limits on the number of open handles per process, often
as low as 1024 or 4096 files. You’ve probably exceeded this.
.sp
There are two settings that need changing to increase this value. Consult your
OS documentation for how to increase the limit for your process. Under Linux
and systemd, this setting can be adjusted via \fBsystemctl edit couchdb\fP and
adding the lines:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[Service]
LimitNOFILE=65536
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
to the file in the editor.
.sp
To increase this value higher than 65536, you must also add the Erlang \fB+Q\fP
parameter to your \fBetc/vm.args\fP file by adding the line:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
+Q 102400
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The old \fBERL_MAX_PORTS\fP environment variable is ignored by the version of
Erlang supplied with CouchDB.
.SS Lots of memory being used on startup
.sp
Is your CouchDB using a lot of memory (several hundred MB) on startup? This one
seems to especially affect Dreamhost installs. It’s really an issue with the
Erlang VM pre\-allocating data structures when ulimit is very large or
unlimited. A detailed discussion can be found on the erlang\-questions list,
but the short answer is that you should decrease \fBulimit \-n\fP or lower the
\fBvm.args\fP parameter \fB+Q\fP to something reasonable like 1024.
.SS function raised exception (Cannot encode ‘undefined’ value as JSON)
.sp
If you see this in the CouchDB error logs, the JavaScript code you are using
for either a map or reduce function is referencing an object member that is
not defined in at least one document in your database. Consider this
document:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
  \(dq_id\(dq:\(dqXYZ123\(dq,
  \(dq_rev\(dq:\(dq1BB2BB\(dq,
  \(dqfield\(dq:\(dqvalue\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
and this map function:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
  emit(doc.name, doc.address);
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This will fail on the above document, as it does not contain a \fBname\fP or
\fBaddress\fP member. Instead, use guarding to make sure the function only
accesses members when they exist in a document:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
  if(doc.name && doc.address) {
    emit(doc.name, doc.address);
  }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
While the above guard will work in most cases, it’s worth bearing JavaScript’s
understanding of ‘false’ values in mind. Testing against a property with a
value of 0 (zero), \fB\(aq\(aq\fP (empty String), \fBfalse\fP or \fBnull\fP will return
false. If this is undesired, a guard of the form \fBif (doc.foo !== undefined)\fP
should do the trick.
.sp
This error can also be caused if a reduce function does not return a value. For
example, this reduce function will cause an error:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(key, values) {
  sum(values);
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The function needs to return a value:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(key, values) {
  return sum(values);
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS erlang stack trace contains \fBbad_utf8_character_code\fP
.sp
CouchDB 1.1.1 and later contain stricter handling of UTF8 encoding. If you are
replicating from older versions to newer versions, then this error may occur
during replication.
.sp
A number of work\-arounds exist; the simplest is to do an in\-place upgrade of
the relevant CouchDB and then compact prior to replicating.
.sp
Alternatively, if the number of documents impacted is small, use filtered
replication to exclude only those documents.
.SS FIPS mode
.sp
Operating systems can be configured to disallow the use of OpenSSL MD5 hash
functions in order to prevent use of MD5 for cryptographic purposes. CouchDB
makes use of MD5 hashes for verifying the integrity of data (and not for
cryptography) and will not run without the ability to use MD5 hashes.
.sp
The message below indicates that the operating system is running in “FIPS mode,”
which, among other restrictions, does not allow the use of OpenSSL’s
MD5 functions:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
md5_dgst.c(82): OpenSSL internal error, assertion failed: Digest MD5 forbidden in FIPS mode!
[os_mon] memory supervisor port (memsup): Erlang has closed
[os_mon] cpu supervisor port (cpu_sup): Erlang has closed
Aborted
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
A workaround for this is provided with the \fB\-\-erlang\-md5\fP compile flag. Use of
the flag results in CouchDB substituting the OpenSSL MD5 function calls with
equivalent calls to Erlang’s built\-in library \fBerlang:md5.\fP NOTE: there may be
a performance penalty associated with this workaround.
.sp
Because CouchDB does not make use of MD5 hashes for cryptographic purposes, this
workaround does not defeat the purpose of “FIPS mode,” provided that the system
owner is aware of and consents to its use.
.SS Debugging startup
.sp
If you’ve compiled from scratch and are having problems getting CouchDB to even
start up, you may want to see more detail. Start by enabling logging at the debug
level:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[log]
level = debug
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You can then pass the \fB\-init_debug +W i +v +V \-emu_args\fP flags in the \fBERL_FLAGS\fP
environment variable to turn on additional debugging information that CouchDB
developers can use to help you.
.sp
Then, reach out to the CouchDB development team using the links provided on the
\fI\%CouchDB home page\fP for assistance.
.SS macOS Known Issues
.SS undefined error, exit_status 134
.sp
Sometimes the \fBVerify Installation\fP fails with an \fBundefined\fP error.
This could be due to a missing dependency with Mac.
In the logs, you will find \fBcouchdb exit_status,134\fP\&.
.sp
Installing the missing \fBnspr\fP via \fBbrew install nspr\fP resolves the issue.
(see: \fI\%https://github.com/apache/couchdb/issues/979\fP)
.SH SETUP
.sp
CouchDB 2.x can be deployed in either a single\-node or a clustered
configuration. This section covers the first\-time setup steps required for each
of these configurations.
.SS Single Node Setup
.sp
Many users simply need a single\-node CouchDB 2.x installation. Operationally,
it is roughly equivalent to the CouchDB 1.x series. Note that a single\-node
setup obviously doesn’t take any advantage of the new scaling and
fault\-tolerance features in CouchDB 2.x.
.sp
After installation and initial startup, visit Fauxton at
\fBhttp://127.0.0.1:5984/_utils#setup\fP\&. You will be asked to set up
CouchDB as a single\-node instance or set up a cluster. When you click
“Single\-Node\-Setup”, you will get asked for an admin username and
password. Choose them well and remember them.
.sp
You can also bind CouchDB to a public address, so it is accessible within your
LAN or the public, if you are doing this on a public VM. Or, you can keep the
installation private by binding only to 127.0.0.1 (localhost). Binding to
0.0.0.0 will bind to all addresses. The wizard then configures your admin
username and password and creates the three system databases \fB_users\fP,
\fB_replicator\fP and \fB_global_changes\fP for you.
.sp
Another option is to set the configuration parameter \fB[couchdb] single_node=true\fP
in your \fBlocal.ini\fP file. When doing this, CouchDB will create the system
database for you on restart.
.sp
Alternatively, if you don’t want to use the Setup Wizard or set that value, and
run 3.x as a single node with a server administrator already configured via
\fI\%config file\fP, make sure to create the three system
databases manually on startup:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X PUT http://127.0.0.1:5984/_users

curl \-X PUT http://127.0.0.1:5984/_replicator

curl \-X PUT http://127.0.0.1:5984/_global_changes
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Note that the last of these is not necessary if you do not expect to be
using the global changes feed. Feel free to delete this database if you
have created it, it has grown in size, and you do not need the function
(and do not wish to waste system resources on compacting it regularly.)
.SS Cluster Set Up
.sp
This section describes everything you need to know to prepare, install, and
set up your first CouchDB 2.x/3.x cluster.
.SS Ports and Firewalls
.sp
CouchDB uses the following ports:
.TS
center;
|l|l|l|l|.
_
T{
Port Number
T}	T{
Protocol
T}	T{
Recommended binding
T}	T{
Usage
T}
_
T{
5984
T}	T{
tcp
T}	T{
As desired, by
default \fBlocalhost\fP
T}	T{
Standard clustered
port for all HTTP
API requests
T}
_
T{
4369
T}	T{
tcp
T}	T{
\fBlocalhost\fP for single
node installs. Private
interface if clustered
T}	T{
Erlang port mapper
daemon (epmd)
T}
_
T{
Random
above 1024
(see below)
T}	T{
tcp
T}	T{
Private interface
T}	T{
Communication with
other CouchDB nodes
in the cluster
T}
_
.TE
.sp
CouchDB in clustered mode uses the port \fB5984\fP, just as in a standalone
configuration. Port \fB5986\fP, previously used in CouchDB 2.x, has been removed
in CouchDB 3.x. All endpoints previously accessible at that port are now
available under the \fB/_node/{node\-name}/...\fP hierarchy via the primary \fB5984\fP
port.
.sp
CouchDB uses Erlang\-native clustering functionality to achieve a clustered
installation.  Erlang uses TCP port \fB4369\fP (EPMD) to find other nodes, so all
servers must be able to speak to each other on this port. In an Erlang cluster,
all nodes are connected to all other nodes, in a mesh network configuration.
.sp
Every Erlang application running on that machine (such as CouchDB) then uses
automatically assigned ports for communication with other nodes. Yes, this
means random ports. This will obviously not work with a firewall, but it is
possible to force an Erlang application to use a specific port range.
.sp
This documentation will use the range TCP \fB9100\-9200\fP, but this range is
unnecessarily broad. If you only have a single Erlang application running on a
machine, the range can be limited to a single port: \fB9100\-9100\fP, since the
ports erlang assigns are for \fIinbound connections\fP only. Three CouchDB nodes
running on a single machine, as in a development cluster scenario, would need
three ports in this range.
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
If you expose the distribution port to the Internet or any other untrusted
network, then the only thing protecting you is the Erlang
\fI\%cookie\fP\&.
.UNINDENT
.UNINDENT
.SS Configure and Test the Communication with Erlang
.SS Make CouchDB use correct IP|FQDN and the open ports
.sp
In file \fBetc/vm.args\fP change the line \fB\-name couchdb@127.0.0.1\fP to
\fB\-name couchdb@<reachable\-ip\-address|fully\-qualified\-domain\-name>\fP which defines
the name of the node. Each node must have an identifier that allows remote
systems to talk to it. The node name is of the form
\fB<name>@<reachable\-ip\-address|fully\-qualified\-domain\-name>\fP\&.
.sp
The name portion can be couchdb on all nodes, unless you are running more than
1 CouchDB node on the same server with the same IP address or domain name. In
that case, we recommend names of \fBcouchdb1\fP, \fBcouchdb2\fP, etc.
.sp
The second portion of the node name must be an identifier by which other nodes
can access this node – either the node’s fully qualified domain name (FQDN) or
the node’s IP address. The FQDN is preferred so that you can renumber the node’s
IP address without disruption to the cluster. (This is common in cloud\-hosted
environments.)
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
Tricks with \fB/etc/hosts\fP and \fBlibresolv\fP don’t work with Erlang.
Either properly set up DNS and use fully\-qualified domain names, or
use IP addresses. DNS and FQDNs are preferred.
.sp
Changing the name later is somewhat cumbersome (i.e. moving shards), which
is why you will want to set it once and not have to change it.
.UNINDENT
.UNINDENT
.sp
Open \fBetc/vm.args\fP, on all nodes, and add \fB\-kernel inet_dist_listen_min 9100\fP
and \fB\-kernel inet_dist_listen_max 9200\fP like below:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\-name ...
\-setcookie ...
\&...
\-kernel inet_dist_listen_min 9100
\-kernel inet_dist_listen_max 9200
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Again, a small range is fine, down to a single port (set both to \fB9100\fP) if you
only ever run a single CouchDB node on each machine.
.SS Confirming connectivity between nodes
.sp
For this test, you need 2 servers with working hostnames. Let us call them
server1.test.com and server2.test.com. They reside at \fB192.168.0.1\fP and
\fB192.168.0.2\fP, respectively.
.sp
On server1.test.com:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
erl \-name bus@192.168.0.1 \-setcookie \(aqbrumbrum\(aq \-kernel inet_dist_listen_min 9100 \-kernel inet_dist_listen_max 9200
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Then on server2.test.com:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
erl \-name car@192.168.0.2 \-setcookie \(aqbrumbrum\(aq \-kernel inet_dist_listen_min 9100 \-kernel inet_dist_listen_max 9200
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B An explanation to the commands:
.INDENT 7.0
.IP \(bu 2
\fBerl\fP the Erlang shell.
.IP \(bu 2
\fB\-name bus@192.168.0.1\fP the name of the Erlang node and its IP address or FQDN.
.IP \(bu 2
\fB\-setcookie \(aqbrumbrum\(aq\fP the “password” used when nodes connect to each
other.
.IP \(bu 2
\fB\-kernel inet_dist_listen_min 9100\fP the lowest port in the range.
.IP \(bu 2
\fB\-kernel inet_dist_listen_max 9200\fP the highest port in the range.
.UNINDENT
.UNINDENT
.sp
This gives us 2 Erlang shells. shell1 on server1, shell2 on server2.
Time to connect them. Enter the following, being sure to end the line with a
period (\fB\&.\fP):
.sp
In shell1:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
net_kernel:connect_node(\(aqcar@192.168.0.2\(aq).
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This will connect to the node called \fBcar\fP on the server called
\fB192.168.0.2\fP\&.
.sp
If that returns true, then you have an Erlang cluster, and the firewalls are
open. This means that 2 CouchDB nodes on these two servers will be able to
communicate with each other successfully. If you get false or nothing at all,
then you have a problem with the firewall, DNS, or your settings. Try again.
.sp
If you’re concerned about firewall issues, or having trouble connecting all
nodes of your cluster later on, repeat the above test between all pairs of
servers to confirm connectivity and system configuration is correct.
.SS Preparing CouchDB nodes to be joined into a cluster
.sp
Before you can add nodes to form a cluster, you must have them listening on an
IP address accessible from the other nodes in the cluster. You should also ensure
that a few critical settings are identical across all nodes before joining them.
.sp
The settings we recommend you set now, before joining the nodes into a cluster,
are:
.INDENT 0.0
.IP 1. 3
\fBetc/vm.args\fP settings as described in the
\fI\%previous two sections\fP
.IP 2. 3
At least one \fI\%server administrator\fP
user (and password)
.IP 3. 3
Bind the node’s clustered interface (port \fB5984\fP) to a reachable IP address
.IP 4. 3
A consistent \fI\%UUID\fP\&. The UUID is used in identifying
the cluster when replicating. If this value is not consistent across all nodes
in the cluster, replications may be forced to rewind the changes feed to zero,
leading to excessive memory, CPU and network use.
.IP 5. 3
A consistent \fI\%httpd secret\fP\&. The secret
is used in calculating and evaluating cookie and proxy authentication, and should
be set consistently to avoid unnecessary repeated session cookie requests.
.UNINDENT
.sp
As of CouchDB 3.0, steps 4 and 5 above are automatically performed for you when
using the setup API endpoints described below.
.sp
If you use a configuration management tool, such as Chef, Ansible, Puppet, etc.,
then you can place these settings in a \fB\&.ini\fP file and distribute them to all
nodes ahead of time. Be sure to pre\-encrypt the password (cutting and pasting
from a test instance is easiest) if you use this route to avoid CouchDB rewriting
the file.
.sp
If you do not use configuration management, or are just experimenting with
CouchDB for the first time, use these commands \fIonce per server\fP to perform
steps 2\-4 above. Be sure to change the \fBpassword\fP to something secure, and
again, use the same password on all nodes. You may have to run these commands
locally on each node; if so, replace \fB<server\-IP|FQDN>\fP below with \fB127.0.0.1\fP\&.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
# First, get two UUIDs to use later on. Be sure to use the SAME UUIDs on all nodes.
curl http://<server\-IP|FQDN>:5984/_uuids?count=2

# CouchDB will respond with something like:
#   {\(dquuids\(dq:[\(dq60c9e8234dfba3e2fdab04bf92001142\(dq,\(dq60c9e8234dfba3e2fdab04bf92001cc2\(dq]}
# Copy the provided UUIDs into your clipboard or a text editor for later use.
# Use the first UUID as the cluster UUID.
# Use the second UUID as the cluster shared http secret.

# Create the admin user and password:
curl \-X PUT http://<server\-IP|FQDN>:5984/_node/_local/_config/admins/admin \-d \(aq\(dqpassword\(dq\(aq

# Now, bind the clustered interface to all IP addresses available on this machine
curl \-X PUT http://<server\-IP|FQDN>:5984/_node/_local/_config/chttpd/bind_address \-d \(aq\(dq0.0.0.0\(dq\(aq

# If not using the setup wizard / API endpoint, the following 2 steps are required:
# Set the UUID of the node to the first UUID you previously obtained:
curl \-X PUT http://<server\-IP|FQDN>:5984/_node/_local/_config/couchdb/uuid \-d \(aq\(dqFIRST\-UUID\-GOES\-HERE\(dq\(aq

# Finally, set the shared http secret for cookie creation to the second UUID:
curl \-X PUT http://<server\-IP|FQDN>:5984/_node/_local/_config/chttpd_auth/secret \-d \(aq\(dqSECOND\-UUID\-GOES\-HERE\(dq\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.SS The Cluster Setup Wizard
.sp
CouchDB 2.x/3.x comes with a convenient Cluster Setup Wizard as part of the Fauxton
web administration interface. For first\-time cluster setup, and for
experimentation, this is your best option.
.sp
It is \fBstrongly recommended\fP that the minimum number of nodes in a cluster is
3. For more explanation, see the \fI\%Cluster Theory\fP section
of this documentation.
.sp
After installation and initial start\-up of all nodes in your cluster, ensuring
all nodes are reachable, and the pre\-configuration steps listed above, visit
Fauxton at \fBhttp://<server1>:5984/_utils#setup\fP\&. You will be asked to set up
CouchDB as a single\-node instance or set up a cluster.
.sp
When you click “Setup Cluster” you are asked for admin credentials again, and
then to add nodes by IP address. To get more nodes, go through the same install
procedure for each node, using the same machine to perform the setup process.
Be sure to specify the total number of nodes you expect to add to the cluster
before adding nodes.
.sp
Now enter each node’s IP address or FQDN in the setup wizard, ensuring you also
enter the previously set server admin username and password.
.sp
Once you have added all nodes, click “Setup” and Fauxton will finish the
cluster configuration for you.
.sp
To check that all nodes have been joined correctly, visit
\fBhttp://<server\-IP|FQDN>:5984/_membership\fP on each node. The returned list
should show all of the nodes in your cluster:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
  \(dqall_nodes\(dq: [
    \(dqcouchdb@server1.test.com\(dq,
    \(dqcouchdb@server2.test.com\(dq,
    \(dqcouchdb@server3.test.com\(dq
  ],
  \(dqcluster_nodes\(dq: [
    \(dqcouchdb@server1.test.com\(dq,
    \(dqcouchdb@server2.test.com\(dq,
    \(dqcouchdb@server3.test.com\(dq
  ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The \fBcluster_nodes\fP section is the list of \fIexpected\fP nodes; the \fBall_nodes\fP
section is the list of \fIactually connected\fP nodes. Be sure the two lists match.
.sp
Now your cluster is ready and available! You can send requests to any one of
the nodes, and all three will respond as if you are working with a single
CouchDB cluster.
.sp
For a proper production setup, you’d now set up an HTTP reverse proxy in front
of the cluster, for load balancing and SSL termination. We recommend
\fI\%HAProxy\fP, but others can be used. Sample configurations are available in the
\fI\%Best Practices\fP section.
.SS The Cluster Setup API
.sp
If you would prefer to manually configure your CouchDB cluster, CouchDB exposes
the \fB_cluster_setup\fP endpoint for that purpose. After installation and
initial setup/config, we can set up the cluster. On each node we need to run
the following command to set up the node:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X POST \-H \(dqContent\-Type: application/json\(dq http://admin:password@127.0.0.1:5984/_cluster_setup \-d \(aq{\(dqaction\(dq: \(dqenable_cluster\(dq, \(dqbind_address\(dq:\(dq0.0.0.0\(dq, \(dqusername\(dq: \(dqadmin\(dq, \(dqpassword\(dq:\(dqpassword\(dq, \(dqnode_count\(dq:\(dq3\(dq}\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
After that we can join all the nodes together. Choose one node as the “setup
coordination node” to run all these commands on.  This “setup coordination
node” only manages the setup and requires all other nodes to be able to see it
and vice versa. \fIIt has no special purpose beyond the setup process; CouchDB
does not have the concept of a “master” node in a cluster.\fP
.sp
Setup will not work with unavailable nodes. All nodes must be online and properly
preconfigured before the cluster setup process can begin.
.sp
To join a node to the cluster, run these commands for each node you want to add:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X POST \-H \(dqContent\-Type: application/json\(dq http://admin:password@<setup\-coordination\-node>:5984/_cluster_setup \-d \(aq{\(dqaction\(dq: \(dqenable_cluster\(dq, \(dqbind_address\(dq:\(dq0.0.0.0\(dq, \(dqusername\(dq: \(dqadmin\(dq, \(dqpassword\(dq:\(dqpassword\(dq, \(dqport\(dq: 5984, \(dqnode_count\(dq: \(dq3\(dq, \(dqremote_node\(dq: \(dq<remote\-node\-ip>\(dq, \(dqremote_current_user\(dq: \(dq<remote\-node\-username>\(dq, \(dqremote_current_password\(dq: \(dq<remote\-node\-password>\(dq }\(aq
curl \-X POST \-H \(dqContent\-Type: application/json\(dq http://admin:password@<setup\-coordination\-node>:5984/_cluster_setup \-d \(aq{\(dqaction\(dq: \(dqadd_node\(dq, \(dqhost\(dq:\(dq<remote\-node\-ip>\(dq, \(dqport\(dq: <remote\-node\-port>, \(dqusername\(dq: \(dqadmin\(dq, \(dqpassword\(dq:\(dqpassword\(dq}\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This will join the two nodes together. Keep running the above commands for each
node you want to add to the cluster. Once this is done run the following
command to complete the cluster setup and add the system databases:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X POST \-H \(dqContent\-Type: application/json\(dq http://admin:password@<setup\-coordination\-node>:5984/_cluster_setup \-d \(aq{\(dqaction\(dq: \(dqfinish_cluster\(dq}\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Verify install:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl http://admin:password@<setup\-coordination\-node>:5984/_cluster_setup
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Response:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqstate\(dq:\(dqcluster_finished\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Verify all cluster nodes are connected:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl http://admin:password@<setup\-coordination\-node>:5984/_membership
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Response:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqall_nodes\(dq: [
        \(dqcouchdb@couch1.test.com\(dq,
        \(dqcouchdb@couch2.test.com\(dq,
        \(dqcouchdb@couch3.test.com\(dq,
    ],
    \(dqcluster_nodes\(dq: [
        \(dqcouchdb@couch1.test.com\(dq,
        \(dqcouchdb@couch2.test.com\(dq,
        \(dqcouchdb@couch3.test.com\(dq,
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If the cluster is enabled and \fBall_nodes\fP and \fBcluster_nodes\fP lists don’t match, use curl to add nodes with
PUT \fB/_node/_local/_nodes/couchdb@<reachable\-ip\-address|fully\-qualified\-domain\-name>\fP
and remove nodes with
DELETE \fB/_node/_local/_nodes/couchdb@<reachable\-ip\-address|fully\-qualified\-domain\-name>\fP
.sp
You CouchDB cluster is now set up.
.SH CONFIGURATION
.SS Introduction To Configuring
.SS Configuration files
.sp
By default, CouchDB reads configuration files from the following locations,
in the following order:
.INDENT 0.0
.IP 1. 3
\fBetc/default.ini\fP
.IP 2. 3
\fBetc/default.d/*.ini\fP
.IP 3. 3
\fBetc/local.ini\fP
.IP 4. 3
\fBetc/local.d/*.ini\fP
.UNINDENT
.sp
Configuration files in the \fB*.d/\fP directories are sorted by name, that means
for example a file with the name \fBetc/local.d/00\-shared.ini\fP is loaded before
\fBetc/local.d/10\-server\-specific.ini\fP\&.
.sp
All paths are specified relative to the CouchDB installation directory:
\fB/opt/couchdb\fP recommended on UNIX\-like systems, \fBC:\eCouchDB\fP recommended
on Windows systems, and a combination of two directories on macOS:
\fBApplications/Apache CouchDB.app/Contents/Resources/couchdbx\-core/etc\fP for
the \fBdefault.ini\fP and \fBdefault.d\fP directories, and one of
\fB/Users/<your\-user>/Library/Application Support/CouchDB2/etc/couchdb\fP or
\fB/Users/<your\-user>/Library/Preferences/couchdb2\-local.ini\fP for
the \fBlocal.ini\fP and \fBlocal.d\fP directories.
.sp
Settings in successive documents override the settings in earlier entries.
For example, setting the \fI\%chttpd/bind_address\fP parameter in
\fBlocal.ini\fP would override any setting in \fBdefault.ini\fP\&.
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
The \fBdefault.ini\fP file may be overwritten during an upgrade or
re\-installation, so localised changes should be made to the \fBlocal.ini\fP
file or files within the \fBlocal.d\fP directory.
.UNINDENT
.UNINDENT
.sp
The configuration file chain may be changed by setting the ERL_FLAGS
environment variable:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
export ERL_FLAGS=\(dq\-couch_ini /path/to/my/default.ini /path/to/my/local.ini\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
or by placing the \fB\-couch_ini ..\fP flag directly in the \fBetc/vm.args\fP file.
Passing \fB\-couch_ini ..\fP as a command\-line argument when launching \fBcouchdb\fP
is the same as setting the \fBERL_FLAGS\fP environment variable.
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
The environment variable/command\-line flag overrides any \fB\-couch_ini\fP
option specified in the \fBetc/vm.args\fP file. And, \fBBOTH\fP of these
options \fBcompletely\fP override CouchDB from searching in the default
locations. Use these options only when necessary, and be sure to track
the contents of \fBetc/default.ini\fP, which may change in future releases.
.UNINDENT
.UNINDENT
.sp
If there is a need to use different \fBvm.args\fP or \fBsys.config\fP files, for
example, in different locations to the ones provided by CouchDB, or you don’t
want to edit the original files, the default locations may be changed by
setting the COUCHDB_ARGS_FILE or COUCHDB_SYSCONFIG_FILE environment
variables:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
export COUCHDB_ARGS_FILE=\(dq/path/to/my/vm.args\(dq
export COUCHDB_SYSCONFIG_FILE=\(dq/path/to/my/sys.config\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Parameter names and values
.sp
All parameter names are \fIcase\-sensitive\fP\&. Every parameter takes a value of one
of five types: \fIboolean\fP, \fIinteger\fP, \fIstring\fP, \fI\%tuple\fP and \fI\%proplist\fP\&.
Boolean values can be written as \fBtrue\fP or \fBfalse\fP\&.
.sp
Parameters with value type of \fItuple\fP or \fIproplist\fP are following the Erlang
requirement for style and naming.
.SS Setting parameters via the configuration file
.sp
Changed in version 3.3: added ability to have \fB=\fP in parameter names

.sp
Changed in version 3.3: removed the undocumented ability to have multi\-line values.

.sp
The common way to set some parameters is to edit the \fBlocal.ini\fP file
(location explained above).
.sp
For example:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
; This is a comment
[section]
param = value ; inline comments are allowed
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Each configuration file line may contains \fIsection\fP definition, \fIparameter\fP
specification, empty (space and newline characters only) or \fIcommented\fP line.
You can set up \fIinline\fP commentaries for \fIsections\fP or \fIparameters\fP\&.
.sp
The \fIsection\fP defines group of parameters that are belongs to some specific
CouchDB subsystem. For instance, \fI\%httpd\fP section holds not only HTTP
server parameters, but also others that directly interacts with it.
.sp
The \fIparameter\fP specification contains two parts divided by the \fIequal\fP sign
(\fB=\fP): the parameter name on the left side and the parameter value on the
right one. The leading and following whitespace for \fB=\fP is an optional to
improve configuration readability.
.sp
Since version 3.3 it’s possible to use \fB=\fP in parameter names, but only when
the parameter and value are separated \(ga\(ga = \fB, i.e. the equal sign is surrounded
by at least one space on each side. This might be useful in the \(ga\(ga[jwt_keys]\fP
section, where base64 encoded keys may contain some \fB=\fP characters.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
In case when you’d like to remove some parameter from the \fIdefault.ini\fP
without modifying that file, you may override in \fIlocal.ini\fP, but without
any value:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[compactions]
_default =
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This could be read as: “remove the \fI_default\fP parameter from the
\fIcompactions\fP section if it was ever set before”.
.UNINDENT
.UNINDENT
.sp
The semicolon (\fB;\fP) signals the start of a comment. Everything after this
character is ignored by CouchDB.
.sp
After editing the configuration file, CouchDB should be restarted to apply
any changes.
.SS Setting parameters via the HTTP API
.sp
Alternatively, configuration parameters can be set via the
\fI\%HTTP API\fP\&. This API allows changing CouchDB configuration
on\-the\-fly without requiring a server restart:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X PUT http://localhost:5984/_node/<name@host>/_config/uuids/algorithm \-d \(aq\(dqrandom\(dq\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The old parameter’s value is returned in the response:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\(dqsequential\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You should be careful changing configuration via the HTTP API since it’s
possible  to make CouchDB unreachable, for example, by changing the
\fI\%chttpd/bind_address\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X PUT http://localhost:5984/_node/<name@host>/_config/chttpd/bind_address \-d \(aq\(dq10.10.0.128\(dq\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If you make a typo or the specified IP address is not available from your
network, CouchDB will be unreachable. The only way to resolve this will be
to remote into the server, correct the config file, and restart CouchDB. To
protect yourself against such accidents you may set the
\fI\%chttpd/config_whitelist\fP of permitted configuration parameters for
updates via the HTTP API. Once this option is set, further changes to
non\-whitelisted parameters must take place via the configuration file, and in
most cases, will also require a server restart before taking effect.
.SS Configuring the local node
.sp
While the \fI\%HTTP API\fP allows configuring all nodes in the
cluster, as a convenience, you can use the literal string \fB_local\fP in place
of the node name, to interact with the local node’s configuration.  For
example:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X PUT http://localhost:5984/_node/_local/_config/uuids/algorithm \-d \(aq\(dqrandom\(dq\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Base Configuration
.SS Base CouchDB Options
.INDENT 0.0
.TP
.B [couchdb]
.INDENT 7.0
.TP
.B attachment_stream_buffer_size
Higher values may result in better read performance due to fewer read
operations and/or more OS page cache hits. However, they can also
increase overall response time for writes when there are many
attachment write requests in parallel.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[couchdb]
attachment_stream_buffer_size = 4096
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B database_dir
Specifies location of CouchDB database files (\fB*.couch\fP named). This
location should be writable and readable for the user the CouchDB
service runs as (\fBcouchdb\fP by default).
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[couchdb]
database_dir = /var/lib/couchdb
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B default_security
Changed in version 3.0: \fBadmin_only\fP is now the default.

.sp
Default security object for databases if not explicitly set. When set
to \fBeveryone\fP, anyone can performs reads and writes. When set to
\fBadmin_only\fP, only admins can read and write. When set to
\fBadmin_local\fP, sharded databases can be read and written by anyone
but the shards can only be read and written by admins.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[couchdb]
default_security = admin_only
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B enable_database_recovery
Enable this to only “soft\-delete” databases when
\fI\%DELETE /{db}\fP DELETE  requests are made. This will
rename all shards of the database with a suffix of the form
\fB<dbname>.YMD.HMS.deleted.couchdb\fP\&. You can then manually delete these
files later, as desired.
.sp
Default is \fBfalse\fP\&.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[couchdb]
enable_database_recovery = false
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B file_compression
Changed in version 1.2: Added \fI\%Google Snappy\fP compression algorithm.

.sp
Method used to compress everything that is appended to database and
view index files, except for attachments (see the
\fI\%attachments\fP section). Available methods are:
.INDENT 7.0
.IP \(bu 2
\fBnone\fP: no compression
.IP \(bu 2
\fBsnappy\fP: use Google Snappy, a very fast compressor/decompressor
.IP \(bu 2
\fBdeflate_N\fP: use zlib’s deflate; \fBN\fP is the compression level
which ranges from \fB1\fP (fastest, lowest compression ratio) to \fB9\fP
(slowest, highest compression ratio)
.UNINDENT
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[couchdb]
file_compression = snappy
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B maintenance_mode
A CouchDB node may be put into two distinct maintenance modes by setting
this configuration parameter.
.INDENT 7.0
.IP \(bu 2
\fBtrue\fP: The node will not respond to clustered requests from other
nodes and the /_up endpoint will return a 404 response.
.IP \(bu 2
\fBnolb\fP: The /_up endpoint will return a 404 response.
.IP \(bu 2
\fBfalse\fP: The node responds normally, /_up returns a 200 response.
.UNINDENT
.sp
It is expected that the administrator has configured a load balancer
in front of the CouchDB nodes in the cluster. This load balancer should
use the /_up endpoint to determine whether or not to send HTTP requests
to any particular node. For HAProxy, the following config is
appropriate:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
http\-check disable\-on\-404
option httpchk GET /_up
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B max_dbs_open
This option places an upper bound on the number of databases that can
be open at once. CouchDB reference counts database accesses internally
and will close idle databases as needed. Sometimes it is necessary to
keep more than the default open at once, such as in deployments where
many databases will be replicating continuously.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[couchdb]
max_dbs_open = 100
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B max_document_size
Changed in version 3.0.0.

.sp
Limit maximum document body size. Size is calculated based on the
serialized Erlang representation of the JSON document body, because
that reflects more accurately the amount of storage consumed on disk.
In particular, this limit does not include attachments.
.sp
HTTP requests which create or update documents will fail with error
code 413 if one or more documents is larger than this configuration
value.
.sp
In case of \fB_update\fP handlers, document size is checked after the
transformation and right before being inserted into the database.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[couchdb]
max_document_size = 8000000 ; bytes
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBWARNING:\fP
.INDENT 7.0
.INDENT 3.5
Before version 2.1.0 this setting was implemented by simply checking
http request body sizes. For individual document updates via \fIPUT\fP
that approximation was close enough, however that is not the case
for \fB_bulk_docs\fP endpoint. After 2.1.0 a separate configuration
parameter was defined: \fI\%chttpd/max_http_request_size\fP,
which can be used to limit maximum http request sizes. After upgrade,
it is advisable to review those settings and adjust them accordingly.
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B os_process_timeout
If an external process, such as a query server or external process,
runs for this amount of milliseconds without returning any results, it
will be terminated. Keeping this value smaller ensures you get
expedient errors, but you may want to tweak it for your specific
needs.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[couchdb]
os_process_timeout = 5000 ; 5 sec
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B single_node
New in version 3.0.0.

.sp
When this configuration setting is set to \fBtrue\fP, automatically
create the system databases on startup. Must be set \fBfalse\fP for a
clustered CouchDB installation.
.UNINDENT
.INDENT 7.0
.TP
.B uri_file
This file contains the full \fI\%URI\fP that can be used to access this
instance of CouchDB. It is used to help discover the port CouchDB is
running on (if it was set to \fB0\fP (e.g. automatically assigned any
free one). This file should be writable and readable for the user that
runs the CouchDB service (\fBcouchdb\fP by default).
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[couchdb]
uri_file = /var/run/couchdb/couchdb.uri
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B users_db_security_editable
New in version 3.0.0.

.sp
When this configuration setting is set to \fBfalse\fP, reject any attempts
to modify the \fB_users\fP database security object. Modification of this
object is deprecated in 3.x and will be completely disallowed in CouchDB
4.x.
.UNINDENT
.INDENT 7.0
.TP
.B users_db_suffix
Specifies the suffix (last component of a name) of the system database
for storing CouchDB users.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[couchdb]
users_db_suffix = _users
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBWARNING:\fP
.INDENT 7.0
.INDENT 3.5
If you change the database name, do not forget to remove or clean
up the old database, since it will no longer be protected by
CouchDB.
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B util_driver_dir
Specifies location of binary drivers (\fIicu\fP, \fIejson\fP, etc.). This
location and its contents should be readable for the user that runs the
CouchDB service.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[couchdb]
util_driver_dir = /usr/lib/couchdb/erlang/lib/couch\-1.5.0/priv/lib
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B uuid
New in version 1.3.

.sp
Unique identifier for this CouchDB server instance.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[couchdb]
uuid = 0a959b9b8227188afc2ac26ccdf345a6
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B view_index_dir
Specifies location of CouchDB view index files. This location should be
writable and readable for the user that runs the CouchDB service
(\fBcouchdb\fP by default).
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[couchdb]
view_index_dir = /var/lib/couchdb
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Configuring Clustering
.SS Cluster Options
.INDENT 0.0
.TP
.B [cluster]
.INDENT 7.0
.TP
.B q
.UNINDENT
.sp
Sets the default number of shards for newly created databases. The
default value, \fB2\fP, splits a database into 2 separate partitions.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[cluster]
q = 2
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
For systems with only a few, heavily accessed, large databases, or
for servers with many CPU cores, consider increasing this value to
\fB4\fP or \fB8\fP\&.
.sp
The value of \fBq\fP can also be overridden on a per\-DB basis, at DB
creation time.
.sp
\fBSEE ALSO:\fP
.INDENT 7.0
.INDENT 3.5
\fI\%PUT /{db}\fP
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B n
.UNINDENT
.sp
Sets the number of replicas of each document in a cluster. CouchDB will
only place one replica per node in a cluster. When set up through the
\fI\%Cluster Setup Wizard\fP, a standalone single
node will have \fBn = 1\fP, a two node cluster will have \fBn = 2\fP, and
any larger cluster will have \fBn = 3\fP\&. It is recommended not to set
\fBn\fP greater than \fB3\fP\&.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[cluster]
n = 3
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B placement
.UNINDENT
.sp
\fBWARNING:\fP
.INDENT 7.0
.INDENT 3.5
Use of this option will \fBoverride\fP the \fBn\fP option for replica
cardinality. Use with care.
.UNINDENT
.UNINDENT
.sp
Sets the cluster\-wide replica placement policy when creating new
databases. The value must be a comma\-delimited list of strings of the
format \fBzone_name:#\fP, where \fBzone_name\fP is a zone as specified in
the \fBnodes\fP database and \fB#\fP is an integer indicating the number of
replicas to place on nodes with a matching \fBzone_name\fP\&.
.sp
This parameter is not specified by default.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[cluster]
placement = metro\-dc\-a:2,metro\-dc\-b:1
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBSEE ALSO:\fP
.INDENT 7.0
.INDENT 3.5
\fI\%Placing a database on specific nodes\fP
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B seedlist
.UNINDENT
.sp
An optional, comma\-delimited list of node names that this node should
contact in order to join a cluster. If a seedlist is configured the \fB_up\fP
endpoint will return a 404 until the node has successfully contacted at
least one of the members of the seedlist and replicated an up\-to\-date copy
of the \fB_nodes\fP, \fB_dbs\fP, and \fB_users\fP system databases.
.INDENT 7.0
.INDENT 3.5
[cluster]
seedlist = \fI\%couchdb@node1.example.com\fP,couchdb@node2.example.com
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B reconnect_interval_sec
New in version 3.3.

.UNINDENT
.sp
Period in seconds specifying how often to attempt reconnecting to
disconnected nodes. There is a 25% random jitter applied to this
value.
.UNINDENT
.SS RPC Performance Tuning
.INDENT 0.0
.TP
.B [rexi]
CouchDB uses distributed Erlang to communicate between nodes in a cluster.
The \fBrexi\fP library provides an optimized RPC mechanism over this
communication channel. There are a few configuration knobs for this system,
although in general the defaults work well.
.INDENT 7.0
.TP
.B buffer_count
.UNINDENT
.sp
The local RPC server will buffer messages if a remote node goes unavailable.
This flag determines how many messages will be buffered before the local
server starts dropping messages. Default value is \fB2000\fP\&.
.INDENT 7.0
.TP
.B server_per_node
.UNINDENT
.sp
By default, rexi will spawn one local gen_server process for each node in
the cluster. Disabling this flag will cause CouchDB to use a single process
for all RPC communication, which is not recommended in high throughput
deployments.
.INDENT 7.0
.TP
.B stream_limit
New in version 3.0.

.UNINDENT
.sp
This flag comes into play during streaming operations like views and change
feeds. It controls how many messages a remote worker process can send to a
coordinator without waiting for an acknowledgement from the coordinator
process. If this value is too large the coordinator can become overwhelmed
by messages from the worker processes and actually deliver lower overall
throughput to the client. In CouchDB 2.x this value was hard\-coded to
\fB10\fP\&. In the 3.x series it is configurable and defaults to \fB5\fP\&.
Databases with a high \fBq\fP value are especially sensitive to this setting.
.UNINDENT
.SS Database Per User
.SS Database Per User Options
.INDENT 0.0
.TP
.B [couch_peruser]
.INDENT 7.0
.TP
.B enable
.UNINDENT
.sp
If set to \fBtrue\fP, couch_peruser ensures that a private per\-user
database exists for each document in \fB_users\fP\&. These databases are
writable only by the corresponding user. Database names are in the following
form: \fBuserdb\-{UTF\-8 hex encoded username}\fP\&.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[couch_peruser]
enable = false
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 7.0
.INDENT 3.5
The \fB_users\fP database must exist before couch_peruser can be enabled.
.UNINDENT
.UNINDENT
.sp
\fBTIP:\fP
.INDENT 7.0
.INDENT 3.5
Under NodeJS, user names can be converted to and from database names thusly:
.UNINDENT
.UNINDENT
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
function dbNameToUsername(prefixedHexName) {
  return Buffer.from(prefixedHexName.replace(\(aquserdb\-\(aq, \(aq\(aq), \(aqhex\(aq).toString(\(aqutf8\(aq);
}

function usernameToDbName(name) {
  return \(aquserdb\-\(aq + Buffer.from(name).toString(\(aqhex\(aq);
}
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B delete_dbs
.UNINDENT
.sp
If set to \fBtrue\fP and a user is deleted, the respective database gets
deleted as well.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[couch_peruser]
delete_dbs = false
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Note: When using JWT authorization, the provided token must include a custom
\fB_couchdb.roles=[\(aq_admin\(aq]\fP claim to for the peruser database to be properly
created and accessible for the user provided in the \fBsub=\fP claim.
.INDENT 7.0
.TP
.B q
.UNINDENT
.sp
If set, specify the sharding value for per\-user databases. If unset, the
cluster default value will be used.
.INDENT 7.0
.INDENT 3.5
[couch_peruser]
q = 1
.UNINDENT
.UNINDENT
.UNINDENT
.SS CouchDB HTTP Server
.SS HTTP Server Options
.INDENT 0.0
.TP
.B [chttpd]
.
\fBNOTE:\fP
.INDENT 7.0
.INDENT 3.5
In CouchDB 2.x and 3.x, the \fIchttpd\fP section refers to the standard, clustered
port. All use of CouchDB, aside from a few specific maintenance tasks as
described in this documentation, should be performed over this port.
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B bind_address
Defines the IP address by which the clustered port is available:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
bind_address = 127.0.0.1
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
To let CouchDB listen any available IP address, use \fB0.0.0.0\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
bind_address = 0.0.0.0
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
For IPv6 support you need to set \fB::1\fP if you want to let CouchDB
listen correctly:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
bind_address = ::1
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
or \fB::\fP for any available:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
bind_address = ::
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B port
Defines the port number to listen:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
port = 5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
To let CouchDB use any free port, set this option to \fB0\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
port = 0
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B prefer_minimal
If a request has the header \fB\(dqPrefer\(dq: \(dqreturn=minimal\(dq\fP, CouchDB
will only send the headers that are listed for the \fBprefer_minimal\fP
configuration.:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
prefer_minimal = Cache\-Control, Content\-Length, Content\-Range, Content\-Type, ETag, Server, Transfer\-Encoding, Vary
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBWARNING:\fP
.INDENT 7.0
.INDENT 3.5
Removing the Server header from the settings will mean that
the CouchDB server header is replaced with the
MochiWeb server header.
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B authentication_handlers
List of authentication handlers used by CouchDB. You may
extend them via third\-party plugins or remove some of them if you won’t
let users to use one of provided methods:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
authentication_handlers = {chttpd_auth, cookie_authentication_handler}, {chttpd_auth, default_authentication_handler}
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 7.0
.IP \(bu 2
\fB{chttpd_auth, cookie_authentication_handler}\fP: used for Cookie auth;
.IP \(bu 2
\fB{chttpd_auth, proxy_authentication_handler}\fP: used for Proxy auth;
.IP \(bu 2
\fB{chttpd_auth, jwt_authentication_handler}\fP: used for JWT auth;
.IP \(bu 2
\fB{chttpd_auth, default_authentication_handler}\fP: used for Basic auth;
.IP \(bu 2
\fB{couch_httpd_auth, null_authentication_handler}\fP: disables auth, breaks CouchDB.
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B buffer_response
Changed in version 3.1.1.

.sp
Set this to \fBtrue\fP to delay the start of a response until the end has
been calculated. This increases memory usage, but simplifies client error
handling as it eliminates the possibility that a response may be deliberately
terminated midway through, due to a timeout. This config value may be changed
at runtime, without impacting any in\-flight responses.
.sp
Even if this is set to \fBfalse\fP (the default), buffered responses can be
enabled on a per\-request basis for any delayed JSON response call by adding
\fB?buffer_response=true\fP to the request’s parameters.
.UNINDENT
.INDENT 7.0
.TP
.B allow_jsonp
Changed in version 3.2: moved from [httpd] to [chttpd] section

.sp
The \fBtrue\fP value of this option enables \fI\%JSONP\fP support (it’s
\fBfalse\fP by default):
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
allow_jsonp = false
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B changes_timeout
Changed in version 3.2: moved from [httpd] to [chttpd] section

.sp
Specifies default \fItimeout\fP value for \fI\%Changes Feed\fP in
milliseconds (60000 by default):
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
changes_timeout = 60000 ; 60 seconds
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B config_whitelist
Changed in version 3.2: moved from [httpd] to [chttpd] section

.sp
Sets the configuration modification whitelist. Only whitelisted values
may be changed via the \fI\%config API\fP\&. To allow the
admin to change this value over HTTP, remember to include
\fB{chttpd,config_whitelist}\fP itself. Excluding it from the list would
require editing this file to update the whitelist:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
config_whitelist = [{chttpd,config_whitelist}, {log,level}, {etc,etc}]
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B enable_cors
New in version 1.3.

.sp
Changed in version 3.2: moved from [httpd] to [chttpd] section

.sp
Controls \fI\%CORS\fP feature:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
enable_cors = false
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B secure_rewrites
Changed in version 3.2: moved from [httpd] to [chttpd] section

.sp
This option allow to isolate databases via subdomains:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
secure_rewrites = true
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B x_forwarded_host
Changed in version 3.2: moved from [httpd] to [chttpd] section

.sp
The \fIx_forwarded_host\fP header (\fBX\-Forwarded\-Host\fP by default) is used
to forward the original value of the \fBHost\fP header field in case, for
example, if a reverse proxy is rewriting the “Host” header field to
some internal host name before forward the request to CouchDB:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
x_forwarded_host = X\-Forwarded\-Host
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This header has higher priority above \fBHost\fP one, if only it exists
in the request.
.UNINDENT
.INDENT 7.0
.TP
.B x_forwarded_proto
Changed in version 3.2: moved from [httpd] to [chttpd] section

.sp
\fIx_forwarded_proto\fP header (\fBX\-Forwarder\-Proto\fP by default) is used
for identifying the originating protocol of an HTTP request, since a
reverse proxy may communicate with CouchDB instance using HTTP even if
the request to the reverse proxy is HTTPS:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
x_forwarded_proto = X\-Forwarded\-Proto
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B x_forwarded_ssl
Changed in version 3.2: moved from [httpd] to [chttpd] section

.sp
The \fIx_forwarded_ssl\fP header (\fBX\-Forwarded\-Ssl\fP by default) tells
CouchDB that it should use the \fIhttps\fP scheme instead of the \fIhttp\fP\&.
Actually, it’s a synonym for \fBX\-Forwarded\-Proto: https\fP header, but
used by some reverse proxies:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
x_forwarded_ssl = X\-Forwarded\-Ssl
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B enable_xframe_options
Changed in version 3.2: moved from [httpd] to [chttpd] section

.sp
Controls \fI\%Enables or disabled\fP feature:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
enable_xframe_options = false
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B max_http_request_size
Changed in version 3.2: moved from [httpd] to [chttpd] section

.sp
Limit the maximum size of the HTTP request body. This setting applies
to all requests and it doesn’t discriminate between single vs.
multi\-document operations. So setting it to 1MB would block a
\fIPUT\fP of a document larger than 1MB, but it might also block a
\fB_bulk_docs\fP update of 1000 1KB documents, or a multipart/related
update of a small document followed by two 512KB attachments. This
setting is intended to be used as a protection against maliciously
large HTTP requests rather than for limiting maximum document sizes.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
max_http_request_size = 4294967296 ; 4 GB
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBWARNING:\fP
.INDENT 7.0
.INDENT 3.5
Before version 2.1.0 \fI\%couchdb/max_document_size\fP was
implemented effectively as \fBmax_http_request_size\fP\&. That is, it
checked HTTP request bodies instead of document sizes. After the
upgrade, it is advisable to review the usage of these configuration
settings.
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B bulk_get_use_batches
New in version 3.3.

.sp
Set to false to revert to a previous \fB_bulk_get\fP implementation using
single doc fetches internally. Using batches should be faster, however
there may be bugs in the new new implemention, so expose this option to
allow reverting to the old behavior.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
bulk_get_use_batches = true
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B admin_only_all_dbs
New in version 2.2: implemented for \fB_all_dbs\fP defaulting to \fBfalse\fP

.sp
Changed in version 3.0: default switched to \fBtrue\fP, applies to \fB_all_dbs\fP

.sp
Changed in version 3.3: applies for \fB_all_dbs\fP and \fB_dbs_info\fP

.sp
When set to \fBtrue\fP admin is required to access \fB_all_dbs\fP and
\fB_dbs_info\fP\&.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
admin_only_all_dbs = true
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B disconnect_check_msec
New in version 3.3.3.

.sp
How often, in milliseconds, to check for client disconnects while
processing streaming requests such as _all_docs, _find, _changes and
views.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
disconnect_check_msec = 30000
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B disconnect_check_jitter_msec
New in version 3.3.3.

.sp
How much random jitter to apply to the \fBdisconnect_check_msec\fP
period. This is to avoid stampede in case of a large number of
concurrent clients.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
disconnect_check_jitter_msec = 15000
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B [httpd]
Changed in version 3.2: These options were moved to [chttpd] section:
\fIallow_jsonp\fP, \fIchanges_timeout\fP, \fIconfig_whitelist\fP,
\fIenable_cors\fP, \fIsecure_rewrites\fP, \fIx_forwarded_host\fP,
\fIx_forwarded_proto\fP, \fIx_forwarded_ssl\fP,
\fIenable_xframe_options\fP, \fImax_http_request_size\fP\&.

.INDENT 7.0
.TP
.B server_options
Server options for the MochiWeb component of CouchDB can be added to
the configuration files:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[httpd]
server_options = [{backlog, 128}, {acceptor_pool_size, 16}]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The options supported are a subset of full options supported by the
TCP/IP stack. A list of the supported options are provided in the
\fI\%Erlang inet\fP documentation.
.UNINDENT
.INDENT 7.0
.TP
.B socket_options
The socket options for the listening socket in CouchDB, as set at the
beginning of ever request, can be specified as a list of tuples. For example:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[httpd]
socket_options = [{sndbuf, 262144}]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The options supported are a subset of full options supported by the
TCP/IP stack. A list of the supported options are provided in the
\fI\%Erlang inet\fP documentation.
.UNINDENT
.UNINDENT
.SS HTTPS (SSL/TLS) Options
.INDENT 0.0
.TP
.B [ssl]
CouchDB supports TLS/SSL natively, without the use of a proxy server.
.sp
HTTPS setup can be tricky, but the configuration in CouchDB was designed to
be as easy as possible. All you need is two files; a certificate and a
private key. If you have an official certificate from a certificate
authority, both should be in your possession already.
.sp
If you just want to try this out and don’t want to go through the hassle of
obtaining an official certificate, you can create a self\-signed certificate.
Everything will work the same, but clients will get a warning about an insecure
certificate.
.sp
You will need the \fI\%OpenSSL\fP command line tool installed. It probably
already is.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
shell> mkdir /etc/couchdb/cert
shell> cd /etc/couchdb/cert
shell> openssl genrsa > privkey.pem
shell> openssl req \-new \-x509 \-key privkey.pem \-out couchdb.pem \-days 1095
shell> chmod 600 privkey.pem couchdb.pem
shell> chown couchdb privkey.pem couchdb.pem
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Now, you need to edit CouchDB’s configuration, by editing your
\fBlocal.ini\fP file. Here is what you need to do.
.sp
Under the \fB[ssl]\fP section, enable HTTPS and set up the newly generated
certificates:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[ssl]
enable = true
cert_file = /etc/couchdb/cert/couchdb.pem
key_file = /etc/couchdb/cert/privkey.pem
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
For more information please read \fI\%certificates HOWTO\fP\&.
.sp
Now start (or restart) CouchDB. You should be able to connect to it
using HTTPS on port 6984:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
shell> curl https://127.0.0.1:6984/
curl: (60) SSL certificate problem, verify that the CA cert is OK. Details:
error:14090086:SSL routines:SSL3_GET_SERVER_CERTIFICATE:certificate verify failed
More details here: http://curl.haxx.se/docs/sslcerts.html

curl performs SSL certificate verification by default, using a \(dqbundle\(dq
of Certificate Authority (CA) public keys (CA certs). If the default
bundle file isn\(aqt adequate, you can specify an alternate file
using the \-\-cacert option.
If this HTTPS server uses a certificate signed by a CA represented in
the bundle, the certificate verification probably failed due to a
problem with the certificate (it might be expired, or the name might
not match the domain name in the URL).
If you\(aqd like to turn off curl\(aqs verification of the certificate, use
the \-k (or \-\-insecure) option.
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Oh no! What happened?! Remember, clients will notify their users that your
certificate is self signed. \fBcurl\fP is the client in this case and it
notifies you. Luckily you trust yourself (don’t you?) and you can specify
the \fB\-k\fP option as the message reads:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
shell> curl \-k https://127.0.0.1:6984/
{\(dqcouchdb\(dq:\(dqWelcome\(dq,\(dqversion\(dq:\(dq1.5.0\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
All done.
.sp
For performance reasons, and for ease of setup, you may still wish to
terminate HTTPS connections at your load balancer / reverse proxy, then use
unencrypted HTTP between it and your CouchDB cluster. This is a recommended
approach.
.sp
Additional detail may be available in the \fI\%CouchDB wiki\fP\&.
.INDENT 7.0
.TP
.B cacert_file
The path to a file containing PEM encoded CA certificates. The CA
certificates are used to build the server certificate chain, and for
client authentication. Also the CAs are used in the list of acceptable
client CAs passed to the client when a certificate is requested. May be
omitted if there is no need to verify the client and if there are not
any intermediate CAs for the server certificate:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[ssl]
cacert_file = /etc/ssl/certs/ca\-certificates.crt
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B cert_file
Path to a file containing the user’s certificate:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[ssl]
cert_file = /etc/couchdb/cert/couchdb.pem
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B key_file
Path to file containing user’s private PEM encoded key:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[ssl]
key_file = /etc/couchdb/cert/privkey.pem
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B password
String containing the user’s password. Only used if the private key file
is password protected:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[ssl]
password = somepassword
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B ssl_certificate_max_depth
Maximum peer certificate depth (must be set even if certificate
validation is off):
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[ssl]
ssl_certificate_max_depth = 1
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B verify_fun
The verification fun (optional) if not specified, the default
verification fun will be used:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[ssl]
verify_fun = {Module, VerifyFun}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B verify_ssl_certificates
Set to \fBtrue\fP to validate peer certificates:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[ssl]
verify_ssl_certificates = false
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B fail_if_no_peer_cert
Set to \fBtrue\fP to terminate the TLS/SSL handshake with a
\fBhandshake_failure\fP alert message if the client does not send a
certificate. Only used if \fBverify_ssl_certificates\fP is \fBtrue\fP\&. If set
to \fBfalse\fP it will only fail if the client sends an invalid certificate
(an empty certificate is considered valid):
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[ssl]
fail_if_no_peer_cert = false
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B secure_renegotiate
Set to \fBtrue\fP to reject renegotiation attempt that does not live up to
RFC 5746:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[ssl]
secure_renegotiate = true
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B ciphers
Set to the cipher suites that should be supported which can be
specified in erlang format “{ecdhe_ecdsa,aes_128_cbc,sha256}” or
in OpenSSL format “ECDHE\-ECDSA\-AES128\-SHA256”.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[ssl]
ciphers = [\(dqECDHE\-ECDSA\-AES128\-SHA256\(dq, \(dqECDHE\-ECDSA\-AES128\-SHA\(dq]
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B tls_versions
Set to a list of permitted SSL/TLS protocol versions:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[ssl]
tls_versions = [tlsv1 | \(aqtlsv1.1\(aq | \(aqtlsv1.2\(aq]
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Cross\-Origin Resource Sharing
.INDENT 0.0
.TP
.B [cors]
New in version 1.3: added CORS support, see JIRA \fI\%COUCHDB\-431\fP

.sp
Changed in version 3.2: moved from [httpd] to [chttpd] section

.sp
\fICORS\fP, or “Cross\-Origin Resource Sharing”, allows a resource such as a web
page running JavaScript inside a browser, to make AJAX requests
(XMLHttpRequests) to a different domain, without compromising the security
of either party.
.sp
A typical use case is to have a static website hosted on a CDN make
requests to another resource, such as a hosted CouchDB instance. This
avoids needing an intermediary proxy, using \fIJSONP\fP or similar workarounds
to retrieve and host content.
.sp
While CouchDB’s integrated HTTP server has support for document attachments
makes this less of a constraint for pure CouchDB projects, there are many
cases where separating the static content from the database access is
desirable, and CORS makes this very straightforward.
.sp
By supporting CORS functionality, a CouchDB instance can accept direct
connections to protected databases and instances, without the browser
functionality being blocked due to same\-origin constraints. CORS is
supported today on over 90% of recent browsers.
.sp
CORS support is provided as experimental functionality in 1.3, and as such
will need to be enabled specifically in CouchDB’s configuration. While all
origins are forbidden from making requests by default, support is available
for simple requests, preflight requests and per\-vhost configuration.
.sp
This section requires \fI\%chttpd/enable_cors\fP option have
\fBtrue\fP value:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
enable_cors = true
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B credentials
By default, neither authentication headers nor cookies are included in
requests and responses. To do so requires both setting
\fBXmlHttpRequest.withCredentials = true\fP on the request object in the
browser and enabling credentials support in CouchDB.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[cors]
credentials = true
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB will respond to a credentials\-enabled CORS request with an
additional header, \fBAccess\-Control\-Allow\-Credentials=true\fP\&.
.UNINDENT
.INDENT 7.0
.TP
.B origins
List of origins separated by a comma, \fB*\fP means accept all. You can’t
set \fBorigins = *\fP and \fBcredentials = true\fP option at the same
time:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[cors]
origins = *
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Access can be restricted by protocol, host and optionally by port.
Origins must follow the scheme: \fI\%http://example.com:80\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[cors]
origins = http://localhost, https://localhost, http://couch.mydev.name:8080
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Note that by default, no origins are accepted. You must define them
explicitly.
.UNINDENT
.INDENT 7.0
.TP
.B headers
List of accepted headers separated by a comma:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[cors]
headers = X\-Couch\-Id, X\-Couch\-Rev
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B methods
List of accepted methods:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[cors]
methods = GET,POST
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B max_age
Sets the \fBAccess\-Control\-Max\-Age\fP header in seconds. Use it to
avoid repeated \fBOPTIONS\fP requests.
.INDENT 7.0
.INDENT 3.5
[cors]
max_age = 3600
.UNINDENT
.UNINDENT
.UNINDENT
.sp
\fBSEE ALSO:\fP
.INDENT 7.0
.INDENT 3.5
Original JIRA \fI\%implementation ticket\fP
.sp
Standards and References:
.INDENT 0.0
.IP \(bu 2
IETF RFCs relating to methods: \fI\%RFC 2618\fP, \fI\%RFC 2817\fP, \fI\%RFC 5789\fP
.IP \(bu 2
IETF RFC for Web Origins: \fI\%RFC 6454\fP
.IP \(bu 2
W3C \fI\%CORS standard\fP
.UNINDENT
.sp
Mozilla Developer Network Resources:
.INDENT 0.0
.IP \(bu 2
\fI\%Same origin policy for URIs\fP
.IP \(bu 2
\fI\%HTTP Access Control\fP
.IP \(bu 2
\fI\%Server\-side Access Control\fP
.IP \(bu 2
\fI\%JavaScript same origin policy\fP
.UNINDENT
.sp
Client\-side CORS support and usage:
.INDENT 0.0
.IP \(bu 2
\fI\%CORS browser support matrix\fP
.IP \(bu 2
\fI\%COS tutorial\fP
.IP \(bu 2
\fI\%XHR with CORS\fP
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Per Virtual Host Configuration
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
Virtual Hosts are deprecated in CouchDB 3.0, and will be removed in CouchDB 4.0.
.UNINDENT
.UNINDENT
.sp
To set the options for a \fI\%vhosts\fP, you will need to create a section
with the vhost name prefixed by \fBcors:\fP\&. Example case for the vhost
\fIexample.com\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[cors:example.com]
credentials = false
; List of origins separated by a comma
origins = *
; List of accepted headers separated by a comma
headers = X\-CouchDB\-Header
; List of accepted methods
methods = HEAD, GET
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
A video from 2010 on vhost and rewrite configuration \fI\%is available\fP, but is not guaranteed to match current syntax
or behaviour.
.SS Virtual Hosts
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
Virtual Hosts are deprecated in CouchDB 3.0, and will be removed in CouchDB 4.0.
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B [vhosts]
CouchDB can map requests to different locations based on the \fBHost\fP
header, even if they arrive on the same inbound IP address.
.sp
This allows different virtual hosts on the same machine to map to different
databases or design documents, etc. The most common use case is to map a
virtual host to a \fI\%Rewrite Handler\fP, to provide
full control over the application’s URIs.
.sp
To add a virtual host, add a \fICNAME\fP pointer to the DNS for your domain
name. For development and testing, it is sufficient to add an entry in the
hosts file, typically \fI/etc/hosts\(ga\fP on Unix\-like operating systems:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
# CouchDB vhost definitions, refer to local.ini for further details
127.0.0.1       couchdb.local
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Test that this is working:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
$ ping \-n 2 couchdb.local
PING couchdb.local (127.0.0.1) 56(84) bytes of data.
64 bytes from localhost (127.0.0.1): icmp_req=1 ttl=64 time=0.025 ms
64 bytes from localhost (127.0.0.1): icmp_req=2 ttl=64 time=0.051 ms
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Finally, add an entry to your \fI\%configuration file\fP in the
\fB[vhosts]\fP section:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[vhosts]
couchdb.local:5984 = /example
*.couchdb.local:5984 = /example
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If your CouchDB is listening on the the default HTTP port (80), or is
sitting behind a proxy, then you don’t need to specify a port number in the
\fBvhost\fP key.
.sp
The first line will rewrite the request to display the content of the
\fIexample\fP database. This rule works only if the \fBHost\fP header is
\fBcouchdb.local\fP and won’t work for \fICNAMEs\fP\&. The second rule, on the
other hand, matches all \fICNAMEs\fP to \fIexample\fP db, so that both
\fIwww.couchdb.local\fP and \fIdb.couchdb.local\fP will work.
.UNINDENT
.SS Rewriting Hosts to a Path
.sp
Like in the \fI\%_rewrite\fP handler you can match some
variable and use them to create the target path. Some examples:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[vhosts]
*.couchdb.local = /*
:dbname. = /:dbname
:ddocname.:dbname.example.com = /:dbname/_design/:ddocname/_rewrite
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The first rule passes the wildcard as \fBdbname\fP\&. The second one does the same,
but uses a variable name. And the third one allows you to use any URL with
\fBddocname\fP in any database with \fBdbname\fP\&.
.SS X\-Frame\-Options
.sp
X\-Frame\-Options is a response header that controls whether a http response
can be embedded in a <frame>, <iframe> or <object>. This is a security
feature to help against clickjacking.
.INDENT 0.0
.INDENT 3.5
[x_frame_options]
; Settings same\-origin will return X\-Frame\-Options: SAMEORIGIN.
; If same origin is set, it will ignore the hosts setting
; same_origin = true
; Settings hosts will
; return X\-Frame\-Options: ALLOW\-FROM \fI\%https://example.com/\fP
; List of hosts separated by a comma. * means accept all
; hosts =
.UNINDENT
.UNINDENT
.sp
If xframe_options is enabled it will return \fBX\-Frame\-Options: DENY\fP by default.
If \fBsame_origin\fP is enabled it will return \fBX\-Frame\-Options: SAMEORIGIN\fP\&.
A \fBX\-FRAME\-OPTIONS: ALLOW\-FROM url\fP will be returned when \fBsame_origin\fP
is false, and the HOST header matches one of the urls in the \fBhosts\fP config.
Otherwise a \fBX\-Frame\-Options: DENY\fP will be returned.
.SS Authentication and Authorization
.SS Server Administrators
.INDENT 0.0
.TP
.B [admins]
.UNINDENT
.sp
Changed in version 3.0.0: CouchDB requires an admin account to start. If an admin account has not
been created, CouchDB will print an error message and terminate.
.sp
CouchDB server administrators and passwords are not stored in the
\fB_users\fP database, but in the last \fB[admins]\fP section that CouchDB
finds when loading its ini files. See :config:intro for details on config
file order and behaviour. This file (which could be something like
\fB/opt/couchdb/etc/local.ini\fP or
\fB/opt/couchdb/etc/local.d/10\-admins.ini\fP when CouchDB is installed from
packages) should be appropriately secured and     readable only by system
administrators:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[admins]
;admin = mysecretpassword
admin = \-hashed\-6d3c30241ba0aaa4e16c6ea99224f915687ed8cd,7f4a3e05e0cbc6f48a0035e3508eef90
architect = \-pbkdf2\-43ecbd256a70a3a2f7de40d2374b6c3002918834,921a12f74df0c1052b3e562a23cd227f,10000
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Administrators can be added directly to the \fB[admins]\fP section, and when
CouchDB is restarted, the passwords will be salted and encrypted. You may
also use the HTTP interface to create administrator accounts; this way,
you don’t need to restart CouchDB, and there’s no need to temporarily store
or transmit passwords in plaintext. The HTTP
\fB/_node/{node\-name}/_config/admins\fP endpoint supports querying, deleting
or creating new admin accounts:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_node/nonode@nohost/_config/admins HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 196
Content\-Type: application/json
Date: Fri, 30 Nov 2012 11:37:18 GMT
Server: CouchDB (Erlang/OTP)
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqadmin\(dq: \(dq\-hashed\-6d3c30241ba0aaa4e16c6ea99224f915687ed8cd,7f4a3e05e0cbc6f48a0035e3508eef90\(dq,
    \(dqarchitect\(dq: \(dq\-pbkdf2\-43ecbd256a70a3a2f7de40d2374b6c3002918834,921a12f74df0c1052b3e562a23cd227f,10000\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If you already have a salted, encrypted password string (for example, from
an old ini file, or from a different CouchDB server), then you can store
the “raw” encrypted string, without having CouchDB doubly encrypt it.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
PUT /_node/nonode@nohost/_config/admins/architect?raw=true HTTP/1.1
Accept: application/json
Content\-Type: application/json
Content\-Length: 89
Host: localhost:5984

\(dq\-pbkdf2\-43ecbd256a70a3a2f7de40d2374b6c3002918834,921a12f74df0c1052b3e562a23cd227f,10000\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 89
Content\-Type: application/json
Date: Fri, 30 Nov 2012 11:39:18 GMT
Server: CouchDB (Erlang/OTP)

\(dq\-pbkdf2\-43ecbd256a70a3a2f7de40d2374b6c3002918834,921a12f74df0c1052b3e562a23cd227f,10000\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Further details are available in \fIsecurity\fP, including configuring the work
factor for \fBPBKDF2\fP, and the algorithm itself at
\fI\%PBKDF2 (RFC\-2898)\fP\&.
.sp
Changed in version 1.4: \fIPBKDF2\fP server\-side hashed salted password support added, now as a
synchronous call for the \fB_config/admins\fP API.


.SS Authentication Configuration
.INDENT 0.0
.TP
.B [chttpd]
.INDENT 7.0
.TP
.B require_valid_user
Changed in version 3.2: moved from [couch_httpd_auth] to [chttpd] section

.sp
When this option is set to \fBtrue\fP, no requests are allowed from
anonymous users. Everyone must be authenticated.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
require_valid_user = false
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B require_valid_user_except_for_up
When this option is set to \fBtrue\fP, no requests are allowed from
anonymous users, \fIexcept\fP for the \fB/_up\fP endpoint. Everyone else must
be authenticated.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
require_valid_user_except_for_up = false
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B [chttpd_auth]
Changed in version 3.2: These options were moved to [chttpd_auth] section:
\fIauthentication_redirect\fP, \fItimeout\fP,
\fIauth_cache_size\fP, \fIallow_persistent_cookies\fP, \fIiterations\fP,
\fImin_iterations\fP, \fImax_iterations\fP, \fIsecret\fP, \fIusers_db_public\fP,
\fIx_auth_roles\fP, \fIx_auth_token\fP, \fIx_auth_username\fP,
\fIcookie_domain\fP, \fIsame_site\fP\&.

.INDENT 7.0
.TP
.B allow_persistent_cookies
Changed in version 3.2: moved from [couch_httpd_auth] to [chttpd_auth] section

.sp
When set to \fBtrue\fP, CouchDB will set the Max\-Age and Expires attributes
on the cookie, which causes user agents (like browsers) to preserve the cookie
over restarts.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd_auth]
allow_persistent_cookies = true
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B cookie_domain
New in version 2.1.1.

.sp
Changed in version 3.2: moved from [couch_httpd_auth] to [chttpd_auth] section

.sp
Configures the \fBdomain\fP attribute of the \fBAuthSession\fP cookie. By default the
\fBdomain\fP attribute is empty, resulting in the cookie being set on CouchDB’s domain.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd_auth]
cookie_domain = example.com
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B same_site
New in version 3.0.0.

.sp
Changed in version 3.2: moved from [couch_httpd_auth] to [chttpd_auth] section

.sp
When this option is set to a non\-empty value, a \fBSameSite\fP attribute is added to
the \fBAuthSession\fP cookie. Valid values are \fBnone\fP, \fBlax\fP or \fBstrict\fP\&.:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd_auth]
same_site = strict
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B auth_cache_size
Changed in version 3.2: moved from [couch_httpd_auth] to [chttpd_auth] section

.sp
Number of \fI\%User Context Object\fP to cache in memory, to reduce disk
lookups.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd_auth]
auth_cache_size = 50
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B authentication_redirect
Changed in version 3.2: moved from [couch_httpd_auth] to [chttpd_auth] section

.sp
Specifies the location for redirection on successful authentication if
a \fBtext/html\fP response is accepted by the client (via an \fBAccept\fP
header).
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd_auth]
authentication_redirect = /_utils/session.html
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B hash_algorithms
New in version 3.3.

.sp
\fBNOTE:\fP
.INDENT 7.0
.INDENT 3.5
Until CouchDB version 3.3.1, \fI\%Proxy Authentication\fP used only the hash
algorithm \fBsha1\fP as validation of
\fI\%X\-Auth\-CouchDB\-Token\fP\&.
.UNINDENT
.UNINDENT
.sp
Sets the HMAC hash algorithm used for cookie and proxy authentication. You can
provide a comma\-separated list of hash algorithms. New cookie sessions or
session updates are calculated with the first hash algorithm. All values in the
list can be used to decode the cookie session and the token
\fI\%X\-Auth\-CouchDB\-Token\fP for
\fI\%Proxy Authentication\fP\&.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd_auth]
hash_algorithms = sha256, sha
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 7.0
.INDENT 3.5
You can select any hash algorithm the version of erlang used in your CouchDB
install supports. The common list of available hashes might be:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
sha, sha224, sha256, sha384, sha512
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
To retrieve a complete list of supported hash algorithms you can use our
\fBbin/remsh\fP script and retrieve a full list of available hash algorithms
with \fBcrypto:supports(hashs).\fP or use the
\fI\%_node/$node/_versions\fP endpoint to retrieve the
hashes.
.UNINDENT
.UNINDENT
.sp
\fBWARNING:\fP
.INDENT 7.0
.INDENT 3.5
We do not recommend using the following hash algorithms:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
md4, md5
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B iterations
New in version 1.3.

.sp
Changed in version 3.2: moved from [couch_httpd_auth] to [chttpd_auth] section

.sp
The number of iterations for password hashing by the PBKDF2 algorithm.
A higher  number provides better hash durability, but comes at a cost
in performance for each request that requires authentication.
When using hundreds of thousands of iterations, use session cookies, or the performance hit will be huge.
(The internal hashing algorithm is SHA1, which affects the recommended number of iterations.)
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd_auth]
iterations = 10000
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B min_iterations
New in version 1.6.

.sp
Changed in version 3.2: moved from [couch_httpd_auth] to [chttpd_auth] section

.sp
The minimum number of iterations allowed for passwords hashed by the
PBKDF2 algorithm. Any user with fewer iterations is forbidden.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd_auth]
min_iterations = 100
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B max_iterations
New in version 1.6.

.sp
Changed in version 3.2: moved from [couch_httpd_auth] to [chttpd_auth] section

.sp
The maximum number of iterations allowed for passwords hashed by the
PBKDF2 algorithm. Any user with greater iterations is forbidden.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd_auth]
max_iterations = 100000
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B password_regexp
New in version 3.2.

.sp
A list of
\fI\%Regular Expressions\fP
to check new/changed passwords.
When set, new user passwords must \fBmatch\fP all RegExp in this list.
.sp
A RegExp can be paired with a \fIreason text\fP:
\fB[{\(dqRegExp\(dq, \(dqreason text\(dq}, ...]\fP\&.
If a RegExp doesn’t match, its \fIreason text\fP will be appended to the
default reason of \fBPassword does not conform to requirements.\fP
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[couch_httpd_auth]
; Password must be 10 chars long and have one or more uppercase and
; lowercase char and one or more numbers.
password_regexp = [{\(dq.{10,}\(dq, \(dqMin length is 10 chars.\(dq}, \(dq[A\-Z]+\(dq, \(dq[a\-z]+\(dq, \(dq\e\ed+\(dq]
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B proxy_use_secret
Changed in version 3.2: moved from [couch_httpd_auth] to [chttpd_auth] section

.sp
When this option is set to \fBtrue\fP, the
\fI\%chttpd_auth/secret\fP option is required for
\fI\%Proxy Authentication\fP\&.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd_auth]
proxy_use_secret = false
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B public_fields
New in version 1.4.

.sp
Changed in version 3.2: moved from [couch_httpd_auth] to [chttpd_auth] section

.sp
A comma\-separated list of field names in user documents (in
\fI\%couchdb/users_db_suffix\fP) that can be read by any
user. If unset or not specified, authenticated users can only retrieve
their own document.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd_auth]
public_fields = first_name, last_name, contacts, url
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 7.0
.INDENT 3.5
Using the \fBpublic_fields\fP allowlist for user document properties
requires setting the \fI\%chttpd_auth/users_db_public\fP
option to \fBtrue\fP (the latter option has no other purpose):
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd_auth]
users_db_public = true
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B secret
Changed in version 3.2: moved from [couch_httpd_auth] to [chttpd_auth] section

.sp
The secret token is used for \fI\%Proxy Authentication\fP and for \fI\%Cookie Authentication\fP\&.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd_auth]
secret = 92de07df7e7a3fe14808cef90a7cc0d91
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B timeout
Changed in version 3.2: moved from [couch_httpd_auth] to [chttpd_auth] section

.sp
Number of seconds since the last request before sessions will be
expired.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd_auth]
timeout = 600
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B users_db_public
New in version 1.4.

.sp
Changed in version 3.2: moved from [couch_httpd_auth] to [chttpd_auth] section

.sp
Allow all users to view user documents. By default, only admins may
browse all users documents, while users may browse only their own
document.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd_auth]
users_db_public = false
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B x_auth_roles
Changed in version 3.2: moved from [couch_httpd_auth] to [chttpd_auth] section

.sp
The HTTP header name (\fBX\-Auth\-CouchDB\-Roles\fP by default) that
contains the list of a user’s roles, separated by a comma. Used for
\fI\%Proxy Authentication\fP\&.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd_auth]
x_auth_roles = X\-Auth\-CouchDB\-Roles
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B x_auth_token
Changed in version 3.2: moved from [couch_httpd_auth] to [chttpd_auth] section

.sp
The HTTP header name (\fBX\-Auth\-CouchDB\-Token\fP by default) containing
the token used to authenticate the authorization. This token is an
\fIHMAC\-SHA1\fP created from the \fI\%chttpd_auth/secret\fP and
\fI\%chttpd_auth/x_auth_username\fP\&. The secret key should be
the same on the client and the CouchDB node. This token is optional if
the value of the \fI\%chttpd_auth/proxy_use_secret\fP option is
not \fBtrue\fP\&. Used for \fI\%Proxy Authentication\fP\&.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd_auth]
x_auth_token = X\-Auth\-CouchDB\-Token
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B x_auth_username
Changed in version 3.2: moved from [couch_httpd_auth] to [chttpd_auth] section

.sp
The HTTP header name (\fBX\-Auth\-CouchDB\-UserName\fP by default)
containing the username. Used for \fI\%Proxy Authentication\fP\&.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd_auth]
x_auth_username = X\-Auth\-CouchDB\-UserName
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B [jwt_auth]
.INDENT 7.0
.TP
.B required_claims
This parameter is a comma\-separated list of additional mandatory JWT claims
that must be present in any presented JWT token. A \fI\%404 Not Found\fP
is sent if any are missing.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[jwt_auth]
    required_claims = exp,iat
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B roles_claim_name
.
\fBWARNING:\fP
.INDENT 7.0
.INDENT 3.5
\fBroles_claim_name\fP is deprecated in CouchDB 3.3, and will be removed later.
Please migrate to \fBroles_claim_path\fP\&.
.UNINDENT
.UNINDENT
.sp
If presented, as a JSON array of strings, it is used as the CouchDB user’s roles
list as long as the JWT token is valid. The default value for \fBroles_claim_name\fP
is \fB_couchdb.roles\fP\&.
.sp
\fBNOTE:\fP
.INDENT 7.0
.INDENT 3.5
Values for \fBroles_claim_name\fP can only be top\-level attributes in the JWT
token. If \fBroles_claim_path\fP is set, then \fBroles_claim_name\fP is ignored!
.UNINDENT
.UNINDENT
.sp
Let’s assume, we have the following configuration:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[jwt_auth]
roles_claim_name = my\-couchdb.roles
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB will search for the attribute \fBmy\-couchdb.roles\fP in the JWT token.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqmy\-couchdb.roles\(dq: [
        \(dqrole_1\(dq,
        \(dqrole_2\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B roles_claim_path
New in version 3.3.

.sp
This parameter was introduced to overcome disadvantages of \fBroles_claim_name\fP,
because it is not possible with \fBroles_claim_name\fP to map nested role
attributes in the JWT token.
.sp
\fBNOTE:\fP
.INDENT 7.0
.INDENT 3.5
If \fBroles_claim_path\fP is set, then \fBroles_claim_name\fP is ignored!
.UNINDENT
.UNINDENT
.sp
Now it is possible the read a nested roles claim from JWT tokens into CouchDB. As
always, there is some theory at the beginning to get things up and running. Don’t
get scared now, it’s really short and easy. Honestly!
.sp
There are only two characters with a special meaning. These are
.INDENT 7.0
.INDENT 3.5
.INDENT 0.0
.IP \(bu 2
\fB\&.\fP for nesting json attributes and
.IP \(bu 2
\fB\e.\fP to skip nesting
.UNINDENT
.UNINDENT
.UNINDENT
.sp
That’s it. Really.
.sp
Let’s assume there is the following data\-payload in the JWT token:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqresource_access\(dq: {
        \(dqsecurity.settings\(dq: {
            \(dqaccount\(dq: {
                \(dqroles\(dq: [
                    \(dqmanage\-account\(dq,
                    \(dqview\-profile\(dq
                ]
            }
        }
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Now, let’s define the config variable \fBroles_claim_path\fP for this example. It
should look like this:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
roles_claim_path = resource_access.security\e.settings.account.roles
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If an attribute has a \fB\&.\fP in the key like \fBsecurity.settings\fP, you have to
escape it in the config parameter with \fB\e.\fP\&. If you use a \fB\&.\fP then it gets
interpreted as a nested sub\-key. Let’s illustrate the behavior with a second
example. There is the following config parameter for \fBroles_claim_name\fP (by the
way it was the default value if you didn’t configured it):
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
roles_claim_name = _couchdb.roles
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 7.0
.INDENT 3.5
CouchDB doesn’t set any default or implicit value for \fBroles_claim_path\fP\&.
.UNINDENT
.UNINDENT
.sp
To migrate from \fBroles_claim_name\fP to \fBroles_claim_path\fP you need to change
the parameter name and escape the \fB\&.\fP to prevent CouchDB to read this as a
nested JSON key.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
roles_claim_path = _couchdb\e.roles
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Let’s assume your JWT token have the following data\-payload for your couchdb
roles claim:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_couchdb.roles\(dq: [
        \(dqaccounting\-role\(dq,
        \(dqview\-role\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If you did everything right, the response from the \fB_session\fP endpoint should
look something like this:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_session HTTP/1.1
Host: localhost:5984
Authorization: Bearer <JWT token>
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Content\-Type: application/json
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqok\(dq: true,
    \(dquserCtx\(dq: {
        \(dqname\(dq: \(dq1234567890\(dq,
        \(dqroles\(dq: [
            \(dqaccounting\-role\(dq,
            \(dqview\-role\(dq
        ]
    },
    \(dqinfo\(dq: {
    \(dqauthentication_handlers\(dq: [
        \(dqjwt\(dq,
        \(dqproxy\(dq,
        \(dqcookie\(dq,
        \(dqdefault\(dq
    ],
    \(dqauthenticated\(dq: \(dqjwt\(dq
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
That’s all, you are done with the migration from \fBroles_claim_name\fP to
\fBroles_claim_path\fP Easy, isn’t it?
.UNINDENT
.UNINDENT
.SS Compaction
.SS Database Compaction Options
.INDENT 0.0
.TP
.B [database_compaction]
.INDENT 7.0
.TP
.B doc_buffer_size
Specifies the copy buffer’s maximum size in bytes:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[database_compaction]
doc_buffer_size = 524288
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B checkpoint_after
Triggers a checkpoint after the specified amount of bytes were
successfully copied to the compacted database:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[database_compaction]
checkpoint_after = 5242880
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS View Compaction Options
.INDENT 0.0
.TP
.B [view_compaction]
.INDENT 7.0
.TP
.B keyvalue_buffer_size
Specifies maximum copy buffer size in bytes used during compaction:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[view_compaction]
keyvalue_buffer_size = 2097152
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Compaction Daemon
.sp
CouchDB ships with an automated, event\-driven daemon internally known as “smoosh” that
continuously re\-prioritizes the database and secondary index files on each node and
automatically compacts the files that will recover the most free space according to the
following parameters.
.INDENT 0.0
.TP
.B [smoosh]
.INDENT 7.0
.TP
.B db_channels
A comma\-delimited list of channels that are sent the names of database
files when those files are updated. Each channel can choose whether to
enqueue the database for compaction; once a channel has enqueued the
database, no additional channel in the list will be given the
opportunity to do so.
.UNINDENT
.INDENT 7.0
.TP
.B view_channels
A comma\-delimited list of channels that are sent the names of secondary
index files when those files are updated. Each channel can choose
whether to enqueue the index for compaction; once a channel has enqueued
the index, no additional channel in the list will be given the
opportunity to do so.
.UNINDENT
.INDENT 7.0
.TP
.B staleness
The number of minutes that the (expensive) priority calculation on an
individual can be stale for before it is recalculated. Defaults to 5.
.UNINDENT
.INDENT 7.0
.TP
.B cleanup_index_files
If set to true, the compaction daemon will delete the files for indexes
that are no longer associated with any design document. Defaults to
\fIfalse\fP and probably shouldn’t be changed unless the node is running low
on disk space, and only after considering the ramifications.
.UNINDENT
.INDENT 7.0
.TP
.B wait_secs
The time a channel waits before starting compactions to allow time to
observe the system and make a smarter decision about what to compact
first. Hardly ever changed from the default of 30 (seconds).
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B [smoosh.<channel>]
.UNINDENT
.sp
The following settings control the resource allocation for a given compaction
channel.
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.TP
.B capacity
The maximum number of items the channel can hold (lowest priority item
is removed to make room for new items). Defaults to 9999.
.UNINDENT
.INDENT 0.0
.TP
.B concurrency
The maximum number of jobs that can run concurrently in this channel.
Defaults to 1.
.UNINDENT
.INDENT 0.0
.TP
.B from
.UNINDENT
.INDENT 0.0
.TP
.B to
The time period during which this channel is allowed to execute
compactions. The value for each of these parameters must obey the format
\fIHH:MM\fP with HH in [0..23] and MM in [0..59]. Each channel listed in the
top\-level daemon configuration continuously builds its priority queue
regardless of the period defined here. The default is to allow the
channel to execute compactions all the time.
.UNINDENT
.INDENT 0.0
.TP
.B strict_window
If set to \fBtrue\fP, any compaction that is still running after the end of
the allowed perio will be suspended, and then resumed during the next
window. It defaults to \fBfalse\fP, in which case any running compactions
will be allowed to finish, but no new ones will be started.
.UNINDENT
.UNINDENT
.UNINDENT
.sp
There are also several settings that collectively control whether a channel will
enqueue a file for compaction and how it prioritizes files within its queue:
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.TP
.B max_priority
Each item must have a priority lower than this to be enqueued. Defaults
to infinity.
.UNINDENT
.INDENT 0.0
.TP
.B max_size
The item must be no larger than this many bytes in length to be
enqueued. Defaults to infinity.
.UNINDENT
.INDENT 0.0
.TP
.B min_priority
The item must have a priority at least this high to be enqueued.
Defaults to 5.0 for ratio and 16 MB for slack.
.UNINDENT
.INDENT 0.0
.TP
.B min_changes
The minimum number of changes since last compaction before the item will
be enqueued. Defaults to 0. Currently only works for databases.
.UNINDENT
.INDENT 0.0
.TP
.B min_size
The item must be at least this many bytes in length to be enqueued.
Defaults to 1mb (1048576 bytes).
.UNINDENT
.INDENT 0.0
.TP
.B priority
The method used to calculate priority. Can be ratio (calculated as
\fBsizes.file/sizes.active\fP) or slack (calculated as \fBsizes.file \-
sizes.active\fP). Defaults to ratio.
.UNINDENT
.UNINDENT
.UNINDENT
.SS Background Indexing
.sp
Secondary indexes in CouchDB are not updated during document write operations. In order to
avoid high latencies when reading indexes following a large block of writes, CouchDB
automatically kicks off background jobs to keep secondary indexes “warm”. The daemon
responsible for this process is internally known as “ken” and can be configured using the
following settings.
.INDENT 0.0
.TP
.B [ken]
.INDENT 7.0
.TP
.B batch_channels
This setting controls the number of background view builds that can be running in
parallel at any given time. The default is 20.
.UNINDENT
.INDENT 7.0
.TP
.B incremental_channels
It is possible for all the slots in the normal build system to be occupied by
long\-running index rebuilds (e.g. if new design documents are posted to several
databases simultaneously). In order to avoid already\-built indexes from falling
behind when this occurs, CouchDB will allow for a number of short background
indexing jobs to run even when all slots are full. This setting controls how many
additional short jobs are allowed to run concurrently with the main jobs. The
default is 80.
.UNINDENT
.INDENT 7.0
.TP
.B max_incremental_updates
CouchDB estimates whether an indexing job is “incremental” or not by looking at
the difference in sequence numbers between the current index and the main
database. If the difference is larger than the threshold defined here the
background job will only be allowed to run in the main queue. Defaults to 1000.
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B [ken.ignore]
.UNINDENT
.sp
Entries in this configuration section can be used to tell the background indexer to skip
over specific database shard files. The key must be the exact name of the shard with the
\fB\&.couch\fP suffix omitted, for example:
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[ken.ignore]
shards/00000000\-1fffffff/mydb.1567719095 = true
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
In case when you’d like to skip all views from a ddoc, you may add
\fBautoupdate: false\fP to the ddoc. All views of that ddoc will then be skipped.
.sp
More at \fI\%PUT /{db}/_design/{ddoc}\fP\&.
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS IO Queue
.sp
CouchDB has an internal subsystem that can prioritize IO associated with certain
classes of operations. This subsystem can be configured to limit the resources
devoted to background operations like internal replication and compaction
according to the settings described below.
.INDENT 0.0
.TP
.B [ioq]
.INDENT 7.0
.TP
.B concurrency
Specifies the maximum number of concurrent in\-flight IO requests that
the queueing system will submit:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[ioq]
concurrency = 10
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B ratio
The fraction of the time that a background IO request will be selected
over an interactive IO request when both queues are non\-empty:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[ioq]
ratio = 0.01
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B [ioq.bypass]
System administrators can choose to submit specific classes of IO directly
to the underlying file descriptor or OS process, bypassing the queues
altogether. Installing a bypass can yield higher throughput and lower
latency, but relinquishes some control over prioritization. The following
classes are recognized:
.INDENT 7.0
.TP
.B os_process
Messages on their way to an external process (e.g., \fBcouchjs\fP).
.UNINDENT
.INDENT 7.0
.TP
.B read
Disk IO fulfilling interactive read requests.
.UNINDENT
.INDENT 7.0
.TP
.B write
Disk IO required to update a database.
.UNINDENT
.INDENT 7.0
.TP
.B view_update
Disk IO required to update views and other secondary indexes.
.UNINDENT
.INDENT 7.0
.TP
.B shard_sync
Disk IO issued by the background replication processes that fix any
inconsistencies between shard copies.
.UNINDENT
.INDENT 7.0
.TP
.B compaction
Disk IO issued by compaction jobs.
.UNINDENT
.INDENT 7.0
.TP
.B reshard
Disk IO issued by resharding jobs.
.UNINDENT
.sp
Without any configuration CouchDB will enqueue all classes of IO. The
default.ini configuration file that ships with CouchDB activates a bypass
for each of the interactive IO classes and only background IO goes into the
queueing system:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[ioq.bypass]
os_process = true
read = true
write = true
view_update = true
shard_sync = false
compaction = false
reshard = false
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS Recommendations
.sp
The default configuration protects against excessive IO from background
operations like compaction disrupting the latency of interactive operations,
while maximizing the overall IO throughput devoted to those interactive
requests. There are certain situations where this configuration could be
sub\-optimal:
.INDENT 0.0
.IP \(bu 2
An administrator may want to devote a larger portion of the overall IO
bandwidth to compaction in order to stay ahead of the incoming write load. In
this it may be necessary to disable the bypass for \fBwrite\fP (to help with
database compaction) and/or \fBview_update\fP (to help with view index compaction)
and then increase the \fBratio\fP to give compaction a higher priority.
.IP \(bu 2
A server with a large number of views that do not need to be comlpetely
up\-to\-date may benefit from removing the bypass on \fBview_update\fP in order to
optimize the latency for regular document read and write operations, and build
the views during quieter periods.
.UNINDENT
.SS Logging
.SS Logging options
.INDENT 0.0
.TP
.B [log]
CouchDB logging configuration.
.INDENT 7.0
.TP
.B writer
Current writers include:
.INDENT 7.0
.IP \(bu 2
\fBstderr\fP: Logs are sent to stderr.
.IP \(bu 2
\fBfile\fP: Logs are sent to the file set in
\fI\%log file\fP\&.
.IP \(bu 2
\fBsyslog\fP: Logs are sent to the syslog daemon.
.IP \(bu 2
\fBjournald\fP: Logs are sent to stderr without timestamp and log
levels compatible with sd\-daemon.
.UNINDENT
.sp
You can also specify a full module name here if implement your own
writer:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[log]
writer = stderr
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B file
Specifies the location of file for logging output. Only used by the
\fBfile\fP \fI\%writer\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[log]
file = /var/log/couchdb/couch.log
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This path should be readable and writable for user that runs CouchDB
service (\fIcouchdb\fP by default).
.UNINDENT
.INDENT 7.0
.TP
.B write_buffer
Specifies the size of the file log write buffer in bytes, to enable
delayed log writes. Only used by the \fBfile\fP
\fI\%writer\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[log]
write_buffer = 0
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B write_delay
Specifies the wait in milliseconds before committing logs to disk, to
enable delayed log writes. Only used by the \fBfile\fP
\fI\%writer\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[log]
write_delay = 0
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B level
Changed in version 1.3: Added \fBwarning\fP level.

.sp
Logging level defines how verbose and detailed logging will be:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[log]
level = info
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Available levels:
.INDENT 7.0
.IP \(bu 2
\fBdebug\fP: Detailed debug logging.
.IP \(bu 2
\fBinfo\fP: Informative logging. Includes HTTP requests headlines,
startup of an external processes etc.
.IP \(bu 2
\fBnotice\fP
.IP \(bu 2
\fBwarning\fP or \fBwarn\fP: Warning messages are alerts about edge situations that
may lead to errors. For instance, compaction daemon alerts about low
or insufficient disk space at this level.
.IP \(bu 2
\fBerror\fP or \fBerr\fP: Error level includes only things that go wrong, like crash
reports and HTTP error responses (5xx codes).
.IP \(bu 2
\fBcritical\fP or \fBcrit\fP
.IP \(bu 2
\fBalert\fP
.IP \(bu 2
\fBemergency\fP or \fBemerg\fP
.IP \(bu 2
\fBnone\fP: Disables logging any messages.
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B include_sasl
Includes \fI\%SASL\fP information in logs:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[log]
include_sasl = true
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B syslog_host
.
\fBNOTE:\fP
.INDENT 7.0
.INDENT 3.5
Setting \fIsyslog_host\fP is mandatory for \fBsyslog\fP to work!
.UNINDENT
.UNINDENT
.sp
Specifies the syslog host to send logs to. Only used by the
\fBsyslog\fP \fI\%writer\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[log]
syslog_host = localhost
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B syslog_port
Specifies the syslog port to connect to when sending logs. Only used by
the \fBsyslog\fP \fI\%writer\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[log]
syslog_port = 514
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B syslog_appid
Specifies application name to the \fBsyslog\fP
\fI\%writer\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[log]
syslog_appid = couchdb
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B syslog_facility
Specifies the syslog facility to use with the \fBsyslog\fP
\fI\%writer\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[log]
syslog_facility = local2
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 7.0
.INDENT 3.5
CouchDB’s \fBsyslog\fP only knows how to use UDP logging. Please ensure that your
\fBsyslog\fP server has UDP logging enabled.
.sp
For \fBrsyslog\fP you can enable the UDP module \fIimudp\fP in \fB/etc/rsyslog.conf\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
# provides UDP syslog reception
module(load=\(dqimudp\(dq)
input(type=\(dqimudp\(dq port=\(dq514\(dq)
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Replicator
.SS Replicator Database Configuration
.INDENT 0.0
.TP
.B [replicator]
.INDENT 7.0
.TP
.B max_jobs
New in version 2.1.

.sp
Number of actively running replications.
This value represents the threshold to trigger the automatic replication
scheduler.
The system will check every \fBinterval\fP milliseconds how many replication
jobs are running, and if there are more than \fBmax_jobs\fP active jobs,
the scheduler will pause\-and\-restart up to \fBmax_churn\fP jobs in the
scheduler queue.
Making this value too high could cause performance issues, while making
it too low could mean replications jobs might not have enough time to make
progress before getting unscheduled again.
This parameter can be adjusted at runtime and will take effect during next
rescheduling cycle:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
max_jobs = 500
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B interval
New in version 2.1.

.sp
Scheduling interval in milliseconds.
During each reschedule cycle the scheduler might start or stop up to \fBmax_churn\fP
number of jobs:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
interval = 60000
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B max_churn
New in version 2.1.

.sp
Maximum number of replication jobs to start and stop during rescheduling.
This parameter, along with \fBinterval\fP, defines the rate of job replacement.
During startup, however, a much larger number of jobs could be started
(up to \fBmax_jobs\fP) in a short period of time:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
max_churn = 20
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B max_history
Maximum number of events recorded for each job. This parameter defines
an upper bound on the consecutive failure count for a job, and in turn
the maximum backoff factor used when determining the delay before the job
is restarted. The longer the length of the crash count, the longer the
possible length of the delay:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
max_history = 20
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B update_docs
New in version 2.1.

.sp
When set to \fBtrue\fP replicator will update replication document with
error and triggered states. This approximates pre\-2.1 replicator
behavior:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
update_docs = false
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B worker_batch_size
With lower batch sizes checkpoints are done more frequently. Lower
batch sizes also reduce the total amount of used RAM memory:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
worker_batch_size = 500
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B worker_processes
More worker processes can give higher network throughput but can also
imply more disk and network IO:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
worker_processes = 4
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B http_connections
Maximum number of HTTP connections per replication:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
http_connections = 20
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B connection_timeout
HTTP connection timeout per replication.
This is divided by three (3) when the replicator makes changes feed requests.
Even for very fast/reliable networks it might need to be increased if
a remote database is too busy:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
connection_timeout = 30000
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B retries_per_request
Changed in version 2.1.1.

.sp
If a request fails, the replicator will retry it up to N times. The
default value for N is 5 (before version 2.1.1 it was 10). The requests
are retried with a doubling exponential backoff starting at 0.25
seconds. So by default requests would be retried in 0.25, 0.5, 1, 2, 4
second intervals. When number of retires is exhausted, the whole
replication job is stopped and will retry again later:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
retries_per_request = 5
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B socket_options
Some socket options that might boost performance in some scenarios:
.INDENT 7.0
.IP \(bu 2
\fB{nodelay, boolean()}\fP
.IP \(bu 2
\fB{sndbuf, integer()}\fP
.IP \(bu 2
\fB{recbuf, integer()}\fP
.IP \(bu 2
\fB{priority, integer()}\fP
.UNINDENT
.sp
See the \fI\%inet\fP Erlang module’s man page for the full list of options:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
socket_options = [{keepalive, true}, {nodelay, false}]
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B valid_socket_options
New in version 3.3.

.sp
Valid socket options. Options not in this list are ignored. Most of
those options are low level and setting some of them may lead to
unintended or unpredictable behavior. See \fI\%inet\fP Erlang docs for the
full list of options:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
valid_socket_options = buffer,keepalive,nodelay,priority,recbuf,sndbuf
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B ibrowse_options
New in version 3.3.3: A non\-default ibrowse setting is needed to support IPV6\-only replication sources
or targets:
.INDENT 7.0
.IP \(bu 2
\fB{prefer_ipv6, boolean()}\fP
.UNINDENT
.sp
See the \fI\%ibrowse\fP site for the full list of options:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
ibrowse_options = [{prefer_ipv6, true}]
.ft P
.fi
.UNINDENT
.UNINDENT

.UNINDENT
.INDENT 7.0
.TP
.B valid_ibrowse_options
.INDENT 7.0
.INDENT 3.5
New in version 3.3.3.

.sp
Valid ibrowse options. Options not in this list are ignored:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
valid_ibrowse_options = prefer_ipv6
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B valid_endpoint_protocols
New in version 3.3.

.sp
Valid replication endpoint protocols. Replication jobs with endpoint
urls not in this list will fail to run:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
valid_endpoint_protocols = http,https
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B valid_proxy_protocols
New in version 3.3.

.sp
Valid replication proxy protocols. Replication jobs with proxy
urls not in this list will fail to run:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
valid_proxy_protocols = http,https,socks5
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B checkpoint_interval
New in version 1.6.

.sp
Defines replication checkpoint interval in milliseconds.
\fI\%Replicator\fP will \fI\%requests\fP from the
Source database at the specified interval:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
checkpoint_interval = 5000
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Lower intervals may be useful for frequently changing data, while
higher values will lower bandwidth and make fewer requests for
infrequently updated databases.
.UNINDENT
.INDENT 7.0
.TP
.B use_checkpoints
New in version 1.6.

.sp
If \fBuse_checkpoints\fP is set to \fBtrue\fP, CouchDB will make
checkpoints during replication and at the completion of replication.
CouchDB can efficiently resume replication from any of these
checkpoints:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
use_checkpoints = true
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 7.0
.INDENT 3.5
Checkpoints are stored in \fI\%local documents\fP
on both the source and target databases (which requires write
access).
.UNINDENT
.UNINDENT
.sp
\fBWARNING:\fP
.INDENT 7.0
.INDENT 3.5
Disabling checkpoints is \fBnot recommended\fP as CouchDB will scan
the Source database’s changes feed from the beginning.
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B use_bulk_get
New in version 3.3.

.sp
If \fBuse_bulk_get\fP is \fBtrue\fP, CouchDB will attempt to use the
\fB_bulk_get\fP HTTP API endpoint to fetch documents from the source.
Replicator should automatically fall back to individual doc GETs on
on error; however, in some cases it may be useful to prevent spending
time attempting to call \fB_bulk_get\fP altogether.
.UNINDENT
.INDENT 7.0
.TP
.B cert_file
Path to a file containing the user’s certificate:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
cert_file = /full/path/to/server_cert.pem
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B key_file
Path to file containing user’s private PEM encoded key:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
key_file = /full/path/to/server_key.pem
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B password
String containing the user’s password. Only used if the private key file
is password protected:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
password = somepassword
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B verify_ssl_certificates
Set to true to validate peer certificates:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
verify_ssl_certificates = false
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B ssl_trusted_certificates_file
File containing a list of peer trusted certificates (in the PEM
format):
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
ssl_trusted_certificates_file = /etc/ssl/certs/ca\-certificates.crt
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B ssl_certificate_max_depth
Maximum peer certificate depth (must be set even if certificate
validation is off):
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
ssl_certificate_max_depth = 3
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B auth_plugins
New in version 2.2.

.sp
List of replicator client authentication plugins. Plugins will
be tried in order and the first to initialize successfully will
be used. By default there are two plugins available:
\fIcouch_replicator_auth_session\fP implementing session (cookie)
authentication, and \fIcouch_replicator_auth_noop\fP implementing basic
authentication. For backwards compatibility, the no\-op plugin should be used at
the end of the plugin list:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
auth_plugins = couch_replicator_auth_session,couch_replicator_auth_noop
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B usage_coeff
New in version 3.2.0.

.sp
Usage coefficient decays historic fair share usage every
scheduling cycle. The value must be between 0.0 and 1.0. Lower
values will ensure historic usage decays quicker and higher
values means it will be remembered longer:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
usage_coeff = 0.5
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B priority_coeff
.INDENT 7.0
.INDENT 3.5
New in version 3.2.0.

.UNINDENT
.UNINDENT
.sp
Priority coefficient decays all the job priorities such that they slowly
drift towards the front of the run queue. This coefficient defines a maximum
time window over which this algorithm would operate. For example, if this
value is too small (0.1), after a few cycles quite a few jobs would end up at
priority 0, and would render this algorithm useless. The default value of
0.98 is picked such that if a job ran for one scheduler cycle, then didn’t
get to run for 7 hours, it would still have priority > 0. 7 hours was picked
as it was close enough to 8 hours which is the default maximum error backoff
interval:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator]
priority_coeff = 0.98
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Fair Share Replicator Share Allocation
.INDENT 0.0
.TP
.B [replicator.shares]
.INDENT 7.0
.TP
.B $replicator_db
New in version 3.2.0.

.sp
Fair share configuration section. Higher share values results in a
higher chance that jobs from that db get to run. The default
value is 100, minimum is 1 and maximum is 1000. The
configuration may be set even if the database does not exist.
.sp
In this context the option \fB$replicator_db\fP acts as a placeholder
for your replicator database name. The default replicator database is
\fB_replicator\fP\&. Additional replicator databases can be created. To be
recognized as such by the system, their database names should end with
\fB/_replicator\fP\&. See the \fI\%Replicator Database\fP
section for more info.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[replicator.shares]
_replicator = 50
foo/_replicator = 25
bar/_replicator = 25
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Query Servers
.SS Query Servers Definition
.sp
Changed in version 2.3: Changed configuration method for Query Servers
and Native Query Servers.

.sp
CouchDB delegates computation of \fI\%design documents\fP functions
to external query servers. The external query server is a special OS
process which communicates with CouchDB over standard input/output using a
very simple line\-based protocol with JSON messages.
.sp
An external query server may be defined with environment variables following
this pattern:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
COUCHDB_QUERY_SERVER_LANGUAGE=\(dqPATH ARGS\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Where:
.INDENT 0.0
.IP \(bu 2
\fBLANGUAGE\fP: is a programming language which code this query server may
execute. For instance, there are \fIPYTHON\fP, \fIRUBY\fP, \fICLOJURE\fP and other
query servers in the wild. This value in \fIlowercase\fP is also used for \fBddoc\fP
field \fBlanguage\fP to determine which query server processes the functions.
.sp
Note, that you may set up multiple query servers for the same programming
language, but you have to name them differently (like \fIPYTHONDEV\fP etc.).
.IP \(bu 2
\fBPATH\fP: is a system path to the executable binary program that runs the
query server.
.IP \(bu 2
\fBARGS\fP: optionally, you may specify additional command line arguments
for the executable \fBPATH\fP\&.
.UNINDENT
.sp
The default query server is written in \fI\%JavaScript\fP,
running via \fI\%Mozilla SpiderMonkey\fP\&. It requires no special environment
settings to enable, but is the equivalent of these two variables:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
COUCHDB_QUERY_SERVER_JAVASCRIPT=\(dq/opt/couchdb/bin/couchjs /opt/couchdb/share/server/main.js\(dq
COUCHDB_QUERY_SERVER_COFFEESCRIPT=\(dq/opt/couchdb/bin/couchjs /opt/couchdb/share/server/main\-coffee.js\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
By default, \fBcouchjs\fP limits the max runtime allocation to 64MiB.
If you run into out of memory issue in your ddoc functions,
you can adjust the memory limitation (here, increasing to 512 MiB):
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
COUCHDB_QUERY_SERVER_JAVASCRIPT=\(dq/usr/bin/couchjs \-S 536870912 /usr/share/server/main.js\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
For more info about the available options, please consult \fBcouchjs \-h\fP\&.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
CouchDB versions 3.0.0 to 3.2.2 included a performance regression for
custom reduce functions. CouchDB 3.3.0 and later come with an experimental
fix to this issue that is included in a separate \fB\&.js\fP file.
.sp
To enable the fix, you need to define a custom \fBCOUCHDB_QUERY_SERVER_JAVASCRIPT\fP
environment variable as outlined above. The path to \fBcouchjs\fP needs to
remain the same as you find it on your \fBcouchdb\fP file, and the path to
\fBmain.js\fP needs to be set to \fB/path/to/couchdb/share/server/main\-ast\-bypass.js\fP\&.
.sp
With a default installation on Linux systems, this is going to be
\fBCOUCHDB_QUERY_SERVER_JAVASCRIPT=\(dq/opt/couchdb/bin/couchjs /opt/couchdb/share/server/main\-ast\-bypass.js\(dq\fP
.UNINDENT
.UNINDENT
.sp
\fBSEE ALSO:\fP
.INDENT 0.0
.INDENT 3.5
The \fI\%Mango Query Server\fP is a declarative language
that requires \fIno programming\fP, allowing for easier indexing and finding
of data in documents.
.sp
The \fI\%Native Erlang Query Server\fP
allows running \fIddocs\fP written in Erlang natively, bypassing
stdio communication and JSON serialization/deserialization round trip
overhead.
.UNINDENT
.UNINDENT
.SS Query Servers Configuration
.INDENT 0.0
.TP
.B [query_server_config]
.INDENT 7.0
.TP
.B commit_freq
Specifies the delay in seconds before view index changes are committed
to disk. The default value is \fB5\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[query_server_config]
commit_freq = 5
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B os_process_limit
Hard limit on the number of OS processes usable by Query
Servers. The default value is \fB100\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[query_server_config]
os_process_limit = 100
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Setting \fBos_process_limit\fP too low can result in starvation of
Query Servers, and manifest in \fBos_process_timeout\fP errors,
while setting it too high can potentially use too many system
resources. Production settings are typically 10\-20 times the
default value.
.UNINDENT
.INDENT 7.0
.TP
.B os_process_soft_limit
Soft limit on the number of OS processes usable by Query
Servers. The default value is \fB100\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[query_server_config]
os_process_soft_limit = 100
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Idle OS processes are closed until the total reaches the soft
limit.
.sp
For example, if the hard limit is 200 and the soft limit is
100, the total number of OS processes will never exceed 200,
and CouchDB will close all idle OS processes until it reaches
100, at which point it will leave the rest intact, even if
some are idle.
.UNINDENT
.INDENT 7.0
.TP
.B reduce_limit
Controls \fIReduce overflow\fP error that raises when output of
\fI\%reduce functions\fP is too big:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[query_server_config]
reduce_limit = true
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Normally, you don’t have to disable (by setting \fBfalse\fP value) this
option since main propose of \fIreduce\fP functions is to \fIreduce\fP the
input.
.UNINDENT
.UNINDENT
.SS Native Erlang Query Server
.INDENT 0.0
.TP
.B [native_query_servers]
.
\fBWARNING:\fP
.INDENT 7.0
.INDENT 3.5
Due to security restrictions, the Erlang query server is disabled by
default.
.sp
Unlike the JavaScript query server, the Erlang one does not run in a
sandbox mode. This means that Erlang code has full access to your OS,
file system and network, which may lead to security issues. While Erlang
functions are faster than JavaScript ones, you need to be careful
about running them, especially if they were written by someone else.
.UNINDENT
.UNINDENT
.sp
CouchDB has a native Erlang query server, allowing you to write your
map/reduce functions in Erlang.
.sp
First, you’ll need to edit your \fIlocal.ini\fP to include a
\fB[native_query_servers]\fP section:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[native_query_servers]
enable_erlang_query_server = true
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
To see these changes you will also need to restart the server.
.sp
Let’s try an example of map/reduce functions which count the total
documents at each number of revisions (there are x many documents at
version “1”, and y documents at “2”… etc). Add a few documents to the
database, then enter the following functions as a view:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
%% Map Function
fun({Doc}) \->
    <<K,_/binary>> = proplists:get_value(<<\(dq_rev\(dq>>, Doc, null),
    V = proplists:get_value(<<\(dq_id\(dq>>, Doc, null),
    Emit(<<K>>, V)
end.

%% Reduce Function
fun(Keys, Values, ReReduce) \-> length(Values) end.
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If all has gone well, after running the view you should see a list of the
total number of documents at each revision number.
.sp
Additional examples are on the \fI\%users@couchdb.apache.org mailing list\fP\&.
.UNINDENT
.SS Search
.sp
CouchDB’s search subsystem can be configured via the \fBdreyfus\fP configuration section.
.INDENT 0.0
.TP
.B [dreyfus]
.INDENT 7.0
.TP
.B name
The name and location of the Clouseau Java service required to enable Search
functionality. Defaults to \fBclouseau@127.0.0.1\fP\&.
.UNINDENT
.INDENT 7.0
.TP
.B retry_limit
CouchDB will try to reconnect to Clouseau using a bounded exponential backoff with
the following number of iterations. Defaults to \fB5\fP\&.
.UNINDENT
.INDENT 7.0
.TP
.B limit
The number of results returned from a global search query if no limit is
specified. Defaults to \fB25\fP\&.
.UNINDENT
.INDENT 7.0
.TP
.B limit_partitions
The number of results returned from a search on a partition of a database if no
limit is specified. Defaults to \fB2000\fP\&.
.UNINDENT
.INDENT 7.0
.TP
.B max_limit
The maximum number of results that can be returned from a global search query (or
any search query on a database without user\-defined partitions). Attempts to set
\fB?limit=N higher\fP than this value will be rejected. Defaults to \fB200\fP\&.
.UNINDENT
.INDENT 7.0
.TP
.B max_limit_partitions
The maximum number of results that can be returned when searching a partition of a
database. Attempts to set \fB?limit=N\fP higher than this value will be rejected. If
this config setting is not defined, CouchDB will use the value of \fBmax_limit\fP
instead. If neither is defined, the default is \fB2000\fP\&.
.UNINDENT
.UNINDENT
.SS Mango
.sp
Mango is the Query Engine that services the \fI\%_find\fP, endpoint.
.INDENT 0.0
.TP
.B [mango]
.INDENT 7.0
.TP
.B index_all_disabled
Set to \fBtrue\fP to disable the “index all fields” text index. This can lead
to out of memory issues when there are documents with nested array fields.
Defaults to \fBfalse\fP\&.:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[mango]
index_all_disabled = false
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B default_limit
Sets the default number of results that will be returned in a
\fI\%_find\fP response. Individual requests can override this
by setting \fBlimit\fP directly in the query parameters.
Defaults to \fB25\fP\&.:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[mango]
default_limit = 25
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B index_scan_warning_threshold
This sets the ratio between documents scanned and results matched that
will generate a warning in the _find response. For example, if a query
requires reading 100 documents to return 10 rows, a warning will be
generated if this value is \fB10\fP\&.
.sp
Defaults to \fB10\fP\&. Setting the value to \fB0\fP disables the warning.:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[mango]
index_scan_warning_threshold = 10
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Miscellaneous Parameters
.SS Configuration of Attachment Storage
.INDENT 0.0
.TP
.B [attachments]
.INDENT 7.0
.TP
.B compression_level
Defines zlib compression level for the attachments from \fB1\fP (lowest,
fastest) to \fB9\fP (highest, slowest). A value of \fB0\fP disables
compression:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[attachments]
compression_level = 8
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B compressible_types
Since compression is ineffective for some types of files, it is
possible to let CouchDB compress only some types of attachments,
specified by their MIME type:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[attachments]
compressible_types = text/*, application/javascript, application/json, application/xml
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Statistic Calculation
.INDENT 0.0
.TP
.B [stats]
.INDENT 7.0
.TP
.B interval
Interval between gathering statistics in seconds:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[stats]
interval = 10
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS UUIDs Configuration
.INDENT 0.0
.TP
.B [uuids]
.INDENT 7.0
.TP
.B algorithm
Changed in version 1.3: Added \fButc_id\fP algorithm.

.sp
CouchDB provides various algorithms to generate the UUID values that
are  used for document \fI_id\fP’s by default:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[uuids]
algorithm = sequential
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Available algorithms:
.INDENT 7.0
.IP \(bu 2
\fBrandom\fP: 128 bits of random awesome. All awesome, all the time:
.INDENT 2.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dquuids\(dq: [
        \(dq5fcbbf2cb171b1d5c3bc6df3d4affb32\(dq,
        \(dq9115e0942372a87a977f1caf30b2ac29\(dq,
        \(dq3840b51b0b81b46cab99384d5cd106e3\(dq,
        \(dqb848dbdeb422164babf2705ac18173e1\(dq,
        \(dqb7a8566af7e0fc02404bb676b47c3bf7\(dq,
        \(dqa006879afdcae324d70e925c420c860d\(dq,
        \(dq5f7716ee487cc4083545d4ca02cd45d4\(dq,
        \(dq35fdd1c8346c22ccc43cc45cd632e6d6\(dq,
        \(dq97bbdb4a1c7166682dc026e1ac97a64c\(dq,
        \(dqeb242b506a6ae330bda6969bb2677079\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.IP \(bu 2
\fBsequential\fP: Monotonically increasing ids with random increments.
The first 26 hex characters are random, the last 6 increment in
random amounts until an overflow occurs. On overflow, the random
prefix is regenerated and the process starts over.
.INDENT 2.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dquuids\(dq: [
        \(dq4e17c12963f4bee0e6ec90da54804894\(dq,
        \(dq4e17c12963f4bee0e6ec90da5480512f\(dq,
        \(dq4e17c12963f4bee0e6ec90da54805c25\(dq,
        \(dq4e17c12963f4bee0e6ec90da54806ba1\(dq,
        \(dq4e17c12963f4bee0e6ec90da548072b3\(dq,
        \(dq4e17c12963f4bee0e6ec90da54807609\(dq,
        \(dq4e17c12963f4bee0e6ec90da54807718\(dq,
        \(dq4e17c12963f4bee0e6ec90da54807754\(dq,
        \(dq4e17c12963f4bee0e6ec90da54807e5d\(dq,
        \(dq4e17c12963f4bee0e6ec90da54808d28\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.IP \(bu 2
\fButc_random\fP: The time since Jan 1, 1970 UTC, in microseconds. The
first 14 characters are the time in hex. The last 18 are random.
.INDENT 2.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dquuids\(dq: [
        \(dq04dd32b3af699659b6db9486a9c58c62\(dq,
        \(dq04dd32b3af69bb1c2ac7ebfee0a50d88\(dq,
        \(dq04dd32b3af69d8591b99a8e86a76e0fb\(dq,
        \(dq04dd32b3af69f4a18a76efd89867f4f4\(dq,
        \(dq04dd32b3af6a1f7925001274bbfde952\(dq,
        \(dq04dd32b3af6a3fe8ea9b120ed906a57f\(dq,
        \(dq04dd32b3af6a5b5c518809d3d4b76654\(dq,
        \(dq04dd32b3af6a78f6ab32f1e928593c73\(dq,
        \(dq04dd32b3af6a99916c665d6bbf857475\(dq,
        \(dq04dd32b3af6ab558dd3f2c0afacb7d66\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.IP \(bu 2
\fButc_id\fP: The time since Jan 1, 1970 UTC, in microseconds, plus the
\fButc_id_suffix\fP string. The first 14 characters are the time in
hex. The \fI\%uuids/utc_id_suffix\fP string value is appended to
these.
.INDENT 2.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dquuids\(dq: [
        \(dq04dd32bd5eabcc@mycouch\(dq,
        \(dq04dd32bd5eabee@mycouch\(dq,
        \(dq04dd32bd5eac05@mycouch\(dq,
        \(dq04dd32bd5eac28@mycouch\(dq,
        \(dq04dd32bd5eac43@mycouch\(dq,
        \(dq04dd32bd5eac58@mycouch\(dq,
        \(dq04dd32bd5eac6e@mycouch\(dq,
        \(dq04dd32bd5eac84@mycouch\(dq,
        \(dq04dd32bd5eac98@mycouch\(dq,
        \(dq04dd32bd5eacad@mycouch\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 7.0
.INDENT 3.5
\fBImpact of UUID choices:\fP the choice of UUID has a significant
impact on the layout of the B\-tree, prior to compaction.
.sp
For example, using a sequential UUID algorithm while uploading a
large batch of documents will avoid the need to rewrite many
intermediate B\-tree nodes. A random UUID algorithm may require
rewriting intermediate nodes on a regular basis, resulting in
significantly decreased throughput and wasted disk space space due to
the append\-only B\-tree design.
.sp
It is generally recommended to set your own UUIDs, or use the
sequential algorithm unless you have a specific need and take into
account the likely need for compaction to re\-balance the B\-tree and
reclaim wasted space.
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B utc_id_suffix
New in version 1.3.

.sp
The \fButc_id_suffix\fP value will be appended to UUIDs generated by the
\fButc_id\fP algorithm. Replicating instances should have unique
\fButc_id_suffix\fP values to ensure uniqueness of \fButc_id\fP ids.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[uuid]
utc_id_suffix = my\-awesome\-suffix
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B max_count
New in version 1.5.1.

.sp
No more than this number of UUIDs will be sent in a single request. If
more UUIDs are requested, an HTTP error response will be thrown.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[uuid]
max_count = 1000
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Vendor information
.INDENT 0.0
.TP
.B [vendor]
New in version 1.3.

.sp
CouchDB distributors have the option of customizing CouchDB’s welcome
message. This is returned when requesting \fBGET /\fP\&.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[vendor]
name = The Apache Software Foundation
version = 1.5.0
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS Content\-Security\-Policy
.INDENT 0.0
.TP
.B [csp]
You can configure \fBContent\-Security\-Policy\fP header for Fauxton, attachments and
show/list functions separately. See \fI\%MDN Content\-Security\-Policy\fP
for more details on CSP.
.INDENT 7.0
.TP
.B utils_enable
Enable the sending of the header \fBContent\-Security\-Policy\fP for \fB/_utils\fP\&.
Defaults to \fBtrue\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[csp]
utils_enable = true
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B utils_header_value
Specifies the exact header value to send. Defaults to:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[csp]
utils_header_value = default\-src \(aqself\(aq; img\-src \(aqself\(aq; font\-src *; script\-src \(aqself\(aq \(aqunsafe\-eval\(aq; style\-src \(aqself\(aq \(aqunsafe\-inline\(aq;
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B attachments_enable
Enable sending the \fBContent\-Security\-Policy\fP header for attachments:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[csp]
attachments_enable = true
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B attachments_header_value
Specifies the exact header value to send. Defaults to:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[csp]
attachments_header_value = sandbox
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B showlist_enable
Enable sending the \fBContent\-Security\-Policy\fP header for show and list functions:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[csp]
showlist_enable = true
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B showlist_header_value
Specifies the exact header value to send. Defaults to:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[csp]
showlist_header_value = sandbox
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.sp
The pre 3.2.0 behaviour is still honoured, but we recommend updating
to the new format.
.sp
Experimental support of CSP headers for \fB/_utils\fP (Fauxton).
.INDENT 7.0
.TP
.B enable
Enable the sending of the Header \fBContent\-Security\-Policy\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[csp]
enable = true
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B header_value
You can change the default value for the Header which is sent:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[csp]
header_value = default\-src \(aqself\(aq; img\-src *; font\-src *;
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Configuration of Database Purge
.INDENT 0.0
.TP
.B [purge]
.INDENT 7.0
.TP
.B max_document_id_number
New in version 3.0.

.sp
Sets the maximum number of documents allowed in a single purge request:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[purge]
max_document_id_number = 100
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B max_revisions_number
New in version 3.0.

.sp
Sets the maximum number of accumulated revisions allowed in a single purge
request:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[purge]
max_revisions_number = 1000
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B index_lag_warn_seconds
New in version 3.0.

.sp
Sets the allowed duration when index is not updated for local purge checkpoint
document. Default is 24 hours:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[purge]
index_lag_warn_seconds = 86400
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Configuration of Prometheus Endpoint
.INDENT 0.0
.TP
.B [prometheus]
.INDENT 7.0
.TP
.B additional_port
New in version 3.2.

.sp
Sets whether or not to create a separate, non\-authenticated port (default is false):
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[prometheus]
additional_port = true
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B bind_address
New in version 3.2.

.sp
The IP address to bind:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[prometheus]
bind_address = 127.0.0.1
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B port
New in version 3.2.

.sp
The port on which clients can query prometheus endpoint data without authentication:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[prometheus]
port = 17986
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Resharding
.SS Resharding Configuration
.INDENT 0.0
.TP
.B [resharding]
.INDENT 7.0
.TP
.B max_jobs
Maximum number of resharding jobs per cluster node. This includes
completed, failed, and running jobs. If the job appears in the
_reshard/jobs HTTP API results it will be counted towards the limit.
When more than \fBmax_jobs\fP jobs have been created, subsequent requests
will start to fail with the \fBmax_jobs_exceeded\fP error:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[reshard]
max_jobs = 48
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B max_history
Each resharding job maintains a timestamped event log. This setting
limits the maximum size of that log:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[reshard]
max_history = 20
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B max_retries
How many times to retry shard splitting steps if they fail. For
example, if indexing or topping off fails, it will be retried up to
this many times before the whole resharding job fails:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[reshard]
max_retries = 1
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B retry_interval_sec
How long to wait between subsequent retries:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[reshard]
retry_interval_sec = 10
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B delete_source
Indicates if the source shard should be deleted after resharding has
finished. By default, it is \fBtrue\fP as that would recover the space
utilized by the shard. When debugging or when extra safety is required,
this can be switched to \fBfalse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[reshard]
delete_source = true
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B update_shard_map_timeout_sec
How many seconds to wait for the shard map update operation to
complete. If there is a large number of shard db changes waiting to
finish replicating, it might be beneficial to increase this timeout:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[reshard]
update_shard_map_timeout_sec = 60
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B source_close_timeout_sec
How many seconds to wait for the source shard to close. “Close” in this
context means that client requests which keep the database open have
all finished:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[reshard]
source_close_timeout_sec = 600
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B require_node_param
Require users to specify a \fBnode\fP parameter when creating resharding
jobs. This can be used as a safety check to avoid inadvertently
starting too many resharding jobs by accident:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[reshard]
require_node_param = false
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B require_range_param
Require users to specify a \fBrange\fP parameter when creating resharding
jobs. This can be used as a safety check to avoid inadvertently
starting too many resharding jobs by accident:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[reshard]
require_range_param = false
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SH CLUSTER MANAGEMENT
.INDENT 0.0
.TP
.B As of CouchDB 2.0.0, CouchDB can be run in two different modes of operation:
.INDENT 7.0
.IP \(bu 2
Standalone: In this mode, CouchDB’s clustering is unavailable.
CouchDB’s HTTP\-based replication with other CouchDB installations remains available.
.IP \(bu 2
Cluster: A cluster of CouchDB installations internally replicate
with each other via optimized network connections.
This is intended to be used with servers that are in the same data center.
This allows for database sharding to improve performance.
.UNINDENT
.UNINDENT
.sp
This section details the theory behind CouchDB clusters, and provides specific
operational instructions on node, database and shard management.
.SS Theory
.sp
Before we move on, we need some theory.
.sp
As you see in \fBetc/default.ini\fP there is a section called \fB[cluster]\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[cluster]
q=2
n=3
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.IP \(bu 2
\fBq\fP \- The number of shards.
.IP \(bu 2
\fBn\fP \- The number of copies there is of every document. Replicas.
.UNINDENT
.sp
When creating a database you can send your own values with request and
thereby override the defaults in \fBdefault.ini\fP\&.
.sp
The number of copies of a document with the same revision that have to be read
before CouchDB returns with a \fB200\fP is equal to a half of total copies of
the document plus one. It is the same for the number of nodes that need to
save a document before a write is returned with \fB201\fP\&. If there are less
nodes than that number, then \fB202\fP is returned. Both read and write numbers
can be specified with a request as \fBr\fP and \fBw\fP parameters accordingly.
.sp
We will focus on the shards and replicas for now.
.sp
A shard is a part of a database. It can be replicated multiple times. The more
copies of a shard, the more you can scale out. If you have 4 replicas, that
means that all 4 copies of this specific shard will live on at most 4 nodes.
No node can have more than one copy of each shard replica. The default for
CouchDB since 3.0.0 is \fBq=2\fP and \fBn=3\fP, meaning each database (and secondary
index) is split into 2 shards, with 3 replicas per shard, for a total of 6
shard replica files. For a CouchDB cluster only hosting a single database with
these default values, a maximum of 6 nodes can be used to scale horizontally.
.sp
Replicas add failure resistance, as some nodes can be offline without everything
crashing down.
.INDENT 0.0
.IP \(bu 2
\fBn=1\fP All nodes must be up.
.IP \(bu 2
\fBn=2\fP Any 1 node can be down.
.IP \(bu 2
\fBn=3\fP Any 2 nodes can be down.
.IP \(bu 2
etc
.UNINDENT
.sp
Computers go down and sysadmins pull out network cables in a furious rage from
time to time, so using \fBn<2\fP is asking for downtime. Having too high a value
of \fBn\fP adds servers and complexity without any real benefit. The sweet spot is
at \fBn=3\fP\&.
.sp
Say that we have a database with 3 replicas and 4 shards. That would give us a
maximum of 12 nodes: 4*3=12.
.sp
We can lose any 2 nodes and still read and write all documents.
.sp
What happens if we lose more nodes? It depends on how lucky we are. As long as
there is at least one copy of every shard online, we can read and write all
documents.
.sp
So, if we are very lucky then we can lose 8 nodes at maximum.
.SS Node Management
.SS Adding a node
.sp
Go to \fBhttp://server1:5984/_membership\fP to see the name of the node and all
the nodes it is connected to and knows about.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X GET \(dqhttp://xxx.xxx.xxx.xxx:5984/_membership\(dq \-\-user admin\-user
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqall_nodes\(dq:[
        \(dqnode1@xxx.xxx.xxx.xxx\(dq],
    \(dqcluster_nodes\(dq:[
        \(dqnode1@xxx.xxx.xxx.xxx\(dq]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.IP \(bu 2
\fBall_nodes\fP are all the nodes that this node knows about.
.IP \(bu 2
\fBcluster_nodes\fP are the nodes that are connected to this node.
.UNINDENT
.sp
To add a node simply do:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X PUT \(dqhttp://xxx.xxx.xxx.xxx/_node/_local/_nodes/node2@yyy.yyy.yyy.yyy\(dq \-d {}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Now look at \fBhttp://server1:5984/_membership\fP again.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqall_nodes\(dq:[
        \(dqnode1@xxx.xxx.xxx.xxx\(dq,
        \(dqnode2@yyy.yyy.yyy.yyy\(dq
    ],
    \(dqcluster_nodes\(dq:[
        \(dqnode1@xxx.xxx.xxx.xxx\(dq,
        \(dqnode2@yyy.yyy.yyy.yyy\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
And you have a 2 node cluster :)
.sp
\fBhttp://yyy.yyy.yyy.yyy:5984/_membership\fP will show the same thing, so you
only have to add a node once.
.SS Removing a node
.sp
Before you remove a node, make sure that you have moved all
\fI\%shards\fP away from that node.
.sp
To remove \fBnode2\fP from server \fByyy.yyy.yyy.yyy\fP, you need to first know the
revision of the document that signifies that node’s existence:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \(dqhttp://xxx.xxx.xxx.xxx/_node/_local/_nodes/node2@yyy.yyy.yyy.yyy\(dq
{\(dq_id\(dq:\(dqnode2@yyy.yyy.yyy.yyy\(dq,\(dq_rev\(dq:\(dq1\-967a00dff5e02add41820138abb3284d\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
With that \fB_rev\fP, you can now proceed to delete the node document:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X DELETE \(dqhttp://xxx.xxx.xxx.xxx/_node/_local/_nodes/node2@yyy.yyy.yyy.yyy?rev=1\-967a00dff5e02add41820138abb3284d\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Database Management
.SS Creating a database
.sp
This will create a database with \fB3\fP replicas and \fB8\fP shards.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X PUT \(dqhttp://xxx.xxx.xxx.xxx:5984/database\-name?n=3&q=8\(dq \-\-user admin\-user
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The database is in \fBdata/shards\fP\&. Look around on all the nodes and you will
find all the parts.
.sp
If you do not specify \fBn\fP and \fBq\fP the default will be used. The default is
\fB3\fP replicas and \fB8\fP shards.
.SS Deleting a database
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X DELETE \(dqhttp://xxx.xxx.xxx.xxx:5984/database\-name \-\-user admin\-user
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Placing a database on specific nodes
.sp
In BigCouch, the predecessor to CouchDB 2.0’s clustering functionality, there
was the concept of zones. CouchDB 2.0 carries this forward with cluster
placement rules.
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
Use of the \fBplacement\fP argument will \fBoverride\fP the standard
logic for shard replica cardinality (specified by \fB[cluster] n\fP\&.)
.UNINDENT
.UNINDENT
.sp
First, each node must be labeled with a zone attribute. This defines which zone each node
is in. You do this by editing the node’s document in the system \fB_nodes\fP database, which
is accessed node\-local via the \fBGET /_node/_local/_nodes/{node\-name}\fP endpoint.
.sp
Add a key value pair of the form:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\(dqzone\(dq: \(dqmetro\-dc\-a\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Do this for all of the nodes in your cluster.
.sp
In your config file (\fBlocal.ini\fP or \fBdefault.ini\fP) on each node, define a
consistent cluster\-wide setting like:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[cluster]
placement = metro\-dc\-a:2,metro\-dc\-b:1
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
In this example, it will ensure that two replicas for a shard will be hosted
on nodes with the zone attribute set to \fBmetro\-dc\-a\fP and one replica will
be hosted on a new with the zone attribute set to \fBmetro\-dc\-b\fP\&.
.sp
Note that you can also use this system to ensure certain nodes in the cluster
do not host \fIany\fP replicas for newly created databases, by giving them a zone
attribute that does not appear in the \fB[cluster]\fP placement string.
.SS Shard Management
.SS Introduction
.sp
This document discusses how sharding works in CouchDB along with how to
safely add, move, remove, and create placement rules for shards and
shard replicas.
.sp
A \fI\%shard\fP is a
horizontal partition of data in a database. Partitioning data into
shards and distributing copies of each shard (called “shard replicas” or
just “replicas”) to different nodes in a cluster gives the data greater
durability against node loss. CouchDB clusters automatically shard
databases and distribute the subsets of documents that compose each
shard among nodes. Modifying cluster membership and sharding behavior
must be done manually.
.SS Shards and Replicas
.sp
How many shards and replicas each database has can be set at the global
level, or on a per\-database basis. The relevant parameters are \fBq\fP and
\fBn\fP\&.
.sp
\fIq\fP is the number of database shards to maintain. \fIn\fP is the number of
copies of each document to distribute. The default value for \fBn\fP is \fB3\fP,
and for \fBq\fP is \fB2\fP\&. With \fBq=2\fP, the database is split into 2 shards. With
\fBn=3\fP, the cluster distributes three replicas of each shard. Altogether,
that’s 6 shard replicas for a single database.
.sp
In a 3\-node cluster with \fBq=8\fP, each node would receive 8 shards. In a 4\-node
cluster, each node would receive 6 shards. We recommend in the general case
that the number of nodes in your cluster should be a multiple of \fBn\fP, so that
shards are distributed evenly.
.sp
CouchDB nodes have a \fBetc/default.ini\fP file with a section named
\fI\%cluster\fP which looks like this:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[cluster]
q=2
n=3
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
These settings specify the default sharding parameters for newly created
databases. These can be overridden in the \fBetc/local.ini\fP file by copying the
text above, and replacing the values with your new defaults.
If \fB[couch_peruser]\fP \fBq\fP is set, that value is used for per\-user databases.
(By default, it is set to 1, on the assumption that per\-user dbs will be quite
small and there will be many of them.)  The values can also be set on a
per\-database basis by specifying the \fBq\fP and \fBn\fP query parameters when the
database is created. For example:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \-X PUT \(dq$COUCH_URL:5984/database\-name?q=4&n=2\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This creates a database that is split into 4 shards and 2 replicas,
yielding 8 shard replicas distributed throughout the cluster.
.SS Quorum
.sp
Depending on the size of the cluster, the number of shards per database,
and the number of shard replicas, not every node may have access to
every shard, but every node knows where all the replicas of each shard
can be found through CouchDB’s internal shard map.
.sp
Each request that comes in to a CouchDB cluster is handled by any one
random coordinating node. This coordinating node proxies the request to
the other nodes that have the relevant data, which may or may not
include itself. The coordinating node sends a response to the client
once a \fI\%quorum\fP of
database nodes have responded; 2, by default. The default required size
of a quorum is equal to \fBr=w=((n+1)/2)\fP where \fBr\fP refers to the size
of a read quorum, \fBw\fP refers to the size of a write quorum, and \fBn\fP
refers to the number of replicas of each shard. In a default cluster where
\fBn\fP is 3, \fB((n+1)/2)\fP would be 2.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Each node in a cluster can be a coordinating node for any one
request. There are no special roles for nodes inside the cluster.
.UNINDENT
.UNINDENT
.sp
The size of the required quorum can be configured at request time by
setting the \fBr\fP parameter for document reads, and the \fBw\fP
parameter for document writes. The \fB_view\fP, \fB_find\fP, and
\fB_search\fP endpoints read only one copy no matter what quorum is
configured, effectively making a quorum of 1 for these requests.
.sp
For example, here is a request that directs the coordinating node to
send a response once at least two nodes have responded:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \(dq$COUCH_URL:5984/{db}/{doc}?r=2\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Here is a similar example for writing a document:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \-X PUT \(dq$COUCH_URL:5984/{db}/{doc}?w=2\(dq \-d \(aq{...}\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Setting \fBr\fP or \fBw\fP to be equal to \fBn\fP (the number of replicas)
means you will only receive a response once all nodes with relevant
shards have responded or timed out, and as such this approach does not
guarantee \fI\%ACIDic consistency\fP\&. Setting \fBr\fP or
\fBw\fP to 1 means you will receive a response after only one relevant
node has responded.
.SS Examining database shards
.sp
There are a few API endpoints that help you understand how a database
is sharded. Let’s start by making a new database on a cluster, and putting
a couple of documents into it:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \-X PUT $COUCH_URL:5984/mydb
{\(dqok\(dq:true}
$ curl \-X PUT $COUCH_URL:5984/mydb/joan \-d \(aq{\(dqloves\(dq:\(dqcats\(dq}\(aq
{\(dqok\(dq:true,\(dqid\(dq:\(dqjoan\(dq,\(dqrev\(dq:\(dq1\-cc240d66a894a7ee7ad3160e69f9051f\(dq}
$ curl \-X PUT $COUCH_URL:5984/mydb/robert \-d \(aq{\(dqloves\(dq:\(dqdogs\(dq}\(aq
{\(dqok\(dq:true,\(dqid\(dq:\(dqrobert\(dq,\(dqrev\(dq:\(dq1\-4032b428c7574a85bc04f1f271be446e\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
First, the top level \fI\%/db\fP endpoint will tell you what the sharding parameters
are for your database:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \-s $COUCH_URL:5984/db | jq .
{
  \(dqdb_name\(dq: \(dqmydb\(dq,
\&...
  \(dqcluster\(dq: {
    \(dqq\(dq: 8,
    \(dqn\(dq: 3,
    \(dqw\(dq: 2,
    \(dqr\(dq: 2
  },
\&...
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
So we know this database was created with 8 shards (\fBq=8\fP), and each
shard has 3 replicas (\fBn=3\fP) for a total of 24 shard replicas across
the nodes in the cluster.
.sp
Now, let’s see how those shard replicas are placed on the cluster with
the \fI\%/db/_shards\fP endpoint:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \-s $COUCH_URL:5984/mydb/_shards | jq .
{
  \(dqshards\(dq: {
    \(dq00000000\-1fffffff\(dq: [
      \(dqnode1@127.0.0.1\(dq,
      \(dqnode2@127.0.0.1\(dq,
      \(dqnode4@127.0.0.1\(dq
    ],
    \(dq20000000\-3fffffff\(dq: [
      \(dqnode1@127.0.0.1\(dq,
      \(dqnode2@127.0.0.1\(dq,
      \(dqnode3@127.0.0.1\(dq
    ],
    \(dq40000000\-5fffffff\(dq: [
      \(dqnode2@127.0.0.1\(dq,
      \(dqnode3@127.0.0.1\(dq,
      \(dqnode4@127.0.0.1\(dq
    ],
    \(dq60000000\-7fffffff\(dq: [
      \(dqnode1@127.0.0.1\(dq,
      \(dqnode3@127.0.0.1\(dq,
      \(dqnode4@127.0.0.1\(dq
    ],
    \(dq80000000\-9fffffff\(dq: [
      \(dqnode1@127.0.0.1\(dq,
      \(dqnode2@127.0.0.1\(dq,
      \(dqnode4@127.0.0.1\(dq
    ],
    \(dqa0000000\-bfffffff\(dq: [
      \(dqnode1@127.0.0.1\(dq,
      \(dqnode2@127.0.0.1\(dq,
      \(dqnode3@127.0.0.1\(dq
    ],
    \(dqc0000000\-dfffffff\(dq: [
      \(dqnode2@127.0.0.1\(dq,
      \(dqnode3@127.0.0.1\(dq,
      \(dqnode4@127.0.0.1\(dq
    ],
    \(dqe0000000\-ffffffff\(dq: [
      \(dqnode1@127.0.0.1\(dq,
      \(dqnode3@127.0.0.1\(dq,
      \(dqnode4@127.0.0.1\(dq
    ]
  }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Now we see that there are actually 4 nodes in this cluster, and CouchDB
has spread those 24 shard replicas evenly across all 4 nodes.
.sp
We can also see exactly which shard contains a given document with
the \fI\%/db/_shards/doc\fP endpoint:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \-s $COUCH_URL:5984/mydb/_shards/joan | jq .
{
  \(dqrange\(dq: \(dqe0000000\-ffffffff\(dq,
  \(dqnodes\(dq: [
    \(dqnode1@127.0.0.1\(dq,
    \(dqnode3@127.0.0.1\(dq,
    \(dqnode4@127.0.0.1\(dq
  ]
}
$ curl \-s $COUCH_URL:5984/mydb/_shards/robert | jq .
{
  \(dqrange\(dq: \(dq60000000\-7fffffff\(dq,
  \(dqnodes\(dq: [
    \(dqnode1@127.0.0.1\(dq,
    \(dqnode3@127.0.0.1\(dq,
    \(dqnode4@127.0.0.1\(dq
  ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB shows us the specific shard into which each of the two sample
documents is mapped.
.SS Moving a shard
.sp
When moving shards or performing other shard manipulations on the cluster, it
is advisable to stop all resharding jobs on the cluster. See
\fI\%Stopping Resharding Jobs\fP for more details.
.sp
This section describes how to manually place and replace shards. These
activities are critical steps when you determine your cluster is too big
or too small, and want to resize it successfully, or you have noticed
from server metrics that database/shard layout is non\-optimal and you
have some “hot spots” that need resolving.
.sp
Consider a three\-node cluster with q=8 and n=3. Each database has 24
shards, distributed across the three nodes. If you \fI\%add a fourth
node\fP to the cluster, CouchDB will not redistribute
existing database shards to it. This leads to unbalanced load, as the
new node will only host shards for databases created after it joined the
cluster. To balance the distribution of shards from existing databases,
they must be moved manually.
.sp
Moving shards between nodes in a cluster involves the following steps:
.INDENT 0.0
.IP 0. 4
\fI\%Ensure the target node has joined the cluster\fP\&.
.IP 1. 4
Copy the shard(s) and any secondary
\fI\%index shard(s) onto the target node\fP\&.
.IP 2. 4
\fI\%Set the target node to maintenance mode\fP\&.
.IP 3. 4
Update cluster metadata
\fI\%to reflect the new target shard(s)\fP\&.
.IP 4. 4
Monitor internal replication
\fI\%to ensure up\-to\-date shard(s)\fP\&.
.IP 5. 4
\fI\%Clear the target node’s maintenance mode\fP\&.
.IP 6. 4
Update cluster metadata again
\fI\%to remove the source shard(s)\fP
.IP 7. 4
Remove the shard file(s) and secondary index file(s)
\fI\%from the source node\fP\&.
.UNINDENT
.SS Copying shard files
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Technically, copying database and secondary index
shards is optional. If you proceed to the next step without
performing this data copy, CouchDB will use internal replication
to populate the newly added shard replicas. However, copying files
is faster than internal replication, especially on a busy cluster,
which is why we recommend performing this manual data copy first.
.UNINDENT
.UNINDENT
.sp
Shard files live in the \fBdata/shards\fP directory of your CouchDB
install. Within those subdirectories are the shard files themselves. For
instance, for a \fBq=8\fP database called \fBabc\fP, here is its database shard
files:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
data/shards/00000000\-1fffffff/abc.1529362187.couch
data/shards/20000000\-3fffffff/abc.1529362187.couch
data/shards/40000000\-5fffffff/abc.1529362187.couch
data/shards/60000000\-7fffffff/abc.1529362187.couch
data/shards/80000000\-9fffffff/abc.1529362187.couch
data/shards/a0000000\-bfffffff/abc.1529362187.couch
data/shards/c0000000\-dfffffff/abc.1529362187.couch
data/shards/e0000000\-ffffffff/abc.1529362187.couch
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Secondary indexes (including JavaScript views, Erlang views and Mango
indexes) are also sharded, and their shards should be moved to save the
new node the effort of rebuilding the view. View shards live in
\fBdata/.shards\fP\&. For example:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
data/.shards
data/.shards/e0000000\-ffffffff/_replicator.1518451591_design
data/.shards/e0000000\-ffffffff/_replicator.1518451591_design/mrview
data/.shards/e0000000\-ffffffff/_replicator.1518451591_design/mrview/3e823c2a4383ac0c18d4e574135a5b08.view
data/.shards/c0000000\-dfffffff
data/.shards/c0000000\-dfffffff/_replicator.1518451591_design
data/.shards/c0000000\-dfffffff/_replicator.1518451591_design/mrview
data/.shards/c0000000\-dfffffff/_replicator.1518451591_design/mrview/3e823c2a4383ac0c18d4e574135a5b08.view
\&...
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Since they are files, you can use \fBcp\fP, \fBrsync\fP,
\fBscp\fP or other file\-copying command to copy them from one node to
another. For example:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
# one one machine
$ mkdir \-p data/.shards/{range}
$ mkdir \-p data/shards/{range}
# on the other
$ scp {couch\-dir}/data/.shards/{range}/{database}.{datecode}* \e
  {node}:{couch\-dir}/data/.shards/{range}/
$ scp {couch\-dir}/data/shards/{range}/{database}.{datecode}.couch \e
  {node}:{couch\-dir}/data/shards/{range}/
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Remember to move view files before database files! If a view index
is ahead of its database, the database will rebuild it from
scratch.
.UNINDENT
.UNINDENT
.SS Set the target node to \fBtrue\fP maintenance mode
.sp
Before telling CouchDB about these new shards on the node, the node
must be put into maintenance mode. Maintenance mode instructs CouchDB to
return a \fB404 Not Found\fP response on the \fB/_up\fP endpoint, and
ensures it does not participate in normal interactive clustered requests
for its shards. A properly configured load balancer that uses \fBGET
/_up\fP to check the health of nodes will detect this 404 and remove the
node from circulation, preventing requests from being sent to that node.
For example, to configure HAProxy to use the \fB/_up\fP endpoint, use:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
http\-check disable\-on\-404
option httpchk GET /_up
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If you do not set maintenance mode, or the load balancer ignores this
maintenance mode status, after the next step is performed the cluster
may return incorrect responses when consulting the node in question. You
don’t want this! In the next steps, we will ensure that this shard is
up\-to\-date before allowing it to participate in end\-user requests.
.sp
To enable maintenance mode:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \-X PUT \-H \(dqContent\-type: application/json\(dq \e
    $COUCH_URL:5984/_node/{node\-name}/_config/couchdb/maintenance_mode \e
    \-d \(dq\e\(dqtrue\e\(dq\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Then, verify that the node is in maintenance mode by performing a \fBGET
/_up\fP on that node’s individual endpoint:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \-v $COUCH_URL/_up
…
< HTTP/1.1 404 Object Not Found
…
{\(dqstatus\(dq:\(dqmaintenance_mode\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Finally, check that your load balancer has removed the node from the
pool of available backend nodes.
.SS Updating cluster metadata to reflect the new target shard(s)
.sp
Now we need to tell CouchDB that the target node (which must already be
\fI\%joined to the cluster\fP) should be hosting
shard replicas for a given database.
.sp
To update the cluster metadata, use the special \fB/_dbs\fP database,
which is an internal CouchDB database that maps databases to shards and
nodes. This database is automatically replicated between nodes. It is accessible
only through the special \fB/_node/_local/_dbs\fP endpoint.
.sp
First, retrieve the database’s current metadata:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl http://localhost/_node/_local/_dbs/{name}
{
  \(dq_id\(dq: \(dq{name}\(dq,
  \(dq_rev\(dq: \(dq1\-e13fb7e79af3b3107ed62925058bfa3a\(dq,
  \(dqshard_suffix\(dq: [46, 49, 53, 51, 48, 50, 51, 50, 53, 50, 54],
  \(dqchangelog\(dq: [
    [\(dqadd\(dq, \(dq00000000\-1fffffff\(dq, \(dqnode1@xxx.xxx.xxx.xxx\(dq],
    [\(dqadd\(dq, \(dq00000000\-1fffffff\(dq, \(dqnode2@xxx.xxx.xxx.xxx\(dq],
    [\(dqadd\(dq, \(dq00000000\-1fffffff\(dq, \(dqnode3@xxx.xxx.xxx.xxx\(dq],
    …
  ],
  \(dqby_node\(dq: {
    \(dqnode1@xxx.xxx.xxx.xxx\(dq: [
      \(dq00000000\-1fffffff\(dq,
      …
    ],
    …
  },
  \(dqby_range\(dq: {
    \(dq00000000\-1fffffff\(dq: [
      \(dqnode1@xxx.xxx.xxx.xxx\(dq,
      \(dqnode2@xxx.xxx.xxx.xxx\(dq,
      \(dqnode3@xxx.xxx.xxx.xxx\(dq
    ],
    …
  }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Here is a brief anatomy of that document:
.INDENT 0.0
.IP \(bu 2
\fB_id\fP: The name of the database.
.IP \(bu 2
\fB_rev\fP: The current revision of the metadata.
.IP \(bu 2
\fBshard_suffix\fP: A timestamp of the database’s creation, marked as
seconds after the Unix epoch mapped to the codepoints for ASCII
numerals.
.IP \(bu 2
\fBchangelog\fP: History of the database’s shards.
.IP \(bu 2
\fBby_node\fP: List of shards on each node.
.IP \(bu 2
\fBby_range\fP: On which nodes each shard is.
.UNINDENT
.sp
To reflect the shard move in the metadata, there are three steps:
.INDENT 0.0
.IP 1. 3
Add appropriate changelog entries.
.IP 2. 3
Update the \fBby_node\fP entries.
.IP 3. 3
Update the \fBby_range\fP entries.
.UNINDENT
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
Be very careful! Mistakes during this process can
irreparably corrupt the cluster!
.UNINDENT
.UNINDENT
.sp
As of this writing, this process must be done manually.
.sp
To add a shard to a node, add entries like this to the database
metadata’s \fBchangelog\fP attribute:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[\(dqadd\(dq, \(dq{range}\(dq, \(dq{node\-name}\(dq]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The \fB{range}\fP is the specific shard range for the shard. The \fB{node\-name}\fP
should match the name and address of the node as displayed in \fBGET
/_membership\fP on the cluster.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
When removing a shard from a node, specify \fBremove\fP instead of \fBadd\fP\&.
.UNINDENT
.UNINDENT
.sp
Once you have figured out the new changelog entries, you will need to
update the \fBby_node\fP and \fBby_range\fP to reflect who is storing what
shards. The data in the changelog entries and these attributes must
match. If they do not, the database may become corrupted.
.sp
Continuing our example, here is an updated version of the metadata above
that adds shards to an additional node called \fBnode4\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
  \(dq_id\(dq: \(dq{name}\(dq,
  \(dq_rev\(dq: \(dq1\-e13fb7e79af3b3107ed62925058bfa3a\(dq,
  \(dqshard_suffix\(dq: [46, 49, 53, 51, 48, 50, 51, 50, 53, 50, 54],
  \(dqchangelog\(dq: [
    [\(dqadd\(dq, \(dq00000000\-1fffffff\(dq, \(dqnode1@xxx.xxx.xxx.xxx\(dq],
    [\(dqadd\(dq, \(dq00000000\-1fffffff\(dq, \(dqnode2@xxx.xxx.xxx.xxx\(dq],
    [\(dqadd\(dq, \(dq00000000\-1fffffff\(dq, \(dqnode3@xxx.xxx.xxx.xxx\(dq],
    ...
    [\(dqadd\(dq, \(dq00000000\-1fffffff\(dq, \(dqnode4@xxx.xxx.xxx.xxx\(dq]
  ],
  \(dqby_node\(dq: {
    \(dqnode1@xxx.xxx.xxx.xxx\(dq: [
      \(dq00000000\-1fffffff\(dq,
      ...
    ],
    ...
    \(dqnode4@xxx.xxx.xxx.xxx\(dq: [
      \(dq00000000\-1fffffff\(dq
    ]
  },
  \(dqby_range\(dq: {
    \(dq00000000\-1fffffff\(dq: [
      \(dqnode1@xxx.xxx.xxx.xxx\(dq,
      \(dqnode2@xxx.xxx.xxx.xxx\(dq,
      \(dqnode3@xxx.xxx.xxx.xxx\(dq,
      \(dqnode4@xxx.xxx.xxx.xxx\(dq
    ],
    ...
  }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Now you can \fBPUT\fP this new metadata:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \-X PUT http://localhost/_node/_local/_dbs/{name} \-d \(aq{...}\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Forcing synchronization of the shard(s)
.sp
New in version 2.4.0.

.sp
Whether you pre\-copied shards to your new node or not, you can force
CouchDB to synchronize all replicas of all shards in a database with the
\fI\%/db/_sync_shards\fP endpoint:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \-X POST $COUCH_URL:5984/{db}/_sync_shards
{\(dqok\(dq:true}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This starts the synchronization process. Note that this will put
additional load onto your cluster, which may affect performance.
.sp
It is also possible to force synchronization on a per\-shard basis by
writing to a document that is stored within that shard.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Admins may want to bump their \fB[mem3] sync_concurrency\fP value to a
larger figure for the duration of the shards sync.
.UNINDENT
.UNINDENT
.SS Monitor internal replication to ensure up\-to\-date shard(s)
.sp
After you complete the previous step, CouchDB will have started
synchronizing the shards. You can observe this happening by monitoring
the \fB/_node/{node\-name}/_system\fP endpoint, which includes the
\fBinternal_replication_jobs\fP metric.
.sp
Once this metric has returned to the baseline from before you started
the shard sync, or is \fB0\fP, the shard replica is ready to serve data
and we can bring the node out of maintenance mode.
.SS Clear the target node’s maintenance mode
.sp
You can now let the node start servicing data requests by
putting \fB\(dqfalse\(dq\fP to the maintenance mode configuration endpoint, just
as in step 2.
.sp
Verify that the node is not in maintenance mode by performing a \fBGET
/_up\fP on that node’s individual endpoint.
.sp
Finally, check that your load balancer has returned the node to the pool
of available backend nodes.
.SS Update cluster metadata again to remove the source shard
.sp
Now, remove the source shard from the shard map the same way that you
added the new target shard to the shard map in step 2. Be sure to add
the \fB[\(dqremove\(dq, {range}, {source\-shard}]\fP entry to the end of the
changelog as well as modifying both the \fBby_node\fP and \fBby_range\fP sections of
the database metadata document.
.SS Remove the shard and secondary index files from the source node
.sp
Finally, you can remove the source shard replica by deleting its file from the
command line on the source host, along with any view shard replicas:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ rm {couch\-dir}/data/shards/{range}/{db}.{datecode}.couch
$ rm \-r {couch\-dir}/data/.shards/{range}/{db}.{datecode}*
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Congratulations! You have moved a database shard replica. By adding and removing
database shard replicas in this way, you can change the cluster’s shard layout,
also known as a shard map.
.SS Specifying database placement
.sp
You can configure CouchDB to put shard replicas on certain nodes at
database creation time using placement rules.
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
Use of the \fBplacement\fP option will \fBoverride\fP the \fBn\fP option,
both in the \fB\&.ini\fP file as well as when specified in a \fBURL\fP\&.
.UNINDENT
.UNINDENT
.sp
First, each node must be labeled with a zone attribute. This defines which zone
each node is in. You do this by editing the node’s document in the special
\fB/_nodes\fP database, which is accessed through the special node\-local API
endpoint at \fB/_node/_local/_nodes/{node\-name}\fP\&. Add a key value pair of the
form:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\(dqzone\(dq: \(dq{zone\-name}\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Do this for all of the nodes in your cluster. For example:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \-X PUT http://localhost/_node/_local/_nodes/{node\-name} \e
    \-d \(aq{ \e
        \(dq_id\(dq: \(dq{node\-name}\(dq,
        \(dq_rev\(dq: \(dq{rev}\(dq,
        \(dqzone\(dq: \(dq{zone\-name}\(dq
        }\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
In the local config file (\fBlocal.ini\fP) of each node, define a
consistent cluster\-wide setting like:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[cluster]
placement = {zone\-name\-1}:2,{zone\-name\-2}:1
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
In this example, CouchDB will ensure that two replicas for a shard will
be hosted on nodes with the zone attribute set to \fB{zone\-name\-1}\fP and
one replica will be hosted on a new with the zone attribute set to
\fB{zone\-name\-2}\fP\&.
.sp
This approach is flexible, since you can also specify zones on a per\-
database basis by specifying the placement setting as a query parameter
when the database is created, using the same syntax as the ini file:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-X PUT $COUCH_URL:5984/{db}?zone={zone}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The \fBplacement\fP argument may also be specified. Note that this \fIwill\fP
override the logic that determines the number of created replicas!
.sp
Note that you can also use this system to ensure certain nodes in the
cluster do not host any replicas for newly created databases, by giving
them a zone attribute that does not appear in the \fB[cluster]\fP
placement string.
.SS Splitting Shards
.sp
The \fI\%/_reshard\fP is an HTTP API for shard manipulation. Currently
it only supports shard splitting. To perform shard merging, refer to the manual
process outlined in the \fI\%Merging Shards\fP section.
.sp
The main way to interact with \fI\%/_reshard\fP is to create resharding
jobs, monitor those jobs, wait until they complete, remove them, post new jobs,
and so on. What follows are a few steps one might take to use this API to split
shards.
.sp
At first, it’s a good idea to call \fBGET /_reshard\fP to see a summary of
resharding on the cluster.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \-s $COUCH_URL:5984/_reshard | jq .
{
  \(dqstate\(dq: \(dqrunning\(dq,
  \(dqstate_reason\(dq: null,
  \(dqcompleted\(dq: 3,
  \(dqfailed\(dq: 0,
  \(dqrunning\(dq: 0,
  \(dqstopped\(dq: 0,
  \(dqtotal\(dq: 3
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Two important things to pay attention to are the total number of jobs and the state.
.sp
The \fBstate\fP field indicates the state of resharding on the cluster. Normally
it would be \fBrunning\fP, however, another user could have disabled resharding
temporarily. Then, the state would be \fBstopped\fP and hopefully, there would be
a reason or a comment in the value of the \fBstate_reason\fP field. See
\fI\%Stopping Resharding Jobs\fP for more details.
.sp
The \fBtotal\fP number of jobs is important to keep an eye on because there is a
maximum number of resharding jobs per node, and creating new jobs after the
limit has been reached will result in an error. Before staring new jobs it’s a
good idea to remove already completed jobs. See \fI\%reshard configuration
section\fP for the default value of \fBmax_jobs\fP parameter and
how to adjust if needed.
.sp
For example, to remove all the completed jobs run:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ for jobid in $(curl \-s $COUCH_URL:5984/_reshard/jobs | jq \-r \(aq.jobs[] | select (.job_state==\(dqcompleted\(dq) | .id\(aq); do \e
      curl \-s \-XDELETE $COUCH_URL:5984/_reshard/jobs/$jobid \e
  done
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Then it’s a good idea to see what the db shard map looks like.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \-s $COUCH_URL:5984/db1/_shards | jq \(aq.\(aq
{
  \(dqshards\(dq: {
    \(dq00000000\-7fffffff\(dq: [
      \(dqnode1@127.0.0.1\(dq,
      \(dqnode2@127.0.0.1\(dq,
      \(dqnode3@127.0.0.1\(dq
    ],
    \(dq80000000\-ffffffff\(dq: [
      \(dqnode1@127.0.0.1\(dq,
      \(dqnode2@127.0.0.1\(dq,
      \(dqnode3@127.0.0.1\(dq
    ]
  }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
In this example we’ll split all the copies of the \fB00000000\-7fffffff\fP range.
The API allows a combination of parameters such as: splitting all
the ranges on all the nodes, all the ranges on just one node, or one particular
range on one particular node. These are specified via the \fBdb\fP,
\fBnode\fP and \fBrange\fP job parameters.
.sp
To split all the copies of \fB00000000\-7fffffff\fP we issue a request like this:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \-s \-H \(dqContent\-type: application/json\(dq \-XPOST $COUCH_URL:5984/_reshard/jobs \e
  \-d \(aq{\(dqtype\(dq: \(dqsplit\(dq, \(dqdb\(dq:\(dqdb1\(dq, \(dqrange\(dq:\(dq00000000\-7fffffff\(dq}\(aq | jq \(aq.\(aq
[
  {
    \(dqok\(dq: true,
    \(dqid\(dq: \(dq001\-ef512cfb502a1c6079fe17e9dfd5d6a2befcc694a146de468b1ba5339ba1d134\(dq,
    \(dqnode\(dq: \(dqnode1@127.0.0.1\(dq,
    \(dqshard\(dq: \(dqshards/00000000\-7fffffff/db1.1554242778\(dq
  },
  {
    \(dqok\(dq: true,
    \(dqid\(dq: \(dq001\-cec63704a7b33c6da8263211db9a5c74a1cb585d1b1a24eb946483e2075739ca\(dq,
    \(dqnode\(dq: \(dqnode2@127.0.0.1\(dq,
    \(dqshard\(dq: \(dqshards/00000000\-7fffffff/db1.1554242778\(dq
  },
  {
    \(dqok\(dq: true,
    \(dqid\(dq: \(dq001\-fc72090c006d9b059d4acd99e3be9bb73e986d60ca3edede3cb74cc01ccd1456\(dq,
    \(dqnode\(dq: \(dqnode3@127.0.0.1\(dq,
    \(dqshard\(dq: \(dqshards/00000000\-7fffffff/db1.1554242778\(dq
  }
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The request returned three jobs, one job for each of the three copies.
.sp
To check progress of these jobs use \fBGET /_reshard/jobs\fP or \fBGET
/_reshard/jobs/{jobid}\fP\&.
.sp
Eventually, these jobs should complete and the shard map should look like this:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \-s $COUCH_URL:5984/db1/_shards | jq \(aq.\(aq
{
  \(dqshards\(dq: {
    \(dq00000000\-3fffffff\(dq: [
      \(dqnode1@127.0.0.1\(dq,
      \(dqnode2@127.0.0.1\(dq,
      \(dqnode3@127.0.0.1\(dq
    ],
    \(dq40000000\-7fffffff\(dq: [
      \(dqnode1@127.0.0.1\(dq,
      \(dqnode2@127.0.0.1\(dq,
      \(dqnode3@127.0.0.1\(dq
    ],
    \(dq80000000\-ffffffff\(dq: [
      \(dqnode1@127.0.0.1\(dq,
      \(dqnode2@127.0.0.1\(dq,
      \(dqnode3@127.0.0.1\(dq
    ]
  }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Stopping Resharding Jobs
.sp
Resharding at the cluster level could be stopped and then restarted. This can
be helpful to allow external tools which manipulate the shard map to avoid
interfering with resharding jobs. To stop all resharding jobs on a cluster
issue a \fBPUT\fP to \fB/_reshard/state\fP endpoint with the \fB\(dqstate\(dq: \(dqstopped\(dq\fP
key and value. You can also specify an optional note or reason for stopping.
.sp
For example:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \-s \-H \(dqContent\-type: application/json\(dq \e
  \-XPUT $COUCH_URL:5984/_reshard/state \e
  \-d \(aq{\(dqstate\(dq: \(dqstopped\(dq, \(dqreason\(dq:\(dqMoving some shards\(dq}\(aq
{\(dqok\(dq: true}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This state will then be reflected in the global summary:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ curl \-s $COUCH_URL:5984/_reshard | jq .
{
  \(dqstate\(dq: \(dqstopped\(dq,
  \(dqstate_reason\(dq: \(dqMoving some shards\(dq,
  \(dqcompleted\(dq: 74,
  \(dqfailed\(dq: 0,
  \(dqrunning\(dq: 0,
  \(dqstopped\(dq: 0,
  \(dqtotal\(dq: 74
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
To restart, issue a \fBPUT\fP request like above with \fBrunning\fP as the state.
That should resume all the shard splitting jobs since their last checkpoint.
.sp
See the API reference for more details: \fI\%/_reshard\fP\&.
.SS Merging Shards
.sp
The \fBq\fP value for a database can be set when the database is created or it
can be increased later by splitting some of the shards
\fI\%Splitting Shards\fP\&. In order to decrease \fBq\fP and merge
some shards together, the database must be regenerated. Here are the steps:
.INDENT 0.0
.IP 1. 3
If there are running shard splitting jobs on the cluster, stop them via the
HTTP API \fI\%Stopping Resharding Jobs\fP\&.
.IP 2. 3
Create a temporary database with the desired shard settings, by
specifying the q value as a query parameter during the PUT
operation.
.IP 3. 3
Stop clients accessing the database.
.IP 4. 3
Replicate the primary database to the temporary one. Multiple
replications may be required if the primary database is under
active use.
.IP 5. 3
Delete the primary database. \fBMake sure nobody is using it!\fP
.IP 6. 3
Recreate the primary database with the desired shard settings.
.IP 7. 3
Clients can now access the database again.
.IP 8. 3
Replicate the temporary back to the primary.
.IP 9. 3
Delete the temporary database.
.UNINDENT
.sp
Once all steps have completed, the database can be used again. The
cluster will create and distribute its shards according to placement
rules automatically.
.sp
Downtime can be avoided in production if the client application(s) can
be instructed to use the new database instead of the old one, and a cut\-
over is performed during a very brief outage window.
.SS Clustered Purge
.sp
The primary purpose of clustered purge is to clean databases that have multiple
deleted tombstones or single documents that contain large numbers of conflicts.
But it can also be used to purge any document (deleted or non\-deleted) with any
number of revisions.
.sp
Clustered purge is designed to maintain eventual consistency and prevent
unnecessary invalidation of secondary indexes. For this, every database keeps
track of a certain number of historical purges requested in the database, as
well as its current \fBpurge_seq\fP\&. Internal replications and secondary indexes
process database’s purges and periodically update their corresponding purge
checkpoint documents to report \fBpurge_seq\fP processed by them. To ensure
eventual consistency, the database will remove stored historical purge requests
only after they have been processed by internal replication jobs and secondary
indexes.
.SS Internal Structures
.sp
To enable internal replication of purge information between nodes and secondary
indexes, two internal purge trees were added to a database file to track
historical purges.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
purge_tree: UUID \-> {PurgeSeq, DocId, Revs}
purge_seq_tree: PurgeSeq \-> {UUID, DocId, Revs}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Each interactive request to \fB_purge API\fP, creates an ordered set of pairs on
increasing \fBpurge_seq\fP and purge_request, where purge_request is a tuple that
contains docid and list of revisions. For each purge_request uuid is generated.
A purge request is added to internal purge trees:
a tuple \fB{UUID \-> {PurgeSeq, DocId, Revs}}\fP is added to \fBpurge_tree\fP,
a tuple is \fB{PurgeSeq \-> {UUID, DocId, Revs}}\fP added \fBto purge_seq_tree\fP\&.
.SS Compaction of Purges
.sp
During the compaction of the database the oldest purge requests are to be
removed to store only \fBpurged_infos_limit\fP number of purges in the database.
But in order to keep the database consistent with indexes and other replicas,
we can only remove purge requests that have already been processed by indexes
and internal replications jobs. Thus, occasionally purge trees may store
more than \fBpurged_infos_limit\fP purges. If the number of stored purges in the
database exceeds \fBpurged_infos_limit\fP by a certain threshold, a warning is
produced in logs signaling a problem of synchronization of database’s purges
with indexes and other replicas.
.SS Local Purge Checkpoint Documents
.sp
Indexes and internal replications of the database with purges create and
periodically update local checkpoint purge documents:
\fB_local/purge\-$type\-$hash\fP\&. These documents report the last \fBpurge_seq\fP
processed by them and the timestamp of the last processing. An example of a
local checkpoint purge document:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
  \(dq_id\(dq: \(dq_local/purge\-mrview\-86cacdfbaf6968d4ebbc324dd3723fe7\(dq,
  \(dqtype\(dq: \(dqmrview\(dq,
  \(dqpurge_seq\(dq: 10,
  \(dqupdated_on\(dq: 1540541874,
  \(dqddoc_id\(dq: \(dq_design/foo\(dq,
  \(dqsignature\(dq: \(dq5d10247925f826ae3e00966ec24b7bf6\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The below image shows possible local checkpoint documents that a database may
have.
.INDENT 0.0
.INDENT 2.5
[image: Local Purge Checkpoint Documents]
[image]
Local Purge Checkpoint Documents.UNINDENT
.UNINDENT
.SS Internal Replication
.sp
Purge requests are replayed across all nodes in an eventually consistent manner.
Internal replication of purges consists of two steps:
.sp
1. Pull replication. Internal replication first starts by pulling purges from
target and applying them on source to make sure we don’t reintroduce to target
source’s docs/revs that have been already purged on target. In this step, we use
purge checkpoint documents stored on target to keep track of the last target’s
\fBpurge_seq\fP processed by the source. We find purge requests occurred after
this \fBpurge_seq\fP, and replay them on source. This step is done by updating
the target’s checkpoint purge documents with the latest process \fBpurge_seq\fP
and timestamp.
.sp
2. Push replication. Then internal replication proceeds as usual with an extra
step inserted to push source’s purge requests to target. In this step, we use
local internal replication checkpoint documents, that are updated both on target
and source.
.sp
Under normal conditions, an interactive purge request is already sent to every
node containing a database shard’s replica, and applied on every replica.
Internal replication of purges between nodes is just an extra step to ensure
consistency between replicas, where all purge requests on one node are replayed
on another node. In order not to replay the same purge request on a replica,
each interactive purge request is tagged with a unique \fBuuid\fP\&. Internal
replication filters out purge requests with UUIDs that already exist in the
replica’s \fBpurge_tree\fP, and applies only purge requests with UUIDs that don’t
exist in the \fBpurge_tree\fP\&. This is the reason why we needed to have two
internal purge trees: 1) \fBpurge_tree\fP: \fB{UUID \-> {PurgeSeq, DocId, Revs}}\fP
allows to quickly find purge requests with UUIDs that already exist in the
replica; 2) \fBpurge_seq_tree\fP: \fB{PurgeSeq \-> {UUID, DocId, Revs}}\fP allows to
iterate from a given \fBpurge_seq\fP to collect all purge requests happened after
this \fBpurge_seq\fP\&.
.SS Indexes
.sp
Each purge request will bump up \fBupdate_seq\fP of the database, so that each
secondary index is also updated in order to apply the purge requests to maintain
consistency within the main database.
.SS Config Settings
.sp
These settings can be updated in the default.ini or local.ini:
.TS
center;
|l|l|l|.
_
T{
Field
T}	T{
Description
T}	T{
Default
T}
_
T{
max_document_id_number
T}	T{
Allowed maximum number of documents in one
purge request
T}	T{
100
T}
_
T{
max_revisions_number
T}	T{
Allowed maximum number of accumulated
revisions in one purge request
T}	T{
1000
T}
_
T{
allowed_purge_seq_lag
T}	T{
Beside purged_infos_limit, allowed
additional buffer to store purge requests
T}	T{
100
T}
_
T{
index_lag_warn_seconds
T}	T{
Allowed durations when index is not
updated for local purge checkpoint document
T}	T{
86400
T}
_
.TE
.sp
During a database compaction,  we check all checkpoint purge docs. A client (an
index or internal replication job) is allowed to have the last reported
\fBpurge_seq\fP to be smaller than the current database shard’s \fBpurge_seq\fP by
the value of \fB(purged_infos_limit + allowed_purge_seq_lag)\fP\&.  If the client’s
\fBpurge_seq\fP is even smaller, and the client has not checkpointed within
\fBindex_lag_warn_seconds\fP, it prevents compaction of purge trees and we have to
issue the following log warning for this client:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
Purge checkpoint \(aq_local/purge\-mrview\-9152d15c12011288629bcffba7693fd4’
not updated in 86400 seconds in
<<\(dqshards/00000000\-1fffffff/testdb12.1491979089\(dq>>
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If this type of log warning occurs, check the client to see why the processing
of purge requests is stalled in it.
.sp
There is a mapping relationship between a design document of indexes and local
checkpoint docs. If a design document of indexes is updated or deleted, the
corresponding local checkpoint document should be also automatically deleted.
But in an unexpected case, when a design doc was updated/deleted, but its
checkpoint document still exists in a database, the following warning will be
issued:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\(dqInvalid purge doc \(aq<<\(dq_design/bar\(dq>>\(aq on database
<<\(dqshards/00000000\-1fffffff/testdb12.1491979089\(dq>>
with purge_seq \(aq50\(aq\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If this type of log warning occurs, remove the local purge doc from a database.
.SS TLS Erlang Distribution
.sp
The main purpose is specifically to allow using TLS for Erlang distribution
between nodes, with the ability to connect to some nodes using TCP as well.
TLS distribution will enhance data security during data migration between
nodes.
.sp
This section describes how to enable TLS distribution for additional
verification and security.
.sp
Reference: \fI\%Using TLS for Erlang Distribution\fP
.SS Generate Certificate
.sp
For TLS to work properly, at least one public key and one certificate must be
specified. In the following example (couch_ssl_dist.conf), the PEM file contains
the \fBcertificate\fP and its \fBprivate key\fP\&.
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[{server,
  [{certfile, \(dq</path/to/erlserver.pem>\(dq},
   {secure_renegotiate, true}]},
 {client,
  [{secure_renegotiate, true}]}].
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
The following command is an example of generating a certificate (PEM) file.
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ openssl req \-newkey rsa:2048 \-new \-nodes \-x509 \-days 3650 \-keyout key.pem \-out cert.pem
$ cat key.pem cert.pem > erlserver.pem && rm key.pem cert.pem
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
This is \fBnot\fP an endorsement of a specific expiration limit,
key size or algorithm.
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Config Settings
.sp
To enable TLS distribution, make sure to set custom parameters in \fBvm.args\fP\&.
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
# Don\(aqt forget to override the paths to point to your cert and conf file!

\-proto_dist couch
\-couch_dist no_tls \e\(dqclouseau@127.0.0.1\e\(dq
\-ssl_dist_optfile <path/to/couch_ssl_dist.conf>
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.IP \(bu 2
The default value of \fBno_tls\fP is \fBfalse\fP\&. If the user does not
set any \fBno_tls\fP flag, all nodes will use \fBTCP\fP\&.
.IP \(bu 2
To ensure “search” works, make sure to set \fBno_tls\fP option for the
\fBclouseau\fP node. By default, this will be \fB\(dqclouseau@127.0.0.1\(dq\fP\&.
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
The \fBno_tls\fP flag can have these values:
.INDENT 0.0
.IP 1. 3
Use \fBTLS\fP only, set to \fBfalse\fP (default value), such as:
.INDENT 3.0
.INDENT 3.5
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\-couch_dist no_tls false
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.IP 2. 3
Use \fBTCP\fP only, set to \fBtrue\fP, such as:
.INDENT 3.0
.INDENT 3.5
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\-couch_dist no_tls true
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.IP 3. 3
Specify some nodes to use \fBTCP\fP, others to use \fBTLS\fP, such as:
.INDENT 3.0
.INDENT 3.5
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
# Specify node1 and node2 to use TCP, others use TLS

\-couch_dist no_tls \e\(dqnode1@127.0.0.1\e\(dq
\-couch_dist no_tls \e\(dqnode2@127.0.0.1\e\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
# Any nodes end with \(dq@127.0.0.1\(dq will use TCP, others use TLS

\-couch_dist no_tls \e\(dq*@127.0.0.1\e\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
\fBAsterisk(*)\fP: matches a sequence of zero or more occurrences of the regular
expression.
.sp
\fBQuestion mark(?)\fP: matches zero or one occurrences of the regular expression.
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Connect to Remsh
.sp
Start Erlang using a remote shell connected to Node.
.INDENT 0.0
.IP \(bu 2
If the node uses \fBTCP\fP:
.INDENT 2.0
.INDENT 3.5
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ ./remsh
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.IP \(bu 2
If the node uses \fBTLS\fP:
.INDENT 2.0
.INDENT 3.5
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ ./remsh \-t <path/to/couch_ssl_dist.conf>
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Troubleshooting CouchDB 3 with WeatherReport
.SS Overview
.sp
WeatherReport is an OTP application and set of tools that diagnoses
common problems which could affect a CouchDB version 3 node or cluster
(version 4 or later is not supported). It is accessed via the
\fBweatherreport\fP command line escript.
.sp
Here is a basic example of using \fBweatherreport\fP followed immediately
by the command’s output:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ weatherreport \-\-etc /path/to/etc
[warning] Cluster member node3@127.0.0.1 is not connected to this node. Please check whether it is down.
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Usage
.sp
For most cases, you can just run the \fBweatherreport\fP command as
shown above.  However, sometimes you might want to know some extra
detail, or run only specific checks. For that, there are command\-line
options. Execute \fBweatherreport \-\-help\fP to learn more about these
options:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ weatherreport \-\-help
Usage: weatherreport [\-c <path>] [\-d <level>] [\-e] [\-h] [\-l] [check_name ...]

  \-c, \-\-etc                 Path to the CouchDB configuration directory
  \-d, \-\-level               Minimum message severity level (default: notice)
  \-l, \-\-list                Describe available diagnostic tasks
  \-e, \-\-expert              Perform more detailed diagnostics
  \-h, \-\-help                Display help/usage
  check_name                A specific check to run
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
To get an idea of what checks will be run, use the \fI–list\fP option:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ weatherreport \-\-list
Available diagnostic checks:

  custodian            Shard safety/liveness checks
  disk                 Data directory permissions and atime
  internal_replication Check the number of pending internal replication jobs
  ioq                  Check the total number of active IOQ requests
  mem3_sync            Check there is a registered mem3_sync process
  membership           Cluster membership validity
  memory_use           Measure memory usage
  message_queues       Check for processes with large mailboxes
  node_stats           Check useful erlang statistics for diagnostics
  nodes_connected      Cluster node liveness
  process_calls        Check for large numbers of processes with the same current/initial call
  process_memory       Check for processes with high memory usage
  safe_to_rebuild      Check whether the node can safely be taken out of service
  search               Check the local search node is responsive
  tcp_queues           Measure the length of tcp queues in the kernel
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If you want all the gory details about what WeatherReport is doing,
you can run the checks at a more verbose logging level with
the \fB\-\-level\fP option:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ weatherreport \-\-etc /path/to/etc \-\-level debug
[debug] Not connected to the local cluster node, trying to connect. alive:false connect_failed:undefined
[debug] Starting distributed Erlang.
[debug] Connected to local cluster node \(aqnode1@127.0.0.1\(aq.
[debug] Local RPC: mem3:nodes([]) [5000]
[debug] Local RPC: os:getpid([]) [5000]
[debug] Running shell command: ps \-o pmem,rss \-p 73905
[debug] Shell command output:
%MEM    RSS
0.3  25116

[debug] Local RPC: erlang:nodes([]) [5000]
[debug] Local RPC: mem3:nodes([]) [5000]
[warning] Cluster member node3@127.0.0.1 is not connected to this node. Please check whether it is down.
[info] Process is using 0.3% of available RAM, totalling 25116 KB of real memory.
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Most times you’ll want to use the defaults, but any syslog severity
name will do (from most to least verbose): \fBdebug, info, notice,
warning, error, critical, alert, emergency\fP\&.
.sp
Finally, if you want to run just a single diagnostic or a list of
specific ones, you can pass their name(s):
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ weatherreport \-\-etc /path/to/etc nodes_connected
[warning] Cluster member node3@127.0.0.1 is not connected to this node. Please check whether it is down.
.ft P
.fi
.UNINDENT
.UNINDENT
.SH MAINTENANCE
.SS Compaction
.sp
The \fIcompaction\fP operation is a way to reduce disk space usage by removing
unused and old data from database or view index files. This operation is very
similar to the \fIvacuum\fP (\fI\%SQLite\fP ex.) operation available for other database
management systems.
.sp
During compaction, CouchDB re\-creates the database or view in a new file
with the \fB\&.compact\fP extension. As this requires roughly twice the disk storage,
CouchDB first checks for available disk space before proceeding.
.sp
When all actual data is successfully transferred to the newly compacted file,
CouchDB transparently swaps the compacted file into service, and removes the
old database or view file.
.sp
Since CouchDB 2.1.1, automated compaction is enabled by default, and is
described in the next section. It is still possible to trigger manual
compaction if desired or necessary. This is described in the subsequent
sections.
.SS Automatic Compaction
.sp
CouchDB’s automatic compaction daemon, internally known as “smoosh”, will
trigger compaction jobs for both databases and views based on configurable
thresholds for the sparseness of a file and the total amount of space that can
be recovered.
.SS Channels
.sp
Smoosh works using the concept of channels. A channel is essentially a queue of
pending compactions. There are separate sets of active channels for databases
and views. Each channel is assigned a configuration which defines whether a
compaction ends up in the channel’s queue and how compactions are prioritized
within that queue.
.sp
Smoosh takes each channel and works through the compactions queued in each in
priority order. Each channel is processed concurrently, so the priority levels
only matter within a given channel. Each channel has an assigned number of
active compactions, which defines how many compactions happen for that channel
in parallel. For example, a cluster with a lot of database churn but few views
might require more active compactions in the database channel(s).
.sp
It’s important to remember that a channel is local to a CouchDB node; that is,
each node maintains and processes an independent set of compactions. Channels
are defined as either “ratio” channels or “slack” channels, depending on the
type of algorithm used for prioritization:
.INDENT 0.0
.IP \(bu 2
Ratio: uses the ratio of sizes.file / sizes.active as its driving
calculation. The result X must be greater than some configurable value Y for
a compaction to be added to the queue. Compactions are then prioritised for
higher values of X.
.IP \(bu 2
Slack: uses the difference of sizes.file \- sizes.active as its driving
calculation. The result X must be greater than some configurable value Y for
a compaction to be added to the queue. Compactions are prioritised for
higher values of X.
.UNINDENT
.sp
In both cases, Y is set using the \fBmin_priority\fP configuration variable. CouchDB
ships with four channels pre\-configured: one channel of each type for databases,
and another one for views.
.SS Channel Configuration
.sp
Channels are defined using \fB[smoosh.<channel_name>]\fP configuration blocks, and
activated by naming the channel in the \fBdb_channels\fP or \fBview_channels\fP
configuration setting in the \fB[smoosh]\fP block. The default configuration is
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[smoosh]
db_channels = upgrade_dbs,ratio_dbs,slack_dbs
view_channels = upgrade_views,ratio_views,slack_views
cleanup_channels = index_cleanup

[smoosh.ratio_dbs]
priority = ratio
min_priority = 2.0

[smoosh.ratio_views]
priority = ratio
min_priority = 2.0

[smoosh.slack_dbs]
priority = slack
min_priority = 536870912

[smoosh.slack_views]
priority = slack
min_priority = 536870912
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The “upgrade” and “cleanup_channels” are special system channels. The “upgrade”
ones check whether the \fBdisk_format_version\fP for the file matches the current
version, and enqueue the file for compaction (which has the side effect of
upgrading the file format) if that’s not the case. In addition to that, the
\fBupgrade_views\fP will enqueue views for compaction after the collation
(libicu) library is upgraded. The “index_cleanup” channel is used for
scheduling jobs used to remove stale index files and purge _local checkpoint
document after design documents are updated.
.sp
Here are several additional properties that can be configured for each channel;
these are documented in the \fI\%configuration API\fP
.SS Scheduling Windows
.sp
Each compaction channel can be configured to run only during certain hours of
the day. The channel\-specific \fBfrom\fP, \fBto\fP, and \fBstrict_window\fP configuration
settings control this behavior. For example
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[smoosh.overnight_channel]
from = 20:00
to = 06:00
strict_window = true
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
where \fBovernight_channel\fP is the name of the channel you want to configure.
.sp
Note: CouchDB determines time via the UTC (GMT) timezone, so these settings must be
expressed as UTC (GMT).
.sp
The \fBstrict_window\fP setting will cause the compaction daemon to suspend all
active compactions in this channel when exiting the window, and resume them when
re\-entering. If \fBstrict_window\fP is left at its default of false, the active
compactions will be allowed to complete but no new compactions will be started.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
When a channel is created, a 60s timer is started to check if the channel
should be processing any compactions based on the time window defined in your config.
.sp
The channel is set to pending and after 60s it checks if it should be running
at all and is set to paused if not.
At the end of the check another 60s timer is started to schedule another check.
.sp
Eventually, when in the time window, it starts processing compactions.
But since it will continue running a check every 60s running compaction
processes will be suspended when exiting the time window and resume them when
re\-entering the window.
.sp
This means that for the first 60s after exiting the time window,
or when a channel is created and you are outside the time window,
compactions are run for up to 60s.This is different to the behavior of the
old compaction daemon which would cancel the compactions outright.
.UNINDENT
.UNINDENT
.SS Migration Guide
.sp
Previous versions of CouchDB shipped with a simpler compaction daemon. The
configuration system for the new daemon is not backwards\-compatible with the old
one, so users with customized compaction configurations will need to port them
to the new setup. The old daemon’s compaction rules configuration looked like
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[compaction_daemon]
min_file_size = 131072
check_interval = 3600
snooze_period_ms = 3000

[compactions]
mydb = [{db_fragmentation, \(dq70%\(dq}, {view_fragmentation, \(dq60%\(dq}, {parallel_view_compaction, true}]
_default = [{db_fragmentation, \(dq50%\(dq}, {view_fragmentation, \(dq55%\(dq}, {from, \(dq20:00\(dq}, {to, \(dq06:00\(dq}, {strict_window, true}]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Many of the elements of this configuration can be ported over to the new system.
Examining each in detail:
.INDENT 0.0
.IP \(bu 2
\fBmin_file_size\fP is now configured on a per\-channel basis using the
min_size config setting.
.IP \(bu 2
\fBdb_fragmentation\fP is equivalent to configuring a priority = ratio
channel with min_priority set to 1.0 / (1 \- db_fragmentation/100)
and then listing that channel in the [smoosh] db_channels config
setting.
.IP \(bu 2
\fBview_fragmention\fP is likewise equivalent to configuring a priority = ratio
channel with min_priority set to 1.0 / (1 \- view_fragmentation/100)
and then listing that channel in the [smoosh] view_channels config
setting.
.IP \(bu 2
\fBfrom\fP / \fBto\fP / \fBstrict_window\fP: each of these settings can be applied
on a per\-channel basis in the new daemon. The one behavior change is that
the new daemon will suspend compactions upon exiting the allowed window
instead of canceling them outright, and resume them when re\-entering.
.IP \(bu 2
\fBparallel_view_compaction\fP: each compaction channel has a concurrency
setting that controls how many compactions will execute in parallel in that
channel. The total parallelism is the sum of the concurrency settings of all
active channels. This is a departure from the previous behavior, in which
the daemon would only focus on one database and/or its views (depending on
the value of this flag) at a time.
.UNINDENT
.sp
The \fBcheck_interval\fP and \fBsnooze_period_ms\fP settings are obsolete in the
event\-driven design of the new daemon. The new daemon does not support setting
database\-specific thresholds as in the \fBmydb\fP setting above. Rather, channels
can be configured to focus on specific classes of files: large databases, small
view indexes, and so on. Most cases of named database compaction rules can be
expressed using properties of those databases and/or their associated views.
.SS Manual Database Compaction
.sp
Database compaction compresses the database file by removing unused file
sections created during updates. Old documents revisions are replaced with
small amount of metadata called \fBtombstone\fP which are used for conflicts
resolution during replication. The number of stored revisions
(and their \fBtombstones\fP) can be configured by using the \fI\%_revs_limit\fP URL endpoint.
.sp
Compaction can be manually triggered per database and runs as a background
task. To start it for specific database there is need to send HTTP
\fI\%POST /{db}/_compact\fP sub\-resource of the target database:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-H \(dqContent\-Type: application/json\(dq \-X POST http://localhost:5984/my_db/_compact
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
On success, HTTP status \fI\%202 Accepted\fP is returned immediately:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 202 Accepted
Cache\-Control: must\-revalidate
Content\-Length: 12
Content\-Type: text/plain; charset=utf\-8
Date: Wed, 19 Jun 2013 09:43:52 GMT
Server: CouchDB (Erlang/OTP)
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqok\(dq:true}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Although the request body is not used you must still specify
\fI\%Content\-Type\fP header with \fIapplication/json\fP value
for the request. If you don’t, you will be aware about with HTTP status
\fI\%415 Unsupported Media Type\fP response:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 415 Unsupported Media Type
Cache\-Control: must\-revalidate
Content\-Length: 78
Content\-Type: application/json
Date: Wed, 19 Jun 2013 09:43:44 GMT
Server: CouchDB (Erlang/OTP)

{\(dqerror\(dq:\(dqbad_content_type\(dq,\(dqreason\(dq:\(dqContent\-Type must be application/json\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
When the compaction is successful started and running it is possible to get
information about it via \fI\%database information resource\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl http://localhost:5984/my_db
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 246
Content\-Type: application/json
Date: Wed, 19 Jun 2013 16:51:20 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqcommitted_update_seq\(dq: 76215,
    \(dqcompact_running\(dq: true,
    \(dqdb_name\(dq: \(dqmy_db\(dq,
    \(dqdisk_format_version\(dq: 6,
    \(dqdoc_count\(dq: 5091,
    \(dqdoc_del_count\(dq: 0,
    \(dqinstance_start_time\(dq: \(dq0\(dq,
    \(dqpurge_seq\(dq: 0,
    \(dqsizes\(dq: {
      \(dqactive\(dq: 3787996,
      \(dqdisk\(dq: 17703025,
      \(dqexternal\(dq: 4763321
    },
    \(dqupdate_seq\(dq: 76215
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Note that \fBcompact_running\fP field is \fBtrue\fP indicating that compaction
is actually running. To track the compaction progress you may query the
\fI\%_active_tasks\fP resource:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl http://localhost:5984/_active_tasks
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 175
Content\-Type: application/json
Date: Wed, 19 Jun 2013 16:27:23 GMT
Server: CouchDB (Erlang/OTP)

[
    {
        \(dqchanges_done\(dq: 44461,
        \(dqdatabase\(dq: \(dqmy_db\(dq,
        \(dqpid\(dq: \(dq<0.218.0>\(dq,
        \(dqprogress\(dq: 58,
        \(dqstarted_on\(dq: 1371659228,
        \(dqtotal_changes\(dq: 76215,
        \(dqtype\(dq: \(dqdatabase_compaction\(dq,
        \(dqupdated_on\(dq: 1371659241
    }
]
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Manual View Compaction
.sp
Views also need compaction. Unlike databases, views are compacted by groups
per \fIdesign document\fP\&. To start their compaction, send the HTTP
\fI\%POST /{db}/_compact/{ddoc}\fP request:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-H \(dqContent\-Type: application/json\(dq \-X POST http://localhost:5984/dbname/_compact/designname
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqok\(dq:true}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This compacts the view index from the current version of the specified design
document. The HTTP response code is \fI\%202 Accepted\fP
(like \fI\%compaction for databases\fP) and a compaction background
task will be created.
.SS Views cleanup
.sp
View indexes on disk are named after their \fIMD5\fP hash of the view definition.
When you change a view, old indexes remain on disk. To clean up all outdated
view indexes (files named after the MD5 representation of views, that does not
exist anymore) you can trigger a \fI\%view cleanup\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
curl \-H \(dqContent\-Type: application/json\(dq \-X POST http://localhost:5984/dbname/_view_cleanup
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqok\(dq:true}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Performance
.sp
With up to tens of thousands of documents you will generally find CouchDB to
perform well no matter how you write your code. Once you start getting into
the millions of documents you need to be a lot more careful.
.SS Disk I/O
.SS File Size
.sp
The smaller your file size, the less \fII/O\fP operations there will be,
the more of the file can be cached by CouchDB and the operating system,
the quicker it is to replicate, backup etc. Consequently you should carefully
examine the data you are storing. For example it would be silly to use keys
that are hundreds of characters long, but your program would be hard to
maintain if you only used single character keys. Carefully consider data
that is duplicated by putting it in views.
.SS Disk and File System Performance
.sp
Using faster disks, striped RAID arrays and modern file systems can all speed
up your CouchDB deployment. However, there is one option that can increase
the responsiveness of your CouchDB server when disk performance is a
bottleneck. From the Erlang documentation for the file module:
.INDENT 0.0
.INDENT 3.5
On operating systems with thread support, it is possible to let file
operations be performed in threads of their own, allowing other Erlang
processes to continue executing in parallel with the file operations.
See the \fI\%command line flag +A in erl(1)\fP\&.
.UNINDENT
.UNINDENT
.sp
Setting this argument to a number greater than zero can keep your CouchDB
installation responsive even during periods of heavy disk utilization. The
easiest way to set this option is through the \fBERL_FLAGS\fP environment
variable. For example, to give Erlang four threads with which to perform I/O
operations add the following to \fB(prefix)/etc/defaults/couchdb\fP
(or equivalent):
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
export ERL_FLAGS=\(dq+A 4\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.SS System Resource Limits
.sp
One of the problems that administrators run into as their deployments become
large are resource limits imposed by the system and by the application
configuration. Raising these limits can allow your deployment to grow beyond
what the default configuration will support.
.SS CouchDB Configuration Options
.SS max_dbs_open
.sp
In your \fI\%configuration\fP (local.ini or similar) familiarize
yourself with the \fI\%couchdb/max_dbs_open\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[couchdb]
max_dbs_open = 100
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This option places an upper bound on the number of databases that can be
open at one time. CouchDB reference counts database accesses internally and
will close idle databases when it must. Sometimes it is necessary to keep
more than the default open at once, such as in deployments where many databases
will be continuously replicating.
.SS Erlang
.sp
Even if you’ve increased the maximum connections CouchDB will allow,
the Erlang runtime system will not allow more than 65536 connections by
default. Adding the following directive to \fB(prefix)/etc/vm.args\fP (or
equivalent) will increase this limit (in this case to 102400):
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
+Q 102400
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Note that on Windows, Erlang will not actually increase the file descriptor
limit past 8192 (i.e. the system header–defined value of \fBFD_SETSIZE\fP). On
macOS, the limit may be as low as 1024. See \fI\%this tip for a possible
workaround\fP and \fI\%this thread for a deeper explanation\fP\&.
.SS Maximum open file descriptors (ulimit)
.sp
In general, modern UNIX\-like systems can handle very large numbers of file
handles per process (e.g. 100000) without problem. Don’t be afraid to increase
this limit on your system.
.sp
The method of increasing these limits varies, depending on your init system and
particular OS release. The default value for many OSes is 1024 or 4096. On a
system with many databases or many views, CouchDB can very rapidly hit this
limit.
.sp
For systemd\-based Linuxes (such as CentOS/RHEL 7, Ubuntu 16.04+, Debian 8
or newer), assuming you are launching CouchDB from systemd, you must
override the upper limit via editing the override file. The best practice
for this is via the \fBsystemctl edit couchdb\fP command. Add these lines to
the file in the editor:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[Service]
LimitNOFILE=65536
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
…or whatever value you like. To increase this value higher than 65536, you
must also add the Erlang \fB+Q\fP parameter to your \fBetc/vm.args\fP file by
adding the line:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
+Q 102400
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The old \fBERL_MAX_PORTS\fP environment variable is ignored by the version of
Erlang supplied with CouchDB.
.sp
If your system is set up to use the Pluggable Authentication Modules (\fI\%PAM\fP),
and you are \fBnot\fP launching CouchDB from systemd, increasing this limit
is straightforward. For example, creating a file named
\fB/etc/security/limits.d/100\-couchdb.conf\fP with the following contents will
ensure that CouchDB can open up to 65536 file descriptors at once:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
#<domain>    <type>    <item>    <value>
couchdb      hard      nofile    65536
couchdb      soft      nofile    65536
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If you are using our Debian/Ubuntu sysvinit script (\fB/etc/init.d/couchdb\fP),
you also need to raise the limits for the root user:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
#<domain>    <type>    <item>    <value>
root         hard      nofile    65536
root         soft      nofile    65536
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You may also have to edit the \fB/etc/pam.d/common\-session\fP and
\fB/etc/pam.d/common\-session\-noninteractive\fP files to add the line:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
session required pam_limits.so
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
if it is not already present.
.sp
If your system does not use PAM, a \fIulimit\fP command is usually available for
use in a custom script to launch CouchDB with increased resource limits.
Typical syntax would be something like \fIulimit \-n 65536\fP\&.
.SS Network
.sp
There is latency overhead making and receiving each request/response.
In general you should do your requests in batches. Most APIs have some
mechanism to do batches, usually by supplying lists of documents or keys in
the request body. Be careful what size you pick for the batches. The larger
batch requires more time your client has to spend encoding the items into JSON
and more time is spent decoding that number of responses. Do some benchmarking
with your own configuration and typical data to find the sweet spot.
It is likely to be between one and ten thousand documents.
.sp
If you have a fast I/O system then you can also use concurrency \- have
multiple requests/responses at the same time. This mitigates the latency
involved in assembling JSON, doing the networking and decoding JSON.
.sp
As of CouchDB 1.1.0, users often report lower write performance of documents
compared to older releases. The main reason is that this release ships with
the more recent version of the HTTP server library MochiWeb, which by default
sets the TCP socket option \fI\%SO_NODELAY\fP to false. This means that small data
sent to the TCP socket, like the reply to a document write request (or reading
a very small document), will not be sent immediately to the network \- TCP will
buffer it for a while hoping that it will be asked to send more data through
the same socket and then send all the data at once for increased performance.
This TCP buffering behaviour can be disabled via
\fI\%httpd/socket_options\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[httpd]
socket_options = [{nodelay, true}]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBSEE ALSO:\fP
.INDENT 0.0
.INDENT 3.5
Bulk \fI\%load\fP and \fI\%store\fP API.
.UNINDENT
.UNINDENT
.SS Connection limit
.sp
\fI\%MochiWeb\fP handles CouchDB requests.
The default maximum number of connections is 2048. To change this limit, use the
\fBserver_options\fP configuration variable. \fBmax\fP indicates maximum number of
connections.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
server_options = [{backlog, 128}, {acceptor_pool_size, 16}, {max, 4096}]
.ft P
.fi
.UNINDENT
.UNINDENT
.SS CouchDB
.SS DELETE operation
.sp
When you \fI\%DELETE\fP a document the database will create a new
revision which contains the \fB_id\fP and \fB_rev\fP fields as well as
the \fI_deleted\fP flag. This revision will remain even after a \fIdatabase
compaction\fP so that the deletion can be replicated. Deleted documents, like
non\-deleted documents, can affect view build times, \fI\%PUT\fP and
\fI\%DELETE\fP request times, and the size of the database since they
increase the size of the B+Tree. You can see the number of deleted documents
in \fI\%database information\fP\&. If your use case creates lots of
deleted documents (for example, if you are storing short\-term data like log
entries, message queues, etc), you might want to periodically switch to a new
database and delete the old one (once the entries in it have all expired).
.SS Document’s ID
.sp
The db file size is derived from your document and view sizes but also on a
multiple of your \fB_id\fP sizes. Not only is the \fB_id\fP present in the document,
but it and parts of it are duplicated in the binary tree structure CouchDB uses
to navigate the file to find the document in the first place. As a real world
example for one user switching from 16 byte ids to 4 byte ids made a database
go from 21GB to 4GB with 10 million documents (the raw JSON text when from
2.5GB to 2GB).
.sp
Inserting with sequential (and at least sorted) ids is faster than random ids.
Consequently you should consider generating ids yourself, allocating them
sequentially and using an encoding scheme that consumes fewer bytes.
For example, something that takes 16 hex digits to represent can be done in
4 base 62 digits (10 numerals, 26 lower case, 26 upper case).
.SS Views
.SS Views Generation
.sp
Views with the JavaScript query server are extremely slow to generate when
there are a non\-trivial number of documents to process. The generation process
won’t even saturate a single CPU let alone your I/O. The cause is the latency
involved in the CouchDB server and separate \fIcouchjs\fP query server, dramatically
indicating how important it is to take latency out of your implementation.
.sp
You can let view access be “stale” but it isn’t practical to determine when
that will occur giving you a quick response and when views will be updated
which will take a long time. (A 10 million document database took about 10
minutes to load into CouchDB but about 4 hours to do view generation).
.sp
In a cluster, “stale” requests are serviced by a fixed set of shards in order
to present users with consistent results between requests. This comes with an
availability trade\-off \- the fixed set of shards might not be the most
responsive / available within the cluster. If you don’t need this kind of
consistency (e.g. your indexes are relatively static), you can tell CouchDB to
use any available replica by specifying \fBstable=false&update=false\fP instead of
\fBstale=ok\fP, or \fBstable=false&update=lazy\fP instead of \fBstale=update_after\fP\&.
.sp
View information isn’t replicated \- it is rebuilt on each database so you
can’t do the view generation on a separate sever.
.SS Built\-In Reduce Functions
.sp
If you’re using a very simple view function that only performs a sum or count
reduction, you can call native Erlang implementations of them by simply
writing \fB_sum\fP or \fB_count\fP in place of your function declaration.
This will speed up things dramatically, as it cuts down on IO between CouchDB
and the \fI\%JavaScript query server\fP\&. For example, as
\fI\%mentioned on the mailing list\fP, the time for outputting an (already indexed
and cached) view with about 78,000 items went down from 60 seconds to 4 seconds.
.sp
Before:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dq_design/foo\(dq,
    \(dqviews\(dq: {
        \(dqbar\(dq: {
            \(dqmap\(dq: \(dqfunction (doc) { emit(doc.author, 1); }\(dq,
            \(dqreduce\(dq: \(dqfunction (keys, values, rereduce) { return sum(values); }\(dq
        }
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
After:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dq_design/foo\(dq,
    \(dqviews\(dq: {
        \(dqbar\(dq: {
            \(dqmap\(dq: \(dqfunction (doc) { emit(doc.author, 1); }\(dq,
            \(dqreduce\(dq: \(dq_sum\(dq
        }
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBSEE ALSO:\fP
.INDENT 0.0
.INDENT 3.5
\fI\%Built\-in Reduce Functions\fP
.UNINDENT
.UNINDENT
.SS Backing up CouchDB
.sp
CouchDB has three different types of files it can create during runtime:
.INDENT 0.0
.IP \(bu 2
Database files (including secondary indexes)
.IP \(bu 2
Configuration files (\fB*.ini\fP)
.IP \(bu 2
Log files (if configured to log to disk)
.UNINDENT
.sp
Below are strategies for ensuring consistent backups of all of these files.
.SS Database Backups
.sp
The simplest and easiest approach for CouchDB backup is to use \fI\%CouchDB
replication\fP to another CouchDB installation.  You can choose
between \fI\%normal (one\-shot) or continuous replications\fP depending on your need.
.sp
However, you can also copy the actual \fB\&.couch\fP files from the CouchDB data
directory (by default, \fBdata/\fP) at any time, without problem. CouchDB’s
append\-only storage format for both databases and secondary indexes ensures that
this will work without issue.
.sp
To ensure reliability of backups, it is recommended that you \fIback up secondary
indexes\fP (stored under \fBdata/.shards\fP) \fIprior to backing up the main database
files\fP (stored under \fBdata/shards\fP as well as the system\-level databases at the
parent \fBdata/\fP directory). This is because CouchDB will automatically handle
views/secondary indexes that are slightly out of date by updating them on the
next read access, but views or secondary indexes that are \fInewer\fP than their
associated databases will trigger a \fIfull rebuild of the index\fP\&. This can be a
very costly and time\-consuming operation, and can impact your ability to
recover quickly in a disaster situation.
.sp
On supported operating systems/storage environments, you can also make use of
\fI\%storage snapshots\fP\&.
These have the advantage of being near\-instantaneous when working with block
storage systems such as \fI\%ZFS\fP or \fI\%LVM\fP or \fI\%Amazon EBS\fP\&. When using
snapshots at the block\-storage level, be sure to quiesce the file system with an
OS\-level utility such as Linux’s \fI\%fsfreeze\fP if necessary. If unsure, consult your
operating system’s or cloud provider’s documentation for more detail.
.SS Configuration Backups
.sp
CouchDB’s \fI\%configuration system\fP stores data in \fB\&.ini\fP files
under the configuration directory (by default, \fBetc/\fP). If changes are made
to the configuration at runtime, the very last file in the configuration chain
will be updated with the changes.
.sp
Simple back up the entire \fBetc/\fP directory to ensure a consistent configuration
after restoring from backup.
.sp
If no changes to the configuration are made at runtime through the HTTP API,
and all configuration files are managed by a configuration management system
(such as \fI\%Ansible\fP or
\fI\%Chef\fP), there is no need to
backup the configuration directory.
.SS Log Backups
.sp
If \fI\%configured to log to a file\fP, you may want to back up the
log files written by CouchDB. Any backup solution for these files works.
.sp
Under UNIX\-like systems, if using log rotation software, a copy\-then\-truncate
approach is necessary. This will truncate the original log file to zero size in
place after creating a copy. CouchDB does not recognize any signal to be told to
close its log file and create a new one. Because of this, and because of
differences in how file handles function, there is no straightforward log
rotation solution under Microsoft Windows other than periodic restarts of the
CouchDB process.
.SH FAUXTON
.SS Fauxton Setup
.sp
Fauxton is included with CouchDB 2.0, so make sure CouchDB is running, then go to:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
http://127.0.0.1:5984/_utils/
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You can also upgrade to the latest version of Fauxton by using npm:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ npm install \-g fauxton
$ fauxton
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
(Recent versions of \fI\%node.js\fP and \fI\%npm\fP are required.)
.SS Fauxton Visual Guide
.INDENT 0.0
.TP
.B You can find the Visual Guide here:
\fI\%http://couchdb.apache.org/fauxton\-visual\-guide\fP
.UNINDENT
.SS Development Server
.sp
Recent versions of \fI\%node.js\fP and \fI\%npm\fP are required.
.sp
Using the dev server is the easiest way to use Fauxton, specially when developing for it:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ git clone https://github.com/apache/couchdb\-fauxton.git
$ npm install && npm run dev
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Understanding Fauxton Code layout
.sp
Each bit of functionality is its own separate module or addon.
.sp
All core modules are stored under \fIapp/module\fP and any addons that are optional
are under \fIapp/addons\fP\&.
.sp
We use \fI\%backbone.js\fP and \fI\%Backbone.layoutmanager\fP quite heavily, so best to
get an idea how they work. Its best at this point to read through a couple of
the modules and addons to get an idea of how they work.
.sp
Two good starting points are \fIapp/addon/config\fP and \fIapp/modules/databases\fP\&.
.sp
Each module must have a \fIbase.js\fP file, this is read and compile when Fauxton is
deployed.
.sp
The \fIresource.js\fP file is usually for your \fBBackbone.Models\fP and
\fBBackbone.Collections\fP, \fIview.js\fP for your \fBBackbone.Views\fP\&.
.sp
The \fIroutes.js\fP is used to register a url path for your view along with what
layout, data, breadcrumbs and api point is required for the view.
.SS ToDo items
.sp
Checkout \fIJIRA\fP or \fI\%GitHub Issues\fP  for a list of items to do.
.SH EXPERIMENTAL FEATURES
.sp
This is a list of experimental features in CouchDB. They are included in
a release because the development team is requesting feedback from the
larger developer community. As such, please play around with these
features and send us feedback, thanks!
.sp
Use at your own risk! Do not rely on these features for critical applications.
.SS Content\-Security\-Policy (CSP) Header Support for /_utils (Fauxton)
.sp
This will just work with Fauxton. You can enable it in your config: you
can enable the feature in general and change the default header that is
sent for everything in /_utils.
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[csp]
enable = true
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
Then restart CouchDB.
.sp
Have fun!
.SH API REFERENCE
.sp
The components of the API URL path help determine the part of the CouchDB
server that is being accessed. The result is the structure of the URL request
both identifies and effectively describes the area of the database you are
accessing.
.sp
As with all URLs, the individual components are separated by a forward slash.
.sp
As a general rule, URL components and JSON fields starting with the \fB_\fP
(underscore) character represent a special component or entity within the
server or returned object. For example, the URL fragment \fB/_all_dbs\fP gets a
list of all of the databases in a CouchDB instance.
.sp
This reference is structured according to the URL structure, as below.
.SS API Basics
.sp
The CouchDB API is the primary method of interfacing to a CouchDB instance.
Requests are made using HTTP and requests are used to request information from
the database, store new data, and perform views and formatting of the
information stored within the documents.
.sp
Requests to the API can be categorised by the different areas of the CouchDB
system that you are accessing, and the HTTP method used to send the request.
Different methods imply different operations, for example retrieval of
information from the database is typically handled by the \fBGET\fP operation,
while updates are handled by either a \fBPOST\fP or \fBPUT\fP request. There are
some differences between the information that must be supplied for the
different methods. For a guide to the basic HTTP methods and request structure,
see \fI\%Request Format and Responses\fP\&.
.sp
For nearly all operations, the submitted data, and the returned data structure,
is defined within a JavaScript Object Notation (JSON) object. Basic information
on the content and data types for JSON are provided in \fI\%JSON Basics\fP\&.
.sp
Errors when accessing the CouchDB API are reported using standard HTTP Status
Codes. A guide to the generic codes returned by CouchDB are provided in
\fI\%HTTP Status Codes\fP\&.
.sp
When accessing specific areas of the CouchDB API, specific information and
examples on the HTTP methods and request, JSON structures, and error codes are
provided.
.SS Request Format and Responses
.sp
CouchDB supports the following HTTP request methods:
.INDENT 0.0
.IP \(bu 2
\fBGET\fP
.sp
Request the specified item. As with normal HTTP requests, the format of the
URL defines what is returned. With CouchDB this can include static items,
database documents, and configuration and statistical information. In most
cases the information is returned in the form of a JSON document.
.IP \(bu 2
\fBHEAD\fP
.sp
The \fBHEAD\fP method is used to get the HTTP header of a \fBGET\fP request
without the body of the response.
.IP \(bu 2
\fBPOST\fP
.sp
Upload data. Within CouchDB \fBPOST\fP is used to set values, including
uploading documents, setting document values, and starting certain
administration commands.
.IP \(bu 2
\fBPUT\fP
.sp
Used to put a specified resource. In CouchDB \fBPUT\fP is used to create new
objects, including databases, documents, views and design documents.
.IP \(bu 2
\fBDELETE\fP
.sp
Deletes the specified resource, including documents, views, and design
documents.
.IP \(bu 2
\fBCOPY\fP
.sp
A special method that can be used to copy documents and objects.
.UNINDENT
.sp
If you use an unsupported HTTP request type with an URL that does not support
the specified type then a \fB405 \- Method Not Allowed\fP will be returned,
listing the supported HTTP methods. For example:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqerror\(dq:\(dqmethod_not_allowed\(dq,
    \(dqreason\(dq:\(dqOnly GET,HEAD allowed\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS HTTP Headers
.sp
Because CouchDB uses HTTP for all communication, you need to ensure that the
correct HTTP headers are supplied (and processed on retrieval) so that you get
the right format and encoding. Different environments and clients will be more
or less strict on the effect of these HTTP headers (especially when not
present). Where possible you should be as specific as possible.
.SS Request Headers
.INDENT 0.0
.IP \(bu 2
\fBAccept\fP
.sp
Specifies the list of accepted data types to be returned by the server (i.e.
that are accepted/understandable by the client). The format should be a list
of one or more MIME types, separated by colons.
.sp
For the majority of requests the definition should be for JSON data
(\fBapplication/json\fP). For attachments you can either specify the MIME type
explicitly, or use \fB*/*\fP to specify that all file types are supported. If
the \fBAccept\fP header is not supplied, then the \fB*/*\fP MIME type is assumed
(i.e. client accepts all formats).
.sp
The use of \fBAccept\fP in queries for CouchDB is not required, but is highly
recommended as it helps to ensure that the data returned can be processed by
the client.
.sp
If you specify a data type using the \fBAccept\fP header, CouchDB will honor
the specified type in the \fBContent\-type\fP header field returned. For
example, if you explicitly request \fBapplication/json\fP in the \fBAccept\fP of
a request, the returned HTTP headers will use the value in the returned
\fBContent\-type\fP field.
.sp
For example, when sending a request without an explicit \fBAccept\fP header, or
when specifying \fB*/*\fP:
.INDENT 2.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes HTTP/1.1
Host: couchdb:5984
Accept: */*
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The returned headers are:
.INDENT 2.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Server: CouchDB (Erlang/OTP)
Date: Thu, 13 Jan 2011 13:39:34 GMT
Content\-Type: text/plain;charset=utf\-8
Content\-Length: 227
Cache\-Control: must\-revalidate
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 2.0
.INDENT 3.5
The returned content type is \fBtext/plain\fP even though the information
returned by the request is in JSON format.
.UNINDENT
.UNINDENT
.sp
Explicitly specifying the \fBAccept\fP header:
.INDENT 2.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes HTTP/1.1
Host: couchdb:5984
Accept: application/json
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The headers returned include the \fBapplication/json\fP content type:
.INDENT 2.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Server: CouchDB (Erlang/OTP)
Date: Thu, 13 Jan 2013 13:40:11 GMT
Content\-Type: application/json
Content\-Length: 227
Cache\-Control: must\-revalidate
.ft P
.fi
.UNINDENT
.UNINDENT
.IP \(bu 2
\fBContent\-type\fP
.sp
Specifies the content type of the information being supplied within the
request. The specification uses MIME type specifications. For the majority of
requests this will be JSON (\fBapplication/json\fP). For some settings the MIME
type will be plain text. When uploading attachments it should be the
corresponding MIME type for the attachment or binary
(\fBapplication/octet\-stream\fP).
.sp
The use of the \fBContent\-type\fP on a request is highly recommended.
.UNINDENT
.SS Response Headers
.sp
Response headers are returned by the server when sending back content and
include a number of different header fields, many of which are standard HTTP
response header and have no significance to CouchDB operation. The list of
response headers important to CouchDB are listed below.
.INDENT 0.0
.IP \(bu 2
\fBCache\-control\fP
.sp
The cache control HTTP response header provides a suggestion for client
caching mechanisms on how to treat the returned information. CouchDB
typically returns the \fBmust\-revalidate\fP, which indicates that the
information should be revalidated if possible. This is used to ensure that
the dynamic nature of the content is correctly updated.
.IP \(bu 2
\fBContent\-length\fP
.sp
The length (in bytes) of the returned content.
.IP \(bu 2
\fBContent\-type\fP
.sp
Specifies the MIME type of the returned data. For most request, the returned
MIME type is \fBtext/plain\fP\&. All text is encoded in Unicode (UTF\-8), and this
is explicitly stated in the returned \fBContent\-type\fP, as
\fBtext/plain;charset=utf\-8\fP\&.
.IP \(bu 2
\fBEtag\fP
.sp
The \fBEtag\fP HTTP header field is used to show the revision for a document,
or a view.
.sp
ETags have been assigned to a map/reduce group (the collection of views in a
single design document). Any change to any of the indexes for those views
would generate a new ETag for all view URLs in a single design doc, even if
that specific view’s results had not changed.
.sp
Each \fB_view\fP URL has its own ETag which only gets updated when changes are
made to the database that effect that index. If the index for that specific
view does not change, that view keeps the original ETag head (therefore
sending back \fB304 \- Not Modified\fP more often).
.IP \(bu 2
\fBTransfer\-Encoding\fP
.sp
If the response uses an encoding, then it is specified in this header field.
.sp
\fBTransfer\-Encoding: chunked\fP means that the response is sent in parts, a
method known as \fI\%chunked transfer encoding\fP\&. This is used when CouchDB does
not know beforehand the size of the data it will send (for example,
the \fI\%changes feed\fP).
.IP \(bu 2
\fBX\-CouchDB\-Body\-Time\fP
.sp
Time spent receiving the request body in milliseconds.
.sp
Available when body content is included in the request.
.IP \(bu 2
\fBX\-Couch\-Request\-ID\fP
.sp
Unique identifier for the request.
.UNINDENT
.SS JSON Basics
.sp
The majority of requests and responses to CouchDB use the JavaScript Object
Notation (JSON) for formatting the content and structure of the data and
responses.
.sp
JSON is used because it is the simplest and easiest solution for working with
data within a web browser, as JSON structures can be evaluated and used as
JavaScript objects within the web browser environment. JSON also integrates
with the server\-side JavaScript used within CouchDB.
.sp
JSON supports the same basic types as supported by JavaScript, these are:
.INDENT 0.0
.IP \(bu 2
Array \- a list of values enclosed in square brackets. For example:
.INDENT 2.0
.INDENT 3.5
.sp
.nf
.ft C
[\(dqone\(dq, \(dqtwo\(dq, \(dqthree\(dq]
.ft P
.fi
.UNINDENT
.UNINDENT
.IP \(bu 2
Boolean \- a \fBtrue\fP or \fBfalse\fP value. You can use these strings directly.
For example:
.INDENT 2.0
.INDENT 3.5
.sp
.nf
.ft C
{ \(dqvalue\(dq: true}
.ft P
.fi
.UNINDENT
.UNINDENT
.IP \(bu 2
Number \- an integer or floating\-point number.
.IP \(bu 2
Object \- a set of key/value pairs (i.e. an associative array, or hash). The
key must be a string, but the value can be any of the supported JSON values.
For example:
.INDENT 2.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqservings\(dq : 4,
    \(dqsubtitle\(dq : \(dqEasy to make in advance, and then cook when ready\(dq,
    \(dqcooktime\(dq : 60,
    \(dqtitle\(dq : \(dqChicken Coriander\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
In CouchDB, the JSON object is used to represent a variety of structures,
including the main CouchDB document.
.IP \(bu 2
String \- this should be enclosed by double\-quotes and supports Unicode
characters and backslash escaping. For example:
.INDENT 2.0
.INDENT 3.5
.sp
.nf
.ft C
\(dqA String\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.sp
Parsing JSON into a JavaScript object is supported through the \fBJSON.parse()\fP
function in JavaScript, or through various libraries that will perform the
parsing of the content into a JavaScript object for you. Libraries for parsing
and generating JSON are available in many languages, including Perl, Python,
Ruby, Erlang and others.
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
Care should be taken to ensure that your JSON structures are valid,
invalid structures will cause CouchDB to return an HTTP status code of 500
(server error).
.UNINDENT
.UNINDENT
.SS Number Handling
.sp
Developers and users new to computer handling of numbers often encounter
surprises when expecting that a number stored in JSON format does not
necessarily return as the same number as compared character by character.
.sp
Any numbers defined in JSON that contain a decimal point or exponent will be
passed through the Erlang VM’s idea of the “double” data type. Any numbers that
are used in views will pass through the view server’s idea of a number (the
common JavaScript case means even integers pass through a double due to
JavaScript’s definition of a number).
.sp
Consider this document that we write to CouchDB:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq:\(dq30b3b38cdbd9e3a587de9b8122000cff\(dq,
    \(dqnumber\(dq: 1.1
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Now let’s read that document back from CouchDB:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq:\(dq30b3b38cdbd9e3a587de9b8122000cff\(dq,
    \(dq_rev\(dq:\(dq1\-f065cee7c3fd93aa50f6c97acde93030\(dq,
    \(dqnumber\(dq:1.1000000000000000888
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
What happens is CouchDB is changing the textual representation of the
result of decoding what it was given into some numerical format. In most
cases this is an \fI\%IEEE 754\fP double precision floating point number which
is exactly what almost all other languages use as well.
.sp
What Erlang does a bit differently than other languages is that it does not
attempt to pretty print the resulting output to use the shortest number of
characters. For instance, this is why we have this relationship:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
ejson:encode(ejson:decode(<<\(dq1.1\(dq>>)).
<<\(dq1.1000000000000000888\(dq>>
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
What can be confusing here is that internally those two formats decode into the
same IEEE\-754 representation. And more importantly, it will decode into a
fairly close representation when passed through all major parsers that we know
about.
.sp
While we’ve only been discussing cases where the textual representation
changes, another important case is when an input value contains more precision
than can actually represented in a double. (You could argue that this case is
actually “losing” data if you don’t accept that numbers are stored in doubles).
.sp
Here’s a log for a couple of the more common JSON libraries that happen to be
on the author’s machine:
.sp
Ejson (CouchDB’s current parser) at CouchDB sha 168a663b:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ ./utils/run \-i
Erlang R14B04 (erts\-5.8.5) [source] [64\-bit] [smp:2:2] [rq:2]
[async\-threads:4] [hipe] [kernel\-poll:true]

Eshell V5.8.5  (abort with ^G)
1> ejson:encode(ejson:decode(<<\(dq1.01234567890123456789012345678901234567890\(dq>>)).
<<\(dq1.0123456789012346135\(dq>>
2> F = ejson:encode(ejson:decode(<<\(dq1.01234567890123456789012345678901234567890\(dq>>)).
<<\(dq1.0123456789012346135\(dq>>
3> ejson:encode(ejson:decode(F)).
<<\(dq1.0123456789012346135\(dq>>
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Node:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ node \-v
v0.6.15
$ node
JSON.stringify(JSON.parse(\(dq1.01234567890123456789012345678901234567890\(dq))
\(aq1.0123456789012346\(aq
var f = JSON.stringify(JSON.parse(\(dq1.01234567890123456789012345678901234567890\(dq))
undefined
JSON.stringify(JSON.parse(f))
\(aq1.0123456789012346\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Python:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ python
Python 2.7.2 (default, Jun 20 2012, 16:23:33)
[GCC 4.2.1 Compatible Apple Clang 4.0 (tags/Apple/clang\-418.0.60)] on darwin
Type \(dqhelp\(dq, \(dqcopyright\(dq, \(dqcredits\(dq or \(dqlicense\(dq for more information.
import json
json.dumps(json.loads(\(dq1.01234567890123456789012345678901234567890\(dq))
\(aq1.0123456789012346\(aq
f = json.dumps(json.loads(\(dq1.01234567890123456789012345678901234567890\(dq))
json.dumps(json.loads(f))
\(aq1.0123456789012346\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Ruby:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ irb \-\-version
irb 0.9.5(05/04/13)
require \(aqJSON\(aq
=> true
JSON.dump(JSON.load(\(dq[1.01234567890123456789012345678901234567890]\(dq))
=> \(dq[1.01234567890123]\(dq
f = JSON.dump(JSON.load(\(dq[1.01234567890123456789012345678901234567890]\(dq))
=> \(dq[1.01234567890123]\(dq
JSON.dump(JSON.load(f))
=> \(dq[1.01234567890123]\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
A small aside on Ruby, it requires a top level object or array, so I just
wrapped the value. Should be obvious it doesn’t affect the result of
parsing the number though.
.UNINDENT
.UNINDENT
.sp
Spidermonkey:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ js \-h 2>&1 | head \-n 1
JavaScript\-C 1.8.5 2011\-03\-31
$ js
js> JSON.stringify(JSON.parse(\(dq1.01234567890123456789012345678901234567890\(dq))
\(dq1.0123456789012346\(dq
js> var f = JSON.stringify(JSON.parse(\(dq1.01234567890123456789012345678901234567890\(dq))
js> JSON.stringify(JSON.parse(f))
\(dq1.0123456789012346\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
As you can see they all pretty much behave the same except for Ruby actually
does appear to be losing some precision over the other libraries.
.sp
The astute observer will notice that ejson (the CouchDB JSON library) reported
an extra three digits. While its tempting to think that this is due to some
internal difference, its just a more specific case of the 1.1 input as
described above.
.sp
The important point to realize here is that a double can only hold a finite
number of values. What we’re doing here is generating a string that when passed
through the “standard” floating point parsing algorithms (ie, \fBstrtod\fP) will
result in the same bit pattern in memory as we started with. Or, slightly
different, the bytes in a JSON serialized number are chosen such that they
refer to a single specific value that a double can represent.
.sp
The important point to understand is that we’re mapping from one infinite set
onto a finite set. An easy way to see this is by reflecting on this:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
1.0 == 1.00 == 1.000 = 1.(infinite zeros)
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Obviously a computer can’t hold infinite bytes so we have to decimate our
infinitely sized set to a finite set that can be represented concisely.
.sp
The game that other JSON libraries are playing is merely:
.sp
“How few characters do I have to use to select this specific value for a
double”
.sp
And that game has lots and lots of subtle details that are difficult to
duplicate in C without a significant amount of effort (it took Python over a
year to get it sorted with their fancy build systems that automatically run on
a number of different architectures).
.sp
Hopefully we’ve shown that CouchDB is not doing anything “funky” by changing
input. Its behaving the same as any other common JSON library does, its just
not pretty printing its output.
.sp
On the other hand, if you actually are in a position where an IEEE\-754 double
is not a satisfactory data type for your numbers, then the answer as has been
stated is to not pass your numbers through this representation. In JSON this is
accomplished by encoding them as a string or by using integer types (although
integer types can still bite you if you use a platform that has a different
integer representation than normal, ie, JavaScript).
.sp
Further information can be found easily, including the
\fI\%Floating Point Guide\fP, and  \fI\%David Goldberg’s Reference\fP\&.
.sp
Also, if anyone is really interested in changing this behavior, we’re all ears
for contributions to \fI\%jiffy\fP (which is theoretically going to replace ejson
when we get around to updating the build system). The places we’ve looked for
inspiration are TCL and Python. If you know a decent implementation of this
float printing algorithm give us a holler.
.SS HTTP Status Codes
.sp
With the interface to CouchDB working through HTTP, error codes and statuses
are reported using a combination of the HTTP status code number, and
corresponding data in the body of the response data.
.sp
A list of the error codes returned by CouchDB, and generic descriptions of the
related errors are provided below. The meaning of different status codes for
specific request types are provided in the corresponding API call reference.
.INDENT 0.0
.IP \(bu 2
\fB200 \- OK\fP
.sp
Request completed successfully.
.IP \(bu 2
\fB201 \- Created\fP
.sp
Document created successfully.
.IP \(bu 2
\fB202 \- Accepted\fP
.sp
Request has been accepted, but the corresponding operation may not have
completed. This is used for background operations, such as database
compaction.
.IP \(bu 2
\fB304 \- Not Modified\fP
.sp
The additional content requested has not been modified. This is used with the
ETag system to identify the version of information returned.
.IP \(bu 2
\fB400 \- Bad Request\fP
.sp
Bad request structure. The error can indicate an error with the request URL,
path or headers. Differences in the supplied MD5 hash and content also
trigger this error, as this may indicate message corruption.
.IP \(bu 2
\fB401 \- Unauthorized\fP
.sp
The item requested was not available using the supplied authorization, or
authorization was not supplied.
.IP \(bu 2
\fB403 \- Forbidden\fP
.sp
The requested item or operation is forbidden.
.IP \(bu 2
\fB404 \- Not Found\fP
.sp
The requested content could not be found. The content will include further
information, as a JSON object, if available. The structure will contain two
keys, \fBerror\fP and \fBreason\fP\&. For example:
.INDENT 2.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqerror\(dq:\(dqnot_found\(dq,\(dqreason\(dq:\(dqno_db_file\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.IP \(bu 2
\fB405 \- Method Not Allowed\fP
.sp
A request was made using an invalid HTTP request type for the URL requested.
For example, you have requested a \fBPUT\fP when a \fBPOST\fP is required. Errors
of this type can also triggered by invalid URL strings.
.IP \(bu 2
\fB406 \- Not Acceptable\fP
.sp
The requested content type is not supported by the server.
.IP \(bu 2
\fB409 \- Conflict\fP
.sp
Request resulted in an update conflict.
.IP \(bu 2
\fB412 \- Precondition Failed\fP
.sp
The request headers from the client and the capabilities of the server do not
match.
.IP \(bu 2
\fB413 \- Request Entity Too Large\fP
.sp
A document exceeds the configured \fI\%couchdb/max_document_size\fP
value or the entire request exceeds the
\fI\%chttpd/max_http_request_size\fP value.
.IP \(bu 2
\fB415 \- Unsupported Media Type\fP
.sp
The content types supported, and the content type of the information being
requested or submitted indicate that the content type is not supported.
.IP \(bu 2
\fB416 \- Requested Range Not Satisfiable\fP
.sp
The range specified in the request header cannot be satisfied by the server.
.IP \(bu 2
\fB417 \- Expectation Failed\fP
.sp
When sending documents in bulk, the bulk load operation failed.
.IP \(bu 2
\fB500 \- Internal Server Error\fP
.sp
The request was invalid, either because the supplied JSON was invalid, or
invalid information was supplied as part of the request.
.IP \(bu 2
\fB503 \- Service Unavailable\fP
.sp
The request can’t be serviced at this time, either because the cluster is overloaded,
maintenance is underway, or some other reason.
The request may be retried without changes, perhaps in a couple of minutes.
.UNINDENT
.SS Server
.sp
The CouchDB server interface provides the basic interface to a
CouchDB server for obtaining CouchDB information and getting and setting
configuration information.
.SS \fB/\fP
.INDENT 0.0
.TP
.B GET /
Accessing the root of a CouchDB instance returns meta information about the
instance. The response is a JSON structure containing information about the
server, including a welcome message and the version of the server.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET / HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 179
Content\-Type: application/json
Date: Sat, 10 Aug 2013 06:33:33 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqcouchdb\(dq: \(dqWelcome\(dq,
    \(dquuid\(dq: \(dq85fb71bf700c17267fef77535820e371\(dq,
    \(dqvendor\(dq: {
        \(dqname\(dq: \(dqThe Apache Software Foundation\(dq,
        \(dqversion\(dq: \(dq1.3.1\(dq
    },
    \(dqversion\(dq: \(dq1.3.1\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/_active_tasks\fP
.sp
Changed in version 2.1.0: Because of how the scheduling replicator works, continuous replication jobs could be periodically stopped and then started later. When they are not running they will not appear in the \fB_active_tasks\fP endpoint

.sp
Changed in version 3.3: Added \fI“bulk_get_attempts”\fP and \fI“bulk_get_docs”\fP fields for replication jobs.

.INDENT 0.0
.TP
.B GET /_active_tasks
List of running tasks, including the task type, name, status
and process ID. The result is a JSON array of the currently running tasks,
with each task being described with a single object. Depending on operation
type set of response object fields might be different.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBchanges_done\fP (\fInumber\fP) – Processed changes
.IP \(bu 2
\fBdatabase\fP (\fIstring\fP) – Source database
.IP \(bu 2
\fBpid\fP (\fIstring\fP) – Process ID
.IP \(bu 2
\fBprogress\fP (\fInumber\fP) – Current percentage progress
.IP \(bu 2
\fBstarted_on\fP (\fInumber\fP) – Task start time as unix timestamp
.IP \(bu 2
\fBstatus\fP (\fIstring\fP) – Task status message
.IP \(bu 2
\fBtask\fP (\fIstring\fP) – Task name
.IP \(bu 2
\fBtotal_changes\fP (\fInumber\fP) – Total changes to process
.IP \(bu 2
\fBtype\fP (\fIstring\fP) – Operation Type
.IP \(bu 2
\fBupdated_on\fP (\fInumber\fP) – Unix timestamp of last operation update
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_active_tasks HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 1690
Content\-Type: application/json
Date: Sat, 10 Aug 2013 06:37:31 GMT
Server: CouchDB (Erlang/OTP)

[
    {
        \(dqchanges_done\(dq: 64438,
        \(dqdatabase\(dq: \(dqmailbox\(dq,
        \(dqpid\(dq: \(dq<0.12986.1>\(dq,
        \(dqprogress\(dq: 84,
        \(dqstarted_on\(dq: 1376116576,
        \(dqtotal_changes\(dq: 76215,
        \(dqtype\(dq: \(dqdatabase_compaction\(dq,
        \(dqupdated_on\(dq: 1376116619
    },
    {
        \(dqchanges_done\(dq: 14443,
        \(dqdatabase\(dq: \(dqmailbox\(dq,
        \(dqdesign_document\(dq: \(dqc9753817b3ba7c674d92361f24f59b9f\(dq,
        \(dqpid\(dq: \(dq<0.10461.3>\(dq,
        \(dqprogress\(dq: 18,
        \(dqstarted_on\(dq: 1376116621,
        \(dqtotal_changes\(dq: 76215,
        \(dqtype\(dq: \(dqindexer\(dq,
        \(dqupdated_on\(dq: 1376116650
    },
    {
        \(dqchanges_done\(dq: 5454,
        \(dqdatabase\(dq: \(dqmailbox\(dq,
        \(dqdesign_document\(dq: \(dq_design/meta\(dq,
        \(dqpid\(dq: \(dq<0.6838.4>\(dq,
        \(dqprogress\(dq: 7,
        \(dqstarted_on\(dq: 1376116632,
        \(dqtotal_changes\(dq: 76215,
        \(dqtype\(dq: \(dqindexer\(dq,
        \(dqupdated_on\(dq: 1376116651
    },
    {
        \(dqcheckpointed_source_seq\(dq: 68585,
        \(dqcontinuous\(dq: false,
        \(dqdoc_id\(dq: null,
        \(dqdoc_write_failures\(dq: 0,
        \(dqbulk_get_attempts\(dq: 4524,
        \(dqbulk_get_docs\(dq: 4524,
        \(dqdocs_read\(dq: 4524,
        \(dqdocs_written\(dq: 4524,
        \(dqmissing_revisions_found\(dq: 4524,
        \(dqpid\(dq: \(dq<0.1538.5>\(dq,
        \(dqprogress\(dq: 44,
        \(dqreplication_id\(dq: \(dq9bc1727d74d49d9e157e260bb8bbd1d5\(dq,
        \(dqrevisions_checked\(dq: 4524,
        \(dqsource\(dq: \(dqmailbox\(dq,
        \(dqsource_seq\(dq: 154419,
        \(dqstarted_on\(dq: 1376116644,
        \(dqtarget\(dq: \(dqhttp://mailsrv:5984/mailbox\(dq,
        \(dqtype\(dq: \(dqreplication\(dq,
        \(dqupdated_on\(dq: 1376116651
    }
]
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/_all_dbs\fP
.INDENT 0.0
.TP
.B GET /_all_dbs
Returns a list of all the databases in the CouchDB instance.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBdescending\fP (\fIboolean\fP) – Return the databases in descending order by key.
Default is \fBfalse\fP\&.
.IP \(bu 2
\fBendkey\fP (\fIjson\fP) – Stop returning databases when the specified key is
reached.
.IP \(bu 2
\fBend_key\fP (\fIjson\fP) – Alias for \fBendkey\fP param
.IP \(bu 2
\fBlimit\fP (\fInumber\fP) – Limit the number of the returned databases to the
specified number.
.IP \(bu 2
\fBskip\fP (\fInumber\fP) – Skip this number of databases before starting to return
the results. Default is \fB0\fP\&.
.IP \(bu 2
\fBstartkey\fP (\fIjson\fP) – Return databases starting with the specified key.
.IP \(bu 2
\fBstart_key\fP (\fIjson\fP) – Alias for \fBstartkey\fP\&.
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_all_dbs HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 52
Content\-Type: application/json
Date: Sat, 10 Aug 2013 06:57:48 GMT
Server: CouchDB (Erlang/OTP)

[
   \(dq_users\(dq,
   \(dqcontacts\(dq,
   \(dqdocs\(dq,
   \(dqinvoices\(dq,
   \(dqlocations\(dq
]
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/_dbs_info\fP
.sp
New in version 3.2.

.INDENT 0.0
.TP
.B GET /_dbs_info
Returns a list of all the databases information in the CouchDB instance.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBdescending\fP (\fIboolean\fP) – Return databases information in descending order
by key. Default is \fBfalse\fP\&.
.IP \(bu 2
\fBendkey\fP (\fIjson\fP) – Stop returning databases information when the specified
key is reached.
.IP \(bu 2
\fBend_key\fP (\fIjson\fP) – Alias for \fBendkey\fP param
.IP \(bu 2
\fBlimit\fP (\fInumber\fP) – Limit the number of the returned databases information
to the specified number.
.IP \(bu 2
\fBskip\fP (\fInumber\fP) – Skip this number of databases before starting to return
the results. Default is \fB0\fP\&.
.IP \(bu 2
\fBstartkey\fP (\fIjson\fP) – Return databases information starting with the
specified key.
.IP \(bu 2
\fBstart_key\fP (\fIjson\fP) – Alias for \fBstartkey\fP\&.
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_dbs_info HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Thu, 18 Nov 2021 14:37:35 GMT
Server: CouchDB (Erlang OTP/23)

[
  {
    \(dqkey\(dq: \(dqanimals\(dq,
    \(dqinfo\(dq: {
      \(dqdb_name\(dq: \(dqanimals\(dq,
      \(dqupdate_seq\(dq: \(dq52232\(dq,
      \(dqsizes\(dq: {
        \(dqfile\(dq: 1178613587,
        \(dqexternal\(dq: 1713103872,
        \(dqactive\(dq: 1162451555
      },
      \(dqpurge_seq\(dq: 0,
      \(dqdoc_del_count\(dq: 0,
      \(dqdoc_count\(dq: 52224,
      \(dqdisk_format_version\(dq: 6,
      \(dqcompact_running\(dq: false,
      \(dqcluster\(dq: {
        \(dqq\(dq: 8,
        \(dqn\(dq: 3,
        \(dqw\(dq: 2,
        \(dqr\(dq: 2
      },
      \(dqinstance_start_time\(dq: \(dq0\(dq
    }
  }
]
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.sp
New in version 2.2.

.INDENT 0.0
.TP
.B POST /_dbs_info
Returns information of a list of the specified databases in the CouchDB
instance. This enables you to request information about multiple databases
in a single request, in place of multiple \fI\%GET /{db}\fP requests.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Request JSON Object
.INDENT 7.0
.IP \(bu 2
\fBkeys\fP (\fIarray\fP) – Array of database names to be requested
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%400 Bad Request\fP – Missing keys or exceeded keys in request
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /_dbs_info HTTP/1.1
Accept: application/json
Host: localhost:5984
Content\-Type: application/json

{
    \(dqkeys\(dq: [
        \(dqanimals\(dq,
        \(dqplants\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Sat, 20 Dec 2017 06:57:48 GMT
Server: CouchDB (Erlang/OTP)

[
  {
    \(dqkey\(dq: \(dqanimals\(dq,
    \(dqinfo\(dq: {
      \(dqdb_name\(dq: \(dqanimals\(dq,
      \(dqupdate_seq\(dq: \(dq52232\(dq,
      \(dqsizes\(dq: {
        \(dqfile\(dq: 1178613587,
        \(dqexternal\(dq: 1713103872,
        \(dqactive\(dq: 1162451555
      },
      \(dqpurge_seq\(dq: 0,
      \(dqdoc_del_count\(dq: 0,
      \(dqdoc_count\(dq: 52224,
      \(dqdisk_format_version\(dq: 6,
      \(dqcompact_running\(dq: false,
      \(dqcluster\(dq: {
        \(dqq\(dq: 8,
        \(dqn\(dq: 3,
        \(dqw\(dq: 2,
        \(dqr\(dq: 2
      },
      \(dqinstance_start_time\(dq: \(dq0\(dq
    }
  },
  {
    \(dqkey\(dq: \(dqplants\(dq,
    \(dqinfo\(dq: {
      \(dqdb_name\(dq: \(dqplants\(dq,
      \(dqupdate_seq\(dq: \(dq303\(dq,
      \(dqsizes\(dq: {
        \(dqfile\(dq: 3872387,
        \(dqexternal\(dq: 2339,
        \(dqactive\(dq: 67475
      },
      \(dqpurge_seq\(dq: 0,
      \(dqdoc_del_count\(dq: 0,
      \(dqdoc_count\(dq: 11,
      \(dqdisk_format_version\(dq: 6,
      \(dqcompact_running\(dq: false,
      \(dqcluster\(dq: {
        \(dqq\(dq: 8,
        \(dqn\(dq: 3,
        \(dqw\(dq: 2,
        \(dqr\(dq: 2
      },
      \(dqinstance_start_time\(dq: \(dq0\(dq
    }
  }
]
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
The supported number of the specified databases in the list can be limited
by modifying the \fImax_db_number_for_dbs_info_req\fP entry in configuration
file. The default limit is 100. Increasing the limit, while possible, creates
load on the server so it is advisable to have more requests with 100 dbs,
rather than a few requests with 1000s of dbs at a time.
.UNINDENT
.UNINDENT
.SS \fB/_cluster_setup\fP
.sp
New in version 2.0.

.INDENT 0.0
.TP
.B GET /_cluster_setup
Returns the status of the node or cluster, per the cluster setup wizard.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBensure_dbs_exist\fP (\fIarray\fP) – List of system databases to ensure exist
on the node/cluster. Defaults to
\fB[\(dq_users\(dq,\(dq_replicator\(dq]\fP\&.
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBstate\fP (\fIstring\fP) – Current \fBstate\fP of the node and/or cluster (see
below)
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.UNINDENT
.UNINDENT
.sp
The \fBstate\fP returned indicates the current node or cluster state, and
is one of the following:
.INDENT 7.0
.IP \(bu 2
\fBcluster_disabled\fP: The current node is completely unconfigured.
.IP \(bu 2
\fBsingle_node_disabled\fP: The current node is configured as a single
(standalone) node (\fB[cluster] n=1\fP), but either does not have a
server\-level admin user defined, or does not have the standard system
databases created. If the \fBensure_dbs_exist\fP query parameter is
specified, the list of databases provided overrides the default list
of standard system databases.
.IP \(bu 2
\fBsingle_node_enabled\fP: The current node is configured as a single
(standalone) node, has a server\-level admin user defined, and has
the \fBensure_dbs_exist\fP list (explicit or default) of databases
created.
.IP \(bu 2
\fBcluster_enabled\fP: The current node has \fB[cluster] n\fP > 1, is not
bound to \fB127.0.0.1\fP and has a server\-level admin user defined.
However, the full set of standard system databases have not been
created yet. If the \fBensure_dbs_exist\fP query parameter is
specified, the list of databases provided overrides the default list
of standard system databases.
.IP \(bu 2
\fBcluster_finished\fP: The current node has \fB[cluster] n\fP > 1, is not
bound to \fB127.0.0.1\fP, has a server\-level admin user defined \fIand\fP
has the \fBensure_dbs_exist\fP list (explicit or default) of databases
created.
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_cluster_setup HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
X\-CouchDB\-Body\-Time: 0
X\-Couch\-Request\-ID: 5c058bdd37
Server: CouchDB/2.1.0\-7f17678 (Erlang OTP/17)
Date: Sun, 30 Jul 2017 06:33:18 GMT
Content\-Type: application/json
Content\-Length: 29
Cache\-Control: must\-revalidate

{\(dqstate\(dq:\(dqcluster_enabled\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B POST /_cluster_setup
Configure a node as a single (standalone) node, as part of a cluster,
or finalise a cluster.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.IP \(bu 2
\fI\%Content\-Type\fP – \fIapplication/json\fP
.UNINDENT
.TP
.B Request JSON Object
.INDENT 7.0
.IP \(bu 2
\fBaction\fP (\fIstring\fP) – .INDENT 2.0
.IP \(bu 2
\fBenable_single_node\fP: Configure the current node
as a single, standalone CouchDB server.
.IP \(bu 2
\fBenable_cluster\fP: Configure the local or remote
node as one node, preparing it to be joined to a
new CouchDB cluster.
.IP \(bu 2
\fBadd_node\fP: Add the specified remote node to
this cluster’s list of nodes, joining it to the
cluster.
.IP \(bu 2
\fBfinish_cluster\fP: Finalise the cluster by
creating the standard system databases.
.UNINDENT

.IP \(bu 2
\fBbind_address\fP (\fIstring\fP) – The IP address to which to bind the current
node. The special value \fB0.0.0.0\fP may be specified to bind to all
interfaces on the host. (enable_cluster and enable_single_node only)
.IP \(bu 2
\fBusername\fP (\fIstring\fP) – The username of the server\-level administrator to
create. (enable_cluster and enable_single_node only), or the remote
server’s administrator username (add_node)
.IP \(bu 2
\fBpassword\fP (\fIstring\fP) – The password for the server\-level administrator to
create. (enable_cluster and enable_single_node only), or the remote
server’s administrator username (add_node)
.IP \(bu 2
\fBport\fP (\fInumber\fP) – The TCP port to which to bind this node
(enable_cluster and enable_single_node only) or the TCP port to which
to bind a remote node (add_node only).
.IP \(bu 2
\fBnode_count\fP (\fInumber\fP) – The total number of nodes to be joined into
the cluster, including this one. Used to determine the value of the
cluster’s \fBn\fP, up to a maximum of 3. (enable_cluster only)
.IP \(bu 2
\fBremote_node\fP (\fIstring\fP) – The IP address of the remote node to setup as
part of this cluster’s list of nodes. (enable_cluster only)
.IP \(bu 2
\fBremote_current_user\fP (\fIstring\fP) – The username of the server\-level
administrator authorized on the remote node. (enable_cluster only)
.IP \(bu 2
\fBremote_current_password\fP (\fIstring\fP) – The password of the server\-level
administrator authorized on the remote node. (enable_cluster only)
.IP \(bu 2
\fBhost\fP (\fIstring\fP) – The remote node IP of the node to add to the cluster.
(add_node only)
.IP \(bu 2
\fBensure_dbs_exist\fP (\fIarray\fP) – List of system databases to ensure exist
on the node/cluster. Defaults to
\fB[\(dq_users\(dq,\(dq_replicator\(dq]\fP\&.
.UNINDENT
.UNINDENT
.sp
\fINo example request/response included here. For a worked example, please
see\fP \fI\%The Cluster Setup API\fP\&.
.UNINDENT
.SS \fB/_db_updates\fP
.sp
New in version 1.4.

.INDENT 0.0
.TP
.B GET /_db_updates
Returns a list of all database events in the CouchDB instance. The
existence of the \fB_global_changes\fP database is required to use this
endpoint.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBfeed\fP (\fIstring\fP) – .INDENT 2.0
.IP \(bu 2
\fBnormal\fP: Returns all historical DB changes, then
closes the connection. \fIDefault.\fP
.IP \(bu 2
\fBlongpoll\fP: Closes the connection after the first
event.
.IP \(bu 2
\fBcontinuous\fP: Send a line of JSON per event.
Keeps the socket open until \fBtimeout\fP\&.
.IP \(bu 2
\fBeventsource\fP: Like, \fBcontinuous\fP, but sends
the events in \fI\%EventSource\fP format.
.UNINDENT

.IP \(bu 2
\fBtimeout\fP (\fInumber\fP) – Number of \fImilliseconds\fP until CouchDB closes the
connection. Default is \fB60000\fP\&.
.IP \(bu 2
\fBheartbeat\fP (\fInumber\fP) – Period in \fImilliseconds\fP after which an empty
line is sent in the results. Only applicable for \fBlongpoll\fP,
\fBcontinuous\fP, and \fBeventsource\fP feeds. Overrides any timeout to
keep the feed alive indefinitely. Default is \fB60000\fP\&. May be \fBtrue\fP
to use default value.
.IP \(bu 2
\fBsince\fP (\fIstring\fP) – Return only updates since the specified sequence ID.
If the sequence ID is specified but does not exist, all changes are returned.
May be the string \fBnow\fP to begin showing only new updates.
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.IP \(bu 2
\fI\%Transfer\-Encoding\fP – \fBchunked\fP
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBresults\fP (\fIarray\fP) – An array of database events. For \fBlongpoll\fP and
\fBcontinuous\fP modes, the entire response is the contents of the
\fBresults\fP array.
.IP \(bu 2
\fBlast_seq\fP (\fIstring\fP) – The last sequence ID reported.
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.UNINDENT
.UNINDENT
.sp
The \fBresults\fP field of database updates:
.INDENT 7.0
.TP
.B JSON Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb_name\fP (\fIstring\fP) – Database name.
.IP \(bu 2
\fBtype\fP (\fIstring\fP) – A database event is one of \fBcreated\fP, \fBupdated\fP,
\fBdeleted\fP\&.
.IP \(bu 2
\fBseq\fP (\fIjson\fP) – Update sequence of the event.
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_db_updates HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Sat, 18 Mar 2017 19:01:35 GMT
Etag: \(dqC1KU98Y6H0LGM7EQQYL6VSL07\(dq
Server: CouchDB/2.0.0 (Erlang OTP/17)
Transfer\-Encoding: chunked
X\-Couch\-Request\-ID: ad87efc7ff
X\-CouchDB\-Body\-Time: 0

{
    \(dqresults\(dq:[
        {\(dqdb_name\(dq:\(dqmailbox\(dq,\(dqtype\(dq:\(dqcreated\(dq,\(dqseq\(dq:\(dq1\-g1AAAAFReJzLYWBg4MhgTmHgzcvPy09JdcjLz8gvLskBCjMlMiTJ____PyuDOZExFyjAnmJhkWaeaIquGIf2JAUgmWQPMiGRAZcaB5CaePxqEkBq6vGqyWMBkgwNQAqobD4h\(dq},
        {\(dqdb_name\(dq:\(dqmailbox\(dq,\(dqtype\(dq:\(dqdeleted\(dq,\(dqseq\(dq:\(dq2\-g1AAAAFReJzLYWBg4MhgTmHgzcvPy09JdcjLz8gvLskBCjMlMiTJ____PyuDOZEpFyjAnmJhkWaeaIquGIf2JAUgmWQPMiGRAZcaB5CaePxqEkBq6vGqyWMBkgwNQAqobD4hdQsg6vYTUncAou4\-IXUPIOpA7ssCAIFHa60\(dq},
    ],
    \(dqlast_seq\(dq: \(dq2\-g1AAAAFReJzLYWBg4MhgTmHgzcvPy09JdcjLz8gvLskBCjMlMiTJ____PyuDOZEpFyjAnmJhkWaeaIquGIf2JAUgmWQPMiGRAZcaB5CaePxqEkBq6vGqyWMBkgwNQAqobD4hdQsg6vYTUncAou4\-IXUPIOpA7ssCAIFHa60\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/_membership\fP
.sp
New in version 2.0.

.INDENT 0.0
.TP
.B GET /_membership
Displays the nodes that are part of the cluster as \fBcluster_nodes\fP\&. The
field \fBall_nodes\fP displays all nodes this node knows about, including the
ones that are part of the cluster. The endpoint is useful when setting up a
cluster, see \fI\%Node Management\fP
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_membership HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Sat, 11 Jul 2015 07:02:41 GMT
Server: CouchDB (Erlang/OTP)
Content\-Length: 142

{
    \(dqall_nodes\(dq: [
        \(dqnode1@127.0.0.1\(dq,
        \(dqnode2@127.0.0.1\(dq,
        \(dqnode3@127.0.0.1\(dq
    ],
    \(dqcluster_nodes\(dq: [
        \(dqnode1@127.0.0.1\(dq,
        \(dqnode2@127.0.0.1\(dq,
        \(dqnode3@127.0.0.1\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/_replicate\fP
.sp
Changed in version 3.3: Added \fI“bulk_get_attempts”\fP and \fI“bulk_get_docs”\fP  fields to the replication history response object.

.INDENT 0.0
.TP
.B POST /_replicate
Request, configure, or stop, a replication operation.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.IP \(bu 2
\fI\%Content\-Type\fP – \fIapplication/json\fP
.UNINDENT
.TP
.B Request JSON Object
.INDENT 7.0
.IP \(bu 2
\fBcancel\fP (\fIboolean\fP) – Cancels the replication
.IP \(bu 2
\fBcontinuous\fP (\fIboolean\fP) – Configure the replication to be continuous
.IP \(bu 2
\fBcreate_target\fP (\fIboolean\fP) – Creates the target database.
Required administrator’s privileges on target server.
.IP \(bu 2
\fBcreate_target_params\fP (\fIobject\fP) – An object that contains parameters
to be used when creating the target database. Can include the
standard \fBq\fP and \fBn\fP parameters.
.IP \(bu 2
\fBwinning_revs_only\fP (\fIboolean\fP) – Replicate winning revisions only.
.IP \(bu 2
\fBdoc_ids\fP (\fIarray\fP) – Array of document IDs to be synchronized.
\fBdoc_ids\fP, \fBfilter\fP, and \fBselector\fP are mutually exclusive.
.IP \(bu 2
\fBfilter\fP (\fIstring\fP) – The name of a \fI\%filter function\fP\&.
\fBdoc_ids\fP, \fBfilter\fP, and \fBselector\fP are mutually exclusive.
.IP \(bu 2
\fBselector\fP (\fIjson\fP) – A \fI\%selector\fP to filter
documents for synchronization. Has the same behavior as the
\fI\%selector objects\fP in replication documents.
\fBdoc_ids\fP, \fBfilter\fP, and \fBselector\fP are mutually exclusive.
.IP \(bu 2
\fBsource_proxy\fP (\fIstring\fP) – Address of a proxy server through which
replication from the source should occur (protocol can be “http” or
“socks5”)
.IP \(bu 2
\fBtarget_proxy\fP (\fIstring\fP) – Address of a proxy server through which
replication to the target should occur (protocol can be “http” or
“socks5”)
.IP \(bu 2
\fBsource\fP (\fIstring/object\fP) – Fully qualified source database URL or an
object which contains the full URL of the source database with additional
parameters like headers. Eg: ‘\fI\%http://example.com/source_db_name\fP’ or
{“url”:”url in here”, “headers”: {“header1”:”value1”, …}} . For
backwards compatibility, CouchDB 3.x will auto\-convert bare database
names by prepending the address and port CouchDB is listening on, to
form a complete URL. This behaviour is deprecated in 3.x and will be
removed in CouchDB 4.0.
.IP \(bu 2
\fBtarget\fP (\fIstring/object\fP) – Fully qualified target database URL or an
object which contains the full URL of the target database with additional
parameters like headers. Eg: ‘\fI\%http://example.com/target_db_name\fP’ or
{“url”:”url in here”, “headers”: {“header1”:”value1”, …}} . For
backwards compatibility, CouchDB 3.x will auto\-convert bare database
names by prepending the address and port CouchDB is listening on, to
form a complete URL. This behaviour is deprecated in 3.x and will be
removed in CouchDB 4.0.
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBhistory\fP (\fIarray\fP) – Replication history (see below)
.IP \(bu 2
\fBok\fP (\fIboolean\fP) – Replication status
.IP \(bu 2
\fBreplication_id_version\fP (\fInumber\fP) – Replication protocol version
.IP \(bu 2
\fBsession_id\fP (\fIstring\fP) – Unique session ID
.IP \(bu 2
\fBsource_last_seq\fP (\fInumber\fP) – Last sequence number read from source
database
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Replication request successfully completed
.IP \(bu 2
\fI\%202 Accepted\fP – Continuous replication request has been accepted
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid JSON data
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.IP \(bu 2
\fI\%404 Not Found\fP – Either the source or target DB is not found or attempt to
cancel unknown replication task
.IP \(bu 2
\fI\%500 Internal Server Error\fP – JSON specification was invalid
.UNINDENT
.UNINDENT
.sp
The specification of the replication request is controlled through the
JSON content of the request. The JSON should be an object with the
fields defining the source, target and other options.
.sp
The \fIReplication history\fP is an array of objects with following structure:
.INDENT 7.0
.TP
.B JSON Parameters
.INDENT 7.0
.IP \(bu 2
\fBdoc_write_failures\fP (\fInumber\fP) – Number of document write failures
.IP \(bu 2
\fBdocs_read\fP (\fInumber\fP) – Number of documents read
.IP \(bu 2
\fBdocs_written\fP (\fInumber\fP) – Number of documents written to target
.IP \(bu 2
\fBbulk_get_attempts\fP (\fInumber\fP) – The total count of attempted doc revisions
fetched with \fB_bulk_get\fP\&.
.IP \(bu 2
\fBbulk_get_docs\fP (\fInumber\fP) – The total count of successful docs fetched with
\fB_bulk_get\fP\&.
.IP \(bu 2
\fBend_last_seq\fP (\fInumber\fP) – Last sequence number in changes stream
.IP \(bu 2
\fBend_time\fP (\fIstring\fP) – Date/Time replication operation completed in
\fI\%RFC 2822\fP format
.IP \(bu 2
\fBmissing_checked\fP (\fInumber\fP) – Number of missing documents checked
.IP \(bu 2
\fBmissing_found\fP (\fInumber\fP) – Number of missing documents found
.IP \(bu 2
\fBrecorded_seq\fP (\fInumber\fP) – Last recorded sequence number
.IP \(bu 2
\fBsession_id\fP (\fIstring\fP) – Session ID for this replication operation
.IP \(bu 2
\fBstart_last_seq\fP (\fInumber\fP) – First sequence number in changes stream
.IP \(bu 2
\fBstart_time\fP (\fIstring\fP) – Date/Time replication operation started in
\fI\%RFC 2822\fP format
.UNINDENT
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
As of CouchDB 2.0.0, fully qualified URLs are required for both the
replication \fBsource\fP and \fBtarget\fP parameters.
.sp
\fBRequest\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST /_replicate HTTP/1.1
Accept: application/json
Content\-Length: 80
Content\-Type: application/json
Host: localhost:5984

{
    \(dqsource\(dq: \(dqhttp://127.0.0.1:5984/db_a\(dq,
    \(dqtarget\(dq: \(dqhttp://127.0.0.1:5984/db_b\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 692
Content\-Type: application/json
Date: Sun, 11 Aug 2013 20:38:50 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqhistory\(dq: [
        {
            \(dqdoc_write_failures\(dq: 0,
            \(dqdocs_read\(dq: 10,
            \(dqbulk_get_attempts\(dq: 10,
            \(dqbulk_get_docs\(dq: 10,
            \(dqdocs_written\(dq: 10,
            \(dqend_last_seq\(dq: 28,
            \(dqend_time\(dq: \(dqSun, 11 Aug 2013 20:38:50 GMT\(dq,
            \(dqmissing_checked\(dq: 10,
            \(dqmissing_found\(dq: 10,
            \(dqrecorded_seq\(dq: 28,
            \(dqsession_id\(dq: \(dq142a35854a08e205c47174d91b1f9628\(dq,
            \(dqstart_last_seq\(dq: 1,
            \(dqstart_time\(dq: \(dqSun, 11 Aug 2013 20:38:50 GMT\(dq
        },
        {
            \(dqdoc_write_failures\(dq: 0,
            \(dqdocs_read\(dq: 1,
            \(dqbulk_get_attempts\(dq: 1,
            \(dqbulk_get_docs\(dq: 1,
            \(dqdocs_written\(dq: 1,
            \(dqend_last_seq\(dq: 1,
            \(dqend_time\(dq: \(dqSat, 10 Aug 2013 15:41:54 GMT\(dq,
            \(dqmissing_checked\(dq: 1,
            \(dqmissing_found\(dq: 1,
            \(dqrecorded_seq\(dq: 1,
            \(dqsession_id\(dq: \(dq6314f35c51de3ac408af79d6ee0c1a09\(dq,
            \(dqstart_last_seq\(dq: 0,
            \(dqstart_time\(dq: \(dqSat, 10 Aug 2013 15:41:54 GMT\(dq
        }
    ],
    \(dqok\(dq: true,
    \(dqreplication_id_version\(dq: 3,
    \(dqsession_id\(dq: \(dq142a35854a08e205c47174d91b1f9628\(dq,
    \(dqsource_last_seq\(dq: 28
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Replication Operation
.sp
The aim of the replication is that at the end of the process, all active
documents on the source database are also in the destination database and all
documents that were deleted in the source databases are also deleted (if they
exist) on the destination database.
.sp
Replication can be described as either push or pull replication:
.INDENT 0.0
.IP \(bu 2
\fIPull replication\fP is where the \fBsource\fP is the remote CouchDB instance,
and the \fBtarget\fP is the local database.
.sp
Pull replication is the most useful solution to use if your source database
has a permanent IP address, and your destination (local) database may have a
dynamically assigned IP address (for example, through DHCP). This is
particularly important if you are replicating to a mobile or other device
from a central server.
.IP \(bu 2
\fIPush replication\fP is where the \fBsource\fP is a local database, and
\fBtarget\fP is a remote database.
.UNINDENT
.SS Specifying the Source and Target Database
.sp
You must use the URL specification of the CouchDB database if you want to
perform replication in either of the following two situations:
.INDENT 0.0
.IP \(bu 2
Replication with a remote database (i.e. another instance of CouchDB on the
same host, or a different host)
.IP \(bu 2
Replication with a database that requires authentication
.UNINDENT
.sp
For example, to request replication between a database local to the CouchDB
instance to which you send the request, and a remote database you might use the
following request:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST http://couchdb:5984/_replicate HTTP/1.1
Content\-Type: application/json
Accept: application/json

{
    \(dqsource\(dq : \(dqrecipes\(dq,
    \(dqtarget\(dq : \(dqhttp://coucdb\-remote:5984/recipes\(dq,
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
In all cases, the requested databases in the \fBsource\fP and \fBtarget\fP
specification must exist. If they do not, an error will be returned within the
JSON object:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqerror\(dq : \(dqdb_not_found\(dq
    \(dqreason\(dq : \(dqcould not open http://couchdb\-remote:5984/ol1ka/\(dq,
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You can create the target database (providing your user credentials allow it)
by adding the \fBcreate_target\fP field to the request object:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST http://couchdb:5984/_replicate HTTP/1.1
Content\-Type: application/json
Accept: application/json

{
    \(dqcreate_target\(dq : true
    \(dqsource\(dq : \(dqrecipes\(dq,
    \(dqtarget\(dq : \(dqhttp://couchdb\-remote:5984/recipes\(dq,
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The \fBcreate_target\fP field is not destructive. If the database already
exists, the replication proceeds as normal.
.SS Single Replication
.sp
You can request replication of a database so that the two databases can be
synchronized. By default, the replication process occurs one time and
synchronizes the two databases together. For example, you can request a single
synchronization between two databases by supplying the \fBsource\fP and
\fBtarget\fP fields within the request JSON content.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST http://couchdb:5984/_replicate HTTP/1.1
Accept: application/json
Content\-Type: application/json

{
    \(dqsource\(dq : \(dqrecipes\(dq,
    \(dqtarget\(dq : \(dqrecipes\-snapshot\(dq,
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
In the above example, the databases \fBrecipes\fP and \fBrecipes\-snapshot\fP will
be synchronized. These databases are local to the CouchDB instance where the
request was made. The response will be a JSON structure containing the success
(or failure) of the synchronization process, and statistics about the process:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqok\(dq : true,
    \(dqhistory\(dq : [
        {
            \(dqdocs_read\(dq : 1000,
            \(dqbulk_get_attempts\(dq: 1000,
            \(dqbulk_get_docs\(dq: 1000,
            \(dqsession_id\(dq : \(dq52c2370f5027043d286daca4de247db0\(dq,
            \(dqrecorded_seq\(dq : 1000,
            \(dqend_last_seq\(dq : 1000,
            \(dqdoc_write_failures\(dq : 0,
            \(dqstart_time\(dq : \(dqThu, 28 Oct 2010 10:24:13 GMT\(dq,
            \(dqstart_last_seq\(dq : 0,
            \(dqend_time\(dq : \(dqThu, 28 Oct 2010 10:24:14 GMT\(dq,
            \(dqmissing_checked\(dq : 0,
            \(dqdocs_written\(dq : 1000,
            \(dqmissing_found\(dq : 1000
        }
    ],
    \(dqsession_id\(dq : \(dq52c2370f5027043d286daca4de247db0\(dq,
    \(dqsource_last_seq\(dq : 1000
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Continuous Replication
.sp
Synchronization of a database with the previously noted methods happens only
once, at the time the replicate request is made. To have the target database
permanently replicated from the source, you must set the \fBcontinuous\fP field
of the JSON object within the request to true.
.sp
With continuous replication changes in the source database are replicated to
the target database in perpetuity until you specifically request that
replication ceases.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST http://couchdb:5984/_replicate HTTP/1.1
Accept: application/json
Content\-Type: application/json

{
    \(dqcontinuous\(dq : true
    \(dqsource\(dq : \(dqrecipes\(dq,
    \(dqtarget\(dq : \(dqhttp://couchdb\-remote:5984/recipes\(dq,
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Changes will be replicated between the two databases as long as a network
connection is available between the two instances.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Two keep two databases synchronized with each other, you need to set
replication in both directions; that is, you must replicate from \fBsource\fP
to \fBtarget\fP, and separately from \fBtarget\fP to \fBsource\fP\&.
.UNINDENT
.UNINDENT
.SS Canceling Continuous Replication
.sp
You can cancel continuous replication by adding the \fBcancel\fP field to the
JSON request object and setting the value to true. Note that the structure of
the request must be identical to the original for the cancellation request to
be honoured. For example, if you requested continuous replication, the
cancellation request must also contain the \fBcontinuous\fP field.
.sp
For example, the replication request:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST http://couchdb:5984/_replicate HTTP/1.1
Content\-Type: application/json
Accept: application/json

{
    \(dqsource\(dq : \(dqrecipes\(dq,
    \(dqtarget\(dq : \(dqhttp://couchdb\-remote:5984/recipes\(dq,
    \(dqcreate_target\(dq : true,
    \(dqcontinuous\(dq : true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Must be canceled using the request:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST http://couchdb:5984/_replicate HTTP/1.1
Accept: application/json
Content\-Type: application/json

{
    \(dqcancel\(dq : true,
    \(dqcontinuous\(dq : true
    \(dqcreate_target\(dq : true,
    \(dqsource\(dq : \(dqrecipes\(dq,
    \(dqtarget\(dq : \(dqhttp://couchdb\-remote:5984/recipes\(dq,
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Requesting cancellation of a replication that does not exist results in a 404
error.
.SS \fB/_scheduler/jobs\fP
.INDENT 0.0
.TP
.B GET /_scheduler/jobs
List of replication jobs. Includes replications created via
\fI\%/_replicate\fP endpoint as well as those created from
replication documents. Does not include replications which have completed
or have failed to start because replication documents were malformed. Each
job description will include source and target information, replication id,
a history of recent event, and a few other things.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBlimit\fP (\fInumber\fP) – How many results to return
.IP \(bu 2
\fBskip\fP (\fInumber\fP) – How many result to skip starting at the beginning,
ordered by replication ID
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBoffset\fP (\fInumber\fP) – How many results were skipped
.IP \(bu 2
\fBtotal_rows\fP (\fInumber\fP) – Total number of replication jobs
.IP \(bu 2
\fBid\fP (\fIstring\fP) – Replication ID.
.IP \(bu 2
\fBdatabase\fP (\fIstring\fP) – Replication document database
.IP \(bu 2
\fBdoc_id\fP (\fIstring\fP) – Replication document ID
.IP \(bu 2
\fBhistory\fP (\fIlist\fP) – Timestamped history of events as a list of objects
.IP \(bu 2
\fBpid\fP (\fIstring\fP) – Replication process ID
.IP \(bu 2
\fBnode\fP (\fIstring\fP) – Cluster node where the job is running
.IP \(bu 2
\fBsource\fP (\fIstring\fP) – Replication source
.IP \(bu 2
\fBtarget\fP (\fIstring\fP) – Replication target
.IP \(bu 2
\fBstart_time\fP (\fIstring\fP) – Timestamp of when the replication was started
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_scheduler/jobs HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 1690
Content\-Type: application/json
Date: Sat, 29 Apr 2017 05:05:16 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqjobs\(dq: [
        {
            \(dqdatabase\(dq: \(dq_replicator\(dq,
            \(dqdoc_id\(dq: \(dqcdyno\-0000001\-0000003\(dq,
            \(dqhistory\(dq: [
                {
                    \(dqtimestamp\(dq: \(dq2017\-04\-29T05:01:37Z\(dq,
                    \(dqtype\(dq: \(dqstarted\(dq
                },
                {
                    \(dqtimestamp\(dq: \(dq2017\-04\-29T05:01:37Z\(dq,
                    \(dqtype\(dq: \(dqadded\(dq
                }
            ],
            \(dqid\(dq: \(dq8f5b1bd0be6f9166ccfd36fc8be8fc22+continuous\(dq,
            \(dqinfo\(dq: {
                \(dqchanges_pending\(dq: 0,
                \(dqcheckpointed_source_seq\(dq: \(dq113\-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV0MDQy1zMAQsMckEQiQ1L9____szKYE01ygQLsZsYGqcamiZjKcRqRxwIkGRqA1H\-oSbZgk1KMLCzTDE0wdWUBAF6HJIQ\(dq,
                \(dqdoc_write_failures\(dq: 0,
                \(dqdocs_read\(dq: 113,
                \(dqdocs_written\(dq: 113,
                \(dqbulk_get_attempts\(dq: 113,
                \(dqbulk_get_docs\(dq: 113,
                \(dqmissing_revisions_found\(dq: 113,
                \(dqrevisions_checked\(dq: 113,
                \(dqsource_seq\(dq: \(dq113\-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV0MDQy1zMAQsMckEQiQ1L9____szKYE01ygQLsZsYGqcamiZjKcRqRxwIkGRqA1H\-oSbZgk1KMLCzTDE0wdWUBAF6HJIQ\(dq,
                \(dqthrough_seq\(dq: \(dq113\-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV0MDQy1zMAQsMckEQiQ1L9____szKYE01ygQLsZsYGqcamiZjKcRqRxwIkGRqA1H\-oSbZgk1KMLCzTDE0wdWUBAF6HJIQ\(dq
            },
            \(dqnode\(dq: \(dqnode1@127.0.0.1\(dq,
            \(dqpid\(dq: \(dq<0.1850.0>\(dq,
            \(dqsource\(dq: \(dqhttp://myserver.com/foo\(dq,
            \(dqstart_time\(dq: \(dq2017\-04\-29T05:01:37Z\(dq,
            \(dqtarget\(dq: \(dqhttp://adm:*****@localhost:15984/cdyno\-0000003/\(dq,
            \(dquser\(dq: null
        },
        {
            \(dqdatabase\(dq: \(dq_replicator\(dq,
            \(dqdoc_id\(dq: \(dqcdyno\-0000001\-0000002\(dq,
            \(dqhistory\(dq: [
                {
                    \(dqtimestamp\(dq: \(dq2017\-04\-29T05:01:37Z\(dq,
                    \(dqtype\(dq: \(dqstarted\(dq
                },
                {
                    \(dqtimestamp\(dq: \(dq2017\-04\-29T05:01:37Z\(dq,
                    \(dqtype\(dq: \(dqadded\(dq
                }
            ],
            \(dqid\(dq: \(dqe327d79214831ca4c11550b4a453c9ba+continuous\(dq,
            \(dqinfo\(dq: {
                \(dqchanges_pending\(dq: null,
                \(dqcheckpointed_source_seq\(dq: 0,
                \(dqdoc_write_failures\(dq: 0,
                \(dqdocs_read\(dq: 12,
                \(dqdocs_written\(dq: 12,
                \(dqbulk_get_attempts\(dq: 12,
                \(dqbulk_get_docs\(dq: 12,
                \(dqmissing_revisions_found\(dq: 12,
                \(dqrevisions_checked\(dq: 12,
                \(dqsource_seq\(dq: \(dq12\-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV0MDQy1zMAQsMckEQiQ1L9____szKYE1lzgQLsBsZm5pZJJpjKcRqRxwIkGRqA1H\-oSexgk4yMkhITjS0wdWUBADfEJBg\(dq,
                \(dqthrough_seq\(dq: \(dq12\-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV0MDQy1zMAQsMckEQiQ1L9____szKYE1lzgQLsBsZm5pZJJpjKcRqRxwIkGRqA1H\-oSexgk4yMkhITjS0wdWUBADfEJBg\(dq
            },
            \(dqnode\(dq: \(dqnode2@127.0.0.1\(dq,
            \(dqpid\(dq: \(dq<0.1757.0>\(dq,
            \(dqsource\(dq: \(dqhttp://myserver.com/foo\(dq,
            \(dqstart_time\(dq: \(dq2017\-04\-29T05:01:37Z\(dq,
            \(dqtarget\(dq: \(dqhttp://adm:*****@localhost:15984/cdyno\-0000002/\(dq,
            \(dquser\(dq: null
        }
    ],
    \(dqoffset\(dq: 0,
    \(dqtotal_rows\(dq: 2
 }
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/_scheduler/docs\fP
.sp
Changed in version 2.1.0: Use this endpoint to monitor the state of
document\-based replications. Previously needed to poll both
documents and \fB_active_tasks\fP to get a complete state
summary

.sp
Changed in version 3.0.0: In error states the \fI“info”\fP field switched
from being a string to being an object

.sp
Changed in version 3.3: Added \fI“bulk_get_attempts”\fP and \fI“bulk_get_docs”\fP the
\fI“info”\fP object.

.INDENT 0.0
.TP
.B GET /_scheduler/docs
List of replication document states. Includes information about all the
documents, even in \fBcompleted\fP and \fBfailed\fP states. For each document
it returns the document ID, the database, the replication ID, source and
target, and other information.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBlimit\fP (\fInumber\fP) – How many results to return
.IP \(bu 2
\fBskip\fP (\fInumber\fP) – How many result to skip starting at the beginning, if
ordered by document ID
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBoffset\fP (\fInumber\fP) – How many results were skipped
.IP \(bu 2
\fBtotal_rows\fP (\fInumber\fP) – Total number of replication documents.
.IP \(bu 2
\fBid\fP (\fIstring\fP) – Replication ID, or \fBnull\fP if state is \fBcompleted\fP or
\fBfailed\fP
.IP \(bu 2
\fBstate\fP (\fIstring\fP) – One of following states (see \fI\%Replication states\fP
for descriptions): \fBinitializing\fP, \fBrunning\fP,
\fBcompleted\fP, \fBpending\fP, \fBcrashing\fP, \fBerror\fP,
\fBfailed\fP
.IP \(bu 2
\fBdatabase\fP (\fIstring\fP) – Database where replication document came from
.IP \(bu 2
\fBdoc_id\fP (\fIstring\fP) – Replication document ID
.IP \(bu 2
\fBnode\fP (\fIstring\fP) – Cluster node where the job is running
.IP \(bu 2
\fBsource\fP (\fIstring\fP) – Replication source
.IP \(bu 2
\fBtarget\fP (\fIstring\fP) – Replication target
.IP \(bu 2
\fBstart_time\fP (\fIstring\fP) – Timestamp of when the replication was started
.IP \(bu 2
\fBlast_updated\fP (\fIstring\fP) – Timestamp of last state update
.IP \(bu 2
\fBinfo\fP (\fIobject\fP) – Will contain additional information about the
state. For errors, this will be an object with
an \fB\(dqerror\(dq\fP field and string value. For
success states, see below.
.IP \(bu 2
\fBerror_count\fP (\fInumber\fP) – Consecutive errors count. Indicates how many
times in a row this replication has crashed.
Replication will be retried with an exponential
backoff based on this number. As soon as the
replication succeeds this count is reset to 0.
To can be used to get an idea why a particular
replication is not making progress.
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.UNINDENT
.UNINDENT
.sp
The \fBinfo\fP field of a scheduler doc:
.INDENT 7.0
.TP
.B JSON Parameters
.INDENT 7.0
.IP \(bu 2
\fBrevisions_checked\fP (\fInumber\fP) – The count of revisions which have been
checked since this replication began.
.IP \(bu 2
\fBmissing_revisions_found\fP (\fInumber\fP) – The count of revisions which were
found on the source, but missing from the target.
.IP \(bu 2
\fBdocs_read\fP (\fInumber\fP) – The count of docs which have been read from the
source.
.IP \(bu 2
\fBdocs_written\fP (\fInumber\fP) – The count of docs which have been written to the
target.
.IP \(bu 2
\fBbulk_get_attempts\fP (\fInumber\fP) – The total count of attempted doc revisions
fetched with \fB_bulk_get\fP\&.
.IP \(bu 2
\fBbulk_get_docs\fP (\fInumber\fP) – The total count of successful docs fetched with
\fB_bulk_get\fP\&.
.IP \(bu 2
\fBchanges_pending\fP (\fInumber\fP) – The count of changes not yet replicated.
.IP \(bu 2
\fBdoc_write_failures\fP (\fInumber\fP) – The count of docs which failed to be
written to the target.
.IP \(bu 2
\fBcheckpointed_source_seq\fP (\fIobject\fP) – The source sequence id which was last
successfully replicated.
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_scheduler/docs HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Content\-Type: application/json
Date: Sat, 29 Apr 2017 05:10:08 GMT
Server: Server: CouchDB (Erlang/OTP)
Transfer\-Encoding: chunked

{
    \(dqdocs\(dq: [
        {
            \(dqdatabase\(dq: \(dq_replicator\(dq,
            \(dqdoc_id\(dq: \(dqcdyno\-0000001\-0000002\(dq,
            \(dqerror_count\(dq: 0,
            \(dqid\(dq: \(dqe327d79214831ca4c11550b4a453c9ba+continuous\(dq,
            \(dqinfo\(dq: {
                \(dqchanges_pending\(dq: 15,
                \(dqcheckpointed_source_seq\(dq: \(dq60\-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV0MDQy1zMAQsMckEQiQ1L9____szKYEyVygQLsBsZm5pZJJpjKcRqRxwIkGRqA1H\-oSSpgk4yMkhITjS0wdWUBAENCJEg\(dq,
                \(dqdoc_write_failures\(dq: 0,
                \(dqdocs_read\(dq: 67,
                \(dqbulk_get_attempts\(dq: 67,
                \(dqbulk_get_docs\(dq: 67,
                \(dqdocs_written\(dq: 67,
                \(dqmissing_revisions_found\(dq: 67,
                \(dqrevisions_checked\(dq: 67,
                \(dqsource_seq\(dq: \(dq67\-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV0MDQy1zMAQsMckEQiQ1L9____szKYE2VygQLsBsZm5pZJJpjKcRqRxwIkGRqA1H\-oSepgk4yMkhITjS0wdWUBAEVKJE8\(dq,
                \(dqthrough_seq\(dq: \(dq67\-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV0MDQy1zMAQsMckEQiQ1L9____szKYE2VygQLsBsZm5pZJJpjKcRqRxwIkGRqA1H\-oSepgk4yMkhITjS0wdWUBAEVKJE8\(dq
            },
            \(dqlast_updated\(dq: \(dq2017\-04\-29T05:01:37Z\(dq,
            \(dqnode\(dq: \(dqnode2@127.0.0.1\(dq,
            \(dqsource_proxy\(dq: null,
            \(dqtarget_proxy\(dq: null,
            \(dqsource\(dq: \(dqhttp://myserver.com/foo\(dq,
            \(dqstart_time\(dq: \(dq2017\-04\-29T05:01:37Z\(dq,
            \(dqstate\(dq: \(dqrunning\(dq,
            \(dqtarget\(dq: \(dqhttp://adm:*****@localhost:15984/cdyno\-0000002/\(dq
        },
        {
            \(dqdatabase\(dq: \(dq_replicator\(dq,
            \(dqdoc_id\(dq: \(dqcdyno\-0000001\-0000003\(dq,
            \(dqerror_count\(dq: 0,
            \(dqid\(dq: \(dq8f5b1bd0be6f9166ccfd36fc8be8fc22+continuous\(dq,
            \(dqinfo\(dq: {
                \(dqchanges_pending\(dq: null,
                \(dqcheckpointed_source_seq\(dq: 0,
                \(dqdoc_write_failures\(dq: 0,
                \(dqbulk_get_attempts\(dq: 12,
                \(dqbulk_get_docs\(dq: 12,
                \(dqdocs_read\(dq: 12,
                \(dqdocs_written\(dq: 12,
                \(dqmissing_revisions_found\(dq: 12,
                \(dqrevisions_checked\(dq: 12,
                \(dqsource_seq\(dq: \(dq12\-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV0MDQy1zMAQsMckEQiQ1L9____szKYE1lzgQLsBsZm5pZJJpjKcRqRxwIkGRqA1H\-oSexgk4yMkhITjS0wdWUBADfEJBg\(dq,
                \(dqthrough_seq\(dq: \(dq12\-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV0MDQy1zMAQsMckEQiQ1L9____szKYE1lzgQLsBsZm5pZJJpjKcRqRxwIkGRqA1H\-oSexgk4yMkhITjS0wdWUBADfEJBg\(dq
            },
            \(dqlast_updated\(dq: \(dq2017\-04\-29T05:01:37Z\(dq,
            \(dqnode\(dq: \(dqnode1@127.0.0.1\(dq,
            \(dqsource_proxy\(dq: null,
            \(dqtarget_proxy\(dq: null,
            \(dqsource\(dq: \(dqhttp://myserver.com/foo\(dq,
            \(dqstart_time\(dq: \(dq2017\-04\-29T05:01:37Z\(dq,
            \(dqstate\(dq: \(dqrunning\(dq,
            \(dqtarget\(dq: \(dqhttp://adm:*****@localhost:15984/cdyno\-0000003/\(dq
        }
    ],
    \(dqoffset\(dq: 0,
    \(dqtotal_rows\(dq: 2
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B GET /_scheduler/docs/{replicator_db}
Get information about replication documents from a replicator database.
The default replicator database is \fB_replicator\fP but other replicator
databases can exist if their name ends with the suffix \fB/_replicator\fP\&.
.sp
\fBNOTE:\fP
.INDENT 7.0
.INDENT 3.5
As a convenience slashes (\fB/\fP) in replicator db names do not
have to be escaped. So \fB/_scheduler/docs/other/_replicator\fP is valid
and equivalent to \fB/_scheduler/docs/other%2f_replicator\fP
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBlimit\fP (\fInumber\fP) – How many results to return
.IP \(bu 2
\fBskip\fP (\fInumber\fP) – How many result to skip starting at the beginning, if
ordered by document ID
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBoffset\fP (\fInumber\fP) – How many results were skipped
.IP \(bu 2
\fBtotal_rows\fP (\fInumber\fP) – Total number of replication documents.
.IP \(bu 2
\fBid\fP (\fIstring\fP) – Replication ID, or \fBnull\fP if state is \fBcompleted\fP or
\fBfailed\fP
.IP \(bu 2
\fBstate\fP (\fIstring\fP) – One of following states (see \fI\%Replication states\fP
for descriptions): \fBinitializing\fP, \fBrunning\fP,
\fBcompleted\fP, \fBpending\fP, \fBcrashing\fP, \fBerror\fP,
\fBfailed\fP
.IP \(bu 2
\fBdatabase\fP (\fIstring\fP) – Database where replication document came from
.IP \(bu 2
\fBdoc_id\fP (\fIstring\fP) – Replication document ID
.IP \(bu 2
\fBnode\fP (\fIstring\fP) – Cluster node where the job is running
.IP \(bu 2
\fBsource\fP (\fIstring\fP) – Replication source
.IP \(bu 2
\fBtarget\fP (\fIstring\fP) – Replication target
.IP \(bu 2
\fBstart_time\fP (\fIstring\fP) – Timestamp of when the replication was started
.IP \(bu 2
\fBlast_update\fP (\fIstring\fP) – Timestamp of last state update
.IP \(bu 2
\fBinfo\fP (\fIobject\fP) – Will contain additional information about the
state. For errors, this will be an object with
an \fB\(dqerror\(dq\fP field and string value. For
success states, see below.
.IP \(bu 2
\fBerror_count\fP (\fInumber\fP) – Consecutive errors count. Indicates how many
times in a row this replication has crashed.
Replication will be retried with an exponential
backoff based on this number. As soon as the
replication succeeds this count is reset to 0.
To can be used to get an idea why a particular
replication is not making progress.
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.UNINDENT
.UNINDENT
.sp
The \fBinfo\fP field of a scheduler doc:
.INDENT 7.0
.TP
.B JSON Parameters
.INDENT 7.0
.IP \(bu 2
\fBrevisions_checked\fP (\fInumber\fP) – The count of revisions which have been
checked since this replication began.
.IP \(bu 2
\fBmissing_revisions_found\fP (\fInumber\fP) – The count of revisions which were
found on the source, but missing from the target.
.IP \(bu 2
\fBdocs_read\fP (\fInumber\fP) – The count of docs which have been read from the
source.
.IP \(bu 2
\fBdocs_written\fP (\fInumber\fP) – The count of docs which have been written to the
target.
.IP \(bu 2
\fBbulk_get_attempts\fP (\fInumber\fP) – The total count of attempted doc revisions
fetched with \fB_bulk_get\fP\&.
.IP \(bu 2
\fBbulk_get_docs\fP (\fInumber\fP) – The total count of successful docs fetched with
\fB_bulk_get\fP\&.
.IP \(bu 2
\fBchanges_pending\fP (\fInumber\fP) – The count of changes not yet replicated.
.IP \(bu 2
\fBdoc_write_failures\fP (\fInumber\fP) – The count of docs which failed to be
written to the target.
.IP \(bu 2
\fBcheckpointed_source_seq\fP (\fIobject\fP) – The source sequence id which was last
successfully replicated.
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_scheduler/docs/other/_replicator HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Content\-Type: application/json
Date: Sat, 29 Apr 2017 05:10:08 GMT
Server: Server: CouchDB (Erlang/OTP)
Transfer\-Encoding: chunked

{
    \(dqdocs\(dq: [
        {
            \(dqdatabase\(dq: \(dqother/_replicator\(dq,
            \(dqdoc_id\(dq: \(dqcdyno\-0000001\-0000002\(dq,
            \(dqerror_count\(dq: 0,
            \(dqid\(dq: \(dqe327d79214831ca4c11550b4a453c9ba+continuous\(dq,
            \(dqinfo\(dq: {
                \(dqchanges_pending\(dq: 0,
                \(dqcheckpointed_source_seq\(dq: \(dq60\-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV0MDQy1zMAQsMckEQiQ1L9____szKYEyVygQLsBsZm5pZJJpjKcRqRxwIkGRqA1H\-oSSpgk4yMkhITjS0wdWUBAENCJEg\(dq,
                \(dqdoc_write_failures\(dq: 0,
                \(dqdocs_read\(dq: 67,
                \(dqbulk_get_attempts\(dq: 67,
                \(dqbulk_get_docs\(dq: 67,
                \(dqdocs_written\(dq: 67,
                \(dqmissing_revisions_found\(dq: 67,
                \(dqrevisions_checked\(dq: 67,
                \(dqsource_seq\(dq: \(dq67\-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV0MDQy1zMAQsMckEQiQ1L9____szKYE2VygQLsBsZm5pZJJpjKcRqRxwIkGRqA1H\-oSepgk4yMkhITjS0wdWUBAEVKJE8\(dq,
                \(dqthrough_seq\(dq: \(dq67\-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV0MDQy1zMAQsMckEQiQ1L9____szKYE2VygQLsBsZm5pZJJpjKcRqRxwIkGRqA1H\-oSepgk4yMkhITjS0wdWUBAEVKJE8\(dq
            },
            \(dqlast_updated\(dq: \(dq2017\-04\-29T05:01:37Z\(dq,
            \(dqnode\(dq: \(dqnode2@127.0.0.1\(dq,
            \(dqsource_proxy\(dq: null,
            \(dqtarget_proxy\(dq: null,
            \(dqsource\(dq: \(dqhttp://myserver.com/foo\(dq,
            \(dqstart_time\(dq: \(dq2017\-04\-29T05:01:37Z\(dq,
            \(dqstate\(dq: \(dqrunning\(dq,
            \(dqtarget\(dq: \(dqhttp://adm:*****@localhost:15984/cdyno\-0000002/\(dq
        }
    ],
    \(dqoffset\(dq: 0,
    \(dqtotal_rows\(dq: 1
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B GET /_scheduler/docs/{replicator_db}/{docid}
.sp
\fBNOTE:\fP
.INDENT 7.0
.INDENT 3.5
As a convenience slashes (\fB/\fP) in replicator db names do not
have to be escaped. So \fB/_scheduler/docs/other/_replicator\fP is valid
and equivalent to \fB/_scheduler/docs/other%2f_replicator\fP
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBid\fP (\fIstring\fP) – Replication ID, or \fBnull\fP if state is \fBcompleted\fP or
\fBfailed\fP
.IP \(bu 2
\fBstate\fP (\fIstring\fP) – One of following states (see \fI\%Replication states\fP
for descriptions): \fBinitializing\fP, \fBrunning\fP,
\fBcompleted\fP, \fBpending\fP, \fBcrashing\fP, \fBerror\fP,
\fBfailed\fP
.IP \(bu 2
\fBdatabase\fP (\fIstring\fP) – Database where replication document came from
.IP \(bu 2
\fBdoc_id\fP (\fIstring\fP) – Replication document ID
.IP \(bu 2
\fBnode\fP (\fIstring\fP) – Cluster node where the job is running
.IP \(bu 2
\fBsource\fP (\fIstring\fP) – Replication source
.IP \(bu 2
\fBtarget\fP (\fIstring\fP) – Replication target
.IP \(bu 2
\fBstart_time\fP (\fIstring\fP) – Timestamp of when the replication was started
.IP \(bu 2
\fBlast_update\fP (\fIstring\fP) – Timestamp of last state update
.IP \(bu 2
\fBinfo\fP (\fIobject\fP) – Will contain additional information about the
state. For errors, this will be an object with
an \fB\(dqerror\(dq\fP field and string value. For
success states, see below.
.IP \(bu 2
\fBerror_count\fP (\fInumber\fP) – Consecutive errors count. Indicates how many
times in a row this replication has crashed.
Replication will be retried with an exponential
backoff based on this number. As soon as the
replication succeeds this count is reset to 0.
To can be used to get an idea why a particular
replication is not making progress.
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.UNINDENT
.UNINDENT
.sp
The \fBinfo\fP field of a scheduler doc:
.INDENT 7.0
.TP
.B JSON Parameters
.INDENT 7.0
.IP \(bu 2
\fBrevisions_checked\fP (\fInumber\fP) – The count of revisions which have been
checked since this replication began.
.IP \(bu 2
\fBmissing_revisions_found\fP (\fInumber\fP) – The count of revisions which were
found on the source, but missing from the target.
.IP \(bu 2
\fBdocs_read\fP (\fInumber\fP) – The count of docs which have been read from the
source.
.IP \(bu 2
\fBdocs_written\fP (\fInumber\fP) – The count of docs which have been written to the
target.
.IP \(bu 2
\fBbulk_get_attempts\fP (\fInumber\fP) – The total count of attempted doc revisions
fetched with \fB_bulk_get\fP\&.
.IP \(bu 2
\fBbulk_get_docs\fP (\fInumber\fP) – The total count of successful docs fetched with
\fB_bulk_get\fP\&.
.IP \(bu 2
\fBchanges_pending\fP (\fInumber\fP) – The count of changes not yet replicated.
.IP \(bu 2
\fBdoc_write_failures\fP (\fInumber\fP) – The count of docs which failed to be
written to the target.
.IP \(bu 2
\fBcheckpointed_source_seq\fP (\fIobject\fP) – .INDENT 2.0
.TP
.B The source sequence id which was last
successfully replicated.
.UNINDENT
.sp
\fBRequest\fP:

.UNINDENT
.UNINDENT
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_scheduler/docs/other/_replicator/cdyno\-0000001\-0000002 HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Content\-Type: application/json
Date: Sat, 29 Apr 2017 05:10:08 GMT
Server: Server: CouchDB (Erlang/OTP)
Transfer\-Encoding: chunked

{
    \(dqdatabase\(dq: \(dqother/_replicator\(dq,
    \(dqdoc_id\(dq: \(dqcdyno\-0000001\-0000002\(dq,
    \(dqerror_count\(dq: 0,
    \(dqid\(dq: \(dqe327d79214831ca4c11550b4a453c9ba+continuous\(dq,
    \(dqinfo\(dq: {
        \(dqchanges_pending\(dq: 0,
        \(dqcheckpointed_source_seq\(dq: \(dq60\-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV0MDQy1zMAQsMckEQiQ1L9____szKYEyVygQLsBsZm5pZJJpjKcRqRxwIkGRqA1H\-oSSpgk4yMkhITjS0wdWUBAENCJEg\(dq,
        \(dqdoc_write_failures\(dq: 0,
        \(dqdocs_read\(dq: 67,
        \(dqbulk_get_attempts\(dq: 67,
        \(dqbulk_get_docs\(dq: 67,
        \(dqdocs_written\(dq: 67,
        \(dqmissing_revisions_found\(dq: 67,
        \(dqrevisions_checked\(dq: 67,
        \(dqsource_seq\(dq: \(dq67\-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV0MDQy1zMAQsMckEQiQ1L9____szKYE2VygQLsBsZm5pZJJpjKcRqRxwIkGRqA1H\-oSepgk4yMkhITjS0wdWUBAEVKJE8\(dq,
        \(dqthrough_seq\(dq: \(dq67\-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV0MDQy1zMAQsMckEQiQ1L9____szKYE2VygQLsBsZm5pZJJpjKcRqRxwIkGRqA1H\-oSepgk4yMkhITjS0wdWUBAEVKJE8\(dq
    },
    \(dqlast_updated\(dq: \(dq2017\-04\-29T05:01:37Z\(dq,
    \(dqnode\(dq: \(dqnode2@127.0.0.1\(dq,
    \(dqsource_proxy\(dq: null,
    \(dqtarget_proxy\(dq: null,
    \(dqsource\(dq: \(dqhttp://myserver.com/foo\(dq,
    \(dqstart_time\(dq: \(dq2017\-04\-29T05:01:37Z\(dq,
    \(dqstate\(dq: \(dqrunning\(dq,
    \(dqtarget\(dq: \(dqhttp://adm:*****@localhost:15984/cdyno\-0000002/\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/_node/{node\-name}\fP
.INDENT 0.0
.TP
.B GET /_node/{node\-name}
The \fB/_node/{node\-name}\fP endpoint can be used to confirm the Erlang
node name of the server that processes the request. This is most useful
when accessing \fB/_node/_local\fP to retrieve this information. Repeatedly
retrieving this information for a CouchDB endpoint can be useful to determine
if a CouchDB cluster is correctly proxied through a reverse load balancer.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_node/_local HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 27
Content\-Type: application/json
Date: Tue, 28 Jan 2020 19:25:51 GMT
Server: CouchDB (Erlang OTP)
X\-Couch\-Request\-ID: 5b8db6c677
X\-CouchDB\-Body\-Time: 0

{\(dqname\(dq:\(dqnode1@127.0.0.1\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/_node/{node\-name}/_stats\fP
.INDENT 0.0
.TP
.B GET /_node/{node\-name}/_stats
The \fB_stats\fP resource returns a JSON object containing the statistics
for the running server. The object is structured with top\-level sections
collating the statistics for a range of entries, with each individual
statistic being easily identified, and the content of each statistic is
self\-describing.
.sp
Statistics are sampled internally on a \fI\%configurable interval\fP\&. When monitoring the \fB_stats\fP endpoint, you need to use
a polling frequency of at least twice this to observe accurate results.
For example, if the \fI\%interval\fP is 10 seconds,
poll \fB_stats\fP at least every 5 seconds.
.sp
The literal string \fB_local\fP serves as an alias for the local node name, so
for all stats URLs, \fB{node\-name}\fP may be replaced with \fB_local\fP, to
interact with the local node’s statistics.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_node/_local/_stats/couchdb/request_time HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 187
Content\-Type: application/json
Date: Sat, 10 Aug 2013 11:41:11 GMT
Server: CouchDB (Erlang/OTP)

{
  \(dqvalue\(dq: {
    \(dqmin\(dq: 0,
    \(dqmax\(dq: 0,
    \(dqarithmetic_mean\(dq: 0,
    \(dqgeometric_mean\(dq: 0,
    \(dqharmonic_mean\(dq: 0,
    \(dqmedian\(dq: 0,
    \(dqvariance\(dq: 0,
    \(dqstandard_deviation\(dq: 0,
    \(dqskewness\(dq: 0,
    \(dqkurtosis\(dq: 0,
    \(dqpercentile\(dq: [
      [
        50,
        0
      ],
      [
        75,
        0
      ],
      [
        90,
        0
      ],
      [
        95,
        0
      ],
      [
        99,
        0
      ],
      [
        999,
        0
      ]
    ],
    \(dqhistogram\(dq: [
      [
        0,
        0
      ]
    ],
    \(dqn\(dq: 0
  },
  \(dqtype\(dq: \(dqhistogram\(dq,
  \(dqdesc\(dq: \(dqlength of a request inside CouchDB without MochiWeb\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.sp
The fields provide the current, minimum and maximum, and a collection of
statistical means and quantities. The quantity in each case is not defined, but
the descriptions below provide sufficient detail to determine units.
.sp
Statistics are reported by ‘group’.  The statistics are divided into the
following top\-level sections:
.INDENT 0.0
.IP \(bu 2
\fBcouch_log\fP: Logging subsystem
.IP \(bu 2
\fBcouch_replicator\fP: Replication scheduler and subsystem
.IP \(bu 2
\fBcouchdb\fP: Primary CouchDB database operations
.IP \(bu 2
\fBfabric\fP: Cluster\-related operations
.IP \(bu 2
\fBglobal_changes\fP: Global changes feed
.IP \(bu 2
\fBmem3\fP: Node membership\-related statistics
.IP \(bu 2
\fBpread\fP: CouchDB file\-related exceptions
.IP \(bu 2
\fBrexi\fP: Cluster internal RPC\-related statistics
.UNINDENT
.sp
The type of the statistic is included in the \fBtype\fP field, and is one of
the following:
.INDENT 0.0
.IP \(bu 2
\fBcounter\fP: Monotonically increasing counter, resets on restart
.IP \(bu 2
\fBhistogram\fP: Binned set of values with meaningful subdivisions.
Scoped to the current \fI\%collection interval\fP\&.
.IP \(bu 2
\fBgauge\fP: Single numerical value that can go up and down
.UNINDENT
.sp
You can also access individual statistics by quoting the statistics sections
and statistic ID as part of the URL path. For example, to get the
\fBrequest_time\fP statistics within the \fBcouchdb\fP section for the target
node, you can use:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_node/_local/_stats/couchdb/request_time HTTP/1.1
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This returns an entire statistics object, as with the full request, but
containing only the requested individual statistic.
.SS \fB/_node/{node\-name}/_prometheus\fP
.INDENT 0.0
.TP
.B GET /_node/{node\-name}/_prometheus
The \fB_prometheus\fP resource returns a text/plain response that consolidates our
\fI\%/_node/{node\-name}/_stats\fP, and \fI\%/_node/{node\-name}/_system\fP endpoints. The format is
determined by \fI\%Prometheus\fP\&.
The format version is 2.0.
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_node/_local/_prometheus HTTP/1.1
Accept: text/plain
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 187
Content\-Type: text/plain; version=2.0
Date: Sat, 10 May 2020 11:41:11 GMT
Server: CouchDB (Erlang/OTP)

# TYPE couchdb_couch_log_requests_total counter
couchdb_couch_log_requests_total{level=\(dqalert\(dq} 0
couchdb_couch_log_requests_total{level=\(dqcritical\(dq} 0
couchdb_couch_log_requests_total{level=\(dqdebug\(dq} 0
couchdb_couch_log_requests_total{level=\(dqemergency\(dq} 0
couchdb_couch_log_requests_total{level=\(dqerror\(dq} 0
couchdb_couch_log_requests_total{level=\(dqinfo\(dq} 8
couchdb_couch_log_requests_total{level=\(dqnotice\(dq} 51
couchdb_couch_log_requests_total{level=\(dqwarning\(dq} 0
# TYPE couchdb_couch_replicator_changes_manager_deaths_total counter
couchdb_couch_replicator_changes_manager_deaths_total 0
# TYPE couchdb_couch_replicator_changes_queue_deaths_total counter
couchdb_couch_replicator_changes_queue_deaths_total 0
# TYPE couchdb_couch_replicator_changes_read_failures_total counter
couchdb_couch_replicator_changes_read_failures_total 0
# TYPE couchdb_couch_replicator_changes_reader_deaths_total counter
couchdb_couch_replicator_changes_reader_deaths_total 0
# TYPE couchdb_couch_replicator_checkpoints_failure_total counter
couchdb_couch_replicator_checkpoints_failure_total 0
# TYPE couchdb_couch_replicator_checkpoints_total counter
couchdb_couch_replicator_checkpoints_total 0
# TYPE couchdb_couch_replicator_cluster_is_stable gauge
couchdb_couch_replicator_cluster_is_stable 1
# TYPE couchdb_couch_replicator_connection_acquires_total counter
couchdb_couch_replicator_connection_acquires_total 0
# TYPE couchdb_couch_replicator_connection_closes_total counter
couchdb_couch_replicator_connection_closes_total 0
# TYPE couchdb_couch_replicator_connection_creates_total counter
couchdb_couch_replicator_connection_creates_total 0
# TYPE couchdb_couch_replicator_connection_owner_crashes_total counter
couchdb_couch_replicator_connection_owner_crashes_total 0
# TYPE couchdb_couch_replicator_connection_releases_total counter
couchdb_couch_replicator_connection_releases_total 0
# TYPE couchdb_couch_replicator_connection_worker_crashes_total counter
couchdb_couch_replicator_connection_worker_crashes_total 0
# TYPE couchdb_couch_replicator_db_scans_total counter
couchdb_couch_replicator_db_scans_total 1
# TYPE couchdb_couch_replicator_docs_completed_state_updates_total counter
couchdb_couch_replicator_docs_completed_state_updates_total 0
# TYPE couchdb_couch_replicator_docs_db_changes_total counter
couchdb_couch_replicator_docs_db_changes_total 0
# TYPE couchdb_couch_replicator_docs_dbs_created_total counter
couchdb_couch_replicator_docs_dbs_created_total 0
# TYPE couchdb_couch_replicator_docs_dbs_deleted_total counter
couchdb_couch_replicator_docs_dbs_deleted_total 0
# TYPE couchdb_couch_replicator_docs_dbs_found_total counter
couchdb_couch_replicator_docs_dbs_found_total 2
# TYPE couchdb_couch_replicator_docs_failed_state_updates_total counter
couchdb_couch_replicator_docs_failed_state_updates_total 0
# TYPE couchdb_couch_replicator_failed_starts_total counter
couchdb_couch_replicator_failed_starts_total 0
# TYPE couchdb_couch_replicator_jobs_adds_total counter
couchdb_couch_replicator_jobs_adds_total 0
# TYPE couchdb_couch_replicator_jobs_crashed gauge
couchdb_couch_replicator_jobs_crashed 0
# TYPE couchdb_couch_replicator_jobs_crashes_total counter
couchdb_couch_replicator_jobs_crashes_total 0
# TYPE couchdb_couch_replicator_jobs_duplicate_adds_total counter
couchdb_couch_replicator_jobs_duplicate_adds_total 0
# TYPE couchdb_couch_replicator_jobs_pending gauge
couchdb_couch_replicator_jobs_pending 0
# TYPE couchdb_couch_replicator_jobs_removes_total counter
couchdb_couch_replicator_jobs_removes_total 0
# TYPE couchdb_couch_replicator_jobs_running gauge
couchdb_couch_replicator_jobs_running 0
# TYPE couchdb_couch_replicator_jobs_starts_total counter
couchdb_couch_replicator_jobs_starts_total 0
# TYPE couchdb_couch_replicator_jobs_stops_total counter
couchdb_couch_replicator_jobs_stops_total 0
# TYPE couchdb_couch_replicator_jobs_total gauge
couchdb_couch_replicator_jobs_total 0
# TYPE couchdb_couch_replicator_requests_total counter
couchdb_couch_replicator_requests_total 0
# TYPE couchdb_couch_replicator_responses_failure_total counter
couchdb_couch_replicator_responses_failure_total 0
# TYPE couchdb_couch_replicator_responses_total counter
couchdb_couch_replicator_responses_total 0
# TYPE couchdb_couch_replicator_stream_responses_failure_total counter
couchdb_couch_replicator_stream_responses_failure_total 0
# TYPE couchdb_couch_replicator_stream_responses_total counter
couchdb_couch_replicator_stream_responses_total 0
# TYPE couchdb_couch_replicator_worker_deaths_total counter
couchdb_couch_replicator_worker_deaths_total 0
# TYPE couchdb_couch_replicator_workers_started_total counter
couchdb_couch_replicator_workers_started_total 0
# TYPE couchdb_auth_cache_requests_total counter
couchdb_auth_cache_requests_total 0
# TYPE couchdb_auth_cache_misses_total counter
couchdb_auth_cache_misses_total 0
# TYPE couchdb_collect_results_time_seconds summary
couchdb_collect_results_time_seconds{quantile=\(dq0.5\(dq} 0.0
couchdb_collect_results_time_seconds{quantile=\(dq0.75\(dq} 0.0
couchdb_collect_results_time_seconds{quantile=\(dq0.9\(dq} 0.0
couchdb_collect_results_time_seconds{quantile=\(dq0.95\(dq} 0.0
couchdb_collect_results_time_seconds{quantile=\(dq0.99\(dq} 0.0
couchdb_collect_results_time_seconds{quantile=\(dq0.999\(dq} 0.0
couchdb_collect_results_time_seconds_sum 0.0
couchdb_collect_results_time_seconds_count 0
# TYPE couchdb_couch_server_lru_skip_total counter
couchdb_couch_server_lru_skip_total 0
# TYPE couchdb_database_purges_total counter
couchdb_database_purges_total 0
# TYPE couchdb_database_reads_total counter
couchdb_database_reads_total 0
# TYPE couchdb_database_writes_total counter
couchdb_database_writes_total 0
# TYPE couchdb_db_open_time_seconds summary
couchdb_db_open_time_seconds{quantile=\(dq0.5\(dq} 0.0
couchdb_db_open_time_seconds{quantile=\(dq0.75\(dq} 0.0
couchdb_db_open_time_seconds{quantile=\(dq0.9\(dq} 0.0
couchdb_db_open_time_seconds{quantile=\(dq0.95\(dq} 0.0
couchdb_db_open_time_seconds{quantile=\(dq0.99\(dq} 0.0
couchdb_db_open_time_seconds{quantile=\(dq0.999\(dq} 0.0
couchdb_db_open_time_seconds_sum 0.0
couchdb_db_open_time_seconds_count 0
# TYPE couchdb_dbinfo_seconds summary
couchdb_dbinfo_seconds{quantile=\(dq0.5\(dq} 0.0
couchdb_dbinfo_seconds{quantile=\(dq0.75\(dq} 0.0
couchdb_dbinfo_seconds{quantile=\(dq0.9\(dq} 0.0
couchdb_dbinfo_seconds{quantile=\(dq0.95\(dq} 0.0
couchdb_dbinfo_seconds{quantile=\(dq0.99\(dq} 0.0
couchdb_dbinfo_seconds{quantile=\(dq0.999\(dq} 0.0
couchdb_dbinfo_seconds_sum 0.0
couchdb_dbinfo_seconds_count 0
# TYPE couchdb_document_inserts_total counter
couchdb_document_inserts_total 0
# TYPE couchdb_document_purges_failure_total counter
couchdb_document_purges_failure_total 0
# TYPE couchdb_document_purges_success_total counter
couchdb_document_purges_success_total 0
# TYPE couchdb_document_purges_total_total counter
couchdb_document_purges_total_total 0
# TYPE couchdb_document_writes_total counter
couchdb_document_writes_total 0
# TYPE couchdb_httpd_aborted_requests_total counter
couchdb_httpd_aborted_requests_total 0
# TYPE couchdb_httpd_all_docs_timeouts_total counter
couchdb_httpd_all_docs_timeouts_total 0
# TYPE couchdb_httpd_bulk_docs_seconds summary
couchdb_httpd_bulk_docs_seconds{quantile=\(dq0.5\(dq} 0.0
couchdb_httpd_bulk_docs_seconds{quantile=\(dq0.75\(dq} 0.0
couchdb_httpd_bulk_docs_seconds{quantile=\(dq0.9\(dq} 0.0
couchdb_httpd_bulk_docs_seconds{quantile=\(dq0.95\(dq} 0.0
couchdb_httpd_bulk_docs_seconds{quantile=\(dq0.99\(dq} 0.0
couchdb_httpd_bulk_docs_seconds{quantile=\(dq0.999\(dq} 0.0
couchdb_httpd_bulk_docs_seconds_sum 0.0
couchdb_httpd_bulk_docs_seconds_count 0
\&...remaining couchdb metrics from _stats and _system
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.sp
If an additional port config option is specified, then a client can call this API using
that port which does not require authentication. This option is \fBfalse\fP (OFF)
by default. When the option is \fBtrue\fP (ON), the default ports for a 3 node cluster
are \fB17986\fP, \fB27986\fP, \fB37986\fP\&.
See \fI\%Configuration of Prometheus Endpoint\fP for details.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_node/_local/_prometheus HTTP/1.1
Accept: text/plain
Host: localhost:17986
.ft P
.fi
.UNINDENT
.UNINDENT
.SS \fB/_node/{node\-name}/_system\fP
.INDENT 0.0
.TP
.B GET /_node/{node\-name}/_system
The \fB_system\fP resource returns a JSON object containing various
system\-level statistics for the running server. The object is structured
with top\-level sections collating the statistics for a range of entries,
with each individual statistic being easily identified, and the content of
each statistic is self\-describing.
.sp
The literal string \fB_local\fP serves as an alias for the local node name, so
for all stats URLs, \fB{node\-name}\fP may be replaced with \fB_local\fP, to
interact with the local node’s statistics.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_node/_local/_system HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 187
Content\-Type: application/json
Date: Sat, 10 Aug 2013 11:41:11 GMT
Server: CouchDB (Erlang/OTP)

{
  \(dquptime\(dq: 259,
  \(dqmemory\(dq: {}
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
These statistics are generally intended for CouchDB developers only.
.UNINDENT
.SS \fB/_node/{node\-name}/_restart\fP
.INDENT 0.0
.TP
.B POST /_node/{node\-name}/_restart
This API is to facilitate integration testing only
it is not meant to be used in production
.INDENT 7.0
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/_node/{node\-name}/_versions\fP
.INDENT 0.0
.TP
.B GET /_node/{node\-name}/_versions
The \fB_versions\fP resource returns a JSON object containing various
system\-level informations for the running server.
.sp
The literal string \fB_local\fP serves as an alias for the local node name, so
for all stats URLs, \fB{node\-name}\fP may be replaced with \fB_local\fP, to
interact with the local node’s informations.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_node/_local/_versions HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 368
Content\-Type: application/json
Date: Sat, 03 Sep 2022 08:12:12 GMT
Server: CouchDB/3.2.2\-ea382cf (Erlang OTP/25)

{
    \(dqjavascript_engine\(dq: {
        \(dqversion\(dq: \(dq91\(dq,
        \(dqname\(dq: \(dqspidermonkey\(dq
    },
    \(dqerlang\(dq: {
        \(dqversion\(dq: \(dq25.0.4\(dq,
        \(dqsupported_hashes\(dq: [
            \(dqsha\(dq,
            \(dqsha224\(dq,
            \(dqsha256\(dq,
        ]
    },
    \(dqcollation_driver\(dq: {
        \(dqname\(dq: \(dqlibicu\(dq,
        \(dqlibrary_version\(dq: \(dq70.1\(dq,
        \(dqcollator_version\(dq: \(dq153.112\(dq,
        \(dqcollation_algorithm_version\(dq: \(dq14\(dq
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/_search_analyze\fP
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
Search endpoints require a running search plugin connected to each cluster
node. See \fI\%Search Plugin Installation\fP for details.
.UNINDENT
.UNINDENT
.sp
New in version 3.0.

.INDENT 0.0
.TP
.B POST /_search_analyze
Tests the results of Lucene analyzer tokenization on sample text.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBfield\fP – Type of analyzer
.IP \(bu 2
\fBtext\fP – Analyzer token you want to test
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%400 Bad Request\fP – Request body is wrong (malformed or missing one of the mandatory fields)
.IP \(bu 2
\fI\%500 Internal Server Error\fP – A server error (or other kind of error) occurred
.UNINDENT
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST /_search_analyze HTTP/1.1
Host: localhost:5984
Content\-Type: application/json

{\(dqanalyzer\(dq:\(dqenglish\(dq, \(dqtext\(dq:\(dqrunning\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqtokens\(dq: [
        \(dqrun\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS \fB/_utils\fP
.INDENT 0.0
.TP
.B GET /_utils
Accesses the built\-in Fauxton administration interface for CouchDB.
.INDENT 7.0
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Location\fP – New URI location
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%301 Moved Permanently\fP – Redirects to \fI\%GET /_utils/\fP
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B GET /_utils/
.INDENT 7.0
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – \fItext/html\fP
.IP \(bu 2
\fI\%Last\-Modified\fP – Static files modification timestamp
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/_up\fP
.sp
New in version 2.0.

.INDENT 0.0
.TP
.B GET /_up
Confirms that the server is up, running, and ready to respond to requests.
If \fI\%maintenance_mode\fP is
\fBtrue\fP or \fBnolb\fP, the endpoint will return a 404 response.
.INDENT 7.0
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – \fIapplication/json\fP
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%404 Not Found\fP – The server is unavailable for requests at this time.
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 16
Content\-Type: application/json
Date: Sat, 17 Mar 2018 04:46:26 GMT
Server: CouchDB/2.2.0\-f999071ec (Erlang OTP/19)
X\-Couch\-Request\-ID: c57a3b2787
X\-CouchDB\-Body\-Time: 0

{\(dqstatus\(dq:\(dqok\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/_uuids\fP
.sp
Changed in version 2.0.0.

.INDENT 0.0
.TP
.B GET /_uuids
Requests one or more Universally Unique Identifiers (UUIDs) from the
CouchDB instance. The response is a JSON object providing a list of UUIDs.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBcount\fP (\fInumber\fP) – Number of UUIDs to return. Default is \fB1\fP\&.
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.IP \(bu 2
\fI\%ETag\fP – Response hash
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%400 Bad Request\fP – Requested more UUIDs than is \fI\%allowed\fP to retrieve
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_uuids?count=10 HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Content\-Length: 362
Content\-Type: application/json
Date: Sat, 10 Aug 2013 11:46:25 GMT
ETag: \(dqDGRWWQFLUDWN5MRKSLKQ425XV\(dq
Expires: Fri, 01 Jan 1990 00:00:00 GMT
Pragma: no\-cache
Server: CouchDB (Erlang/OTP)

{
    \(dquuids\(dq: [
        \(dq75480ca477454894678e22eec6002413\(dq,
        \(dq75480ca477454894678e22eec600250b\(dq,
        \(dq75480ca477454894678e22eec6002c41\(dq,
        \(dq75480ca477454894678e22eec6003b90\(dq,
        \(dq75480ca477454894678e22eec6003fca\(dq,
        \(dq75480ca477454894678e22eec6004bef\(dq,
        \(dq75480ca477454894678e22eec600528f\(dq,
        \(dq75480ca477454894678e22eec6005e0b\(dq,
        \(dq75480ca477454894678e22eec6006158\(dq,
        \(dq75480ca477454894678e22eec6006161\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.sp
The UUID type is determined by the \fI\%UUID algorithm\fP setting in the CouchDB configuration.
.sp
The UUID type may be changed at any time through the
\fI\%Configuration API\fP\&. For example, the UUID type
could be changed to \fBrandom\fP by sending this HTTP request:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
PUT http://couchdb:5984/_node/nonode@nohost/_config/uuids/algorithm HTTP/1.1
Content\-Type: application/json
Accept: */*

\(dqrandom\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You can verify the change by obtaining a list of UUIDs:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dquuids\(dq : [
        \(dq031aad7b469956cf2826fcb2a9260492\(dq,
        \(dq6ec875e15e6b385120938df18ee8e496\(dq,
        \(dqcff9e881516483911aa2f0e98949092d\(dq,
        \(dqb89d37509d39dd712546f9510d4a9271\(dq,
        \(dq2e0dbf7f6c4ad716f21938a016e4e59f\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS \fB/favicon.ico\fP
.INDENT 0.0
.TP
.B GET /favicon.ico
Binary content for the \fIfavicon.ico\fP site icon.
.INDENT 7.0
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – \fIimage/x\-icon\fP
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%404 Not Found\fP – The requested content could not be found
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/_reshard\fP
.sp
New in version 2.4.

.INDENT 0.0
.TP
.B GET /_reshard
Returns a count of completed, failed, running, stopped, and total jobs
along with the state of resharding on the cluster.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBstate\fP (\fIstring\fP) – \fBstopped\fP or \fBrunning\fP
.IP \(bu 2
\fBstate_reason\fP (\fIstring\fP) – \fBnull\fP or string describing additional
information or reason associated with the state
.IP \(bu 2
\fBcompleted\fP (\fInumber\fP) – Count of completed resharding jobs
.IP \(bu 2
\fBfailed\fP (\fInumber\fP) – Count of failed resharding jobs
.IP \(bu 2
\fBrunning\fP (\fInumber\fP) – Count of running resharding jobs
.IP \(bu 2
\fBstopped\fP (\fInumber\fP) – Count of stopped resharding jobs
.IP \(bu 2
\fBtotal\fP (\fInumber\fP) – Total count of resharding jobs
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_reshard HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Content\-Type: application/json

{
    \(dqcompleted\(dq: 21,
    \(dqfailed\(dq: 0,
    \(dqrunning\(dq: 3,
    \(dqstate\(dq: \(dqrunning\(dq,
    \(dqstate_reason\(dq: null,
    \(dqstopped\(dq: 0,
    \(dqtotal\(dq: 24
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B GET /_reshard/state
Returns the resharding state and optional information about the state.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBstate\fP (\fIstring\fP) – \fBstopped\fP or \fBrunning\fP
.IP \(bu 2
\fBstate_reason\fP (\fIstring\fP) – Additional  information  or  reason  associated
with the state
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_reshard/state HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Content\-Type: application/json

{
    \(dqreason\(dq: null,
    \(dqstate\(dq: \(dqrunning\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B PUT /_reshard/state
Change the resharding state on the cluster. The states are
\fBstopped\fP or \fBrunning\fP\&. This starts and stops global resharding on all
the nodes of the cluster. If there are any running jobs, they
will be stopped when the state changes to \fBstopped\fP\&. When the state
changes back to \fBrunning\fP those job will continue running.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Request JSON Object
.INDENT 7.0
.IP \(bu 2
\fBstate\fP (\fIstring\fP) – \fBstopped\fP or \fBrunning\fP
.IP \(bu 2
\fBstate_reason\fP (\fIstring\fP) – Optional string describing additional
information or reason associated with the state
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBok\fP (\fIboolean\fP) – \fBtrue\fP
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid request. Could be a bad or missing state name.
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
PUT /_reshard/state HTTP/1.1
Accept: application/json
Host: localhost:5984

{
    \(dqstate\(dq: \(dqstopped\(dq,
    \(dqreason\(dq: \(dqRebalancing in progress\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Content\-Type: application/json

{
    \(dqok\(dq: true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B GET /_reshard/jobs
.sp
\fBNOTE:\fP
.INDENT 7.0
.INDENT 3.5
The shape of the response and the \fBtotal_rows\fP and \fBoffset\fP
field in particular are meant to be consistent with the
\fB_scheduler/jobs\fP endpoint.
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBjobs\fP (\fIlist\fP) – Array of json objects, one for each resharding job. For
the fields of each job see the /_reshard/job/{jobid}
endpoint.
.IP \(bu 2
\fBoffset\fP (\fInumber\fP) – Offset in the list of jobs object. Currently
hard\-coded at \fB0\fP\&.
.IP \(bu 2
\fBtotal_rows\fP (\fInumber\fP) – Total number of resharding jobs on the cluster.
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_reshard/jobs HTTP/1.1
Accept: application/json
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Content\-Type: application/json

{
    \(dqjobs\(dq: [
        {
            \(dqhistory\(dq: [
                {
                    \(dqdetail\(dq: null,
                    \(dqtimestamp\(dq: \(dq2019\-03\-28T15:28:02Z\(dq,
                    \(dqtype\(dq: \(dqnew\(dq
                },
                {
                    \(dqdetail\(dq: \(dqinitial_copy\(dq,
                    \(dqtimestamp\(dq: \(dq2019\-03\-28T15:28:02Z\(dq,
                    \(dqtype\(dq: \(dqrunning\(dq
                }
            ],
            \(dqid\(dq: \(dq001\-171d1211418996ff47bd610b1d1257fc4ca2628868def4a05e63e8f8fe50694a\(dq,
            \(dqjob_state\(dq: \(dqcompleted\(dq,
            \(dqnode\(dq: \(dqnode1@127.0.0.1\(dq,
            \(dqsource\(dq: \(dqshards/00000000\-1fffffff/d1.1553786862\(dq,
            \(dqsplit_state\(dq: \(dqcompleted\(dq,
            \(dqstart_time\(dq: \(dq2019\-03\-28T15:28:02Z\(dq,
            \(dqstate_info\(dq: {},
            \(dqtarget\(dq: [
                \(dqshards/00000000\-0fffffff/d1.1553786862\(dq,
                \(dqshards/10000000\-1fffffff/d1.1553786862\(dq
            ],
            \(dqtype\(dq: \(dqsplit\(dq,
            \(dqupdate_time\(dq: \(dq2019\-03\-28T15:28:08Z\(dq
        }
    ],
    \(dqoffset\(dq: 0,
    \(dqtotal_rows\(dq: 24
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B GET /_reshard/jobs/{jobid}
Get information about the resharding job identified by \fBjobid\fP\&.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBid\fP (\fIstring\fP) – Job ID.
.IP \(bu 2
\fBtype\fP (\fIstring\fP) – Currently only \fBsplit\fP is implemented.
.IP \(bu 2
\fBjob_state\fP (\fIstring\fP) – The running state of the job. Could be one of
\fBnew\fP, \fBrunning\fP, \fBstopped\fP, \fBcompleted\fP
or \fBfailed\fP\&.
.IP \(bu 2
\fBsplit_state\fP (\fIstring\fP) – State detail specific to shard splitting. It
indicates how far has shard splitting
progressed, and can be one of \fBnew\fP,
\fBinitial_copy\fP, \fBtopoff1\fP,
\fBbuild_indices\fP, \fBtopoff2\fP,
\fBcopy_local_docs\fP, \fBupdate_shardmap\fP,
\fBwait_source_close\fP, \fBtopoff3\fP,
\fBsource_delete\fP or \fBcompleted\fP\&.
.IP \(bu 2
\fBstate_info\fP (\fIobject\fP) – Optional additional info associated with the
current state.
.IP \(bu 2
\fBsource\fP (\fIstring\fP) – For \fBsplit\fP jobs this will be the source shard.
.IP \(bu 2
\fBtarget\fP (\fIlist\fP) – For \fBsplit\fP jobs this will be a list of two or more
target shards.
.IP \(bu 2
\fBhistory\fP (\fIlist\fP) – List of json objects recording a job’s state
transition history.
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_reshard/jobs/001\-171d1211418996ff47bd610b1d1257fc4ca2628868def4a05e63e8f8fe50694a HTTP/1.1
Accept: application/json
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Content\-Type: application/json

{

    \(dqid\(dq: \(dq001\-171d1211418996ff47bd610b1d1257fc4ca2628868def4a05e63e8f8fe50694a\(dq,
    \(dqjob_state\(dq: \(dqcompleted\(dq,
    \(dqnode\(dq: \(dqnode1@127.0.0.1\(dq,
    \(dqsource\(dq: \(dqshards/00000000\-1fffffff/d1.1553786862\(dq,
    \(dqsplit_state\(dq: \(dqcompleted\(dq,
    \(dqstart_time\(dq: \(dq2019\-03\-28T15:28:02Z\(dq,
    \(dqstate_info\(dq: {},
    \(dqtarget\(dq: [
        \(dqshards/00000000\-0fffffff/d1.1553786862\(dq,
        \(dqshards/10000000\-1fffffff/d1.1553786862\(dq
    ],
    \(dqtype\(dq: \(dqsplit\(dq,
    \(dqupdate_time\(dq: \(dq2019\-03\-28T15:28:08Z\(dq,
    \(dqhistory\(dq: [
        {
            \(dqdetail\(dq: null,
            \(dqtimestamp\(dq: \(dq2019\-03\-28T15:28:02Z\(dq,
            \(dqtype\(dq: \(dqnew\(dq
        },
        {
            \(dqdetail\(dq: \(dqinitial_copy\(dq,
            \(dqtimestamp\(dq: \(dq2019\-03\-28T15:28:02Z\(dq,
            \(dqtype\(dq: \(dqrunning\(dq
        }
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B POST /_reshard/jobs
Depending on what fields are specified in the request, one or more
resharding jobs will be created. The response is a json array of results.
Each result object represents a single resharding job for a particular node
and range. Some of the responses could be successful and some could fail.
Successful results will have the \fB\(dqok\(dq: true\fP key and and value, and
failed jobs will have the \fB\(dqerror\(dq: \(dq{error_message}\(dq\fP key and value.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Request JSON Object
.INDENT 7.0
.IP \(bu 2
\fBtype\fP (\fIstring\fP) – Type of job. Currently only \fB\(dqsplit\(dq\fP is accepted.
.IP \(bu 2
\fBdb\fP (\fIstring\fP) – Database to split. This is mutually exclusive with the
\fB\(dqshard\fP” field.
.IP \(bu 2
\fBnode\fP (\fIstring\fP) – Split shards on a particular node. This is an optional
parameter. The value should be one of the nodes
returned from the \fB_membership\fP endpoint.
.IP \(bu 2
\fBrange\fP (\fIstring\fP) – Split shards copies in the given range. The range
format is \fBhhhhhhhh\-hhhhhhhh\fP where \fBh\fP is a
hexadecimal digit. This format is used since this is
how the ranges are represented in the file system.
This is parameter is optional and is mutually
exclusive with the \fB\(dqshard\(dq\fP field.
.IP \(bu 2
\fBshard\fP (\fIstring\fP) – Split a particular shard. The shard should be
specified as \fB\(dqshards/{range}/{db}.{suffix}\(dq\fP\&. Where
\fBrange\fP has the \fBhhhhhhhh\-hhhhhhhh\fP format, \fBdb\fP
is the database name, and \fBsuffix\fP is the shard
(timestamp) creation suffix.
.IP \(bu 2
\fBerror\fP (\fIstring\fP) – Error message if a job could be not be created.
.IP \(bu 2
\fBnode\fP – Cluster node where the job was created and is running.
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBok\fP (\fIboolean\fP) – \fBtrue\fP if job created successfully.
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%201 Created\fP – One or more jobs were successfully created
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid request. Parameter validation might have failed.
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.IP \(bu 2
\fI\%404 Not Found\fP – Db, node, range or shard was not found
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /_reshard/jobs HTTP/1.1
Accept: application/json
Content\-Type: application/json

{
   \(dqdb\(dq: \(dqdb3\(dq,
   \(dqrange\(dq: \(dq80000000\-ffffffff\(dq,
   \(dqtype\(dq: \(dqsplit\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Content\-Type: application/json

[
    {
        \(dqid\(dq: \(dq001\-30d7848a6feeb826d5e3ea5bb7773d672af226fd34fd84a8fb1ca736285df557\(dq,
        \(dqnode\(dq: \(dqnode1@127.0.0.1\(dq,
        \(dqok\(dq: true,
        \(dqshard\(dq: \(dqshards/80000000\-ffffffff/db3.1554148353\(dq
    },
    {
        \(dqid\(dq: \(dq001\-c2d734360b4cb3ff8b3feaccb2d787bf81ce2e773489eddd985ddd01d9de8e01\(dq,
        \(dqnode\(dq: \(dqnode2@127.0.0.1\(dq,
        \(dqok\(dq: true,
        \(dqshard\(dq: \(dqshards/80000000\-ffffffff/db3.1554148353\(dq
    }
]
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B DELETE /_reshard/jobs/{jobid}
If the job is running, stop the job and then remove it.
.INDENT 7.0
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBok\fP (\fIboolean\fP) – \fBtrue\fP if the job was removed successfully.
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – The job was removed successfully
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.IP \(bu 2
\fI\%404 Not Found\fP – The job was not found
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
DELETE /_reshard/jobs/001\-171d1211418996ff47bd610b1d1257fc4ca2628868def4a05e63e8f8fe50694a HTTP/1.1
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Content\-Type: application/json

{
    \(dqok\(dq: true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B GET /_reshard/jobs/{jobid}/state
Returns the running state of a resharding job identified by \fBjobid\fP\&.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Request JSON Object
.INDENT 7.0
.IP \(bu 2
\fBstate\fP (\fIstring\fP) – One of \fBnew\fP, \fBrunning\fP, \fBstopped\fP,
\fBcompleted\fP or \fBfailed\fP\&.
.IP \(bu 2
\fBstate_reason\fP (\fIstring\fP) – Additional information associated with the
state
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.IP \(bu 2
\fI\%404 Not Found\fP – The job was not found
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_reshard/jobs/001\-b3da04f969bbd682faaab5a6c373705cbcca23f732c386bb1a608cfbcfe9faff/state HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Content\-Type: application/json

{
    \(dqreason\(dq: null,
    \(dqstate\(dq: \(dqrunning\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B PUT /_reshard/jobs/{jobid}/state
Change the state of a particular resharding job identified by \fBjobid\fP\&.
The state can be changed from \fBstopped\fP to \fBrunning\fP or from
\fBrunning\fP to \fBstopped\fP\&. If an individual job is \fBstopped\fP via this
API it will stay \fBstopped\fP even after the global resharding state is
toggled from \fBstopped\fP to \fBrunning\fP\&. If the job is already
\fBcompleted\fP its state will stay \fBcompleted\fP\&.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Request JSON Object
.INDENT 7.0
.IP \(bu 2
\fBstate\fP (\fIstring\fP) – \fBstopped\fP or \fBrunning\fP
.IP \(bu 2
\fBstate_reason\fP (\fIstring\fP) – Optional string describing additional
information or reason associated with the state
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBok\fP (\fIboolean\fP) – \fBtrue\fP
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid request. Could be a bad state name, for example.
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.IP \(bu 2
\fI\%404 Not Found\fP – The job was not found
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
PUT /_reshard/state/001\-b3da04f969bbd682faaab5a6c373705cbcca23f732c386bb1a608cfbcfe9faff/state HTTP/1.1
Accept: application/json
Host: localhost:5984

{
    \(dqstate\(dq: \(dqstopped\(dq,
    \(dqreason\(dq: \(dqRebalancing in progress\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Content\-Type: application/json

{
     \(dqok\(dq: true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS Authentication
.sp
Interfaces for obtaining session and authorization data.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
We also strongly recommend you \fI\%set up SSL\fP to
improve all authentication methods’ security.
.UNINDENT
.UNINDENT
.SS Basic Authentication
.sp
\fI\%Basic authentication\fP (\fI\%RFC 2617\fP) is a quick and simple way to authenticate
with CouchDB. The main drawback is the need to send user credentials with each
request which may be insecure and could hurt operation performance (since
CouchDB must compute the password hash with every request):
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET / HTTP/1.1
Accept: application/json
Authorization: Basic cm9vdDpyZWxheA==
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 177
Content\-Type: application/json
Date: Mon, 03 Dec 2012 00:44:47 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqcouchdb\(dq:\(dqWelcome\(dq,
    \(dquuid\(dq:\(dq0a959b9b8227188afc2ac26ccdf345a6\(dq,
    \(dqversion\(dq:\(dq1.3.0\(dq,
    \(dqvendor\(dq: {
        \(dqversion\(dq:\(dq1.3.0\(dq,
        \(dqname\(dq:\(dqThe Apache Software Foundation\(dq
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Cookie Authentication
.sp
For cookie authentication (\fI\%RFC 2109\fP) CouchDB generates a token that the
client can use for the next few requests to CouchDB. Tokens are valid until
a timeout. When CouchDB sees a valid token in a subsequent request, it will
authenticate the user by this token without requesting the password again. By
default, cookies are valid for 10 minutes, but it’s adjustable via \fI\%timeout\fP\&. Also it’s possible to make cookies
\fI\%persistent\fP\&.
.sp
To obtain the first token and thus authenticate a user for the first time, the
\fBusername\fP and \fBpassword\fP must be sent to the \fI\%_session API\fP\&.
.SS \fB/_session\fP
.INDENT 0.0
.TP
.B POST /_session
Initiates new session for specified user credentials by providing \fICookie\fP
value.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/x\-www\-form\-urlencoded\fP
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBnext\fP (\fIstring\fP) – Enforces redirect after successful login to the
specified location. This location is relative from server root.
\fIOptional\fP\&.
.UNINDENT
.TP
.B Form Parameters
.INDENT 7.0
.IP \(bu 2
\fBname\fP – User name
.IP \(bu 2
\fBpassword\fP – Password
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Set\-Cookie\fP – Authorization token
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBok\fP (\fIboolean\fP) – Operation status
.IP \(bu 2
\fBname\fP (\fIstring\fP) – Username
.IP \(bu 2
\fBroles\fP (\fIarray\fP) – List of user roles
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Successfully authenticated
.IP \(bu 2
\fI\%302 Found\fP – Redirect after successful authentication
.IP \(bu 2
\fI\%401 Unauthorized\fP – Username or password wasn’t recognized
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /_session HTTP/1.1
Accept: application/json
Content\-Length: 24
Content\-Type: application/x\-www\-form\-urlencoded
Host: localhost:5984

name=root&password=relax
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
It’s also possible to send data as JSON:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /_session HTTP/1.1
Accept: application/json
Content\-Length: 37
Content\-Type: application/json
Host: localhost:5984

{
    \(dqname\(dq: \(dqroot\(dq,
    \(dqpassword\(dq: \(dqrelax\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 43
Content\-Type: application/json
Date: Mon, 03 Dec 2012 01:23:14 GMT
Server: CouchDB (Erlang/OTP)
Set\-Cookie: AuthSession=cm9vdDo1MEJCRkYwMjq0LO0ylOIwShrgt8y\-UkhI\-c6BGw; Version=1; Path=/; HttpOnly

{\(dqok\(dq:true,\(dqname\(dq:\(dqroot\(dq,\(dqroles\(dq:[\(dq_admin\(dq]}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If \fBnext\fP query parameter was provided the response will trigger
redirection to the specified location in case of successful authentication:
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /_session?next=/blog/_design/sofa/_rewrite/recent\-posts HTTP/1.1
Accept: application/json
Content\-Type: application/x\-www\-form\-urlencoded
Host: localhost:5984

name=root&password=relax
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 302 Moved Temporarily
Cache\-Control: must\-revalidate
Content\-Length: 43
Content\-Type: application/json
Date: Mon, 03 Dec 2012 01:32:46 GMT
Location: http://localhost:5984/blog/_design/sofa/_rewrite/recent\-posts
Server: CouchDB (Erlang/OTP)
Set\-Cookie: AuthSession=cm9vdDo1MEJDMDEzRTp7Vu5GKCkTxTVxwXbpXsBARQWnhQ; Version=1; Path=/; HttpOnly

{\(dqok\(dq:true,\(dqname\(dq:null,\(dqroles\(dq:[\(dq_admin\(dq]}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B GET /_session
Returns information about the authenticated user, including a
\fI\%User Context Object\fP, the authentication method and database that were
used, and a list of configured authentication handlers on the server.
.INDENT 7.0
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBbasic\fP (\fIboolean\fP) – Accept \fIBasic Auth\fP by requesting this resource.
\fIOptional\fP\&.
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBok\fP (\fIboolean\fP) – Operation status
.IP \(bu 2
\fBuserCtx\fP (\fIobject\fP) – User context for the current user
.IP \(bu 2
\fBinfo\fP (\fIobject\fP) – Server authentication configuration
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Successfully authenticated.
.IP \(bu 2
\fI\%401 Unauthorized\fP – Username or password wasn’t recognized.
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_session HTTP/1.1
Host: localhost:5984
Accept: application/json
Cookie: AuthSession=cm9vdDo1MEJDMDQxRDpqb\-Ta9QfP9hpdPjHLxNTKg_Hf9w
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 175
Content\-Type: application/json
Date: Fri, 09 Aug 2013 20:27:45 GMT
Server: CouchDB (Erlang/OTP)
Set\-Cookie: AuthSession=cm9vdDo1MjA1NTBDMTqmX2qKt1KDR\-\-GUC80DQ6\-Ew_XIw; Version=1; Path=/; HttpOnly

{
    \(dqinfo\(dq: {
        \(dqauthenticated\(dq: \(dqcookie\(dq,
        \(dqauthentication_db\(dq: \(dq_users\(dq,
        \(dqauthentication_handlers\(dq: [
            \(dqcookie\(dq,
            \(dqdefault\(dq
        ]
    },
    \(dqok\(dq: true,
    \(dquserCtx\(dq: {
        \(dqname\(dq: \(dqroot\(dq,
        \(dqroles\(dq: [
            \(dq_admin\(dq
        ]
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B DELETE /_session
Closes user’s session by instructing the browser to clear the cookie. This
does not invalidate the session from the server’s perspective, as there is
no way to do this because CouchDB cookies are stateless. This means calling
this endpoint is purely optional from a client perspective, and it does not
protect against theft of a session cookie.
.INDENT 7.0
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Successfully close session.
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
DELETE /_session HTTP/1.1
Accept: application/json
Cookie: AuthSession=cm9vdDo1MjA1NEVGMDo1QXNQkqC_0Qmgrk8Fw61_AzDeXw
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 12
Content\-Type: application/json
Date: Fri, 09 Aug 2013 20:30:12 GMT
Server: CouchDB (Erlang/OTP)
Set\-Cookie: AuthSession=; Version=1; Path=/; HttpOnly

{
    \(dqok\(dq: true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS Proxy Authentication
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
To use this authentication method make sure that the
\fB{chttpd_auth, proxy_authentication_handler}\fP value is added to the
list of the active \fI\%chttpd/authentication_handlers\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
authentication_handlers = {chttpd_auth, cookie_authentication_handler}, {chttpd_auth, proxy_authentication_handler}, {chttpd_auth, default_authentication_handler}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
\fIProxy authentication\fP is very useful in case your application already uses
some external authentication service and you don’t want to duplicate users and
their roles in CouchDB.
.sp
This authentication method allows creation of a \fI\%User Context Object\fP for
remotely authenticated user. By default, the client just needs to pass specific
headers to CouchDB with related requests:
.INDENT 0.0
.IP \(bu 2
\fI\%X\-Auth\-CouchDB\-UserName\fP:
username
.IP \(bu 2
\fI\%X\-Auth\-CouchDB\-Roles\fP:
comma\-separated (\fB,\fP) list of user roles
.IP \(bu 2
\fI\%X\-Auth\-CouchDB\-Token\fP:
authentication token. When
\fI\%proxy_use_secret\fP
is set (which is strongly recommended!), this header provides an HMAC of the
username to authenticate and the secret token to prevent requests from
untrusted sources. (Use one of the configured hash algorithms in
\fI\%chttpd_auth/hash_algorithms\fP
and sign the username with the secret)
.UNINDENT
.sp
\fBCreating the token (example with openssl)\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
echo \-n \(dqfoo\(dq | openssl dgst \-sha256 \-hmac \(dqthe_secret\(dq
# (stdin)= 3f0786e96b20b0102b77f1a49c041be6977cfb3bf78c41a12adc121cd9b4e68a
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_session HTTP/1.1
Host: localhost:5984
Accept: application/json
Content\-Type: application/json; charset=utf\-8
X\-Auth\-CouchDB\-Roles: users,blogger
X\-Auth\-CouchDB\-UserName: foo
X\-Auth\-CouchDB\-Token: 3f0786e96b20b0102b77f1a49c041be6977cfb3bf78c41a12adc121cd9b4e68a
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 190
Content\-Type: application/json
Date: Fri, 14 Jun 2013 10:16:03 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqinfo\(dq: {
        \(dqauthenticated\(dq: \(dqproxy\(dq,
        \(dqauthentication_db\(dq: \(dq_users\(dq,
        \(dqauthentication_handlers\(dq: [
            \(dqcookie\(dq,
            \(dqproxy\(dq,
            \(dqdefault\(dq
        ]
    },
    \(dqok\(dq: true,
    \(dquserCtx\(dq: {
        \(dqname\(dq: \(dqfoo\(dq,
        \(dqroles\(dq: [
            \(dqusers\(dq,
            \(dqblogger\(dq
        ]
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Note that you don’t need to request a \fI\%session\fP
to be authenticated by this method if all required HTTP headers are provided.
.SS JWT Authentication
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
To use this authentication method, make sure that the
\fB{chttpd_auth, jwt_authentication_handler}\fP value is added to the
list of the active \fI\%chttpd/authentication_handlers\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[chttpd]
authentication_handlers = {chttpd_auth, cookie_authentication_handler}, {chttpd_auth, jwt_authentication_handler}, {chttpd_auth, default_authentication_handler}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
\fBJWT authentication\fP enables CouchDB to use externally\-generated JWT tokens
instead of defining users or roles in the \fB_users\fP database.
.sp
The JWT authentication handler requires that all JWT tokens are signed by a key that
CouchDB has been configured to trust (there is no support for JWT’s “NONE” algorithm).
.sp
Additionally, CouchDB can be configured to reject JWT tokens that are
missing a configurable set of claims (e.g, a CouchDB administrator
could insist on the \fBexp\fP claim).
.sp
Only claims listed in required checks are validated. Additional claims will be ignored.
.sp
Two sections of config exist to configure JWT authentication;
.sp
The \fI\%required_claims\fP config
setting is a comma\-separated list of additional mandatory JWT claims
that must be present in any presented JWT token. A \fI\%400 Bad Request\fP
is sent if any are missing.
.sp
The \fBalg\fP claim is mandatory as it used to lookup the correct key for verifying the
signature.
.sp
The \fBsub\fP claim is mandatory and is used as the CouchDB user’s name if the JWT token
is valid.
.sp
You can set the user roles claim name through the config setting
\fI\%roles_claim_name\fP\&. If you don’t set
an explicit value, then \fB_couchdb.roles\fP will be set as the default claim name.
If presented, as a JSON array of strings, it is used as the CouchDB user’s roles
list as long as the JWT token is valid.
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
\fBroles_claim_name\fP is deprecated in CouchDB 3.3, and will be removed later.
Please use \fI\%roles_claim_path\fP\&.
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
; [jwt_keys]
; Configure at least one key here if using the JWT auth handler.
; If your JWT tokens do not include a \(dqkid\(dq attribute, use \(dq_default\(dq
; as the config key, otherwise use the kid as the config key.
; Examples
; hmac:_default = aGVsbG8=
; hmac:foo = aGVsbG8=
; The config values can represent symmetric and asymmetric keys.
; For symmetric keys, the value is base64 encoded;
; hmac:_default = aGVsbG8= # base64\-encoded form of \(dqhello\(dq
; For asymmetric keys, the value is the PEM encoding of the public
; key with newlines replaced with the escape sequence \en.
; rsa:foo = \-\-\-\-\-BEGIN PUBLIC KEY\-\-\-\-\-\enMIIBIjAN...IDAQAB\en\-\-\-\-\-END PUBLIC KEY\-\-\-\-\-\en
; ec:bar = \-\-\-\-\-BEGIN PUBLIC KEY\-\-\-\-\-\enMHYwEAYHK...AzztRs\en\-\-\-\-\-END PUBLIC KEY\-\-\-\-\-\en
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The \fBjwt_keys\fP section lists all the keys that this CouchDB server trusts. You
should ensure that all nodes of your cluster have the same list.
.sp
Since version 3.3 it’s possible to use \fB=\fP in parameter names, but only when
the parameter and value are separated \fB\ =\ \fP, i.e. the equal sign is
surrounded by at least one space on each side. This might be useful in the
\fB[jwt_keys]\fP section where base64 encoded keys may contain the \fB=\fP
character.
.sp
JWT tokens that do not include a \fBkid\fP claim will be validated against the
\fB$alg:_default\fP key.
.sp
It is mandatory to specify the algorithm associated with every key for security
reasons (notably presenting a HMAC\-signed token using an RSA or EC public key
that the server trusts:
\fI\%https://auth0.com/blog/critical\-vulnerabilities\-in\-json\-web\-token\-libraries/\fP).
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_session HTTP/1.1
Host: localhost:5984
Accept: application/json
Content\-Type: application/json; charset=utf\-8
Authorization: Bearer <JWT token>
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 188
Content\-Type: application/json
Date: Sun, 19 Apr 2020 08:29:15 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqinfo\(dq: {
        \(dqauthenticated\(dq: \(dqjwt\(dq,
        \(dqauthentication_db\(dq: \(dq_users\(dq,
        \(dqauthentication_handlers\(dq: [
            \(dqcookie\(dq,
            \(dqproxy\(dq,
            \(dqdefault\(dq
        ]
    },
    \(dqok\(dq: true,
    \(dquserCtx\(dq: {
        \(dqname\(dq: \(dqfoo\(dq,
        \(dqroles\(dq: [
            \(dqusers\(dq,
            \(dqblogger\(dq
        ]
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Note that you don’t need to request \fI\%session\fP
to be authenticated by this method if the required HTTP header is provided.
.SS Configuration
.sp
The CouchDB Server Configuration API provide an interface to query and update
the various configuration values within a running CouchDB instance.
.SS Accessing the local node’s configuration
.sp
The literal string \fB_local\fP serves as an alias for the local node name, so
for all configuration URLs, \fB{node\-name}\fP may be replaced with \fB_local\fP, to
interact with the local node’s configuration.
.SS \fB/_node/{node\-name}/_config\fP
.INDENT 0.0
.TP
.B GET /_node/{node\-name}/_config
Returns the entire CouchDB server configuration as a JSON structure. The
structure is organized by different configuration sections, with
individual values.
.INDENT 7.0
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_node/nonode@nohost/_config HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 4148
Content\-Type: application/json
Date: Sat, 10 Aug 2013 12:01:42 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqattachments\(dq: {
        \(dqcompressible_types\(dq: \(dqtext/*, application/javascript, application/json,  application/xml\(dq,
        \(dqcompression_level\(dq: \(dq8\(dq
    },
    \(dqcouchdb\(dq: {
        \(dqusers_db_suffix\(dq: \(dq_users\(dq,
        \(dqdatabase_dir\(dq: \(dq/var/lib/couchdb\(dq,
        \(dqmax_attachment_chunk_size\(dq: \(dq4294967296\(dq,
        \(dqmax_dbs_open\(dq: \(dq100\(dq,
        \(dqos_process_timeout\(dq: \(dq5000\(dq,
        \(dquri_file\(dq: \(dq/var/lib/couchdb/couch.uri\(dq,
        \(dqutil_driver_dir\(dq: \(dq/usr/lib64/couchdb/erlang/lib/couch\-1.5.0/priv/lib\(dq,
        \(dqview_index_dir\(dq: \(dq/var/lib/couchdb\(dq
    },
    \(dqchttpd\(dq: {
        \(dqallow_jsonp\(dq: \(dqfalse\(dq,
        \(dqbacklog\(dq: \(dq512\(dq,
        \(dqbind_address\(dq: \(dq0.0.0.0\(dq,
        \(dqport\(dq: \(dq5984\(dq,
        \(dqrequire_valid_user\(dq: \(dqfalse\(dq,
        \(dqsocket_options\(dq: \(dq[{sndbuf, 262144}, {nodelay, true}]\(dq,
        \(dqserver_options\(dq: \(dq[{recbuf, undefined}]\(dq,
        \(dqsecure_rewrites\(dq: \(dqtrue\(dq
    },
    \(dqhttpd\(dq: {
        \(dqauthentication_handlers\(dq: \(dq{couch_httpd_auth, cookie_authentication_handler}, {couch_httpd_auth, default_authentication_handler}\(dq,
        \(dqbind_address\(dq: \(dq192.168.0.2\(dq,
        \(dqmax_connections\(dq: \(dq2048\(dq,
        \(dqport\(dq: \(dq5984\(dq,
    },
    \(dqlog\(dq: {
        \(dqwriter\(dq: \(dqfile\(dq,
        \(dqfile\(dq: \(dq/var/log/couchdb/couch.log\(dq,
        \(dqinclude_sasl\(dq: \(dqtrue\(dq,
        \(dqlevel\(dq: \(dqinfo\(dq
    },
    \(dqquery_server_config\(dq: {
        \(dqreduce_limit\(dq: \(dqtrue\(dq
    },
    \(dqreplicator\(dq: {
        \(dqmax_http_pipeline_size\(dq: \(dq10\(dq,
        \(dqmax_http_sessions\(dq: \(dq10\(dq
    },
    \(dqstats\(dq: {
        \(dqinterval\(dq: \(dq10\(dq
    },
    \(dquuids\(dq: {
        \(dqalgorithm\(dq: \(dqutc_random\(dq
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/_node/{node\-name}/_config/{section}\fP
.INDENT 0.0
.TP
.B GET /_node/{node\-name}/_config/{section}
Gets the configuration structure for a single section.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBsection\fP – Configuration section name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_node/nonode@nohost/_config/httpd HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 444
Content\-Type: application/json
Date: Sat, 10 Aug 2013 12:10:40 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqauthentication_handlers\(dq: \(dq{couch_httpd_auth, cookie_authentication_handler}, {couch_httpd_auth, default_authentication_handler}\(dq,
    \(dqbind_address\(dq: \(dq127.0.0.1\(dq,
    \(dqdefault_handler\(dq: \(dq{couch_httpd_db, handle_request}\(dq,
    \(dqport\(dq: \(dq5984\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/_node/{node\-name}/_config/{section}/{key}\fP
.INDENT 0.0
.TP
.B GET /_node/{node\-name}/_config/{section}/{key}
Gets a single configuration value from within a specific configuration
section.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBsection\fP – Configuration section name
.IP \(bu 2
\fBkey\fP – Configuration option name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_node/nonode@nohost/_config/log/level HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 8
Content\-Type: application/json
Date: Sat, 10 Aug 2013 12:12:59 GMT
Server: CouchDB (Erlang/OTP)

\(dqdebug\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 7.0
.INDENT 3.5
The returned value will be the JSON of the value, which may be a string
or numeric value, or an array or object. Some client environments may
not parse simple strings or numeric values as valid JSON.
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B PUT /_node/{node\-name}/_config/{section}/{key}
Updates a configuration value. The new value should be supplied in the
request body in the corresponding JSON format. If you are setting a string
value, you must supply a valid JSON string. In response CouchDB sends old
value for target section key.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBsection\fP – Configuration section name
.IP \(bu 2
\fBkey\fP – Configuration option name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.IP \(bu 2
\fI\%Content\-Type\fP – \fIapplication/json\fP
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid JSON request body
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.IP \(bu 2
\fI\%500 Internal Server Error\fP – Error setting configuration
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
PUT /_node/nonode@nohost/_config/log/level HTTP/1.1
Accept: application/json
Content\-Length: 7
Content\-Type: application/json
Host: localhost:5984

\(dqinfo\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 8
Content\-Type: application/json
Date: Sat, 10 Aug 2013 12:12:59 GMT
Server: CouchDB (Erlang/OTP)

\(dqdebug\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B DELETE /_node/{node\-name}/_config/{section}/{key}
Deletes a configuration value. The returned JSON will be the value of the
configuration parameter before it was deleted.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBsection\fP – Configuration section name
.IP \(bu 2
\fBkey\fP – Configuration option name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.IP \(bu 2
\fI\%404 Not Found\fP – Specified configuration option not found
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
DELETE /_node/nonode@nohost/_config/log/level HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 7
Content\-Type: application/json
Date: Sat, 10 Aug 2013 12:29:03 GMT
Server: CouchDB (Erlang/OTP)

\(dqinfo\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/_node/{node\-name}/_config/_reload\fP
.sp
New in version 3.0.

.INDENT 0.0
.TP
.B POST /_node/{node\-name}/_config/_reload
Reloads the configuration from disk. This has a side effect of
flushing any in\-memory configuration changes that have not been
committed to disk.
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /_node/nonode@nohost/_config/_reload HTTP/1.1
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 12
Content\-Type: application/json
Date: Tues, 21 Jan 2020 11:09:35
Server: CouchDB/3.0.0 (Erlang OTP)

{\(dqok\(dq:true}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS Databases
.sp
The Database endpoint provides an interface to an entire database with in
CouchDB. These are database\-level, rather than document\-level requests.
.sp
For all these requests, the database name within the URL path
should be the database name that you wish to perform the operation on.
For example, to obtain the meta information for the database
\fBrecipes\fP, you would use the HTTP request:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
For clarity, the form below is used in the URL paths:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /db
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Where \fBdb\fP is the name of any database.
.SS \fB/db\fP
.INDENT 0.0
.TP
.B HEAD /{db}
Returns the HTTP Headers containing a minimal amount of information
about the specified database. Since the response body is empty, using the
HEAD method is a lightweight way to check if the database exists already or
not.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Database exists
.IP \(bu 2
\fI\%404 Not Found\fP – Requested database not found
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HEAD /test HTTP/1.1
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Mon, 12 Aug 2013 01:27:41 GMT
Server: CouchDB (Erlang/OTP)
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B GET /{db}
Gets information about the specified database.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBcluster.n\fP (\fInumber\fP) – Replicas. The number of copies of every document.
.IP \(bu 2
\fBcluster.q\fP (\fInumber\fP) – Shards. The number of range partitions.
.IP \(bu 2
\fBcluster.r\fP (\fInumber\fP) – Read quorum. The number of consistent copies
of a document that need to be read before a successful reply.
.IP \(bu 2
\fBcluster.w\fP (\fInumber\fP) – Write quorum. The number of copies of a document
that need to be written before a successful reply.
.IP \(bu 2
\fBcompact_running\fP (\fIboolean\fP) – Set to \fBtrue\fP if the database compaction
routine is operating on this database.
.IP \(bu 2
\fBdb_name\fP (\fIstring\fP) – The name of the database.
.IP \(bu 2
\fBdisk_format_version\fP (\fInumber\fP) – The version of the physical format used
for the data when it is stored on disk.
.IP \(bu 2
\fBdoc_count\fP (\fInumber\fP) – A count of the documents in the specified
database.
.IP \(bu 2
\fBdoc_del_count\fP (\fInumber\fP) – Number of deleted documents
.IP \(bu 2
\fBinstance_start_time\fP (\fIstring\fP) – Always \fB\(dq0\(dq\fP\&. (Returned for legacy
reasons.)
.IP \(bu 2
\fBpurge_seq\fP (\fIstring\fP) – An opaque string that describes the purge state
of the database. Do not rely on this string for counting the number
of purge operations.
.IP \(bu 2
\fBsizes.active\fP (\fInumber\fP) – The size of live data inside the database, in
bytes.
.IP \(bu 2
\fBsizes.external\fP (\fInumber\fP) – The uncompressed size of database contents
in bytes.
.IP \(bu 2
\fBsizes.file\fP (\fInumber\fP) – The size of the database file on disk in bytes.
Views indexes are not included in the calculation.
.IP \(bu 2
\fBupdate_seq\fP (\fIstring\fP) – An opaque string that describes the state
of the database. Do not rely on this string for counting the number
of updates.
.IP \(bu 2
\fBprops.partitioned\fP (\fIboolean\fP) – (optional) If present and true, this
indicates that the database is partitioned.
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%404 Not Found\fP – Requested database not found
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /receipts HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 258
Content\-Type: application/json
Date: Mon, 12 Aug 2013 01:38:57 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqcluster\(dq: {
        \(dqn\(dq: 3,
        \(dqq\(dq: 8,
        \(dqr\(dq: 2,
        \(dqw\(dq: 2
    },
    \(dqcompact_running\(dq: false,
    \(dqdb_name\(dq: \(dqreceipts\(dq,
    \(dqdisk_format_version\(dq: 6,
    \(dqdoc_count\(dq: 6146,
    \(dqdoc_del_count\(dq: 64637,
    \(dqinstance_start_time\(dq: \(dq0\(dq,
    \(dqprops\(dq: {},
    \(dqpurge_seq\(dq: 0,
    \(dqsizes\(dq: {
        \(dqactive\(dq: 65031503,
        \(dqexternal\(dq: 66982448,
        \(dqfile\(dq: 137433211
    },
    \(dqupdate_seq\(dq: \(dq292786\-g1AAAAF...\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B PUT /{db}
Creates a new database. The database name \fB{db}\fP must be composed by
following next rules:
.INDENT 7.0
.IP \(bu 2
Name must begin with a lowercase letter (\fBa\-z\fP)
.IP \(bu 2
Lowercase characters (\fBa\-z\fP)
.IP \(bu 2
Digits (\fB0\-9\fP)
.IP \(bu 2
Any of the characters \fB_\fP, \fB$\fP, \fB(\fP, \fB)\fP, \fB+\fP, \fB\-\fP, and
\fB/\fP\&.
.UNINDENT
.sp
If you’re familiar with \fI\%Regular Expressions\fP, the rules above could be
written as \fB^[a\-z][a\-z0\-9_$()+/\-]*$\fP\&.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBq\fP (\fIinteger\fP) – Shards, aka the number of range partitions. Default is
8, unless overridden in the \fI\%cluster config\fP\&.
.IP \(bu 2
\fBn\fP (\fIinteger\fP) – Replicas. The number of copies of the database in the
cluster. The default is 3, unless overridden in the
\fI\%cluster config\fP .
.IP \(bu 2
\fBpartitioned\fP (\fIboolean\fP) – Whether to create a partitioned database.
Default is false.
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.IP \(bu 2
\fI\%Location\fP – Database URI location
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBok\fP (\fIboolean\fP) – Operation status. Available in case of success
.IP \(bu 2
\fBerror\fP (\fIstring\fP) – Error type. Available if response code is \fB4xx\fP
.IP \(bu 2
\fBreason\fP (\fIstring\fP) – Error description. Available if response code is
\fB4xx\fP
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%201 Created\fP – Database created successfully (quorum is met)
.IP \(bu 2
\fI\%202 Accepted\fP – Accepted (at least by one node)
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid database name
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.IP \(bu 2
\fI\%412 Precondition Failed\fP – Database already exists
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
PUT /db HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Cache\-Control: must\-revalidate
Content\-Length: 12
Content\-Type: application/json
Date: Mon, 12 Aug 2013 08:01:45 GMT
Location: http://localhost:5984/db
Server: CouchDB (Erlang/OTP)

{
    \(dqok\(dq: true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If we repeat the same request to CouchDB, it will response with \fB412\fP
since the database already exists:
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
PUT /db HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 412 Precondition Failed
Cache\-Control: must\-revalidate
Content\-Length: 95
Content\-Type: application/json
Date: Mon, 12 Aug 2013 08:01:16 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqerror\(dq: \(dqfile_exists\(dq,
    \(dqreason\(dq: \(dqThe database could not be created, the file already exists.\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If an invalid database name is supplied, CouchDB returns response with
\fB400\fP:
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
PUT /_db HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 400 Bad Request
Cache\-Control: must\-revalidate
Content\-Length: 194
Content\-Type: application/json
Date: Mon, 12 Aug 2013 08:02:10 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqerror\(dq: \(dqillegal_database_name\(dq,
    \(dqreason\(dq: \(dqName: \(aq_db\(aq. Only lowercase characters (a\-z), digits (0\-9), and any of the characters _, $, (, ), +, \-, and / are allowed. Must begin with a letter.\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B DELETE /{db}
Deletes the specified database, and all the documents and attachments
contained within it.
.sp
\fBNOTE:\fP
.INDENT 7.0
.INDENT 3.5
To avoid deleting a database, CouchDB will respond with the HTTP status
code 400 when the request URL includes a ?rev= parameter. This suggests
that one wants to delete a document but forgot to add the document id
to the URL.
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBok\fP (\fIboolean\fP) – Operation status
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Database removed successfully (quorum is met and database is deleted by at least one node)
.IP \(bu 2
\fI\%202 Accepted\fP – Accepted (deleted by at least one of the nodes, quorum is not met yet)
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid database name or forgotten document id by accident
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.IP \(bu 2
\fI\%404 Not Found\fP – Database doesn’t exist or invalid database name
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
DELETE /db HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 12
Content\-Type: application/json
Date: Mon, 12 Aug 2013 08:54:00 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqok\(dq: true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B POST /{db}
Creates a new document in the specified database, using the supplied JSON
document structure.
.sp
If the JSON structure includes the \fB_id\fP field, then the document will be
created with the specified document ID.
.sp
If the \fB_id\fP field is not specified, a new unique ID will be generated,
following whatever UUID algorithm is configured for that server.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.IP \(bu 2
\fI\%Content\-Type\fP – \fIapplication/json\fP
.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBbatch\fP (\fIstring\fP) – Stores document in \fI\%batch mode\fP Possible values: \fBok\fP\&. \fIOptional\fP
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.IP \(bu 2
\fI\%Location\fP – Document’s URI
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBid\fP (\fIstring\fP) – Document ID
.IP \(bu 2
\fBok\fP (\fIboolean\fP) – Operation status
.IP \(bu 2
\fBrev\fP (\fIstring\fP) – Revision info
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%201 Created\fP – Document created and stored on disk
.IP \(bu 2
\fI\%202 Accepted\fP – Document data accepted, but not yet stored on disk
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid database name
.IP \(bu 2
\fI\%401 Unauthorized\fP – Write privileges required
.IP \(bu 2
\fI\%404 Not Found\fP – Database doesn’t exist
.IP \(bu 2
\fI\%409 Conflict\fP – A Conflicting Document with same ID already exists
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /db HTTP/1.1
Accept: application/json
Content\-Length: 81
Content\-Type: application/json

{
    \(dqservings\(dq: 4,
    \(dqsubtitle\(dq: \(dqDelicious with fresh bread\(dq,
    \(dqtitle\(dq: \(dqFish Stew\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Cache\-Control: must\-revalidate
Content\-Length: 95
Content\-Type: application/json
Date: Tue, 13 Aug 2013 15:19:25 GMT
Location: http://localhost:5984/db/ab39fe0993049b84cfa81acd6ebad09d
Server: CouchDB (Erlang/OTP)

{
    \(dqid\(dq: \(dqab39fe0993049b84cfa81acd6ebad09d\(dq,
    \(dqok\(dq: true,
    \(dqrev\(dq: \(dq1\-9c65296036141e575d32ba9c034dd3ee\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS Specifying the Document ID
.sp
The document ID can be specified by including the \fB_id\fP field in the
JSON of the submitted record. The following request will create the same
document with the ID \fBFishStew\fP\&.
.INDENT 0.0
.INDENT 3.5
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST /db HTTP/1.1
Accept: application/json
Content\-Length: 98
Content\-Type: application/json

{
    \(dq_id\(dq: \(dqFishStew\(dq,
    \(dqservings\(dq: 4,
    \(dqsubtitle\(dq: \(dqDelicious with fresh bread\(dq,
    \(dqtitle\(dq: \(dqFish Stew\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Cache\-Control: must\-revalidate
Content\-Length: 71
Content\-Type: application/json
Date: Tue, 13 Aug 2013 15:19:25 GMT
ETag: \(dq1\-9c65296036141e575d32ba9c034dd3ee\(dq
Location: http://localhost:5984/db/FishStew
Server: CouchDB (Erlang/OTP)

{
    \(dqid\(dq: \(dqFishStew\(dq,
    \(dqok\(dq: true,
    \(dqrev\(dq: \(dq1\-9c65296036141e575d32ba9c034dd3ee\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Batch Mode Writes
.sp
You can write documents to the database at a higher rate by using the batch
option. This collects document writes together in memory (on a per\-user basis)
before they are committed to disk. This increases the risk of the documents not
being stored in the event of a failure, since the documents are not written to
disk immediately.
.sp
Batch mode is not suitable for critical data, but may be ideal for applications
such as log data, when the risk of some data loss due to a crash is acceptable.
.sp
To use batch mode, append the \fBbatch=ok\fP query argument to the URL of a
\fI\%POST /{db}\fP, \fI\%PUT /{db}/{docid}\fP, or \fI\%DELETE /{db}/{docid}\fP request. The
CouchDB server will respond with an HTTP \fI\%202 Accepted\fP response code
immediately.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Creating or updating documents with batch mode doesn’t guarantee that all
documents will be successfully stored on disk. For example, individual
documents may not be saved due to conflicts, rejection by
\fI\%validation function\fP or by other reasons, even if overall
the batch was successfully submitted.
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST /db?batch=ok HTTP/1.1
Accept: application/json
Content\-Length: 98
Content\-Type: application/json

{
    \(dq_id\(dq: \(dqFishStew\(dq,
    \(dqservings\(dq: 4,
    \(dqsubtitle\(dq: \(dqDelicious with fresh bread\(dq,
    \(dqtitle\(dq: \(dqFish Stew\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 202 Accepted
Cache\-Control: must\-revalidate
Content\-Length: 28
Content\-Type: application/json
Date: Tue, 13 Aug 2013 15:19:25 GMT
Location: http://localhost:5984/db/FishStew
Server: CouchDB (Erlang/OTP)

{
    \(dqid\(dq: \(dqFishStew\(dq,
    \(dqok\(dq: true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS \fB/{db}/_all_docs\fP
.INDENT 0.0
.TP
.B GET /{db}/_all_docs
Executes the built\-in \fI_all_docs\fP \fI\%view\fP, returning all of the
documents in the database.  With the exception of the URL parameters
(described below), this endpoint works identically to any other view. Refer
to the \fI\%view endpoint\fP documentation for a complete
description of the available query parameters and the format of the returned
data.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – \fIapplication/json\fP
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%404 Not Found\fP – Requested database not found
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /db/_all_docs HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Sat, 10 Aug 2013 16:22:56 GMT
ETag: \(dq1W2DJUZFZSZD9K78UFA3GZWB4\(dq
Server: CouchDB (Erlang/OTP)
Transfer\-Encoding: chunked

{
    \(dqoffset\(dq: 0,
    \(dqrows\(dq: [
        {
            \(dqid\(dq: \(dq16e458537602f5ef2a710089dffd9453\(dq,
            \(dqkey\(dq: \(dq16e458537602f5ef2a710089dffd9453\(dq,
            \(dqvalue\(dq: {
                \(dqrev\(dq: \(dq1\-967a00dff5e02add41819138abb3284d\(dq
            }
        },
        {
            \(dqid\(dq: \(dqa4c51cdfa2069f3e905c431114001aff\(dq,
            \(dqkey\(dq: \(dqa4c51cdfa2069f3e905c431114001aff\(dq,
            \(dqvalue\(dq: {
                \(dqrev\(dq: \(dq1\-967a00dff5e02add41819138abb3284d\(dq
            }
        },
        {
            \(dqid\(dq: \(dqa4c51cdfa2069f3e905c4311140034aa\(dq,
            \(dqkey\(dq: \(dqa4c51cdfa2069f3e905c4311140034aa\(dq,
            \(dqvalue\(dq: {
                \(dqrev\(dq: \(dq5\-6182c9c954200ab5e3c6bd5e76a1549f\(dq
            }
        },
        {
            \(dqid\(dq: \(dqa4c51cdfa2069f3e905c431114003597\(dq,
            \(dqkey\(dq: \(dqa4c51cdfa2069f3e905c431114003597\(dq,
            \(dqvalue\(dq: {
                \(dqrev\(dq: \(dq2\-7051cbe5c8faecd085a3fa619e6e6337\(dq
            }
        },
        {
            \(dqid\(dq: \(dqf4ca7773ddea715afebc4b4b15d4f0b3\(dq,
            \(dqkey\(dq: \(dqf4ca7773ddea715afebc4b4b15d4f0b3\(dq,
            \(dqvalue\(dq: {
                \(dqrev\(dq: \(dq2\-7051cbe5c8faecd085a3fa619e6e6337\(dq
            }
        }
    ],
    \(dqtotal_rows\(dq: 5
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B POST /{db}/_all_docs
\fI\%POST\fP \fI_all_docs\fP functionality supports identical parameters and behavior
as specified in the \fI\%GET /{db}/_all_docs\fP API but allows for the query string
parameters to be supplied as keys in a JSON object in the body of the \fIPOST\fP request.
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /db/_all_docs HTTP/1.1
Accept: application/json
Content\-Length: 70
Content\-Type: application/json
Host: localhost:5984

{
    \(dqkeys\(dq : [
        \(dqZingylemontart\(dq,
        \(dqYogurtraita\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqtotal_rows\(dq : 2666,
    \(dqrows\(dq : [
        {
            \(dqvalue\(dq : {
                \(dqrev\(dq : \(dq1\-a3544d296de19e6f5b932ea77d886942\(dq
            },
            \(dqid\(dq : \(dqZingylemontart\(dq,
            \(dqkey\(dq : \(dqZingylemontart\(dq
        },
        {
            \(dqvalue\(dq : {
                \(dqrev\(dq : \(dq1\-91635098bfe7d40197a1b98d7ee085fc\(dq
            },
            \(dqid\(dq : \(dqYogurtraita\(dq,
            \(dqkey\(dq : \(dqYogurtraita\(dq
        }
    ],
    \(dqoffset\(dq : 0
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/{db}/_design_docs\fP
.sp
New in version 2.2.

.INDENT 0.0
.TP
.B GET /{db}/_design_docs
Returns a JSON structure of all of the design documents in a given
database. The information is returned as a JSON structure containing meta
information about the return structure, including a list of all design
documents and basic contents, consisting the ID, revision and key. The key
is the design document’s \fB_id\fP\&.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBconflicts\fP (\fIboolean\fP) – Includes \fIconflicts\fP information in response.
Ignored if \fIinclude_docs\fP isn’t \fBtrue\fP\&. Default is \fBfalse\fP\&.
.IP \(bu 2
\fBdescending\fP (\fIboolean\fP) – Return the design documents in descending by
key order. Default is \fBfalse\fP\&.
.IP \(bu 2
\fBendkey\fP (\fIstring\fP) – Stop returning records when the specified key is
reached. \fIOptional\fP\&.
.IP \(bu 2
\fBend_key\fP (\fIstring\fP) – Alias for \fIendkey\fP param.
.IP \(bu 2
\fBendkey_docid\fP (\fIstring\fP) – Stop returning records when the specified
design document ID is reached. \fIOptional\fP\&.
.IP \(bu 2
\fBend_key_doc_id\fP (\fIstring\fP) – Alias for \fIendkey_docid\fP param.
.IP \(bu 2
\fBinclude_docs\fP (\fIboolean\fP) – Include the full content of the design
documents in the return. Default is \fBfalse\fP\&.
.IP \(bu 2
\fBinclusive_end\fP (\fIboolean\fP) – Specifies whether the specified end key
should be included in the result. Default is \fBtrue\fP\&.
.IP \(bu 2
\fBkey\fP (\fIstring\fP) – Return only design documents that match the specified
key. \fIOptional\fP\&.
.IP \(bu 2
\fBkeys\fP (\fIstring\fP) – Return only design documents that match the specified
keys. \fIOptional\fP\&.
.IP \(bu 2
\fBlimit\fP (\fInumber\fP) – Limit the number of the returned design documents to
the specified number. \fIOptional\fP\&.
.IP \(bu 2
\fBskip\fP (\fInumber\fP) – Skip this number of records before starting to return
the results. Default is \fB0\fP\&.
.IP \(bu 2
\fBstartkey\fP (\fIstring\fP) – Return records starting with the specified key.
\fIOptional\fP\&.
.IP \(bu 2
\fBstart_key\fP (\fIstring\fP) – Alias for \fIstartkey\fP param.
.IP \(bu 2
\fBstartkey_docid\fP (\fIstring\fP) – Return records starting with the specified
design document ID. \fIOptional\fP\&.
.IP \(bu 2
\fBstart_key_doc_id\fP (\fIstring\fP) – Alias for \fIstartkey_docid\fP param.
.IP \(bu 2
\fBupdate_seq\fP (\fIboolean\fP) – Response includes an \fBupdate_seq\fP value
indicating which sequence id of the underlying database the view
reflects. Default is \fBfalse\fP\&.
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.IP \(bu 2
\fI\%ETag\fP – Response signature
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBoffset\fP (\fInumber\fP) – Offset where the design document list started
.IP \(bu 2
\fBrows\fP (\fIarray\fP) – Array of view row objects. By default the information
returned contains only the design document ID and revision.
.IP \(bu 2
\fBtotal_rows\fP (\fInumber\fP) – Number of design documents in the database. Note
that this is not the number of rows returned in the actual query.
.IP \(bu 2
\fBupdate_seq\fP (\fInumber\fP) – Current update sequence for the database
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%404 Not Found\fP – Requested database not found
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /db/_design_docs HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Sat, 23 Dec 2017 16:22:56 GMT
ETag: \(dq1W2DJUZFZSZD9K78UFA3GZWB4\(dq
Server: CouchDB (Erlang/OTP)
Transfer\-Encoding: chunked

{
    \(dqoffset\(dq: 0,
    \(dqrows\(dq: [
        {
            \(dqid\(dq: \(dq_design/ddoc01\(dq,
            \(dqkey\(dq: \(dq_design/ddoc01\(dq,
            \(dqvalue\(dq: {
                \(dqrev\(dq: \(dq1\-7407569d54af5bc94c266e70cbf8a180\(dq
            }
        },
        {
            \(dqid\(dq: \(dq_design/ddoc02\(dq,
            \(dqkey\(dq: \(dq_design/ddoc02\(dq,
            \(dqvalue\(dq: {
                \(dqrev\(dq: \(dq1\-d942f0ce01647aa0f46518b213b5628e\(dq
            }
        },
        {
            \(dqid\(dq: \(dq_design/ddoc03\(dq,
            \(dqkey\(dq: \(dq_design/ddoc03\(dq,
            \(dqvalue\(dq: {
                \(dqrev\(dq: \(dq1\-721fead6e6c8d811a225d5a62d08dfd0\(dq
            }
        },
        {
            \(dqid\(dq: \(dq_design/ddoc04\(dq,
            \(dqkey\(dq: \(dq_design/ddoc04\(dq,
            \(dqvalue\(dq: {
                \(dqrev\(dq: \(dq1\-32c76b46ca61351c75a84fbcbceece2f\(dq
            }
        },
        {
            \(dqid\(dq: \(dq_design/ddoc05\(dq,
            \(dqkey\(dq: \(dq_design/ddoc05\(dq,
            \(dqvalue\(dq: {
                \(dqrev\(dq: \(dq1\-af856babf9cf746b48ae999645f9541e\(dq
            }
        }
    ],
    \(dqtotal_rows\(dq: 5
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B POST /{db}/_design_docs
\fI\%POST\fP \fI_design_docs\fP functionality supports identical parameters and behavior
as specified in the \fI\%GET /{db}/_design_docs\fP API but allows for the query string
parameters to be supplied as keys in a JSON object in the body of the \fIPOST\fP request.
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /db/_design_docs HTTP/1.1
Accept: application/json
Content\-Length: 70
Content\-Type: application/json
Host: localhost:5984

{
    \(dqkeys\(dq : [
        \(dq_design/ddoc02\(dq,
        \(dq_design/ddoc05\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The returned JSON is the all documents structure, but with only the
selected keys in the output:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqtotal_rows\(dq : 5,
    \(dqrows\(dq : [
        {
            \(dqvalue\(dq : {
                \(dqrev\(dq : \(dq1\-d942f0ce01647aa0f46518b213b5628e\(dq
            },
            \(dqid\(dq : \(dq_design/ddoc02\(dq,
            \(dqkey\(dq : \(dq_design/ddoc02\(dq
        },
        {
            \(dqvalue\(dq : {
                \(dqrev\(dq : \(dq1\-af856babf9cf746b48ae999645f9541e\(dq
            },
            \(dqid\(dq : \(dq_design/ddoc05\(dq,
            \(dqkey\(dq : \(dq_design/ddoc05\(dq
        }
    ],
    \(dqoffset\(dq : 0
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS Sending multiple queries to a database
.sp
New in version 2.2.

.INDENT 0.0
.TP
.B POST /{db}/_all_docs/queries
Executes multiple specified built\-in view queries of all documents in this
database. This enables you to request multiple queries in a single
request, in place of multiple \fI\%POST /{db}/_all_docs\fP requests.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Request JSON Object
.INDENT 7.0
.IP \(bu 2
\fBqueries\fP – An array of query objects with fields for the
parameters of each individual view query to be executed. The field names
and their meaning are the same as the query parameters of a
regular \fI\%_all_docs request\fP\&.
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.IP \(bu 2
\fI\%ETag\fP – Response signature
.IP \(bu 2
\fI\%Transfer\-Encoding\fP – \fBchunked\fP
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBresults\fP (\fIarray\fP) – An array of result objects \- one for each query. Each
result object contains the same fields as the response to a regular
\fI\%_all_docs request\fP\&.
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid request
.IP \(bu 2
\fI\%401 Unauthorized\fP – Read permission required
.IP \(bu 2
\fI\%404 Not Found\fP – Specified database is missing
.IP \(bu 2
\fI\%500 Internal Server Error\fP – Query execution error
.UNINDENT
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST /db/_all_docs/queries HTTP/1.1
Content\-Type: application/json
Accept: application/json
Host: localhost:5984

{
    \(dqqueries\(dq: [
        {
            \(dqkeys\(dq: [
                \(dqmeatballs\(dq,
                \(dqspaghetti\(dq
            ]
        },
        {
            \(dqlimit\(dq: 3,
            \(dqskip\(dq: 2
        }
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Wed, 20 Dec 2017 11:17:07 GMT
ETag: \(dq1H8RGBCK3ABY6ACDM7ZSC30QK\(dq
Server: CouchDB (Erlang/OTP)
Transfer\-Encoding: chunked

{
    \(dqresults\(dq : [
        {
            \(dqrows\(dq: [
                {
                    \(dqid\(dq: \(dqmeatballs\(dq,
                    \(dqkey\(dq: \(dqmeatballs\(dq,
                    \(dqvalue\(dq: 1
                },
                {
                    \(dqid\(dq: \(dqspaghetti\(dq,
                    \(dqkey\(dq: \(dqspaghetti\(dq,
                    \(dqvalue\(dq: 1
                }
            ],
            \(dqtotal_rows\(dq: 3
        },
        {
            \(dqoffset\(dq : 2,
            \(dqrows\(dq : [
                {
                    \(dqid\(dq : \(dqAdukiandorangecasserole\-microwave\(dq,
                    \(dqkey\(dq : \(dqAduki and orange casserole \- microwave\(dq,
                    \(dqvalue\(dq : [
                        null,
                        \(dqAduki and orange casserole \- microwave\(dq
                    ]
                },
                {
                    \(dqid\(dq : \(dqAioli\-garlicmayonnaise\(dq,
                    \(dqkey\(dq : \(dqAioli \- garlic mayonnaise\(dq,
                    \(dqvalue\(dq : [
                        null,
                        \(dqAioli \- garlic mayonnaise\(dq
                    ]
                },
                {
                    \(dqid\(dq : \(dqAlabamapeanutchicken\(dq,
                    \(dqkey\(dq : \(dqAlabama peanut chicken\(dq,
                    \(dqvalue\(dq : [
                        null,
                        \(dqAlabama peanut chicken\(dq
                    ]
                }
            ],
            \(dqtotal_rows\(dq : 2667
        }
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
The multiple queries are also supported in /db/_local_docs/queries and
/db/_design_docs/queries (similar to /db/_all_docs/queries).
.UNINDENT
.UNINDENT
.SS \fB/{db}/_bulk_get\fP
.INDENT 0.0
.TP
.B POST /{db}/_bulk_get
This method can be called to query several documents in bulk. It is well
suited for fetching a specific revision of documents, as replicators do for
example, or for getting revision history.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fImultipart/related\fP
.IP \(bu 2
\fImultipart/mixed\fP
.UNINDENT

.IP \(bu 2
\fI\%Content\-Type\fP – \fIapplication/json\fP
.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBrevs\fP (\fIboolean\fP) – Give the revisions history
.UNINDENT
.TP
.B Request JSON Object
.INDENT 7.0
.IP \(bu 2
\fBdocs\fP (\fIarray\fP) – List of document objects, with \fBid\fP, and optionally
\fBrev\fP and \fBatts_since\fP
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBresults\fP (\fIobject\fP) – an array of results for each requested document/rev
pair. \fBid\fP key lists the requested document ID, \fBdocs\fP contains a
single\-item array of objects, each of which has either an \fBerror\fP key and
value describing the error, or \fBok\fP key and associated value of the
requested document, with the additional \fB_revisions\fP property that lists
the parent revisions if \fBrevs=true\fP\&.
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%400 Bad Request\fP – The request provided invalid JSON data or invalid query parameter
.IP \(bu 2
\fI\%401 Unauthorized\fP – Read permission required
.IP \(bu 2
\fI\%404 Not Found\fP – Invalid database name
.IP \(bu 2
\fI\%415 Unsupported Media Type\fP – Bad \fI\%Content\-Type\fP value
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /db/_bulk_get HTTP/1.1
Accept: application/json
Content\-Type:application/json
Host: localhost:5984

{
    \(dqdocs\(dq: [
        {
            \(dqid\(dq: \(dqfoo\(dq
            \(dqrev\(dq: \(dq4\-753875d51501a6b1883a9d62b4d33f91\(dq,
        },
        {
            \(dqid\(dq: \(dqfoo\(dq
            \(dqrev\(dq: \(dq1\-4a7e4ae49c4366eaed8edeaea8f784ad\(dq,
        },
        {
            \(dqid\(dq: \(dqbar\(dq,
        }
        {
            \(dqid\(dq: \(dqbaz\(dq,
        }
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Mon, 19 Mar 2018 15:27:34 GMT
Server: CouchDB (Erlang/OTP)

{
  \(dqresults\(dq: [
    {
      \(dqid\(dq: \(dqfoo\(dq,
      \(dqdocs\(dq: [
        {
          \(dqok\(dq: {
            \(dq_id\(dq: \(dqfoo\(dq,
            \(dq_rev\(dq: \(dq4\-753875d51501a6b1883a9d62b4d33f91\(dq,
            \(dqvalue\(dq: \(dqthis is foo\(dq,
            \(dq_revisions\(dq: {
              \(dqstart\(dq: 4,
              \(dqids\(dq: [
                \(dq753875d51501a6b1883a9d62b4d33f91\(dq,
                \(dqefc54218773c6acd910e2e97fea2a608\(dq,
                \(dq2ee767305024673cfb3f5af037cd2729\(dq,
                \(dq4a7e4ae49c4366eaed8edeaea8f784ad\(dq
              ]
            }
          }
        }
      ]
    },
    {
      \(dqid\(dq: \(dqfoo\(dq,
      \(dqdocs\(dq: [
        {
          \(dqok\(dq: {
            \(dq_id\(dq: \(dqfoo\(dq,
            \(dq_rev\(dq: \(dq1\-4a7e4ae49c4366eaed8edeaea8f784ad\(dq,
            \(dqvalue\(dq: \(dqthis is the first revision of foo\(dq,
            \(dq_revisions\(dq: {
              \(dqstart\(dq: 1,
              \(dqids\(dq: [
                \(dq4a7e4ae49c4366eaed8edeaea8f784ad\(dq
              ]
            }
          }
        }
      ]
    },
    {
      \(dqid\(dq: \(dqbar\(dq,
      \(dqdocs\(dq: [
        {
          \(dqok\(dq: {
            \(dq_id\(dq: \(dqbar\(dq,
            \(dq_rev\(dq: \(dq2\-9b71d36dfdd9b4815388eb91cc8fb61d\(dq,
            \(dqbaz\(dq: true,
            \(dq_revisions\(dq: {
              \(dqstart\(dq: 2,
              \(dqids\(dq: [
                \(dq9b71d36dfdd9b4815388eb91cc8fb61d\(dq,
                \(dq309651b95df56d52658650fb64257b97\(dq
              ]
            }
          }
        }
      ]
    },
    {
      \(dqid\(dq: \(dqbaz\(dq,
      \(dqdocs\(dq: [
        {
          \(dqerror\(dq: {
            \(dqid\(dq: \(dqbaz\(dq,
            \(dqrev\(dq: \(dqundefined\(dq,
            \(dqerror\(dq: \(dqnot_found\(dq,
            \(dqreason\(dq: \(dqmissing\(dq
          }
        }
      ]
    }
  ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Example response with a conflicted document:
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /db/_bulk_get HTTP/1.1
Accept: application/json
Content\-Type:application/json
Host: localhost:5984

{
    \(dqdocs\(dq: [
        {
            \(dqid\(dq: \(dqa\(dq
        }
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Mon, 19 Mar 2018 15:27:34 GMT
Server: CouchDB (Erlang/OTP)

{
  \(dqresults\(dq: [
    {
      \(dqid\(dq: \(dqa\(dq,
      \(dqdocs\(dq: [
        {
          \(dqok\(dq: {
            \(dq_id\(dq: \(dqa\(dq,
            \(dq_rev\(dq: \(dq1\-23202479633c2b380f79507a776743d5\(dq,
            \(dqa\(dq: 1
          }
        },
        {
          \(dqok\(dq: {
            \(dq_id\(dq: \(dqa\(dq,
            \(dq_rev\(dq: \(dq1\-967a00dff5e02add41819138abb3284d\(dq
          }
        }
      ]
    }
  ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/{db}/_bulk_docs\fP
.INDENT 0.0
.TP
.B POST /{db}/_bulk_docs
The bulk document API allows you to create and update multiple documents
at the same time within a single request. The basic operation is similar
to creating or updating a single document, except that you batch the
document structure and information.
.sp
When creating new documents the document ID (\fB_id\fP) is optional.
.sp
For updating existing documents, you must provide the document ID, revision
information (\fB_rev\fP), and new document values.
.sp
In case of batch deleting documents all fields as document ID, revision
information and deletion status (\fB_deleted\fP) are required.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.IP \(bu 2
\fI\%Content\-Type\fP – \fIapplication/json\fP
.UNINDENT
.TP
.B Request JSON Object
.INDENT 7.0
.IP \(bu 2
\fBdocs\fP (\fIarray\fP) – List of documents objects
.IP \(bu 2
\fBnew_edits\fP (\fIboolean\fP) – If \fBfalse\fP, prevents the database from
assigning them new revision IDs. Default is \fBtrue\fP\&. \fIOptional\fP
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Array of Objects
.INDENT 7.0
.IP \(bu 2
\fBid\fP (\fIstring\fP) – Document ID
.IP \(bu 2
\fBrev\fP (\fIstring\fP) – New document revision token. Available
if document has saved without errors. \fIOptional\fP
.IP \(bu 2
\fBerror\fP (\fIstring\fP) – Error type. \fIOptional\fP
.IP \(bu 2
\fBreason\fP (\fIstring\fP) – Error reason. \fIOptional\fP
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%201 Created\fP – Document(s) have been created or updated
.IP \(bu 2
\fI\%400 Bad Request\fP – The request provided invalid JSON data
.IP \(bu 2
\fI\%404 Not Found\fP – Requested database not found
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /db/_bulk_docs HTTP/1.1
Accept: application/json
Content\-Length: 109
Content\-Type:application/json
Host: localhost:5984

{
    \(dqdocs\(dq: [
        {
            \(dq_id\(dq: \(dqFishStew\(dq
        },
        {
            \(dq_id\(dq: \(dqLambStew\(dq,
            \(dq_rev\(dq: \(dq2\-0786321986194c92dd3b57dfbfc741ce\(dq,
            \(dq_deleted\(dq: true
        }
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Cache\-Control: must\-revalidate
Content\-Length: 144
Content\-Type: application/json
Date: Mon, 12 Aug 2013 00:15:05 GMT
Server: CouchDB (Erlang/OTP)

[
    {
        \(dqok\(dq: true,
        \(dqid\(dq: \(dqFishStew\(dq,
        \(dqrev\(dq:\(dq 1\-967a00dff5e02add41819138abb3284d\(dq
    },
    {
        \(dqok\(dq: true,
        \(dqid\(dq: \(dqLambStew\(dq,
        \(dqrev\(dq: \(dq3\-f9c62b2169d0999103e9f41949090807\(dq
    }
]
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS Inserting Documents in Bulk
.sp
Each time a document is stored or updated in CouchDB, the internal B\-tree
is updated. Bulk insertion provides efficiency gains in both storage space,
and time, by consolidating many of the updates to intermediate B\-tree nodes.
.sp
It is not intended as a way to perform \fBACID\fP\-like transactions in CouchDB,
the only transaction boundary within CouchDB is a single update to a single
database. The constraints are detailed in \fI\%Bulk Documents Transaction Semantics\fP\&.
.sp
To insert documents in bulk into a database you need to supply a JSON
structure with the array of documents that you want to add to the database.
You can either include a document ID, or allow the document ID to be
automatically generated.
.sp
For example, the following update inserts three new documents, two with the
supplied document IDs, and one which will have a document ID generated:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST /source/_bulk_docs HTTP/1.1
Accept: application/json
Content\-Length: 323
Content\-Type: application/json
Host: localhost:5984

{
    \(dqdocs\(dq: [
        {
            \(dq_id\(dq: \(dqFishStew\(dq,
            \(dqservings\(dq: 4,
            \(dqsubtitle\(dq: \(dqDelicious with freshly baked bread\(dq,
            \(dqtitle\(dq: \(dqFishStew\(dq
        },
        {
            \(dq_id\(dq: \(dqLambStew\(dq,
            \(dqservings\(dq: 6,
            \(dqsubtitle\(dq: \(dqServe with a whole meal scone topping\(dq,
            \(dqtitle\(dq: \(dqLambStew\(dq
        },
        {
            \(dqservings\(dq: 8,
            \(dqsubtitle\(dq: \(dqHand\-made dumplings make a great accompaniment\(dq,
            \(dqtitle\(dq: \(dqBeefStew\(dq
        }
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The return type from a bulk insertion will be \fI\%201 Created\fP,
with the content of the returned structure indicating specific success
or otherwise messages on a per\-document basis.
.sp
The return structure from the example above contains a list of the
documents created, here with the combination and their revision IDs:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Cache\-Control: must\-revalidate
Content\-Length: 215
Content\-Type: application/json
Date: Sat, 26 Oct 2013 00:10:39 GMT
Server: CouchDB (Erlang OTP)

[
    {
        \(dqid\(dq: \(dqFishStew\(dq,
        \(dqok\(dq: true,
        \(dqrev\(dq: \(dq1\-6a466d5dfda05e613ba97bd737829d67\(dq
    },
    {
        \(dqid\(dq: \(dqLambStew\(dq,
        \(dqok\(dq: true,
        \(dqrev\(dq: \(dq1\-648f1b989d52b8e43f05aa877092cc7c\(dq
    },
    {
        \(dqid\(dq: \(dq00a271787f89c0ef2e10e88a0c0003f0\(dq,
        \(dqok\(dq: true,
        \(dqrev\(dq: \(dq1\-e4602845fc4c99674f50b1d5a804fdfa\(dq
    }
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
For details of the semantic content and structure of the returned JSON see
\fI\%Bulk Documents Transaction Semantics\fP\&. Conflicts and validation errors when
updating documents in bulk must be handled separately; see
\fI\%Bulk Document Validation and Conflict Errors\fP\&.
.SS Updating Documents in Bulk
.sp
The bulk document update procedure is similar to the insertion
procedure, except that you must specify the document ID and current
revision for every document in the bulk update JSON string.
.sp
For example, you could send the following request:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST /recipes/_bulk_docs HTTP/1.1
Accept: application/json
Content\-Length: 464
Content\-Type: application/json
Host: localhost:5984

{
    \(dqdocs\(dq: [
        {
            \(dq_id\(dq: \(dqFishStew\(dq,
            \(dq_rev\(dq: \(dq1\-6a466d5dfda05e613ba97bd737829d67\(dq,
            \(dqservings\(dq: 4,
            \(dqsubtitle\(dq: \(dqDelicious with freshly baked bread\(dq,
            \(dqtitle\(dq: \(dqFishStew\(dq
        },
        {
            \(dq_id\(dq: \(dqLambStew\(dq,
            \(dq_rev\(dq: \(dq1\-648f1b989d52b8e43f05aa877092cc7c\(dq,
            \(dqservings\(dq: 6,
            \(dqsubtitle\(dq: \(dqServe with a whole meal scone topping\(dq,
            \(dqtitle\(dq: \(dqLambStew\(dq
        },
        {
            \(dq_id\(dq: \(dqBeefStew\(dq,
            \(dq_rev\(dq: \(dq1\-e4602845fc4c99674f50b1d5a804fdfa\(dq,
            \(dqservings\(dq: 8,
            \(dqsubtitle\(dq: \(dqHand\-made dumplings make a great accompaniment\(dq,
            \(dqtitle\(dq: \(dqBeefStew\(dq
        }
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The return structure is the JSON of the updated documents, with the new
revision and ID information:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Cache\-Control: must\-revalidate
Content\-Length: 215
Content\-Type: application/json
Date: Sat, 26 Oct 2013 00:10:39 GMT
Server: CouchDB (Erlang OTP)

[
    {
        \(dqid\(dq: \(dqFishStew\(dq,
        \(dqok\(dq: true,
        \(dqrev\(dq: \(dq2\-2bff94179917f1dec7cd7f0209066fb8\(dq
    },
    {
        \(dqid\(dq: \(dqLambStew\(dq,
        \(dqok\(dq: true,
        \(dqrev\(dq: \(dq2\-6a7aae7ac481aa98a2042718d09843c4\(dq
    },
    {
        \(dqid\(dq: \(dqBeefStew\(dq,
        \(dqok\(dq: true,
        \(dqrev\(dq: \(dq2\-9801936a42f06a16f16c30027980d96f\(dq
    }
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You can optionally delete documents during a bulk update by adding the
\fB_deleted\fP field with a value of \fBtrue\fP to each document ID/revision
combination within the submitted JSON structure.
.sp
The return type from a bulk insertion will be \fI\%201 Created\fP, with the
content of the returned structure indicating specific success or otherwise
messages on a per\-document basis.
.sp
The content and structure of the returned JSON will depend on the transaction
semantics being used for the bulk update; see \fI\%Bulk Documents Transaction Semantics\fP
for more information. Conflicts and validation errors when updating documents
in bulk must be handled separately; see \fI\%Bulk Document Validation and Conflict Errors\fP\&.
.SS Bulk Documents Transaction Semantics
.sp
Bulk document operations are \fBnon\-atomic\fP\&. This means that CouchDB does not
guarantee that any individual document included in the bulk update (or insert)
will be saved when you send the request. The response will contain the list of
documents successfully inserted or updated during the process. In the event of
a crash, some of the documents may have been successfully saved, while others
lost.
.sp
The response structure will indicate whether the document was updated by
supplying the new \fB_rev\fP parameter indicating a new document revision was
created. If the update failed, you will get an \fBerror\fP of type \fBconflict\fP\&.
For example:
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    {
        \(dqid\(dq : \(dqFishStew\(dq,
        \(dqerror\(dq : \(dqconflict\(dq,
        \(dqreason\(dq : \(dqDocument update conflict.\(dq
    },
    {
        \(dqid\(dq : \(dqLambStew\(dq,
        \(dqerror\(dq : \(dqconflict\(dq,
        \(dqreason\(dq : \(dqDocument update conflict.\(dq
    },
    {
        \(dqid\(dq : \(dqBeefStew\(dq,
        \(dqerror\(dq : \(dqconflict\(dq,
        \(dqreason\(dq : \(dqDocument update conflict.\(dq
    }
]
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
In this case no new revision has been created and you will need to submit the
document update, with the correct revision tag, to update the document.
.sp
Replication of documents is independent of the type of insert or update.
The documents and revisions created during a bulk insert or update are
replicated in the same way as any other document.
.SS Bulk Document Validation and Conflict Errors
.sp
The JSON returned by the \fB_bulk_docs\fP operation consists of an array
of JSON structures, one for each document in the original submission.
The returned JSON structure should be examined to ensure that all of the
documents submitted in the original request were successfully added to
the database.
.sp
When a document (or document revision) is not correctly committed to the
database because of an error, you should check the \fBerror\fP field to
determine error type and course of action. Errors will be one of the
following type:
.INDENT 0.0
.IP \(bu 2
\fBconflict\fP
.sp
The document as submitted is in conflict. The new revision will not have been
created and you will need to re\-submit the document to the database.
.sp
Conflict resolution of documents added using the bulk docs interface
is identical to the resolution procedures used when resolving
conflict errors during replication.
.IP \(bu 2
\fBforbidden\fP
.sp
Entries with this error type indicate that the validation routine
applied to the document during submission has returned an error.
.sp
For example, if your \fI\%validation routine\fP includes
the following:
.INDENT 2.0
.INDENT 3.5
.sp
.nf
.ft C
throw({forbidden: \(aqinvalid recipe ingredient\(aq});
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The error response returned will be:
.INDENT 2.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Cache\-Control: must\-revalidate
Content\-Length: 80
Content\-Type: application/json
Date: Sat, 26 Oct 2013 00:05:17 GMT
Server: CouchDB (Erlang OTP)

[
    {
        \(dqid\(dq: \(dqLambStew\(dq,
        \(dqerror\(dq: \(dqforbidden\(dq,
        \(dqreason\(dq: \(dqinvalid recipe ingredient\(dq
    }
]
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/db/_find\fP
.INDENT 0.0
.TP
.B POST /{db}/_find
Find documents using a declarative JSON querying syntax.
Queries will use custom indexes, specified using the \fI\%_index\fP
endpoint, if available.
Otherwise, they use the built\-in \fI\%_all_docs\fP index, which
can be arbitrarily slow.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Request JSON Object
.INDENT 7.0
.IP \(bu 2
\fBselector\fP (\fIjson\fP) – JSON object describing criteria used to select
documents. More information provided in the section on \fI\%selector
syntax\fP\&. \fIRequired\fP
.IP \(bu 2
\fBlimit\fP (\fInumber\fP) – Maximum number of results returned. Default is \fB25\fP\&.
\fIOptional\fP
.IP \(bu 2
\fBskip\fP (\fInumber\fP) – Skip the first ‘n’ results, where ‘n’ is the value
specified. \fIOptional\fP
.IP \(bu 2
\fBsort\fP (\fIjson\fP) – JSON array following \fI\%sort syntax\fP\&.
\fIOptional\fP
.IP \(bu 2
\fBfields\fP (\fIarray\fP) – JSON array specifying which fields of each object
should be returned. If it is omitted, the entire object is returned.
More information provided in the section on \fI\%filtering fields\fP\&. \fIOptional\fP
.IP \(bu 2
\fBuse_index\fP (\fIstring|array\fP) – Instruct a query to use a specific index.
Specified either as \fB\(dq<design_document>\(dq\fP or
\fB[\(dq<design_document>\(dq, \(dq<index_name>\(dq]\fP\&. \fIOptional\fP
.IP \(bu 2
\fBconflicts\fP (\fIboolean\fP) – Include conflicted documents if \fBtrue\fP\&.
Intended use is to easily find conflicted documents, without an
index or view. Default is \fBfalse\fP\&. \fIOptional\fP
.IP \(bu 2
\fBr\fP (\fInumber\fP) – Read quorum needed for the result. This defaults to 1, in
which case the document found in the index is returned. If set to a
higher value, each document is read from at least that many replicas
before it is returned in the results. This is likely to take more time
than using only the document stored locally with the index. \fIOptional,
default: 1\fP
.IP \(bu 2
\fBbookmark\fP (\fIstring\fP) – A string that enables you to specify which page of
results you require. Used for paging through result sets. Every query
returns an opaque string under the \fBbookmark\fP key that can then be
passed back in a query to get the next page of results. If any part of
the selector query changes between requests, the results
are undefined. \fIOptional, default: null\fP
.IP \(bu 2
\fBupdate\fP (\fIboolean\fP) – Whether to update the index prior to returning the
result. Default is \fBtrue\fP\&. \fIOptional\fP
.IP \(bu 2
\fBstable\fP (\fIboolean\fP) – Whether or not the view results should be returned
from a “stable” set of shards. \fIOptional\fP
.IP \(bu 2
\fBstale\fP (\fIstring\fP) – Combination of \fBupdate=false\fP and \fBstable=true\fP
options. Possible options: \fB\(dqok\(dq\fP, \fBfalse\fP (default). \fIOptional\fP
Note that this parameter is deprecated. Use \fBstable\fP and \fBupdate\fP instead.
See \fI\%Views Generation\fP for more details.
.IP \(bu 2
\fBexecution_stats\fP (\fIboolean\fP) – Include
\fI\%execution statistics\fP in the query response.
\fIOptional, default:\fP \fBfalse\fP
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – \fIapplication/json\fP
.IP \(bu 2
\fI\%Transfer\-Encoding\fP – \fBchunked\fP
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBdocs\fP (\fIobject\fP) – Array of documents matching the search. In each matching
document, the fields specified in the \fBfields\fP part of the request
body are listed, along with their values.
.IP \(bu 2
\fBwarning\fP (\fIstring\fP) – Execution warnings
.IP \(bu 2
\fBexecution_stats\fP (\fIobject\fP) – Execution statistics
.IP \(bu 2
\fBbookmark\fP (\fIstring\fP) – An opaque string used for paging. See the
\fBbookmark\fP field in the request (above) for usage details.
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid request
.IP \(bu 2
\fI\%401 Unauthorized\fP – Read permission required
.IP \(bu 2
\fI\%404 Not Found\fP – Requested database not found
.IP \(bu 2
\fI\%500 Internal Server Error\fP – Query execution error
.UNINDENT
.UNINDENT
.UNINDENT
.sp
The \fBlimit\fP and \fBskip\fP values are exactly as you would expect. While
\fBskip\fP exists, it is not intended to be used for paging. The reason is that
the \fBbookmark\fP feature is more efficient.
.INDENT 0.0
.INDENT 3.5
\fBRequest\fP:
.UNINDENT
.UNINDENT
.sp
Example request body for finding documents using an index:
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST /movies/_find HTTP/1.1
Accept: application/json
Content\-Type: application/json
Content\-Length: 168
Host: localhost:5984

{
    \(dqselector\(dq: {
        \(dqyear\(dq: {\(dq$gt\(dq: 2010}
    },
    \(dqfields\(dq: [\(dq_id\(dq, \(dq_rev\(dq, \(dqyear\(dq, \(dqtitle\(dq],
    \(dqsort\(dq: [{\(dqyear\(dq: \(dqasc\(dq}],
    \(dqlimit\(dq: 2,
    \(dqskip\(dq: 0,
    \(dqexecution_stats\(dq: true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.UNINDENT
.UNINDENT
.sp
Example response when finding documents using an index:
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Thu, 01 Sep 2016 15:41:53 GMT
Server: CouchDB (Erlang OTP)
Transfer\-Encoding: chunked

{
    \(dqdocs\(dq: [
        {
            \(dq_id\(dq: \(dq176694\(dq,
            \(dq_rev\(dq: \(dq1\-54f8e950cc338d2385d9b0cda2fd918e\(dq,
            \(dqyear\(dq: 2011,
            \(dqtitle\(dq: \(dqThe Tragedy of Man\(dq
        },
        {
            \(dq_id\(dq: \(dq780504\(dq,
            \(dq_rev\(dq: \(dq1\-5f14bab1a1e9ac3ebdf85905f47fb084\(dq,
            \(dqyear\(dq: 2011,
            \(dqtitle\(dq: \(dqDrive\(dq
        }
    ],
    \(dqexecution_stats\(dq: {
        \(dqtotal_keys_examined\(dq: 0,
        \(dqtotal_docs_examined\(dq: 200,
        \(dqtotal_quorum_docs_examined\(dq: 0,
        \(dqresults_returned\(dq: 2,
        \(dqexecution_time_ms\(dq: 5.52
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Selector Syntax
.sp
Selectors are expressed as a JSON object describing documents of interest.
Within this structure, you can apply conditional logic using specially named
fields.
.sp
Whilst selectors have some similarities with MongoDB query documents, these
arise from a similarity of purpose and do not necessarily extend to commonality
of function or result.
.SS Selector Basics
.sp
Elementary selector syntax requires you to specify one or more fields, and the
corresponding values required for those fields. This selector matches all
documents whose “director” field has the value “Lars von Trier”.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqdirector\(dq: \(dqLars von Trier\(dq
}

A simple selector, inspecting specific fields
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\(dqselector\(dq: {
  \(dqtitle\(dq: \(dqLive And Let Die\(dq
},
\(dqfields\(dq: [
  \(dqtitle\(dq,
  \(dqcast\(dq
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You can create more complex selector expressions by combining operators.
For best performance, it is best to combine ‘combination’ or
‘array logical’ operators, such as \fB$regex\fP, with an equality
operators such as \fB$eq\fP, \fB$gt\fP, \fB$gte\fP, \fB$lt\fP, and \fB$lte\fP
(but not \fB$ne\fP). For more information about creating complex
selector expressions, see \fI\%creating selector expressions\fP\&.
.SS Selector with 2 fields
.sp
This selector matches any document with a name field containing \fB\(dqPaul\(dq\fP,
and that also has a location field with the value \fB\(dqBoston\(dq\fP\&.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqname\(dq: \(dqPaul\(dq,
    \(dqlocation\(dq: \(dqBoston\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Subfields
.sp
A more complex selector enables you to specify the values for field of nested
objects, or subfields. For example, you might use a standard JSON structure for
specifying a field and subfield.
.sp
Example of a field and subfield selector, using a standard JSON structure:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqimdb\(dq: {
        \(dqrating\(dq: 8
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
An abbreviated equivalent uses a dot notation to combine the field and subfield
names into a single name.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqimdb.rating\(dq: 8
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Operators
.sp
Operators are identified by the use of a dollar sign ($) prefix in the name
field.
.sp
There are two core types of operators in the selector syntax:
.INDENT 0.0
.IP \(bu 2
Combination operators
.IP \(bu 2
Condition operators
.UNINDENT
.sp
In general, combination operators are applied at the topmost level of selection.
They are used to combine conditions, or to create combinations of conditions,
into one selector.
.sp
Every explicit operator has the form:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dq$operator\(dq: argument}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
A selector without an explicit operator is considered to have an implicit
operator. The exact implicit operator is determined by the structure of the
selector expression.
.SS Implicit Operators
.sp
There are two implicit operators:
.INDENT 0.0
.IP \(bu 2
Equality
.IP \(bu 2
And
.UNINDENT
.sp
In a selector, any field containing a JSON value, but that has no operators in
it, is considered to be an equality condition. The implicit equality test
applies also for fields and subfields.
.sp
Any JSON object that is not the argument to a condition operator is an implicit
$and operator on each field.
.sp
In the below example, we use an operator to match any document, where the
\fB\(dqyear\(dq\fP field has a value greater than \fB2010\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqyear\(dq: {
        \(dq$gt\(dq: 2010
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
In this next example, there must be a field \fB\(dqdirector\(dq\fP in a matching
document, and the field must have a value exactly equal to \fB\(dqLars von Trier\(dq\fP\&.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqdirector\(dq: \(dqLars von Trier\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You can also make the equality operator explicit.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqdirector\(dq: {
        \(dq$eq\(dq: \(dqLars von Trier\(dq
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
In the next example using subfields, the required field \fB\(dqimdb\(dq\fP in a matching
document must also have a subfield \fB\(dqrating\(dq\fP and the subfield must have a
value equal to \fB8\fP\&.
.sp
Example of implicit operator applied to a subfield test
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqimdb\(dq: {
        \(dqrating\(dq: 8
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Again, you can make the equality operator explicit.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqimdb\(dq: {
        \(dqrating\(dq: { \(dq$eq\(dq: 8 }
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
An example of the \fB$eq\fP operator used with full text indexing
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
  \(dqselector\(dq: {
    \(dqyear\(dq: {
      \(dq$eq\(dq: 2001
    }
  },
  \(dqsort\(dq: [
    \(dqtitle:string\(dq
  ],
  \(dqfields\(dq: [
    \(dqtitle\(dq
  ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
An example of  the \fB$eq\fP operator used with database indexed on the field \fB\(dqyear\(dq\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
  \(dqselector\(dq: {
    \(dqyear\(dq: {
      \(dq$eq\(dq: 2001
    }
  },
  \(dqsort\(dq: [
    \(dqyear\(dq
  ],
  \(dqfields\(dq: [
    \(dqyear\(dq
  ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
In this example, the field \fB\(dqdirector\(dq\fP must be present and contain the value
\fB\(dqLars von Trier\(dq\fP and the field \fB\(dqyear\(dq\fP must exist and have the value
\fB2003\fP\&.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqdirector\(dq: \(dqLars von Trier\(dq,
    \(dqyear\(dq: 2003
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You can make both the \fB$and\fP operator and the equality operator explicit.
.INDENT 0.0
.INDENT 3.5
Example of using explicit \fB$and\fP and \fB$eq\fP operators
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq$and\(dq: [
        {
            \(dqdirector\(dq: {
                \(dq$eq\(dq: \(dqLars von Trier\(dq
            }
        },
        {
            \(dqyear\(dq: {
                \(dq$eq\(dq: 2003
            }
        }
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Explicit Operators
.sp
All operators, apart from ‘Equality’ and ‘And’, must be stated explicitly.
.SS Combination Operators
.sp
Combination operators are used to combine selectors. In addition to the common
boolean operators found in most programming languages, there are three
combination operators (\fB$all\fP, \fB$elemMatch\fP, and \fB$allMatch\fP) that help
you work with JSON arrays and one that works with JSON maps (\fB$keyMapMatch\fP).
.sp
A combination operator takes a single argument. The argument is either another
selector, or an array of selectors.
.sp
The list of combination operators:
.TS
center;
|l|l|l|.
_
T{
Operator
T}	T{
Argument
T}	T{
Purpose
T}
_
T{
\fB$and\fP
T}	T{
Array
T}	T{
Matches if all the selectors in the array match.
T}
_
T{
\fB$or\fP
T}	T{
Array
T}	T{
Matches if any of the selectors in the array
match. All selectors must use the same index.
T}
_
T{
\fB$not\fP
T}	T{
Selector
T}	T{
Matches if the given selector does not match.
T}
_
T{
\fB$nor\fP
T}	T{
Array
T}	T{
Matches if none of the selectors in the array
match.
T}
_
T{
\fB$all\fP
T}	T{
Array
T}	T{
Matches an array value if it contains all the
elements of the argument array.
T}
_
T{
\fB$elemMatch\fP
T}	T{
Selector
T}	T{
Matches and returns all documents that contain an
array field with at least one element that
matches all the specified query criteria.
T}
_
T{
\fB$allMatch\fP
T}	T{
Selector
T}	T{
Matches and returns all documents that contain an
array field with all its elements matching all
the specified query criteria.
T}
_
T{
\fB$keyMapMatch\fP
T}	T{
Selector
T}	T{
Matches and returns all documents that contain a
map that contains at least one key that matches
all the specified query criteria.
T}
_
.TE
.INDENT 0.0
.TP
\fBThe\fP \fB$and\fP \fBoperator\fP
\fB$and\fP operator used with two fields
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
  \(dqselector\(dq: {
    \(dq$and\(dq: [
      {
        \(dqtitle\(dq: \(dqTotal Recall\(dq
      },
      {
        \(dqyear\(dq: {
          \(dq$in\(dq: [1984, 1991]
        }
      }
    ]
  },
  \(dqfields\(dq: [
    \(dqyear\(dq,
    \(dqtitle\(dq,
    \(dqcast\(dq
  ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The \fB$and\fP operator matches if all the selectors in the array match. Below is
an example using the primary index (\fB_all_docs\fP):
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq$and\(dq: [
        {
            \(dq_id\(dq: { \(dq$gt\(dq: null }
        },
        {
            \(dqyear\(dq: {
                \(dq$in\(dq: [2014, 2015]
            }
        }
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBThe\fP \fB$or\fP \fBoperator\fP
.sp
The \fB$or\fP operator matches if any of the selectors in the array match. Below
is an example used with an index on the field \fB\(dqyear\(dq\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqyear\(dq: 1977,
    \(dq$or\(dq: [
        { \(dqdirector\(dq: \(dqGeorge Lucas\(dq },
        { \(dqdirector\(dq: \(dqSteven Spielberg\(dq }
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBThe\fP \fB$not\fP \fBoperator\fP
.sp
The \fB$not\fP operator matches if the given selector does not match. Below is an
example used with an index on the field \fB\(dqyear\(dq\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqyear\(dq: {
        \(dq$gte\(dq: 1900
    },
    \(dqyear\(dq: {
        \(dq$lte\(dq: 1903
    },
    \(dq$not\(dq: {
        \(dqyear\(dq: 1901
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBThe\fP \fB$nor\fP \fBoperator\fP
.sp
The \fB$nor\fP operator matches if the given selector does not match. Below is an
example used with an index on the field \fB\(dqyear\(dq\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqyear\(dq: {
        \(dq$gte\(dq: 1900
    },
    \(dqyear\(dq: {
        \(dq$lte\(dq: 1910
    },
    \(dq$nor\(dq: [
        { \(dqyear\(dq: 1901 },
        { \(dqyear\(dq: 1905 },
        {  \(dqyear\(dq: 1907 }
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBThe\fP \fB$all\fP \fBoperator\fP
.sp
The \fB$all\fP operator matches an array value if it contains all the elements of
the argument array. Below is an example used with the primary index
(\fB_all_docs\fP):
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: {
        \(dq$gt\(dq: null
    },
    \(dqgenre\(dq: {
        \(dq$all\(dq: [\(dqComedy\(dq,\(dqShort\(dq]
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBThe\fP \fB$elemMatch\fP \fBoperator\fP
.sp
The \fB$elemMatch\fP operator matches and returns all documents that contain an
array field with at least one element matching the supplied query criteria.
Below is an example used with the primary index (\fB_all_docs\fP):
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: { \(dq$gt\(dq: null },
    \(dqgenre\(dq: {
        \(dq$elemMatch\(dq: {
            \(dq$eq\(dq: \(dqHorror\(dq
        }
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBThe\fP \fB$allMatch\fP \fBoperator\fP
.sp
The \fB$allMatch\fP operator matches and returns all documents that contain an
array field with all its elements matching the supplied query criteria. Below
is an example used with the primary index (\fB_all_docs\fP):
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: { \(dq$gt\(dq: null },
    \(dqgenre\(dq: {
        \(dq$allMatch\(dq: {
            \(dq$eq\(dq: \(dqHorror\(dq
        }
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBThe\fP \fB$keyMapMatch\fP \fBoperator\fP
.sp
The \fB$keyMapMatch\fP operator matches and returns all documents that contain a
map that contains at least one key that matches all the specified query criteria.
Below is an example used with the primary index (\fB_all_docs\fP):
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: { \(dq$gt\(dq: null },
    \(dqcameras\(dq: {
        \(dq$keyMapMatch\(dq: {
            \(dq$eq\(dq: \(dqsecondary\(dq
        }
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Condition Operators
.sp
Condition operators are specific to a field, and are used to evaluate the value
stored in that field. For instance, the basic \fB$eq\fP operator matches when the
specified field contains a value that is equal to the supplied argument.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
For a condition operator to function correctly, the field \fBmust exist\fP
in the document for the selector to match. As an example, \fB$ne\fP means
the specified field must exist, and is not equal to the value of the
argument.
.UNINDENT
.UNINDENT
.sp
The basic equality and inequality operators common to most programming
languages are supported. Strict type matching is used.
.sp
In addition, some ‘meta’ condition operators are available. Some condition
operators accept any valid JSON content as the argument.  Other condition
operators require the argument to be in a specific JSON format.
.TS
center;
|l|l|l|l|.
_
T{
Operator type
T}	T{
Operator
T}	T{
Argument
T}	T{
Purpose
T}
_
T{
(In)equality
T}	T{
\fB$lt\fP
T}	T{
Any JSON
T}	T{
The field is less than the
argument
T}
_
T{
T}	T{
\fB$lte\fP
T}	T{
Any JSON
T}	T{
The field is less than or equal to
the argument.
T}
_
T{
T}	T{
\fB$eq\fP
T}	T{
Any JSON
T}	T{
The field is equal to the argument
T}
_
T{
T}	T{
\fB$ne\fP
T}	T{
Any JSON
T}	T{
The field is not equal to the
argument.
T}
_
T{
T}	T{
\fB$gte\fP
T}	T{
Any JSON
T}	T{
The field is greater than or equal
to the argument.
T}
_
T{
T}	T{
\fB$gt\fP
T}	T{
Any JSON
T}	T{
The field is greater than the
to the argument.
T}
_
T{
Object
T}	T{
\fB$exists\fP
T}	T{
Boolean
T}	T{
Check whether the field exists or
not, regardless of its value.
T}
_
T{
T}	T{
\fB$type\fP
T}	T{
String
T}	T{
Check the document field’s type.
Valid values are \fB\(dqnull\(dq\fP,
\fB\(dqboolean\(dq\fP, \fB\(dqnumber\(dq\fP,
\fB\(dqstring\(dq\fP, \fB\(dqarray\(dq\fP, and
\fB\(dqobject\(dq\fP\&.
T}
_
T{
Array
T}	T{
\fB$in\fP
T}	T{
Array of
JSON values
T}	T{
The document field must exist in
the list provided.
T}
_
T{
T}	T{
\fB$nin\fP
T}	T{
Array of
JSON values
T}	T{
The document field not must exist
in the list provided.
T}
_
T{
T}	T{
\fB$size\fP
T}	T{
Integer
T}	T{
Special condition to match the
length of an array field in a
document. Non\-array fields cannot
match this condition.
T}
_
T{
Miscellaneous
T}	T{
\fB$mod\fP
T}	T{
[Divisor,
Remainder]
T}	T{
Divisor is a non\-zero integer,
Remainder is any integer.
Non\-integer values result in a
404. Matches documents where
\fBfield % Divisor == Remainder\fP
is true, and only when the
document field is an integer.
T}
_
T{
T}	T{
\fB$regex\fP
T}	T{
String
T}	T{
A regular expression pattern to
match against the document field.
Only matches when the field is a
string value and matches the
supplied regular expression. The
matching algorithms are based on
the Perl Compatible Regular
Expression (PCRE) library. For
more information about what is
implemented, see the see the
\fI\%Erlang Regular Expression\fP
T}
_
.TE
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
Regular expressions do not work with indexes, so they should not be used to
filter large data sets. They can, however, be used to restrict a
\fI\%partial index\fP\&.
.UNINDENT
.UNINDENT
.SS Creating Selector Expressions
.sp
We have seen examples of combining selector expressions, such as \fI\%using
explicit $and and $eq operators\fP\&.
.sp
In general, whenever you have an operator that takes an argument, that argument
can itself be another operator with arguments of its own. This enables us to
build up more complex selector expressions.
.sp
However, only equality operators such as \fB$eq\fP, \fB$gt\fP, \fB$gte\fP, \fB$lt\fP,
and \fB$lte\fP (but not \fB$ne\fP) can be used as the basis of a query. You should
include at least one of these in a selector.
.sp
For example, if you try to perform a query that attempts to match all documents
that have a field called \fIafieldname\fP containing a value that begins with the
letter \fIA\fP, this will trigger a warning because no index could be used and
the database performs a full scan of the primary index:
.INDENT 0.0
.INDENT 3.5
\fBRequest\fP
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST /movies/_find HTTP/1.1
Accept: application/json
Content\-Type: application/json
Content\-Length: 112
Host: localhost:5984

{
    \(dqselector\(dq: {
        \(dqafieldname\(dq: {\(dq$regex\(dq: \(dq^A\(dq}
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Thu, 01 Sep 2016 17:25:51 GMT
Server: CouchDB (Erlang OTP)
Transfer\-Encoding: chunked

{
    \(dqwarning\(dq:\(dqno matching index found, create an index to optimize
    query time\(dq,
    \(dqdocs\(dq:[
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
It’s always recommended that you create an appropriate index when deploying
in production.
.UNINDENT
.UNINDENT
.sp
Most selector expressions work exactly as you would expect for the given
operator. But it is not always the case: for example, comparison of strings is
done with ICU and can can give surprising results if you were expecting ASCII
ordering. See \fI\%Views Collation\fP for more details.
.SS Sort Syntax
.sp
The \fBsort\fP field contains a list of field name and direction pairs, expressed
as a basic array. The first field name and direction pair is the topmost level
of sort. The second pair, if provided, is the next level of sort.
.sp
The field can be any field, using dotted notation if desired for sub\-document
fields.
.sp
The direction value is \fB\(dqasc\(dq\fP for ascending, and \fB\(dqdesc\(dq\fP for descending.
If you omit the direction value, the default \fB\(dqasc\(dq\fP is used.
.sp
Example, sorting by 2 fields:
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[{\(dqfieldName1\(dq: \(dqdesc\(dq}, {\(dqfieldName2\(dq: \(dqdesc\(dq }]
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
Example, sorting by 2 fields, assuming default direction for both :
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[\(dqfieldNameA\(dq, \(dqfieldNameB\(dq]
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
A typical requirement is to search for some content using a selector, then to
sort the results according to the specified field, in the required direction.
.sp
To use sorting, ensure that:
.INDENT 0.0
.IP \(bu 2
At least one of the sort fields is included in the selector.
.IP \(bu 2
.INDENT 2.0
.TP
.B There is an index already defined, with all the sort fields in the same
order.
.UNINDENT
.IP \(bu 2
Each object in the sort array has a single key.
.UNINDENT
.sp
If an object in the sort array does not have a single key, the resulting sort
order is implementation specific and might change.
.sp
Find does not support multiple fields with different sort orders, so the
directions must be either all ascending or all descending.
.sp
For field names in text search sorts, it is sometimes necessary for a
field type to be specified, for example:
.sp
\fB{ \(dq<fieldname>:string\(dq: \(dqasc\(dq}\fP
.sp
If possible, an attempt is made to discover the field type based on the
selector. In ambiguous cases the field type must be provided explicitly.
.sp
The sorting order is undefined when fields contain different data types.
This is an important difference between text and view indexes. Sorting
behavior for fields with different data types might change in future
versions.
.INDENT 0.0
.INDENT 3.5
A simple query, using sorting:
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqselector\(dq: {\(dqActor_name\(dq: \(dqRobert De Niro\(dq},
    \(dqsort\(dq: [{\(dqActor_name\(dq: \(dqasc\(dq}, {\(dqMovie_runtime\(dq: \(dqasc\(dq}]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Filtering Fields
.sp
It is possible to specify exactly which fields are returned for a document when
selecting from a database. The two advantages are:
.INDENT 0.0
.IP \(bu 2
.INDENT 2.0
.TP
.B Your results are limited to only those parts of the document that are
required for your application.
.UNINDENT
.IP \(bu 2
A reduction in the size of the response.
.UNINDENT
.sp
The fields returned are specified as an array.
.sp
Only the specified filter fields are included, in the response. There is no
automatic inclusion of the \fB_id\fP or other metadata fields when a field list
is included.
.sp
Example of selective retrieval of fields from matching documents:
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqselector\(dq: { \(dqActor_name\(dq: \(dqRobert De Niro\(dq },
    \(dqfields\(dq: [\(dqActor_name\(dq, \(dqMovie_year\(dq, \(dq_id\(dq, \(dq_rev\(dq]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Pagination
.sp
Mango queries support pagination via the bookmark field. Every \fB_find\fP
response contains a bookmark \- a token that CouchDB uses to determine
where to resume from when subsequent queries are made. To get the next
set of query results, add the bookmark that was received in the previous
response to your next request. Remember to keep the \fIselector\fP the same,
otherwise you will receive unexpected results. To paginate backwards,
you can use a previous bookmark to return the previous set of results.
.sp
Note that the presence of a bookmark doesn’t guarantee that there are
more results. You can to test whether you have reached the end of the
result set by comparing the number of results returned with the page
size requested \- if results returned < \fIlimit\fP, there are no more.
.SS Execution Statistics
.sp
Find can return basic execution statistics for a specific request. Combined with
the \fI\%_explain\fP endpoint, this should provide some
insight as to whether indexes are being used effectively.
.sp
The execution statistics currently include:
.TS
center;
|l|l|.
_
T{
Field
T}	T{
Description
T}
_
T{
\fBtotal_keys_examined\fP
T}	T{
Number of index keys examined.
Currently always 0.
T}
_
T{
\fBtotal_docs_examined\fP
T}	T{
Number of documents fetched from the
database / index, equivalent to using
\fBinclude_docs=true\fP in a view.
These may then be filtered in\-memory to
further narrow down the result set based
on the selector.
T}
_
T{
\fBtotal_quorum_docs_examined\fP
T}	T{
Number of documents fetched from the
database using an out\-of\-band document
fetch. This is only non\-zero when read
quorum > 1 is specified in the query
parameters.
T}
_
T{
\fBresults_returned\fP
T}	T{
Number of results returned from the query.
Ideally this should not be significantly
lower than the total documents / keys
examined.
T}
_
T{
\fBexecution_time_ms\fP
T}	T{
Total execution time in milliseconds as
measured by the database.
T}
_
.TE
.SS \fB/db/_index\fP
.sp
Mango is a declarative JSON querying language for CouchDB databases.
Mango wraps several index types, starting with the Primary Index
out\-of\-the\-box. Mango indexes, with index type \fIjson\fP, are
built using MapReduce Views.
.INDENT 0.0
.TP
.B POST /{db}/_index
Create a new index on a database
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBindex\fP (\fIjson\fP) – JSON object describing the index to create.
.IP \(bu 2
\fBddoc\fP (\fIstring\fP) – Name of the design document in which the index will be
created. By default, each index will be created in its own design
document.
Indexes can be grouped into design documents for efficiency. However, a
change to one index in a design document will invalidate all other
indexes in the same document (similar to views). \fIOptional\fP
.IP \(bu 2
\fBname\fP (\fIstring\fP) – Name of the index. If no name is provided, a name will
be generated automatically. \fIOptional\fP
.IP \(bu 2
\fBtype\fP (\fIstring\fP) – Can be \fB\(dqjson\(dq\fP or \fB\(dqtext\(dq\fP\&. Defaults to json.
Geospatial indexes will be supported in the future. \fIOptional\fP
Text indexes are supported via a third party library \fIOptional\fP
.IP \(bu 2
\fBpartitioned\fP (\fIboolean\fP) – Determines whether a JSON index is partitioned
or global. The default value of \fBpartitioned\fP is the \fBpartitioned\fP
property of the database. To create a global index on a
partitioned database, specify
\fBfalse\fP for the \fB\(dqpartitioned\(dq\fP field. If you specify \fBtrue\fP
for the  \fB\(dqpartitioned\(dq\fP field on an unpartitioned database, an
error occurs.
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – \fIapplication/json\fP
.IP \(bu 2
\fI\%Transfer\-Encoding\fP – \fBchunked\fP
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBresult\fP (\fIstring\fP) – Flag to show whether the index was created or one
already exists. Can be \fB\(dqcreated\(dq\fP or \fB\(dqexists\(dq\fP\&.
.IP \(bu 2
\fBid\fP (\fIstring\fP) – Id of the design document the index was created in.
.IP \(bu 2
\fBname\fP (\fIstring\fP) – Name of the index created.
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Index created successfully or already exists
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid request
.IP \(bu 2
\fI\%401 Unauthorized\fP – Admin permission required
.IP \(bu 2
\fI\%404 Not Found\fP – Database not found
.IP \(bu 2
\fI\%500 Internal Server Error\fP – Execution error
.UNINDENT
.UNINDENT
.sp
The \fIIndex object\fP is a JSON object with the following fields:
.INDENT 7.0
.TP
.B JSON Parameters
.INDENT 7.0
.IP \(bu 2
\fBfields\fP (\fIarray\fP) – array of field names following the \fI\%sort
syntax\fP\&. Nested fields are also allowed, e.g. \fI“person.name”\fP\&.
.IP \(bu 2
\fBpartial_filter_selector\fP (\fIjson\fP) – A \fI\%selector\fP
to apply to documents at indexing time, creating a
\fI\%partial index\fP\&. \fIOptional\fP
.UNINDENT
.UNINDENT
.sp
Example of creating a new index for a field called \fBfoo\fP:
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /db/_index HTTP/1.1
Content\-Type: application/json
Content\-Length: 116
Host: localhost:5984

{
    \(dqindex\(dq: {
        \(dqfields\(dq: [\(dqfoo\(dq]
    },
    \(dqname\(dq : \(dqfoo\-index\(dq,
    \(dqtype\(dq : \(dqjson\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.sp
The returned JSON confirms the index has been created:
.INDENT 0.0
.INDENT 3.5
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 96
Content\-Type: application/json
Date: Thu, 01 Sep 2016 18:17:48 GMT
Server: CouchDB (Erlang OTP/18)

{
    \(dqresult\(dq:\(dqcreated\(dq,
    \(dqid\(dq:\(dq_design/a5f4711fc9448864a13c81dc71e660b524d7410c\(dq,
    \(dqname\(dq:\(dqfoo\-index\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
Example index creation using all available query parameters
.INDENT 0.0
.INDENT 3.5
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST /db/_index HTTP/1.1
Content\-Type: application/json
Content\-Length: 396
Host: localhost:5984

{
    \(dqindex\(dq: {
        \(dqpartial_filter_selector\(dq: {
            \(dqyear\(dq: {
                \(dq$gt\(dq: 2010
            },
            \(dqlimit\(dq: 10,
            \(dqskip\(dq: 0
        },
        \(dqfields\(dq: [
            \(dq_id\(dq,
            \(dq_rev\(dq,
            \(dqyear\(dq,
            \(dqtitle\(dq
        ]
    },
    \(dqddoc\(dq: \(dqexample\-ddoc\(dq,
    \(dqname\(dq: \(dqexample\-index\(dq,
    \(dqtype\(dq: \(dqjson\(dq,
    \(dqpartitioned\(dq: false
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
By default, a JSON index will include all documents that have the indexed fields
present, including those which have null values.
.SS Partial Indexes
.sp
Partial indexes allow documents to be filtered at indexing time, potentially
offering significant performance improvements for query selectors that don’t
map cleanly to a range query on an index.
.sp
Let’s look at an example query:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
  \(dqselector\(dq: {
    \(dqstatus\(dq: {
      \(dq$ne\(dq: \(dqarchived\(dq
    },
    \(dqtype\(dq: \(dquser\(dq
  }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Without a partial index, this requires a full index scan to find all the
documents of \fB\(dqtype\(dq:\(dquser\(dq\fP that do not have a status of \fB\(dqarchived\(dq\fP\&.
This is because a normal index can only be used to match contiguous rows,
and the \fB\(dq$ne\(dq\fP operator cannot guarantee that.
.sp
To improve response times, we can create an index which excludes documents
where  \fB\(dqstatus\(dq: { \(dq$ne\(dq: \(dqarchived\(dq }\fP at index time using the
\fB\(dqpartial_filter_selector\(dq\fP field:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST /db/_index HTTP/1.1
Content\-Type: application/json
Content\-Length: 144
Host: localhost:5984

{
  \(dqindex\(dq: {
    \(dqpartial_filter_selector\(dq: {
      \(dqstatus\(dq: {
        \(dq$ne\(dq: \(dqarchived\(dq
      }
    },
    \(dqfields\(dq: [\(dqtype\(dq]
  },
  \(dqddoc\(dq : \(dqtype\-not\-archived\(dq,
  \(dqtype\(dq : \(dqjson\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Partial indexes are not currently used by the query planner unless specified
by a \fB\(dquse_index\(dq\fP field, so we need to modify the original query:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
  \(dqselector\(dq: {
    \(dqstatus\(dq: {
      \(dq$ne\(dq: \(dqarchived\(dq
    },
    \(dqtype\(dq: \(dquser\(dq
  },
  \(dquse_index\(dq: \(dqtype\-not\-archived\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Technically, we don’t need to include the filter on the \fB\(dqstatus\(dq\fP field
in the query selector \- the partial index ensures this is always true \-
but including it makes the intent of the selector clearer and will make
it easier to take advantage of future improvements to query planning
(e.g. automatic selection of partial indexes).
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
An index with fields is only used, when the selector includes
all of the fields indexed. For instance, if an index contains \fB[\(dqa\(dq. \(dqb\(dq]\fP
but the selector only requires field \fB[\(dqa\(dq]\fP to exist in the matching
documents, the index would not be valid for the query. All indexes,
however, can be treated as if they include the special fields \fB_id\fP and
\fB_rev\fP\&. They \fBnever\fP need to be specified in the query selector.
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B GET /{db}/_index
When you make a \fBGET\fP request to \fB/db/_index\fP, you get a list of all
indexes in the database. In addition to the information available through
this API, indexes are also stored in design documents <index\-functions>.
Design documents are regular documents that have an ID starting with
\fB_design/\fP\&. Design documents can be retrieved and modified in the same
way as any other document, although this is not necessary when using Mango.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name.
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – \fIapplication/json\fP
.IP \(bu 2
\fI\%Transfer\-Encoding\fP – \fBchunked\fP
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBtotal_rows\fP (\fInumber\fP) – Number of indexes
.IP \(bu 2
\fBindexes\fP (\fIobject\fP) – Array of index definitions
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Success
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid request
.IP \(bu 2
\fI\%401 Unauthorized\fP – Read permission required
.IP \(bu 2
\fI\%500 Internal Server Error\fP – Execution error
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B Format of index objects:
.INDENT 7.0
.IP \(bu 2
.INDENT 2.0
.TP
\fBddoc\fP: ID of the design document the index belongs to. This ID
can be used to retrieve the design document containing the index,
by making a \fBGET\fP request to \fB/db/ddoc\fP, where \fBddoc\fP is the
value of this field.
.UNINDENT
.IP \(bu 2
\fBname\fP: Name of the index.
.IP \(bu 2
.INDENT 2.0
.TP
\fBtype\fP: Type of the index. Currently “json” is the only
supported type.
.UNINDENT
.IP \(bu 2
.INDENT 2.0
.TP
\fBdef\fP: Definition of the index, containing the indexed fields
and the sort order: ascending or descending.
.UNINDENT
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /db/_index HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 238
Content\-Type: application/json
Date: Thu, 01 Sep 2016 18:17:48 GMT
Server: CouchDB (Erlang OTP/18)

{
    \(dqtotal_rows\(dq: 2,
    \(dqindexes\(dq: [
    {
        \(dqddoc\(dq: null,
        \(dqname\(dq: \(dq_all_docs\(dq,
        \(dqtype\(dq: \(dqspecial\(dq,
        \(dqdef\(dq: {
            \(dqfields\(dq: [
                {
                    \(dq_id\(dq: \(dqasc\(dq
                }
            ]
        }
    },
    {
        \(dqddoc\(dq: \(dq_design/a5f4711fc9448864a13c81dc71e660b524d7410c\(dq,
        \(dqname\(dq: \(dqfoo\-index\(dq,
        \(dqtype\(dq: \(dqjson\(dq,
        \(dqdef\(dq: {
            \(dqfields\(dq: [
                {
                    \(dqfoo\(dq: \(dqasc\(dq
                }
            ]
        }
    }
  ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B DELETE /{db}/_index/{designdoc}/json/{name}
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name.
.IP \(bu 2
\fBdesigndoc\fP – Design document name.
.IP \(bu 2
\fBname\fP – Index name.
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – \fIapplication/json\fP
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBok\fP (\fIstring\fP) – \fI“true”\fP if successful.
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Success
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid request
.IP \(bu 2
\fI\%401 Unauthorized\fP – Writer permission required
.IP \(bu 2
\fI\%404 Not Found\fP – Index not found
.IP \(bu 2
\fI\%500 Internal Server Error\fP – Execution error
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
DELETE /db/_index/_design/a5f4711fc9448864a13c81dc71e660b524d7410c/json/foo\-index HTTP/1.1
Accept: */*
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 12
Content\-Type: application/json
Date: Thu, 01 Sep 2016 19:21:40 GMT
Server: CouchDB (Erlang OTP/18)

{
    \(dqok\(dq: true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/db/_explain\fP
.INDENT 0.0
.TP
.B POST /{db}/_explain
Shows which index is being used by the query.  Parameters are the same as
\fI\%_find\fP
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – \fIapplication/json\fP
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – \fIapplication/json\fP
.IP \(bu 2
\fI\%Transfer\-Encoding\fP – \fBchunked\fP
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBdbname\fP (\fIstring\fP) – Name of database
.IP \(bu 2
\fBindex\fP (\fIobject\fP) – Index used to fulfill the query
.IP \(bu 2
\fBselector\fP (\fIobject\fP) – Query selector used
.IP \(bu 2
\fBopts\fP (\fIobject\fP) – Query options used
.IP \(bu 2
\fBlimit\fP (\fInumber\fP) – Limit parameter used
.IP \(bu 2
\fBskip\fP (\fInumber\fP) – Skip parameter used
.IP \(bu 2
\fBfields\fP (\fIarray\fP) – Fields to be returned by the query
.IP \(bu 2
\fBrange\fP (\fIobject\fP) – Range parameters passed to the underlying view
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid request
.IP \(bu 2
\fI\%401 Unauthorized\fP – Read permission required
.IP \(bu 2
\fI\%500 Internal Server Error\fP – Execution error
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /movies/_explain HTTP/1.1
Accept: application/json
Content\-Type: application/json
Content\-Length: 168
Host: localhost:5984

{
    \(dqselector\(dq: {
        \(dqyear\(dq: {\(dq$gt\(dq: 2010}
    },
    \(dqfields\(dq: [\(dq_id\(dq, \(dq_rev\(dq, \(dqyear\(dq, \(dqtitle\(dq],
    \(dqsort\(dq: [{\(dqyear\(dq: \(dqasc\(dq}],
    \(dqlimit\(dq: 2,
    \(dqskip\(dq: 0
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Thu, 01 Sep 2016 15:41:53 GMT
Server: CouchDB (Erlang OTP)
Transfer\-Encoding: chunked

{
    \(dqdbname\(dq: \(dqmovies\(dq,
    \(dqindex\(dq: {
        \(dqddoc\(dq: \(dq_design/0d61d9177426b1e2aa8d0fe732ec6e506f5d443c\(dq,
        \(dqname\(dq: \(dq0d61d9177426b1e2aa8d0fe732ec6e506f5d443c\(dq,
        \(dqtype\(dq: \(dqjson\(dq,
        \(dqdef\(dq: {
            \(dqfields\(dq: [
                {
                    \(dqyear\(dq: \(dqasc\(dq
                }
            ]
        }
    },
    \(dqselector\(dq: {
        \(dqyear\(dq: {
            \(dq$gt\(dq: 2010
        }
    },
    \(dqopts\(dq: {
        \(dqbookmark\(dq: \(dqnil\(dq,
        \(dqlimit\(dq: 2,
        \(dqskip\(dq: 0,
        \(dqsort\(dq: {},
        \(dqfields\(dq: [
            \(dq_id\(dq,
            \(dq_rev\(dq,
            \(dqyear\(dq,
            \(dqtitle\(dq
        ],
        \(dqr\(dq: [
            49
        ],
        \(dqconflicts\(dq: false
    },
    \(dqlimit\(dq: 2,
    \(dqskip\(dq: 0,
    \(dqfields\(dq: [
        \(dq_id\(dq,
        \(dq_rev\(dq,
        \(dqyear\(dq,
        \(dqtitle\(dq
    ],
    \(dqrange\(dq: {
        \(dqstart_key\(dq: [
            2010
        ],
        \(dqend_key\(dq: [
            {}
        ]
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS Index selection
.sp
\fI_find\fP chooses which index to use for responding to a query, unless you specify
an index at query time.
.sp
The query planner looks at the selector section and finds the index with the
closest match to operators and fields used in the query. If there are two
or more json type indexes that match, the index with the smallest
number of fields in the index is preferred.
If there are still two or more candidate indexes,
the index with the first alphabetical name is chosen.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
It’s good practice to specify indexes explicitly in your queries. This
prevents existing queries being affected by new indexes that might get added
in a production environment.
.UNINDENT
.UNINDENT
.SS \fB/db/_shards\fP
.sp
New in version 2.0.

.INDENT 0.0
.TP
.B GET /{db}/_shards
The response will contain a list of database shards. Each shard will
have its internal database range, and the nodes on which replicas of
those shards are stored.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBshards\fP (\fIobject\fP) – Mapping of shard ranges to individual shard replicas
on each node in the cluster
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid database name
.IP \(bu 2
\fI\%401 Unauthorized\fP – Read privilege required
.IP \(bu 2
\fI\%415 Unsupported Media Type\fP – Bad \fI\%Content\-Type\fP value
.IP \(bu 2
\fI\%500 Internal Server Error\fP – Internal server error or timeout
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /db/_shards HTTP/1.1
Accept: */*
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 621
Content\-Type: application/json
Date: Fri, 18 Jan 2019 19:55:14 GMT
Server: CouchDB/2.4.0 (Erlang OTP/19)

{
  \(dqshards\(dq: {
    \(dq00000000\-1fffffff\(dq: [
      \(dqcouchdb@node1.example.com\(dq,
      \(dqcouchdb@node2.example.com\(dq,
      \(dqcouchdb@node3.example.com\(dq
    ],
    \(dq20000000\-3fffffff\(dq: [
      \(dqcouchdb@node1.example.com\(dq,
      \(dqcouchdb@node2.example.com\(dq,
      \(dqcouchdb@node3.example.com\(dq
    ],
    \(dq40000000\-5fffffff\(dq: [
      \(dqcouchdb@node1.example.com\(dq,
      \(dqcouchdb@node2.example.com\(dq,
      \(dqcouchdb@node3.example.com\(dq
    ],
    \(dq60000000\-7fffffff\(dq: [
      \(dqcouchdb@node1.example.com\(dq,
      \(dqcouchdb@node2.example.com\(dq,
      \(dqcouchdb@node3.example.com\(dq
    ],
    \(dq80000000\-9fffffff\(dq: [
      \(dqcouchdb@node1.example.com\(dq,
      \(dqcouchdb@node2.example.com\(dq,
      \(dqcouchdb@node3.example.com\(dq
    ],
    \(dqa0000000\-bfffffff\(dq: [
      \(dqcouchdb@node1.example.com\(dq,
      \(dqcouchdb@node2.example.com\(dq,
      \(dqcouchdb@node3.example.com\(dq
    ],
    \(dqc0000000\-dfffffff\(dq: [
      \(dqcouchdb@node1.example.com\(dq,
      \(dqcouchdb@node2.example.com\(dq,
      \(dqcouchdb@node3.example.com\(dq
    ],
    \(dqe0000000\-ffffffff\(dq: [
      \(dqcouchdb@node1.example.com\(dq,
      \(dqcouchdb@node2.example.com\(dq,
      \(dqcouchdb@node3.example.com\(dq
    ]
  }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/db/_shards/doc\fP
.INDENT 0.0
.TP
.B GET /{db}/_shards/{docid}
Returns information about the specific shard into which a given document
has been stored, along with information about the nodes on which that
shard has a replica.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBdocid\fP – Document ID
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBrange\fP (\fIstring\fP) – The shard range in which the document is stored
.IP \(bu 2
\fBnodes\fP (\fIarray\fP) – List of nodes serving a replica of the shard
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%401 Unauthorized\fP – Read privilege required
.IP \(bu 2
\fI\%404 Not Found\fP – Database or document not found
.IP \(bu 2
\fI\%500 Internal Server Error\fP – Internal server error or timeout
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 94
Content\-Type: application/json
Date: Fri, 18 Jan 2019 20:08:07 GMT
Server: CouchDB/2.3.0\-9d4cb03c2 (Erlang OTP/19)
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 94
Content\-Type: application/json
Date: Fri, 18 Jan 2019 20:26:33 GMT
Server: CouchDB/2.3.0\-9d4cb03c2 (Erlang OTP/19)

{
  \(dqrange\(dq: \(dqe0000000\-ffffffff\(dq,
  \(dqnodes\(dq: [
    \(dqnode1@127.0.0.1\(dq,
    \(dqnode2@127.0.0.1\(dq,
    \(dqnode3@127.0.0.1\(dq
  ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/db/_sync_shards\fP
.sp
New in version 2.3.1.

.INDENT 0.0
.TP
.B POST /{db}/_sync_shards
For the given database, force\-starts internal shard synchronization
for all replicas of all database shards.
.sp
This is typically only used when performing cluster maintenance,
such as \fI\%moving a shard\fP\&.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBok\fP (\fIboolean\fP) – Operation status. Available in case of success
.IP \(bu 2
\fBerror\fP (\fIstring\fP) – Error type. Available if response code is \fB4xx\fP
.IP \(bu 2
\fBreason\fP (\fIstring\fP) – Error description. Available if response code is
\fB4xx\fP
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%202 Accepted\fP – Request accepted
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid database name
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.IP \(bu 2
\fI\%404 Not Found\fP – Database not found
.IP \(bu 2
\fI\%500 Internal Server Error\fP – Internal server error or timeout
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /db/_sync_shards HTTP/1.1
Host: localhost:5984
Accept: */*
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 202 Accepted
Cache\-Control: must\-revalidate
Content\-Length: 12
Content\-Type: application/json
Date: Fri, 18 Jan 2019 20:19:23 GMT
Server: CouchDB/2.3.0\-9d4cb03c2 (Erlang OTP/19)
X\-Couch\-Request\-ID: 14f0b8d252
X\-CouchDB\-Body\-Time: 0

{
    \(dqok\(dq: true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Admins may want to bump their \fB[mem3] sync_concurrency\fP value to a
larger figure for the duration of the shards sync.
.UNINDENT
.UNINDENT
.SS \fB/db/_changes\fP
.INDENT 0.0
.TP
.B GET /{db}/_changes
Returns a sorted list of changes made to documents in the database, in time
order of application, can be obtained from the database’s \fB_changes\fP
resource. Only the most recent change for a given document is guaranteed to
be provided, for example if a document has had fields added, and then
deleted, an API client checking for changes will not necessarily receive
the intermediate state of added documents.
.sp
This can be used to listen for update and modifications to the database for
post processing or synchronization, and for practical purposes,
a continuously connected \fB_changes\fP feed is a reasonable approach for
generating a real\-time log for most applications.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/event\-stream\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.IP \(bu 2
\fI\%Last\-Event\-ID\fP – ID of the last events received by the server on a
previous connection. Overrides \fBsince\fP query parameter.
.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBdoc_ids\fP (\fIarray\fP) – List of document IDs to filter the changes feed as
valid JSON array. Used with \fI\%_doc_ids\fP
filter. Since \fI\%length of URL is limited\fP, it is better to use
\fI\%POST /{db}/_changes\fP instead.
.IP \(bu 2
\fBconflicts\fP (\fIboolean\fP) – Includes \fIconflicts\fP information in response.
Ignored if \fIinclude_docs\fP isn’t \fBtrue\fP\&. Default is \fBfalse\fP\&.
.IP \(bu 2
\fBdescending\fP (\fIboolean\fP) – Return the change results in descending sequence
order (most recent change first). Default is \fBfalse\fP\&.
.IP \(bu 2
\fBfeed\fP (\fIstring\fP) – .INDENT 2.0
.IP \(bu 2
\fBnormal\fP Specifies \fI\%Normal Polling Mode\fP\&. All past changes are returned
immediately. \fIDefault.\fP
.IP \(bu 2
\fBlongpoll\fP Specifies \fI\%Long Polling Mode\fP\&. Waits until at least one change
has occurred, sends the change, then closes the
connection. Most commonly used in conjunction with
\fBsince=now\fP, to wait for the next change.
.IP \(bu 2
\fBcontinuous\fP Sets \fI\%Continuous Mode\fP\&. Sends a line of JSON per
event. Keeps the socket open until \fBtimeout\fP\&.
.IP \(bu 2
\fBeventsource\fP Sets \fI\%Event Source Mode\fP\&. Works the same as Continuous
Mode, but sends the events in \fI\%EventSource\fP format.
.UNINDENT

.IP \(bu 2
\fBfilter\fP (\fIstring\fP) – Reference to a \fI\%filter function\fP
from a design document that will filter whole stream emitting only
filtered events. See the section \fI\%Change Notifications in the book
CouchDB The Definitive Guide\fP for more information.
.IP \(bu 2
\fBheartbeat\fP (\fInumber\fP) – Period in \fImilliseconds\fP after which an empty
line is sent in the results. Only applicable for \fI\%longpoll\fP, \fI\%continuous\fP, and
\fI\%eventsource\fP feeds. Overrides any timeout
to keep the feed alive indefinitely. Default is \fB60000\fP\&. May be
\fBtrue\fP to use default value.
.IP \(bu 2
\fBinclude_docs\fP (\fIboolean\fP) – Include the associated document with each
result. If there are conflicts, only the winning revision is returned.
Default is \fBfalse\fP\&.
.IP \(bu 2
\fBattachments\fP (\fIboolean\fP) – Include the Base64\-encoded content of
\fI\%attachments\fP in the documents that
are included if \fBinclude_docs\fP is \fBtrue\fP\&. Ignored if \fBinclude_docs\fP
isn’t \fBtrue\fP\&. Default is \fBfalse\fP\&.
.IP \(bu 2
\fBatt_encoding_info\fP (\fIboolean\fP) – Include encoding information in attachment
stubs if \fBinclude_docs\fP is \fBtrue\fP and the particular attachment is
compressed. Ignored if \fBinclude_docs\fP isn’t \fBtrue\fP\&.
Default is \fBfalse\fP\&.
.IP \(bu 2
\fBlast\-event\-id\fP (\fInumber\fP) – Alias of \fILast\-Event\-ID\fP header.
.IP \(bu 2
\fBlimit\fP (\fInumber\fP) – Limit number of result rows to the specified value
(note that using \fB0\fP here has the same effect as \fB1\fP).
.IP \(bu 2
\fBsince\fP – Start the results from the change immediately after the given
update sequence. Can be valid update sequence or \fBnow\fP value.
Default is \fB0\fP\&.
.IP \(bu 2
\fBstyle\fP (\fIstring\fP) – Specifies how many revisions are returned in
the changes array. The default, \fBmain_only\fP, will only return
the current “winning” revision; \fBall_docs\fP will return all leaf
revisions (including conflicts and deleted former conflicts).
.IP \(bu 2
\fBtimeout\fP (\fInumber\fP) – Maximum period in \fImilliseconds\fP to wait for a change
before the response is sent, even if there are no results.
Only applicable for \fI\%longpoll\fP or
\fI\%continuous\fP feeds.
Default value is specified by \fI\%chttpd/changes_timeout\fP
configuration option. Note that \fB60000\fP value is also the default
maximum timeout to prevent undetected dead connections.
.IP \(bu 2
\fBview\fP (\fIstring\fP) – Allows to use view functions as filters. Documents
counted as “passed” for view filter in case if map function emits
at least one record for them.
See \fI\%_view\fP for more info.
.IP \(bu 2
\fBseq_interval\fP (\fInumber\fP) – When fetching changes in a batch, setting the
\fIseq_interval\fP parameter tells CouchDB to only calculate the update seq
with every Nth result returned. By setting \fBseq_interval=<batch size>\fP
, where \fB<batch size>\fP is the number of results requested per batch,
load can be reduced on the source CouchDB database; computing the seq
value across many shards (esp. in highly\-sharded databases) is expensive
in a heavily loaded CouchDB cluster.
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Cache\-Control\fP – \fBno\-cache\fP if changes feed is
\fI\%eventsource\fP
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/event\-stream\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.IP \(bu 2
\fI\%ETag\fP – Response hash if changes feed is \fInormal\fP
.IP \(bu 2
\fI\%Transfer\-Encoding\fP – \fBchunked\fP
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBlast_seq\fP (\fIjson\fP) – Last change update sequence
.IP \(bu 2
\fBpending\fP (\fInumber\fP) – Count of remaining items in the feed
.IP \(bu 2
\fBresults\fP (\fIarray\fP) – Changes made to a database
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%400 Bad Request\fP – Bad request
.UNINDENT
.UNINDENT
.sp
The \fBresults\fP field of database changes:
.INDENT 7.0
.TP
.B JSON Parameters
.INDENT 7.0
.IP \(bu 2
\fBchanges\fP (\fIarray\fP) – List of document’s leaves with single field \fBrev\fP\&.
.IP \(bu 2
\fBid\fP (\fIstring\fP) – Document ID.
.IP \(bu 2
\fBseq\fP (\fIjson\fP) – Update sequence.
.IP \(bu 2
\fBdeleted\fP (\fIbool\fP) – \fBtrue\fP if the document is deleted.
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /db/_changes?style=all_docs HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Mon, 12 Aug 2013 00:54:58 GMT
ETag: \(dq6ASLEKEMSRABT0O5XY9UPO9Z\(dq
Server: CouchDB (Erlang/OTP)
Transfer\-Encoding: chunked

{
    \(dqlast_seq\(dq: \(dq5\-g1AAAAIreJyVkEsKwjAURZ\-toI5cgq5A0sQ0OrI70XyppcaRY92J7kR3ojupaSPUUgotgRd4yTlwbw4A0zRUMLdnpaMkwmyF3Ily9xBwEIuiKLI05KOTW0wkV4rruP29UyGWbordzwKVxWBNOGMKZhertDlarbr5pOT3DV4gudUC9\-MPJX9tpEAYx4TQASns2E24ucuJ7rXJSL1BbEgf3vTwpmedCZkYa7Pulck7Xt7x_usFU2aIHOD4eEfVTVA5KMGUkqhNZV\-8_o5i\(dq,
    \(dqpending\(dq: 0,
    \(dqresults\(dq: [
        {
            \(dqchanges\(dq: [
                {
                    \(dqrev\(dq: \(dq2\-7051cbe5c8faecd085a3fa619e6e6337\(dq
                }
            ],
            \(dqid\(dq: \(dq6478c2ae800dfc387396d14e1fc39626\(dq,
            \(dqseq\(dq: \(dq3\-g1AAAAG3eJzLYWBg4MhgTmHgz8tPSTV0MDQy1zMAQsMcoARTIkOS_P___7MSGXAqSVIAkkn2IFUZzIkMuUAee5pRqnGiuXkKA2dpXkpqWmZeagpu_Q4g_fGEbEkAqaqH2sIItsXAyMjM2NgUUwdOU_JYgCRDA5ACGjQfn30QlQsgKvcjfGaQZmaUmmZClM8gZhyAmHGfsG0PICrBPmQC22ZqbGRqamyIqSsLAAArcXo\(dq
        },
        {
            \(dqchanges\(dq: [
                {
                    \(dqrev\(dq: \(dq3\-7379b9e515b161226c6559d90c4dc49f\(dq
                }
            ],
            \(dqdeleted\(dq: true,
            \(dqid\(dq: \(dq5bbc9ca465f1b0fcd62362168a7c8831\(dq,
            \(dqseq\(dq: \(dq4\-g1AAAAHXeJzLYWBg4MhgTmHgz8tPSTV0MDQy1zMAQsMcoARTIkOS_P___7MymBMZc4EC7MmJKSmJqWaYynEakaQAJJPsoaYwgE1JM0o1TjQ3T2HgLM1LSU3LzEtNwa3fAaQ_HqQ_kQG3qgSQqnoUtxoYGZkZG5uS4NY8FiDJ0ACkgAbNx2cfROUCiMr9CJ8ZpJkZpaaZEOUziBkHIGbcJ2zbA4hKsA\-ZwLaZGhuZmhobYurKAgCz33kh\(dq
        },
        {
            \(dqchanges\(dq: [
                {
                    \(dqrev\(dq: \(dq6\-460637e73a6288cb24d532bf91f32969\(dq
                },
                {
                    \(dqrev\(dq: \(dq5\-eeaa298781f60b7bcae0c91bdedd1b87\(dq
                }
            ],
            \(dqid\(dq: \(dq729eb57437745e506b333068fff665ae\(dq,
            \(dqseq\(dq: \(dq5\-g1AAAAIReJyVkE0OgjAQRkcwUVceQU9g\-mOpruQm2tI2SLCuXOtN9CZ6E70JFmpCCCFCmkyTdt6bfJMDwDQNFcztWWkcY8JXyB2cu49AgFwURZGloRid3MMkEUoJHbXbOxVy6arc_SxQWQzRVHCuYHaxSpuj1aqbj0t\-3\-AlSrZakn78oeSvjRSIkIhSNiCFHbsKN3c50b02mURvEB\-yD296eNOzzoRMRLRZ98rkHS_veGcC_nR\-fGe1gaCaxihhjOI2lX0BhniHaA\(dq
        }
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.sp
Changed in version 0.11.0: added \fBinclude_docs\fP parameter

.sp
Changed in version 1.2.0: added \fBview\fP parameter and special value \fI_view\fP
for \fBfilter\fP one

.sp
Changed in version 1.3.0: \fBsince\fP parameter could take \fInow\fP value to start
listen changes since current seq number.

.sp
Changed in version 1.3.0: \fBeventsource\fP feed type added.

.sp
Changed in version 1.4.0: Support \fBLast\-Event\-ID\fP header.

.sp
Changed in version 1.6.0: added \fBattachments\fP and \fBatt_encoding_info\fP
parameters

.sp
Changed in version 2.0.0: update sequences can be any valid json object,
added \fBseq_interval\fP

.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
If the specified replicas of the shards in any given since value are
unavailable, alternative replicas are selected, and the last known
checkpoint between them is used. If this happens, you might see changes
again that you have previously seen. Therefore, an application making use
of the \fB_changes\fP feed should be ‘idempotent’, that is, able to receive the
same data multiple times, safely.
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Cloudant Sync and PouchDB already optimize the replication process by
setting \fBseq_interval\fP parameter to the number of results expected per
batch. This parameter increases throughput by reducing latency between
sequential requests in bulk document transfers. This has resulted in up to
a 20% replication performance improvement in highly\-sharded databases.
.UNINDENT
.UNINDENT
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
Using the \fBattachments\fP parameter to include attachments in the changes
feed is not recommended for large attachment sizes. Also note that the
Base64\-encoding that is used leads to a 33% overhead (i.e. one third) in
transfer size for attachments.
.UNINDENT
.UNINDENT
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
The results returned by \fI_changes\fP are partially ordered. In other words,
the order is not guaranteed to be preserved for multiple calls.
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B POST /{db}/_changes
Requests the database changes feed in the same way as
\fI\%GET /{db}/_changes\fP does, but is widely used with
\fB?filter=_doc_ids\fP query parameter and allows one to pass a larger list of
document IDs to filter.
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /recipes/_changes?filter=_doc_ids HTTP/1.1
Accept: application/json
Content\-Length: 40
Content\-Type: application/json
Host: localhost:5984

{
    \(dqdoc_ids\(dq: [
        \(dqSpaghettiWithMeatballs\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Sat, 28 Sep 2013 07:23:09 GMT
ETag: \(dqARIHFWL3I7PIS0SPVTFU6TLR2\(dq
Server: CouchDB (Erlang OTP)
Transfer\-Encoding: chunked

{
    \(dqlast_seq\(dq: \(dq5\-g1AAAAIreJyVkEsKwjAURZ\-toI5cgq5A0sQ0OrI70XyppcaRY92J7kR3ojupaSPUUgotgRd4yTlwbw4A0zRUMLdnpaMkwmyF3Ily9xBwEIuiKLI05KOTW0wkV4rruP29UyGWbordzwKVxWBNOGMKZhertDlarbr5pOT3DV4gudUC9\-MPJX9tpEAYx4TQASns2E24ucuJ7rXJSL1BbEgf3vTwpmedCZkYa7Pulck7Xt7x_usFU2aIHOD4eEfVTVA5KMGUkqhNZV8_o5i\(dq,
    \(dqpending\(dq: 0,
    \(dqresults\(dq: [
        {
            \(dqchanges\(dq: [
                {
                    \(dqrev\(dq: \(dq13\-bcb9d6388b60fd1e960d9ec4e8e3f29e\(dq
                }
            ],
            \(dqid\(dq: \(dqSpaghettiWithMeatballs\(dq,
            \(dqseq\(dq:  \(dq5\-g1AAAAIReJyVkE0OgjAQRkcwUVceQU9g\-mOpruQm2tI2SLCuXOtN9CZ6E70JFmpCCCFCmkyTdt6bfJMDwDQNFcztWWkcY8JXyB2cu49AgFwURZGloRid3MMkEUoJHbXbOxVy6arc_SxQWQzRVHCuYHaxSpuj1aqbj0t\-3\-AlSrZakn78oeSvjRSIkIhSNiCFHbsKN3c50b02mURvEB\-yD296eNOzzoRMRLRZ98rkHS_veGcC_nR\-fGe1gaCaxihhjOI2lX0BhniHaA\(dq
        }
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS Changes Feeds
.SS Polling
.sp
By default all changes are immediately returned within the JSON body:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /somedatabase/_changes HTTP/1.1
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqresults\(dq:[
{\(dqseq\(dq:\(dq1\-g1AAAAF9eJzLYWBg4MhgTmHgz8tPSTV0MDQy1zMAQsMcoARTIkOS_P__7MSGXAqSVIAkkn2IFUZzIkMuUAee5pRqnGiuXkKA2dpXkpqWmZeagpu_Q4g_fGEbEkAqaqH2sIItsXAyMjM2NgUUwdOU_JYgCRDA5ACGjQfn30QlQsgKvcTVnkAovI\-YZUPICpBvs0CAN1eY_c\(dq,\(dqid\(dq:\(dqfresh\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq1\-967a00dff5e02add41819138abb3284d\(dq}]},
{\(dqseq\(dq:\(dq3\-g1AAAAG3eJzLYWBg4MhgTmHgz8tPSTV0MDQy1zMAQsMcoARTIkOS_P___7MSGXAqSVIAkkn2IFUZzIkMuUAee5pRqnGiuXkKA2dpXkpqWmZeagpu_Q4g_fGEbEkAqaqH2sIItsXAyMjM2NgUUwdOU_JYgCRDA5ACGjQfn30QlQsgKvcjfGaQZmaUmmZClM8gZhyAmHGfsG0PICrBPmQC22ZqbGRqamyIqSsLAAArcXo\(dq,\(dqid\(dq:\(dqupdated\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq2\-7051cbe5c8faecd085a3fa619e6e6337CFCmkyTdt6bfJMDwDQNFcztWWkcY8JXyB2cu49AgFwURZGloRid3MMkEUoJHbXbOxVy6arc_SxQWQzRVHCuYHaxSpuj1aqbj0t\-3\-AlSrZakn78oeSvjRSIkIhSNiCFHbsKN3c50b02mURvEB\-yD296eNOzzoRMRLRZ98rkHS_veGcC_nR\-fGe1gaCaxihhjOI2lX0BhniHaA\(dq,\(dqid\(dq:\(dqdeleted\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq2\-eec205a9d413992850a6e32678485900\(dq}],\(dqdeleted\(dq:true}
],
\(dqlast_seq\(dq:\(dq5\-g1AAAAIreJyVkEsKwjAURZ\-toI5cgq5A0sQ0OrI70XyppcaRY92J7kR3ojupaSPUUgotgRd4yTlwbw4A0zRUMLdnpaMkwmyF3Ily9xBwEIuiKLI05KOTW0wkV4rruP29UyGWbordzwKVxWBNOGMKZhertDlarbr5pOT3DV4gudUC9\-MPJX9tpEAYx4TQASns2E24ucuJ7rXJSL1BbEgf3vTwpmedCZkYa7Pulck7Xt7x_usFU2aIHOD4eEfVTVA5KMGUkqhNZV\-8_o5i\(dq,
\(dqpending\(dq: 0}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBresults\fP is the list of changes in sequential order. New and changed
documents only differ in the value of the rev; deleted documents include the
\fB\(dqdeleted\(dq: true\fP attribute. (In the \fBstyle=all_docs mode\fP, deleted applies
only to the current/winning revision. The other revisions listed might be
deleted even if there is no deleted property; you have to \fBGET\fP them
individually to make sure.)
.sp
\fBlast_seq\fP is the update sequence of the last update returned (Equivalent
to the last item in the results).
.sp
Sending a \fBsince\fP param in the query string skips all changes up to and
including the given update sequence:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /somedatabase/_changes?since=4\-g1AAAAHXeJzLYWBg4MhgTmHgz8tPSTV0MDQy1zMAQsMcoARTIkOS_P___7MymBMZc4EC7MmJKSmJqWaYynEakaQAJJPsoaYwgE1JM0o1TjQ3T2HgLM1LSU3LzEtNwa3fAaQ_HqQ_kQG3qgSQqnoUtxoYGZkZG5uS4NY8FiDJ0ACkgAbNx2cfROUCiMr9CJ8ZpJkZpaaZEOUziBkHIGbcJ2zbA4hKsA\-ZwLaZGhuZmhobYurKAgCz33kh HTTP/1.1
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The return structure for \fBnormal\fP and \fBlongpoll\fP modes is a JSON
array of changes objects, and the last update sequence.
.sp
In the return format for \fBcontinuous\fP mode, the server sends a \fBCRLF\fP
(carriage\-return, linefeed) delimited line for each change. Each line
contains the \fIJSON object\fP described above.
.sp
You can also request the full contents of each document change (instead
of just the change notification) by using the \fBinclude_docs\fP parameter.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqlast_seq\(dq: \(dq5\-g1AAAAIreJyVkEsKwjAURZ\-toI5cgq5A0sQ0OrI70XyppcaRY92J7kR3ojupaSPUUgotgRd4yTlwbw4A0zRUMLdnpaMkwmyF3Ily9xBwEIuiKLI05KOTW0wkV4rruP29UyGWbordzwKVxWBNOGMKZhertDlarbr5pOT3DV4gudUC9\-MPJX9tpEAYx4TQASns2E24ucuJ7rXJSL1BbEgf3vTwpmedCZkYa7Pulck7Xt7x_usFU2aIHOD4eEfVTVA5KMGUkqhNZV\-8_o5i\(dq,
    \(dqpending\(dq: 0,
    \(dqresults\(dq: [
        {
            \(dqchanges\(dq: [
                {
                    \(dqrev\(dq: \(dq2\-eec205a9d413992850a6e32678485900\(dq
                }
            ],
            \(dqdeleted\(dq: true,
            \(dqid\(dq: \(dqdeleted\(dq,
            \(dqseq\(dq:  \(dq5\-g1AAAAIReJyVkE0OgjAQRkcwUVceQU9g\-mOpruQm2tI2SLCuXOtN9CZ6E70JFmpCCCFCmkyTdt6bfJMDwDQNFcztWWkcY8JXyB2cu49AgFwURZGloRid3MMkEUoJHbXbOxVy6arc_SxQWQzRVHCuYHaxSpuj1aqbj0t\-3\-AlSrZakn78oeSvjRSIkIhSNiCFHbsKN3c50b02mURvEByD296eNOzzoRMRLRZ98rkHS_veGcC_nR\-fGe1gaCaxihhjOI2lX0BhniHaA\(dq,
        }
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Long Polling
.sp
The \fIlongpoll\fP feed, probably most applicable for a browser, is a more
efficient form of polling that waits for a change to occur before the response
is sent. \fIlongpoll\fP avoids the need to frequently poll CouchDB to discover
nothing has changed!
.sp
The request to the server will remain open until a change is made on the
database and is subsequently transferred, and then the connection will close.
This is low load for both server and client.
.sp
The response is basically the same JSON as is sent for the \fInormal\fP feed.
.sp
Because the wait for a change can be significant you can set a
timeout before the connection is automatically closed (the
\fBtimeout\fP argument). You can also set a heartbeat interval (using
the \fBheartbeat\fP query argument), which sends a newline to keep the
connection active.
.sp
Keep in mind that \fBheartbeat\fP means “Send a linefeed every \fBx\fP ms
if no change arrives, and hold the connection indefinitely” while \fBtimeout\fP
means “Hold this connection open for \fBx\fP ms, and if no change arrives in that
time, close the socket.”  \fBheartbeat\fP overrides \fBtimeout\fP\&.
.SS Continuous
.sp
Continually polling the CouchDB server is not ideal \- setting up new HTTP
connections just to tell the client that nothing happened puts unnecessary
strain on CouchDB.
.sp
A continuous feed stays open and connected to the database until explicitly
closed and changes are sent to the client as they happen, i.e. in near
real\-time.
.sp
As with the \fIlongpoll\fP feed type you can set both the timeout and heartbeat
intervals to ensure that the connection is kept open for new changes and
updates.
.sp
Keep in mind that \fBheartbeat\fP means “Send a linefeed every \fBx\fP ms
if no change arrives, and hold the connection indefinitely” while \fBtimeout\fP
means “Hold this connection open for \fBx\fP ms, and if no change arrives in that
time, close the socket.”  \fBheartbeat\fP overrides \fBtimeout\fP\&.
.sp
The continuous feed’s response is a little different than the other feed types
to simplify the job of the client \- each line of the response is either empty
or a JSON object representing a single change, as found in the normal feed’s
results.
.sp
If \fIlimit\fP has been specified the feed will end with a \fI{ last_seq }\fP object.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /somedatabase/_changes?feed=continuous HTTP/1.1
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqseq\(dq:\(dq1\-g1AAAAF9eJzLYWBg4MhgTmHgz8tPSTV0MDQy1zMAQsMcoARTIkOS_P___7MSGXAqSVIAkkn2IFUZzIkMuUAee5pRqnGiuXkKA2dpXkpqWmZeagpu_Q4g_fGEbEkAqaqH2sIItsXAyMjM2NgUUwdOU_JYgCRDA5ACGjQfn30QlQsgKvcTVnkAovI\-YZUPICpBvs0CAN1eY_c\(dq,\(dqid\(dq:\(dqfresh\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq5\-g1AAAAHxeJzLYWBg4MhgTmHgz8tPSTV0MDQy1zMAQsMcoARTIkOS_P___7MymBOZcoEC7MmJKSmJqWaYynEakaQAJJPsoaYwgE1JM0o1TjQ3T2HgLM1LSU3LzEtNwa3fAaQ_HkV_kkGyZWqSEXH6E0D666H6GcH6DYyMzIyNTUnwRR4LkGRoAFJAg\-YjwiMtOdXCwJyU8ICYtABi0n6EnwzSzIxS00yI8hPEjAMQM\-5nJTIQUPkAovI_UGUWAA0SgOI\(dq,\(dqid\(dq:\(dqupdated\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq2\-7051cbe5c8faecd085a3fa619e6e6337\(dq}]}
{\(dqseq\(dq:\(dq3\-g1AAAAHReJzLYWBg4MhgTmHgz8tPSTV0MDQy1zMAQsMcoARTIkOS_P___7MymBOZcoEC7MmJKSmJqWaYynEakaQAJJPsoaYwgE1JM0o1TjQ3T2HgLM1LSU3LzEtNwa3fAaQ_HkV_kkGyZWqSEXH6E0D660H6ExlwqspjAZIMDUAKqHA\-yCZGiEuTUy0MzEnxL8SkBRCT9iPcbJBmZpSaZkKUmyFmHICYcZ\-wux9AVIJ8mAUABgp6XQ\(dq,\(dqid\(dq:\(dqdeleted\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq2\-eec205a9d413992850a6e32678485900\(dq}],\(dqdeleted\(dq:true}
\&... tum tee tum ...
{\(dqseq\(dq:\(dq6\-g1AAAAIreJyVkEsKwjAURWMrqCOXoCuQ9MU0OrI70XyppcaRY92J7kR3ojupaVNopRQsgRd4yTlwb44QmqahQnN7VjpKImAr7E6Uu4eAI7EoiiJLQx6c3GIiuVJcx93vvQqxdFPsaguqLAY04YwpNLtYpc3RatXPJyW__\-EFllst4D_\-UPLXmh9VPAaICaEDUtixm\-jmLie6N30YqTeYDenDmx7e9GwyYRODNuu_MnnHyzverV6AMkPkAMfHO1rdUAKUkqhLZV\-_0o5j\(dq,\(dqid\(dq:\(dqupdated\(dq,\(dqchanges\(dq:[{\(dqrev\(dq:\(dq3\-825cb35de44c433bfb2df415563a19de\(dq}]}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Obviously, \fI… tum tee tum …\fP does not appear in the actual response, but
represents a long pause before the change with seq 6 occurred.
.SS Event Source
.sp
The \fIeventsource\fP feed provides push notifications that can be consumed in
the form of DOM events in the browser. Refer to the \fI\%W3C eventsource
specification\fP for further details. CouchDB also honours the \fBLast\-Event\-ID\fP
parameter.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /somedatabase/_changes?feed=eventsource HTTP/1.1
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
// define the event handling function
if (window.EventSource) {

    var source = new EventSource(\(dq/somedatabase/_changes?feed=eventsource\(dq);
    source.onerror = function(e) {
        alert(\(aqEventSource failed.\(aq);
    };

    var results = [];
    var sourceListener = function(e) {
        var data = JSON.parse(e.data);
        results.push(data);
    };

    // start listening for events
    source.addEventListener(\(aqmessage\(aq, sourceListener, false);

    // stop listening for events
    source.removeEventListener(\(aqmessage\(aq, sourceListener, false);

}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If you set a heartbeat interval (using the \fBheartbeat\fP query argument),
CouchDB will send a \fBhearbeat\fP event that you can subscribe to with:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
source.addEventListener(\(aqheartbeat\(aq, function () {}, false);
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This can be monitored by the client application to restart the EventSource
connection if needed (i.e. if the TCP connection gets stuck in a half\-open
state).
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
EventSource connections are subject to cross\-origin resource sharing
restrictions. You might need to configure \fI\%CORS support\fP to get the EventSource to work in your application.
.UNINDENT
.UNINDENT
.SS Filtering
.sp
You can filter the contents of the changes feed in a number of ways. The
most basic way is to specify one or more document IDs to the query. This
causes the returned structure value to only contain changes for the
specified IDs. Note that the value of this query argument should be a
JSON formatted array.
.sp
You can also filter the \fB_changes\fP feed by defining a filter function
within a design document. The specification for the filter is the same
as for replication filters. You specify the name of the filter function
to the \fBfilter\fP parameter, specifying the design document name and
\fI\%filter name\fP\&. For example:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /db/_changes?filter=design_doc/filtername HTTP/1.1
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Additionally, a couple of built\-in filters are available and described
below.
.SS _doc_ids
.sp
This filter accepts only changes for documents which ID in specified in
\fBdoc_ids\fP query parameter or payload’s object array. See
\fI\%POST /{db}/_changes\fP for an example.
.SS _selector
.sp
New in version 2.0.

.sp
This filter accepts only changes for documents which match a specified
selector, defined using the same \fI\%selector
syntax\fP used for \fI\%_find\fP\&.
.sp
This is significantly more efficient than using a JavaScript filter
function and is the recommended option if filtering on document attributes only.
.sp
Note that, unlike JavaScript filters, selectors do not have access to the
request object.
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST /recipes/_changes?filter=_selector HTTP/1.1
Content\-Type: application/json
Host: localhost:5984

{
    \(dqselector\(dq: { \(dq_id\(dq: { \(dq$regex\(dq: \(dq^_design/\(dq } }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Tue, 06 Sep 2016 20:03:23 GMT
Etag: \(dq1H8RGBCK3ABY6ACDM7ZSC30QK\(dq
Server: CouchDB (Erlang OTP/18)
Transfer\-Encoding: chunked

{
    \(dqlast_seq\(dq: \(dq11\-g1AAAAIreJyVkEEKwjAQRUOrqCuPoCeQZGIaXdmbaNIk1FLjyrXeRG\-iN9Gb1LQRaimFlsAEJnkP_s8RQtM0VGhuz0qTmABfYXdI7h4CgeSiKIosDUVwcotJIpQSOmp_71TIpZty97OgymJAU8G5QrOLVdocrVbdfFzy\-wYvcbLVEvrxh5K_NlJggIhSNiCFHbmJbu5yonttMoneYD6kD296eNOzzoRNBNqse2Xyjpd3vP96AcYNTQY4Pt5RdTOuHIwCY5S0qewLwY6OaA\(dq,
    \(dqpending\(dq: 0,
    \(dqresults\(dq: [
        {
            \(dqchanges\(dq: [
                {
                    \(dqrev\(dq: \(dq10\-304cae84fd862832ea9814f02920d4b2\(dq
                }
            ],
            \(dqid\(dq: \(dq_design/ingredients\(dq,
            \(dqseq\(dq: \(dq8\-g1AAAAHxeJzLYWBg4MhgTmHgz8tPSTV0MDQy1zMAQsMcoARTIkOS_P___7MymBOZcoEC7MmJKSmJqWaYynEakaQAJJPsoaYwgE1JM0o1TjQ3T2HgLM1LSU3LzEtNwa3fAaQ_HkV_kkGyZWqSEXH6E0D666H6GcH6DYyMzIyNTUnwRR4LkGRoAFJAg\-ZnJTIQULkAonI_ws0GaWZGqWkmRLkZYsYBiBn3Cdv2AKIS7ENWsG2mxkampsaGmLqyAOYpgEo\(dq
        },
        {
            \(dqchanges\(dq: [
                {
                    \(dqrev\(dq: \(dq123\-6f7c1b7c97a9e4f0d22bdf130e8fd817\(dq
                }
            ],
            \(dqdeleted\(dq: true,
            \(dqid\(dq: \(dq_design/cookbook\(dq,
            \(dqseq\(dq: \(dq9\-g1AAAAHxeJzLYWBg4MhgTmHgz8tPSTV0MDQy1zMAQsMcoARTIkOS_P___7MymBOZcoEC7MmJKSmJqWaYynEakaQAJJPsoaYwgE1JM0o1TjQ3T2HgLM1LSU3LzEtNwa3fAaQ_HkV_kkGyZWqSEXH6E0D661F8YWBkZGZsbEqCL_JYgCRDA5ACGjQ_K5GBgMoFEJX7EW42SDMzSk0zIcrNEDMOQMy4T9i2BxCVYB\-ygm0zNTYyNTU2xNSVBQDnK4BL\(dq
        },
        {
            \(dqchanges\(dq: [
                {
                    \(dqrev\(dq: \(dq6\-5b8a52c22580e922e792047cff3618f3\(dq
                }
            ],
            \(dqdeleted\(dq: true,
            \(dqid\(dq: \(dq_design/meta\(dq,
            \(dqseq\(dq: \(dq11\-g1AAAAIReJyVkE0OgjAQRiegUVceQU9g\-mOpruQm2tI2SLCuXOtN9CZ6E70JFmpCCCFCmkyTdt6bfJMDwDQNFcztWWkcY8JXyB2cu49AgFwURZGloQhO7mGSCKWEjtrtnQq5dFXufhaoLIZoKjhXMLtYpc3RatXNxyW_b_ASJVstST_\-UPLXRgpESEQpG5DCjlyFm7uc6F6bTKI3iA_Zhzc9vOlZZ0ImItqse2Xyjpd3vDMBfzo_vrPawLiaxihhjOI2lX0BirqHbg\(dq
        }
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Missing selector
.sp
If the selector object is missing from the request body,
the error message is similar to the following example:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
   \(dqerror\(dq: \(dqbad request\(dq,
   \(dqreason\(dq: \(dqSelector must be specified in POST payload\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Not a valid JSON object
.sp
If the selector object is not a well\-formed JSON object,
the error message is similar to the following example:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
   \(dqerror\(dq: \(dqbad request\(dq,
   \(dqreason\(dq: \(dqSelector error: expected a JSON object\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Not a valid selector
.sp
If the selector object does not contain a valid selection expression,
the error message is similar to the following example:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
   \(dqerror\(dq: \(dqbad request\(dq,
   \(dqreason\(dq: \(dqSelector error: expected a JSON object\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS _design
.sp
The \fB_design\fP filter accepts only changes for any design document within the
requested database.
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes/_changes?filter=_design HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Tue, 06 Sep 2016 12:55:12 GMT
ETag: \(dqARIHFWL3I7PIS0SPVTFU6TLR2\(dq
Server: CouchDB (Erlang OTP)
Transfer\-Encoding: chunked

{
    \(dqlast_seq\(dq: \(dq11\-g1AAAAIreJyVkEEKwjAQRUOrqCuPoCeQZGIaXdmbaNIk1FLjyrXeRG\-iN9Gb1LQRaimFlsAEJnkP_s8RQtM0VGhuz0qTmABfYXdI7h4CgeSiKIosDUVwcotJIpQSOmp_71TIpZty97OgymJAU8G5QrOLVdocrVbdfFzy\-wYvcbLVEvrxh5K_NlJggIhSNiCFHbmJbu5yonttMoneYD6kD296eNOzzoRNBNqse2Xyjpd3vP96AcYNTQY4Pt5RdTOuHIwCY5S0qewLwY6OaA\(dq,
    \(dqpending\(dq: 0,
    \(dqresults\(dq: [
        {
            \(dqchanges\(dq: [
                {
                    \(dqrev\(dq: \(dq10\-304cae84fd862832ea9814f02920d4b2\(dq
                }
            ],
            \(dqid\(dq: \(dq_design/ingredients\(dq,
            \(dqseq\(dq: \(dq8\-g1AAAAHxeJzLYWBg4MhgTmHgz8tPSTV0MDQy1zMAQsMcoARTIkOS_P___7MymBOZcoEC7MmJKSmJqWaYynEakaQAJJPsoaYwgE1JM0o1TjQ3T2HgLM1LSU3LzEtNwa3fAaQ_HkV_kkGyZWqSEXH6E0D666H6GcH6DYyMzIyNTUnwRR4LkGRoAFJAg\-ZnJTIQULkAonI_ws0GaWZGqWkmRLkZYsYBiBn3Cdv2AKIS7ENWsG2mxkampsaGmLqyAOYpgEo\(dq
        },
        {
            \(dqchanges\(dq: [
                {
                    \(dqrev\(dq: \(dq123\-6f7c1b7c97a9e4f0d22bdf130e8fd817\(dq
                }
            ],
            \(dqdeleted\(dq: true,
            \(dqid\(dq: \(dq_design/cookbook\(dq,
            \(dqseq\(dq: \(dq9\-g1AAAAHxeJzLYWBg4MhgTmHgz8tPSTV0MDQy1zMAQsMcoARTIkOS_P___7MymBOZcoEC7MmJKSmJqWaYynEakaQAJJPsoaYwgE1JM0o1TjQ3T2HgLM1LSU3LzEtNwa3fAaQ_HkV_kkGyZWqSEXH6E0D661F8YWBkZGZsbEqCL_JYgCRDA5ACGjQ_K5GBgMoFEJX7EW42SDMzSk0zIcrNEDMOQMy4T9i2BxCVYB\-ygm0zNTYyNTU2xNSVBQDnK4BL\(dq
        },
        {
            \(dqchanges\(dq: [
                {
                    \(dqrev\(dq: \(dq6\-5b8a52c22580e922e792047cff3618f3\(dq
                }
            ],
            \(dqdeleted\(dq: true,
            \(dqid\(dq: \(dq_design/meta\(dq,
            \(dqseq\(dq: \(dq11\-g1AAAAIReJyVkE0OgjAQRiegUVceQU9g\-mOpruQm2tI2SLCuXOtN9CZ6E70JFmpCCCFCmkyTdt6bfJMDwDQNFcztWWkcY8JXyB2cu49AgFwURZGloQhO7mGSCKWEjtrtnQq5dFXufhaoLIZoKjhXMLtYpc3RatXNxyW_b_ASJVstST_\-UPLXRgpESEQpG5DCjlyFm7uc6F6bTKI3iA_Zhzc9vOlZZ0ImItqse2Xyjpd3vDMBfzo_vrPawLiaxihhjOI2lX0BirqHbg\(dq
        }
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS _view
.sp
New in version 1.2.

.sp
The special filter \fB_view\fP allows to use existing
\fI\%map function\fP as the \fI\%filter\fP\&. If the map
function emits anything for the processed document it counts as accepted and
the changes event emits to the feed. For most use\-practice cases \fIfilter\fP
functions are very similar to \fImap\fP ones, so this feature helps to reduce
amount of duplicated code.
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
While \fI\%map functions\fP doesn’t process the design documents,
using \fB_view\fP filter forces them to do this. You need to be sure, that
they are ready to handle documents with \fIalien\fP structure without panic.
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Using \fB_view\fP filter doesn’t queries the view index files, so you cannot
use common \fI\%view query parameters\fP to additionally
filter the changes feed by index key. Also, CouchDB doesn’t returns
the result instantly as it does for views \- it really uses the specified
map function as filter.
.sp
Moreover, you cannot make such filters dynamic e.g. process the request
query parameters or handle the \fI\%User Context Object\fP \- the map function is
only operates with the document.
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes/_changes?filter=_view&view=ingredients/by_recipe HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Tue, 06 Sep 2016 12:57:56 GMT
ETag: \(dqARIHFWL3I7PIS0SPVTFU6TLR2\(dq
Server: CouchDB (Erlang OTP)
Transfer\-Encoding: chunked

{
    \(dqlast_seq\(dq: \(dq11\-g1AAAAIreJyVkEEKwjAQRUOrqCuPoCeQZGIaXdmbaNIk1FLjyrXeRG\-iN9Gb1LQRaimFlsAEJnkP_s8RQtM0VGhuz0qTmABfYXdI7h4CgeSiKIosDUVwcotJIpQSOmp_71TIpZty97OgymJAU8G5QrOLVdocrVbdfFzy\-wYvcbLVEvrxh5K_NlJggIhSNiCFHbmJbu5yonttMoneYD6kD296eNOzzoRNBNqse2Xyjpd3vP96AcYNTQY4Pt5RdTOuHIwCY5S0qewLwY6OaA\(dq,
    \(dqresults\(dq: [
        {
            \(dqchanges\(dq: [
                {
                    \(dqrev\(dq: \(dq13\-bcb9d6388b60fd1e960d9ec4e8e3f29e\(dq
                }
            ],
            \(dqid\(dq: \(dqSpaghettiWithMeatballs\(dq,
            \(dqseq\(dq: \(dq11\-g1AAAAIReJyVkE0OgjAQRiegUVceQU9g\-mOpruQm2tI2SLCuXOtN9CZ6E70JFmpCCCFCmkyTdt6bfJMDwDQNFcztWWkcY8JXyB2cu49AgFwURZGloQhO7mGSCKWEjtrtnQq5dFXufhaoLIZoKjhXMLtYpc3RatXNxyW_b_ASJVstST_\-UPLXRgpESEQpG5DCjlyFm7uc6F6bTKI3iA_Zhzc9vOlZZ0ImItqse2Xyjpd3vDMBfzo_vrPawLiaxihhjOI2lX0BirqHbg\(dq
        }
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS \fB/db/_compact\fP
.INDENT 0.0
.TP
.B POST /{db}/_compact
Request compaction of the specified database. Compaction compresses the
disk database file by performing the following operations:
.INDENT 7.0
.IP \(bu 2
Writes a new, optimised, version of the database file, removing any
unused sections from the new version during write. Because a new file is
temporarily created for this purpose, you may require up to twice the
current storage space of the specified database in order for the
compaction routine to complete.
.IP \(bu 2
Removes the bodies of any non\-leaf revisions of documents from the
database.
.IP \(bu 2
Removes old revision history beyond the limit specified by the
\fB_revs_limit\fP database parameter.
.UNINDENT
.sp
Compaction can only be requested on an individual database; you cannot
compact all the databases for a CouchDB instance. The compaction process
runs as a background process.
.sp
You can determine if the compaction process is operating on a database
by obtaining the database meta information, the \fBcompact_running\fP
value of the returned database structure will be set to true. See
\fI\%GET /{db}\fP\&.
.sp
You can also obtain a list of running processes to determine whether
compaction is currently running. See \fI\%/_active_tasks\fP\&.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.IP \(bu 2
\fI\%Content\-Type\fP – \fIapplication/json\fP
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBok\fP (\fIboolean\fP) – Operation status
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%202 Accepted\fP – Compaction request has been accepted
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid database name
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.IP \(bu 2
\fI\%415 Unsupported Media Type\fP – Bad \fI\%Content\-Type\fP value
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /db/_compact HTTP/1.1
Accept: application/json
Content\-Type: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 202 Accepted
Cache\-Control: must\-revalidate
Content\-Length: 12
Content\-Type: application/json
Date: Mon, 12 Aug 2013 09:27:43 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqok\(dq: true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/db/_compact/design\-doc\fP
.INDENT 0.0
.TP
.B POST /{db}/_compact/{ddoc}
Compacts the view indexes associated with the specified design document.
It may be that compacting a large view can return more storage than
compacting the actual db. Thus, you can use this in place of the full
database compaction if you know a specific set of view indexes have been
affected by a recent database change.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBddoc\fP – Design document name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.IP \(bu 2
\fI\%Content\-Type\fP – \fIapplication/json\fP
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBok\fP (\fIboolean\fP) – Operation status
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%202 Accepted\fP – Compaction request has been accepted
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid database name
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.IP \(bu 2
\fI\%404 Not Found\fP – Design document not found
.IP \(bu 2
\fI\%415 Unsupported Media Type\fP – Bad \fI\%Content\-Type\fP value
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /db/_compact/posts HTTP/1.1
Accept: application/json
Content\-Type: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 202 Accepted
Cache\-Control: must\-revalidate
Content\-Length: 12
Content\-Type: application/json
Date: Mon, 12 Aug 2013 09:36:44 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqok\(dq: true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 7.0
.INDENT 3.5
View indexes are stored in a separate \fB\&.couch\fP file based on a hash
of the design document’s relevant functions, in a sub directory of
where the main \fB\&.couch\fP database files are located.
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/db/_ensure_full_commit\fP
.INDENT 0.0
.TP
.B POST /{db}/_ensure_full_commit
Changed in version 3.0.0: Deprecated; endpoint is a no\-op.

.sp
Before 3.0 this was used to commit recent changes to the database in case
the \fBdelayed_commits=true\fP option was set. That option is always
\fBfalse\fP now, so commits are never delayed. However, this endpoint is kept
for compatibility with older replicators.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.IP \(bu 2
\fI\%Content\-Type\fP – \fIapplication/json\fP
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBinstance_start_time\fP (\fIstring\fP) – Always \fB\(dq0\(dq\fP\&. (Returned for legacy
reasons.)
.IP \(bu 2
\fBok\fP (\fIboolean\fP) – Operation status
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%201 Created\fP – Commit completed successfully
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid database name
.IP \(bu 2
\fI\%415 Unsupported Media Type\fP – Bad \fI\%Content\-Type\fP value
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /db/_ensure_full_commit HTTP/1.1
Accept: application/json
Content\-Type: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Cache\-Control: must\-revalidate
Content\-Length: 53
Content\-Type: application/json
Date: Mon, 12 Aug 2013 10:22:19 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqinstance_start_time\(dq: \(dq0\(dq,
    \(dqok\(dq: true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/db/_view_cleanup\fP
.INDENT 0.0
.TP
.B POST /{db}/_view_cleanup
Removes view index files that are no longer required by CouchDB as a result
of changed views within design documents. As the view filename is based on
a hash of the view functions, over time old views will remain, consuming
storage. This call cleans up the cached view output on disk for
a given view.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.IP \(bu 2
\fI\%Content\-Type\fP – \fIapplication/json\fP
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBok\fP (\fIboolean\fP) – Operation status
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%202 Accepted\fP – Compaction request has been accepted
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid database name
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.IP \(bu 2
\fI\%415 Unsupported Media Type\fP – Bad \fI\%Content\-Type\fP value
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /db/_view_cleanup HTTP/1.1
Accept: application/json
Content\-Type: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 202 Accepted
Cache\-Control: must\-revalidate
Content\-Length: 12
Content\-Type: application/json
Date: Mon, 12 Aug 2013 09:27:43 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqok\(dq: true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/db/_security\fP
.INDENT 0.0
.TP
.B GET /{db}/_security
Returns the current security object from the specified database.
.sp
The security object consists of two compulsory elements, \fBadmins\fP
and \fBmembers\fP, which are used to specify the list of users and/or roles
that have admin and members rights to the database respectively:
.INDENT 7.0
.IP \(bu 2
\fBmembers\fP: they can read all types of documents from the DB, and they
can write (and edit) documents to the DB except for design documents.
.IP \(bu 2
\fBadmins\fP: they have all the privileges of \fBmembers\fP plus the
privileges: write (and edit) design documents, add/remove database admins
and members and set the \fI\%database revisions limit\fP\&. They can not create a database nor delete a
database.
.UNINDENT
.sp
Both \fBmembers\fP and \fBadmins\fP objects contain two array\-typed fields:
.INDENT 7.0
.IP \(bu 2
\fBnames\fP: List of CouchDB user names
.IP \(bu 2
\fBroles\fP: List of users roles
.UNINDENT
.sp
Any additional fields in the security object are optional.
The entire security object is made available to validation and other
internal functions so that the database can control and limit
functionality.
.sp
If both the names and roles fields of either the admins or members
properties are empty arrays, or are not existent, it means the database
has no admins or members.
.sp
Having no admins, only server admins (with the reserved \fB_admin\fP role)
are able to update design documents and make other admin level changes.
.sp
Having no members or roles, any user can write regular documents (any
non\-design document) and read documents from the database.
.sp
Since CouchDB 3.x newly created databases have by default the _admin role
to prevent unintentional access.
.sp
If there are any member names or roles defined for a database, then only
authenticated users having a matching name or role are allowed to read
documents from the database (or do a \fI\%GET /{db}\fP call).
.sp
\fBNOTE:\fP
.INDENT 7.0
.INDENT 3.5
If the security object for a database has never been set, then the
value returned will be empty.
.sp
Also note, that security objects are not regular versioned documents
(that is, they are not under MVCC rules). This is a design choice to
speed up authorization checks (avoids traversing a database’s documents
B\-Tree).
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBadmins\fP (\fIobject\fP) – Object with two fields as \fBnames\fP and \fBroles\fP\&.
See description above for more info.
.IP \(bu 2
\fBmembers\fP (\fIobject\fP) – Object with two fields as \fBnames\fP and \fBroles\fP\&.
See description above for more info.
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /db/_security HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 109
Content\-Type: application/json
Date: Mon, 12 Aug 2013 19:05:29 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqadmins\(dq: {
        \(dqnames\(dq: [
            \(dqsuperuser\(dq
        ],
        \(dqroles\(dq: [
            \(dqadmins\(dq
        ]
    },
    \(dqmembers\(dq: {
        \(dqnames\(dq: [
            \(dquser1\(dq,
            \(dquser2\(dq
        ],
        \(dqroles\(dq: [
            \(dqdevelopers\(dq
        ]
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B PUT /{db}/_security
Sets the security object for the given database.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.IP \(bu 2
\fI\%Content\-Type\fP – \fIapplication/json\fP
.UNINDENT
.TP
.B Request JSON Object
.INDENT 7.0
.IP \(bu 2
\fBadmins\fP (\fIobject\fP) – Object with two fields as \fBnames\fP and \fBroles\fP\&.
\fI\%See description above for more info\fP\&.
.IP \(bu 2
\fBmembers\fP (\fIobject\fP) – Object with two fields as \fBnames\fP and \fBroles\fP\&.
\fI\%See description above for more info\fP\&.
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBok\fP (\fIboolean\fP) – Operation status
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%401 Unauthorized\fP – CouchDB Server Administrator privileges required
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
shell> curl http://localhost:5984/pineapple/_security \-X PUT \-H \(aqcontent\-type: application/json\(aq \-H \(aqaccept: application/json\(aq \-d \(aq{\(dqadmins\(dq:{\(dqnames\(dq:[\(dqsuperuser\(dq],\(dqroles\(dq:[\(dqadmins\(dq]},\(dqmembers\(dq:{\(dqnames\(dq: [\(dquser1\(dq,\(dquser2\(dq],\(dqroles\(dq: [\(dqdevelopers\(dq]}}\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
PUT /db/_security HTTP/1.1
Accept: application/json
Content\-Length: 121
Content\-Type: application/json
Host: localhost:5984

{
    \(dqadmins\(dq: {
        \(dqnames\(dq: [
            \(dqsuperuser\(dq
        ],
        \(dqroles\(dq: [
            \(dqadmins\(dq
        ]
    },
    \(dqmembers\(dq: {
        \(dqnames\(dq: [
            \(dquser1\(dq,
            \(dquser2\(dq
        ],
        \(dqroles\(dq: [
            \(dqdevelopers\(dq
        ]
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 12
Content\-Type: application/json
Date: Tue, 13 Aug 2013 11:26:28 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqok\(dq: true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/db/_purge\fP
.INDENT 0.0
.TP
.B POST /{db}/_purge
A database purge permanently removes the references to documents
in the database. Normal deletion of a document within CouchDB does not
remove the document from the database, instead, the document is marked as
\fB_deleted=true\fP (and a new revision is created). This is to ensure that
deleted documents can be replicated to other databases as having been
deleted. This also means that you can check the status of a document and
identify that the document has been deleted by its absence.
.sp
The purge request must include the document IDs, and for each
document ID, one or more revisions that must be purged. Documents can be
previously deleted, but it is not necessary. Revisions must be leaf
revisions.
.sp
The response will contain a list of the document IDs and revisions
successfully purged.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.IP \(bu 2
\fI\%Content\-Type\fP – \fIapplication/json\fP
.UNINDENT
.TP
.B Request JSON Object
.INDENT 7.0
.IP \(bu 2
\fBobject\fP – Mapping of document ID to list of revisions to purge
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBpurge_seq\fP (\fIstring\fP) – Purge sequence string
.IP \(bu 2
\fBpurged\fP (\fIobject\fP) – Mapping of document ID to list of purged revisions
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%201 Created\fP – Request completed successfully
.IP \(bu 2
\fI\%202 Accepted\fP – Request was accepted, and was completed successfully on at least
one replica, but quorum was not reached.
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid database name or JSON payload
.IP \(bu 2
\fI\%415 Unsupported Media Type\fP – Bad \fI\%Content\-Type\fP value
.IP \(bu 2
\fI\%500 Internal Server Error\fP – Internal server error or timeout
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /db/_purge HTTP/1.1
Accept: application/json
Content\-Length: 76
Content\-Type: application/json
Host: localhost:5984

{
    \(dqc6114c65e295552ab1019e2b046b10e\(dq: [
        \(dq3\-b06fcd1c1c9e0ec7c480ee8aa467bf3b\(dq,
        \(dq3\-c50a32451890a3f1c3e423334cc92745\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Cache\-Control: must\-revalidate
Content\-Length: 107
Content\-Type: application/json
Date: Fri, 02 Jun 2017 18:55:54 GMT
Server: CouchDB/2.0.0\-2ccd4bf (Erlang OTP/18)

{
  \(dqpurge_seq\(dq: null,
  \(dqpurged\(dq: {
    \(dqc6114c65e295552ab1019e2b046b10e\(dq: [
        \(dq3\-c50a32451890a3f1c3e423334cc92745\(dq
      ]
  }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.INDENT 2.5
[image: Document Revision Tree 1]
[image]
Document Revision Tree 1.UNINDENT
.UNINDENT
.sp
For example, given the above purge tree and issuing the above purge request,
the whole document will be purged, as it contains only a single branch with a
leaf revision  \fI3\-c50a32451890a3f1c3e423334cc92745\fP that will be purged.
As a result of this purge operation, a document with
\fI_id:c6114c65e295552ab1019e2b046b10e\fP will be completely removed from the
database’s document b+tree, and sequence b+tree. It will not be available
through \fB_all_docs\fP or \fB_changes\fP endpoints, as though this document never
existed. Also as a result of purge operation, the database’s \fBpurge_seq\fP and
\fBupdate_seq\fP will be increased.
.sp
Notice, how revision \fI3\-b06fcd1c1c9e0ec7c480ee8aa467bf3b\fP was ignored. Revisions
that have already been purged and non\-leaf revisions are ignored in a purge
request.
.sp
If a document has two conflict revisions with the following revision history:
.INDENT 0.0
.INDENT 2.5
[image: Document Revision Tree 1]
[image]
Document Revision Tree 2.UNINDENT
.UNINDENT
.sp
the above purge request will purge only one branch, leaving the document’s
revision tree with only a single branch:
.INDENT 0.0
.INDENT 2.5
[image: Document Revision Tree 3]
[image]
Document Revision Tree 3.UNINDENT
.UNINDENT
.sp
As a result of this purge operation, a new updated version of the document will
be available in \fB_all_docs\fP and \fB_changes\fP, creating a new record in \fB_changes\fP\&.
The database’s \fBpurge_seq\fP and \fBupdate_seq\fP will be increased.
.SS Internal Replication
.sp
Purges are automatically replicated between replicas of the same database. Each
database has an internal purge tree that stores a certain number of the most
recent purges. This allows internal synchronization between replicas of the same
database.
.SS External Replication
.sp
Purge operations are not replicated to other external databases. External
replication works by identifying a source’s document revisions that are missing
on target, and copying these revisions from source to target. A purge operation
completely purges revisions from a document’s purge tree making external
replication of purges impossible.
.INDENT 0.0
.INDENT 3.5
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
If you need a purge to be effective across multiple effective databases, you
must run the purge separately on each of the databases.
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.SS Updating Indexes
.sp
The number of purges on a database is tracked using a purge sequence. This is
used by the view indexer to optimize the updating of views that contain the
purged documents.
.sp
Each internal database indexer, including the view indexer, keeps its own purge
sequence. The purge sequence stored in the index can be much smaller than the
database’s purge sequence up to the number of purge requests allowed to be
stored in the purge trees of the database. Multiple purge requests can be
processed by the indexer without incurring a rebuild of the index. The index
will be updated according to these purge requests.
.sp
The index of documents is based on the winner of the revision tree. Depending on
which revision is specified in the purge request, the index update observes the
following behavior:
.INDENT 0.0
.IP \(bu 2
If the winner of the revision tree is not specified in the purge request,
there is no change to the index record of this document.
.IP \(bu 2
If the winner of the revision tree is specified in the purge request, and
there is still a revision left after purging, the index record of the document
will be built according to the new winner of the revision tree.
.IP \(bu 2
If all revisions of the document are specified in the purge request, the index
record of the document will be deleted. The document will no longer be found
in searches.
.UNINDENT
.SS \fB/db/_purged_infos_limit\fP
.INDENT 0.0
.TP
.B GET /{db}/_purged_infos_limit
Gets the current \fBpurged_infos_limit\fP (purged documents limit) setting,
the maximum number of historical purges (purged document Ids with their
revisions) that can be stored in the database.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /db/_purged_infos_limit HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 5
Content\-Type: application/json
Date: Wed, 14 Jun 2017 14:43:42 GMT
Server: CouchDB (Erlang/OTP)

1000
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B PUT /{db}/_purged_infos_limit
Sets the maximum number of purges (requested purged Ids with their
revisions) that will be tracked in the database, even after compaction has
occurred. You can set the purged documents limit on a database with a scalar
integer of the limit that you want to set as the request body.
.sp
The default value of historical stored purges is 1000. This means up to 1000
purges can be synchronized between replicas of the same databases in case of
one of the replicas was down when purges occurred.
.sp
This request sets the soft limit for stored purges. During the compaction
CouchDB will try to keep only \fI_purged_infos_limit\fP of purges in the
database, but occasionally the number of stored purges can exceed this
value. If a database has not completed purge synchronization with active
indexes or active internal replications, it may temporarily store a higher
number of historical purges.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.IP \(bu 2
\fI\%Content\-Type\fP – \fIapplication/json\fP
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBok\fP (\fIboolean\fP) – Operation status
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid JSON data
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
PUT /db/_purged_infos_limit HTTP/1.1
Accept: application/json
Content\-Length: 4
Content\-Type: application/json
Host: localhost:5984

1500
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 12
Content\-Type: application/json
Date: Wed, 14 Jun 2017 14:45:34 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqok\(dq: true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/db/_missing_revs\fP
.INDENT 0.0
.TP
.B POST /{db}/_missing_revs
With given a list of document revisions, returns the document revisions
that do not exist in the database.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.IP \(bu 2
\fI\%Content\-Type\fP – \fIapplication/json\fP
.UNINDENT
.TP
.B Request JSON Object
.INDENT 7.0
.IP \(bu 2
\fBobject\fP – Mapping of document ID to list of revisions to lookup
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBmissing_revs\fP (\fIobject\fP) – Mapping of document ID to list of missed
revisions
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid database name or JSON payload
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /db/_missing_revs HTTP/1.1
Accept: application/json
Content\-Length: 76
Content\-Type: application/json
Host: localhost:5984

{
    \(dqc6114c65e295552ab1019e2b046b10e\(dq: [
        \(dq3\-b06fcd1c1c9e0ec7c480ee8aa467bf3b\(dq,
        \(dq3\-0e871ef78849b0c206091f1a7af6ec41\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 64
Content\-Type: application/json
Date: Mon, 12 Aug 2013 10:53:24 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqmissing_revs\(dq:{
        \(dqc6114c65e295552ab1019e2b046b10e\(dq: [
            \(dq3\-b06fcd1c1c9e0ec7c480ee8aa467bf3b\(dq
        ]
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/db/_revs_diff\fP
.INDENT 0.0
.TP
.B POST /{db}/_revs_diff
Given a set of document/revision IDs, returns the subset of those that do
not correspond to revisions stored in the database.
.sp
Its primary use is by the replicator, as an important optimization: after
receiving a set of new revision IDs from the source database, the
replicator sends this set to the destination database’s \fB_revs_diff\fP to
find out which of them already exist there. It can then avoid fetching and
sending already\-known document bodies.
.sp
Both the request and response bodies are JSON objects whose keys are
document IDs; but the values are structured differently:
.INDENT 7.0
.IP \(bu 2
In the request, a value is an array of revision IDs for that document.
.IP \(bu 2
In the response, a value is an object with a \fBmissing\fP: key, whose
value is a list of revision IDs for that document (the ones that are not
stored in the database) and optionally a \fBpossible_ancestors\fP key,
whose value is an array of revision IDs that are known that might be
ancestors of the missing revisions.
.UNINDENT
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.IP \(bu 2
\fI\%Content\-Type\fP – \fIapplication/json\fP
.UNINDENT
.TP
.B Request JSON Object
.INDENT 7.0
.IP \(bu 2
\fBobject\fP – Mapping of document ID to list of revisions to lookup
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBmissing\fP (\fIarray\fP) – List of missed revisions for specified document
.IP \(bu 2
\fBpossible_ancestors\fP (\fIarray\fP) – List of revisions that \fImay be\fP ancestors
for specified document and its current revision in requested database
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid database name or JSON payload
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /db/_revs_diff HTTP/1.1
Accept: application/json
Content\-Length: 113
Content\-Type: application/json
Host: localhost:5984

{
    \(dq190f721ca3411be7aa9477db5f948bbb\(dq: [
        \(dq3\-bb72a7682290f94a985f7afac8b27137\(dq,
        \(dq4\-10265e5a26d807a3cfa459cf1a82ef2e\(dq,
        \(dq5\-067a00dff5e02add41819138abb3284d\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 88
Content\-Type: application/json
Date: Mon, 12 Aug 2013 16:56:02 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dq190f721ca3411be7aa9477db5f948bbb\(dq: {
        \(dqmissing\(dq: [
            \(dq3\-bb72a7682290f94a985f7afac8b27137\(dq,
            \(dq5\-067a00dff5e02add41819138abb3284d\(dq
        ],
        \(dqpossible_ancestors\(dq: [
            \(dq4\-10265e5a26d807a3cfa459cf1a82ef2e\(dq
        ]
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/db/_revs_limit\fP
.INDENT 0.0
.TP
.B GET /{db}/_revs_limit
Gets the current \fBrevs_limit\fP (revision limit) setting.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /db/_revs_limit HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 5
Content\-Type: application/json
Date: Mon, 12 Aug 2013 17:27:30 GMT
Server: CouchDB (Erlang/OTP)

1000
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B PUT /{db}/_revs_limit
Sets the maximum number of document revisions that will be tracked by
CouchDB, even after compaction has occurred. You can set the revision limit
on a database with a scalar integer of the limit that you want to set as
the request body.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.IP \(bu 2
\fI\%Content\-Type\fP – \fIapplication/json\fP
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBok\fP (\fIboolean\fP) – Operation status
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid JSON data
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
PUT /db/_revs_limit HTTP/1.1
Accept: application/json
Content\-Length: 5
Content\-Type: application/json
Host: localhost:5984

1000
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 12
Content\-Type: application/json
Date: Mon, 12 Aug 2013 17:47:52 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqok\(dq: true
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS Documents
.sp
Details on how to create, read, update and delete documents within a database.
.SS \fB/db/doc\fP
.INDENT 0.0
.TP
.B HEAD /{db}/{docid}
Returns the HTTP Headers containing a minimal amount of information about
the specified document. The method supports the same query arguments as the
\fI\%GET /{db}/{docid}\fP method, but only the header information (including
document size, and the revision as an ETag), is returned.
.sp
The \fI\%ETag\fP header shows the current revision for the requested
document, and the \fI\%Content\-Length\fP specifies the length of the
data, if the document were requested in full.
.sp
Adding any of the query arguments (see \fI\%GET /{db}/{docid}\fP), then the
resulting HTTP Headers will correspond to what would be returned.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBdocid\fP – Document ID
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%If\-None\-Match\fP – Double quoted document’s revision token
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Length\fP – Document size
.IP \(bu 2
\fI\%ETag\fP – Double quoted document’s revision token
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Document exists
.IP \(bu 2
\fI\%304 Not Modified\fP – Document wasn’t modified since specified revision
.IP \(bu 2
\fI\%401 Unauthorized\fP – Read privilege required
.IP \(bu 2
\fI\%404 Not Found\fP – Document not found
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HEAD /db/SpaghettiWithMeatballs HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 660
Content\-Type: application/json
Date: Tue, 13 Aug 2013 21:35:37 GMT
ETag: \(dq12\-151bb8678d45aaa949ec3698ef1c7e78\(dq
Server: CouchDB (Erlang/OTP)
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B GET /{db}/{docid}
Returns document by the specified \fBdocid\fP from the specified \fBdb\fP\&.
Unless you request a specific revision, the latest revision of the document
will always be returned.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBdocid\fP – Document ID
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fImultipart/related\fP
.IP \(bu 2
\fImultipart/mixed\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.IP \(bu 2
\fI\%If\-None\-Match\fP – Double quoted document’s revision token
.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBattachments\fP (\fIboolean\fP) – Includes attachments bodies in response.
Default is \fBfalse\fP
.IP \(bu 2
\fBatt_encoding_info\fP (\fIboolean\fP) – Includes encoding information in
attachment stubs if the particular attachment is compressed. Default is
\fBfalse\fP\&.
.IP \(bu 2
\fBatts_since\fP (\fIarray\fP) – Includes attachments only since specified
revisions. Doesn’t includes attachments for specified revisions.
\fIOptional\fP
.IP \(bu 2
\fBconflicts\fP (\fIboolean\fP) – Includes information about conflicts in document.
Default is \fBfalse\fP
.IP \(bu 2
\fBdeleted_conflicts\fP (\fIboolean\fP) – Includes information about deleted
conflicted revisions. Default is \fBfalse\fP
.IP \(bu 2
\fBlatest\fP (\fIboolean\fP) – Forces retrieving latest “leaf” revision, no matter
what \fIrev\fP was requested. Default is \fBfalse\fP
.IP \(bu 2
\fBlocal_seq\fP (\fIboolean\fP) – Includes last update sequence for the
document. Default is \fBfalse\fP
.IP \(bu 2
\fBmeta\fP (\fIboolean\fP) – Acts same as specifying all \fBconflicts\fP,
\fBdeleted_conflicts\fP and \fBrevs_info\fP query parameters. Default is
\fBfalse\fP
.IP \(bu 2
\fBopen_revs\fP (\fIarray\fP) – Retrieves documents of specified leaf revisions.
Additionally, it accepts value as \fBall\fP to return all leaf revisions.
\fIOptional\fP
.IP \(bu 2
\fBrev\fP (\fIstring\fP) – Retrieves document of specified revision. \fIOptional\fP
.IP \(bu 2
\fBrevs\fP (\fIboolean\fP) – Includes list of all known document revisions.
Default is \fBfalse\fP
.IP \(bu 2
\fBrevs_info\fP (\fIboolean\fP) – Includes detailed information for all known
document revisions. Default is \fBfalse\fP
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fImultipart/related\fP
.IP \(bu 2
\fImultipart/mixed\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.IP \(bu 2
\fI\%ETag\fP – Double quoted document’s revision token. Not available when
retrieving conflicts\-related information
.IP \(bu 2
\fI\%Transfer\-Encoding\fP – \fBchunked\fP\&. Available if requested with query
parameter \fBopen_revs\fP
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fB_id\fP (\fIstring\fP) – Document ID
.IP \(bu 2
\fB_rev\fP (\fIstring\fP) – Revision MVCC token
.IP \(bu 2
\fB_deleted\fP (\fIboolean\fP) – Deletion flag. Available if document was removed
.IP \(bu 2
\fB_attachments\fP (\fIobject\fP) – Attachment’s stubs. Available if document has
any attachments
.IP \(bu 2
\fB_conflicts\fP (\fIarray\fP) – List of conflicted revisions. Available if
requested with \fBconflicts=true\fP query parameter
.IP \(bu 2
\fB_deleted_conflicts\fP (\fIarray\fP) – List of deleted conflicted revisions.
Available if requested with \fBdeleted_conflicts=true\fP query parameter
.IP \(bu 2
\fB_local_seq\fP (\fIstring\fP) – Document’s update sequence in current database.
Available if requested with \fBlocal_seq=true\fP query parameter
.IP \(bu 2
\fB_revs_info\fP (\fIarray\fP) – List of objects with information about local
revisions and their status. Available if requested with \fBopen_revs\fP
query parameter
.IP \(bu 2
\fB_revisions\fP (\fIobject\fP) – List of local revision tokens without.
Available if requested with \fBrevs=true\fP query parameter
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%304 Not Modified\fP – Document wasn’t modified since specified revision
.IP \(bu 2
\fI\%400 Bad Request\fP – The format of the request or revision was invalid
.IP \(bu 2
\fI\%401 Unauthorized\fP – Read privilege required
.IP \(bu 2
\fI\%404 Not Found\fP – Document not found
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes/SpaghettiWithMeatballs HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 660
Content\-Type: application/json
Date: Tue, 13 Aug 2013 21:35:37 GMT
ETag: \(dq1\-917fa2381192822767f010b95b45325b\(dq
Server: CouchDB (Erlang/OTP)

{
    \(dq_id\(dq: \(dqSpaghettiWithMeatballs\(dq,
    \(dq_rev\(dq: \(dq1\-917fa2381192822767f010b95b45325b\(dq,
    \(dqdescription\(dq: \(dqAn Italian\-American dish that usually consists of spaghetti, tomato sauce and meatballs.\(dq,
    \(dqingredients\(dq: [
        \(dqspaghetti\(dq,
        \(dqtomato sauce\(dq,
        \(dqmeatballs\(dq
    ],
    \(dqname\(dq: \(dqSpaghetti with meatballs\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B PUT /{db}/{docid}
The \fI\%PUT\fP method creates a new named document, or creates a new
revision of the existing document. Unlike the \fI\%POST /{db}\fP, you must
specify the document ID in the request URL.
.sp
When updating an existing document, the current document revision must be
included in the document (i.e. the request body), as the \fBrev\fP query
parameter, or in the \fBIf\-Match\fP request header.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBdocid\fP – Document ID
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fImultipart/related\fP
.UNINDENT

.IP \(bu 2
\fI\%If\-Match\fP – Document’s revision. Alternative to \fIrev\fP query
parameter or document key. \fIOptional\fP
.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBrev\fP (\fIstring\fP) – Document’s revision if updating an existing document.
Alternative to \fBIf\-Match\fP header or document key. \fIOptional\fP
.IP \(bu 2
\fBbatch\fP (\fIstring\fP) – Stores document in \fI\%batch mode\fP\&. Possible values: \fBok\fP\&. \fIOptional\fP
.IP \(bu 2
\fBnew_edits\fP (\fIboolean\fP) – Prevents insertion of a \fI\%conflicting
document\fP\&. Possible values: \fBtrue\fP (default)
and \fBfalse\fP\&. If \fBfalse\fP, a well\-formed \fB_rev\fP must be included in
the document. \fBnew_edits=false\fP is used by the replicator to insert
documents into the target database even if that leads to the creation
of conflicts. \fIOptional\fP, \fBThe \(ga\(gafalse\(ga\(ga value is intended for use
only by the replicator.\fP
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.IP \(bu 2
\fImultipart/related\fP
.UNINDENT

.IP \(bu 2
\fI\%ETag\fP – Quoted document’s new revision
.IP \(bu 2
\fI\%Location\fP – Document URI
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBid\fP (\fIstring\fP) – Document ID
.IP \(bu 2
\fBok\fP (\fIboolean\fP) – Operation status
.IP \(bu 2
\fBrev\fP (\fIstring\fP) – Revision MVCC token
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%201 Created\fP – Document created and stored on disk
.IP \(bu 2
\fI\%202 Accepted\fP – Document data accepted, but not yet stored on disk
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid request body or parameters
.IP \(bu 2
\fI\%401 Unauthorized\fP – Write privileges required
.IP \(bu 2
\fI\%404 Not Found\fP – Specified database or document ID doesn’t exists
.IP \(bu 2
\fI\%409 Conflict\fP – Document with the specified ID already exists or specified
revision is not latest for target document
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
PUT /recipes/SpaghettiWithMeatballs HTTP/1.1
Accept: application/json
Content\-Length: 196
Content\-Type: application/json
Host: localhost:5984

{
    \(dqdescription\(dq: \(dqAn Italian\-American dish that usually consists of spaghetti, tomato sauce and meatballs.\(dq,
    \(dqingredients\(dq: [
        \(dqspaghetti\(dq,
        \(dqtomato sauce\(dq,
        \(dqmeatballs\(dq
    ],
    \(dqname\(dq: \(dqSpaghetti with meatballs\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Cache\-Control: must\-revalidate
Content\-Length: 85
Content\-Type: application/json
Date: Wed, 14 Aug 2013 20:31:39 GMT
ETag: \(dq1\-917fa2381192822767f010b95b45325b\(dq
Location: http://localhost:5984/recipes/SpaghettiWithMeatballs
Server: CouchDB (Erlang/OTP)

{
    \(dqid\(dq: \(dqSpaghettiWithMeatballs\(dq,
    \(dqok\(dq: true,
    \(dqrev\(dq: \(dq1\-917fa2381192822767f010b95b45325b\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B DELETE /{db}/{docid}
Marks the specified document as deleted by adding a field \fB_deleted\fP with
the value \fBtrue\fP\&. Documents with this field will not be returned within
requests anymore, but stay in the database. You must supply the current
(latest) revision, either by using the \fBrev\fP parameter or by using the
\fI\%If\-Match\fP header to specify the revision.
.sp
\fBNOTE:\fP
.INDENT 7.0
.INDENT 3.5
CouchDB doesn’t completely delete the specified document. Instead, it
leaves a tombstone with very basic information about the document. The
tombstone is required so that the delete action can be replicated
across databases.
.UNINDENT
.UNINDENT
.sp
\fBSEE ALSO:\fP
.INDENT 7.0
.INDENT 3.5
\fI\%Retrieving Deleted Documents\fP
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBdocid\fP – Document ID
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.IP \(bu 2
\fI\%If\-Match\fP – Document’s revision. Alternative to \fIrev\fP query
parameter
.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBrev\fP (\fIstring\fP) – Actual document’s revision
.IP \(bu 2
\fBbatch\fP (\fIstring\fP) – Stores document in \fI\%batch mode\fP Possible values: \fBok\fP\&. \fIOptional\fP
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.IP \(bu 2
\fI\%ETag\fP – Double quoted document’s new revision
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBid\fP (\fIstring\fP) – Document ID
.IP \(bu 2
\fBok\fP (\fIboolean\fP) – Operation status
.IP \(bu 2
\fBrev\fP (\fIstring\fP) – Revision MVCC token
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Document successfully removed
.IP \(bu 2
\fI\%202 Accepted\fP – Request was accepted, but changes are not yet stored on disk
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid request body or parameters
.IP \(bu 2
\fI\%401 Unauthorized\fP – Write privileges required
.IP \(bu 2
\fI\%404 Not Found\fP – Specified database or document ID doesn’t exists
.IP \(bu 2
\fI\%409 Conflict\fP – Specified revision is not the latest for target document
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
DELETE /recipes/FishStew?rev=1\-9c65296036141e575d32ba9c034dd3ee HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Alternatively, instead of \fBrev\fP query parameter you may use
\fI\%If\-Match\fP header:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
DELETE /recipes/FishStew HTTP/1.1
Accept: application/json
If\-Match: 1\-9c65296036141e575d32ba9c034dd3ee
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 71
Content\-Type: application/json
Date: Wed, 14 Aug 2013 12:23:13 GMT
ETag: \(dq2\-056f5f44046ecafc08a2bc2b9c229e20\(dq
Server: CouchDB (Erlang/OTP)

{
    \(dqid\(dq: \(dqFishStew\(dq,
    \(dqok\(dq: true,
    \(dqrev\(dq: \(dq2\-056f5f44046ecafc08a2bc2b9c229e20\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B COPY /{db}/{docid}
The \fI\%COPY\fP (which is non\-standard HTTP) copies an existing
document to a new or existing document. Copying a document is only possible
within the same database.
.sp
The source document is specified on the request line, with the
\fI\%Destination\fP header of the request specifying the target
document.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBdocid\fP – Document ID
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.IP \(bu 2
\fI\%Destination\fP – Destination document. Must contain the target
document ID, and optionally the target document revision, if copying to
an existing document.  See \fI\%Copying to an Existing Document\fP\&.
.IP \(bu 2
\fI\%If\-Match\fP – Source document’s revision. Alternative to \fBrev\fP query
parameter
.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBrev\fP (\fIstring\fP) – Revision to copy from. \fIOptional\fP
.IP \(bu 2
\fBbatch\fP (\fIstring\fP) – Stores document in \fI\%batch mode\fP Possible values: \fBok\fP\&. \fIOptional\fP
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.IP \(bu 2
\fI\%ETag\fP – Double quoted document’s new revision
.IP \(bu 2
\fI\%Location\fP – Document URI
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBid\fP (\fIstring\fP) – Document document ID
.IP \(bu 2
\fBok\fP (\fIboolean\fP) – Operation status
.IP \(bu 2
\fBrev\fP (\fIstring\fP) – Revision MVCC token
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%201 Created\fP – Document successfully created
.IP \(bu 2
\fI\%202 Accepted\fP – Request was accepted, but changes are not yet stored on disk
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid request body or parameters
.IP \(bu 2
\fI\%401 Unauthorized\fP – Read or write privileges required
.IP \(bu 2
\fI\%404 Not Found\fP – Specified database, document ID  or revision doesn’t exists
.IP \(bu 2
\fI\%409 Conflict\fP – Document with the specified ID already exists or specified
revision is not latest for target document
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
COPY /recipes/SpaghettiWithMeatballs HTTP/1.1
Accept: application/json
Destination: SpaghettiWithMeatballs_Italian
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Cache\-Control: must\-revalidate
Content\-Length: 93
Content\-Type: application/json
Date: Wed, 14 Aug 2013 14:21:00 GMT
ETag: \(dq1\-e86fdf912560c2321a5fcefc6264e6d9\(dq
Location: http://localhost:5984/recipes/SpaghettiWithMeatballs_Italian
Server: CouchDB (Erlang/OTP)

{
    \(dqid\(dq: \(dqSpaghettiWithMeatballs_Italian\(dq,
    \(dqok\(dq: true,
    \(dqrev\(dq: \(dq1\-e86fdf912560c2321a5fcefc6264e6d9\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS Attachments
.sp
If the document includes attachments, then the returned structure will contain
a summary of the attachments associated with the document, but not the
attachment data itself.
.sp
The JSON for the returned document will include the \fB_attachments\fP field,
with one or more attachment definitions.
.sp
The \fB_attachments\fP object keys are attachments names while values are
information objects with next structure:
.INDENT 0.0
.IP \(bu 2
\fBcontent_type\fP (\fIstring\fP): Attachment MIME type
.IP \(bu 2
\fBdata\fP (\fIstring\fP): Base64\-encoded content. Available if attachment content
is requested by using the following query parameters:
.INDENT 2.0
.INDENT 3.5
.INDENT 0.0
.IP \(bu 2
\fBattachments=true\fP when querying a document
.IP \(bu 2
\fBattachments=true&include_docs=true\fP when querying a
\fI\%changes feed\fP or a \fI\%view\fP
.IP \(bu 2
\fBatts_since\fP\&.
.UNINDENT
.UNINDENT
.UNINDENT
.IP \(bu 2
\fBdigest\fP (\fIstring\fP): Content hash digest.
It starts with prefix which announce hash type (\fBmd5\-\fP) and continues with
Base64\-encoded hash digest
.IP \(bu 2
\fBencoded_length\fP (\fInumber\fP): Compressed attachment size in bytes.
Available if \fBcontent_type\fP is in \fI\%list of compressible
types\fP when the attachment was added and the
following query parameters are specified:
.INDENT 2.0
.INDENT 3.5
.INDENT 0.0
.IP \(bu 2
\fBatt_encoding_info=true\fP when querying a document
.IP \(bu 2
\fBatt_encoding_info=true&include_docs=true\fP when querying a
\fI\%changes feed\fP or a \fI\%view\fP
.UNINDENT
.UNINDENT
.UNINDENT
.IP \(bu 2
\fBencoding\fP (\fIstring\fP): Compression codec. Available if \fBcontent_type\fP is
in \fI\%list of compressible types\fP when the attachment was added and the
following query parameters are specified:
.INDENT 2.0
.INDENT 3.5
.INDENT 0.0
.IP \(bu 2
\fBatt_encoding_info=true\fP when querying a document
.IP \(bu 2
\fBatt_encoding_info=true&include_docs=true\fP when querying a
\fI\%changes feed\fP or a \fI\%view\fP
.UNINDENT
.UNINDENT
.UNINDENT
.IP \(bu 2
\fBlength\fP (\fInumber\fP): Real attachment size in bytes. Not available if
attachment content requested
.IP \(bu 2
\fBrevpos\fP (\fInumber\fP): Revision \fInumber\fP when attachment was added
.IP \(bu 2
\fBstub\fP (\fIboolean\fP): Has \fBtrue\fP value if object contains stub info and no
content. Otherwise omitted in response
.UNINDENT
.SS Basic Attachments Info
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes/SpaghettiWithMeatballs HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 660
Content\-Type: application/json
Date: Tue, 13 Aug 2013 21:35:37 GMT
ETag: \(dq5\-fd96acb3256302bf0dd2f32713161f2a\(dq
Server: CouchDB (Erlang/OTP)

{
    \(dq_attachments\(dq: {
        \(dqgrandma_recipe.txt\(dq: {
            \(dqcontent_type\(dq: \(dqtext/plain\(dq,
            \(dqdigest\(dq: \(dqmd5\-Ids41vtv725jyrN7iUvMcQ==\(dq,
            \(dqlength\(dq: 1872,
            \(dqrevpos\(dq: 4,
            \(dqstub\(dq: true
        },
        \(dqmy_recipe.txt\(dq: {
            \(dqcontent_type\(dq: \(dqtext/plain\(dq,
            \(dqdigest\(dq: \(dqmd5\-198BPPNiT5fqlLxoYYbjBA==\(dq,
            \(dqlength\(dq: 85,
            \(dqrevpos\(dq: 5,
            \(dqstub\(dq: true
        },
        \(dqphoto.jpg\(dq: {
            \(dqcontent_type\(dq: \(dqimage/jpeg\(dq,
            \(dqdigest\(dq: \(dqmd5\-7Pv4HW2822WY1r/3WDbPug==\(dq,
            \(dqlength\(dq: 165504,
            \(dqrevpos\(dq: 2,
            \(dqstub\(dq: true
        }
    },
    \(dq_id\(dq: \(dqSpaghettiWithMeatballs\(dq,
    \(dq_rev\(dq: \(dq5\-fd96acb3256302bf0dd2f32713161f2a\(dq,
    \(dqdescription\(dq: \(dqAn Italian\-American dish that usually consists of spaghetti, tomato sauce and meatballs.\(dq,
    \(dqingredients\(dq: [
        \(dqspaghetti\(dq,
        \(dqtomato sauce\(dq,
        \(dqmeatballs\(dq
    ],
    \(dqname\(dq: \(dqSpaghetti with meatballs\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Retrieving Attachments Content
.sp
It’s possible to retrieve document with all attached files content by using
\fBattachments=true\fP query parameter:
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /db/pixel?attachments=true HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 553
Content\-Type: application/json
Date: Wed, 14 Aug 2013 11:32:40 GMT
ETag: \(dq4\-f1bcae4bf7bbb92310079e632abfe3f4\(dq
Server: CouchDB (Erlang/OTP)

{
    \(dq_attachments\(dq: {
        \(dqpixel.gif\(dq: {
            \(dqcontent_type\(dq: \(dqimage/gif\(dq,
            \(dqdata\(dq: \(dqR0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\(dq,
            \(dqdigest\(dq: \(dqmd5\-2JdGiI2i2VELZKnwMers1Q==\(dq,
            \(dqrevpos\(dq: 2
        },
        \(dqpixel.png\(dq: {
            \(dqcontent_type\(dq: \(dqimage/png\(dq,
            \(dqdata\(dq: \(dqiVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAAAXNSR0IArs4c6QAAAANQTFRFAAAAp3o92gAAAAF0Uk5TAEDm2GYAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3QgOCx8VHgmcNwAAAApJREFUCNdjYAAAAAIAAeIhvDMAAAAASUVORK5CYII=\(dq,
            \(dqdigest\(dq: \(dqmd5\-Dgf5zxgGuchWrve73evvGQ==\(dq,
            \(dqrevpos\(dq: 3
        }
    },
    \(dq_id\(dq: \(dqpixel\(dq,
    \(dq_rev\(dq: \(dq4\-f1bcae4bf7bbb92310079e632abfe3f4\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Or retrieve attached files content since specific revision using \fBatts_since\fP
query parameter:
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes/SpaghettiWithMeatballs?atts_since=[%224\-874985bc28906155ba0e2e0538f67b05%22]  HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 760
Content\-Type: application/json
Date: Tue, 13 Aug 2013 21:35:37 GMT
ETag: \(dq5\-fd96acb3256302bf0dd2f32713161f2a\(dq
Server: CouchDB (Erlang/OTP)

{
    \(dq_attachments\(dq: {
        \(dqgrandma_recipe.txt\(dq: {
            \(dqcontent_type\(dq: \(dqtext/plain\(dq,
            \(dqdigest\(dq: \(dqmd5\-Ids41vtv725jyrN7iUvMcQ==\(dq,
            \(dqlength\(dq: 1872,
            \(dqrevpos\(dq: 4,
            \(dqstub\(dq: true
        },
        \(dqmy_recipe.txt\(dq: {
            \(dqcontent_type\(dq: \(dqtext/plain\(dq,
            \(dqdata\(dq: \(dqMS4gQ29vayBzcGFnaGV0dGkKMi4gQ29vayBtZWV0YmFsbHMKMy4gTWl4IHRoZW0KNC4gQWRkIHRvbWF0byBzYXVjZQo1LiAuLi4KNi4gUFJPRklUIQ==\(dq,
            \(dqdigest\(dq: \(dqmd5\-198BPPNiT5fqlLxoYYbjBA==\(dq,
            \(dqrevpos\(dq: 5
        },
        \(dqphoto.jpg\(dq: {
            \(dqcontent_type\(dq: \(dqimage/jpeg\(dq,
            \(dqdigest\(dq: \(dqmd5\-7Pv4HW2822WY1r/3WDbPug==\(dq,
            \(dqlength\(dq: 165504,
            \(dqrevpos\(dq: 2,
            \(dqstub\(dq: true
        }
    },
    \(dq_id\(dq: \(dqSpaghettiWithMeatballs\(dq,
    \(dq_rev\(dq: \(dq5\-fd96acb3256302bf0dd2f32713161f2a\(dq,
    \(dqdescription\(dq: \(dqAn Italian\-American dish that usually consists of spaghetti, tomato sauce and meatballs.\(dq,
    \(dqingredients\(dq: [
        \(dqspaghetti\(dq,
        \(dqtomato sauce\(dq,
        \(dqmeatballs\(dq
    ],
    \(dqname\(dq: \(dqSpaghetti with meatballs\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Efficient Multiple Attachments Retrieving
.sp
As noted above, retrieving document with \fBattachments=true\fP returns a
large JSON object with all attachments included.  When your document and
files are smaller it’s ok, but if you have attached something bigger like media
files (audio/video), parsing such response might be very expensive.
.sp
To solve this problem, CouchDB allows to get documents in
\fImultipart/related\fP format:
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes/secret?attachments=true HTTP/1.1
Accept: multipart/related
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Content\-Length: 538
Content\-Type: multipart/related; boundary=\(dqe89b3e29388aef23453450d10e5aaed0\(dq
Date: Sat, 28 Sep 2013 08:08:22 GMT
ETag: \(dq2\-c1c6c44c4bc3c9344b037c8690468605\(dq
Server: CouchDB (Erlang OTP)

\-\-e89b3e29388aef23453450d10e5aaed0
Content\-Type: application/json

{\(dq_id\(dq:\(dqsecret\(dq,\(dq_rev\(dq:\(dq2\-c1c6c44c4bc3c9344b037c8690468605\(dq,\(dq_attachments\(dq:{\(dqrecipe.txt\(dq:{\(dqcontent_type\(dq:\(dqtext/plain\(dq,\(dqrevpos\(dq:2,\(dqdigest\(dq:\(dqmd5\-HV9aXJdEnu0xnMQYTKgOFA==\(dq,\(dqlength\(dq:86,\(dqfollows\(dq:true}}}
\-\-e89b3e29388aef23453450d10e5aaed0
Content\-Disposition: attachment; filename=\(dqrecipe.txt\(dq
Content\-Type: text/plain
Content\-Length: 86

1. Take R
2. Take E
3. Mix with L
4. Add some A
5. Serve with X

\-\-e89b3e29388aef23453450d10e5aaed0\-\-
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
In this response the document contains only attachments stub information and
quite short while all attachments goes as separate entities which reduces
memory footprint and processing overhead (you’d noticed, that attachment
content goes as raw data, not in base64 encoding, right?).
.SS Retrieving Attachments Encoding Info
.sp
By using \fBatt_encoding_info=true\fP query parameter you may retrieve
information about compressed attachments size and used codec.
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes/SpaghettiWithMeatballs?att_encoding_info=true HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 736
Content\-Type: application/json
Date: Tue, 13 Aug 2013 21:35:37 GMT
ETag: \(dq5\-fd96acb3256302bf0dd2f32713161f2a\(dq
Server: CouchDB (Erlang/OTP)

{
    \(dq_attachments\(dq: {
        \(dqgrandma_recipe.txt\(dq: {
            \(dqcontent_type\(dq: \(dqtext/plain\(dq,
            \(dqdigest\(dq: \(dqmd5\-Ids41vtv725jyrN7iUvMcQ==\(dq,
            \(dqencoded_length\(dq: 693,
            \(dqencoding\(dq: \(dqgzip\(dq,
            \(dqlength\(dq: 1872,
            \(dqrevpos\(dq: 4,
            \(dqstub\(dq: true
        },
        \(dqmy_recipe.txt\(dq: {
            \(dqcontent_type\(dq: \(dqtext/plain\(dq,
            \(dqdigest\(dq: \(dqmd5\-198BPPNiT5fqlLxoYYbjBA==\(dq,
            \(dqencoded_length\(dq: 100,
            \(dqencoding\(dq: \(dqgzip\(dq,
            \(dqlength\(dq: 85,
            \(dqrevpos\(dq: 5,
            \(dqstub\(dq: true
        },
        \(dqphoto.jpg\(dq: {
            \(dqcontent_type\(dq: \(dqimage/jpeg\(dq,
            \(dqdigest\(dq: \(dqmd5\-7Pv4HW2822WY1r/3WDbPug==\(dq,
            \(dqlength\(dq: 165504,
            \(dqrevpos\(dq: 2,
            \(dqstub\(dq: true
        }
    },
    \(dq_id\(dq: \(dqSpaghettiWithMeatballs\(dq,
    \(dq_rev\(dq: \(dq5\-fd96acb3256302bf0dd2f32713161f2a\(dq,
    \(dqdescription\(dq: \(dqAn Italian\-American dish that usually consists of spaghetti, tomato sauce and meatballs.\(dq,
    \(dqingredients\(dq: [
        \(dqspaghetti\(dq,
        \(dqtomato sauce\(dq,
        \(dqmeatballs\(dq
    ],
    \(dqname\(dq: \(dqSpaghetti with meatballs\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Creating Multiple Attachments
.sp
To create a document with multiple attachments with single request you need
just inline base64 encoded attachments data into the document body:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
  \(dq_id\(dq:\(dqmultiple_attachments\(dq,
  \(dq_attachments\(dq:
  {
    \(dqfoo.txt\(dq:
    {
      \(dqcontent_type\(dq:\(dqtext\e/plain\(dq,
      \(dqdata\(dq: \(dqVGhpcyBpcyBhIGJhc2U2NCBlbmNvZGVkIHRleHQ=\(dq
    },

   \(dqbar.txt\(dq:
    {
      \(dqcontent_type\(dq:\(dqtext\e/plain\(dq,
      \(dqdata\(dq: \(dqVGhpcyBpcyBhIGJhc2U2NCBlbmNvZGVkIHRleHQ=\(dq
    }
  }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Alternatively, you can upload a document with attachments more efficiently in
\fImultipart/related\fP format. This avoids having to Base64\-encode
the attachments, saving CPU and bandwidth. To do this, set the
\fI\%Content\-Type\fP header of the \fI\%PUT /{db}/{docid}\fP request to
\fImultipart/related\fP\&.
.sp
The first MIME body is the document itself, which should have its own
\fI\%Content\-Type\fP of \fIapplication/json\(dq\fP\&. It also should
include  an \fB_attachments\fP metadata object in which each attachment object
has a key \fBfollows\fP with value \fBtrue\fP\&.
.sp
The subsequent MIME bodies are the attachments.
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
PUT /temp/somedoc HTTP/1.1
Accept: application/json
Content\-Length: 372
Content\-Type: multipart/related;boundary=\(dqabc123\(dq
Host: localhost:5984
User\-Agent: HTTPie/0.6.0

\-\-abc123
Content\-Type: application/json

{
    \(dqbody\(dq: \(dqThis is a body.\(dq,
    \(dq_attachments\(dq: {
        \(dqfoo.txt\(dq: {
            \(dqfollows\(dq: true,
            \(dqcontent_type\(dq: \(dqtext/plain\(dq,
            \(dqlength\(dq: 21
        },
        \(dqbar.txt\(dq: {
            \(dqfollows\(dq: true,
            \(dqcontent_type\(dq: \(dqtext/plain\(dq,
            \(dqlength\(dq: 20
        }
    }
}

\-\-abc123

this is 21 chars long
\-\-abc123

this is 20 chars lon
\-\-abc123\-\-
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Cache\-Control: must\-revalidate
Content\-Length: 72
Content\-Type: application/json
Date: Sat, 28 Sep 2013 09:13:24 GMT
ETag: \(dq1\-5575e26acdeb1df561bb5b70b26ba151\(dq
Location: http://localhost:5984/temp/somedoc
Server: CouchDB (Erlang OTP)

{
    \(dqid\(dq: \(dqsomedoc\(dq,
    \(dqok\(dq: true,
    \(dqrev\(dq: \(dq1\-5575e26acdeb1df561bb5b70b26ba151\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Getting a List of Revisions
.sp
You can obtain a list of the revisions for a given document by adding
the \fBrevs=true\fP parameter to the request URL:
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes/SpaghettiWithMeatballs?revs=true  HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 584
Content\-Type: application/json
Date: Wed, 14 Aug 2013 11:38:26 GMT
ETag: \(dq5\-fd96acb3256302bf0dd2f32713161f2a\(dq
Server: CouchDB (Erlang/OTP)

{
    \(dq_id\(dq: \(dqSpaghettiWithMeatballs\(dq,
    \(dq_rev\(dq: \(dq8\-6f5ad8db0f34af24a6e0984cd1a6cfb9\(dq,
    \(dq_revisions\(dq: {
        \(dqids\(dq: [
            \(dq6f5ad8db0f34af24a6e0984cd1a6cfb9\(dq,
            \(dq77fba3a059497f51ec99b9b478b569d2\(dq,
            \(dq136813b440a00a24834f5cb1ddf5b1f1\(dq,
            \(dqfd96acb3256302bf0dd2f32713161f2a\(dq,
            \(dq874985bc28906155ba0e2e0538f67b05\(dq,
            \(dq0de77a37463bf391d14283e626831f2e\(dq,
            \(dqd795d1b924777732fdea76538c558b62\(dq,
            \(dq917fa2381192822767f010b95b45325b\(dq
        ],
        \(dqstart\(dq: 8
    },
    \(dqdescription\(dq: \(dqAn Italian\-American dish that usually consists of spaghetti, tomato sauce and meatballs.\(dq,
    \(dqingredients\(dq: [
        \(dqspaghetti\(dq,
        \(dqtomato sauce\(dq,
        \(dqmeatballs\(dq
    ],
    \(dqname\(dq: \(dqSpaghetti with meatballs\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The returned JSON structure includes the original document, including a
\fB_revisions\fP structure that includes the revision information in next form:
.INDENT 0.0
.IP \(bu 2
\fBids\fP (\fIarray\fP): Array of valid revision IDs, in reverse order
(latest first)
.IP \(bu 2
\fBstart\fP (\fInumber\fP): Prefix number for the latest revision
.UNINDENT
.SS Obtaining an Extended Revision History
.sp
You can get additional information about the revisions for a given document by
supplying the \fBrevs_info\fP argument to the query:
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes/SpaghettiWithMeatballs?revs_info=true  HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 802
Content\-Type: application/json
Date: Wed, 14 Aug 2013 11:40:55 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dq_id\(dq: \(dqSpaghettiWithMeatballs\(dq,
    \(dq_rev\(dq: \(dq8\-6f5ad8db0f34af24a6e0984cd1a6cfb9\(dq,
    \(dq_revs_info\(dq: [
        {
            \(dqrev\(dq: \(dq8\-6f5ad8db0f34af24a6e0984cd1a6cfb9\(dq,
            \(dqstatus\(dq: \(dqavailable\(dq
        },
        {
            \(dqrev\(dq: \(dq7\-77fba3a059497f51ec99b9b478b569d2\(dq,
            \(dqstatus\(dq: \(dqdeleted\(dq
        },
        {
            \(dqrev\(dq: \(dq6\-136813b440a00a24834f5cb1ddf5b1f1\(dq,
            \(dqstatus\(dq: \(dqavailable\(dq
        },
        {
            \(dqrev\(dq: \(dq5\-fd96acb3256302bf0dd2f32713161f2a\(dq,
            \(dqstatus\(dq: \(dqmissing\(dq
        },
        {
            \(dqrev\(dq: \(dq4\-874985bc28906155ba0e2e0538f67b05\(dq,
            \(dqstatus\(dq: \(dqmissing\(dq
        },
        {
            \(dqrev\(dq: \(dq3\-0de77a37463bf391d14283e626831f2e\(dq,
            \(dqstatus\(dq: \(dqmissing\(dq
        },
        {
            \(dqrev\(dq: \(dq2\-d795d1b924777732fdea76538c558b62\(dq,
            \(dqstatus\(dq: \(dqmissing\(dq
        },
        {
            \(dqrev\(dq: \(dq1\-917fa2381192822767f010b95b45325b\(dq,
            \(dqstatus\(dq: \(dqmissing\(dq
        }
    ],
    \(dqdescription\(dq: \(dqAn Italian\-American dish that usually consists of spaghetti, tomato sauce and meatballs.\(dq,
    \(dqingredients\(dq: [
        \(dqspaghetti\(dq,
        \(dqtomato sauce\(dq,
        \(dqmeatballs\(dq
    ],
    \(dqname\(dq: \(dqSpaghetti with meatballs\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The returned document contains \fB_revs_info\fP field with extended revision
information, including the availability and status of each revision. This array
field contains objects with following structure:
.INDENT 0.0
.IP \(bu 2
\fBrev\fP (\fIstring\fP): Full revision string
.IP \(bu 2
\fBstatus\fP (\fIstring\fP): Status of the revision.
Maybe one of:
.INDENT 2.0
.IP \(bu 2
\fBavailable\fP: Revision is available for retrieving with \fIrev\fP query
parameter
.IP \(bu 2
\fBmissing\fP: Revision is not available
.IP \(bu 2
\fBdeleted\fP: Revision belongs to deleted document
.UNINDENT
.UNINDENT
.SS Obtaining a Specific Revision
.sp
To get a specific revision, use the \fBrev\fP argument to the request, and
specify the full revision number. The specified revision of the document will
be returned, including a \fB_rev\fP field specifying the revision that was
requested.
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes/SpaghettiWithMeatballs?rev=6\-136813b440a00a24834f5cb1ddf5b1f1  HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 271
Content\-Type: application/json
Date: Wed, 14 Aug 2013 11:40:55 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dq_id\(dq: \(dqSpaghettiWithMeatballs\(dq,
    \(dq_rev\(dq: \(dq6\-136813b440a00a24834f5cb1ddf5b1f1\(dq,
    \(dqdescription\(dq: \(dqAn Italian\-American dish that usually consists of spaghetti, tomato sauce and meatballs.\(dq,
    \(dqingredients\(dq: [
        \(dqspaghetti\(dq,
        \(dqtomato sauce\(dq,
        \(dqmeatballs\(dq
    ],
    \(dqname\(dq: \(dqSpaghetti with meatballs\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Retrieving Deleted Documents
.sp
CouchDB doesn’t actually delete documents via \fI\%DELETE /{db}/{docid}\fP\&.
Instead, it leaves tombstone with very basic information about the
document. If you just \fI\%GET /{db}/{docid}\fP CouchDB returns \fI\%404 Not Found\fP
response:
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes/FishStew  HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 404 Object Not Found
Cache\-Control: must\-revalidate
Content\-Length: 41
Content\-Type: application/json
Date: Wed, 14 Aug 2013 12:23:27 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqerror\(dq: \(dqnot_found\(dq,
    \(dqreason\(dq: \(dqdeleted\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
However, you may retrieve document’s tombstone by using \fBrev\fP query parameter
with \fI\%GET /{db}/{docid}\fP request:
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes/FishStew?rev=2\-056f5f44046ecafc08a2bc2b9c229e20  HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 79
Content\-Type: application/json
Date: Wed, 14 Aug 2013 12:30:22 GMT
ETag: \(dq2\-056f5f44046ecafc08a2bc2b9c229e20\(dq
Server: CouchDB (Erlang/OTP)

{
    \(dq_deleted\(dq: true,
    \(dq_id\(dq: \(dqFishStew\(dq,
    \(dq_rev\(dq: \(dq2\-056f5f44046ecafc08a2bc2b9c229e20\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Updating an Existing Document
.sp
To update an existing document you must specify the current revision
number within the \fB_rev\fP parameter.
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
PUT /recipes/SpaghettiWithMeatballs HTTP/1.1
Accept: application/json
Content\-Length: 258
Content\-Type: application/json
Host: localhost:5984

{
    \(dq_rev\(dq: \(dq1\-917fa2381192822767f010b95b45325b\(dq,
    \(dqdescription\(dq: \(dqAn Italian\-American dish that usually consists of spaghetti, tomato sauce and meatballs.\(dq,
    \(dqingredients\(dq: [
        \(dqspaghetti\(dq,
        \(dqtomato sauce\(dq,
        \(dqmeatballs\(dq
    ],
    \(dqname\(dq: \(dqSpaghetti with meatballs\(dq,
    \(dqserving\(dq: \(dqhot\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Alternatively, you can supply the current revision number in the \fBIf\-Match\fP
HTTP header of the request:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
PUT /recipes/SpaghettiWithMeatballs HTTP/1.1
Accept: application/json
Content\-Length: 258
Content\-Type: application/json
If\-Match: 1\-917fa2381192822767f010b95b45325b
Host: localhost:5984

{
    \(dqdescription\(dq: \(dqAn Italian\-American dish that usually consists of spaghetti, tomato sauce and meatballs.\(dq,
    \(dqingredients\(dq: [
        \(dqspaghetti\(dq,
        \(dqtomato sauce\(dq,
        \(dqmeatballs\(dq
    ],
    \(dqname\(dq: \(dqSpaghetti with meatballs\(dq,
    \(dqserving\(dq: \(dqhot\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Cache\-Control: must\-revalidate
Content\-Length: 85
Content\-Type: application/json
Date: Wed, 14 Aug 2013 20:33:56 GMT
ETag: \(dq2\-790895a73b63fb91dd863388398483dd\(dq
Location: http://localhost:5984/recipes/SpaghettiWithMeatballs
Server: CouchDB (Erlang/OTP)

{
    \(dqid\(dq: \(dqSpaghettiWithMeatballs\(dq,
    \(dqok\(dq: true,
    \(dqrev\(dq: \(dq2\-790895a73b63fb91dd863388398483dd\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Copying from a Specific Revision
.sp
To copy \fIfrom\fP a specific version, use the \fBrev\fP argument to the query string
or \fI\%If\-Match\fP:
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
COPY /recipes/SpaghettiWithMeatballs HTTP/1.1
Accept: application/json
Destination: SpaghettiWithMeatballs_Original
If\-Match: 1\-917fa2381192822767f010b95b45325b
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Cache\-Control: must\-revalidate
Content\-Length: 93
Content\-Type: application/json
Date: Wed, 14 Aug 2013 14:21:00 GMT
ETag: \(dq1\-917fa2381192822767f010b95b45325b\(dq
Location: http://localhost:5984/recipes/SpaghettiWithMeatballs_Original
Server: CouchDB (Erlang/OTP)

{
    \(dqid\(dq: \(dqSpaghettiWithMeatballs_Original\(dq,
    \(dqok\(dq: true,
    \(dqrev\(dq: \(dq1\-917fa2381192822767f010b95b45325b\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Copying to an Existing Document
.sp
To copy to an existing document, you must specify the current revision string
for the target document by appending the \fBrev\fP parameter to the
\fI\%Destination\fP header string.
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
COPY /recipes/SpaghettiWithMeatballs?rev=8\-6f5ad8db0f34af24a6e0984cd1a6cfb9 HTTP/1.1
Accept: application/json
Destination: SpaghettiWithMeatballs_Original?rev=1\-917fa2381192822767f010b95b45325b
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Cache\-Control: must\-revalidate
Content\-Length: 93
Content\-Type: application/json
Date: Wed, 14 Aug 2013 14:21:00 GMT
ETag: \(dq2\-62e778c9ec09214dd685a981dcc24074\(dq\(dq
Location: http://localhost:5984/recipes/SpaghettiWithMeatballs_Original
Server: CouchDB (Erlang/OTP)

{
    \(dqid\(dq: \(dqSpaghettiWithMeatballs_Original\(dq,
    \(dqok\(dq: true,
    \(dqrev\(dq: \(dq2\-62e778c9ec09214dd685a981dcc24074\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS \fB/db/doc/attachment\fP
.INDENT 0.0
.TP
.B HEAD /{db}/{docid}/{attname}
Returns the HTTP headers containing a minimal amount of information about
the specified attachment. The method supports the same query arguments as
the \fI\%GET /{db}/{docid}/{attname}\fP method, but only the header information
(including attachment size, encoding and the MD5 hash as an
\fI\%ETag\fP), is returned.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBdocid\fP – Document ID
.IP \(bu 2
\fBattname\fP – Attachment name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%If\-Match\fP – Document’s revision. Alternative to \fBrev\fP query
parameter
.IP \(bu 2
\fI\%If\-None\-Match\fP – Attachment’s base64 encoded MD5 binary digest.
\fIOptional\fP
.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBrev\fP (\fIstring\fP) – Document’s revision. \fIOptional\fP
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\-Ranges\fP – \fI\%Range request aware\fP\&. Used for attachments with
\fIapplication/octet\-stream\fP content type
.IP \(bu 2
\fI\%Content\-Encoding\fP – Used compression codec. Available if
attachment’s \fBcontent_type\fP is in \fI\%list of compressible
types\fP
.IP \(bu 2
\fI\%Content\-Length\fP – Attachment size. If compression codec was used,
this value is about compressed size, not actual
.IP \(bu 2
\fI\%ETag\fP – Double quoted base64 encoded MD5 binary digest
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Attachment exists
.IP \(bu 2
\fI\%401 Unauthorized\fP – Read privilege required
.IP \(bu 2
\fI\%404 Not Found\fP – Specified database, document or attachment was not found
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HEAD /recipes/SpaghettiWithMeatballs/recipe.txt HTTP/1.1
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Accept\-Ranges: none
Cache\-Control: must\-revalidate
Content\-Encoding: gzip
Content\-Length: 100
Content\-Type: text/plain
Date: Thu, 15 Aug 2013 12:42:42 GMT
ETag: \(dqvVa/YgiE1+Gh0WfoFJAcSg==\(dq
Server: CouchDB (Erlang/OTP)
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B GET /{db}/{docid}/{attname}
Returns the file attachment associated with the document. The raw data of
the associated attachment is returned (just as if you were accessing a
static file. The returned \fI\%Content\-Type\fP will be the same as the
content type set when the document attachment was submitted into the
database.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBdocid\fP – Document ID
.IP \(bu 2
\fBattname\fP – Attachment name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%If\-Match\fP – Document’s revision. Alternative to \fBrev\fP query
parameter
.IP \(bu 2
\fI\%If\-None\-Match\fP – Attachment’s base64 encoded MD5 binary digest.
\fIOptional\fP
.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBrev\fP (\fIstring\fP) – Document’s revision. \fIOptional\fP
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\-Ranges\fP – \fI\%Range request aware\fP\&. Used for attachments with
\fIapplication/octet\-stream\fP
.IP \(bu 2
\fI\%Content\-Encoding\fP – Used compression codec. Available if
attachment’s \fBcontent_type\fP is in \fI\%list of compressible
types\fP
.IP \(bu 2
\fI\%Content\-Length\fP – Attachment size. If compression codec is used,
this value is about compressed size, not actual
.IP \(bu 2
\fI\%ETag\fP – Double quoted base64 encoded MD5 binary digest
.UNINDENT
.TP
.B Response
Stored content
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Attachment exists
.IP \(bu 2
\fI\%401 Unauthorized\fP – Read privilege required
.IP \(bu 2
\fI\%404 Not Found\fP – Specified database, document or attachment was not found
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B PUT /{db}/{docid}/{attname}
Uploads the supplied content as an attachment to the specified document.
The attachment name provided must be a URL encoded string. You must supply
the Content\-Type header, and for an existing document you must also supply
either the \fBrev\fP query argument or the \fI\%If\-Match\fP HTTP header. If
the revision is omitted, a new, otherwise empty document will be created
with the provided attachment, or a conflict will occur.
.sp
If case when uploading an attachment using an existing attachment name,
CouchDB will update the corresponding stored content of the database. Since
you must supply the revision information to add an attachment to the
document, this serves as validation to update the existing attachment.
.sp
\fBNOTE:\fP
.INDENT 7.0
.INDENT 3.5
Uploading an attachment updates the corresponding document revision.
Revisions are tracked for the parent document, not individual
attachments.
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBdocid\fP – Document ID
.IP \(bu 2
\fBattname\fP – Attachment name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – Attachment MIME type. Default: \fIapplication/octet\-stream\fP \fIOptional\fP
.IP \(bu 2
\fI\%If\-Match\fP – Document revision. Alternative to \fBrev\fP query parameter
.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBrev\fP (\fIstring\fP) – Document revision. \fIOptional\fP
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBid\fP (\fIstring\fP) – Document ID
.IP \(bu 2
\fBok\fP (\fIboolean\fP) – Operation status
.IP \(bu 2
\fBrev\fP (\fIstring\fP) – Revision MVCC token
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%201 Created\fP – Attachment created and stored on disk
.IP \(bu 2
\fI\%202 Accepted\fP – Request was accepted, but changes are not yet stored on disk
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid request body or parameters
.IP \(bu 2
\fI\%401 Unauthorized\fP – Write privileges required
.IP \(bu 2
\fI\%404 Not Found\fP – Specified database, document or attachment was not found
.IP \(bu 2
\fI\%409 Conflict\fP – Document’s revision wasn’t specified or it’s not the latest
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
PUT /recipes/SpaghettiWithMeatballs/recipe.txt HTTP/1.1
Accept: application/json
Content\-Length: 86
Content\-Type: text/plain
Host: localhost:5984
If\-Match: 1\-917fa2381192822767f010b95b45325b

1. Cook spaghetti
2. Cook meatballs
3. Mix them
4. Add tomato sauce
5. ...
6. PROFIT!
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Cache\-Control: must\-revalidate
Content\-Length: 85
Content\-Type: application/json
Date: Thu, 15 Aug 2013 12:38:04 GMT
ETag: \(dq2\-ce91aed0129be8f9b0f650a2edcfd0a4\(dq
Location: http://localhost:5984/recipes/SpaghettiWithMeatballs/recipe.txt
Server: CouchDB (Erlang/OTP)

{
    \(dqid\(dq: \(dqSpaghettiWithMeatballs\(dq,
    \(dqok\(dq: true,
    \(dqrev\(dq: \(dq2\-ce91aed0129be8f9b0f650a2edcfd0a4\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B DELETE /{db}/{docid}/{attname}
Deletes the attachment with filename \fB{attname}\fP of the specified \fBdoc\fP\&.
You must supply the \fBrev\fP query parameter or \fI\%If\-Match\fP with the
current revision to delete the attachment.
.sp
\fBNOTE:\fP
.INDENT 7.0
.INDENT 3.5
Deleting an attachment updates the corresponding document revision.
Revisions are tracked for the parent document, not individual attachments.
.UNINDENT
.UNINDENT
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBdocid\fP – Document ID
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.IP \(bu 2
\fI\%If\-Match\fP – Document revision. Alternative to \fBrev\fP query parameter
.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBrev\fP (\fIstring\fP) – Document revision. \fIRequired\fP
.IP \(bu 2
\fBbatch\fP (\fIstring\fP) – Store changes in \fI\%batch mode\fP Possible values: \fBok\fP\&. \fIOptional\fP
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.IP \(bu 2
\fI\%ETag\fP – Double quoted document’s new revision
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBid\fP (\fIstring\fP) – Document ID
.IP \(bu 2
\fBok\fP (\fIboolean\fP) – Operation status
.IP \(bu 2
\fBrev\fP (\fIstring\fP) – Revision MVCC token
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Attachment successfully removed
.IP \(bu 2
\fI\%202 Accepted\fP – Request was accepted, but changes are not yet stored on disk
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid request body or parameters
.IP \(bu 2
\fI\%401 Unauthorized\fP – Write privileges required
.IP \(bu 2
\fI\%404 Not Found\fP – Specified database, document or attachment was not found
.IP \(bu 2
\fI\%409 Conflict\fP – Document’s revision wasn’t specified or it’s not the latest
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
DELETE /recipes/SpaghettiWithMeatballs?rev=6\-440b2dd39c20413045748b42c6aba6e2 HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Alternatively, instead of \fBrev\fP query parameter you may use
\fI\%If\-Match\fP header:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
DELETE /recipes/SpaghettiWithMeatballs HTTP/1.1
Accept: application/json
If\-Match: 6\-440b2dd39c20413045748b42c6aba6e2
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 85
Content\-Type: application/json
Date: Wed, 14 Aug 2013 12:23:13 GMT
ETag: \(dq7\-05185cf5fcdf4b6da360af939431d466\(dq
Server: CouchDB (Erlang/OTP)

{
    \(dqid\(dq: \(dqSpaghettiWithMeatballs\(dq,
    \(dqok\(dq: true,
    \(dqrev\(dq: \(dq7\-05185cf5fcdf4b6da360af939431d466\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS HTTP Range Requests
.sp
HTTP allows you to specify byte ranges for requests. This allows the
implementation of resumable downloads and skippable audio and video streams
alike. This is available for all attachments inside CouchDB.
.sp
This is just a real quick run through how this looks under the hood. Usually,
you will have larger binary files to serve from CouchDB, like MP3s and videos,
but to make things a little more obvious, I use a text file here (Note that I
use the \fIapplication/octet\-stream\fP :header\(gaContent\-Type\(ga instead of
\fItext/plain\fP).
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
shell> cat file.txt
My hovercraft is full of eels!
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Now let’s store this text file as an attachment in CouchDB. First, we create a
database:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
shell> curl \-X PUT http://127.0.0.1:5984/test
{\(dqok\(dq:true}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Then we create a new document and the file attachment in one go:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
shell> curl \-X PUT http://127.0.0.1:5984/test/doc/file.txt \e
            \-H \(dqContent\-Type: application/octet\-stream\(dq \-d@file.txt
{\(dqok\(dq:true,\(dqid\(dq:\(dqdoc\(dq,\(dqrev\(dq:\(dq1\-287a28fa680ae0c7fb4729bf0c6e0cf2\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Now we can request the whole file easily:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
shell> curl \-X GET http://127.0.0.1:5984/test/doc/file.txt
My hovercraft is full of eels!
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
But say we only want the first 13 bytes:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
shell> curl \-X GET http://127.0.0.1:5984/test/doc/file.txt \e
            \-H \(dqRange: bytes=0\-12\(dq
My hovercraft
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
HTTP supports many ways to specify single and even multiple byte
ranges. Read all about it in \fI\%RFC 2616#section\-14.27\fP\&.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Databases that have been created with CouchDB 1.0.2 or earlier will support
range requests in 3.3, but they are using a less\-optimal algorithm.
If you plan to make heavy use of this feature, make sure to compact your
database with CouchDB 3.3 to take advantage of a better algorithm to
find byte ranges.
.UNINDENT
.UNINDENT
.SS Design Documents
.sp
In CouchDB, design documents provide the main interface for building a CouchDB
application. The design document defines the views used to extract information
from CouchDB through one or more views. Design documents are created within
your CouchDB instance in the same way as you create database documents, but the
content and definition of the documents is different. Design Documents are
named using an ID defined with the design document URL path, and this URL can
then be used to access the database contents.
.sp
Views and lists operate together to provide automated (and formatted) output
from your database.
.SS \fB/db/_design/design\-doc\fP
.INDENT 0.0
.TP
.B HEAD /{db}/_design/{ddoc}
Returns the HTTP Headers containing a minimal amount of information about
the specified design document.
.sp
\fBSEE ALSO:\fP
.INDENT 7.0
.INDENT 3.5
\fI\%HEAD /{db}/{docid}\fP
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B GET /{db}/_design/{ddoc}
Returns the contents of the design document specified with the name of the
design document and from the specified database from the URL. Unless you
request a specific revision, the latest revision of the document will
always be returned.
.sp
\fBSEE ALSO:\fP
.INDENT 7.0
.INDENT 3.5
\fI\%GET /{db}/{docid}\fP
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B PUT /{db}/_design/{ddoc}
The \fI\%PUT\fP method creates a new named design document, or creates
a new revision of the existing design document.
.sp
The design documents have some agreement upon their fields and structure.
Currently it is the following:
.INDENT 7.0
.IP \(bu 2
\fBlanguage\fP (\fIstring\fP): Defines \fI\%Query Server\fP
to process design document functions
.IP \(bu 2
\fBoptions\fP (\fIobject\fP): View’s default options
.IP \(bu 2
\fBfilters\fP (\fIobject\fP): \fI\%Filter functions\fP definition
.IP \(bu 2
\fBlists\fP (\fIobject\fP): \fI\%List functions\fP definition. \fIDeprecated.\fP
.IP \(bu 2
\fBrewrites\fP (\fIarray\fP or \fIstring\fP): Rewrite rules definition. \fIDeprecated.\fP
.IP \(bu 2
\fBshows\fP (\fIobject\fP): \fI\%Show functions\fP definition. \fIDeprecated.\fP
.IP \(bu 2
\fBupdates\fP (\fIobject\fP): \fI\%Update functions\fP definition
.IP \(bu 2
\fBvalidate_doc_update\fP (\fIstring\fP): \fI\%Validate document update\fP function source
.IP \(bu 2
\fBviews\fP (\fIobject\fP): \fI\%View functions\fP definition.
.IP \(bu 2
\fBautoupdate\fP (\fIboolean\fP): Indicates whether to automatically build
indexes defined in this design document. Default is \fBtrue\fP\&.
.UNINDENT
.sp
Note, that for \fBfilters\fP, \fBlists\fP, \fBshows\fP and \fBupdates\fP fields
objects are mapping of function name to string function source code. For
\fBviews\fP mapping is the same except that values are objects with \fBmap\fP
and \fBreduce\fP (optional) keys which also contains functions source code.
.sp
\fBSEE ALSO:\fP
.INDENT 7.0
.INDENT 3.5
\fI\%PUT /{db}/{docid}\fP
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B DELETE /{db}/_design/{ddoc}
Deletes the specified document from the database. You must supply the
current (latest) revision, either by using the \fBrev\fP parameter to
specify the revision.
.sp
\fBSEE ALSO:\fP
.INDENT 7.0
.INDENT 3.5
\fI\%DELETE /{db}/{docid}\fP
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B COPY /{db}/_design/{ddoc}
The \fI\%COPY\fP (which is non\-standard HTTP) copies an existing design
document to a new or existing one.
.sp
Given that view indexes on disk are named after their MD5 hash of the
view definition, and that a \fICOPY\fP operation won’t actually change
that definition, the copied views won’t have to be reconstructed.
Both views will be served from the same index on disk.
.sp
\fBSEE ALSO:\fP
.INDENT 7.0
.INDENT 3.5
\fI\%COPY /{db}/{docid}\fP
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/db/_design/design\-doc/attachment\fP
.INDENT 0.0
.TP
.B HEAD /{db}/_design/{ddoc}/{attname}
Returns the HTTP headers containing a minimal amount of information about
the specified attachment.
.sp
\fBSEE ALSO:\fP
.INDENT 7.0
.INDENT 3.5
\fI\%HEAD /{db}/{docid}/{attname}\fP
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B GET /{db}/_design/{ddoc}/{attname}
Returns the file attachment associated with the design document. The raw
data of the associated attachment is returned (just as if you were
accessing a static file.
.sp
\fBSEE ALSO:\fP
.INDENT 7.0
.INDENT 3.5
\fI\%GET /{db}/{docid}/{attname}\fP
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B PUT /{db}/_design/{ddoc}/{attname}
Uploads the supplied content as an attachment to the specified design
document. The attachment name provided must be a URL encoded string.
.sp
\fBSEE ALSO:\fP
.INDENT 7.0
.INDENT 3.5
\fI\%PUT /{db}/{docid}/{attname}\fP
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B DELETE /{db}/_design/{ddoc}/{attname}
Deletes the attachment of the specified design document.
.sp
\fBSEE ALSO:\fP
.INDENT 7.0
.INDENT 3.5
\fI\%DELETE /{db}/{docid}/{attname}\fP
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/db/_design/design\-doc/_info\fP
.INDENT 0.0
.TP
.B GET /{db}/_design/{ddoc}/_info
Obtains information about the specified design document, including the
index, index size and current status of the design document and associated
index information.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBddoc\fP – Design document name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBname\fP (\fIstring\fP) – Design document name
.IP \(bu 2
\fBview_index\fP (\fIobject\fP) – \fI\%View Index Information\fP
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes/_design/recipe/_info HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 263
Content\-Type: application/json
Date: Sat, 17 Aug 2013 12:54:17 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqname\(dq: \(dqrecipe\(dq,
    \(dqview_index\(dq: {
        \(dqcompact_running\(dq: false,
        \(dqlanguage\(dq: \(dqpython\(dq,
        \(dqpurge_seq\(dq: 0,
        \(dqsignature\(dq: \(dqa59a1bb13fdf8a8a584bc477919c97ac\(dq,
        \(dqsizes\(dq: {
          \(dqactive\(dq: 926691,
          \(dqdisk\(dq: 1982704,
          \(dqexternal\(dq: 1535701
        },
        \(dqupdate_seq\(dq: 12397,
        \(dqupdater_running\(dq: false,
        \(dqwaiting_clients\(dq: 0,
        \(dqwaiting_commit\(dq: false
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS View Index Information
.sp
The response from \fI\%GET /{db}/_design/{ddoc}/_info\fP contains
\fBview_index\fP (\fIobject\fP) field with the next structure:
.INDENT 0.0
.IP \(bu 2
\fBcompact_running\fP (\fIboolean\fP):  Indicates whether a compaction routine
is currently running on the view
.IP \(bu 2
\fBsizes.active\fP (\fInumber\fP): The size of live data inside the view, in bytes
.IP \(bu 2
\fBsizes.external\fP (\fInumber\fP): The uncompressed size of view contents in bytes
.IP \(bu 2
\fBsizes.file\fP (\fInumber\fP): Size in bytes of the view as stored on disk
.IP \(bu 2
\fBlanguage\fP (\fIstring\fP): Language for the defined views
.IP \(bu 2
\fBpurge_seq\fP (\fInumber\fP): The purge sequence that has been processed
.IP \(bu 2
\fBsignature\fP (\fIstring\fP): MD5 signature of the views for the design document
.IP \(bu 2
\fBupdate_seq\fP (\fInumber\fP / \fIstring\fP): The update sequence of the corresponding
database that has been indexed
.IP \(bu 2
\fBupdater_running\fP (\fIboolean\fP): Indicates if the view is currently
being updated
.IP \(bu 2
\fBwaiting_clients\fP (\fInumber\fP): Number of clients waiting on views from
this design document
.IP \(bu 2
\fBwaiting_commit\fP (\fIboolean\fP): Indicates if there are outstanding commits
to the underlying database that need to processed
.UNINDENT
.SS \fB/db/_design/design\-doc/_view/view\-name\fP
.INDENT 0.0
.TP
.B GET /{db}/_design/{ddoc}/_view/{view}
Executes the specified view function from the specified design document.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBddoc\fP – Design document name
.IP \(bu 2
\fBview\fP – View function name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBconflicts\fP (\fIboolean\fP) – Include \fIconflicts\fP information in response.
Ignored if \fBinclude_docs\fP isn’t \fBtrue\fP\&. Default is \fBfalse\fP\&.
.IP \(bu 2
\fBdescending\fP (\fIboolean\fP) – Return the documents in descending order by key.
Default is \fBfalse\fP\&.
.IP \(bu 2
\fBendkey\fP (\fIjson\fP) – Stop returning records when the specified key is
reached.
.IP \(bu 2
\fBend_key\fP (\fIjson\fP) – Alias for \fBendkey\fP param
.IP \(bu 2
\fBendkey_docid\fP (\fIstring\fP) – Stop returning records when the specified
document ID is reached. Ignored if \fBendkey\fP is not set.
.IP \(bu 2
\fBend_key_doc_id\fP (\fIstring\fP) – Alias for \fBendkey_docid\fP\&.
.IP \(bu 2
\fBgroup\fP (\fIboolean\fP) – Group the results using the reduce function to a
group or single row. Implies \fBreduce\fP is \fBtrue\fP and the maximum
\fBgroup_level\fP\&. Default is \fBfalse\fP\&.
.IP \(bu 2
\fBgroup_level\fP (\fInumber\fP) – Specify the group level to be used. Implies
\fBgroup\fP is \fBtrue\fP\&.
.IP \(bu 2
\fBinclude_docs\fP (\fIboolean\fP) – Include the associated document with each row.
Default is \fBfalse\fP\&.
.IP \(bu 2
\fBattachments\fP (\fIboolean\fP) – Include the Base64\-encoded content of
\fI\%attachments\fP in the documents that are
included if \fBinclude_docs\fP is \fBtrue\fP\&. Ignored if \fBinclude_docs\fP isn’t
\fBtrue\fP\&. Default is \fBfalse\fP\&.
.IP \(bu 2
\fBatt_encoding_info\fP (\fIboolean\fP) – Include encoding information in
attachment stubs if \fBinclude_docs\fP is \fBtrue\fP and the particular
attachment is compressed. Ignored if \fBinclude_docs\fP isn’t \fBtrue\fP\&.
Default is \fBfalse\fP\&.
.IP \(bu 2
\fBinclusive_end\fP (\fIboolean\fP) – Specifies whether the specified end key
should be included in the result. Default is \fBtrue\fP\&.
.IP \(bu 2
\fBkey\fP (\fIjson\fP) – Return only documents that match the specified key.
.IP \(bu 2
\fBkeys\fP (\fIjson\-array\fP) – Return only documents where the key matches one of
the keys specified in the array.
.IP \(bu 2
\fBlimit\fP (\fInumber\fP) – Limit the number of the returned documents to the
specified number.
.IP \(bu 2
\fBreduce\fP (\fIboolean\fP) – Use the reduction function. Default is \fBtrue\fP when
a reduce function is defined.
.IP \(bu 2
\fBskip\fP (\fInumber\fP) – Skip this number of records before starting to return
the results. Default is \fB0\fP\&.
.IP \(bu 2
\fBsorted\fP (\fIboolean\fP) – Sort returned rows (see \fI\%Sorting Returned Rows\fP). Setting this to \fBfalse\fP offers a performance
boost. The \fBtotal_rows\fP and \fBoffset\fP fields are not available when this
is set to \fBfalse\fP\&. Default is \fBtrue\fP\&.
.IP \(bu 2
\fBstable\fP (\fIboolean\fP) – Whether or not the view results should be returned
from a stable set of shards. Default is \fBfalse\fP\&.
.IP \(bu 2
\fBstale\fP (\fIstring\fP) – Allow the results from a stale view to be used.
Supported values: \fBok\fP and \fBupdate_after\fP\&.
\fBok\fP is equivalent to \fBstable=true&update=false\fP\&.
\fBupdate_after\fP is equivalent to \fBstable=true&update=lazy\fP\&.
The default behavior is equivalent to \fBstable=false&update=true\fP\&.
Note that this parameter is deprecated. Use \fBstable\fP and \fBupdate\fP instead.
See \fI\%Views Generation\fP for more details.
.IP \(bu 2
\fBstartkey\fP (\fIjson\fP) – Return records starting with the specified key.
.IP \(bu 2
\fBstart_key\fP (\fIjson\fP) – Alias for \fBstartkey\fP\&.
.IP \(bu 2
\fBstartkey_docid\fP (\fIstring\fP) – Return records starting with the specified
document ID. Ignored if \fBstartkey\fP is not set.
.IP \(bu 2
\fBstart_key_doc_id\fP (\fIstring\fP) – Alias for \fBstartkey_docid\fP param
.IP \(bu 2
\fBupdate\fP (\fIstring\fP) – Whether or not the view in question should be updated
prior to responding to the user. Supported values: \fBtrue\fP, \fBfalse\fP,
\fBlazy\fP\&. Default is \fBtrue\fP\&.
.IP \(bu 2
\fBupdate_seq\fP (\fIboolean\fP) – Whether to include in the response an
\fBupdate_seq\fP value indicating the sequence id of the database the view
reflects. Default is \fBfalse\fP\&.
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.IP \(bu 2
\fI\%ETag\fP – Response signature
.IP \(bu 2
\fI\%Transfer\-Encoding\fP – \fBchunked\fP
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBoffset\fP (\fInumber\fP) – Offset where the document list started.
.IP \(bu 2
\fBrows\fP (\fIarray\fP) – Array of view row objects. By default the information
returned contains only the document ID and revision.
.IP \(bu 2
\fBtotal_rows\fP (\fInumber\fP) – Number of documents in the database/view.
.IP \(bu 2
\fBupdate_seq\fP (\fIobject\fP) – Current update sequence for the database.
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid request
.IP \(bu 2
\fI\%401 Unauthorized\fP – Read permission required
.IP \(bu 2
\fI\%404 Not Found\fP – Specified database, design document or view is missed
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes/_design/ingredients/_view/by_name HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Wed, 21 Aug 2013 09:12:06 GMT
ETag: \(dq2FOLSBSW4O6WB798XU4AQYA9B\(dq
Server: CouchDB (Erlang/OTP)
Transfer\-Encoding: chunked

{
    \(dqoffset\(dq: 0,
    \(dqrows\(dq: [
        {
            \(dqid\(dq: \(dqSpaghettiWithMeatballs\(dq,
            \(dqkey\(dq: \(dqmeatballs\(dq,
            \(dqvalue\(dq: 1
        },
        {
            \(dqid\(dq: \(dqSpaghettiWithMeatballs\(dq,
            \(dqkey\(dq: \(dqspaghetti\(dq,
            \(dqvalue\(dq: 1
        },
        {
            \(dqid\(dq: \(dqSpaghettiWithMeatballs\(dq,
            \(dqkey\(dq: \(dqtomato sauce\(dq,
            \(dqvalue\(dq: 1
        }
    ],
    \(dqtotal_rows\(dq: 3
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.sp
Changed in version 1.6.0: added \fBattachments\fP and \fBatt_encoding_info\fP
parameters

.sp
Changed in version 2.0.0: added \fBsorted\fP parameter

.sp
Changed in version 2.1.0: added \fBstable\fP and \fBupdate\fP parameters

.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
Using the \fBattachments\fP parameter to include attachments in view results
is not recommended for large attachment sizes. Also note that the
Base64\-encoding that is used leads to a 33% overhead (i.e. one third) in
transfer size for attachments.
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B POST /{db}/_design/{ddoc}/_view/{view}
Executes the specified view function from the specified design document.
\fI\%POST\fP view functionality supports identical parameters and behavior
as specified in the \fI\%GET /{db}/_design/{ddoc}/_view/{view}\fP API but allows for the
query string parameters to be supplied as keys in a JSON object in the body
of the \fIPOST\fP request.
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /recipes/_design/ingredients/_view/by_name HTTP/1.1
Accept: application/json
Content\-Length: 37
Host: localhost:5984

{
    \(dqkeys\(dq: [
        \(dqmeatballs\(dq,
        \(dqspaghetti\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Wed, 21 Aug 2013 09:14:13 GMT
ETag: \(dq6R5NM8E872JIJF796VF7WI3FZ\(dq
Server: CouchDB (Erlang/OTP)
Transfer\-Encoding: chunked

{
    \(dqoffset\(dq: 0,
    \(dqrows\(dq: [
        {
            \(dqid\(dq: \(dqSpaghettiWithMeatballs\(dq,
            \(dqkey\(dq: \(dqmeatballs\(dq,
            \(dqvalue\(dq: 1
        },
        {
            \(dqid\(dq: \(dqSpaghettiWithMeatballs\(dq,
            \(dqkey\(dq: \(dqspaghetti\(dq,
            \(dqvalue\(dq: 1
        }
    ],
    \(dqtotal_rows\(dq: 3
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS View Options
.sp
There are two view indexing options that can be defined in a design document
as boolean properties of an \fBoptions\fP object. Unlike the others querying
options, these aren’t URL parameters because they take effect when the view
index is generated, not when it’s accessed:
.INDENT 0.0
.IP \(bu 2
\fBlocal_seq\fP (\fIboolean\fP): Makes documents’ local sequence numbers available
to map functions (as a \fB_local_seq\fP document property)
.IP \(bu 2
\fBinclude_design\fP (\fIboolean\fP): Allows map functions to be called on design
documents as well as regular documents
.UNINDENT
.SS Querying Views and Indexes
.sp
The definition of a view within a design document also creates an index based
on the key information defined within each view. The production and use of the
index significantly increases the speed of access and searching or selecting
documents from the view.
.sp
However, the index is not updated when new documents are added or modified in
the database. Instead, the index is generated or updated, either when the view
is first accessed, or when the view is accessed after a document has been
updated. In each case, the index is updated before the view query is executed
against the database.
.sp
View indexes are updated incrementally in the following situations:
.INDENT 0.0
.IP \(bu 2
A new document has been added to the database.
.IP \(bu 2
A document has been deleted from the database.
.IP \(bu 2
A document in the database has been updated.
.UNINDENT
.sp
View indexes are rebuilt entirely when the view definition changes. To achieve
this, a ‘fingerprint’ of the view definition is created when the design
document is updated. If the fingerprint changes, then the view indexes are
entirely rebuilt. This ensures that changes to the view definitions are
reflected in the view indexes.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
View index rebuilds occur when one view from the same the view group (i.e.
all the views defined within a single a design document) has been
determined as needing a rebuild. For example, if you have a design
document with different views, and you update the database, all three view
indexes within the design document will be updated.
.UNINDENT
.UNINDENT
.sp
Because the view is updated when it has been queried, it can result in a delay
in returned information when the view is accessed, especially if there are a
large number of documents in the database and the view index does not exist.
There are a number of ways to mitigate, but not completely eliminate, these
issues. These include:
.INDENT 0.0
.IP \(bu 2
Create the view definition (and associated design documents) on your database
before allowing insertion or updates to the documents. If this is allowed
while the view is being accessed, the index can be updated incrementally.
.IP \(bu 2
Manually force a view request from the database. You can do this either
before users are allowed to use the view, or you can access the view manually
after documents are added or updated.
.IP \(bu 2
Use the \fI\%changes feed\fP to monitor for changes to the
database and then access the view to force the corresponding view index to be
updated.
.UNINDENT
.sp
None of these can completely eliminate the need for the indexes to be rebuilt
or updated when the view is accessed, but they may lessen the effects on
end\-users of the index update affecting the user experience.
.sp
Another alternative is to allow users to access a ‘stale’ version of the view
index, rather than forcing the index to be updated and displaying the updated
results. Using a stale view may not return the latest information, but will
return the results of the view query using an existing version of the index.
.sp
For example, to access the existing stale view \fBby_recipe\fP in the
\fBrecipes\fP design document:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
http://localhost:5984/recipes/_design/recipes/_view/by_recipe?stale=ok
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Accessing a stale view:
.INDENT 0.0
.IP \(bu 2
Does not trigger a rebuild of the view indexes, even if there have been
changes since the last access.
.IP \(bu 2
Returns the current version of the view index, if a current version exists.
.IP \(bu 2
Returns an empty result set if the given view index does not exist.
.UNINDENT
.sp
As an alternative, you use the \fBupdate_after\fP value to the \fBstale\fP
parameter. This causes the view to be returned as a stale view, but for the
update process to be triggered after the view information has been returned to
the client.
.sp
In addition to using stale views, you can also make use of the \fBupdate_seq\fP
query argument. Using this query argument generates the view information
including the update sequence of the database from which the view was
generated. The returned value can be compared this to the current update
sequence exposed in the database information (returned by \fI\%GET /{db}\fP).
.SS Sorting Returned Rows
.sp
Each element within the returned array is sorted using
native UTF\-8 sorting
according to the contents of the key portion of the
emitted content. The basic
order of output is as follows:
.INDENT 0.0
.IP \(bu 2
\fBnull\fP
.IP \(bu 2
\fBfalse\fP
.IP \(bu 2
\fBtrue\fP
.IP \(bu 2
Numbers
.IP \(bu 2
Text (case sensitive, lowercase first)
.IP \(bu 2
Arrays (according to the values of each element, in order)
.IP \(bu 2
Objects (according to the values of keys, in key order)
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /db/_design/test/_view/sorting HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Wed, 21 Aug 2013 10:09:25 GMT
ETag: \(dq8LA1LZPQ37B6R9U8BK9BGQH27\(dq
Server: CouchDB (Erlang/OTP)
Transfer\-Encoding: chunked

{
    \(dqoffset\(dq: 0,
    \(dqrows\(dq: [
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: null,
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: false,
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: true,
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: 0,
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: 1,
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: 10,
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: 42,
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: \(dq10\(dq,
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: \(dqhello\(dq,
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: \(dqHello\(dq,
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: \(dq\eu043f\eu0440\eu0438\eu0432\eu0435\eu0442\(dq,
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: [],
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: [
                1,
                2,
                3
            ],
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: [
                2,
                3
            ],
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: [
                3
            ],
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: {},
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: {
                \(dqfoo\(dq: \(dqbar\(dq
            },
            \(dqvalue\(dq: null
        }
    ],
    \(dqtotal_rows\(dq: 17
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You can reverse the order of the returned view information
by using the \fBdescending\fP query value set to true:
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /db/_design/test/_view/sorting?descending=true HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Wed, 21 Aug 2013 10:09:25 GMT
ETag: \(dqZ4N468R15JBT98OM0AMNSR8U\(dq
Server: CouchDB (Erlang/OTP)
Transfer\-Encoding: chunked

{
    \(dqoffset\(dq: 0,
    \(dqrows\(dq: [
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: {
                \(dqfoo\(dq: \(dqbar\(dq
            },
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: {},
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: [
                3
            ],
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: [
                2,
                3
            ],
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: [
                1,
                2,
                3
            ],
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: [],
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: \(dq\eu043f\eu0440\eu0438\eu0432\eu0435\eu0442\(dq,
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: \(dqHello\(dq,
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: \(dqhello\(dq,
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: \(dq10\(dq,
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: 42,
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: 10,
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: 1,
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: 0,
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: true,
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: false,
            \(dqvalue\(dq: null
        },
        {
            \(dqid\(dq: \(dqdummy\-doc\(dq,
            \(dqkey\(dq: null,
            \(dqvalue\(dq: null
        }
    ],
    \(dqtotal_rows\(dq: 17
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Sorting order and startkey/endkey
.sp
The sorting direction is applied before the filtering applied using the
\fBstartkey\fP and \fBendkey\fP query arguments. For example the following query:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET http://couchdb:5984/recipes/_design/recipes/_view/by_ingredient?startkey=%22carrots%22&endkey=%22egg%22 HTTP/1.1
Accept: application/json
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
will operate correctly when listing all the matching entries between
\fBcarrots\fP and \fBegg\fP\&. If the order of output is reversed with the
\fBdescending\fP query argument, the view request will return no entries:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes/_design/recipes/_view/by_ingredient?descending=true&startkey=%22carrots%22&endkey=%22egg%22 HTTP/1.1
Accept: application/json
Host: localhost:5984

{
    \(dqtotal_rows\(dq : 26453,
    \(dqrows\(dq : [],
    \(dqoffset\(dq : 21882
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The results will be empty because the entries in the view are reversed before
the key filter is applied, and therefore the \fBendkey\fP of “egg” will be seen
before the \fBstartkey\fP of “carrots”, resulting in an empty list.
.sp
Instead, you should reverse the values supplied to the \fBstartkey\fP and
\fBendkey\fP parameters to match the descending sorting applied to the keys.
Changing the previous example to:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes/_design/recipes/_view/by_ingredient?descending=true&startkey=%22egg%22&endkey=%22carrots%22 HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Raw collation
.sp
By default CouchDB uses an \fI\%ICU\fP driver for sorting view results. It’s possible
use binary collation instead for faster view builds where Unicode collation is
not important.
.sp
To use raw collation add \fB\(dqoptions\(dq:{\(dqcollation\(dq:\(dqraw\(dq}\fP  within the view object of the
design document. After that, views will be regenerated and new order applied for the
appropriate view.
.sp
\fBSEE ALSO:\fP
.INDENT 0.0
.INDENT 3.5
\fI\%Views Collation\fP
.UNINDENT
.UNINDENT
.SS Using Limits and Skipping Rows
.sp
By default, views return all results. That’s ok when the number of results is
small, but this may lead to problems when there are billions results, since the
client may have to read them all and consume all available memory.
.sp
But it’s possible to reduce output result rows by specifying \fBlimit\fP query
parameter. For example, retrieving the list of recipes using the \fBby_title\fP
view and limited to 5 returns only 5 records, while there are total 2667
records in view:
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes/_design/recipes/_view/by_title?limit=5 HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Wed, 21 Aug 2013 09:14:13 GMT
ETag: \(dq9Q6Q2GZKPH8D5F8L7PB6DBSS9\(dq
Server: CouchDB (Erlang/OTP)
Transfer\-Encoding: chunked

{
    \(dqoffset\(dq : 0,
    \(dqrows\(dq : [
        {
            \(dqid\(dq : \(dq3\-tiersalmonspinachandavocadoterrine\(dq,
            \(dqkey\(dq : \(dq3\-tier salmon, spinach and avocado terrine\(dq,
            \(dqvalue\(dq : [
                null,
                \(dq3\-tier salmon, spinach and avocado terrine\(dq
            ]
        },
        {
            \(dqid\(dq : \(dqAberffrawcake\(dq,
            \(dqkey\(dq : \(dqAberffraw cake\(dq,
            \(dqvalue\(dq : [
                null,
                \(dqAberffraw cake\(dq
            ]
        },
        {
            \(dqid\(dq : \(dqAdukiandorangecasserole\-microwave\(dq,
            \(dqkey\(dq : \(dqAduki and orange casserole \- microwave\(dq,
            \(dqvalue\(dq : [
                null,
                \(dqAduki and orange casserole \- microwave\(dq
            ]
        },
        {
            \(dqid\(dq : \(dqAioli\-garlicmayonnaise\(dq,
            \(dqkey\(dq : \(dqAioli \- garlic mayonnaise\(dq,
            \(dqvalue\(dq : [
                null,
                \(dqAioli \- garlic mayonnaise\(dq
            ]
        },
        {
            \(dqid\(dq : \(dqAlabamapeanutchicken\(dq,
            \(dqkey\(dq : \(dqAlabama peanut chicken\(dq,
            \(dqvalue\(dq : [
                null,
                \(dqAlabama peanut chicken\(dq
            ]
        }
    ],
    \(dqtotal_rows\(dq : 2667
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
To omit some records you may use \fBskip\fP query parameter:
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes/_design/recipes/_view/by_title?limit=3&skip=2 HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Wed, 21 Aug 2013 09:14:13 GMT
ETag: \(dqH3G7YZSNIVRRHO5FXPE16NJHN\(dq
Server: CouchDB (Erlang/OTP)
Transfer\-Encoding: chunked

{
    \(dqoffset\(dq : 2,
    \(dqrows\(dq : [
        {
            \(dqid\(dq : \(dqAdukiandorangecasserole\-microwave\(dq,
            \(dqkey\(dq : \(dqAduki and orange casserole \- microwave\(dq,
            \(dqvalue\(dq : [
                null,
                \(dqAduki and orange casserole \- microwave\(dq
            ]
        },
        {
            \(dqid\(dq : \(dqAioli\-garlicmayonnaise\(dq,
            \(dqkey\(dq : \(dqAioli \- garlic mayonnaise\(dq,
            \(dqvalue\(dq : [
                null,
                \(dqAioli \- garlic mayonnaise\(dq
            ]
        },
        {
            \(dqid\(dq : \(dqAlabamapeanutchicken\(dq,
            \(dqkey\(dq : \(dqAlabama peanut chicken\(dq,
            \(dqvalue\(dq : [
                null,
                \(dqAlabama peanut chicken\(dq
            ]
        }
    ],
    \(dqtotal_rows\(dq : 2667
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
Using \fBlimit\fP and \fBskip\fP parameters is not recommended for results
pagination. Read \fI\%pagination recipe\fP why it’s so
and how to make it better.
.UNINDENT
.UNINDENT
.SS Sending multiple queries to a view
.sp
New in version 2.2.

.INDENT 0.0
.TP
.B POST /{db}/_design/{ddoc}/_view/{view}/queries
Executes multiple specified view queries against the view function
from the specified design document.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBddoc\fP – Design document name
.IP \(bu 2
\fBview\fP – View function name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.UNINDENT
.TP
.B Request JSON Object
.INDENT 7.0
.IP \(bu 2
\fBqueries\fP – An array of query objects with fields for the
parameters of each individual view query to be executed. The field names
and their meaning are the same as the query parameters of a
regular \fI\%view request\fP\&.
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.UNINDENT

.IP \(bu 2
\fI\%ETag\fP – Response signature
.IP \(bu 2
\fI\%Transfer\-Encoding\fP – \fBchunked\fP
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBresults\fP (\fIarray\fP) – An array of result objects \- one for each query. Each
result object contains the same fields as the response to a regular
\fI\%view request\fP\&.
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid request
.IP \(bu 2
\fI\%401 Unauthorized\fP – Read permission required
.IP \(bu 2
\fI\%404 Not Found\fP – Specified database, design document or view is missing
.IP \(bu 2
\fI\%500 Internal Server Error\fP – View function execution error
.UNINDENT
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
POST /recipes/_design/recipes/_view/by_title/queries HTTP/1.1
Content\-Type: application/json
Accept: application/json
Host: localhost:5984

{
    \(dqqueries\(dq: [
        {
            \(dqkeys\(dq: [
                \(dqmeatballs\(dq,
                \(dqspaghetti\(dq
            ]
        },
        {
            \(dqlimit\(dq: 3,
            \(dqskip\(dq: 2
        }
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Wed, 20 Dec 2016 11:17:07 GMT
ETag: \(dq1H8RGBCK3ABY6ACDM7ZSC30QK\(dq
Server: CouchDB (Erlang/OTP)
Transfer\-Encoding: chunked

{
    \(dqresults\(dq : [
        {
            \(dqoffset\(dq: 0,
            \(dqrows\(dq: [
                {
                    \(dqid\(dq: \(dqSpaghettiWithMeatballs\(dq,
                    \(dqkey\(dq: \(dqmeatballs\(dq,
                    \(dqvalue\(dq: 1
                },
                {
                    \(dqid\(dq: \(dqSpaghettiWithMeatballs\(dq,
                    \(dqkey\(dq: \(dqspaghetti\(dq,
                    \(dqvalue\(dq: 1
                },
                {
                    \(dqid\(dq: \(dqSpaghettiWithMeatballs\(dq,
                    \(dqkey\(dq: \(dqtomato sauce\(dq,
                    \(dqvalue\(dq: 1
                }
            ],
            \(dqtotal_rows\(dq: 3
        },
        {
            \(dqoffset\(dq : 2,
            \(dqrows\(dq : [
                {
                    \(dqid\(dq : \(dqAdukiandorangecasserole\-microwave\(dq,
                    \(dqkey\(dq : \(dqAduki and orange casserole \- microwave\(dq,
                    \(dqvalue\(dq : [
                        null,
                        \(dqAduki and orange casserole \- microwave\(dq
                    ]
                },
                {
                    \(dqid\(dq : \(dqAioli\-garlicmayonnaise\(dq,
                    \(dqkey\(dq : \(dqAioli \- garlic mayonnaise\(dq,
                    \(dqvalue\(dq : [
                        null,
                        \(dqAioli \- garlic mayonnaise\(dq
                    ]
                },
                {
                    \(dqid\(dq : \(dqAlabamapeanutchicken\(dq,
                    \(dqkey\(dq : \(dqAlabama peanut chicken\(dq,
                    \(dqvalue\(dq : [
                        null,
                        \(dqAlabama peanut chicken\(dq
                    ]
                }
            ],
            \(dqtotal_rows\(dq : 2667
        }
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS \fB/db/_design/design\-doc/_search/index\-name\fP
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
Search endpoints require a running search plugin connected to each cluster
node. See \fI\%Search Plugin Installation\fP for details.
.UNINDENT
.UNINDENT
.sp
New in version 3.0.

.INDENT 0.0
.TP
.B GET /{db}/_design/{ddoc}/_search/{index}
Executes a search request against the named index in the specified design document.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBddoc\fP – Design document name
.IP \(bu 2
\fBindex\fP – Search index name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBbookmark\fP (\fIstring\fP) – A bookmark received from a previous search. This parameter
enables paging through the results. If there are no more results after the
bookmark, you get a response with an empty rows array and the same bookmark,
confirming the end of the result list.
.IP \(bu 2
\fBcounts\fP (\fIjson\fP) – An array of names of string fields for which counts
are requested. The response contains counts for each unique value of this field
name among the documents that match the search query. \fI\%Faceting\fP must be enabled for this parameter to function.
.IP \(bu 2
\fBdrilldown\fP (\fIjson\fP) – This field can be used several times. Each use defines a pair
with a field name and a value. The search matches only documents containing the
value that was provided in the named field. It differs from using
\fB\(dqfieldname:value\(dq\fP in the \fBq\fP parameter only in that the values are not
analyzed. \fI\%Faceting\fP must be enabled for this
parameter to function.
.IP \(bu 2
\fBgroup_field\fP (\fIstring\fP) – Field by which to group search matches. :query number
group_limit: Maximum group count. This field can be used only if \fBgroup_field\fP
is specified.
.IP \(bu 2
\fBgroup_sort\fP (\fIjson\fP) – This field defines the order of the groups in a search that
uses \fBgroup_field\fP\&. The default sort order is relevance.
.IP \(bu 2
\fBhighlight_fields\fP (\fIjson\fP) – Specifies which fields to highlight. If specified, the
result object contains a \fBhighlights\fP field with an entry for each specified
field.
.IP \(bu 2
\fBhighlight_pre_tag\fP (\fIstring\fP) – A string that is inserted before the highlighted
word in the highlights output.
.IP \(bu 2
\fBhighlight_post_tag\fP (\fIstring\fP) – A string that is inserted after the highlighted
word in the highlights output.
.IP \(bu 2
\fBhighlight_number\fP (\fInumber\fP) – Number of fragments that are returned in highlights.
If the search term occurs less often than the number of fragments that are
specified, longer fragments are returned.
.IP \(bu 2
\fBhighlight_size\fP (\fInumber\fP) – Number of characters in each fragment for highlights.
.IP \(bu 2
\fBinclude_docs\fP (\fIboolean\fP) – Include the full content of the documents in the
response.
.IP \(bu 2
\fBinclude_fields\fP (\fIjson\fP) – A JSON array of field names to include in search
results. Any fields that are included must be indexed with the store:true option.
.IP \(bu 2
\fBlimit\fP (\fInumber\fP) – Limit the number of the returned documents to the specified
number. For a grouped search, this parameter limits the number of documents per
group.
.IP \(bu 2
\fBq\fP (\fIstring\fP) – Alias for \fBquery\fP\&.
.IP \(bu 2
\fBquery\fP (\fIstring\fP) – Required. The Lucene query string.
.IP \(bu 2
\fBranges\fP (\fIjson\fP) – This field defines ranges for faceted, numeric search fields. The
value is a JSON object where the fields names are faceted numeric search fields,
and the values of the fields are JSON objects. The field names of the JSON objects
are names for ranges. The values are strings that describe the range, for example
“[0 TO 10]”.
.IP \(bu 2
\fBsort\fP (\fIjson\fP) – Specifies the sort order of the results. In a grouped search (when
\fBgroup_field\fP is used), this parameter specifies the sort order within a group.
The default sort order is relevance. A JSON string of the form
\fB\(dqfieldname<type>\(dq\fP or \fB\-fieldname<type>\fP for descending order, where
fieldname is the name of a string or number field, and \fBtype\fP is either a
number, a string, or a JSON array of strings. The \fBtype\fP part is optional, and
defaults to number. Some examples are \fB\(dqfoo\(dq\fP, \fB\(dq\-foo\(dq\fP, \fB\(dqbar<string>\(dq\fP,
\fB\(dq\-foo<number>\(dq\fP and [\fB\(dq\-foo<number>\(dq\fP, \fB\(dqbar<string>\(dq\fP]. String fields that
are used for sorting must not be analyzed fields. Fields that are used for sorting
must be indexed by the same indexer that is used for the search query.
.IP \(bu 2
\fBstale\fP (\fIstring\fP) – Set to \fBok\fP to allow the use of an out\-of\-date index.
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.IP \(bu 2
\fI\%ETag\fP – Response signature
.IP \(bu 2
\fI\%Transfer\-Encoding\fP – \fBchunked\fP
.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBrows\fP (\fIarray\fP) – Array of view row objects. By default the information
returned contains only the document ID and revision.
.IP \(bu 2
\fBtotal_rows\fP (\fInumber\fP) – Number of documents in the database/view.
.IP \(bu 2
\fBbookmark\fP (\fIstring\fP) – Opaque identifier to enable pagination.
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%400 Bad Request\fP – Invalid request
.IP \(bu 2
\fI\%401 Unauthorized\fP – Read permission required
.IP \(bu 2
\fI\%404 Not Found\fP – Specified database, design document or view is missed
.UNINDENT
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
You must enable \fI\%faceting\fP before you can use the
\fBcounts\fP, \fBdrilldown\fP, and \fBranges\fP parameters.
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Faceting and grouping are not supported on partitioned searches, so the following
query parameters should not be used on those requests: \fBcounts\fP, \fBdrilldown\fP,
\fBranges\fP, and \fBgroup_field\fP, \fBgroup_limit\fP, group_sort\(ga\(ga.
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Do not combine the \fBbookmark\fP and \fBstale\fP options. These options constrain the
choice of shard replicas to use for the response. When used together, the options
might cause problems when contact is attempted with replicas that are slow or not
available.
.UNINDENT
.UNINDENT
.sp
\fBSEE ALSO:\fP
.INDENT 0.0
.INDENT 3.5
For more information about how search works, see the
\fI\%Search User Guide\fP\&.
.UNINDENT
.UNINDENT
.SS \fB/db/_design/design\-doc/_search_info/index\-name\fP
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
Search endpoints require a running search plugin connected to each cluster
node. See \fI\%Search Plugin Installation\fP for details.
.UNINDENT
.UNINDENT
.sp
New in version 3.0.

.INDENT 0.0
.TP
.B GET /{db}/_design/{ddoc}/_search_info/{index}
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBddoc\fP – Design document name
.IP \(bu 2
\fBindex\fP – Search index name
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%400 Bad Request\fP – Request body is wrong (malformed or missing one of the mandatory fields)
.IP \(bu 2
\fI\%500 Internal Server Error\fP – A server error (or other kind of error) occurred
.UNINDENT
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes/_design/cookbook/_search_info/ingredients HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Content\-Type: application/json

{
    \(dqname\(dq: \(dq_design/cookbook/ingredients\(dq,
    \(dqsearch_index\(dq: {
        \(dqpending_seq\(dq: 7125496,
        \(dqdoc_del_count\(dq: 129180,
        \(dqdoc_count\(dq: 1066173,
        \(dqdisk_size\(dq: 728305827,
        \(dqcommitted_seq\(dq: 7125496
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS \fB/db/_design/design\-doc/_show/show\-name\fP
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
Show functions are deprecated in CouchDB 3.0, and will be removed in CouchDB 4.0.
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B GET /{db}/_design/{ddoc}/_show/{func}
.UNINDENT
.INDENT 0.0
.TP
.B POST /{db}/_design/{ddoc}/_show/{func}
Applies \fI\%show function\fP for \fBnull\fP document.
.sp
The request and response parameters are depended upon function
implementation.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBddoc\fP – Design document name
.IP \(bu 2
\fBfunc\fP – Show function name
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%ETag\fP – Response signature
.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBformat\fP (\fIstring\fP) – Format of the returned response.
Used by \fI\%provides()\fP function
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%500 Internal Server Error\fP – Query server error
.UNINDENT
.UNINDENT
.sp
\fBFunction\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc, req) {
    if (!doc) {
        return {body: \(dqno doc\(dq}
    } else {
        return {body: doc.description}
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes/_design/recipe/_show/description HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Content\-Length: 6
Content\-Type: text/html; charset=utf\-8
Date: Wed, 21 Aug 2013 12:34:07 GMT
Etag: \(dq7Z2TO7FPEMZ0F4GH0RJCRIOAU\(dq
Server: CouchDB (Erlang/OTP)
Vary: Accept

no doc
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/db/_design/design\-doc/_show/show\-name/doc\-id\fP
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
Show functions are deprecated in CouchDB 3.0, and will be removed in CouchDB 4.0.
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B GET /{db}/_design/{ddoc}/_show/{func}/{docid}
.UNINDENT
.INDENT 0.0
.TP
.B POST /{db}/_design/{ddoc}/_show/{func}/{docid}
Applies \fI\%show function\fP for the specified document.
.sp
The request and response parameters are depended upon function
implementation.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBddoc\fP – Design document name
.IP \(bu 2
\fBfunc\fP – Show function name
.IP \(bu 2
\fBdocid\fP – Document ID
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%ETag\fP – Response signature
.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBformat\fP (\fIstring\fP) – Format of the returned response.
Used by \fI\%provides()\fP function
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%500 Internal Server Error\fP – Query server error
.UNINDENT
.UNINDENT
.sp
\fBFunction\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc, req) {
    if (!doc) {
        return {body: \(dqno doc\(dq}
    } else {
        return {body: doc.description}
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes/_design/recipe/_show/description/SpaghettiWithMeatballs HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Content\-Length: 88
Content\-Type: text/html; charset=utf\-8
Date: Wed, 21 Aug 2013 12:38:08 GMT
Etag: \(dq8IEBO8103EI98HDZL5Z4I1T0C\(dq
Server: CouchDB (Erlang/OTP)
Vary: Accept

An Italian\-American dish that usually consists of spaghetti, tomato sauce and meatballs.
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/db/_design/design\-doc/_list/list\-name/view\-name\fP
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
List functions are deprecated in CouchDB 3.0, and will be removed in CouchDB 4.0.
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B GET /{db}/_design/{ddoc}/_list/{func}/{view}
.UNINDENT
.INDENT 0.0
.TP
.B POST /{db}/_design/{ddoc}/_list/{func}/{view}
Applies \fI\%list function\fP for the \fI\%view function\fP from the same design document.
.sp
The request and response parameters are depended upon function
implementation.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBddoc\fP – Design document name
.IP \(bu 2
\fBfunc\fP – List function name
.IP \(bu 2
\fBview\fP – View function name
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%ETag\fP – Response signature
.IP \(bu 2
\fI\%Transfer\-Encoding\fP – \fBchunked\fP
.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBformat\fP (\fIstring\fP) – Format of the returned response.
Used by \fI\%provides()\fP function
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%500 Internal Server Error\fP – Query server error
.UNINDENT
.UNINDENT
.sp
\fBFunction\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
function(head, req) {
    var row = getRow();
    if (!row){
        return \(aqno ingredients\(aq
    }
    send(row.key);
    while(row=getRow()){
        send(\(aq, \(aq + row.key);
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes/_design/recipe/_list/ingredients/by_name HTTP/1.1
Accept: text/plain
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Content\-Type: text/plain; charset=utf\-8
Date: Wed, 21 Aug 2013 12:49:15 GMT
Etag: \(dqD52L2M1TKQYDD1Y8MEYJR8C84\(dq
Server: CouchDB (Erlang/OTP)
Transfer\-Encoding: chunked
Vary: Accept

meatballs, spaghetti, tomato sauce
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/db/_design/design\-doc/_list/list\-name/other\-ddoc/view\-name\fP
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
List functions are deprecated in CouchDB 3.0, and will be removed in CouchDB 4.0.
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B GET /{db}/_design/{ddoc}/_list/{func}/{other\-ddoc}/{view}
.UNINDENT
.INDENT 0.0
.TP
.B POST /{db}/_design/{ddoc}/_list/{func}/{other\-ddoc}/{view}
Applies \fI\%list function\fP for the \fI\%view function\fP from the other design document.
.sp
The request and response parameters are depended upon function
implementation.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBddoc\fP – Design document name
.IP \(bu 2
\fBfunc\fP – List function name
.IP \(bu 2
\fBother\-ddoc\fP – Other design document name that holds view function
.IP \(bu 2
\fBview\fP – View function name
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%ETag\fP – Response signature
.IP \(bu 2
\fI\%Transfer\-Encoding\fP – \fBchunked\fP
.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBformat\fP (\fIstring\fP) – Format of the returned response.
Used by \fI\%provides()\fP function
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.IP \(bu 2
\fI\%500 Internal Server Error\fP – Query server error
.UNINDENT
.UNINDENT
.sp
\fBFunction\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
function(head, req) {
    var row = getRow();
    if (!row){
        return \(aqno ingredients\(aq
    }
    send(row.key);
    while(row=getRow()){
        send(\(aq, \(aq + row.key);
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /recipes/_design/ingredient/_list/ingredients/recipe/by_ingredient?key=\(dqspaghetti\(dq HTTP/1.1
Accept: text/plain
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Content\-Type: text/plain; charset=utf\-8
Date: Wed, 21 Aug 2013 12:49:15 GMT
Etag: \(dq5L0975X493R0FB5Z3043POZHD\(dq
Server: CouchDB (Erlang/OTP)
Transfer\-Encoding: chunked
Vary: Accept

spaghetti
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/db/_design/design\-doc/_update/update\-name\fP
.INDENT 0.0
.TP
.B POST /{db}/_design/{ddoc}/_update/{func}
Executes \fI\%update function\fP on server side for \fBnull\fP
document.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBddoc\fP – Design document name
.IP \(bu 2
\fBfunc\fP – Update function name
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fIX\-Couch\-Id\fP – Created/updated document’s ID
.IP \(bu 2
\fIX\-Couch\-Update\-NewRev\fP – Created/updated document’s revision
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – No document was created or updated
.IP \(bu 2
\fI\%201 Created\fP – Document was created or updated
.IP \(bu 2
\fI\%500 Internal Server Error\fP – Query server error
.UNINDENT
.UNINDENT
.sp
\fBFunction\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc, req) {
    if (!doc){
      return [null, {\(aqcode\(aq: 400,
                     \(aqjson\(aq: {\(aqerror\(aq: \(aqmissed\(aq,
                              \(aqreason\(aq: \(aqno document to update\(aq}}]
    } else {
        doc.ingredients.push(req.body);
        return [doc, {\(aqjson\(aq: {\(aqstatus\(aq: \(aqok\(aq}}];
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /recipes/_design/recipe/_update/ingredients HTTP/1.1
Accept: application/json
Content\-Length: 10
Content\-Type: application/json
Host: localhost:5984

\(dqsomething\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 404 Object Not Found
Cache\-Control: must\-revalidate
Content\-Length: 52
Content\-Type: application/json
Date: Wed, 21 Aug 2013 14:00:58 GMT
Server: CouchDB (Erlang/OTP)

{
    \(dqerror\(dq: \(dqmissed\(dq,
    \(dqreason\(dq: \(dqno document to update\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/db/_design/design\-doc/_update/update\-name/doc\-id\fP
.INDENT 0.0
.TP
.B PUT /{db}/_design/{ddoc}/_update/{func}/{docid}
Executes \fI\%update function\fP on server side for the specified
document.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBddoc\fP – Design document name
.IP \(bu 2
\fBfunc\fP – Update function name
.IP \(bu 2
\fBdocid\fP – Document ID
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fIX\-Couch\-Id\fP – Created/updated document’s ID
.IP \(bu 2
\fIX\-Couch\-Update\-NewRev\fP – Created/updated document’s revision
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – No document was created or updated
.IP \(bu 2
\fI\%201 Created\fP – Document was created or updated
.IP \(bu 2
\fI\%500 Internal Server Error\fP – Query server error
.UNINDENT
.UNINDENT
.sp
\fBFunction\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc, req) {
    if (!doc){
        return [null, {\(aqcode\(aq: 400,
                       \(aqjson\(aq: {\(aqerror\(aq: \(aqmissed\(aq,
                                \(aqreason\(aq: \(aqno document to update\(aq}}]
    } else {
        doc.ingredients.push(req.body);
        return [doc, {\(aqjson\(aq: {\(aqstatus\(aq: \(aqok\(aq}}];
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /recipes/_design/recipe/_update/ingredients/SpaghettiWithMeatballs HTTP/1.1
Accept: application/json
Content\-Length: 5
Content\-Type: application/json
Host: localhost:5984

\(dqlove\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 201 Created
Cache\-Control: must\-revalidate
Content\-Length: 16
Content\-Type: application/json
Date: Wed, 21 Aug 2013 14:11:34 GMT
Server: CouchDB (Erlang/OTP)
X\-Couch\-Id: SpaghettiWithMeatballs
X\-Couch\-Update\-NewRev: 12\-a5e099df5720988dae90c8b664496baf

{
    \(dqstatus\(dq: \(dqok\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/db/_design/design\-doc/_rewrite/path\fP
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
Rewrites are deprecated in CouchDB 3.0, and will be removed in CouchDB 4.0.
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B ANY /{db}/_design/{ddoc}/_rewrite/{path}
Rewrites the specified path by rules defined in the specified design
document. The rewrite rules are defined by the \fBrewrites\fP field of the
design document. The \fBrewrites\fP field can either be a \fIstring\fP containing
the a rewrite function or an \fIarray\fP of rule definitions.
.UNINDENT
.SS Using a stringified function for \fBrewrites\fP
.sp
New in version 2.0: When the \fBrewrites\fP field is a stringified function, the query server is used
to pre\-process and route requests.
.sp
The function takes a \fI\%Request2 object\fP\&.
.sp
The return value of the function will cause the server to rewrite the
request to a new location or immediately return a response.
.sp
To rewrite the request, return an object containing the following
properties:
.INDENT 0.0
.IP \(bu 2
\fBpath\fP (\fIstring\fP): Rewritten path.
.IP \(bu 2
\fBquery\fP (\fIarray\fP): Rewritten query. If omitted, the original
query keys are used.
.IP \(bu 2
\fBheaders\fP (\fIobject\fP): Rewritten headers. If omitted, the original
request headers are used.
.IP \(bu 2
\fBmethod\fP (\fIstring\fP): HTTP method of rewritten request (\fB\(dqGET\(dq\fP,
\fB\(dqPOST\(dq\fP, etc). If omitted, the original request method is used.
.IP \(bu 2
\fBbody\fP (\fIstring\fP): Body for \fB\(dqPOST\(dq\fP/\fB\(dqPUT\(dq\fP requests. If omitted,
the original request body is used.
.UNINDENT
.sp
To immediately respond to the request, return an object containing the
following properties:
.INDENT 0.0
.IP \(bu 2
\fBcode\fP (\fInumber\fP): Returned HTTP status code (\fB200\fP, \fB404\fP, etc).
.IP \(bu 2
\fBbody\fP (\fIstring\fP): Body of the response to user.
.UNINDENT
.sp
\fBExample A\fP\&. Restricting access.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(req2) {
  var path = req2.path.slice(4),
    isWrite = /^(put|post|delete)$/i.test(req2.method),
    isFinance = req2.userCtx.roles.indexOf(\(dqfinance\(dq) > \-1;
  if (path[0] == \(dqfinance\(dq && isWrite && !isFinance) {
    // Deny writes to  DB \(dqfinance\(dq for users
    // having no \(dqfinance\(dq role
    return {
      code: 403,
      body: JSON.stringify({
        error: \(dqforbidden\(dq.
        reason: \(dqYou are not allowed to modify docs in this DB\(dq
      })
    };
  }
  // Pass through all other requests
  return { path: \(dq../../../\(dq + path.join(\(dq/\(dq) };
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBExample B\fP\&. Different replies for JSON and HTML requests.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(req2) {
  var path = req2.path.slice(4),
    h = headers,
    wantsJson = (h.Accept || \(dq\(dq).indexOf(\(dqapplication/json\(dq) > \-1,
    reply = {};
  if (!wantsJson) {
    // Here we should prepare reply object
    // for plain HTML pages
  } else {
    // Pass through JSON requests
    reply.path = \(dq../../../\(dq+path.join(\(dq/\(dq);
  }
  return reply;
}
.ft P
.fi
.UNINDENT
.UNINDENT

.SS Using an array of rules for \fBrewrites\fP
.INDENT 0.0
.INDENT 3.5
When the \fBrewrites\fP field is an array of rule objects, the server will
rewrite the request based on the first matching rule in the array.
.sp
Each rule in the array is an \fIobject\fP with the following fields:
.INDENT 0.0
.IP \(bu 2
\fBmethod\fP (\fIstring\fP): HTTP request method to bind the request method to
the rule. If omitted, uses \fB\(dq*\(dq\fP, which matches all methods.
.IP \(bu 2
\fBfrom\fP (\fIstring\fP): The pattern used to compare against the URL and
define dynamic variables.
.IP \(bu 2
\fBto\fP (\fIstring\fP): The path to rewrite the URL to. It can contain
variables depending on binding variables discovered during pattern
matching and query args (URL args and from the query member).
.IP \(bu 2
\fBquery\fP (\fIobject\fP): Query args passed to the rewritten URL. They may
contain dynamic variables.
.UNINDENT
.sp
The \fBto\fP and \fBfrom\fP paths may contains string patterns with leading
\fB:\fP or \fB*\fP characters to define dynamic variables in the match.
.sp
The first rule in the \fBrewrites\fP array that matches the incoming request
is used to define the rewrite. To match the incoming request, the
rule’s \fBmethod\fP must match the request’s HTTP method and the rule’s
\fBfrom\fP must match the request’s path using the following pattern matching
logic.
.INDENT 0.0
.IP \(bu 2
The \fIfrom\fP pattern and URL are first split on \fB/\fP to get a list of
tokens. For example, if \fIfrom\fP field is \fB/somepath/:var/*\fP and the URL
is \fB/somepath/a/b/c\fP, the tokens are \fBsomepath\fP, \fB:var\fP, and
\fB*\fP for the \fIfrom\fP pattern and \fBsomepath\fP, \fBa\fP, \fBb\fP, and
\fBc\fP for the URL.
.IP \(bu 2
Each token starting with \fB:\fP in the pattern will match the
corresponding token in the URL and define a new dynamic variable whose
name is the remaining string after the \fB:\fP and value is the token from
the URL. In this example, the \fB:var\fP token will match \fBb\fP
and set \fBvar\fP = \fBa\fP\&.
.IP \(bu 2
The star token \fB*\fP in the pattern will match any number of tokens in
the URL and must be the last token in the pattern. It will define a
dynamic variable with the remaining tokens. In this example, the \fB*\fP
token will match the \fBb\fP and \fBc\fP tokens and set \fB*\fP =
\fBb/c\fP\&.
.IP \(bu 2
The remaining tokens must match exactly for the pattern to be considered
a match. In this example, \fBsomepath\fP in the pattern matches
\fBsomepath\fP in the URL and all tokens in the URL have matched, causing
this rule to be a match.
.UNINDENT
.sp
Once a rule is found, the request URL is rewritten using the \fBto\fP and
\fBquery\fP fields. Dynamic variables are substituted into the \fB:\fP and
\fB*\fP variables in these fields to produce the final URL.
.sp
If no rule matches, a \fI\%404 Not Found\fP response is returned.
.sp
Examples:
.TS
center;
|l|l|l|l|.
_
T{
Rule
T}	T{
URL
T}	T{
Rewrite to
T}	T{
Tokens
T}
_
T{
.INDENT 0.0
.TP
.B {“from”: “/a”,
“to”: “/some”}
.UNINDENT
T}	T{
/a
T}	T{
/some
T}	T{
T}
_
T{
.INDENT 0.0
.TP
.B {“from”: “/a/*”,
“to”: “/some/*}
.UNINDENT
T}	T{
/a/b/c
T}	T{
/some/b/c
T}	T{
T}
_
T{
.INDENT 0.0
.TP
.B {“from”: “/a/b”,
“to”: “/some”}
.UNINDENT
T}	T{
/a/b?k=v
T}	T{
/some?k=v
T}	T{
k=v
T}
_
T{
.INDENT 0.0
.TP
.B {“from”: “/a/b”,
“to”: “/some/:var”}
.UNINDENT
T}	T{
/a/b
T}	T{
/some/b?var=b
T}	T{
var=b
T}
_
T{
.INDENT 0.0
.TP
.B {“from”: “/a/:foo/”,
“to”: “/some/:foo/”}
.UNINDENT
T}	T{
/a/b/c
T}	T{
/some/b/c?foo=b
T}	T{
foo=b
T}
_
T{
.INDENT 0.0
.TP
.B {“from”: “/a/:foo”,
“to”: “/some”,
“query”: { “k”: “:foo” }}
.UNINDENT
T}	T{
/a/b
T}	T{
/some/?k=b&foo=b
T}	T{
foo=b
T}
_
T{
.INDENT 0.0
.TP
.B {“from”: “/a”,
“to”: “/some/:foo”}
.UNINDENT
T}	T{
/a?foo=b
T}	T{
/some/?b&foo=b
T}	T{
foo=b
T}
_
.TE
.sp
Request method, header, query parameters, request payload and response body
are dependent on the endpoint to which the URL will be rewritten.
.INDENT 0.0
.TP
.B param db
Database name
.TP
.B param ddoc
Design document name
.TP
.B param path
URL path to rewrite
.UNINDENT
.UNINDENT
.UNINDENT
.SS Partitioned Databases
.sp
Partitioned databases allow for data colocation in a cluster, which provides
significant performance improvements for queries constrained to a single
partition.
.sp
See the guide for
\fI\%getting started with partitioned databases\fP
.SS \fB/db/_partition/partition\fP
.INDENT 0.0
.TP
.B GET /{db}/_partition/{partition}
This endpoint returns information describing the provided partition.
It includes document and deleted document counts along with external
and active data sizes.
.INDENT 7.0
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /db/_partition/sensor\-260 HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Length: 119
Content\-Type: application/json
Date: Thu, 24 Jan 2019 17:19:59 GMT
Server: CouchDB/2.3.0\-a1e11cea9 (Erlang OTP/21)

{
  \(dqdb_name\(dq: \(dqmy_new_db\(dq,
  \(dqdoc_count\(dq: 1,
  \(dqdoc_del_count\(dq: 0,
  \(dqpartition\(dq: \(dqsensor\-260\(dq,
  \(dqsizes\(dq: {
    \(dqactive\(dq: 244,
    \(dqexternal\(dq: 347
  }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/db/_partition/partition/_all_docs\fP
.INDENT 0.0
.TP
.B GET /{db}/_partition/{partition}/_all_docs
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBpartition\fP – Partition name
.UNINDENT
.UNINDENT
.sp
This endpoint is a convenience endpoint for automatically setting
bounds on the provided partition range. Similar results can be had
by using the global \fB/db/_all_docs\fP endpoint with appropriately
configured values for \fBstart_key\fP and \fBend_key\fP\&.
.sp
Refer to the \fI\%view endpoint\fP documentation for
a complete description of the available query parameters and the format
of the returned data.
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /db/_partition/sensor\-260/_all_docs HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Sat, 10 Aug 2013 16:22:56 GMT
ETag: \(dq1W2DJUZFZSZD9K78UFA3GZWB4\(dq
Server: CouchDB (Erlang/OTP)
Transfer\-Encoding: chunked

{
  \(dqoffset\(dq: 0,
  \(dqrows\(dq: [
    {
      \(dqid\(dq: \(dqsensor\-260:sensor\-reading\-ca33c748\-2d2c\-4ed1\-8abf\-1bca4d9d03cf\(dq,
      \(dqkey\(dq: \(dqsensor\-260:sensor\-reading\-ca33c748\-2d2c\-4ed1\-8abf\-1bca4d9d03cf\(dq,
      \(dqvalue\(dq: {
        \(dqrev\(dq: \(dq1\-05ed6f7abf84250e213fcb847387f6f5\(dq
      }
    }
  ],
  \(dqtotal_rows\(dq: 1
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/db/_partition/partition/_design/design\-doc/_view/view\-name\fP
.INDENT 0.0
.TP
.B GET /{db}/_partition/{partition}/_design/{ddoc}/_view/{view}
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBpartition\fP – Partition name
.IP \(bu 2
\fBddoc\fP – Design document id
.IP \(bu 2
\fBview\fP – View name
.UNINDENT
.UNINDENT
.sp
This endpoint is responsible for executing a partitioned query. The
returned view result will only contain rows with the specified
partition name.
.sp
Refer to the \fI\%view endpoint\fP documentation for
a complete description of the available query parameters and the format
of the returned data.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /db/_partition/sensor\-260/_design/sensor\-readings/_view/by_sensor HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Wed, 21 Aug 2013 09:12:06 GMT
ETag: \(dq2FOLSBSW4O6WB798XU4AQYA9B\(dq
Server: CouchDB (Erlang/OTP)
Transfer\-Encoding: chunked

{
  \(dqoffset\(dq: 0,
  \(dqrows\(dq: [
    {
      \(dqid\(dq: \(dqsensor\-260:sensor\-reading\-ca33c748\-2d2c\-4ed1\-8abf\-1bca4d9d03cf\(dq,
      \(dqkey\(dq: [
        \(dqsensor\-260\(dq,
        \(dq0\(dq
      ],
      \(dqvalue\(dq: null
    },
    {
      \(dqid\(dq: \(dqsensor\-260:sensor\-reading\-ca33c748\-2d2c\-4ed1\-8abf\-1bca4d9d03cf\(dq,
      \(dqkey\(dq: [
        \(dqsensor\-260\(dq,
        \(dq1\(dq
      ],
      \(dqvalue\(dq: null
    },
    {
      \(dqid\(dq: \(dqsensor\-260:sensor\-reading\-ca33c748\-2d2c\-4ed1\-8abf\-1bca4d9d03cf\(dq,
      \(dqkey\(dq: [
        \(dqsensor\-260\(dq,
        \(dq2\(dq
      ],
      \(dqvalue\(dq: null
    },
    {
      \(dqid\(dq: \(dqsensor\-260:sensor\-reading\-ca33c748\-2d2c\-4ed1\-8abf\-1bca4d9d03cf\(dq,
      \(dqkey\(dq: [
        \(dqsensor\-260\(dq,
        \(dq3\(dq
      ],
      \(dqvalue\(dq: null
    }
  ],
  \(dqtotal_rows\(dq: 4
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/db/_partition/partition_id/_find\fP
.INDENT 0.0
.TP
.B POST /{db}/_partition/{partition_id}/_find
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.IP \(bu 2
\fBid\fP (\fIpartition\fP) – Name of the partition to query
.UNINDENT
.UNINDENT
.sp
This endpoint is responsible for finding a partition query by its ID.
The returned view result will only contain rows with the
specified partition id.
.sp
Refer to the \fI\%find endpoint\fP
documentation for a complete description of the
available parameters and the format
of the returned data.
.UNINDENT
.SS \fB/db/_partition/partition_id/_explain\fP
.INDENT 0.0
.TP
.B POST /{db}/_partition/{partition_id}/_explain
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Partition id
Name of the partition to query
.UNINDENT
.sp
This endpoint shows which index is being used by the query.
.sp
Refer to the \fI\%explain endpoint\fP
documentation for a complete description of the available
parameters and the format of the returned data.
.UNINDENT
.SS Local (non\-replicating) Documents
.sp
The Local (non\-replicating) document interface allows you to create local
documents that are not replicated to other databases. These documents can be
used to hold configuration or other information that is required specifically
on the local CouchDB instance.
.sp
Local documents have the following limitations:
.INDENT 0.0
.IP \(bu 2
Local documents are not replicated to other databases.
.IP \(bu 2
Local documents are not output by views, or the \fI\%/{db}/_all_docs\fP view.
.UNINDENT
.sp
From CouchDB 2.0, Local documents can be listed by using the /db/_local_docs
endpoint.
.sp
Local documents can be used when you want to store configuration or
other information for the current (local) instance of a given database.
.sp
A list of the available methods and URL paths are provided below:
.TS
center;
|l|l|l|.
_
T{
Method
T}	T{
Path
T}	T{
Description
T}
_
T{
GET,
POST
T}	T{
/db/_local_docs
T}	T{
Returns a list of all the
non\-replicated documents in the database
T}
_
T{
GET
T}	T{
/db/_local/id
T}	T{
Returns the latest revision of the
non\-replicated document
T}
_
T{
PUT
T}	T{
/db/_local/id
T}	T{
Inserts a new version of the
non\-replicated document
T}
_
T{
DELETE
T}	T{
/db/_local/id
T}	T{
Deletes the non\-replicated document
T}
_
T{
COPY
T}	T{
/db/_local/id
T}	T{
Copies the non\-replicated document
T}
_
.TE
.SS \fB/db/_local_docs\fP
.INDENT 0.0
.TP
.B GET /{db}/_local_docs
Returns a JSON structure of all of the local documents in a given
database. The information is returned as a JSON structure containing meta
information about the return structure, including a list of all local
documents and basic contents, consisting the ID, revision and key. The key
is the from the local document’s \fB_id\fP\&.
.INDENT 7.0
.TP
.B Parameters
.INDENT 7.0
.IP \(bu 2
\fBdb\fP – Database name
.UNINDENT
.TP
.B Request Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Accept\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain\fP
.UNINDENT

.UNINDENT
.TP
.B Query Parameters
.INDENT 7.0
.IP \(bu 2
\fBconflicts\fP (\fIboolean\fP) – Includes \fIconflicts\fP information in response.
Ignored if \fBinclude_docs\fP isn’t \fBtrue\fP\&. Default is \fBfalse\fP\&.
.IP \(bu 2
\fBdescending\fP (\fIboolean\fP) – Return the local documents in descending by
key order. Default is \fBfalse\fP\&.
.IP \(bu 2
\fBendkey\fP (\fIstring\fP) – Stop returning records when the specified key is
reached. \fIOptional\fP\&.
.IP \(bu 2
\fBend_key\fP (\fIstring\fP) – Alias for \fBendkey\fP param.
.IP \(bu 2
\fBendkey_docid\fP (\fIstring\fP) – Stop returning records when the specified
local document ID is reached. \fIOptional\fP\&.
.IP \(bu 2
\fBend_key_doc_id\fP (\fIstring\fP) – Alias for \fBendkey_docid\fP param.
.IP \(bu 2
\fBinclude_docs\fP (\fIboolean\fP) – Include the full content of the local
documents in the return. Default is \fBfalse\fP\&.
.IP \(bu 2
\fBinclusive_end\fP (\fIboolean\fP) – Specifies whether the specified end key
should be included in the result. Default is \fBtrue\fP\&.
.IP \(bu 2
\fBkey\fP (\fIstring\fP) – Return only local documents that match the specified
key. \fIOptional\fP\&.
.IP \(bu 2
\fBkeys\fP (\fIstring\fP) – Return only local documents that match the specified
keys. \fIOptional\fP\&.
.IP \(bu 2
\fBlimit\fP (\fInumber\fP) – Limit the number of the returned local documents to
the specified number. \fIOptional\fP\&.
.IP \(bu 2
\fBskip\fP (\fInumber\fP) – Skip this number of records before starting to return
the results. Default is \fB0\fP\&.
.IP \(bu 2
\fBstartkey\fP (\fIstring\fP) – Return records starting with the specified key.
\fIOptional\fP\&.
.IP \(bu 2
\fBstart_key\fP (\fIstring\fP) – Alias for \fBstartkey\fP param.
.IP \(bu 2
\fBstartkey_docid\fP (\fIstring\fP) – Return records starting with the specified
local document ID. \fIOptional\fP\&.
.IP \(bu 2
\fBstart_key_doc_id\fP (\fIstring\fP) – Alias for \fBstartkey_docid\fP param.
.IP \(bu 2
\fBupdate_seq\fP (\fIboolean\fP) – Response includes an \fBupdate_seq\fP value
indicating which sequence id of the underlying database the view
reflects. Default is \fBfalse\fP\&.
.UNINDENT
.TP
.B Response Headers
.INDENT 7.0
.IP \(bu 2
\fI\%Content\-Type\fP – .INDENT 2.0
.IP \(bu 2
\fIapplication/json\fP
.IP \(bu 2
\fItext/plain; charset=utf\-8\fP
.UNINDENT

.UNINDENT
.TP
.B Response JSON Object
.INDENT 7.0
.IP \(bu 2
\fBoffset\fP (\fInumber\fP) – Offset where the local document list started
.IP \(bu 2
\fBrows\fP (\fIarray\fP) – Array of view row objects. By default the information
returned contains only the local document ID and revision.
.IP \(bu 2
\fBtotal_rows\fP (\fInumber\fP) – Number of local documents in the database. Note
that this is not the number of rows returned in the actual query.
.IP \(bu 2
\fBupdate_seq\fP (\fInumber\fP) – Current update sequence for the database
.UNINDENT
.TP
.B Status Codes
.INDENT 7.0
.IP \(bu 2
\fI\%200 OK\fP – Request completed successfully
.UNINDENT
.UNINDENT
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
GET /db/_local_docs HTTP/1.1
Accept: application/json
Host: localhost:5984
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBResponse\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
HTTP/1.1 200 OK
Cache\-Control: must\-revalidate
Content\-Type: application/json
Date: Sat, 23 Dec 2017 16:22:56 GMT
Server: CouchDB (Erlang/OTP)
Transfer\-Encoding: chunked

{
    \(dqoffset\(dq: null,
    \(dqrows\(dq: [
        {
            \(dqid\(dq: \(dq_local/localdoc01\(dq,
            \(dqkey\(dq: \(dq_local/localdoc01\(dq,
            \(dqvalue\(dq: {
                \(dqrev\(dq: \(dq0\-1\(dq
            }
        },
        {
            \(dqid\(dq: \(dq_local/localdoc02\(dq,
            \(dqkey\(dq: \(dq_local/localdoc02\(dq,
            \(dqvalue\(dq: {
                \(dqrev\(dq: \(dq0\-1\(dq
            }
        },
        {
            \(dqid\(dq: \(dq_local/localdoc03\(dq,
            \(dqkey\(dq: \(dq_local/localdoc03\(dq,
            \(dqvalue\(dq: {
                \(dqrev\(dq: \(dq0\-1\(dq
            }
        },
        {
            \(dqid\(dq: \(dq_local/localdoc04\(dq,
            \(dqkey\(dq: \(dq_local/localdoc04\(dq,
            \(dqvalue\(dq: {
                \(dqrev\(dq: \(dq0\-1\(dq
            }
        },
        {
            \(dqid\(dq: \(dq_local/localdoc05\(dq,
            \(dqkey\(dq: \(dq_local/localdoc05\(dq,
            \(dqvalue\(dq: {
                \(dqrev\(dq: \(dq0\-1\(dq
            }
        }
    ],
    \(dqtotal_rows\(dq: null
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B POST /{db}/_local_docs
\fI\%POST\fP \fI_local_docs\fP functionality supports identical parameters and behavior
as specified in the \fI\%GET /{db}/_local_docs\fP API but allows for the query string
parameters to be supplied as keys in a JSON object in the body of the \fIPOST\fP request.
.sp
\fBRequest\fP:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
POST /db/_local_docs HTTP/1.1
Accept: application/json
Content\-Length: 70
Content\-Type: application/json
Host: localhost:5984

{
    \(dqkeys\(dq : [
        \(dq_local/localdoc02\(dq,
        \(dq_local/localdoc05\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The returned JSON is the all documents structure, but with only the
selected keys in the output:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqtotal_rows\(dq : null,
    \(dqrows\(dq : [
        {
            \(dqvalue\(dq : {
                \(dqrev\(dq : \(dq0\-1\(dq
            },
            \(dqid\(dq : \(dq_local/localdoc02\(dq,
            \(dqkey\(dq : \(dq_local/localdoc02\(dq
        },
        {
            \(dqvalue\(dq : {
                \(dqrev\(dq : \(dq0\-1\(dq
            },
            \(dqid\(dq : \(dq_local/localdoc05\(dq,
            \(dqkey\(dq : \(dq_local/localdoc05\(dq
        }
    ],
    \(dqoffset\(dq : null
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SS \fB/db/_local/id\fP
.INDENT 0.0
.TP
.B GET /{db}/_local/{docid}
Gets the specified local document. The semantics are identical to accessing
a standard document in the specified database, except that the document is
not replicated. See \fI\%GET /{db}/{docid}\fP\&.
.UNINDENT
.INDENT 0.0
.TP
.B PUT /{db}/_local/{docid}
Stores the specified local document. The semantics are identical to storing
a standard document in the specified database, except that the document is
not replicated. See \fI\%PUT /{db}/{docid}\fP\&.
.UNINDENT
.INDENT 0.0
.TP
.B DELETE /{db}/_local/{docid}
Deletes the specified local document. The semantics are identical to
deleting a standard document in the specified database, except that the
document is not replicated. See \fI\%DELETE /{db}/{docid}\fP\&.
.UNINDENT
.INDENT 0.0
.TP
.B COPY /{db}/_local/{docid}
Copies the specified local document. The semantics are identical to copying
a standard document in the specified database, except that the document is
not replicated. See \fI\%COPY /{db}/{docid}\fP\&.
.UNINDENT
.SH JSON STRUCTURE REFERENCE
.sp
The following appendix provides a quick reference to all the JSON structures
that you can supply to CouchDB, or get in return to requests.
.SS All Database Documents
.TS
center;
|l|l|.
_
T{
Field
T}	T{
Description
T}
_
T{
total_rows
T}	T{
Number of documents in the database/view
T}
_
T{
offset
T}	T{
Offset where the document list started
T}
_
T{
update_seq (optional)
T}	T{
Current update sequence for the database
T}
_
T{
rows [array]
T}	T{
Array of document object
T}
_
.TE
.SS Bulk Document Response
.TS
center;
|l|l|.
_
T{
Field
T}	T{
Description
T}
_
T{
docs [array]
T}	T{
Bulk Docs Returned Documents
T}
_
T{
id
T}	T{
Document ID
T}
_
T{
error
T}	T{
Error type
T}
_
T{
reason
T}	T{
Error string with extended reason
T}
_
.TE
.SS Bulk Documents
.TS
center;
|l|l|.
_
T{
Field
T}	T{
Description
T}
_
T{
docs [array]
T}	T{
Bulk Documents Document
T}
_
T{
_id (optional)
T}	T{
Document ID
T}
_
T{
_rev (optional)
T}	T{
Revision ID (when updating an existing
document)
T}
_
T{
_deleted (optional)
T}	T{
Whether the document should be deleted
T}
_
.TE
.SS Changes information for a database
.TS
center;
|l|l|.
_
T{
Field
T}	T{
Description
T}
_
T{
last_seq
T}	T{
Last update sequence
T}
_
T{
pending
T}	T{
Count of remaining items in the feed
T}
_
T{
results [array]
T}	T{
Changes made to a database
T}
_
T{
seq
T}	T{
Update sequence
T}
_
T{
id
T}	T{
Document ID
T}
_
T{
changes [array]
T}	T{
List of changes, field\-by\-field, for this
document
T}
_
.TE
.SS CouchDB Document
.TS
center;
|l|l|.
_
T{
Field
T}	T{
Description
T}
_
T{
_id (optional)
T}	T{
Document ID
T}
_
T{
_rev (optional)
T}	T{
Revision ID (when updating an existing
document)
T}
_
.TE
.SS CouchDB Error Status
.TS
center;
|l|l|.
_
T{
Field
T}	T{
Description
T}
_
T{
id
T}	T{
Document ID
T}
_
T{
error
T}	T{
Error type
T}
_
T{
reason
T}	T{
Error string with extended reason
T}
_
.TE
.SS CouchDB database information object
.TS
center;
|l|l|.
_
T{
Field
T}	T{
Description
T}
_
T{
db_name
T}	T{
The name of the database.
T}
_
T{
committed_update_seq
T}	T{
The number of committed updates.
T}
_
T{
doc_count
T}	T{
The number of documents in the database.
T}
_
T{
doc_del_count
T}	T{
The number of deleted documents.
T}
_
T{
compact_running
T}	T{
Set to true if the database compaction
routine is operating on this database.
T}
_
T{
disk_format_version
T}	T{
The version of the physical format used for
the data when it is stored on hard disk.
T}
_
T{
disk_size
T}	T{
Size in bytes of the data as stored on disk.
View indexes are not included in the
calculation.
T}
_
T{
instance_start_time
T}	T{
Timestamp indicating when the database was
opened, expressed in microseconds since the
epoch.
T}
_
T{
purge_seq
T}	T{
The number of purge operations on the
database.
T}
_
T{
update_seq
T}	T{
Current update sequence for the database.
T}
_
.TE
.SS Design Document
.TS
center;
|l|l|.
_
T{
Field
T}	T{
Description
T}
_
T{
_id
T}	T{
Design Document ID
T}
_
T{
_rev
T}	T{
Design Document Revision
T}
_
T{
views
T}	T{
View
T}
_
T{
viewname
T}	T{
View Definition
T}
_
T{
map
T}	T{
Map Function for View
T}
_
T{
reduce (optional)
T}	T{
Reduce Function for View
T}
_
.TE
.SS Design Document Information
.TS
center;
|l|l|.
_
T{
Field
T}	T{
Description
T}
_
T{
name
T}	T{
Name/ID of Design Document
T}
_
T{
view_index
T}	T{
View Index
T}
_
T{
compact_running
T}	T{
Indicates whether a compaction routine is
currently running on the view
T}
_
T{
disk_size
T}	T{
Size in bytes of the view as stored on disk
T}
_
T{
language
T}	T{
Language for the defined views
T}
_
T{
purge_seq
T}	T{
The purge sequence that has been processed
T}
_
T{
signature
T}	T{
MD5 signature of the views for the design
document
T}
_
T{
update_seq
T}	T{
The update sequence of the corresponding
database that has been indexed
T}
_
T{
updater_running
T}	T{
Indicates if the view is currently being
updated
T}
_
T{
waiting_clients
T}	T{
Number of clients waiting on views from this
design document
T}
_
T{
waiting_commit
T}	T{
Indicates if there are outstanding commits
to the underlying database that need to
processed
T}
_
.TE
.SS Document with Attachments
.TS
center;
|l|l|.
_
T{
Field
T}	T{
Description
T}
_
T{
_id (optional)
T}	T{
Document ID
T}
_
T{
_rev (optional)
T}	T{
Revision ID (when updating an existing
document)
T}
_
T{
_attachments (optional)
T}	T{
Document Attachment
T}
_
T{
filename
T}	T{
Attachment information
T}
_
T{
content_type
T}	T{
MIME Content type string
T}
_
T{
data
T}	T{
File attachment content, Base64 encoded
T}
_
.TE
.SS List of Active Tasks
.TS
center;
|l|l|.
_
T{
Field
T}	T{
Description
T}
_
T{
tasks [array]
T}	T{
Active Tasks
T}
_
T{
pid
T}	T{
Process ID
T}
_
T{
status
T}	T{
Task status message
T}
_
T{
task
T}	T{
Task name
T}
_
T{
type
T}	T{
Operation Type
T}
_
.TE
.SS Replication Settings
.TS
center;
|l|l|.
_
T{
Field
T}	T{
Description
T}
_
T{
source
T}	T{
Source database name or URL.
T}
_
T{
target
T}	T{
Target database name or URL.
T}
_
T{
cancel (optional)
T}	T{
Cancels the replication.
T}
_
T{
checkpoint_interval (optional)
T}	T{
Specifies the checkpoint interval in ms.
T}
_
T{
continuous (optional)
T}	T{
Configure the replication to be continuous.
T}
_
T{
create_target (optional)
T}	T{
Creates the target database.
T}
_
T{
doc_ids (optional)
T}	T{
Array of document IDs to be synchronized.
T}
_
T{
filter (optional)
T}	T{
name of the filter function in the form of
\fBddoc/myfilter\fP\&.
T}
_
T{
source_proxy (optional)
T}	T{
Address of a proxy server through which
replication from the source should occur.
T}
_
T{
target_proxy (optional)
T}	T{
Address of a proxy server through which
replication to the target should occur.
T}
_
T{
query_params (optional)
T}	T{
Query parameter that are passed to the
filter function; the value should be a
document containing parameters as members.
T}
_
T{
selector (optional)
T}	T{
Select the documents included in the
replication. This option provides
performance benefits compared with using
the \fBfilter\fP option.
T}
_
T{
since_seq (optional)
T}	T{
Sequence from which the replication should
start.
T}
_
T{
use_checkpoints (optional)
T}	T{
Whether to use replication checkpoints
or not.
T}
_
T{
winning_revs_only (optional)
T}	T{
Replicate only the winning revisions.
T}
_
T{
use_bulk_get (optional)
T}	T{
Try to use \fB_bulk_get\fP to fetch revisions.
T}
_
.TE
.SS Replication Status
.TS
center;
|l|l|.
_
T{
Field
T}	T{
Description
T}
_
T{
ok
T}	T{
Replication status
T}
_
T{
session_id
T}	T{
Unique session ID
T}
_
T{
source_last_seq
T}	T{
Last sequence number read from the source
database
T}
_
T{
history [array]
T}	T{
Replication History
T}
_
T{
session_id
T}	T{
Session ID for this replication operation
T}
_
T{
recorded_seq
T}	T{
Last recorded sequence number
T}
_
T{
docs_read
T}	T{
Number of documents read
T}
_
T{
docs_written
T}	T{
Number of documents written to target
T}
_
T{
doc_write_failures
T}	T{
Number of document write failures
T}
_
T{
start_time
T}	T{
Date/Time replication operation started
T}
_
T{
start_last_seq
T}	T{
First sequence number in changes stream
T}
_
T{
end_time
T}	T{
Date/Time replication operation completed
T}
_
T{
end_last_seq
T}	T{
Last sequence number in changes stream
T}
_
T{
missing_checked
T}	T{
Number of missing documents checked
T}
_
T{
missing_found
T}	T{
Number of missing documents found
T}
_
T{
bulk_get_attempts
T}	T{
Number of attempted _bulk_get fetches
T}
_
T{
bulk_get_docs
T}	T{
Number of documents read with _bulk_get
T}
_
.TE
.SS Request object
.TS
center;
|l|l|.
_
T{
Field
T}	T{
Description
T}
_
T{
body
T}	T{
Request body data as \fIstring\fP\&.
If the request method is \fIGET\fP this field
contains the value \fB\(dqundefined\(dq\fP\&. If the
method is \fIDELETE\fP or \fIHEAD\fP the value is
\fB\(dq\(dq\fP (empty string).
T}
_
T{
cookie
T}	T{
Cookies \fIobject\fP\&.
T}
_
T{
form
T}	T{
Form data \fIobject\fP\&.
Contains the decoded body as key\-value
pairs if the \fIContent\-Type\fP header was
\fBapplication/x\-www\-form\-urlencoded\fP\&.
T}
_
T{
headers
T}	T{
Request headers \fIobject\fP\&.
T}
_
T{
id
T}	T{
Requested document id \fIstring\fP if it was
specified or \fBnull\fP otherwise.
T}
_
T{
info
T}	T{
\fI\%Database information\fP
T}
_
T{
method
T}	T{
Request method as \fIstring\fP or \fIarray\fP\&.
String value is a method as one of: \fIHEAD\fP,
\fIGET\fP, \fIPOST\fP, \fIPUT\fP, \fIDELETE\fP, \fIOPTIONS\fP,
and \fITRACE\fP\&. Otherwise it will be
represented as an array of char codes.
T}
_
T{
path
T}	T{
List of requested path sections.
T}
_
T{
peer
T}	T{
Request source IP address.
T}
_
T{
query
T}	T{
URL query parameters \fIobject\fP\&.
Note that multiple keys are not supported
and the last key value suppresses others.
T}
_
T{
requested_path
T}	T{
List of actual requested path section.
T}
_
T{
raw_path
T}	T{
Raw requested path \fIstring\fP\&.
T}
_
T{
secObj
T}	T{
\fI\%Security Object\fP\&.
T}
_
T{
userCtx
T}	T{
\fI\%User Context Object\fP\&.
T}
_
T{
uuid
T}	T{
Generated UUID by a specified algorithm in
the config file.
T}
_
.TE
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqbody\(dq: \(dqundefined\(dq,
    \(dqcookie\(dq: {
        \(dqAuthSession\(dq: \(dqcm9vdDo1MDZBRjQzRjrfcuikzPRfAn\-EA37FmjyfM8G8Lw\(dq,
        \(dqm\(dq: \(dq3234\(dq
    },
    \(dqform\(dq: {},
    \(dqheaders\(dq: {
        \(dqAccept\(dq: \(dqtext/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\(dq,
        \(dqAccept\-Charset\(dq: \(dqISO\-8859\-1,utf\-8;q=0.7,*;q=0.3\(dq,
        \(dqAccept\-Encoding\(dq: \(dqgzip,deflate,sdch\(dq,
        \(dqAccept\-Language\(dq: \(dqen\-US,en;q=0.8\(dq,
        \(dqConnection\(dq: \(dqkeep\-alive\(dq,
        \(dqCookie\(dq: \(dqm=3234:t|3247:t|6493:t|6967:t|34e2:|18c3:t|2c69:t|5acb:t|ca3:t|c01:t|5e55:t|77cb:t|2a03:t|1d98:t|47ba:t|64b8:t|4a01:t; AuthSession=cm9vdDo1MDZBRjQzRjrfcuikzPRfAn\-EA37FmjyfM8G8Lw\(dq,
        \(dqHost\(dq: \(dq127.0.0.1:5984\(dq,
        \(dqUser\-Agent\(dq: \(dqMozilla/5.0 (Windows NT 5.2) AppleWebKit/535.7 (KHTML, like Gecko) Chrome/16.0.912.75 Safari/535.7\(dq
    },
    \(dqid\(dq: \(dqfoo\(dq,
    \(dqinfo\(dq: {
        \(dqcommitted_update_seq\(dq: 2701412,
        \(dqcompact_running\(dq: false,
        \(dqdb_name\(dq: \(dqmailbox\(dq,
        \(dqdisk_format_version\(dq: 6,
        \(dqdoc_count\(dq: 2262757,
        \(dqdoc_del_count\(dq: 560,
        \(dqinstance_start_time\(dq: \(dq1347601025628957\(dq,
        \(dqpurge_seq\(dq: 0,
        \(dqsizes\(dq: {
          \(dqactive\(dq: 7580843252,
          \(dqdisk\(dq: 14325313673,
          \(dqexternal\(dq: 7803423459
        },
        \(dqupdate_seq\(dq: 2701412
    },
    \(dqmethod\(dq: \(dqGET\(dq,
    \(dqpath\(dq: [
        \(dqmailbox\(dq,
        \(dq_design\(dq,
        \(dqrequest\(dq,
        \(dq_show\(dq,
        \(dqdump\(dq,
        \(dqfoo\(dq
    ],
    \(dqpeer\(dq: \(dq127.0.0.1\(dq,
    \(dqquery\(dq: {},
    \(dqraw_path\(dq: \(dq/mailbox/_design/request/_show/dump/foo\(dq,
    \(dqrequested_path\(dq: [
        \(dqmailbox\(dq,
        \(dq_design\(dq,
        \(dqrequest\(dq,
        \(dq_show\(dq,
        \(dqdump\(dq,
        \(dqfoo\(dq
    ],
    \(dqsecObj\(dq: {
        \(dqadmins\(dq: {
            \(dqnames\(dq: [
                \(dqBob\(dq
            ],
            \(dqroles\(dq: []
        },
        \(dqmembers\(dq: {
            \(dqnames\(dq: [
                \(dqMike\(dq,
                \(dqAlice\(dq
            ],
            \(dqroles\(dq: []
        }
    },
    \(dquserCtx\(dq: {
        \(dqdb\(dq: \(dqmailbox\(dq,
        \(dqname\(dq: \(dqMike\(dq,
        \(dqroles\(dq: [
            \(dquser\(dq
        ]
    },
    \(dquuid\(dq: \(dq3184f9d1ea934e1f81a24c71bde5c168\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Request2 object
.TS
center;
|l|l|.
_
T{
Field
T}	T{
Description
T}
_
T{
body
T}	T{
Request body data as \fIstring\fP\&.
If the request method is \fIGET\fP this field
contains the value \fB\(dqundefined\(dq\fP\&. If the
method is \fIDELETE\fP or \fIHEAD\fP the value is
\fB\(dq\(dq\fP (empty string).
T}
_
T{
cookie
T}	T{
Cookies \fIobject\fP\&.
T}
_
T{
headers
T}	T{
Request headers \fIobject\fP\&.
T}
_
T{
method
T}	T{
Request method as \fIstring\fP or \fIarray\fP\&.
String value is a method as one of: \fIHEAD\fP,
\fIGET\fP, \fIPOST\fP, \fIPUT\fP, \fIDELETE\fP, \fIOPTIONS\fP,
and \fITRACE\fP\&. Otherwise it will be
represented as an array of char codes.
T}
_
T{
path
T}	T{
List of requested path sections.
T}
_
T{
peer
T}	T{
Request source IP address.
T}
_
T{
query
T}	T{
URL query parameters \fIobject\fP\&.
Note that multiple keys are not supported
and the last key value suppresses others.
T}
_
T{
requested_path
T}	T{
List of actual requested path section.
T}
_
T{
raw_path
T}	T{
Raw requested path \fIstring\fP\&.
T}
_
T{
secObj
T}	T{
\fI\%Security Object\fP\&.
T}
_
T{
userCtx
T}	T{
\fI\%User Context Object\fP\&.
T}
_
.TE
.SS Response object
.TS
center;
|l|l|.
_
T{
Field
T}	T{
Description
T}
_
T{
code
T}	T{
HTTP status code \fInumber\fP\&.
T}
_
T{
json
T}	T{
JSON encodable \fIobject\fP\&.
Implicitly sets \fIContent\-Type\fP header as
\fBapplication/json\fP\&.
T}
_
T{
body
T}	T{
Raw response text \fIstring\fP\&.
Implicitly sets \fIContent\-Type\fP header as
\fBtext/html; charset=utf\-8\fP\&.
T}
_
T{
base64
T}	T{
Base64 encoded \fIstring\fP\&.
Implicitly sets \fIContent\-Type\fP header as
\fBapplication/binary\fP\&.
T}
_
T{
headers
T}	T{
Response headers \fIobject\fP\&.
\fIContent\-Type\fP header from this object
overrides any implicitly assigned one.
T}
_
T{
stop
T}	T{
\fIboolean\fP signal to stop iteration over
view result rows (for list functions only)
T}
_
.TE
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
The \fBbody\fP, \fBbase64\fP and \fBjson\fP object keys are overlapping each other
where the last one wins. Since most realizations of key\-value objects do
not preserve the key order or if they are mixed, confusing situations can
occur. Try to use only one of them.
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Any custom property makes CouchDB raise an internal exception. Furthermore,
the \fIResponse object\fP could be a simple string value which would be
implicitly wrapped into a \fB{\(dqbody\(dq: ...}\fP object.
.UNINDENT
.UNINDENT
.SS Returned CouchDB Document with Detailed Revision Info
.TS
center;
|l|l|.
_
T{
Field
T}	T{
Description
T}
_
T{
_id (optional)
T}	T{
Document ID
T}
_
T{
_rev (optional)
T}	T{
Revision ID (when updating an existing
document)
T}
_
T{
_revs_info [array]
T}	T{
CouchDB document extended revision info
T}
_
T{
rev
T}	T{
Full revision string
T}
_
T{
status
T}	T{
Status of the revision
T}
_
.TE
.SS Returned CouchDB Document with Revision Info
.TS
center;
|l|l|.
_
T{
Field
T}	T{
Description
T}
_
T{
_id (optional)
T}	T{
Document ID
T}
_
T{
_rev (optional)
T}	T{
Revision ID (when updating an existing
document)
T}
_
T{
_revisions
T}	T{
CouchDB document revisions
T}
_
T{
ids [array]
T}	T{
Array of valid revision IDs, in reverse
order (latest first)
T}
_
T{
start
T}	T{
Prefix number for the latest revision
T}
_
.TE
.SS Returned Document with Attachments
.TS
center;
|l|l|.
_
T{
Field
T}	T{
Description
T}
_
T{
_id (optional)
T}	T{
Document ID
T}
_
T{
_rev (optional)
T}	T{
Revision ID (when updating an existing
document)
T}
_
T{
_attachments (optional)
T}	T{
Document attachment
T}
_
T{
filename
T}	T{
Attachment
T}
_
T{
stub
T}	T{
Indicates whether the attachment is a stub
T}
_
T{
content_type
T}	T{
MIME Content type string
T}
_
T{
length
T}	T{
Length (bytes) of the attachment data
T}
_
T{
revpos
T}	T{
Revision where this attachment exists
T}
_
.TE
.SS Security Object
.TS
center;
|l|l|.
_
T{
Field
T}	T{
Description
T}
_
T{
admins
T}	T{
Roles/Users with admin privileges
T}
_
T{
roles [array]
T}	T{
List of roles with parent privilege
T}
_
T{
names [array]
T}	T{
List of users with parent privilege
T}
_
T{
members
T}	T{
Roles/Users with non\-admin privileges
T}
_
T{
roles [array]
T}	T{
List of roles with parent privilege
T}
_
T{
names [array]
T}	T{
List of users with parent privilege
T}
_
.TE
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqadmins\(dq: {
        \(dqnames\(dq: [
            \(dqBob\(dq
        ],
        \(dqroles\(dq: []
    },
    \(dqmembers\(dq: {
        \(dqnames\(dq: [
            \(dqMike\(dq,
            \(dqAlice\(dq
        ],
        \(dqroles\(dq: []
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS User Context Object
.TS
center;
|l|l|.
_
T{
Field
T}	T{
Description
T}
_
T{
db
T}	T{
Database name in the context of the
provided operation.
T}
_
T{
name
T}	T{
User name.
T}
_
T{
roles
T}	T{
List of user roles.
T}
_
.TE
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqdb\(dq: \(dqmailbox\(dq,
    \(dqname\(dq: null,
    \(dqroles\(dq: [
        \(dq_admin\(dq
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS View Head Information
.TS
center;
|l|l|.
_
T{
Field
T}	T{
Description
T}
_
T{
total_rows
T}	T{
Number of documents in the view
T}
_
T{
offset
T}	T{
Offset where the document list started
T}
_
.TE
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqtotal_rows\(dq: 42,
    \(dqoffset\(dq: 3
}
.ft P
.fi
.UNINDENT
.UNINDENT
.SH QUERY SERVER
.sp
The \fIQuery server\fP is an external process that communicates with CouchDB by JSON
protocol through stdio interface and processes all
\fI\%design functions\fP calls, such as JavaScript \fI\%views\fP\&.
.sp
The default query server is written in
\fI\%JavaScript\fP, running via \fI\%Mozilla SpiderMonkey\fP\&.
You can use \fI\%other languages\fP by setting a Query
server key in the \fBlanguage\fP property of a design document or the
\fIContent\-Type\fP header of a \fItemporary view\fP\&. Design documents that do not
specify a \fBlanguage\fP property are assumed to be of type \fIjavascript\fP\&.
.SS Query Server Protocol
.sp
A \fIQuery Server\fP is an external process that communicates with CouchDB via a
simple, custom JSON protocol over stdin/stdout. It is used to processes all
design functions calls: \fIviews\fP, \fIshows\fP, \fIlists\fP, \fIfilters\fP, \fIupdates\fP and
\fIvalidate_doc_update\fP\&.
.sp
CouchDB communicates with the Query Server process through stdin/stdout with
JSON messages that are terminated by a newline character. Messages that are
sent to the Query Server are always \fIarray\fP\-typed and follow the pattern
\fB[<command>, <*arguments>]\en\fP\&.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
In the documentation examples, we omit the trailing \fB\en\fP for greater
readability. Also, examples contain formatted JSON values while real data
is transferred in compact mode without formatting spaces.
.UNINDENT
.UNINDENT
.SS \fBreset\fP
.INDENT 0.0
.TP
.B Command
\fBreset\fP
.TP
.B Arguments
\fI\%Query server state\fP (optional)
.TP
.B Returns
\fBtrue\fP
.UNINDENT
.sp
This resets the state of the Query Server and makes it forget all previous
input. If applicable, this is the point to run garbage collection.
.sp
CouchDB sends:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[\(dqreset\(dq]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The Query Server answers:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
true
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
To set up new Query Server state, the second argument is used with object data.
.sp
CouchDB sends:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[\(dqreset\(dq, {\(dqreduce_limit\(dq: true, \(dqtimeout\(dq: 5000}]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The Query Server answers:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
true
.ft P
.fi
.UNINDENT
.UNINDENT
.SS \fBadd_lib\fP
.INDENT 0.0
.TP
.B Command
\fBadd_lib\fP
.TP
.B Arguments
CommonJS library object by \fBviews/lib\fP path
.TP
.B Returns
\fBtrue\fP
.UNINDENT
.sp
Adds \fI\%CommonJS\fP library to Query Server state for further usage
in \fImap\fP functions.
.sp
CouchDB sends:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    \(dqadd_lib\(dq,
    {
        \(dqutils\(dq: \(dqexports.MAGIC = 42;\(dq
    }
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The Query Server answers:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
true
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
This library shouldn’t have any side effects nor track its own state
or you’ll have a lot of happy debugging time if something goes wrong.
Remember that a complete index rebuild is a heavy operation and this is
the only way to fix mistakes with shared state.
.UNINDENT
.UNINDENT
.SS \fBadd_fun\fP
.INDENT 0.0
.TP
.B Command
\fBadd_fun\fP
.TP
.B Arguments
Map function source code.
.TP
.B Returns
\fBtrue\fP
.UNINDENT
.sp
When creating or updating a view, this is how the Query Server is sent the
view function for evaluation. The Query Server should parse, compile, and
evaluate the function it receives to make it callable later. If this fails, the
Query Server returns an error. CouchDB may store multiple functions before
sending any documents.
.sp
CouchDB sends:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    \(dqadd_fun\(dq,
    \(dqfunction(doc) { if(doc.score > 50) emit(null, {\(aqplayer_name\(aq: doc.name}); }\(dq
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The Query Server answers:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
true
.ft P
.fi
.UNINDENT
.UNINDENT
.SS \fBmap_doc\fP
.INDENT 0.0
.TP
.B Command
\fBmap_doc\fP
.TP
.B Arguments
Document object
.TP
.B Returns
Array of key\-value pairs per applied \fI\%function\fP
.UNINDENT
.sp
When the view function is stored in the Query Server, CouchDB starts sending
all the documents in the database, one at a time. The Query Server calls the
previously stored functions one after another with a document and stores its
result. When all functions have been called, the result is returned as a JSON
string.
.sp
CouchDB sends:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    \(dqmap_doc\(dq,
    {
        \(dq_id\(dq: \(dq8877AFF9789988EE\(dq,
        \(dq_rev\(dq: \(dq3\-235256484\(dq,
        \(dqname\(dq: \(dqJohn Smith\(dq,
        \(dqscore\(dq: 60
    }
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If the function above is the only function stored, the Query Server answers:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    [
        [null, {\(dqplayer_name\(dq: \(dqJohn Smith\(dq}]
    ]
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
That is, an array with the result for every function for the given document.
.sp
If a document is to be excluded from the view, the array should be empty.
.sp
CouchDB sends:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    \(dqmap_doc\(dq,
    {
        \(dq_id\(dq: \(dq9590AEB4585637FE\(dq,
        \(dq_rev\(dq: \(dq1\-674684684\(dq,
        \(dqname\(dq: \(dqJane Parker\(dq,
        \(dqscore\(dq: 43
    }
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The Query Server answers:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[[]]
.ft P
.fi
.UNINDENT
.UNINDENT
.SS \fBreduce\fP
.INDENT 0.0
.TP
.B Command
\fBreduce\fP
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
Reduce function source
.IP \(bu 2
Array of \fI\%map function\fP results where each item represented
in format \fB[[key, id\-of\-doc], value]\fP
.UNINDENT
.TP
.B Returns
Array with pair values: \fBtrue\fP and another array with reduced result
.UNINDENT
.sp
If the view has a reduce function defined, CouchDB will enter into the reduce
phase. The Query Server will receive a list of reduce functions and some map
results on which it can apply them.
.sp
CouchDB sends:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    \(dqreduce\(dq,
    [
        \(dqfunction(k, v) { return sum(v); }\(dq
    ],
    [
        [[1, \(dq699b524273605d5d3e9d4fd0ff2cb272\(dq], 10],
        [[2, \(dqc081d0f69c13d2ce2050d684c7ba2843\(dq], 20],
        [[null, \(dqfoobar\(dq], 3]
    ]
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The Query Server answers:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    true,
    [33]
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Note that even though the view server receives the map results in the form
\fB[[key, id\-of\-doc], value]\fP, the function may receive them in a different
form. For example, the JavaScript Query Server applies functions on the list of
keys and the list of values.
.SS \fBrereduce\fP
.INDENT 0.0
.TP
.B Command
\fBrereduce\fP
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
Reduce function source
.IP \(bu 2
List of values
.UNINDENT
.UNINDENT
.sp
When building a view, CouchDB will apply the reduce step directly to the output
of the map step and the rereduce step to the output of a previous reduce step.
.sp
CouchDB will send a list of reduce functions and a list of values, with no keys
or document ids to the rereduce step.
.sp
CouchDB sends:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    \(dqrereduce\(dq,
    [
        \(dqfunction(k, v, r) { return sum(v); }\(dq
    ],
    [
        33,
        55,
        66
    ]
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The Query Server answers:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    true,
    [154]
]
.ft P
.fi
.UNINDENT
.UNINDENT
.SS \fBddoc\fP
.INDENT 0.0
.TP
.B Command
\fBddoc\fP
.TP
.B Arguments
Array of objects.
.INDENT 7.0
.IP \(bu 2
First phase (ddoc initialization):
.INDENT 2.0
.IP \(bu 2
\fB\(dqnew\(dq\fP
.IP \(bu 2
Design document \fB_id\fP
.IP \(bu 2
Design document object
.UNINDENT
.IP \(bu 2
Second phase (design function execution):
.INDENT 2.0
.IP \(bu 2
Design document \fB_id\fP
.IP \(bu 2
Function path as an array of object keys
.IP \(bu 2
Array of function arguments
.UNINDENT
.UNINDENT
.TP
.B Returns
.INDENT 7.0
.IP \(bu 2
First phase (ddoc initialization): \fBtrue\fP
.IP \(bu 2
Second phase (design function execution): custom object depending on
executed function
.UNINDENT
.UNINDENT
.sp
This command acts in two phases: \fIddoc\fP registration and \fIdesign function\fP
execution.
.sp
In the first phase CouchDB sends a full design document content to the Query
Server to let it cache it by \fB_id\fP value for further function execution.
.sp
To do this, CouchDB sends:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    \(dqddoc\(dq,
    \(dqnew\(dq,
    \(dq_design/temp\(dq,
    {
        \(dq_id\(dq: \(dq_design/temp\(dq,
        \(dq_rev\(dq: \(dq8\-d7379de23a751dc2a19e5638a7bbc5cc\(dq,
        \(dqlanguage\(dq: \(dqjavascript\(dq,
        \(dqshows\(dq: {
            \(dqrequest\(dq: \(dqfunction(doc,req){ return {json: req}; }\(dq,
            \(dqhello\(dq: \(dqfunction(doc,req){ return {body: \(aqHello, \(aq + (doc || {})._id + \(aq!\(aq}; }\(dq
        }
    }
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The Query Server answers:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
true
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
After this, the design document will be ready to serve subcommands in the
second phase.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Each \fBddoc\fP subcommand is the root design document key, so they are not
actually subcommands, but first elements of the JSON path that may be handled
and processed.
.sp
The pattern for subcommand execution is common:
.sp
\fB[\(dqddoc\(dq, <design_doc_id>, [<subcommand>, <funcname>], [<argument1>, <argument2>, ...]]\fP
.UNINDENT
.UNINDENT
.SS \fBshows\fP
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
Show functions are deprecated in CouchDB 3.0, and will be removed in CouchDB 4.0.
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B Command
\fBddoc\fP
.TP
.B SubCommand
\fBshows\fP
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
Document object or \fBnull\fP if document \fIid\fP isn’t specified in request
.IP \(bu 2
\fI\%Request object\fP
.UNINDENT
.TP
.B Returns
Array with two elements:
.INDENT 7.0
.IP \(bu 2
\fB\(dqresp\(dq\fP
.IP \(bu 2
\fI\%Response object\fP
.UNINDENT
.UNINDENT
.sp
Executes \fI\%show function\fP\&.
.sp
Couchdb sends:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    \(dqddoc\(dq,
    \(dq_design/temp\(dq,
    [
        \(dqshows\(dq,
        \(dqdoc\(dq
    ],
    [
        null,
        {
            \(dqinfo\(dq: {
                \(dqdb_name\(dq: \(dqtest\(dq,
                \(dqdoc_count\(dq: 8,
                \(dqdoc_del_count\(dq: 0,
                \(dqupdate_seq\(dq: 105,
                \(dqpurge_seq\(dq: 0,
                \(dqcompact_running\(dq: false,
                \(dqsizes\(dq: {
                  \(dqactive\(dq: 1535048,
                  \(dqdisk\(dq: 15818856,
                  \(dqexternal\(dq: 15515850
                },
                \(dqinstance_start_time\(dq: \(dq1359952188595857\(dq,
                \(dqdisk_format_version\(dq: 6,
                \(dqcommitted_update_seq\(dq: 105
            },
            \(dqid\(dq: null,
            \(dquuid\(dq: \(dq169cb4cc82427cc7322cb4463d0021bb\(dq,
            \(dqmethod\(dq: \(dqGET\(dq,
            \(dqrequested_path\(dq: [
                \(dqapi\(dq,
                \(dq_design\(dq,
                \(dqtemp\(dq,
                \(dq_show\(dq,
                \(dqrequest\(dq
            ],
            \(dqpath\(dq: [
                \(dqapi\(dq,
                \(dq_design\(dq,
                \(dqtemp\(dq,
                \(dq_show\(dq,
                \(dqrequest\(dq
            ],
            \(dqraw_path\(dq: \(dq/api/_design/temp/_show/request\(dq,
            \(dqquery\(dq: {},
            \(dqheaders\(dq: {
                \(dqAccept\(dq: \(dq*/*\(dq,
                \(dqHost\(dq: \(dqlocalhost:5984\(dq,
                \(dqUser\-Agent\(dq: \(dqcurl/7.26.0\(dq
            },
            \(dqbody\(dq: \(dqundefined\(dq,
            \(dqpeer\(dq: \(dq127.0.0.1\(dq,
            \(dqform\(dq: {},
            \(dqcookie\(dq: {},
            \(dquserCtx\(dq: {
                \(dqdb\(dq: \(dqapi\(dq,
                \(dqname\(dq: null,
                \(dqroles\(dq: [
                    \(dq_admin\(dq
                ]
            },
            \(dqsecObj\(dq: {}
        }
    ]
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The Query Server sends:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    \(dqresp\(dq,
    {
        \(dqbody\(dq: \(dqHello, undefined!\(dq
    }
]
.ft P
.fi
.UNINDENT
.UNINDENT
.SS \fBlists\fP
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
List functions are deprecated in CouchDB 3.0, and will be removed in CouchDB 4.0.
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B Command
\fBddoc\fP
.TP
.B SubCommand
\fBlists\fP
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
\fI\%View Head Information\fP:
.IP \(bu 2
\fI\%Request object\fP
.UNINDENT
.TP
.B Returns
Array. See below for details.
.UNINDENT
.sp
Executes \fI\%list function\fP\&.
.sp
The communication protocol for \fIlist\fP functions is a bit complex so let’s use
an example to illustrate.
.sp
Assume we have view a function that emits \fIid\-rev\fP pairs:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    emit(doc._id, doc._rev);
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
And we’d like to emulate \fB_all_docs\fP JSON response with list function. Our
\fIfirst\fP version of the list functions looks like this:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(head, req){
    start({\(aqheaders\(aq: {\(aqContent\-Type\(aq: \(aqapplication/json\(aq}});
    var resp = head;
    var rows = [];
    while(row=getRow()){
        rows.push(row);
    }
    resp.rows = rows;
    return toJSON(resp);
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The whole communication session during list function execution could be divided
on three parts:
.INDENT 0.0
.IP 1. 3
Initialization
.sp
The first returned object from the list function is an array with the
following structure:
.INDENT 3.0
.INDENT 3.5
.sp
.nf
.ft C
[\(dqstart\(dq, <chunks>, <headers>]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Where \fB<chunks>\fP is an array of text chunks that will be sent to the client
and \fB<headers>\fP is an object with response HTTP headers.
.sp
This message is sent from the Query Server to CouchDB on the
\fI\%start()\fP call which initializes the HTTP response to the client:
.INDENT 3.0
.INDENT 3.5
.sp
.nf
.ft C
[
    \(dqstart\(dq,
    [],
    {
        \(dqheaders\(dq: {
            \(dqContent\-Type\(dq: \(dqapplication/json\(dq
        }
    }
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
After this, the list function may start to process view rows.
.IP 2. 3
View Processing
.sp
Since view results can be extremely large, it is not wise to pass all its
rows in a single command. Instead, CouchDB can send view rows one by one
to the Query Server allowing view processing and output generation to be
processed as a stream.
.sp
CouchDB sends a special array that carries view row data:
.INDENT 3.0
.INDENT 3.5
.sp
.nf
.ft C
[
    \(dqlist_row\(dq,
    {
        \(dqid\(dq: \(dq0cb42c267fe32d4b56b3500bc503e030\(dq,
        \(dqkey\(dq: \(dq0cb42c267fe32d4b56b3500bc503e030\(dq,
        \(dqvalue\(dq: \(dq1\-967a00dff5e02add41819138abb3284d\(dq
    }
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If the Query Server has something to return on this, it returns an array
with a \fB\(dqchunks\(dq\fP item in the head and an array of data in the tail. For
this example it has nothing to return, so the response will be:
.INDENT 3.0
.INDENT 3.5
.sp
.nf
.ft C
[
  \(dqchunks\(dq,
  []
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
When there are no more view rows to process, CouchDB sends a \fIlist_end\fP
message to signify there is no more data to send:
.INDENT 3.0
.INDENT 3.5
.sp
.nf
.ft C
[\(dqlist_end\(dq]
.ft P
.fi
.UNINDENT
.UNINDENT
.IP 3. 3
Finalization
.sp
The last stage of the communication process is the returning \fIlist tail\fP:
the last data chunk. After this, processing of the list function will be
complete and the client will receive a complete response.
.sp
For our example the last message is:
.INDENT 3.0
.INDENT 3.5
.sp
.nf
.ft C
[
    \(dqend\(dq,
    [
        \(dq{\e\(dqtotal_rows\e\(dq:2,\e\(dqoffset\e\(dq:0,\e\(dqrows\e\(dq:[{\e\(dqid\e\(dq:\e\(dq0cb42c267fe32d4b56b3500bc503e030\e\(dq,\e\(dqkey\e\(dq:\e\(dq0cb42c267fe32d4b56b3500bc503e030\e\(dq,\e\(dqvalue\e\(dq:\e\(dq1\-967a00dff5e02add41819138abb3284d\e\(dq},{\e\(dqid\e\(dq:\e\(dq431926a69504bde41851eb3c18a27b1f\e\(dq,\e\(dqkey\e\(dq:\e\(dq431926a69504bde41851eb3c18a27b1f\e\(dq,\e\(dqvalue\e\(dq:\e\(dq1\-967a00dff5e02add41819138abb3284d\e\(dq}]}\(dq
    ]
]
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.sp
In this example, we have returned our result in a single message from the Query
Server. This is okay for small numbers of rows, but for large data sets,
perhaps with millions of documents or millions of view rows, this would not be
acceptable.
.sp
Let’s fix our list function and see the changes in communication:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(head, req){
    start({\(aqheaders\(aq: {\(aqContent\-Type\(aq: \(aqapplication/json\(aq}});
    send(\(aq{\(aq);
    send(\(aq\(dqtotal_rows\(dq:\(aq + toJSON(head.total_rows) + \(aq,\(aq);
    send(\(aq\(dqoffset\(dq:\(aq + toJSON(head.offset) + \(aq,\(aq);
    send(\(aq\(dqrows\(dq:[\(aq);
    if (row=getRow()){
        send(toJSON(row));
    }
    while(row=getRow()){
        send(\(aq,\(aq + toJSON(row));
    }
    send(\(aq]\(aq);
    return \(aq}\(aq;
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
“Wait, what?” \- you’d like to ask. Yes, we’d build JSON response manually by
string chunks, but let’s take a look on logs:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[Wed, 24 Jul 2013 05:45:30 GMT] [debug] [<0.19191.1>] OS Process #Port<0.4444> Output :: [\(dqstart\(dq,[\(dq{\(dq,\(dq\e\(dqtotal_rows\e\(dq:2,\(dq,\(dq\e\(dqoffset\e\(dq:0,\(dq,\(dq\e\(dqrows\e\(dq:[\(dq],{\(dqheaders\(dq:{\(dqContent\-Type\(dq:\(dqapplication/json\(dq}}]
[Wed, 24 Jul 2013 05:45:30 GMT] [info] [<0.18963.1>] 127.0.0.1 \- \- GET /blog/_design/post/_list/index/all_docs 200
[Wed, 24 Jul 2013 05:45:30 GMT] [debug] [<0.19191.1>] OS Process #Port<0.4444> Input  :: [\(dqlist_row\(dq,{\(dqid\(dq:\(dq0cb42c267fe32d4b56b3500bc503e030\(dq,\(dqkey\(dq:\(dq0cb42c267fe32d4b56b3500bc503e030\(dq,\(dqvalue\(dq:\(dq1\-967a00dff5e02add41819138abb3284d\(dq}]
[Wed, 24 Jul 2013 05:45:30 GMT] [debug] [<0.19191.1>] OS Process #Port<0.4444> Output :: [\(dqchunks\(dq,[\(dq{\e\(dqid\e\(dq:\e\(dq0cb42c267fe32d4b56b3500bc503e030\e\(dq,\e\(dqkey\e\(dq:\e\(dq0cb42c267fe32d4b56b3500bc503e030\e\(dq,\e\(dqvalue\e\(dq:\e\(dq1\-967a00dff5e02add41819138abb3284d\e\(dq}\(dq]]
[Wed, 24 Jul 2013 05:45:30 GMT] [debug] [<0.19191.1>] OS Process #Port<0.4444> Input  :: [\(dqlist_row\(dq,{\(dqid\(dq:\(dq431926a69504bde41851eb3c18a27b1f\(dq,\(dqkey\(dq:\(dq431926a69504bde41851eb3c18a27b1f\(dq,\(dqvalue\(dq:\(dq1\-967a00dff5e02add41819138abb3284d\(dq}]
[Wed, 24 Jul 2013 05:45:30 GMT] [debug] [<0.19191.1>] OS Process #Port<0.4444> Output :: [\(dqchunks\(dq,[\(dq,{\e\(dqid\e\(dq:\e\(dq431926a69504bde41851eb3c18a27b1f\e\(dq,\e\(dqkey\e\(dq:\e\(dq431926a69504bde41851eb3c18a27b1f\e\(dq,\e\(dqvalue\e\(dq:\e\(dq1\-967a00dff5e02add41819138abb3284d\e\(dq}\(dq]]
[Wed, 24 Jul 2013 05:45:30 GMT] [debug] [<0.19191.1>] OS Process #Port<0.4444> Input  :: [\(dqlist_end\(dq]
[Wed, 24 Jul 2013 05:45:30 GMT] [debug] [<0.19191.1>] OS Process #Port<0.4444> Output :: [\(dqend\(dq,[\(dq]\(dq,\(dq}\(dq]]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Note, that now the Query Server sends response by lightweight chunks and if
our communication process was extremely slow, the client will see how response
data appears on their screen. Chunk by chunk, without waiting for the complete
result, like they have for our previous list function.
.SS \fBupdates\fP
.INDENT 0.0
.TP
.B Command
\fBddoc\fP
.TP
.B SubCommand
\fBupdates\fP
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
Document object or \fBnull\fP if document \fIid\fP wasn’t specified in request
.IP \(bu 2
\fI\%Request object\fP
.UNINDENT
.TP
.B Returns
Array with there elements:
.INDENT 7.0
.IP \(bu 2
\fB\(dqup\(dq\fP
.IP \(bu 2
Document object or \fBnull\fP if nothing should be stored
.IP \(bu 2
\fI\%Response object\fP
.UNINDENT
.UNINDENT
.sp
Executes \fI\%update function\fP\&.
.sp
CouchDB sends:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    \(dqddoc\(dq,
    \(dq_design/id\(dq,
    [
        \(dqupdates\(dq,
        \(dqnothing\(dq
    ],
    [
        null,
        {
            \(dqinfo\(dq: {
                \(dqdb_name\(dq: \(dqtest\(dq,
                \(dqdoc_count\(dq: 5,
                \(dqdoc_del_count\(dq: 0,
                \(dqupdate_seq\(dq: 16,
                \(dqpurge_seq\(dq: 0,
                \(dqcompact_running\(dq: false,
                \(dqsizes\(dq: {
                  \(dqactive\(dq: 7979745,
                  \(dqdisk\(dq: 8056936,
                  \(dqexternal\(dq: 8024930
                },
                \(dqinstance_start_time\(dq: \(dq1374612186131612\(dq,
                \(dqdisk_format_version\(dq: 6,
                \(dqcommitted_update_seq\(dq: 16
            },
            \(dqid\(dq: null,
            \(dquuid\(dq: \(dq7b695cb34a03df0316c15ab529002e69\(dq,
            \(dqmethod\(dq: \(dqPOST\(dq,
            \(dqrequested_path\(dq: [
                \(dqtest\(dq,
                \(dq_design\(dq,
                \(dq1139\(dq,
                \(dq_update\(dq,
                \(dqnothing\(dq
            ],
            \(dqpath\(dq: [
                \(dqtest\(dq,
                \(dq_design\(dq,
                \(dq1139\(dq,
                \(dq_update\(dq,
                \(dqnothing\(dq
            ],
            \(dqraw_path\(dq: \(dq/test/_design/1139/_update/nothing\(dq,
            \(dqquery\(dq: {},
            \(dqheaders\(dq: {
                \(dqAccept\(dq: \(dq*/*\(dq,
                \(dqAccept\-Encoding\(dq: \(dqidentity, gzip, deflate, compress\(dq,
                \(dqContent\-Length\(dq: \(dq0\(dq,
                \(dqHost\(dq: \(dqlocalhost:5984\(dq
            },
            \(dqbody\(dq: \(dq\(dq,
            \(dqpeer\(dq: \(dq127.0.0.1\(dq,
            \(dqform\(dq: {},
            \(dqcookie\(dq: {},
            \(dquserCtx\(dq: {
                \(dqdb\(dq: \(dqtest\(dq,
                \(dqname\(dq: null,
                \(dqroles\(dq: [
                    \(dq_admin\(dq
                ]
            },
            \(dqsecObj\(dq: {}
        }
    ]
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The Query Server answers:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    \(dqup\(dq,
    null,
    {\(dqbody\(dq: \(dqdocument id wasn\(aqt provided\(dq}
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
or in case of successful update:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    \(dqup\(dq,
    {
        \(dq_id\(dq: \(dq7b695cb34a03df0316c15ab529002e69\(dq,
        \(dqhello\(dq: \(dqworld!\(dq
    },
    {\(dqbody\(dq: \(dqdocument was updated\(dq}
]
.ft P
.fi
.UNINDENT
.UNINDENT
.SS \fBfilters\fP
.INDENT 0.0
.TP
.B Command
\fBddoc\fP
.TP
.B SubCommand
\fBfilters\fP
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
Array of document objects
.IP \(bu 2
\fI\%Request object\fP
.UNINDENT
.TP
.B Returns
Array of two elements:
.INDENT 7.0
.IP \(bu 2
\fBtrue\fP
.IP \(bu 2
Array of booleans in the same order of input documents.
.UNINDENT
.UNINDENT
.sp
Executes \fI\%filter function\fP\&.
.sp
CouchDB sends:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    \(dqddoc\(dq,
    \(dq_design/test\(dq,
    [
        \(dqfilters\(dq,
        \(dqrandom\(dq
    ],
    [
        [
            {
                \(dq_id\(dq: \(dq431926a69504bde41851eb3c18a27b1f\(dq,
                \(dq_rev\(dq: \(dq1\-967a00dff5e02add41819138abb3284d\(dq,
                \(dq_revisions\(dq: {
                    \(dqstart\(dq: 1,
                    \(dqids\(dq: [
                        \(dq967a00dff5e02add41819138abb3284d\(dq
                    ]
                }
            },
            {
                \(dq_id\(dq: \(dq0cb42c267fe32d4b56b3500bc503e030\(dq,
                \(dq_rev\(dq: \(dq1\-967a00dff5e02add41819138abb3284d\(dq,
                \(dq_revisions\(dq: {
                    \(dqstart\(dq: 1,
                    \(dqids\(dq: [
                        \(dq967a00dff5e02add41819138abb3284d\(dq
                    ]
                }
            }
        ],
        {
            \(dqinfo\(dq: {
                \(dqdb_name\(dq: \(dqtest\(dq,
                \(dqdoc_count\(dq: 5,
                \(dqdoc_del_count\(dq: 0,
                \(dqupdate_seq\(dq: 19,
                \(dqpurge_seq\(dq: 0,
                \(dqcompact_running\(dq: false,
                \(dqsizes\(dq: {
                  \(dqactive\(dq: 7979745,
                  \(dqdisk\(dq: 8056936,
                  \(dqexternal\(dq: 8024930
                },
                \(dqinstance_start_time\(dq: \(dq1374612186131612\(dq,
                \(dqdisk_format_version\(dq: 6,
                \(dqcommitted_update_seq\(dq: 19
            },
            \(dqid\(dq: null,
            \(dquuid\(dq: \(dq7b695cb34a03df0316c15ab529023a81\(dq,
            \(dqmethod\(dq: \(dqGET\(dq,
            \(dqrequested_path\(dq: [
                \(dqtest\(dq,
                \(dq_changes?filter=test\(dq,
                \(dqrandom\(dq
            ],
            \(dqpath\(dq: [
                \(dqtest\(dq,
                \(dq_changes\(dq
            ],
            \(dqraw_path\(dq: \(dq/test/_changes?filter=test/random\(dq,
            \(dqquery\(dq: {
                \(dqfilter\(dq: \(dqtest/random\(dq
            },
            \(dqheaders\(dq: {
                \(dqAccept\(dq: \(dqapplication/json\(dq,
                \(dqAccept\-Encoding\(dq: \(dqidentity, gzip, deflate, compress\(dq,
                \(dqContent\-Length\(dq: \(dq0\(dq,
                \(dqContent\-Type\(dq: \(dqapplication/json; charset=utf\-8\(dq,
                \(dqHost\(dq: \(dqlocalhost:5984\(dq
            },
            \(dqbody\(dq: \(dq\(dq,
            \(dqpeer\(dq: \(dq127.0.0.1\(dq,
            \(dqform\(dq: {},
            \(dqcookie\(dq: {},
            \(dquserCtx\(dq: {
                \(dqdb\(dq: \(dqtest\(dq,
                \(dqname\(dq: null,
                \(dqroles\(dq: [
                    \(dq_admin\(dq
                ]
            },
            \(dqsecObj\(dq: {}
        }
    ]
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The Query Server answers:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    true,
    [
        true,
        false
    ]
]
.ft P
.fi
.UNINDENT
.UNINDENT
.SS \fBviews\fP
.INDENT 0.0
.TP
.B Command
\fBddoc\fP
.TP
.B SubCommand
\fBviews\fP
.TP
.B Arguments
Array of document objects
.TP
.B Returns
Array of two elements:
.INDENT 7.0
.IP \(bu 2
\fBtrue\fP
.IP \(bu 2
Array of booleans in the same order of input documents.
.UNINDENT
.UNINDENT
.sp
New in version 1.2.

.sp
Executes \fI\%view function\fP in place of the filter.
.sp
Acts in the same way as \fI\%filters\fP command.
.SS \fBvalidate_doc_update\fP
.INDENT 0.0
.TP
.B Command
\fBddoc\fP
.TP
.B SubCommand
\fBvalidate_doc_update\fP
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
Document object that will be stored
.IP \(bu 2
Document object that will be replaced
.IP \(bu 2
\fI\%User Context Object\fP
.IP \(bu 2
\fI\%Security Object\fP
.UNINDENT
.TP
.B Returns
\fB1\fP
.UNINDENT
.sp
Executes \fI\%validation function\fP\&.
.sp
CouchDB send:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    \(dqddoc\(dq,
    \(dq_design/id\(dq,
    [\(dqvalidate_doc_update\(dq],
    [
        {
            \(dq_id\(dq: \(dqdocid\(dq,
            \(dq_rev\(dq: \(dq2\-e0165f450f6c89dc6b071c075dde3c4d\(dq,
            \(dqscore\(dq: 10
        },
        {
            \(dq_id\(dq: \(dqdocid\(dq,
            \(dq_rev\(dq: \(dq1\-9f798c6ad72a406afdbf470b9eea8375\(dq,
            \(dqscore\(dq: 4
        },
        {
            \(dqname\(dq: \(dqMike\(dq,
            \(dqroles\(dq: [\(dqplayer\(dq]
        },
        {
            \(dqadmins\(dq: {},
            \(dqmembers\(dq: []
        }
    ]
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The Query Server answers:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
1
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
While the only valid response for this command is \fBtrue\fP, to prevent the
document from being saved, the Query Server needs to raise an error:
\fBforbidden\fP or \fBunauthorized\fP; these errors will be turned into correct
\fBHTTP 403\fP and \fBHTTP 401\fP responses respectively.
.UNINDENT
.UNINDENT
.SS \fBrewrites\fP
.INDENT 0.0
.TP
.B Command
\fBddoc\fP
.TP
.B SubCommand
\fBrewrites\fP
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
\fI\%Request2 object\fP
.UNINDENT
.TP
.B Returns
\fB1\fP
.UNINDENT
.sp
Executes \fI\%rewrite function\fP\&.
.sp
CouchDB send:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    \(dqddoc\(dq,
    \(dq_design/id\(dq,
    [\(dqrewrites\(dq],
    [
        {
            \(dqmethod\(dq: \(dqPOST\(dq,
            \(dqrequested_path\(dq: [
                \(dqtest\(dq,
                \(dq_design\(dq,
                \(dq1139\(dq,
                \(dq_update\(dq,
                \(dqnothing\(dq
            ],
            \(dqpath\(dq: [
                \(dqtest\(dq,
                \(dq_design\(dq,
                \(dq1139\(dq,
                \(dq_update\(dq,
                \(dqnothing\(dq
            ],
            \(dqraw_path\(dq: \(dq/test/_design/1139/_update/nothing\(dq,
            \(dqquery\(dq: {},
            \(dqheaders\(dq: {
                \(dqAccept\(dq: \(dq*/*\(dq,
                \(dqAccept\-Encoding\(dq: \(dqidentity, gzip, deflate, compress\(dq,
                \(dqContent\-Length\(dq: \(dq0\(dq,
                \(dqHost\(dq: \(dqlocalhost:5984\(dq
            },
            \(dqbody\(dq: \(dq\(dq,
            \(dqpeer\(dq: \(dq127.0.0.1\(dq,
            \(dqcookie\(dq: {},
            \(dquserCtx\(dq: {
                \(dqdb\(dq: \(dqtest\(dq,
                \(dqname\(dq: null,
                \(dqroles\(dq: [
                    \(dq_admin\(dq
                ]
            },
            \(dqsecObj\(dq: {}
        }
    ]
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The Query Server answers:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    \(dqok\(dq,
    {
        \(dqpath\(dq: \(dqsome/path\(dq,
        \(dqquery\(dq: {\(dqkey1\(dq: \(dqvalue1\(dq, \(dqkey2\(dq: \(dqvalue2\(dq},
        \(dqmethod\(dq: \(dqMETHOD\(dq,
        \(dqheaders\(dq: {\(dqHeader1\(dq: \(dqvalue1\(dq, \(dqHeader2\(dq: \(dqvalue2\(dq},
        \(dqbody\(dq: \(dq\(dq
    }
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
or in case of direct response:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    \(dqok\(dq,
    {
        \(dqheaders\(dq: {\(dqContent\-Type\(dq: \(dqtext/plain\(dq},
        \(dqbody\(dq: \(dqWelcome!\(dq,
        \(dqcode\(dq: 200
    }
]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
or for immediate redirect:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    \(dqok\(dq,
    {
        \(dqheaders\(dq: {\(dqLocation\(dq: \(dqhttp://example.com/path/\(dq},
        \(dqcode\(dq: 302
    }
]
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Returning errors
.sp
When something goes wrong, the Query Server can inform CouchDB by sending a
special message in response to the received command.
.sp
Error messages prevent further command execution and return an error description
to CouchDB. Errors are logically divided into two groups:
.INDENT 0.0
.IP \(bu 2
\fICommon errors\fP\&. These errors only break the current Query Server command and
return the error info to the CouchDB instance \fIwithout\fP terminating the Query
Server process.
.IP \(bu 2
\fIFatal errors\fP\&. Fatal errors signal a condition that cannot be recovered.
For instance, if your a design function is unable to import a third party
module, it’s better to count such error as fatal and terminate whole process.
.UNINDENT
.SS \fBerror\fP
.sp
To raise an error, the Query Server should respond with:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[\(dqerror\(dq, \(dqerror_name\(dq, \(dqreason why\(dq]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The \fB\(dqerror_name\(dq\fP helps to classify problems by their type e.g. if it’s
\fB\(dqvalue_error\(dq\fP to indicate improper data, \fB\(dqnot_found\(dq\fP to indicate a
missing resource and \fB\(dqtype_error\(dq\fP to indicate an improper data type.
.sp
The \fB\(dqreason why\(dq\fP explains in human\-readable terms what went wrong, and
possibly how to resolve it.
.sp
For example, calling \fI\%Update Functions\fP against a non\-existent document could
produce the error message:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[\(dqerror\(dq, \(dqnot_found\(dq, \(dqUpdate function requires existent document\(dq]
.ft P
.fi
.UNINDENT
.UNINDENT
.SS \fBforbidden\fP
.sp
The \fIforbidden\fP error is widely used by \fI\%Validate Document Update Functions\fP to stop further function
processing and prevent storage of the new document revision. Since this is not
actually an error, but an assertion against user actions, CouchDB doesn’t log
it at \fI“error”\fP level, but returns \fIHTTP 403 Forbidden\fP response with error
information object.
.sp
To raise this error, the Query Server should respond with:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqforbidden\(dq: \(dqreason why\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS \fBunauthorized\fP
.sp
The \fIunauthorized\fP error mostly acts like \fIforbidden\fP one, but with
the meaning of \fIplease authorize first\fP\&. This small difference helps end users
to understand what they can do to solve the problem. Similar to \fIforbidden\fP,
CouchDB doesn’t log it at \fI“error”\fP level, but returns a \fIHTTP 401 Unauthorized\fP
response with an error information object.
.sp
To raise this error, the Query Server should respond with:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{\(dqunauthorized\(dq: \(dqreason why\(dq}
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Logging
.sp
At any time, the Query Server may send some information that will be saved in
CouchDB’s log file. This is done by sending a special \fIlog\fP object with a single
argument, on a separate line:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[\(dqlog\(dq, \(dqsome message\(dq]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
CouchDB does not respond, but writes the received message to the log file:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[Sun, 13 Feb 2009 23:31:30 GMT] [info] [<0.72.0>] Query Server Log Message: some message
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
These messages are only logged at \fI\%info level\fP\&.
.SS JavaScript
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
While every design function has access to all JavaScript objects, the table
below describes appropriate usage cases. For example, you may use
\fI\%emit()\fP in \fI\%Map Functions\fP, but \fI\%getRow()\fP is not permitted
during \fI\%Map Functions\fP\&.
.UNINDENT
.UNINDENT
.TS
center;
|l|l|.
_
T{
JS Function
T}	T{
Reasonable to use in design doc functions
T}
_
T{
\fI\%emit()\fP
T}	T{
\fI\%Map Functions\fP
T}
_
T{
\fI\%getRow()\fP
T}	T{
\fI\%List Functions\fP
T}
_
T{
\fI\%JSON\fP
T}	T{
any
T}
_
T{
\fI\%isArray()\fP
T}	T{
any
T}
_
T{
\fI\%log()\fP
T}	T{
any
T}
_
T{
\fI\%provides()\fP
T}	T{
\fI\%Show Functions\fP, \fI\%List Functions\fP
T}
_
T{
\fI\%registerType()\fP
T}	T{
\fI\%Show Functions\fP, \fI\%List Functions\fP
T}
_
T{
\fI\%require()\fP
T}	T{
any, except \fI\%Reduce and Rereduce Functions\fP
T}
_
T{
\fI\%send()\fP
T}	T{
\fI\%List Functions\fP
T}
_
T{
\fI\%start()\fP
T}	T{
\fI\%List Functions\fP
T}
_
T{
\fI\%sum()\fP
T}	T{
any
T}
_
T{
\fI\%toJSON()\fP
T}	T{
any
T}
_
.TE
.SS Design functions context
.sp
Each design function executes in a special context of predefined objects,
modules and functions:
.INDENT 0.0
.TP
.B emit(key, value)
Emits a \fIkey\fP\-\fIvalue\fP pair for further processing by CouchDB after the map
function is done.
.INDENT 7.0
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
\fBkey\fP – The view key
.IP \(bu 2
\fBvalue\fP – The \fIkey\fP’s associated value
.UNINDENT
.UNINDENT
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc){
    emit(doc._id, doc._rev);
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B getRow()
Extracts the next row from a related view result.
.INDENT 7.0
.TP
.B Returns
View result row
.TP
.B Return type
object
.UNINDENT
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
function(head, req){
    send(\(aq[\(aq);
    row = getRow();
    if (row){
        send(toJSON(row));
        while(row = getRow()){
            send(\(aq,\(aq);
            send(toJSON(row));
        }
    }
    return \(aq]\(aq;
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B JSON
\fI\%JSON2\fP
object.
.UNINDENT
.INDENT 0.0
.TP
.B isArray(obj)
A helper function to check if the provided value is an \fIArray\fP\&.
.INDENT 7.0
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
\fBobj\fP – Any JavaScript value
.UNINDENT
.TP
.B Returns
\fBtrue\fP if \fIobj\fP is \fIArray\fP\-typed, \fBfalse\fP otherwise
.TP
.B Return type
boolean
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B log(message)
Log a message to the CouchDB log (at the \fIINFO\fP level).
.INDENT 7.0
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
\fBmessage\fP – Message to be logged
.UNINDENT
.UNINDENT
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc){
    log(\(aqProcesing doc \(aq + doc[\(aq_id\(aq]);
    emit(doc[\(aq_id\(aq], null);
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
After the map function has run, the following line can be found in CouchDB
logs (e.g. at \fI/var/log/couchdb/couch.log\fP):
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[Sat, 03 Nov 2012 17:38:02 GMT] [info] [<0.7543.0>] OS Process #Port<0.3289> Log :: Processing doc 8d300b86622d67953d102165dbe99467
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B provides(key, func)
Registers callable handler for specified MIME key.
.INDENT 7.0
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
\fBkey\fP – MIME key previously defined by \fI\%registerType()\fP
.IP \(bu 2
\fBfunc\fP – MIME type handler
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B registerType(key, *mimes)
Registers list of MIME types by associated \fIkey\fP\&.
.INDENT 7.0
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
\fBkey\fP – MIME types
.IP \(bu 2
\fBmimes\fP – MIME types enumeration
.UNINDENT
.UNINDENT
.sp
Predefined mappings (\fIkey\fP\-\fIarray\fP):
.INDENT 7.0
.IP \(bu 2
\fBall\fP: \fB*/*\fP
.IP \(bu 2
\fBtext\fP: \fBtext/plain; charset=utf\-8\fP, \fBtxt\fP
.IP \(bu 2
\fBhtml\fP: \fBtext/html; charset=utf\-8\fP
.IP \(bu 2
\fBxhtml\fP: \fBapplication/xhtml+xml\fP, \fBxhtml\fP
.IP \(bu 2
\fBxml\fP: \fBapplication/xml\fP, \fBtext/xml\fP, \fBapplication/x\-xml\fP
.IP \(bu 2
\fBjs\fP: \fBtext/javascript\fP, \fBapplication/javascript\fP,
\fBapplication/x\-javascript\fP
.IP \(bu 2
\fBcss\fP: \fBtext/css\fP
.IP \(bu 2
\fBics\fP: \fBtext/calendar\fP
.IP \(bu 2
\fBcsv\fP: \fBtext/csv\fP
.IP \(bu 2
\fBrss\fP: \fBapplication/rss+xml\fP
.IP \(bu 2
\fBatom\fP: \fBapplication/atom+xml\fP
.IP \(bu 2
\fByaml\fP: \fBapplication/x\-yaml\fP, \fBtext/yaml\fP
.IP \(bu 2
\fBmultipart_form\fP: \fBmultipart/form\-data\fP
.IP \(bu 2
\fBurl_encoded_form\fP: \fBapplication/x\-www\-form\-urlencoded\fP
.IP \(bu 2
\fBjson\fP: \fBapplication/json\fP, \fBtext/x\-json\fP
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B require(path)
Loads CommonJS module by a specified \fIpath\fP\&. The path should not start with
a slash.
.INDENT 7.0
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
\fBpath\fP – A CommonJS module path started from design document root
.UNINDENT
.TP
.B Returns
Exported statements
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B send(chunk)
Sends a single string \fIchunk\fP in response.
.INDENT 7.0
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
\fBchunk\fP – Text chunk
.UNINDENT
.UNINDENT
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
function(head, req){
    send(\(aqHello,\(aq);
    send(\(aq \(aq);
    send(\(aqCouch\(aq);
    return ;
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B start(init_resp)
Initiates chunked response. As an option, a custom
\fI\%response\fP object may be sent at this point.
For \fIlist\fP\-functions only!
.sp
\fBNOTE:\fP
.INDENT 7.0
.INDENT 3.5
list functions may set the \fIHTTP response code\fP and \fIheaders\fP by calling
this function. This function must be called before \fI\%send()\fP,
\fI\%getRow()\fP or a \fIreturn\fP statement; otherwise, the query server will
implicitly call this function with the empty object (\fB{}\fP).
.UNINDENT
.UNINDENT
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
function(head, req){
    start({
        \(dqcode\(dq: 302,
        \(dqheaders\(dq: {
            \(dqLocation\(dq: \(dqhttp://couchdb.apache.org\(dq
        }
    });
    return \(dqRelax!\(dq;
}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B sum(arr)
Sum \fIarr\fP’s items.
.INDENT 7.0
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
\fBarr\fP – Array of numbers
.UNINDENT
.TP
.B Return type
number
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B toJSON(obj)
Encodes \fIobj\fP to JSON string. This is an alias for the \fBJSON.stringify\fP
method.
.INDENT 7.0
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
\fBobj\fP – JSON\-encodable object
.UNINDENT
.TP
.B Returns
JSON string
.UNINDENT
.UNINDENT
.SS CommonJS Modules
.sp
Support for \fI\%CommonJS Modules\fP
(introduced in CouchDB 0.11.0) allows you to create modular design functions
without the need for duplication of functionality.
.sp
Here’s a CommonJS module that checks user permissions:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function user_context(userctx, secobj) {
    var is_admin = function() {
        return userctx.indexOf(\(aq_admin\(aq) != \-1;
    }
    return {\(aqis_admin\(aq: is_admin}
}

exports[\(aquser\(aq] = user_context
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Each module has access to additional global variables:
.INDENT 0.0
.IP \(bu 2
\fBmodule\fP (\fIobject\fP): Contains information about the stored module
.INDENT 2.0
.IP \(bu 2
\fBid\fP (\fIstring\fP): The module id; a JSON path in ddoc context
.IP \(bu 2
\fBcurrent\fP (\fIcode\fP): Compiled module code object
.IP \(bu 2
\fBparent\fP (\fIobject\fP): Parent frame
.IP \(bu 2
\fBexports\fP (\fIobject\fP): Export statements
.UNINDENT
.IP \(bu 2
\fBexports\fP (\fIobject\fP): Shortcut to the \fBmodule.exports\fP object
.UNINDENT
.sp
The CommonJS module can be added to a design document, like so:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dqviews\(dq: {
        \(dqlib\(dq: {
            \(dqsecurity\(dq: \(dqfunction user_context(userctx, secobj) { ... }\(dq
        }
    },
    \(dqvalidate_doc_update\(dq: \(dqfunction(newdoc, olddoc, userctx, secobj) {
        user = require(\(aqviews/lib/security\(aq).user_context(userctx, secobj);
        return user.is_admin();
    }\(dq
    \(dq_id\(dq: \(dq_design/test\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Modules paths are relative to the design document’s \fBviews\fP object, but
modules can only be loaded from the object referenced via \fBlib\fP\&. The
\fBlib\fP structure can still be used for view functions as well, by simply
storing view functions at e.g. \fBviews.lib.map\fP, \fBviews.lib.reduce\fP, etc.
.SS Erlang
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
The Erlang query server is disabled by default.
Read \fI\%configuration guide\fP about
reasons why and how to enable it.
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B Emit(Id, Value)
Emits \fIkey\fP\-\fIvalue\fP pairs to view indexer process.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
fun({Doc}) \->
    <<K,_/binary>> = proplists:get_value(<<\(dq_rev\(dq>>, Doc, null),
    V = proplists:get_value(<<\(dq_id\(dq>>, Doc, null),
    Emit(<<K>>, V)
end.
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B FoldRows(Fun, Acc)
Helper to iterate over all rows in a list function.
.INDENT 7.0
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
\fBFun\fP – Function object.
.IP \(bu 2
\fBAcc\fP – The value previously returned by \fIFun\fP\&.
.UNINDENT
.UNINDENT
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
fun(Head, {Req}) \->
    Fun = fun({Row}, Acc) \->
        Id = couch_util:get_value(<<\(dqid\(dq>>, Row),
        Send(list_to_binary(io_lib:format(\(dqPrevious doc id: ~p~n\(dq, [Acc]))),
        Send(list_to_binary(io_lib:format(\(dqCurrent  doc id: ~p~n\(dq, [Id]))),
        {ok, Id}
    end,
    FoldRows(Fun, nil),
    \(dq\(dq
end.
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B GetRow()
Retrieves the next row from a related view result.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
%% FoldRows background implementation.
%% https://git\-wip\-us.apache.org/repos/asf?p=couchdb.git;a=blob;f=src/couchdb/couch_native_process.erl;hb=HEAD#l368
%%
foldrows(GetRow, ProcRow, Acc) \->
    case GetRow() of
        nil \->
            {ok, Acc};
        Row \->
            case (catch ProcRow(Row, Acc)) of
                {ok, Acc2} \->
                    foldrows(GetRow, ProcRow, Acc2);
                {stop, Acc2} \->
                    {ok, Acc2}
            end
end.
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B Log(Msg)
.INDENT 7.0
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
\fBMsg\fP – Log a message at the \fIINFO\fP level.
.UNINDENT
.UNINDENT
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
fun({Doc}) \->
    <<K,_/binary>> = proplists:get_value(<<\(dq_rev\(dq>>, Doc, null),
    V = proplists:get_value(<<\(dq_id\(dq>>, Doc, null),
    Log(lists:flatten(io_lib:format(\(dqHello from ~s doc!\(dq, [V]))),
    Emit(<<K>>, V)
end.
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
After the map function has run, the following line can be found in
CouchDB logs (e.g. at \fI/var/log/couchdb/couch.log\fP):
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
[Sun, 04 Nov 2012 11:33:58 GMT] [info] [<0.9144.2>] Hello from 8d300b86622d67953d102165dbe99467 doc!
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B Send(Chunk)
Sends a single string \fIChunk\fP in response.
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
fun(Head, {Req}) \->
    Send(\(dqHello,\(dq),
    Send(\(dq \(dq),
    Send(\(dqCouch\(dq),
    \(dq!\(dq
end.
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The function above produces the following response:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
Hello, Couch!
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.INDENT 0.0
.TP
.B Start(Headers)
.INDENT 7.0
.TP
.B Arguments
.INDENT 7.0
.IP \(bu 2
\fBHeaders\fP – Proplist of \fI\%response object\fP\&.
.UNINDENT
.UNINDENT
.sp
Initialize \fI\%List Functions\fP response. At this point, response code and headers
may be defined. For example, this function redirects to the CouchDB
web site:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
fun(Head, {Req}) \->
    Start({[{<<\(dqcode\(dq>>, 302},
            {<<\(dqheaders\(dq>>, {[
                {<<\(dqLocation\(dq>>, <<\(dqhttp://couchdb.apache.org\(dq>>}]
            }}
        ]}),
    \(dqRelax!\(dq
end.
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.SH PARTITIONED DATABASES
.sp
A partitioned database forms documents into logical partitions by using
a partition key. All documents are assigned to a partition, and many documents
are typically given the same partition key. The benefit of partitioned databases
is that secondary indices can be significantly more efficient when locating
matching documents since their entries are contained within their partition.
This means a given secondary index read will only scan a single partition
range instead of having to read from a copy of every shard.
.sp
As a means to introducing partitioned databases, we’ll consider a motivating
use case to describe the benefits of this feature. For this example, we’ll
consider a database that stores readings from a large network of soil
moisture sensors.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Before reading this document you should be familiar with the
\fI\%theory\fP of \fI\%sharding\fP
in CouchDB.
.UNINDENT
.UNINDENT
.sp
Traditionally, a document in this database may have something like the
following structure:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
{
    \(dq_id\(dq: \(dqsensor\-reading\-ca33c748\-2d2c\-4ed1\-8abf\-1bca4d9d03cf\(dq,
    \(dq_rev\(dq:\(dq1\-14e8f3262b42498dbd5c672c9d461ff0\(dq,
    \(dqsensor_id\(dq: \(dqsensor\-260\(dq,
    \(dqlocation\(dq: [41.6171031, \-93.7705674],
    \(dqfield_name\(dq: \(dqBob\(aqs Corn Field #5\(dq,
    \(dqreadings\(dq: [
        [\(dq2019\-01\-21T00:00:00\(dq, 0.15],
        [\(dq2019\-01\-21T06:00:00\(dq, 0.14],
        [\(dq2019\-01\-21T12:00:00\(dq, 0.16],
        [\(dq2019\-01\-21T18:00:00\(dq, 0.11]
    ]
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
While this example uses IoT sensors, the main thing to consider is that
there is a logical grouping of documents. Similar use cases might be
documents grouped by user or scientific data grouped by experiment.
.UNINDENT
.UNINDENT
.sp
So we’ve got a bunch of sensors, all grouped by the field they monitor
along with their readouts for a given day (or other appropriate time period).
.sp
Along with our documents, we might expect to have two secondary indexes
for querying our database that might look something like:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    if(doc._id.indexOf(\(dqsensor\-reading\-\(dq) != 0) {
        return;
    }
    for(var r in doc.readings) {
        emit([doc.sensor_id, r[0]], r[1])
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
and:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    if(doc._id.indexOf(\(dqsensor\-reading\-\(dq) != 0) {
        return;
    }
    emit(doc.field_name, doc.sensor_id)
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
With these two indexes defined, we can easily find all readings for a given
sensor, or list all sensors in a given field.
.sp
Unfortunately, in CouchDB, when we read from either of these indexes, it
requires finding a copy of every shard and asking for any documents related
to the particular sensor or field. This means that as our database scales
up the number of shards, every index request must perform more work,
which is unnecessary since we are only interested in a small number of documents.
Fortunately for you, dear reader, partitioned databases were created to solve
this precise problem.
.SS What is a partition?
.sp
In the previous section, we introduced a hypothetical database that contains
sensor readings from an IoT field monitoring service. In this particular
use case, it’s quite logical to group all documents by their \fBsensor_id\fP
field. In this case, we would call the \fBsensor_id\fP the partition key.
.sp
A good partition has two basic properties. First, it should have a high
cardinality. That is, a large partitioned database should have many more
partitions than documents in any single partition. A database that has
a single partition would be an anti\-pattern for this feature. Secondly,
the amount of data per partition should be “small”. The general
recommendation is to limit individual partitions to less than ten
gigabytes (10 GB) of data. Which, for the example of sensor documents,
equates to roughly 60,000 years of data.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
The \fBmax_partition_size\fP under CouchDB dictates the partition limit.
The default value for this option is 10GiB but can be changed accordingly.
Setting the value for this option to 0 disables the partition limit.
.UNINDENT
.UNINDENT
.SS Why use partitions?
.sp
The primary benefit of using partitioned databases is for the performance
of partitioned queries. Large databases with lots of documents often
have a similar pattern where there are groups of related documents that
are queried together.
.sp
By using partitions, we can execute queries against these individual groups
of documents more efficiently by placing the entire group within a specific
shard on disk. Thus, the view engine only has to consult one copy of the
given shard range when executing a query instead of executing
the query across all \fBq\fP shards in the database. This mean that you do
not have to wait for all \fBq\fP shards to respond, which is both
efficient and faster.
.SS Partitions By Example
.sp
To create a partitioned database, we simply need to pass a query string
parameter:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
shell> curl \-X PUT http://127.0.0.1:5984/my_new_db?partitioned=true
{\(dqok\(dq:true}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
To see that our database is partitioned, we can look at the database
information:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
shell> curl http://127.0.0.1:5984/my_new_db
{
  \(dqcluster\(dq: {
    \(dqn\(dq: 3,
    \(dqq\(dq: 8,
    \(dqr\(dq: 2,
    \(dqw\(dq: 2
  },
  \(dqcompact_running\(dq: false,
  \(dqdb_name\(dq: \(dqmy_new_db\(dq,
  \(dqdisk_format_version\(dq: 7,
  \(dqdoc_count\(dq: 0,
  \(dqdoc_del_count\(dq: 0,
  \(dqinstance_start_time\(dq: \(dq0\(dq,
  \(dqprops\(dq: {
    \(dqpartitioned\(dq: true
  },
  \(dqpurge_seq\(dq: \(dq0\-g1AAAAFDeJzLYWBg4M...\(dq,
  \(dqsizes\(dq: {
    \(dqactive\(dq: 0,
    \(dqexternal\(dq: 0,
    \(dqfile\(dq: 66784
  },
  \(dqupdate_seq\(dq: \(dq0\-g1AAAAFDeJzLYWBg4M...\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You’ll now see that the \fB\(dqprops\(dq\fP member contains \fB\(dqpartitioned\(dq: true\fP\&.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Every document in a partitioned database (except _design
and _local documents) must have the format “partition:docid”.
More specifically, the partition for a given document is
everything before the first colon. The document id is everything
after the first colon, which may include more colons.
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
System databases (such as _users) are \fInot\fP allowed to be partitioned. This is
due to system databases already having their own incompatible
requirements on document ids.
.UNINDENT
.UNINDENT
.sp
Now that we’ve created a partitioned database, it’s time to add some documents.
Using our earlier example, we could do this as such:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
shell> cat doc.json
{
    \(dq_id\(dq: \(dqsensor\-260:sensor\-reading\-ca33c748\-2d2c\-4ed1\-8abf\-1bca4d9d03cf\(dq,
    \(dqsensor_id\(dq: \(dqsensor\-260\(dq,
    \(dqlocation\(dq: [41.6171031, \-93.7705674],
    \(dqfield_name\(dq: \(dqBob\(aqs Corn Field #5\(dq,
    \(dqreadings\(dq: [
        [\(dq2019\-01\-21T00:00:00\(dq, 0.15],
        [\(dq2019\-01\-21T06:00:00\(dq, 0.14],
        [\(dq2019\-01\-21T12:00:00\(dq, 0.16],
        [\(dq2019\-01\-21T18:00:00\(dq, 0.11]
    ]
}
shell> $ curl \-X POST \-H \(dqContent\-Type: application/json\(dq \e
            http://127.0.0.1:5984/my_new_db \-d @doc.json
{
    \(dqok\(dq: true,
    \(dqid\(dq: \(dqsensor\-260:sensor\-reading\-ca33c748\-2d2c\-4ed1\-8abf\-1bca4d9d03cf\(dq,
    \(dqrev\(dq: \(dq1\-05ed6f7abf84250e213fcb847387f6f5\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The only change required to the first example document is that we are now
including the partition name in the document id by prepending it to the
old id separated by a colon.
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
The partition name in the document id is not magical. Internally,
the database is simply using only the partition for hashing
the document to a given shard, instead of the entire document id.
.UNINDENT
.UNINDENT
.sp
Working with documents in a partitioned database is no different than
a non\-partitioned database. All APIs are available, and existing client
code will all work seamlessly.
.sp
Now that we have created a document, we can get some info about the partition
containing the document:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
shell> curl http://127.0.0.1:5984/my_new_db/_partition/sensor\-260
{
  \(dqdb_name\(dq: \(dqmy_new_db\(dq,
  \(dqdoc_count\(dq: 1,
  \(dqdoc_del_count\(dq: 0,
  \(dqpartition\(dq: \(dqsensor\-260\(dq,
  \(dqsizes\(dq: {
    \(dqactive\(dq: 244,
    \(dqexternal\(dq: 347
  }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
And we can also list all documents in a partition:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
shell> curl http://127.0.0.1:5984/my_new_db/_partition/sensor\-260/_all_docs
{\(dqtotal_rows\(dq: 1, \(dqoffset\(dq: 0, \(dqrows\(dq:[
    {
        \(dqid\(dq:\(dqsensor\-260:sensor\-reading\-ca33c748\-2d2c\-4ed1\-8abf\-1bca4d9d03cf\(dq,
        \(dqkey\(dq:\(dqsensor\-260:sensor\-reading\-ca33c748\-2d2c\-4ed1\-8abf\-1bca4d9d03cf\(dq,
        \(dqvalue\(dq: {\(dqrev\(dq: \(dq1\-05ed6f7abf84250e213fcb847387f6f5\(dq}
    }
]}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Note that we can use all of the normal bells and whistles available to
\fB_all_docs\fP requests. Accessing \fB_all_docs\fP through the
\fB/dbname/_partition/name/_all_docs\fP endpoint is mostly a convenience
so that requests are guaranteed to be scoped to a given partition. Users
are free to use the normal \fB/dbname/_all_docs\fP to read documents from
multiple partitions. Both query styles have the same performance.
.sp
Next, we’ll create a design document containing our index for
getting all readings from a given sensor. The map function is similar to
our earlier example except we’ve accounted for the change in the document
id.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    if(doc._id.indexOf(\(dq:sensor\-reading\-\(dq) < 0) {
        return;
    }
    for(var r in doc.readings) {
        emit([doc.sensor_id, r[0]], r[1])
    }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
After uploading our design document, we can try out a partitioned query:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
shell> cat ddoc.json
{
    \(dq_id\(dq: \(dq_design/sensor\-readings\(dq,
    \(dqviews\(dq: {
        \(dqby_sensor\(dq: {
            \(dqmap\(dq: \(dqfunction(doc) { ... }\(dq
        }
    }
}
shell> $ curl \-X POST \-H \(dqContent\-Type: application/json\(dq http://127.0.0.1:5984/my_new_db \-d @ddoc2.json
{
    \(dqok\(dq: true,
    \(dqid\(dq: \(dq_design/all_sensors\(dq,
    \(dqrev\(dq: \(dq1\-4a8188d80fab277fccf57bdd7154dec1\(dq
}
shell> curl http://127.0.0.1:5984/my_new_db/_partition/sensor\-260/_design/sensor\-readings/_view/by_sensor
{\(dqtotal_rows\(dq:4,\(dqoffset\(dq:0,\(dqrows\(dq:[
{\(dqid\(dq:\(dqsensor\-260:sensor\-reading\-ca33c748\-2d2c\-4ed1\-8abf\-1bca4d9d03cf\(dq,\(dqkey\(dq:[\(dqsensor\-260\(dq,\(dq0\(dq],\(dqvalue\(dq:null},
{\(dqid\(dq:\(dqsensor\-260:sensor\-reading\-ca33c748\-2d2c\-4ed1\-8abf\-1bca4d9d03cf\(dq,\(dqkey\(dq:[\(dqsensor\-260\(dq,\(dq1\(dq],\(dqvalue\(dq:null},
{\(dqid\(dq:\(dqsensor\-260:sensor\-reading\-ca33c748\-2d2c\-4ed1\-8abf\-1bca4d9d03cf\(dq,\(dqkey\(dq:[\(dqsensor\-260\(dq,\(dq2\(dq],\(dqvalue\(dq:null},
{\(dqid\(dq:\(dqsensor\-260:sensor\-reading\-ca33c748\-2d2c\-4ed1\-8abf\-1bca4d9d03cf\(dq,\(dqkey\(dq:[\(dqsensor\-260\(dq,\(dq3\(dq],\(dqvalue\(dq:null}
]}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Hooray! Our first partitioned query. For experienced users, that may not
be the most exciting development, given that the only things that have
changed are a slight tweak to the document id, and accessing views with
a slightly different path. However, for anyone who likes performance
improvements, it’s actually a big deal. By knowing that the view results
are all located within the provided partition name, our partitioned
queries now perform nearly as fast as document lookups!
.sp
The last thing we’ll look at is how to query data across multiple partitions.
For that, we’ll implement the example sensors by field query from our
initial example. The map function will use the same update to account
for the new document id format, but is otherwise identical to the previous
version:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
function(doc) {
    if(doc._id.indexOf(\(dq:sensor\-reading\-\(dq) < 0) {
        return;
    }
    emit(doc.field_name, doc.sensor_id)
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Next, we’ll create a new design doc with this function. Be sure to notice
that the \fB\(dqoptions\(dq\fP member contains \fB\(dqpartitioned\(dq: false\fP\&.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
shell> cat ddoc2.json
{
  \(dq_id\(dq: \(dq_design/all_sensors\(dq,
  \(dqoptions\(dq: {
    \(dqpartitioned\(dq: false
  },
  \(dqviews\(dq: {
    \(dqby_field\(dq: {
      \(dqmap\(dq: \(dqfunction(doc) { ... }\(dq
    }
  }
}
shell> $ curl \-X POST \-H \(dqContent\-Type: application/json\(dq http://127.0.0.1:5984/my_new_db \-d @ddoc2.json
{
    \(dqok\(dq: true,
    \(dqid\(dq: \(dq_design/all_sensors\(dq,
    \(dqrev\(dq: \(dq1\-4a8188d80fab277fccf57bdd7154dec1\(dq
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Design documents in a partitioned database default to being
partitioned. Design documents that contain views for queries
across multiple partitions must contain the \fB\(dqpartitioned\(dq: false\fP
member in the \fB\(dqoptions\(dq\fP object.
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Design documents are either partitioned or global. They cannot
contain a mix of partitioned and global indexes.
.UNINDENT
.UNINDENT
.sp
And to see a request showing us all sensors in a field, we would use a
request like:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
shell> curl \-u adm:pass http://127.0.0.1:15984/my_new_db/_design/all_sensors/_view/by_field
{\(dqtotal_rows\(dq:1,\(dqoffset\(dq:0,\(dqrows\(dq:[
{\(dqid\(dq:\(dqsensor\-260:sensor\-reading\-ca33c748\-2d2c\-4ed1\-8abf\-1bca4d9d03cf\(dq,\(dqkey\(dq:\(dqBob\(aqs Corn Field #5\(dq,\(dqvalue\(dq:\(dqsensor\-260\(dq}
]}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Notice that we’re not using the \fB/dbname/_partition/...\fP path for global
queries. This is because global queries, by definition, do not cover individual
partitions. Other than having the \fB\(dqpartitioned\(dq: false\fP parameter in the
design document, global design documents and queries are identical in
behavior to design documents on non\-partitioned databases.
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
To be clear, this means that global queries perform identically to
queries on non\-partitioned databases. Only partitioned queries
on a partitioned database benefit from the performance improvements.
.UNINDENT
.UNINDENT
.SH RELEASE NOTES
.SS 3.3.x Branch
.INDENT 0.0
.IP \(bu 2
\fI\%Version 3.3.3\fP
.IP \(bu 2
\fI\%Version 3.3.2\fP
.IP \(bu 2
\fI\%Version 3.3.1\fP
.IP \(bu 2
\fI\%Version 3.3.0\fP
.UNINDENT
.SS Version 3.3.3
.SS Features and Enhancements
.INDENT 0.0
.IP \(bu 2
\fI\%#4623\fP: Handle replicator instance start time during upgrades
better.
.IP \(bu 2
\fI\%#4653\fP: Fix the ability to use \fB;\fP in config values.
.IP \(bu 2
\fI\%#4626\fP: Fix purge infos replicating to the wrong shards during shard
splitting.
.IP \(bu 2
\fI\%#4669\fP: Make it possible to override \fB[replicator]
valid_socket_options\fP with more than two items.
.IP \(bu 2
\fI\%#4670\fP: Allow setting of some ibrowse replication options such as
\fB{prefer_ipv6, true}\fP\&.
.IP \(bu 2
\fI\%#4679\fP: Fix multipart parser “attachment longer than expected”
error. Previously there was a small chance attachments were not replicated.
.IP \(bu 2
\fI\%#4680\fP: Allow restarting failed shard splitting jobs.
.IP \(bu 2
\fI\%#4722\fP: Fix badmatch error when purge requests time out.
.IP \(bu 2
\fI\%#4736\fP: Stop client process and clean up if client disconnects when
processing streaming requests.
.IP \(bu 2
\fI\%#4758\fP: Remove sensitive headers from the mochiweb request in
process dictionary. This should prevent sensitive headers leaking into logs
when a request process crashes.
.IP \(bu 2
\fI\%#4784\fP: Extract the correct node name from \fBERL_FLAGS\fP in
\fBremsh\fP\&.
.IP \(bu 2
\fI\%#4794\fP: Fix incorrect raising of \fBdatabase_does_not_exist\fP error.
.IP \(bu 2
\fI\%#4821\fP: Wait for compacted indexes to flip. Previously, a timeout
during compact file flips could lead to crashes and a subsequent
recompaction.
.IP \(bu 2
\fI\%#4837\fP: Fix update bug in ets_lru.
.IP \(bu 2
\fI\%#4847\fP: Require auth for \fB_replicate\fP endpoint.
.IP \(bu 2
\fI\%#4878\fP: Add an option to scrub some sensitive headers from external
json requests.
.UNINDENT
.SS Version 3.3.2
.SS Features and Enhancements
.INDENT 0.0
.IP \(bu 2
\fI\%#4529\fP: In Javascript process manager, use a database tag in
addition to a ddoc ID to quickly find processes. This should improve
performance.
.IP \(bu 2
\fI\%#4509\fP, \fI\%#4405\fP: Make remsh work with quoted cookie values.
.IP \(bu 2
\fI\%#4473\fP: Avoid re\-compiling filter view functions. This could speed
up Javascript filter functions.
.IP \(bu 2
\fI\%#4412\fP: Remove Javascript json2 script and the try/except clause
around seal.
.IP \(bu 2
\fI\%#4513\fP: Allow configurable timeouts for \fB_view\fP and \fB_search\fP\&.
Search timeouts can be specified as \fB[fabric] search_timeout\fP and
\fB[fabric] search_permsg\fP\&. View per\-message timeout can be configured as
\fB[fabric] view_permsg_timeout\fP\&.
.IP \(bu 2
\fI\%#4438\fP: Proxy auth can now use one of the configured hash algorithms
from chttpd_auth/hash_algorithms to decode authentication tokens.
.IP \(bu 2
\fI\%#4370\fP: Ensure design docs are uploaded individually when
replicating with \fB_bulk_get\fP\&. This restores previous behavior before
version 3.3.0.
.IP \(bu 2
\fI\%#4416\fP: Allow \fB_local\fP doc writes to the replicator dbs.
Previously this issue prevented replicating the replicator db itself, since
checkpointing was not working properly.
.IP \(bu 2
\fI\%#4363\fP: Fix replication \fB_scheduler/docs\fP \fB\(dqtotal_rows\(dq\fP value.
.IP \(bu 2
\fI\%#4380\fP: Be more defensive about SpiderMonkey location. An error
should be emitted early if the Spidermonkey library cannot be found.
.IP \(bu 2
\fI\%#4388\fP: Bump recon to 2.5.3. See the \fI\%changelog\fP for more details.
.IP \(bu 2
\fI\%#4476\fP, \fI\%#4515\fP, \fI\%#4490\fP, \fI\%#4350\fP,
\fI\%#4379\fP: Various documentation cleanups and fixes.
.IP \(bu 2
Fix for \fI\%CVE\-2023\-26268\fP\&.
.UNINDENT
.SS Version 3.3.1
.SS Features and Enhancements
.INDENT 0.0
.IP \(bu 2
\fI\%#4343\fP, \fI\%#4344\fP, \fI\%#4345\fP: Fix \fBundef\fP when
parsing replication doc body with a \fBuser_ctx\fP\&.
.IP \(bu 2
\fI\%#4346\fP: Add \fBmake\fP target to find \fBundef\fP errors.
.IP \(bu 2
\fI\%#4347\fP: Remove failed \fBcouch_plugins\fP experiment, fixes more
\fBundef\fP errors.
.IP \(bu 2
\fI\%#4348\fP: Fix \fBundef\fP error in \fBweatherreport\fP\&.
.IP \(bu 2
\fI\%#4353\fP: Allow starting of more than one replication job. (D’OH!)
.UNINDENT
.SS Version 3.3.0
.SS Highlights
.INDENT 0.0
.IP \(bu 2
\fI\%#4308\fP: Replicator was optimized and should be faster. It now uses
the \fI_bulk_get\fP endpoint on the source, and can statistically skip calling
\fI_revs_diff\fP on the target. Benchmark tests replicating 1M documents, 10KB
each, from UK to US East show a 3x speed improvement.
.UNINDENT
.INDENT 0.0
.INDENT 2.5
[image: Replicator, Tea! Earl Grey! Hot! (Because Picard said so)]
[image]
.UNINDENT
.UNINDENT
.SS Features and Enhancements
.INDENT 0.0
.IP \(bu 2
\fI\%#3766\fP, \fI\%#3970\fP, \fI\%#3972\fP, \fI\%#4093\fP,
\fI\%#4102\fP, \fI\%#4104\fP, \fI\%#4110\fP, \fI\%#4111\fP,
\fI\%#4114\fP, \fI\%#4245\fP, \fI\%#4246\fP:, \fI\%#4266\fP: Add
\fBsmoosh\fP queue persistence. This allows resuming \fBsmoosh\fP operations
after a node restart. This is disabled by default and can be enabled with
\fB[smoosh] persist = true\fP\&. Optimise \fBsmoosh\fP operations and increase
test coverage to 90%.
.IP \(bu 2
\fI\%#3798\fP: Add \fBlibicu\fP version and collation algorithm version to
\fB/_node/_local/_versions\fP\&.
.IP \(bu 2
\fI\%#3837\fP: The Erlang source tree is now auto\-formatted with \fBerlfmt\fP\&.
.IP \(bu 2
\fI\%#3845\fP: Clean up the \fBcouch_ejson_compare\fP C\-module and squash
Microsoft compiler warnings.
.IP \(bu 2
\fI\%#3832\fP: Add \fBGET\fP variant to \fB_dbs_info\fP endpoint, used to be
\fBPOST\fP only.
.IP \(bu 2
\fI\%#3864\fP: Improve \fBerlang_ls\fP configuration.
.IP \(bu 2
\fI\%#3853\fP: Remove legacy \fBddoc_cache_opener\fP \fBgen_server\fP and
speed up event routing.
.IP \(bu 2
\fI\%#3879\fP: Remove use of \fBERL_OPTS\fP environment variable. All
supported Erlang versions now use \fBERL_COMPILER_OPTIONS\fP for the same
purpose.
.IP \(bu 2
\fI\%#3883\fP: Add support for SpiderMonkey 91.
.IP \(bu 2
\fI\%#3889\fP: Track \fBlibicu\fP collator versions in the view header.
.IP \(bu 2
\fI\%#3952\fP: Make the timeout for receiving requests from attachment
writers configurable.
.IP \(bu 2
\fI\%#3927\fP: Include index signature in \fB_search_info\fP\&.
.IP \(bu 2
\fI\%#3963\fP: Optimtize key tree stemming by using maps instead of
sets. This greatly reduced memory usage for heavily conflicted docs in some
situations.
.IP \(bu 2
\fI\%#3974\fP: Create new config options in \fB[couchdb]\fP and \fB[smoosh]\fP
sections to enable finer control of compaction logging levels.
.IP \(bu 2
\fI\%#3983\fP, \fI\%#3984\fP, \fI\%#3985\fP, \fI\%#3987\fP,
\fI\%#4033\fP: Add various functions to \fBcouch_debug\fP module.
.IP \(bu 2
\fI\%#4000\fP: Ensure \fBObject.prototype.toSource()\fP is always available.
.IP \(bu 2
\fI\%#4018\fP: Update \fBjiffy\fP to 1.1.1 and \fBb64url\fP to 1.0.3.
.IP \(bu 2
\fI\%#4021\fP: Reduce smoosh compaction log level to \fBdebug\fP\&.
.IP \(bu 2
\fI\%#4041\fP: Allow and evaluate nested json claim roles in JWT token.
.IP \(bu 2
\fI\%#4060\fP, \fI\%#4290\fP: Add support for Erlang 25.
.IP \(bu 2
\fI\%#4064\fP: Enable replicating purge requests between nodes. Also avoid
applying interactive purges more than once.
.IP \(bu 2
\fI\%#4069\fP, \fI\%#4084\fP: Drop support for Erlang < 23, update
\fBvm.args\fP settings to match. Review this if you have customized your
\fBvm.args\fP\&.
.IP \(bu 2
\fI\%#4083\fP: Support Elixir 13.
.IP \(bu 2
\fI\%#4085\fP: Add an option to let \fBcustodian\fP always use \fB[cluster] n\fP
value.
.IP \(bu 2
\fI\%#4095\fP: Implement \fBwinning_revs_only\fP option for the replicator. It
replicates only the winning revisions from the source to the target,
effectively discarding conflicts.
.IP \(bu 2
\fI\%#4135\fP: Separate search IO from file IO.
.IP \(bu 2
\fI\%#4140\fP, \fI\%#4162\fP: Upgrade hash algorithm for cookie auth (sha1
\-> sha256). This introduces a new config setting \fBhash_algorithms\fP\&. New cookie
values are hashed with sha256, sha1 hashes are still accepted. Admins can set
this to sha256 only. Sha1 will be disallowed in the next major release. Show
supported hash algorithms in \fB/_node/_local/_versions\fP endpoint.
.IP \(bu 2
\fI\%#4179\fP: Don’t double\-encode changes sequence strings in the
replicator.
.IP \(bu 2
\fI\%#4182\fP: Explicitly maintain a fully connected cluster. Previously, it
was possible for the nodes to disconnect, and for that state to persist until
the nodes restarted.
.IP \(bu 2
\fI\%#4198\fP: Redact passwords in log file.
.IP \(bu 2
\fI\%#4243\fP: Update \fBmochiweb\fP to 3.1.1.
.IP \(bu 2
\fI\%#4254\fP: The \fB_dbs_info\fP access control is now configured with the
\fB[couchdb] admin_only_all_dbs\fP setting. Defaults to true. This was a
leftover from the 3.0.0 release.
.IP \(bu 2
\fI\%#4264\fP: \fBactive\fP database sizes is now limited to leaf nodes.
Previously, it included intermediate tree nodes, which had the effect that
deleting (large) documents did not decrease \fBactive\fP database size. In
addition, \fBsmoosh\fP now picks up databases where large documents are
deleted for compaction more eagerly, reclaiming the deleted space quicker.
.IP \(bu 2
\fI\%#4270\fP: Shard splitting now uses its own \fBreshard\fP IO priority.
It can be configured to be safely run in the background with production
loads, or with maximum IO available, if admins prefer quicker progress.
.IP \(bu 2
\fI\%#4274\fP: Improve validation of replicator job parameters & move
\fB_replicator\fP VDU design doc to internal BDU.
.IP \(bu 2
\fI\%#4280\fP: Add \fBCFLAGS\fP and \fBLDFLAGS\fP to ICU build parameters.
.IP \(bu 2
\fI\%#4284\fP: Remove all usage of global to avoid potential deadlocks
in replication jobs.
.IP \(bu 2
\fI\%#4287\fP: Allow \fB=\fP in config key names.
.IP \(bu 2
\fI\%#4306\fP: Fauxton was updated to version v1.2.9. Changes since v1.2.8
can be found \fI\%here\fP
.IP \(bu 2
\fI\%#4317\fP: Write “Relax” welcome message to standard out on
Windows.
.UNINDENT
.SS Performance
.INDENT 0.0
.IP \(bu 2
\fI\%#3860\fP: Add sharding to \fBcouch_index_server\fP, similar to
\fI\%#3366\fP, avoids processing bottlenecks on servers with a lot of
concurrent view indexing going on.
.IP \(bu 2
\fI\%#3891\fP: Avoid decoding JWT payloads when not necessary.
.IP \(bu 2
\fI\%#4031\fP: Default \fB[rexi] use_kill_all\fP to \fBtrue\fP\&. This improves
intra\-cluster\-node messaging. Set to false if you run a cluster with nodes
that have a version <3.0.0.
.IP \(bu 2
\fI\%#4052\fP: Optimise \fBcouch_util:reorder_results/2,3\fP, which speeds up
\fB_bulk_docs\fP and \fB_revs_diff\fP\&.
.IP \(bu 2
\fI\%#4055\fP: Avoid using \fBlength/1\fP guard for \fB>0\fP or \fB==0\fP tests in
\fBcouch_key_tree\fP\&.
.IP \(bu 2
\fI\%#4056\fP: Optimise \fBcouch_key_tree:find_missing/2\fP\&. This speeds up
\fB_revs_diff\fP\&.
.IP \(bu 2
\fI\%#4059\fP: Reduce complexity of \fBpossible_ancestors\fP from quadratic to
linear. This speeds up working with heavily conflicted documents
significantly.
.IP \(bu 2
\fI\%#4091\fP: Optimise \fBcouch_util:to_hex/1\fP, this speeds up all
operations that need to encode a revision id into JSON (this is most
operations).
.IP \(bu 2
\fI\%#4106\fP: Set \fBio_priority\fP in all IO paths. Introduces \fBsystem\fP
\fBio_priority\fP\&.
.IP \(bu 2
\fI\%#4144\fP, \fI\%#4172\fP: Implement \fB_bulk_get\fP support for the
replicator. Backward compatibility is ensured. This speeds up all
replications. Add option to disable new behaviour for legacy setups.
.IP \(bu 2
\fI\%#4163\fP: Statistically skip \fB_revs_diff\fP in the replicator. This
improves performance for replications into empty targets.
.IP \(bu 2
\fI\%#4177\fP: Remove the long deprecated \fBbigcouch 0.4\fP change sequence
support.
.IP \(bu 2
\fI\%#4238\fP: Optimise \fB_bulk_get\fP endpoint. This speeds up replication
of 1M docs by ~2x. Individual \fB_bulk_get\fP requests are up to 8x faster.
.IP \(bu 2
\fI\%#3517\fP: Add experimental fix for reduce performance regression due
to expensive repeated AST\-transformations on newer SpiderMonkey versions.
Set \fBCOUCHDB_QUERY_SERVER_JAVASCRIPT\fP env var to
\fBCOUCHDB_QUERY_SERVER_JAVASCRIPT=\(dq/opt/couchdb/bin/couchjs
/opt/couchdb/share/server/main\-ast\-bypass.js\(dq\fP\&.
.IP \(bu 2
\fI\%#4262\fP: \fBcouchjs\fP executable built against Spidermonkey >= 78 will
return the detailed \fBmajor.minor.patch\fP as opposed to just the \fBmajor\fP
version as previously.
.UNINDENT
.SS Bugfixes
.INDENT 0.0
.IP \(bu 2
\fI\%#3817\fP: Fix undefined function call in \fBweatherreport\fP\&.
.IP \(bu 2
\fI\%#3819\fP: Return \fB400\fP instead of \fB500\fP response code for known
invalid \fB_bulk_docs\fP with \fBnew_edits=false\fP request.
.IP \(bu 2
\fI\%#3861\fP: Add \fBSameSite\fP setting when clearing session cookies.
.IP \(bu 2
\fI\%#3863\fP: Fix custom TLS distribution for Erlang 20.
.IP \(bu 2
\fI\%#3870\fP: Always send all cookie attributes.
.IP \(bu 2
\fI\%#3886\fP: Avoid changes feed rewind after shard move with no subsequent
db updates.
.IP \(bu 2
\fI\%#3888\fP: Make \fB_stats\fP endpoint resilient against nodes that go
offline.
.IP \(bu 2
\fI\%#3901\fP: Use db\-creation time instead of \fB0\fP for
\fBinstance_start_time\fP to help replicator recognise whether a peer database
was deleted and recreated.
.IP \(bu 2
\fI\%#3909\fP: Fix \fBnew_edits:false\fP and VDU \fBfunction_clause\fP\&.
.IP \(bu 2
\fI\%#3934\fP: Fix \fBreplicated_changes\fP typo for purge doc updates.
.IP \(bu 2
\fI\%#3940\fP: Ensure the multipart parser always monitors the worker and
make sure to wait for attachment uploads before responding.
.IP \(bu 2
\fI\%#3950\fP: Ignore responses from timed\-out or retried \fBibrowse\fP calls.
.IP \(bu 2
\fI\%#3969\fP: Fix \fBskip\fP and \fBlimit\fP for \fB_all_dbs\fP and
\fB_dbs_info\fP\&.
.IP \(bu 2
\fI\%#3979\fP: Correctly respond with a \fB500\fP code when document updates
time out under heavy load.
.IP \(bu 2
\fI\%#3992\fP: Show that Search is available if it was available
before. Avoid Search availability disappearing just because a Search node was
temporarily not available.
.IP \(bu 2
\fI\%#3993\fP: Return a \fB400\fP error when decoding a JWT token fails,
rather than crashing and not responding at all.
.IP \(bu 2
\fI\%#3990\fP: Prevent creation of ddocs with no name through Mango index
creation.
.IP \(bu 2
\fI\%#4003\fP: Improve index building during shard splitting.
.IP \(bu 2
\fI\%#4016\fP: Fix \fBfunction_clause\fP error for replicated changes with a
target VDU.
.IP \(bu 2
\fI\%#4020\fP: Fix \fBmaybe_handle_error\fP clauses.
.IP \(bu 2
\fI\%#4037\fP: Fix ES{256,384,512} support for JWTs.
.IP \(bu 2
\fI\%#4040\fP: Handle \fBexit(shutdown)\fP error in \fBchttpd\fP\&.
.IP \(bu 2
\fI\%#4043\fP: Fix purge request timeouts (5s \-> infinity).
.IP \(bu 2
\fI\%#4146\fP: The \fBdevcontainer\fP has been updated.
.IP \(bu 2
\fI\%#4050\fP: Handle \fBall_dbs_active\fP in \fBfabric_doc_update\fP\&.
.IP \(bu 2
\fI\%#4160\fP: Return a proper \fB400\fP error when an invalid object is sent
to \fB_bulk_get\fP\&.
.IP \(bu 2
\fI\%#4070\fP: Prevent \fBerror:function_clause\fP in \fBcheck_security/3\fP if
roles claim is malformed.
.IP \(bu 2
\fI\%#4075\fP: Fix \fBcouch_debug:opened_files*\fP functions.
.IP \(bu 2
\fI\%#4108\fP: Trim \fBX\-Auth\-CouchDB\-Roles\fP header after reading.
.IP \(bu 2
\fI\%#4153\fP: The \fBrequire_valid_user\fP setting is now under \fBchttpd\fP\&.
.IP \(bu 2
\fI\%#4161\fP: Fix \fBcontent\-type\fP handling in \fB_session\fP\&.
.IP \(bu 2
\fI\%#4176\fP: Fix \fBeventsource\fP \fB_changes\fP feed.
.IP \(bu 2
\fI\%#4197\fP: Support large (and impractical as\-of\-yet) \fBq\fP values. Fix
shard open timeouts for \fBq > 64\fP\&.
.IP \(bu 2
\fI\%#4199\fP: Fix spurious unlock in \fBclose_db_if_idle\fP\&.
.IP \(bu 2
\fI\%#4230\fP: Avoid refresh messages piling up in prometheus server.
.IP \(bu 2
\fI\%#4240\fP: Implement global password hasher process. This fixes a
race\-condition when setting new admin passwords in quick succession on a
multicore server.
.IP \(bu 2
\fI\%#4261\fP, \fI\%#4271\fP: Clean up stale view checkpoints,
improve purge client cleanup logging
.IP \(bu 2
\fI\%#4272\fP: Kill all \fBcouch_server_N\fP if \fBdatabase_dir\fP changes.
.IP \(bu 2
\fI\%#4313\fP: Use \fBchttpd\fP config section when patching local
\fB_replicate\fP endpoints.
.IP \(bu 2
\fI\%#4321\fP: Downgrade jiffy to allow building on Windows again.
.IP \(bu 2
\fI\%#4329\fP, \fI\%#4323\fP: Ignore build windows binaries in
git.
.UNINDENT
.SS Tests
.INDENT 0.0
.IP \(bu 2
\fI\%#3825\fP: Eliminate Elixir compiler warnings.
.IP \(bu 2
\fI\%#3830\fP: Reduce skipped Elixir integration tests.
.IP \(bu 2
\fI\%#3890\fP: Handle \fBnot_found\fP lookups removing ddoc cache key.
.IP \(bu 2
\fI\%#3892\fP: Use Debian Stable for CI, add Erlang 24 to CI.
.IP \(bu 2
\fI\%#3898\fP: Remove CI support for Ubuntu 16.04.
.IP \(bu 2
\fI\%#3903\fP, \fI\%#3914\fP: Refactor Jenkins to dynamically generate
stages. Drop \fBMINIMUM_ERLANG_VERSION\fP to 20, drop the packaging
\fBERLANG_VERSION\fP to 23, add the \fBweatherreport\-test\fP as a build step, and
add \fBARM\fP and \fBPOWER\fP back into the matrix.
.IP \(bu 2
\fI\%#3921\fP:, \fI\%#3923\fP: Execute various tests in clean
\fBdatabase_dir\fP to avoid subsequent test flakiness.
.IP \(bu 2
\fI\%#3968\fP: Ensure key tree rev stemming does’t take too much memory.
.IP \(bu 2
\fI\%#3980\fP: Upgrade Mango test dependency \fBnose\fP to \fBnose\fP and fix
flaky\-on\-Windows tests.
.IP \(bu 2
\fI\%#4006\fP: Remove CI support for Debian 9.
.IP \(bu 2
\fI\%#4061\fP, \fI\%#4082\fP: Update PPC CI builder.
.IP \(bu 2
\fI\%#4096\fP: Fix flaky \fBvalidate_doc_update\fP Elixir test.
.IP \(bu 2
\fI\%#4123\fP: Fix \fBhaproxy.cfg\fP\&.
.IP \(bu 2
\fI\%#4126\fP: Return a \fB400\fP response for a single \fBnew_edits=false\fP
doc update without revision.
.IP \(bu 2
\fI\%#4129\fP: Fix \fBproxyauth_test\fP and removed it from skip list.
.IP \(bu 2
\fI\%#4132\fP: Address race condition in \fBcpse_incref_decref\fP test.
.IP \(bu 2
\fI\%#4151\fP: Refactor replication tests to use clustered endpoints.
.IP \(bu 2
\fI\%#4178\fP: Add test coverage to prevent junk in \fBeventsource\fP\&.
.IP \(bu 2
\fI\%#4188\fP: Enable eunit coverage for all applications instead of
enabling it per\-application.
.IP \(bu 2
\fI\%#4202\fP: Fix race condition in ddoc cache LRU test.
.IP \(bu 2
\fI\%#4203\fP, \fI\%#4205\fP: Reduce test log noise.
.IP \(bu 2
\fI\%#4268\fP: Improve flaky \fB_dbs_info\fP test.
.IP \(bu 2
\fI\%#4319\fP: Fix offline \fBconfigure\fP and \fBmake release\fP\&.
.IP \(bu 2
\fI\%#4328\fP: Fix \fBeaddrnotavail\fP in Elixir tests under Windows.
.IP \(bu 2
\fI\%#4330\fP: Do not run source checks in main CI build.
.UNINDENT
.SS Docs
.INDENT 0.0
.IP \(bu 2
\fI\%#4164\fP: The CouchDB documentation has been moved into the main
CouchDB repository.
.IP \(bu 2
\fI\%#4307\fP, \fI\%#4174\fP: Update Sphinx to version 5.3.0
.IP \(bu 2
\fI\%#4170\fP: Document the \fB/_node/_local/_versions\fP endpoint.
.UNINDENT
.SS Builds
.INDENT 0.0
.IP \(bu 2
\fI\%#4097\fP: Stop publication of nightly packages. They were not used
anywhere.
.IP \(bu 2
\fI\%#4322\fP: Reuse installed rebar and rebar3
for mix. Compatible with Elixir =< 13 only. Elixir 14 is not
supported yet.
.IP \(bu 2
\fI\%#4326\fP: Move Elixir source checks to a separate build step.
.UNINDENT
.SS Other
.INDENT 0.0
.IP \(bu 2
Added pumpkin spice to selected endpoints. — Thank you for reading the 3.3.0
release notes.
.UNINDENT
.SS 3.2.x Branch
.INDENT 0.0
.IP \(bu 2
\fI\%Version 3.2.3\fP
.IP \(bu 2
\fI\%Version 3.2.2\fP
.IP \(bu 2
\fI\%Version 3.2.1\fP
.IP \(bu 2
\fI\%Version 3.2.0\fP
.UNINDENT
.SS Version 3.2.3
.SS Features and Enhancements
.INDENT 0.0
.IP \(bu 2
\fI\%#4529\fP: In Javascript process manager, use a database tag in
addition to a ddoc ID to quickly find processes. This should improve
performance.
.IP \(bu 2
\fI\%#4509\fP, \fI\%#4405\fP: Make remsh work with quoted cookie values.
.IP \(bu 2
Fix for \fI\%CVE\-2023\-26268\fP\&.
.UNINDENT
.SS Version 3.2.2
.SS Bugfixes
.INDENT 0.0
.IP \(bu 2
Fix for \fI\%CVE\-2022\-24706\fP\&.
This is a security release for a \fIcritical\fP vulnerability.
.IP \(bu 2
\fI\%#3963\fP: Optimize compaction and doc updates for conflicted
documents on Erlang versions higher than 21.
.IP \(bu 2
\fI\%#3852\fP: Add support for SpiderMonkey 91esr.
.UNINDENT
.SS Version 3.2.1
.SS Features and Enhancements
.INDENT 0.0
.IP \(bu 2
\fI\%#3746\fP: \fBcouch_icu_driver\fP collation driver has been
removed. ICU collation functionality is consolidated in the single
\fBcouch_ejson_compare\fP module. View performance might slightly
increase as there are less corner cases when the C collation driver
fails and falls back to Erlang.
.IP \(bu 2
\fI\%#3787\fP: Update sequences generated from DB info and
\fB_changes?since=now&limit=0\fP now contain shard uuids as part of
their internal, opaque, representation. As a result, there should be
less chance of experiencing changes feed rewinds with these
sequences.
.IP \(bu 2
\fI\%#3798\fP: ICU driver and collator algorithm versions are
returned in the \fB_node/$node/_versions\fP result.
.IP \(bu 2
\fI\%#3801\fP: Users with the \fB_metrics\fP role can now read
\fB_prometheus\fP metrics.
.UNINDENT
.SS Bugfixes
.INDENT 0.0
.IP \(bu 2
\fI\%#3780\fP: Avoid changes feed rewinds after shard moves.
.IP \(bu 2
\fI\%#3779\fP, \fI\%#3785\fP: Prevent deleted view file cleanup
from crashing when database is deleted while the cleanup process is
running.
.IP \(bu 2
\fI\%#3789\fP: Fix \fBbadarith\fP 500 errors when \fB[fabric]
request_timeout\fP is set to \fBinfinity\fP\&.
.IP \(bu 2
\fI\%#3786\fP: Fix off\-by\-one \fBlimit\fP error for
\fB_all_dbs\fP\&. Also, the auto\-injected shard \fB_dbs\fP design doc is
removed and replaced with an Erlang module.
.IP \(bu 2
\fI\%#3788\fP: Minimize changes feeds rewinds when a node is down.
.IP \(bu 2
\fI\%#3807\fP: Enable \fBcustodian\fP application
reporting. Previously, \fBcustodian\fP was accidentally left disabled
as it used a hard\-coded shards db name different than \fB_dbs\fP\&.
.IP \(bu 2
\fI\%#3805\fP: Cluster setup correctly syncs admin passwords and
uses the new (since 3.2.0) \fB[chttpd_auth]\fP config section instead
of the previous \fB[couch_httpd_auth]\fP section.
.IP \(bu 2
\fI\%#3810\fP: Local development \fBdev/run\fP script now uses the
\fB[chttpd_auth]\fP section in \fBlocal.ini\fP instead of
\fB[couch_httpd_auth]\fP\&.
.IP \(bu 2
\fI\%#3773\fP: Fix reduce view collation results for unicode
equivalent keys.
.UNINDENT
.SS Version 3.2.0
.SS Features and Enhancements
.INDENT 0.0
.IP \(bu 2
\fI\%#3364\fP: CouchDB’s replicator now implements a Fair Share replication
scheduler. Rather than using a round\-robin scheduling mechanism, this update allows
specifying the relative priority of jobs via different \fB_replicator\fP databases.
More information is available in the \fI\%_replicator DB docs\fP\&.
.UNINDENT
.INDENT 0.0
.INDENT 2.5
[image: Robert Downey, Jr., thinks that's fair enough for him.]
[image]
.UNINDENT
.UNINDENT
.INDENT 0.0
.IP \(bu 2
\fI\%#3166\fP: Allow custom JWT claims for roles, via the \fB[jwt_auth]
roles_claim_name\fP config setting.
.IP \(bu 2
\fI\%#3296\fP, \fI\%#3312\fP: CouchDB now includes \fBweatherreport\fP and its
dependency \fBcustodian\fP, a diagnostic app forked from Basho’s \fBriaknostic\fP tool.
More documentation is available in the \fI\%Cluster Troubleshooting\fP section.
.IP \(bu 2
\fI\%#2911\fP, \fI\%#3298\fP, \fI\%#3425\fP: CouchDB now returns the version of
SpiderMonkey to administrators in the \fBGET /_node/{node\-name}/_versions\fP response.
.IP \(bu 2
\fI\%#3303\fP: CouchDB now treats a \fB408\fP response received by the replicator
similar to any \fB5xx\fP error (by retrying, as opposed to a permanent error). CouchDB
will never return a \fB408\fP, but some reverse proxies in front of CouchDB may return
this code.
.IP \(bu 2
\fI\%#3322\fP: \fB_session\fP now accepts gzip encoding.
.IP \(bu 2
\fI\%#3254\fP: The new \fB$keyMapMatch\fP operator allows Mango to query on the keys
of a map. It is similar to the \fB$elemMatch\fP operator, but instead of operating on
the elements of array, it operates on the keys of a map.
.IP \(bu 2
\fI\%#3336\fP: Developers now have access to a \fB\&.devcontainer\fP configuration for
the 3.x version of CouchDB, right in the source code repository.
.IP \(bu 2
\fI\%#3347\fP: The default maximum attachment size has been reduced from
\fBinfinity\fP to 1 GiB.
.IP \(bu 2
\fI\%#3361\fP: Compaction process suspension now appears in the \fBactive_tasks\fP
output, allowing administrators to verify that the \fBstrict_window\fP value is being
respected.
.IP \(bu 2
\fI\%#3378\fP: The \fB[admins]\fP section and the \fB[replicator] password\fP are now
redacted from all logs. In addition, \fI\%#3380\fP removes user credentials,
user documents and design documents from logfiles as much as possible. Further,
\fI\%#3489\fP no longer logs all of the messages received by a terminated internal
Erlang process.
.IP \(bu 2
\fI\%#3421\fP, \fI\%#3500\fP: CouchDB now supports SpiderMonkey 78 and 86.
.IP \(bu 2
\fI\%#3422\fP: CouchDB now supports Erlang/OTP 23 and \fBerror_logger\fP reports
for Erlang/OTP >= 21.
.IP \(bu 2
\fI\%#3566\fP: CouchDB now also supports Erlang/OTP 24.
.IP \(bu 2
\fI\%#3571\fP: CouchDB \fIno longer supports Erlang/OTP 19\fP\&.
.IP \(bu 2
\fI\%#3643\fP: Contribute a custom Erlang network protocol to CouchDB,
users can specify nodes to use TCP or TLS.
.UNINDENT
.INDENT 0.0
.INDENT 2.5
[image: The SSL/TLS handshake enables the TLS client and server to establish
the secret keys with which they communicate.]
[image]
.UNINDENT
.UNINDENT
.INDENT 0.0
.IP \(bu 2
\fI\%#3472\fP, \fI\%#3473\fP, \fI\%#3609\fP: Migrate some config options from
\fB[httpd]\fP to \fB[chttpd]\fP, migrate some from \fB[couch_httpd_auth]\fP to
\fB[chttpd_auth]\fP, and comment all out in the \fBdefault.ini\fP\&.
.INDENT 2.0
.IP \(bu 2
Config options moved from \fB[httpd]\fP to \fB[chttpd]\fP:
\fBallow_jsonp\fP, \fBchanges_timeout\fP, \fBconfig_whitelist\fP,
\fBenable_cors\fP, \fBsecure_rewrites\fP, \fBx_forwarded_host\fP,
\fBx_forwarded_proto\fP, \fBx_forwarded_ssl\fP,
\fBenable_xframe_options\fP, \fBmax_http_request_size\fP\&.
.IP \(bu 2
Config options moved from \fB[couch_httpd_auth]\fP to \fB[chttpd_auth]\fP:
\fBauthentication_redirect\fP, \fBtimeout\fP, \fBauth_cache_size\fP,
\fBallow_persistent_cookies\fP, \fBiterations\fP, \fBmin_iterations\fP, \fBmax_iterations\fP,
\fBpassword_scheme\fP, \fBproxy_use_secret\fP, \fBpublic_fields\fP, \fBsecret\fP,
\fBusers_db_public\fP, \fBx_auth_roles\fP, \fBx_auth_token\fP, \fBx_auth_username\fP,
\fBcookie_domain\fP, \fBsame_site\fP
.UNINDENT
.IP \(bu 2
\fI\%#3586\fP: We added a new way of specifying basic auth credentials
which can include various characters previously not allowed to be included
in the url info part of endpoint urls.
.IP \(bu 2
\fI\%#3483\fP: We added a way of specifying requirements for new user passwords
using a list of regular expressions.
.IP \(bu 2
\fI\%#3506\fP, \fI\%#3416\fP, \fI\%#3377\fP: CouchDB now provides a Prometheus
compatible endpoint at \fBGET /_node/{node\-name}/_prometheus\fP\&. A configuration option
allows for scraping via a different port (17986) that does not require authentication,
if desired. More information is available at the \fI\%Prometheus API endpoint\fP summary.
.IP \(bu 2
\fI\%#3697\fP, \fI\%COUCHDB\-883\fP (JIRA): As an opt\-in policy, CouchDB can now stop
encoding the plus sign \fB+\fP in non\-query parts of URLs, in compliance with the
original CouchDB standards. The opt\-in is via the \fB[chttpd] decode_plus_to_space =
true\fP setting. \fIIn CouchDB 4.x, this is going to be an opt\-out policy.\fP
.IP \(bu 2
\fI\%#3724\fP: CouchDB now has new CSP settings for attachments and show/list
functions. This deprecates the old \fB[csp] enable\fP and \fB[csp] header_value\fP
settings, replacing them with the new \fB[csp] utils_enable\fP and \fB[csp]
utils_header_value\fP settings respectively. In addition, new settings for
\fBattachments_enable\fP, \fBattachments_header_value\fP, \fBshowlist_enable\fP and
\fBshowlist_header_value\fP now are available. Documentation is in the \fBdefault.ini\fP
file.
.IP \(bu 2
\fI\%#3734\fP, \fI\%#3733\fP: Users with databases that have low \fBq\fP and \fBn\fP
values would often receive the \fBNo DB shards could be opened\fP error when the cluster
is overloaded, due to a hard\-coded 100ms timeout. CouchDB now calculates a more
reasonable timeout, based on the number of shards and the overall maximum fabric
request timeout limit, using a geometric series.
.UNINDENT
.SS Performance
.INDENT 0.0
.IP \(bu 2
\fI\%#3337\fP: Developer nodes now start faster when using the \fBdev/run\fP script.
.IP \(bu 2
\fI\%#3366\fP: The monolithic \fBcouch_server\fP process has been sharded for
performance. Previously, as a single \fBgen_server\fP, the process would
have a finite throughput that, in busy clusters, is easily breached – causing a
sizeable backlog in the message queue, ultimately leading to failure and errors. No
more! The aggregate message queue info is still available in the \fB_system\fP output.
( \fI\%#3370\fP )
.IP \(bu 2
\fI\%#3208\fP: CouchDB now uses the latest ibrowse 4.4.2 client for the replicator.
.IP \(bu 2
\fI\%#3600\fP, \fI\%#3047\fP, \fI\%#3019\fP: The default \fBslack\fP channel for
smoosh auto\-compaction has been increased to a more reasonable value, reducing load
on systems that would have normally been idle in CouchDB 2.x (where no auto\-compaction
daemon exists).
.IP \(bu 2
\fI\%#3711\fP: Changes feeds may no longer rewind after shard moves, assuming the
node and range specified by the changes feed nonce can still match an existing node’s
shard.
.UNINDENT
.SS Bugfixes
.INDENT 0.0
.IP \(bu 2
Complete retirement of the JavaScript test suite \- replaced by Elixir. Hooray!
.IP \(bu 2
\fI\%#3165\fP: Allow configurability of JWT claims that require a value. Also fixes
\fI\%#3232\fP\&. Further, \fI\%#3392\fP no longer validates claims provided that
CouchDB does not require.
.IP \(bu 2
\fI\%#3160\fP, \fI\%#3161\fP: The \fBrun_queue\fP statistic now returns valid
information even when using Erlang BEAM dirty CPU and IO queues.
.IP \(bu 2
\fI\%#3162\fP: Makefiles updated to include local configs & clean configs when
running \fBmake devclean\fP\&.
.IP \(bu 2
\fI\%#3195\fP: The \fBmax_document_size\fP parameter now has a clearer explanation in
\fBdefault.ini\fP\&.
.IP \(bu 2
\fI\%#3207\fP, \fI\%#2536\fP: Improve the \fBINSTALL.Unix.md\fP file.
.IP \(bu 2
\fI\%#3212\fP: Base and extra headers are properly combined when making replicator
requests that contain duplicate headers.
.IP \(bu 2
\fI\%#3201\fP: When using a POST with request body to pass parameters to a view\-like
request, the boolean parameters are accepting only JSON strings, but not booleans.
Now, CouchDB accepts \fBtrue\fP and \fBfalse\fP for the \fBstable\fP parameter, in addition
to \fB\(dqtrue\(dq\fP and \fB\(dqfalse\(dq\fP\&.
comment in
.IP \(bu 2
\fI\%#1988\fP: Attachment operations \fBPUT /db/doc\fP and \fBPOST /db\fP now perform
consistent attachment name validation.
.IP \(bu 2
\fI\%#3249\fP: Documents with lots of conflicts no longer blow up couchjs if the
user calls \fB_changes\fP with a JS filter and with \fBstyle=all_docs\fP\&.
.IP \(bu 2
\fI\%#3144\fP: Respawning compaction jobs to catch up with intervening changes are
now handled correctly by the smoosh monitor.
.IP \(bu 2
\fI\%#3252\fP: CouchDB now exports the \fBcouch_util:json_decode/2\fP function to
support maps instead of the default data structure.
.IP \(bu 2
\fI\%#3255\fP, \fI\%#2558\fP: View files that have incorrect \fBdb_headers\fP
now reset the index forcing a rebuild.
.IP \(bu 2
\fI\%#3271\fP: Attachments that are stored uncompressed but later replicated to
nodes that compress the attachment no longer fail an internal md5 check that would
break eventual consistency between nodes.
.IP \(bu 2
\fI\%#3277\fP: \fBreq_body\fP requests that have \fBreq_body\fP set already now
properly return the field without parsing.
.IP \(bu 2
\fI\%#3279\fP: Some default headers were missing from some responses in replication,
including \fBX\-CouchDB\-Body\-Time\fP and \fBX\-Couch\-Request\-ID\fP\&.
.IP \(bu 2
\fI\%#3329\fP, \fI\%#2962\fP: CouchDB no longer returns broken couchjs processes
to the internal viewserver process pool.
.IP \(bu 2
\fI\%#3340\fP, \fI\%#1943\fP: \fBPUTs\fP of \fBmultipart/related\fP attachments now
support a \fBTransfer\-Encoding\fP value of \fBchunked\fP\&. Hooray!
.IP \(bu 2
\fI\%#2858\fP, \fI\%#3359\fP: The cluster setup wizard no longer fails when a
request to \fB/\fP is not made before a request to \fBfinish_cluster\fP\&.
.IP \(bu 2
\fI\%#3368\fP: Changing the \fBmax_dbs_open\fP configuration setting correctly
ensures that each new \fBcouch_server_X\fP property receives \fB1/num_servers()\fP of it.
.IP \(bu 2
\fI\%#3373\fP: Requests to \fB{db}/_changes\fP with a custom filter no longer result
in a fabric request timeout if the request body is not available to additional cluster
nodes, resulting in a more descriptive exit message and proper JSON object validation
in the payload.
.IP \(bu 2
\fI\%#3409\fP: The internal \fBchttpd_external:json_req_obj/2\fP function now reads
the cached \fBpeer\fP before falling back to a socket read operation.
.IP \(bu 2
\fI\%#3335\fP, \fI\%#3617\fP, \fI\%#3708\fP: The \fBCOUCHDB_FAUXTON_DOCROOT\fP
environment variable is now introduced to allow its explicit overriding at startup.
.IP \(bu 2
\fI\%#3471\fP: http clients should no longer receive stacktraces unexpectedly.
.IP \(bu 2
\fI\%#3491\fP: libicu tests no longer fail on older OS releases such as CentOS 6
and 7.
.IP \(bu 2
\fI\%#3541\fP: Usernames and passwords can now contain \fI@\fP and not break the
CouchDB replicator.
.IP \(bu 2
\fI\%#3545\fP: The \fBdreyfus_index_manager\fP process now supports offheap message
queues.
.IP \(bu 2
\fI\%#3551\fP: The replication worker pool now properly cleans up worker processes
as they are done via the \fBworker_trap_exits = false\fP setting.
.IP \(bu 2
\fI\%#3633\fP, \fI\%#3631\fP: All code paths for creating databases now fully
respect db creation options, including partitioning options.
.IP \(bu 2
\fI\%#3424\fP, \fI\%#3362\fP: When using \fBlatest=true\fP and an old revision with
conflicting children as rev is specified, CouchDB no longer returns an \fB\(dqerror\(dq:
\(dqcase_clause\(dq\fP response.
.IP \(bu 2
\fI\%#3673\fP: Non\-existent attachments now return a \fB404\fP when the attachment
is missing.
.IP \(bu 2
\fI\%#3698\fP: The \fBdev/run\fP development script now allows clusters where \fBn >
5\fP\&.
.IP \(bu 2
\fI\%#3700\fP: The \fBmaybe_close\fP message is now sent to the correct internal
process.
.IP \(bu 2
\fI\%#3183\fP: The smoosh operator guide now recommends to use the \fBrpc:multicall\fP
function.
.IP \(bu 2
\fI\%#3712\fP: Including a payload within a \fBDELETE\fP operation no longer hangs
the next request made to the same mochiweb acceptor.
.IP \(bu 2
\fI\%#3715\fP: For clusters with databases where \fBn > [cluster] n\fP, attachments
chunks are longer dropped on quorum writes.
.IP \(bu 2
\fI\%#3507\fP: If a file is truncated underneath CouchDB, CouchDB will now log
the filename if it finds this situation with a \fBfile_truncate_error\fP\&.
.IP \(bu 2
\fI\%#3739\fP: Shards with large purge sequences no longer fail to split in a
shard splitting job.
.IP \(bu 2
\fI\%#3754\fP: Always return views meta info when \fBlimit=0\fP and
\fBsorted=true\fP\&.
.IP \(bu 2
\fI\%#3757\fP: Properly sort \fBdescending=true\fP view results with a \fBkeys\fP
list.
.IP \(bu 2
\fI\%#3763\fP: Stabilize view row sorting order when they are merged by the
coordinator.
.UNINDENT
.SS Other
.INDENT 0.0
.IP \(bu 2
Donuts for everyone! Er, not really \- thank you for reading the 3.2 release notes.
.UNINDENT
.SS 3.1.x Branch
.INDENT 0.0
.IP \(bu 2
\fI\%Version 3.1.2\fP
.IP \(bu 2
\fI\%Version 3.1.1\fP
.IP \(bu 2
\fI\%Version 3.1.0\fP
.UNINDENT
.SS Version 3.1.2
.sp
This is a security release for a \fIlow severity\fP vulnerability. Details of
the issue will be published one week after this release. See the \fI\%CVE
database\fP
for details at a later time.
.SS Version 3.1.1
.SS Features and Enhancements
.INDENT 0.0
.IP \(bu 2
\fI\%#3102\fP, \fI\%#1600\fP, \fI\%#2877\fP, \fI\%#2041\fP: When a
client disconnects unexpectedly, CouchDB will no longer log a “\fBnormal :
unknown\fP” error. Bring forth the rainbows.
.UNINDENT
.INDENT 0.0
.INDENT 2.5
[image: The Gravity Falls gnome pukes some rainbows for us.]
[image]
.UNINDENT
.UNINDENT
.INDENT 0.0
.IP \(bu 2
\fI\%#3109\fP: Drilldown parameters for text index searches may now be
specified as a list of lists, to avoid having to define this redundantly
in a single query. (Some languages don’t have this facility.)
.IP \(bu 2
\fI\%#3132\fP: The new \fB[chttpd] buffer_response\fP option can be enabled
to delay the start of a response until the end has been calculated. This
increases memory usage, but simplifies client error handling as it
eliminates the possibility that a response may be deliberately
terminated midway through, due to a timeout. This config value may be
changed at runtime, without impacting any in\-flight responses.
.UNINDENT
.SS Performance
.SS Bugfixes
.INDENT 0.0
.IP \(bu 2
\fI\%#2935\fP: The replicator now correctly picks jobs to restart during
rescheduling, where previously with high load it may have failed to try to
restart crashed jobs.
.IP \(bu 2
\fI\%#2981\fP: When handling extremely large documents (≥50MB), CouchDB
can no longer time out on a \fBgen_server:call\fP if bypassing the IOQ.
.IP \(bu 2
\fI\%#2941\fP: CouchDB will no longer fail to compact databases if it
finds files from a 2.x compaction process (prior to an upgrade) on disk.
.IP \(bu 2
\fI\%#2955\fP CouchDB now sends the correct CSP header to ensure
Fauxton operates correctly with newer browsers.
.IP \(bu 2
\fI\%#3061\fP, \fI\%#3080\fP: The \fIcouch_index\fP server won’t crash
and log errors if a design document is deleted while that index is
building, or when a ddoc is added immediately after database creation.
.IP \(bu 2
\fI\%#3078\fP: CouchDB now checks for and complains correctly about
invalid parameters on database creation.
.IP \(bu 2
\fI\%#3090\fP: CouchDB now correctly encodes URLs correctly when
encoding the \fBatts_since\fP query string.
.IP \(bu 2
\fI\%#2953\fP: Some parameters not allowed for text\-index queries on
partitioned database are now properly validated and rejected.
.IP \(bu 2
\fI\%#3118\fP: Text\-based search indexes may now be cleaned up
correctly, even if the design document is now invalid.
.IP \(bu 2
\fI\%#3121\fP: \fBfips\fP is now only reported in the welcome message
if FIPS mode was enabled at boot (such as in \fBvm.args\fP).
.IP \(bu 2
\fI\%#3128\fP: Using \fI\%COPY\fP to copy a document will no longer
return a JSON result with two \fBok\fP fields.
.IP \(bu 2
\fI\%#3138\fP: Malformed URLs in replication requests or documents
will no longer throw an error.
.UNINDENT
.SS Other
.INDENT 0.0
.IP \(bu 2
JS tests skip faster now.
.IP \(bu 2
More JS tests ported into elixir: \fBreader_acl\fP, \fBreduce_builtin\fP,
\fBreduce_false\fP, \fBrev_stemming\fP, \fBupdate_documents\fP,
\fBview_collation_raw\fP, \fBview_compaction\fP, all the
\fBview_multi_key\fP tests, \fBview_sandboxing\fP,
\fBview_update_seq\fP\&.
.UNINDENT
.SS Version 3.1.0
.SS Features and Enhancements
.INDENT 0.0
.IP \(bu 2
\fI\%#2648\fP: Authentication via \fI\%JSON Web Token (JWT)\fP\&. Full
documentation is at the friendly link.
.IP \(bu 2
\fI\%#2770\fP: CouchDB now supports linking against SpiderMonkey 68, the current
Mozilla SpiderMonkey ESR release. This provides direct support for packaging on the
latest operating system variants, including Ubuntu 20.04 “Focal Fossa.”
.IP \(bu 2
.INDENT 2.0
.TP
.B A new Fauxton release is included, with updated dependencies, and a new optional
CouchDB news page.
.UNINDENT
.UNINDENT
.SS Performance
.INDENT 0.0
.IP \(bu 2
\fI\%#2754\fP: Optimized compactor performance, resulting in a 40% speed improvement
when document revisions approach the \fBrevs_limit\fP\&. The fixes also include additional
metrics on size tracking during the sort and copy phases, accessible via the
\fI\%GET /_active_tasks\fP endpoint.
.IP \(bu 2
A big bowl of candy! OK, no, not really. If you got this far…thank you for reading.
.UNINDENT
.SS 3.0.x Branch
.INDENT 0.0
.IP \(bu 2
\fI\%Upgrade Notes\fP
.IP \(bu 2
\fI\%Version 3.0.1\fP
.IP \(bu 2
\fI\%Version 3.0.0\fP
.UNINDENT
.SS Upgrade Notes
.INDENT 0.0
.IP \(bu 2
\fI\%#2228\fP: The default maximum document size has been reduced to 8MB. This means
that databases with larger documents will not be able to replicate into CouchDB 3.0
correctly without modification. This change has been made in preparation for
anticipated hard upper limits on document size imposed by CouchDB 4.0. For 3.x,
the max document size setting can be relaxed via the \fB[couchdb] max_document_size\fP
config setting.
.IP \(bu 2
\fI\%#2228\fP: The default database sharding factor \fBq\fP has been reduced to 2 by
default. This, combined with automated database resharding (see below), is a better
starting place for new CouchDB databases. As in CouchDB 2.x, specify \fB?q=#\fP to
change the value upon database creation if desired. The default can be changed
via the config \fB[cluster] q\fP setting.
.IP \(bu 2
\fI\%#1523\fP, \fI\%#2092\fP, \fI\%#2336\fP, \fI\%#2475\fP: The “node\-local”
HTTP interface, by default exposed on port 5986, has been removed. All functionality
previously available at that port is now available on the main, clustered interface (by
default, port 5984). Examples:
.INDENT 2.0
.INDENT 3.5
.sp
.nf
.ft C
GET /_node/{nodename}/_stats
GET /_node/{nodename}/_system
GET /_node/{nodename}/_all_dbs
GET /_node/{nodename}/_uuids
GET /_node/{nodename}/_config
GET /_node/{nodename}/_config/couchdb/uuid
POST /_node/{nodename}_config/_reload
GET /_node/{nodename}/_nodes/_changes?include_docs=true
PUT /_node/{nodename}/_dbs/{dbname}
POST /_node/{nodename}/_restart
GET /_node/{nodename}/{db\-shard}
GET /_node/{nodename}/{db\-shard}/{doc}
GET /_node/{nodename}/{db\-shard}/{ddoc}/_info
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
…and so on. Documentation has been updated to reflect this change.
.sp
\fBWARNING:\fP
.INDENT 2.0
.INDENT 3.5
The _node endpoint is for adminstrative purposes it is NOT
intended as an alternative to the regular endpoints (“GET
/dbname”, “PUT /dbname/docid” and so on)
.UNINDENT
.UNINDENT
.IP \(bu 2
\fI\%#2389\fP: CouchDB 3.0 now requires a server admin user to be defined at
startup, or will print an error message and exit. If you do not have one, be sure
to \fI\%create an admin user\fP\&. (The Admin Party is now over.)
.UNINDENT
.INDENT 0.0
.INDENT 2.5
[image: Dizzy the cat with a Santa hat.]
[image]
CC\-BY\-NC 2.0: \fI\%hehaden @ Flickr\fP.UNINDENT
.UNINDENT
.INDENT 0.0
.IP \(bu 2
\fI\%#2576\fP: CouchDB 3.0 now requires admin\-level access for the \fB/_all_dbs\fP
endpoint.
.IP \(bu 2
\fI\%#2339\fP: All databases are now created by default as admin\-only. That is, the
default new database \fB_security\fP object is now:
.INDENT 2.0
.INDENT 3.5
.sp
.nf
.ft C
{
  \(dqmembers\(dq : { \(dqroles\(dq : [ \(dq_admin\(dq ] },
   \(dqadmins\(dq : { \(dqroles\(dq : [ \(dq_admin\(dq ] }
}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
This can be changed after database creation.
.IP \(bu 2
Due to code changes in \fI\%#2324\fP, it is not possible to upgrade transparently from
CouchDB 1.x to 3.x. In addition, the \fBcouchup\fP utility has been removed from CouchDB
3.0 by \fI\%#2399\fP\&. If you are upgrading from CouchDB 1.x, you must first upgrade
to CouchDB 2.3.1 to convert your database and indexes, using \fBcouchup\fP if desired.
You can then upgrade to CouchDB 3.0. Or, you can start a new CouchDB 3.0 installation
and replicate directly from 1.x to 3.0.
.IP \(bu 2
\fI\%#1833\fP, \fI\%#2358\fP, \fI\%#1871\fP, \fI\%#1857\fP: CouchDB 3.0 supports
running only under the following Erlang/OTP versions:
.INDENT 2.0
.IP \(bu 2
19.x \- “soft” support only. No longer tested, but should work.
.IP \(bu 2
20.x \- must be newer than 20.3.8.11 (20.0, 20.1, 20.2 versions all invalid)
.IP \(bu 2
21.x \- for 21.2, must be newer than 21.2.3
.IP \(bu 2
22.x \- for 22.0, must be newer than 22.0.5
.UNINDENT
.IP \(bu 2
\fI\%#1804\fP: By default, views are limited to return a maximum of 2**28 (268435456)
results. This limit can be configured separately for views and partitioned views via
the \fBquery_limit\fP and \fBpartition_query_limit\fP values in the ini file
\fB[query_server_config]\fP section.
.IP \(bu 2
After upgrading all nodes in a cluster to 3.0, add \fB[rexi] use_kill_all = true\fP to
\fBlocal.ini\fP to save some intra\-cluster network bandwidth.
.UNINDENT
.SS Deprecated feature removal
.sp
The following features, deprecated in CouchDB 2.x, have been removed or replaced in
CouchDB 3.0:
.INDENT 0.0
.IP \(bu 2
\fI\%#2089\fP, \fI\%#2128\fP, \fI\%#2251\fP: Local endpoints for replication
targets, which never functioned as expected in CouchDB 2.x, have been completely
removed. When replicating databases, always specify a full URL for the source and
target. In addition, the node local \fB_replicator\fP database is no longer automatically
created.
.IP \(bu 2
\fI\%#2163\fP: The \fBdisk_size\fP and \fBdata_size\fP fields have been retired from the
database info object returned by \fBGET /{db}/\fP\&. These were deprecated in CouchDB 2.x
and replaced by the \fBsizes\fP object, which contains the improved \fBfile\fP,
\fBactive\fP and \fBexternal\fP size metrics. Fauxton has been updated to match.
.IP \(bu 2
\fI\%#2173\fP: The ability to submit multiple queries against a view using
the \fI\%POST\fP to \fB/{db}/_design/{ddoc}/_view/{view}\fP with the
\fB?queries=\fP option has been replaced by the new \fI\%queries\fP endpoint. The same is true of the
\fI\%_all_docs, _design_docs, and _local_docs\fP endpoints.
Specify a \fBkeys\fP object when \fI\%POST\fP\-ing to these endpoints.
.IP \(bu 2
\fI\%#2248\fP: CouchDB externals (\fB_external/\fP) have been removed entirely.
.IP \(bu 2
\fI\%#2208\fP: CouchDB no longer supports the \fBdelayed_commits\fP option in the
configuration file. All writes are now full commits. The \fB/_ensure_full_commit\fP
API endpoint has been retained (as a no\-op) for backwards compatibility with old
CouchDB replicators.
.IP \(bu 2
\fI\%#2395\fP: The security object in the \fB_users\fP database cannot be edited by
default. A setting exists in the configuration file to revert this behaviour. The
ability to override the disable setting is expected to be removed in CouchDB 4.0.
.UNINDENT
.SS Deprecated feature warnings
.sp
The following features are deprecated in CouchDB 3.0 and will be removed in CouchDB 4.0:
.INDENT 0.0
.IP \(bu 2
Show functions (\fB/{db}/{ddoc}/_show\fP)
.IP \(bu 2
List functions (\fB/{db}/{ddoc}/_list\fP)
.IP \(bu 2
Update functions (\fB/{db}/{ddoc}/_update\fP)
.IP \(bu 2
Virtual hosts and ini\-file rewrites
.IP \(bu 2
Rewrite functions (\fB/{db}/{ddoc}/_rewrite\fP)
.UNINDENT
.SS Version 3.0.1
.SS Features and Enhancements
.INDENT 0.0
.IP \(bu 2
Fauxton was updated to version \fIv1.2.3\fP\&.
.UNINDENT
.SS Bugfixes
.INDENT 0.0
.IP \(bu 2
\fI\%#2441\fP: A memory leak when encoding large binary content was patched.
This should resolve a long\-standing gradual memory increase bug in CouchDB.
.IP \(bu 2
\fI\%#2613\fP: Simultaneous attempts to create the same new database should
no longer result in a \fI\%500 Internal Server Error\fP error.
.IP \(bu 2
\fI\%#2678\fP: Defaults for the \fBsmoosh\fP compaction daemon are now consistent
with the shipped \fBdefault.ini\fP file.
.IP \(bu 2
\fI\%#2680\fP: The Windows CouchDB startup batch file will no longer fail to
start CouchDB if incompatible versions of OpenSSL are on the \fBPATH\fP\&.
.IP \(bu 2
\fI\%#2741\fP: A small performance improvement in the \fBcouch_server\fP process
was made.
.IP \(bu 2
\fI\%#2745\fP: The \fBrequire_valid_user\fP exception logic was corrected.
.IP \(bu 2
\fI\%#2643\fP: The \fBusers_db_security_editable\fP setting is now in the correct
section of the \fBdefault.ini\fP file.
.IP \(bu 2
\fI\%#2654\fP: Filtered changes feeds that need to rewind partially should no
longer rewind all the way to the beginning of the feed.
.IP \(bu 2
\fI\%#2655\fP: When deleting a session cookie, CouchDB should now respect the
operator\-specified cookie domain, if set.
.IP \(bu 2
\fI\%#2690\fP: Nodes that re\-enter a cluster after a database was created (while
the node was offline or in maintenance mode) should more correctly handle
creating local replicas of that database.
.IP \(bu 2
\fI\%#2805\fP: Mango operators more correctly handle being passed empty arrays.
.IP \(bu 2
\fI\%#2716\fP, \fI\%#2738\fP: The \fBremsh\fP utility will now try and guess the
node name and Erlang cookie of the local installation. It will also respect the
\fBCOUCHDB_ARGS_FILE\fP environment variable.
.IP \(bu 2
\fI\%#2797\fP: The cluster setup workflow now uses the correct logging module.
.IP \(bu 2
\fI\%#2818\fP: Mango now uses a safer method of bookmark creation that prevents
unexpectedly creating new Erlang atoms.
.IP \(bu 2
\fI\%#2756\fP: SpiderMonkey 60+ will no longer corrupt UTF\-8 strings when
various JS functions are applied to them.
.IP \(bu 2
Multiple test case improvements, including more ports of JS tests to Elixir.
.UNINDENT
.SS Version 3.0.0
.SS Features and Enhancements
.INDENT 0.0
.IP \(bu 2
\fI\%#1789\fP: \fI\%User\-defined partitioned databases\fP\&.
.sp
These special databases support user\-driven placement of documents into the same
shard range. \fI\%JavaScript views\fP and \fI\%Mango
indexes\fP have specific optimizations for partitioned databases
as well.
.sp
Two tweakable configuration parameters exist:
.INDENT 2.0
.IP \(bu 2
\fI\%#1842\fP: Partition size limits. By default, each partition is limited
to 10 GiB.
.IP \(bu 2
\fI\%#1684\fP: Partitioned database support can be disabled via feature
flag in \fBdefault.ini\fP\&.
.UNINDENT
.IP \(bu 2
\fI\%#1972\fP, \fI\%#2012\fP: \fI\%Automated shard splitting\fP\&.  Databases can now be re\-sharded \fIwhile online\fP
to increase the \fBq\fP factor to a larger number. This can be configured to
require specific node and range parameters upon execution.
.IP \(bu 2
\fI\%#1910\fP: \fI\%Automatic background indexing\fP,
internally known as \fBken\fP\&. This subsystem ensures secondary indexes (such
as JavaScript, Mango, and text search) are kept up to date, without requiring
an external query to trigger building them. Many configuration parameters are
available.
.IP \(bu 2
\fI\%#1904\fP: Completely rewritten \fI\%automatic compaction daemon\fP, internally known as \fBsmoosh\fP\&. This subsystem automatically
triggers background compaction jobs for both databases and views, based on
\fI\%configurable thresholds\fP\&.
.IP \(bu 2
\fI\%#1889\fP, \fI\%#2408\fP: New IO Queue subsystem implementation.
This is \fI\%highly configurable and well\-documented\fP\&.
.IP \(bu 2
\fI\%#2436\fP, \fI\%#2455\fP: CouchDB now regression tests against, and officially
supports, running on the \fBarm64v8\fP (\fBaarch64\fP) and \fBppc64le\fP (\fBppc64el\fP)
machine architectures. Convenience binaries are generated on these architectures for
Debian 10.x (“buster”) packages, and for the Docker containers.
.IP \(bu 2
\fI\%#1875\fP, \fI\%#2437\fP, \fI\%#2423\fP: CouchDB now supports linking against
SpiderMonkey 60 or SpiderMonkey 1.8.5. SpiderMonkey 60 provides enhanced support for
ES5, ES6, and ES2016+. Full compatibility information is available at the
\fI\%ECMAScript compatibility table\fP\&. Click on “Show obsolete platforms”, then look for
“FF 60 ESR” in the list of engine types.
.sp
However, it was discovered that on some ARM 64\-bit distributions, SM 60 segfaults
frequently, including the SM 60 packages on CentOS 8 and Debian 10.
.sp
As a result, CouchDB’s convenience binaries \fBonly link against SM 60 on the
\(ga\(gax86_64\(ga\(ga and \(ga\(gappc64le\(ga\(ga architectures\fP\&. This includes the Docker image for these
architectures.
.sp
At present, CouchDB ships with SM 60 linked in on the following binary distributions:
.INDENT 2.0
.IP \(bu 2
Debian buster (10.x)
.IP \(bu 2
CentOS / RedHat 8.x
.IP \(bu 2
macOS (10.10+)
.IP \(bu 2
Windows (7+)
.IP \(bu 2
Docker (3.0.0)
.IP \(bu 2
FreeBSD (CURRENT)
.UNINDENT
.sp
We expect to add SM 60 support to Ubuntu with Focal Fossa (20.04 LTS) when it ships in
April 2020.
.sp
It is unlikely we will backport SM 60 packages to older versions of Debian, CentOS,
RedHat, or Ubuntu.
.IP \(bu 2
The Windows installer has many improvements, including:
.INDENT 2.0
.IP \(bu 2
Prompts for an admin user/password as CouchDB 3.0 requires
* Will not overwrite existing credentials if in place
.IP \(bu 2
No longer remove user\-modified config files, closing \fI\%#1989\fP
* Also will not overwrite them on install.
.IP \(bu 2
Checkbox to disable installation of the Windows service
.IP \(bu 2
\fI\%Silent install support\fP\&.
.IP \(bu 2
Friendly link to these online release notes in the exit dialog
.IP \(bu 2
Higher resolution icon for HiDPI (500x500)
.UNINDENT
.UNINDENT
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
Windows 8, 8.1, and 10 require the \fI\%\&.NET Framework v3.5\fP to be installed.
.UNINDENT
.UNINDENT
.INDENT 0.0
.IP \(bu 2
\fI\%#2037\fP: Dreyfus, the CouchDB side of the Lucene\-powered search solution, is now
shipped with CouchDB. When one or more Clouseau Java nodes are joined to the cluster,
text\-based indexes can be enabled in CouchDB. It is recommended to have as many Clouseau
nodes as you have CouchDB nodes. Search is advertised in the feature list present at
\fBGET /\fP if configured correctly (\fI\%#2206\fP).  \fI\%Configuration\fP and \fI\%installation documentation is available\fP\&.
.IP \(bu 2
\fI\%#2411\fP: The \fB/_up\fP endpoint no longer requires authentication, even when
\fBrequire_valid_user\fP is \fBtrue\fP\&.
.IP \(bu 2
\fI\%#2392\fP: A new \fB_metrics\fP role can be given to a user. This allows that
user access only to the \fB/_node/{node}/_stats\fP and \fB/_node/{node}/_system\fP
endpoints.
.IP \(bu 2
\fI\%#1912\fP: A new alternative \fBsystemd\-journald logging\fP backend has been added,
and can be enabled through the ini file. The new backend does not include CouchDB’s
microsecond\-accurate timestamps, and uses the \fBsd\-daemon(3)\fP logging levels.
.IP \(bu 2
\fI\%#2296\fP, \fI\%#1977\fP: If the configuration file setting \fB[couchdb]\fP
\fBsingle_node\fP is set to \fBtrue\fP, CouchDB will automatically create the system
databases on startup if they are not present.
.IP \(bu 2
\fI\%#2338\fP, \fI\%#2343\fP: \fI\%POST\fP request to CouchDB views and the
\fB/{db}/_all_docs\fP, \fB/{db}/_local_docs\fP and \fB/{db}/_design_docs\fP endpoints now
support the same functionality as \fI\%GET\fP\&.  Parameters are passed in the body as a
JSON object, rather than in the URL when using \fI\%POST\fP\&.
.IP \(bu 2
\fI\%#2292\fP: The \fB_scheduler/docs\fP and \fB_scheduler/info\fP endpoints now return
detailed replication stats for running and pending jobs.
.IP \(bu 2
\fI\%#2282\fP, \fI\%#2272\fP, \fI\%#2290\fP: CouchDB now supports specifying
separate proxies for both the \fBsource\fP and \fBtarget\fP in a replication via
\fBsource_proxy\fP and \fBtarget_proxy\fP keys. The \fI\%API documentation\fP has been updated.
.IP \(bu 2
\fI\%#2240\fP: Headers are now returned from the \fB/{db}/_changes\fP feed
immediately, even when there are no changes available. This avoids client
blocking.
.IP \(bu 2
\fI\%#2005\fP, \fI\%#2006\fP: The name of any node can now be retrieved through
the \fI\%new API endpoint\fP \fBGET /_node/{node\-name}\fP\&.
.IP \(bu 2
\fI\%#1766\fP: Timeouts for requests, \fBall_docs\fP, attachments, views, and
partitioned view requests can all be specified separately in the ini file under
the \fB[fabric]\fP section. See \fBdefault.ini\fP for more detail.
.IP \(bu 2
\fI\%#1963\fP: Metrics are now kept on the number of partition and global view
queries, along with the number of timeouts that occur.
.IP \(bu 2
\fI\%#2452\fP, \fI\%#2221\fP: A new configuration field \fB[couch_httpd_auth]
same_site\fP has been added to set the value of the CouchDB auth cookie’s \fBSameSite\fP
attribute.  It may be necessary to set this to \fBstrict\fP for compatibility with future
versions of Google Chrome. If CouchDB CORS support is enabled, set this to \fBNone\fP\&.
.UNINDENT
.SS Performance
.INDENT 0.0
.IP \(bu 2
\fI\%#2277\fP: The \fBcouch_server\fP process has been highly optimized, supporting
significantly more load than before.
.IP \(bu 2
\fI\%#2360\fP: It is now possible to make the rexi interface’s unacked message
limit configurable. A new, more optimized default (5, lowered from 10) has been set.
This results in a ~50% improvement on view queries on large clusters with \fBq ≥ 8\fP\&.
.IP \(bu 2
\fI\%#2280\fP: Connection sharing for replication now functions correctly when
replicating through a forward proxy. Closes \fI\%#2271\fP\&.
.IP \(bu 2
\fI\%#2195\fP, \fI\%#2207\fP: Metrics aggregation now supports CouchDB systems
that sleep or hibernate, ensuring that on wakeup does not trigger thousands of
unnecessary function calls.
.IP \(bu 2
\fI\%#1795\fP: Avoid calling \fBfabric:update_docs\fP with empty doc lists.
.IP \(bu 2
\fI\%#2497\fP: The setup wizard no longer automatically creates the
\fB_global_changes\fP database, as the majority of users do not need this
functionality. This reduces overall CouchDB load.
.UNINDENT
.SS Bugfixes
.INDENT 0.0
.IP \(bu 2
\fI\%#1752\fP, \fI\%#2398\fP, \fI\%#1803\fP: The cluster setup wizard now ensures
a consistent UUID and http secret across all nodes in a cluster. CouchDB admin passwords
are also synced when the cluster setup wizard is used. This prevents being logged out
when using Fauxton as a server admin user through a load balancer.
.IP \(bu 2
\fI\%#2388\fP: A compatibility change has been made to support replication with
future databases containing per\-document access control fields.
.IP \(bu 2
\fI\%#2379\fP: Any replicator error messages will provide an object in the response,
or null, but never a string.
.IP \(bu 2
\fI\%#2244\fP, \fI\%#2310\fP: CouchDB will no longer send more data than is
requested when retrieving partial attachment data blocks.
.IP \(bu 2
\fI\%#2138\fP: Manual operator updates to a database’s shard map will not
corrupt additional database properties, such as partitioning values.
.IP \(bu 2
\fI\%#1877\fP: The \fB_purge\fP and \fB_purged_infos_limit\fP endpoints are now
correctly restricted to server admin only.
.IP \(bu 2
\fI\%#1794\fP: The minimum purge sequence value for a database is now
gathered without a clustered \fB_all_docs\fP lookup.
.IP \(bu 2
\fI\%#2351\fP: A timeout case clause in \fBfabric_db_info\fP has been normalised
to match other case clauses.
.IP \(bu 2
\fI\%#1897\fP: The \fB/{db}/_bulk_docs\fP endpoint now correctly catches invalid
(\fIi.e.\fP, non\-hexadecimal) \fB_rev_\fP values and responds with a \fI\%400 Bad Request\fP error.
.IP \(bu 2
\fI\%#2321\fP: CouchDB no longer requires Basic auth credentials to reach the
\fB/_session\fP endpoint for login, even when \fBrequire_valid_user\fP is enabled.
.IP \(bu 2
\fI\%#2295\fP: CouchDB no longer marks a job as failed permanently if the
internal doc processor crashes.
.IP \(bu 2
\fI\%#2178\fP: View compaction files are now removed on view cleanup.
.IP \(bu 2
\fI\%#2179\fP: The error message logged when CouchDB does not have a \fB_users\fP
database is now less scary.
.IP \(bu 2
\fI\%#2153\fP: CouchDB no longer may return a \fBbadmatch\fP error when querying
\fBall_docs\fP with a passed \fBkeys\fP array.
.IP \(bu 2
\fI\%#2137\fP: If search is not available, return a \fI\%400 Bad Request\fP instead of a
\fI\%500 Internal Server Error\fP status code.
.IP \(bu 2
\fI\%#2077\fP: Any failed \fBfsync(2)\fP calls are now correctly raised to avoid
data corruption arising from retry attempts.
.IP \(bu 2
\fI\%#2027\fP: Handle epoch mismatch when duplicate UUIDs are created through
invalid operator intervention.
.IP \(bu 2
\fI\%#2019\fP: If a database is deleted and re\-created while internal cluster
replication is still active, CouchDB will no longer retry to delete it continuously.
.IP \(bu 2
\fI\%#2003\fP, \fI\%#2438\fP: CouchDB will no longer automatically reset an index
file if any attempt to read its header fails (such as when the couch_file process
terminates unexpectedly).  CouchDB now also handles the case when a view file lacks a
proper header.
.IP \(bu 2
\fI\%#1983\fP: Improve database “external” size calcuation to be more precise.
.IP \(bu 2
\fI\%#1971\fP: Correctly compare ETags using weak comparison methods to support
\fIW/\fP prefix added by some load balancer configurations.
.IP \(bu 2
\fI\%#1901\fP: Invalid revision specified for a document update will no longer result
in a \fBbadarg\fP crash.
.IP \(bu 2
\fI\%#1845\fP: The \fBend_time\fP field in \fB/_replicate\fP now correctly converts time
to UTC.
.IP \(bu 2
\fI\%#1824\fP: \fBrexi\fP stream workers are now cleaned up when the coordinator process
is killed, such as when the ddoc cache is refreshed.
.IP \(bu 2
\fI\%#1770\fP: Invalid database \fB_security\fP objects no longer return a
\fBfunction_clause\fP error and stack trace.
.IP \(bu 2
\fI\%#2412\fP: Mango execution stats now correctly count documents read which weren’t
followed by a match within a given shard.
.IP \(bu 2
\fI\%#2393\fP, \fI\%#2143\fP: It is now possible to override the query server
environment variables \fBCOUCHDB_QUERY_SERVER_JAVASCRIPT\fP and
\fBCOUCHDB_QUERY_SERVER_COFFEESCRIPT\fP without overwriting the
\fBcouchdb\fP/\fBcouchdb.cmd\fP startup scripts.
.IP \(bu 2
\fI\%#2426\fP, \fI\%#2415\fP: The replicator now better handles the situation where
design document writes to the target fail when replicating with non\-admin credentials.
.IP \(bu 2
\fI\%#2444\fP, \fI\%#2413\fP: Replicator error messages are now significantly
improved, reducing \fBfunction_clause\fP responses.
.IP \(bu 2
\fI\%#2454\fP: The replication auth session plugin now ignores other cookies it may
receive without logging an error.
.IP \(bu 2
\fI\%#2458\fP: Partitioned queries and dreyfus search functions no longer fail
if there is a single failed node or rexi worker error.
.IP \(bu 2
\fI\%#1783\fP: Mango text indexes no longer error when given an empty selector or
operators with empty arrays.
.IP \(bu 2
\fI\%#2466\fP: Mango text indexes no longer error if the indexed document revision
no longer exists in the primary index.
.IP \(bu 2
\fI\%#2486\fP: The \fB$lt\fP, \fB$lte\fP, \fB$gt\fP, and \fB$gte\fP Mango operators are
correctly quoted internally when used in conjunction with a text index search.
.IP \(bu 2
\fI\%#2493\fP: The \fBcouch_auth_cache\fP no longer has a runaway condition in which
it creates millions of monitors on the \fB_users\fP database.
.UNINDENT
.SS Other
.sp
The 3.0.0 release also includes the following minor improvements:
.INDENT 0.0
.IP \(bu 2
\fI\%#2472\fP: CouchDB now logs the correct, clustered URI at startup (by default:
port \fB5984\fP\&.)
.IP \(bu 2
\fI\%#2034\fP, \fI\%#2416\fP: The path to the Fauxton installation can now be
specified via the \fBCOUCHDB_FAUXTON_DOCROOT\fP environment variable.
.IP \(bu 2
\fI\%#2447\fP: Replication stats are both persisted when jobs are re\-created, as well
as properly handled when bulk document batches are split.
.IP \(bu 2
\fI\%#2410\fP, \fI\%#2390\fP, \fI\%#1913\fP: Many metrics were added for Mango
use, including counts of unindexed queries, invalid index queries, docs examined that
do and don’t meet cluster quorum, query time, etc.
.IP \(bu 2
\fI\%#2152\fP, \fI\%#2504\fP: CouchDB can now be started via a symlink to the
binary on UNIX\-based platforms.
.IP \(bu 2
\fI\%#1844\fP: A new internal API has been added to write custom Erlang
request\-level metrics reporting plugins.
.IP \(bu 2
\fI\%#2293\fP, \fI\%#1095\fP: The \fB\-args_file\fP, \fB\-config\fP and \fB\-couch_ini\fP
parameters may now be overridden via the \fBCOUCHDB_INI_FILES\fP environment variable
on UNIX\-based systems.
.IP \(bu 2
\fI\%#2352\fP: The \fBremsh\fP utility now searches for the Erlang cookie in
\fBERL_FLAGS\fP as well as \fBvm.args\fP\&.
.IP \(bu 2
\fI\%#2324\fP: All traces of the (never fully functional) view\-based \fB_changes\fP
feed have been expunged from the code base.
.IP \(bu 2
\fI\%#2337\fP: The md5 shim (introduced to support FIPS\-compliance) is now
used consistently throughout the code base.
.IP \(bu 2
\fI\%#2270\fP: Negative and non\-integer \fBheartbeat\fP values now return
\fI\%400 Bad Request\fP\&.
.IP \(bu 2
\fI\%#2268\fP: When rescheduling jobs, CouchDB now stops sufficient running jobs
to make room for the pending jobs.
.IP \(bu 2
\fI\%#2186\fP: CouchDB plugin writers have a new field in which endpoint
credentials may be stashed for later use.
.IP \(bu 2
\fI\%#2183\fP: \fBdev/run\fP now supports an \fB\-\-extra\-args\fP flag to modify the
Erlang runtime environment during development.
.IP \(bu 2
\fI\%#2105\fP: \fBdev/run\fP no longer fails on unexpected remote end connection
close during cluster setup.
.IP \(bu 2
\fI\%#2118\fP: Improve \fBcouch_epi\fP process replacement mechanism using map
childspecs functionality in modern Erlang.
.IP \(bu 2
\fI\%#2111\fP: When more than \fBMaxJobs\fP replication jobs are defined, CouchDB
now correctly handles job rotation when some jobs crash.
.IP \(bu 2
\fI\%#2020\fP: Fix full ring assertion in fabric stream shard replacements
.IP \(bu 2
\fI\%#1925\fP: Support list for docid when using \fBcouch_db:purge_docs/3\fP\&.
.IP \(bu 2
\fI\%#1642\fP: \fBio_priority\fP is now set properly on view update and compaction
processes.
.IP \(bu 2
\fI\%#1865\fP: Purge now supports >100 document IDs in a single request.
.IP \(bu 2
\fI\%#1861\fP: The \fBvm.args\fP file has improved commentary.
.IP \(bu 2
\fI\%#1808\fP: Pass document update type for additional checks in
\fBbefore_doc_update\fP\&.
.IP \(bu 2
\fI\%#1835\fP: Module lists are no longer hardcoded in \fB\&.app\fP files.
.IP \(bu 2
\fI\%#1798\fP, \fI\%#1933\fP: Multiple compilation warnings were eliminated.
.IP \(bu 2
\fI\%#1826\fP: The \fBcouch_replicator_manager\fP shim has been fully removed.
.IP \(bu 2
\fI\%#1820\fP: After restarting CouchDB, JS and Elixir tests now wait up to 30s for
it to be ready before timing out.
.IP \(bu 2
\fI\%#1800\fP: \fBmake elixir\fP supports specifying individual tests to run with
\fBtests=\fP\&.
.IP \(bu 2
\fI\%#1805\fP: \fBdev/run\fP supports \fB\-\-with\-haproxy\fP again.
.IP \(bu 2
\fI\%#1774\fP: \fBdev/run\fP now supports more than 3 nodes.
.IP \(bu 2
\fI\%#1779\fP: Refactor Elixir test suite initialization.
.IP \(bu 2
\fI\%#1769\fP: The Elixir test suite uses Credo for static analysis.
.IP \(bu 2
\fI\%#1776\fP: All Python code is now formatted using \fI\%Python black\fP\&.
.IP \(bu 2
\fI\%#1786\fP: \fBdev/run\fP: do not create needless \fBdev/data/\fP directory.
.IP \(bu 2
\fI\%#2482\fP: A redundant \fBget_ring_opts\fP call has been removed from
\fBdreyfus_fabric_search\fP\&.
.IP \(bu 2
\fI\%#2506\fP: CouchDB’s release candidates no longer propagate the RC tags
into each Erlang application’s version string.
.IP \(bu 2
\fI\%#2511\fP: \fI\%recon\fP, the Erlang diagnostic toolkit, has been added to
CouchDB’s build process and ships in the release + convenience binaries.
.IP \(bu 2
Fauxton updated to v1.2.3, which includes:
.INDENT 2.0
.IP \(bu 2
Support multiple server\-generated warnings when running queries
.IP \(bu 2
Partitioned database support
.IP \(bu 2
Search index support
.IP \(bu 2
Remove references to deprecated dbinfo fields
.IP \(bu 2
Improve accessibility for screen readers
.IP \(bu 2
Numerous CSS fixes
.UNINDENT
.IP \(bu 2
Improved test cases:
.INDENT 2.0
.IP \(bu 2
Many, many test race conditions and bugs have been removed (PR list too long to
include here!)
.IP \(bu 2
More test cases were ported to Elixir, including:
.INDENT 2.0
.IP \(bu 2
Cluster with and without quorum tests (\fI\%#1812\fP)
.IP \(bu 2
\fBdelayed_commits\fP (\fI\%#1796\fP)
.IP \(bu 2
\fBmultiple_rows\fP (\fI\%#1958\fP)
.IP \(bu 2
\fBinvalid_docids\fP (\fI\%#1968\fP)
.IP \(bu 2
\fBreplication\fP (\fI\%#2090\fP)
.IP \(bu 2
All \fBattachment_*\fP tests (\fI\%#1999\fP)
.IP \(bu 2
\fBcopy_doc\fP (\fI\%#2000\fP)
.IP \(bu 2
\fBattachments\fP (\fI\%#1953\fP)
.IP \(bu 2
\fBerlang_views\fP (\fI\%#2237\fP)
.IP \(bu 2
\fBauth_cache\fP, \fBcookie_auth\fP, \fBlorem*\fP, \fBmultiple_rows\fP, \fBusers_db\fP,
\fButf8\fP (\fI\%#2394\fP)
.IP \(bu 2
\fBetags_head\fP (\fI\%#2464\fP, \fI\%#2469\fP)
.UNINDENT
.IP \(bu 2
\fI\%#2431\fP: \fBchttpd_purge_tests\fP have been improved in light of CI failures.
.IP \(bu 2
\fI\%#2432\fP: Address flaky test failure on \fBt_invalid_view/1\fP\&.
.IP \(bu 2
\fI\%#2363\fP: Elixir tests now run against a single node cluster, in line with
the original design of the JavaScript test suite. This is a permanent change.
.IP \(bu 2
\fI\%#1893\fP: Add “w:3” for lots of doc tests.
.IP \(bu 2
\fI\%#1939\fP, \fI\%#1931\fP: Multiple fixes to improve support in constrained
CI environments.
.IP \(bu 2
\fI\%#2346\fP: Big\-endian support for the \fBcouch_compress\fP tests.
.IP \(bu 2
\fI\%#2314\fP: Do not auto\-index when testing \fBupdate=false\fP in Mango.
.IP \(bu 2
\fI\%#2141\fP: Fix \fBcouch_views\fP encoding test.
.IP \(bu 2
\fI\%#2123\fP: Timeout added for \fBfold_docs\-with_different_keys\fP test.
.IP \(bu 2
\fI\%#2114\fP: EUnit tests now correctly inherit necessary environment
variables.
.IP \(bu 2
\fI\%#2122\fP: \fI:meck.unload()\fP is now called automatically after every test.
.IP \(bu 2
\fI\%#2098\fP: Fix \fBcpse_test_purge_replication\fP eunit test.
.IP \(bu 2
\fI\%#2085\fP, \fI\%#2086\fP: Fix a flaky \fBmem3_sync_event_listener\fP test.
.IP \(bu 2
\fI\%#2084\fP: Increase timeouts on two slow btree tests.
.IP \(bu 2
\fI\%#1960\fP, \fI\%#1961\fP: Fix for \fBchttpd_socket_buffer_size_test\fP\&.
.IP \(bu 2
\fI\%#1922\fP: Tests added for shard splitting functionality.
.IP \(bu 2
\fI\%#1869\fP: New test added for doc reads with etag \fBIf\-None\-Match\fP header.
.IP \(bu 2
\fI\%#1831\fP: Re\-introduced \fIcpse_test_purge_seqs\fP test.
.IP \(bu 2
\fI\%#1790\fP: Reorganise \fBcouch_flag_config_tests\fP into a proper suite.
.IP \(bu 2
\fI\%#1785\fP: Use \fBdevclean\fP on elixir target for consistency of Makefile.
.IP \(bu 2
\fI\%#2476\fP: For testing, \fBTriq\fP has been replaced with \fBPropEr\fP as an
optional dependency.
.UNINDENT
.IP \(bu 2
External dependency updates:
.INDENT 2.0
.IP \(bu 2
\fI\%#1870\fP: Mochiweb has been updated to 2.19.0.
.IP \(bu 2
\fI\%#1938\fP: Folsom has been updated to 0.8.3.
.IP \(bu 2
\fI\%#2001\fP: ibrowse has been updated to 4.0.1\-1.
.IP \(bu 2
\fI\%#2400\fP: jiffy has been updated to 1.0.1.
.UNINDENT
.IP \(bu 2
A llama! OK, no, not really. If you got this far…thank you for reading.
.UNINDENT
.SS 2.3.x Branch
.INDENT 0.0
.IP \(bu 2
\fI\%Upgrade Notes\fP
.IP \(bu 2
\fI\%Version 2.3.1\fP
.IP \(bu 2
\fI\%Version 2.3.0\fP
.UNINDENT
.SS Upgrade Notes
.INDENT 0.0
.IP \(bu 2
\fI\%#1602\fP: To improve security, there have been major changes in the
configuration of query servers, SSL support, and HTTP global handlers:
.INDENT 2.0
.INDENT 3.5
.INDENT 0.0
.IP 1. 3
Query servers
.UNINDENT
.sp
Query servers are NO LONGER DEFINED in the .ini files, and can
no longer be altered at run\-time.
.sp
The JavaScript and CoffeeScript query servers continue to be enabled
by default. Setup differences have been moved from default.ini to
the \fBcouchdb\fP and \fBcouchdb.cmd\fP start scripts respectively.
.sp
Additional query servers can now be configured using environment
variables:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
export COUCHDB_QUERY_SERVER_PYTHON=\(dq/path/to/python/query/server.py with args\(dq
couchdb
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
where the last segment in the environment variable (\fB_PYTHON\fP) matches
the usual lowercase(!) query language in the design doc
\fBlanguage\fP field (here, \fBpython\fP\&.)
.sp
Multiple query servers can be configured by using more environment
variables.
.sp
You can also override the default servers if you need to set command\-
line options (such as \fBcouchjs\fP stack size):
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
export COUCHDB_QUERY_SERVER_JAVASCRIPT=\(dq/path/to/couchjs /path/to/main.js \-S <STACKSIZE>\(dq
couchdb
.ft P
.fi
.UNINDENT
.UNINDENT
.INDENT 0.0
.IP 2. 3
Native Query Servers
.UNINDENT
.sp
The mango query server continues to be enabled by default. The Erlang
query server continues to be disabled by default. This change adds
a \fB[native_query_servers] enable_erlang_query_server = BOOL\fP setting
(defaults to \fBfalse\fP) to enable the Erlang query server.
.sp
If the legacy configuration for enabling the query server is detected,
that is counted as a \fBtrue\fP setting as well, so existing configurations
continue to work just fine.
.INDENT 0.0
.IP 3. 3
SSL Support
.UNINDENT
.sp
Enabling SSL support in the ini file is now easier:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[ssl]
enable = true
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If the legacy httpsd configuration is found in your ini file, this will
still enable SSL support, so existing configurations do not need to be
changed.
.INDENT 0.0
.IP 4. 3
HTTP global handlers
.UNINDENT
.sp
These are no longer defined in the default.ini file, but have been
moved to the couch.app context. If you need to customize your handlers,
you can modify the app context using a couchdb.config file as usual.
.UNINDENT
.UNINDENT
.IP \(bu 2
\fI\%#1602\fP: Also to improve security, the deprecated \fBos_daemons\fP and
\fBcouch_httpd_proxy\fP functionality has been completely removed ahead of the planned
CouchDB 3.0 release. We recommend the use of OS\-level daemons such as runit, sysvinit,
systemd, upstart, etc. to launch and maintain OS daemons instead, and the use of
a reverse proxy server in front of CouchDB (such as haproxy) to proxy access to other
services or domains alongside CouchDB.
.IP \(bu 2
\fI\%#1543\fP: The node\-local (default port 5986) \fB/_restart\fP endpoint has been
replaced by the clustered (default port 5984) endpoint \fB/_node/$node/_restart\fP and
\fB/_node/_local/_restart\fP endpoints. The node\-local endpoint has been removed.
.IP \(bu 2
\fI\%#1764\fP: All python scripts shipped with CouchDB, including \fBcouchup\fP and the
\fBdev/run\fP development cluster script, now specify and require Python 3.x.
.IP \(bu 2
\fI\%#1396\fP: CouchDB is now compatible with Erlang 21.x.
.IP \(bu 2
\fI\%#1680\fP: The embedded version of \fBrebar\fP used to build CouchDB has been
updated to the last version of \fBrebar2\fP available. This assists in building on
non\-x86 platforms.
.IP \(bu 2
\fI\%#1857\fP: Refuse building with known bad versions of Erlang.
.UNINDENT
.SS Version 2.3.1
.SS Features
.INDENT 0.0
.IP \(bu 2
\fI\%#1811\fP: Add new \fB/{db}/_sync_shards\fP endpoint (admin\-only).
.IP \(bu 2
\fI\%#1870\fP: Update to mochiweb 2.19.0. See also \fI\%#1875\fP\&.
.IP \(bu 2
\fI\%#1857\fP: Refuse building with known bad versions of Erlang.
.IP \(bu 2
\fI\%#1880\fP: Compaction: Add snooze_period_ms for finer tuning.
.UNINDENT
.SS Bugfixes
.INDENT 0.0
.IP \(bu 2
\fI\%#1795\fP: Filter out empty missing_revs results in \fBmem3_rep\fP\&.
.IP \(bu 2
\fI\%#1384\fP: Fix \fBfunction_clause\fP error on invalid DB \fB_security\fP objects.
.IP \(bu 2
\fI\%#1841\fP: Fix \fBend_time\fP field in \fB/_replicate\fP response.
.IP \(bu 2
\fI\%#1860\fP: Fix read repair in a mixed cluster environment.
.IP \(bu 2
\fI\%#1862\fP: Fix \fBfabric_open_doc_revs\fP\&.
.IP \(bu 2
\fI\%#1865\fP: Support purge requests with more than 100 doc ids.
.IP \(bu 2
\fI\%#1867\fP: Fix timeout in \fBchttpd_purge_tests\fP\&.
.IP \(bu 2
\fI\%#1766\fP: Add default fabric request timeouts.
.IP \(bu 2
\fI\%#1810\fP: Requests return 400 Bad Request when URL length exceeds 1460
characters. See \fI\%#1870\fP for details.
.IP \(bu 2
\fI\%#1799\fP: Restrict \fB_purge\fP to server admin.
.IP \(bu 2
\fI\%#1874\fP: This fixes inability to set keys with regex symbols in them.
.IP \(bu 2
\fI\%#1901\fP: Fix badarg crash on invalid rev for individual doc update.
.IP \(bu 2
\fI\%#1897\fP: Fix \fBfrom_json_obj_validate\fP crash when provided rev isn’t
a valid hex.
.IP \(bu 2
\fI\%#1803\fP: Use the same salt for admin passwords on cluster setup.
.IP \(bu 2
\fI\%#1053\fP: Fix python2 compatibility for \fBcouchup\fP\&.
.IP \(bu 2
\fI\%#1905\fP: Fix python3 compatibility for \fBcouchup\fP\&.
.UNINDENT
.SS Version 2.3.0
.SS Features
.INDENT 0.0
.IP \(bu 2
(Multiple) Clustered purge is now available. This feature restores the CouchDB 1.x
ability to completely remove any record of a document from a database. Conditions
apply; to use the feature safely, and for full details, read the complete
\fI\%Clustered Purge\fP documentation.
.IP \(bu 2
\fI\%#1658\fP: A new config setting is available, allowing an administrator to
configure an initial list of nodes that should be contacted when a node boots up.
Nodes in the \fBseedlist\fP that are successfully reached will be added to that node’s
\fB_nodes\fP database automatically, triggering a distributed Erlang connection and
replication of the internal system databases to the new node. This can be used instead
of manual config or the cluster setup wizard to bootstrap a cluster. The progress of
the initial seeding of new nodes is exposed at the \fBGET /_up\fP endpoint.
.IP \(bu 2
Replication supports ipv6\-only peers after updating ibrowse dependency.
.IP \(bu 2
\fI\%#1708\fP: The UUID of the server/cluster is once again exposed in the
\fBGET /\fP response. This was a regression from CouchDB 1.x.
.IP \(bu 2
\fI\%#1722\fP: Stats counts between job runs of the replicator are no longer reset
on job restart.
.IP \(bu 2
\fI\%#1195\fP, \fI\%#1742\fP: CouchDB’s \fB_bulk_get\fP implementation now supports
the \fBmultipart/mixed\fP and \fBmultipart/related\fP content types if requested,
extending compatibility with third\-party replication clients.
.UNINDENT
.SS Performance
.INDENT 0.0
.IP \(bu 2
\fI\%#1409\fP: CouchDB no longer forces the TCP receive buffer to a fixed size
of 256KB, allowing the operating system to dynamically adjust the buffer size. This
can lead to significantly improved network performance when transferring large
attachments.
.IP \(bu 2
\fI\%#1423\fP: Mango selector matching now occurs at the shard level, reducing the
network traffic within a cluster for a mango query.
.IP \(bu 2
\fI\%#1423\fP: Long running operations at the node level could exceed the inter\-node
timeout, leading to a fabric timeout error in the logfile and a cancellation of the
task. Nodes can now ping to stop that from happening.
.IP \(bu 2
\fI\%#1560\fP: An optimization to how external data sizes of attachments were
recorded was made.
.IP \(bu 2
\fI\%#1586\fP: When cleaning up outdated secondary index files, the search is limited
to the index directory of a specific database.
.IP \(bu 2
\fI\%#1593\fP: The \fBcouch_server\fP ETS table now has the \fBread_concurrency\fP
option set, improving access to the global list of open database handles.
.IP \(bu 2
\fI\%#1593\fP: Messages to update the least\-recently used (LRU) cache are not
sent when the \fB[couchdb] update_lru_on_read\fP setting is disabled.
.IP \(bu 2
\fI\%#1625\fP: All nodes in a cluster now run their own \fBrexi\fP server.
.UNINDENT
.SS Bugfixes
.INDENT 0.0
.IP \(bu 2
\fI\%#1484\fP: \fB_stats\fP now correctly handles the case where a map function emits
an array of integers. This bug was introduced in 2.2.0.
.IP \(bu 2
\fI\%#1544\fP: Certain list functions could return a \fBrender_error\fP error
intermittently.
.IP \(bu 2
\fI\%#1550\fP: Replicator \fB_session\fP support was incompatible with CouchDB
installations using the \fBrequire_valid_user = true\fP setting.
.IP \(bu 2
\fI\%#1571\fP: Under very heavy load, it was possible that \fBrexi_server\fP could
die in such a way that it’s never restarted, leaving a cluster without the ability
to issue RPC calls \- effectively rendering the cluster useless.
.IP \(bu 2
\fI\%#1574\fP: The built\-in \fB_sum\fP reduce function has been improved to check
if the objects being summed are not overflowing the view storage. Previously, there
was no protection for \fB_sum\fP\-introduced overflows.
.IP \(bu 2
\fI\%#1582\fP: Database creation parameters now have improved validation, giving a
more readable error on invalid input.
.IP \(bu 2
\fI\%#1588\fP: A missing security check has been restored for the noop
\fB/db/_ensure_full_commit\fP call to restore database validation checks.
.IP \(bu 2
\fI\%#1591\fP: CouchDB now creates missing shard files when accessing a database
if necessary. This handles the situation when, on database creation, no nodes were
capable of creating any of the shard files required for that database.
.IP \(bu 2
\fI\%#1568\fP: CouchDB now logs a warning if a changes feed is rewound to 0. This
can help diagnose problems in busy or malfunctioning clusters.
.IP \(bu 2
\fI\%#1596\fP: It is no longer possible that a busy \fBcouch_server\fP, under a
specific ordering and timing of events, will incorrectly track \fBopen_async\fP
messages in its mailbox.
.IP \(bu 2
\fI\%#1601\fP, \fI\%#1654\fP: CouchDB now logs better when an error causes it to
read past the EOF of a database shard. The check for whether CouchDB is trying to read
too many bytes has been correctly separated out from the error indicating it has
attempted to read past the EOF.
.IP \(bu 2
\fI\%#1613\fP: Local nodes are now filtered out during read repair operations.
.IP \(bu 2
\fI\%#1636\fP: A memory leak when replicating over HTTPS and a problem occurs
has been squashed.
.IP \(bu 2
\fI\%#1635\fP: \fB/_replicate\fP jobs are no longer restarted if parameters haven’t
changed.
.IP \(bu 2
\fI\%#1612\fP: JavaScript rewrite functions now send the body of the request to
the rewritten endpoint.
.IP \(bu 2
\fI\%#1631\fP: The replicator no longer crashes if the user has placed an
invalid VDU function into one of the \fB_replicator\fP databases.
.IP \(bu 2
\fI\%#1644\fP, \fI\%#1647\fP: It is no longer possible to create illegally\-named
databases within the reserved system space (\fB_\fP prefix.)
.IP \(bu 2
\fI\%#1650\fP: \fB_bulk_get\fP is once again operational for system databases such
as \fB_users\fP\&.
.IP \(bu 2
\fI\%#1652\fP: Access to \fB/_active_tasks\fP is once again restricted to server
admins only.
.IP \(bu 2
\fI\%#1662\fP: The \fBcouch_log\fP application no longer crashes when new, additional
information is supplied by a crashing application, or when any of its own children are
restarted.
.IP \(bu 2
\fI\%#1666\fP: Mango could return an error that would crash the
\fBcouch_query_servers\fP application. This is no longer the case.
.IP \(bu 2
\fI\%#1655\fP: Configuration of \fBets_lru\fP in \fBchttpd\fP now performs proper error
checking of the specified config value.
.IP \(bu 2
\fI\%#1667\fP: The \fBsnappy\fP dependency has been updated to fix a memory allocation
error.
.IP \(bu 2
\fI\%#1683\fP: Attempting to create a local document with an invalid revision no
longer throws a \fBbadarg\fP exception. Also, when setting \fBnew_edits\fP to \fBfalse\fP
and performing a bulk write operation, local documents are no longer written into the
wrong btree. Finally, it is no longer possible to create a document with an empty
ID during a bulk operation with \fBnew_edits\fP set to \fBfalse\fP\&.
.IP \(bu 2
\fI\%#1721\fP: The \fBcouchup\fP convenience script for upgrading from CouchDB 1.x
now also copies a database’s \fB_security\fP object on migration.
.IP \(bu 2
\fI\%#1672\fP: When checking the status of a view compaction immediately after
starting it, the \fBtotal_changes\fP and \fBchanges_done\fP fields are now immediately
populated with valid values.
.IP \(bu 2
\fI\%#1717\fP: If the \fB\&.ini\fP config file is read only, an attempt to update the
config through the HTTP API will now result in a proper \fBeacces\fP error response.
.IP \(bu 2
\fI\%#1603\fP: CouchDB now returns the correct \fBtotal_rows\fP result when querying
\fB/{db}/_design_docs\fP\&.
.IP \(bu 2
\fI\%#1629\fP: Internal load validation functions no longer incorrectly hold open
a deleted database or its host process.
.IP \(bu 2
\fI\%#1746\fP: Server admins defined in the ini file accessing via HTTP API no longer
result in the auth cache logging the access as a miss in the statistics.
.IP \(bu 2
\fI\%#1607\fP: The replicator no longer fails to re\-authenticate to open a remote
database when its session cookie times out due to a VDU function forbidding writes
or a non\-standard cookie expiration duration.
.IP \(bu 2
\fI\%#1579\fP: The compaction daemon no longer incorrectly only compacts a single
view shard for databases with a \fBq\fP value greater than 1.
.IP \(bu 2
\fI\%#1737\fP: CouchDB 2.x now performs as well as 1.x when using a \fB_doc_ids\fP
or \fB_design_docs\fP filter on a changes feed.
.UNINDENT
.SS Mango
.SS Other
.sp
The 2.3.0 release also includes the following minor improvements:
.INDENT 0.0
.IP \(bu 2
Improved test cases:
.INDENT 2.0
.IP \(bu 2
The Elixir test suite has been merged. These test cases are intended to replace the
aging, unmaintainable JavaScript test suite, and help reduce our dependency on
Mozilla Spidermonkey 1.8.5. The test suite does not yet cover all of the tests that
the JS test suite does. Once it achieves full coverage, the JS test suite will be
removed.
.IP \(bu 2
Many racy test cases improved for reliable CI runs.
.IP \(bu 2
The Makefile targets for \fBlist\-eunit\-*\fP now work correctly on macOS.
.IP \(bu 2
\fI\%#1732\fP, \fI\%#1733\fP, \fI\%#1736\fP: All of the test suites run and
pass on the Windows platform once again.
.UNINDENT
.IP \(bu 2
\fI\%#1597\fP: Off\-heap messages, a new feature in Erlang 19+, can now be disabled
per module if desired.
.IP \(bu 2
\fI\%#1682\fP: A new \fB[feature_flags]\fP config section exists for the purpose of
enabling or disabling experimental features by CouchDB developers.
.IP \(bu 2
A narwhal! OK, no, not really. If you got this far…thank you for reading.
.UNINDENT
.SS 2.2.x Branch
.INDENT 0.0
.IP \(bu 2
\fI\%Upgrade Notes\fP
.IP \(bu 2
\fI\%Version 2.2.0\fP
.UNINDENT
.SS Upgrade Notes
.INDENT 0.0
.IP \(bu 2
The minimum supported version of Erlang is now 17, not R16B03. Support for Erlang 21
is still ongoing and will be provided in a future release.
.IP \(bu 2
The CouchDB replication client can now use the \fB/_session\fP endpoint when
authenticating against remote CouchDB instances, improving performance since
re\-authorization does not have to be performed with every request. Because of
this performance improvement, it is recommended to increase the PBKDF2 work
factor beyond the default \fB10\fP to a modern default such as \fB10000\fP\&. This is done
via the local ini file setting \fB[couch_httpd_auth] iterations = 10000\fP\&.
.sp
Do \fBnot\fP do this if an older version of CouchDB is replicating TO this instance or
cluster regularly, since CouchDB < 2.2.0 must perform authentication on every request
and replication performance will suffer.
.sp
A future version will make this increased number of iterations a default.
.IP \(bu 2
\fI\%#820\fP, \fI\%#1032\fP: Multiple queries can now be made at the
\fBPOST /{db}/_all_docs/queries\fP, \fBPOST /{db}/_design_docs/queries\fP and
\fBPOST /{db}/_local_docs/queries\fP endpoints. Also, a new endpoint
\fBPOST /{db}/_design/{ddoc}/_view/{view}/queries\fP has been introduced to replace
the \fB?queries\fP parameter formerly provided for making multiple queries to a view.
The old \fB?queries\fP parameter \fIis now deprecated and will be removed in a future
release of CouchDB.\fP
.IP \(bu 2
The maximum http request limit, which had been lowered in 2.1.0, has been re\-raised
to a 4GB limit for now. (\fI\%#1446\fP). Ongoing discussion about the path forward
for future releases is available in \fI\%#1200\fP and \fI\%#1253\fP\&.
.IP \(bu 2
\fI\%#1118\fP: The least recently used (LRU) cache of databases is now only updated
on database write, not read. This has lead to significant performance enhancements
on very busy clusters. To restore the previous behaviour, your local ini file can
contain the block \fB[couchdb] update_lru_on_read = true\fP\&.
.IP \(bu 2
\fI\%#1153\fP: The CouchDB replicator can now make use of the \fB/_session\fP endpoint
rather than relying entirely on HTTP basic authentication headers. This can greatly
improve replication performance. We encourage you to upgrade any nodes or clusters that
regularly act as replication clients to use this new feature, which is enabled by
default (\fI\%#1462\fP).
.IP \(bu 2
\fI\%#1283\fP: The \fB[couchdb] enable_database_recovery\fP feature, which only
soft\-deletes databases in response to a \fBDELETE /{db}\fP call, is now documented in
\fBdefault.ini\fP\&.
.IP \(bu 2
\fI\%#1330\fP: CouchDB externals and OS daemons are now officially deprecated and no
longer documented. Support for these features will be completely removed in a future
release of CouchDB (probably 3.0.0).
.IP \(bu 2
\fI\%#1436\fP: CouchDB proxy authentication now uses a proper \fBchttpd_auth\fP
module, simplifying configuration in local ini files. While this is not a backward\-
compatible breaking change, it is best to update your local ini files to reference the
new \fB{chttpd_auth, proxy_authentication_handler}\fP handler rather than the
\fBcouch_httpd_auth\fP version, as \fBcouch_httpd\fP is in the process of being deprecated
completely.
.IP \(bu 2
\fI\%#1476\fP, \fI\%#1477\fP: The obsolete \fIupdate_notification\fP feature, which
was replaced by \fI/{db}/_changes\fP feeds c. CouchDB 1.2, has been completely removed.
This feature never worked in 2.0 for databases, only for shards, making it effectively
useless.
.UNINDENT
.SS Version 2.2.0
.SS Features
.INDENT 0.0
.IP \(bu 2
Much improved documentation. Highlights include:
.INDENT 2.0
.IP \(bu 2
A complete rewrite of the \fI\%sharding\fP documentation.
.IP \(bu 2
Developer installation notes (\fBINSTALL.*.rst\fP)
.IP \(bu 2
Much of the content of the original CouchDB Wiki has been imported into the
official docs. (The old CouchDB Wiki is in the process of being deprecated.)
.UNINDENT
.IP \(bu 2
Much improved Fauxton functionality. Highlights include:
.INDENT 2.0
.IP \(bu 2
Search support in the code editor
.IP \(bu 2
Support for relative Fauxton URLs (\fIi.e.\fP, not always at \fB/_utils\fP)
.IP \(bu 2
Replication setup enhancements for various authentication mechanisms
.IP \(bu 2
Fixes for IE10, IE11, and Edge (we hope…)
.IP \(bu 2
Resolving conflicts of design documents is now allowed
.UNINDENT
.IP \(bu 2
\fI\%#496\fP, \fI\%COUCHDB\-3287\fP: New pluggable storage engine framework has landed in
CouchDB. This internal refactor makes it possible for CouchDB to use different backends
for storing the base database file itself. The refactor included a full migration of
the existing “legacy” storage engine into the new framework.
.IP \(bu 2
\fI\%#603\fP: When creating a new database on a cluster without quorum, CouchDB will
now return a \fB202 Accepted\fP code if possible, indicating that at least one node
has written the database record to disk, and that other nodes will be updated as they
return to an online state. This replaces the former \fB500\fP internal error.
.IP \(bu 2
\fI\%#1136\fP, \fI\%#1139\fP: When deleting a database in a cluster without
quorum, CouchDB will no longer throw a \fB500\fP error status, but a \fB202\fP as long as
at least one node records the deletion, or a \fB200\fP when all nodes respond. This fix
parallels the one made for \fI\%#603\fP\&.
.IP \(bu 2
\fI\%#745\fP: CouchDB no longer fails to complete replicating databases with
large attachments. The fix for this issue included several related changes:
.INDENT 2.0
.IP \(bu 2
The maximum http request limit, which had been lowered in 2.1.0, has been re\-raised
to a 4GB limit for now. (\fI\%#1446\fP). Ongoing discussion about the path forward
for future releases is available in \fI\%#1200\fP and \fI\%#1253\fP\&.
.IP \(bu 2
An update to the replicator http client that improves active socket accounting,
without which CouchDB can cease to be responsive over the main http interface
(\fI\%#1117\fP)
.IP \(bu 2
The replicator’s http client no longer performs unconditional retries on failure
(\fI\%#1177\fP)
.IP \(bu 2
A path by which CouchDB could lose track of their RPC workers during multipart
attachment processing was removed. (\fI\%#1178\fP)
.IP \(bu 2
When CouchDB transmits a \fB413 Payload Too Large\fP response on attachment upload,
it now correctly flushes the receive socket before closing the connection to avoid
a TCP reset, and to give the client a better chance of parsing the 413 response. In
tandem, the replicator http client correctly closes its own socket after processing
any 413 response. (\fI\%#1234\fP)
.IP \(bu 2
A \fBfabric\fP process to receive unchunked attachments can no longer orphan processes
that leave unprocessed binaries in memory until all available memory is exhausted.
(\fI\%#1264\fP).
.IP \(bu 2
When using CouchDB’s native SSL responder (port 6984 by default), sessions are now
timed out by default after 300s. This is to work around RAM explosion in the BEAM VM
when using the Erlang\-native SSL libraries. (\fI\%#1321\fP
.UNINDENT
.IP \(bu 2
\fI\%#822\fP: A new end point \fI\%/_dbs_info\fP has been added to return
information about a list of specified databases. This endpoint can take the place of
multiple queries to \fB/{db}\fP\&.
.IP \(bu 2
\fI\%#875\fP, \fI\%#1030\fP: \fBcouch_peruser\fP installations can now specify a
default \fBq\fP value for each peruser\-created database that is different from the
cluster’s \fBq\fP value. Set this in your local ini file, under \fB[couch_peruser] q\fP\&.
.IP \(bu 2
\fI\%#876\fP, \fI\%#1068\fP: The \fBcouch_peruser\fP database prefix is now
configurable through your local ini file, under \fB[couch_peruser] database_prefix\fP\&.
.IP \(bu 2
\fI\%#887\fP: Replicator documents can now include parameters for target database
creation, such as \fB\(dqcreate_target_params\(dq: {\(dqq\(dq: \(dq1\(dq}\fP\&. This can assist in
database resharding or placement.
.IP \(bu 2
\fI\%#977\fP: When using \fBCOPY\fP to copy a document, CouchDB no longer fails if
the new ID includes Unicode characters.
.IP \(bu 2
\fI\%#1095\fP: Recognize the environment variables \fBARGS_FILE\fP, \fBSYSCONFIG_FILE\fP,
\fBCOUCHDB_ARGS_FILE\fP and \fBCOUCHDB_SYSCONFIG_FILE\fP to override where CouchDB looks
for the \fBvm.args\fP and \fBsys.config\fP files at startup.
.IP \(bu 2
\fI\%#1101\fP, \fI\%#1425\fP: Mango can now be used to find conflicted documents
in a database by adding \fBconflicts: true\fP to a mango selector.
.IP \(bu 2
\fI\%#1126\fP: When queried back after saving, replication documents no longer
contain sensitive credential information (such as basic authenticataion headers).
.IP \(bu 2
\fI\%#1203\fP:
.INDENT 2.0
.INDENT 3.5
.INDENT 0.0
.IP \(bu 2
The compaction daemon now has a snooze period, during which it waits to start
the next compaction after finishing the previous one. This value is useful in
setups with many databases (e.g. with \fBcouch_peruser\fP) or many design docs,
which can cause a CPU spike every \fBcheck_interval\fP seconds. The setting can
be adjusted in your local ini file via \fB[compaction_daemon] snooze_period\fP\&.
The current default is a 3 second pause.
.IP \(bu 2
The \fBcheck_interval\fP has been raised from 300 seconds to 3600 seconds.
.IP \(bu 2
A \fBnotice\fP\-level log about closing view indexes has been demoted to the
\fBdebug\fP level. In a sceario with many design docs, this would createsignficant
load on the logging subsystem every \fB[compaction_daemon] check_interval\fP for
no discernible benefit.
.UNINDENT
.UNINDENT
.UNINDENT
.IP \(bu 2
\fI\%#1309\fP, \fI\%#1435\fP: CouchDB now reports the git sha at the time of build
in the top\-level \fBGET /\fP version string, in a new \fBgit_sha\fP key. This can be used
to help ensure an unmodified version of CouchDB has been built and is running on any
given machine.
.IP \(bu 2
\fI\%COUCHDB\-2971\fP, \fI\%#1346\fP: CouchDB now includes a new builtin reduce function
\fB_approx_count_distinct\fP, that uses a HyperLogLog algorithm to estimate the number of
distinct keys in the view index. The precision is currently fixed to 2^11 observables,
and therefore uses approximately 1.5KB of memory.
.IP \(bu 2
\fI\%#1377\fP: CouchDB finalization of view reduces now occurs at the coordinator
node. This simplified the built\-in \fB_stats\fP function.
.IP \(bu 2
\fI\%#1392\fP: When running CouchDB under Erlang 19.0 or newer, messages can now be
stored off the process heap. This is extremely useful for Erlang processes that can
have huge number of messages in their mailbox, and is now enabled for \fBcouch_server\fP,
\fBcouch_log_server\fP, \fBddoc_cache\fP, \fBmem3_shards\fP, and \fBrexi_server\fP whenever
possible.
.IP \(bu 2
\fI\%#1424\fP: The CouchDB native SSL/TLS server \fBhttpsd\fP now accepts socket\-level
configuration options through the \fB[httpsd] server_options\fP ini file setting.
.IP \(bu 2
\fI\%#1440\fP: CouchDB can now be configured to prevent non\-admins from accessing
the \fBGET /_all_dbs\fP method by specifying \fB[chttpd] admin_only_all_dbs = true\fP in
your local ini file(s). The \fBtrue\fP setting will become default in future versions.
.IP \(bu 2
\fI\%#1171\fP, \fI\%#1445\fP: CouchDB can now be configured to use the internal
Erlang MD5 hash function when not available in the external environment (e.g. FIPS
enabled CentOS) at compile time with the \fBconfigure\fP flag \fB\-\-enable\-md5\fP\&. Because
this implementation is slower, it is not recommended in the general case.
.UNINDENT
.SS Performance
.INDENT 0.0
.IP \(bu 2
\fI\%#958\fP: The revision stemming algorithm was optimized down from \fIO(N^2)\fP to
\fIO(N)\fP via a depth\-first search approach, and then further improved by calling the
stemming operation only when necessary. This new algorithm can be disabled by
setting the option \fB[couchdb] stem_interactive_updates = false\fP if necessary.
.IP \(bu 2
\fI\%#1246\fP: CouchDB now checks for request authorization only once per each
database request, improving the performance of any request that requires
authorization.
.UNINDENT
.SS Bugfixes
.INDENT 0.0
.IP \(bu 2
\fI\%#832\fP, \fI\%#1064\fP: Tracking of Couch logging stats has been added back
into the per\-node \fB/_node/<node\-name>/_stats\fP endpoint.
.IP \(bu 2
\fI\%#953\fP, \fI\%#973\fP: Return \fB404 Not Found\fP on \fBGET /_scheduler\fP,
not \fB405 Method Not Allowed\fP\&.
.IP \(bu 2
\fI\%#955\fP: The \fB/{db}/_bulk_docs\fP endpoint now correctly responds with a
\fB400 Bad Request\fP error if the \fBnew_edits\fP parameter is not a boolean.
.IP \(bu 2
\fI\%#969\fP: CouchDB now returns \fBoffset\fP and \fBupdate_seq\fP values when \fBkeys\fP
are provided to the \fBGET\fP or \fBPOST\fP \fB/{db}/_all_docs?update_seq=true\fP endpoints.
This was affecting PouchDB compatibility.
.IP \(bu 2
\fI\%#984\fP, \fI\%#1434\fP: CouchDB views now retain their \fBupdate_seq\fP after
compaction, preventing potentially expensive client\-side view rewinds after compaction.
.IP \(bu 2
\fI\%#1012\fP: Address a theoretical race condition the replication scheduler could
encounter when trying to determine if the cluster is “stable” enough to resume
handling replication\-introduced document updates.
.IP \(bu 2
\fI\%#1051\fP: Return a user\-friendly error message when attempting to create a
CouchDB user with an invalid password field (non\-string).
.IP \(bu 2
\fI\%#1059\fP: DB\-specific compaction configurations were not working correctly. The
syntax now also supports shard\-level custom compaction configuration if desired (which
it probably isn’t.)
.IP \(bu 2
\fI\%#1097\fP: Compaction daemon will not crash out when trying to check specific
file system mounts that are not “real” file systems (like \fB/run\fP on Linux).
.IP \(bu 2
\fI\%#1198\fP: Fauxton is no longer available on the node\-local port (5986, by
default). The node\-local port is only to be used for specific administrative tasks;
removing the Fauxton interface prevents mistaking the node\-local port as the correct
CouchDB port (5984, by default).
.IP \(bu 2
\fI\%#1165\fP: \fBvalidate_doc_update\fP view functions can once again be implemented
directly in Erlang (after enabling the optional Erlang view server).
.IP \(bu 2
\fI\%#1223\fP: The \fBcouch_config\fP application now correctly handles non\-persistent
integer and boolean\-valued configuration changes.
.IP \(bu 2
\fI\%#1242\fP: \fBcouch_os_daemons\fP may now reside in directories with spaces.
.IP \(bu 2
\fI\%#1258\fP: CouchDB will now successfully login users, even if password encryption
is very slow.
.IP \(bu 2
\fI\%#1276\fP: The replication scheduler status for a repeatedly erroring job now
correctly reflects the \fIcrashing\fP state in more scenarios.
.IP \(bu 2
\fI\%#1375\fP: If CouchDB fails authorization but passes authentication, it no longer
drops the \fBuser_ctx\fP out of the request.
.IP \(bu 2
\fI\%#1390\fP: The active size of views (as returned in a database info response) no
longer is incorrectly calculated in such a way that it could occasionally be larger than
the actual on\-disk file size.
.IP \(bu 2
\fI\%#1401\fP: CouchDB Erlang views no longer crash in the \fBcouch_native\fP process
with an unexpected \fBfunction_clause\fP error.
.IP \(bu 2
\fI\%#1419\fP: When deleting a file, CouchDB now properly ignores the configuration
flag \fBenable_database_recovery\fP when set when compacting databases, rather than
always retaining the old, renamed, uncompacted database file.
.IP \(bu 2
\fI\%#1439\fP: The CouchDB setup wizard now correctly validates bind_addresses. It
also no longer logs credentials by moving logging of internal wizard setup steps to
the \fBdebug\fP level from the \fBnotice\fP level.
.UNINDENT
.SS Mango
.INDENT 0.0
.IP \(bu 2
\fI\%#816\fP, \fI\%#962\fP, \fI\%#1038\fP: If a user specifies a value for
\fBuse_index\fP that is not valid for the selector (does not meet coverage requirements
or proper sort fields), attempt to fall back to a valid index or full DB scan rather
than returning  a \fB400\fP\&.  If we fall back, populate a \fBwarning\fP field in the
response. Mango also tries to use indexes where \fB$or\fP may select a field only when
certain values are present.
.IP \(bu 2
\fI\%#849\fP: When \fB{\(dqseq_indexed\(dq: true}\fP is specified, a badmatch error was
returned. This is now fixed.
.IP \(bu 2
\fI\%#927\fP, \fI\%#1310\fP: Error messages when attempting to sort incorrectly are
now actually useful.
.IP \(bu 2
\fI\%#951\fP: When using \fBGET /{db}/_index\fP, only use a partial filter selector for
an index if it is set to something other than the default.
.IP \(bu 2
\fI\%#961\fP: Do not prefix \fB_design/\fP to a Mango index name whose user\-specified
name already starts with \fB_design/\fP\&.
.IP \(bu 2
\fI\%#988\fP, \fI\%#989\fP: When specifying a \fBuse_index\fP value with an invalid
index, correctly return a \fB400 Bad Request\fP showing that the requested index is
invalid for the request specified.
.IP \(bu 2
\fI\%#998\fP: The fix for \fI\%CVE 2017\-12635\fP presented a breaking
change to Mango’s \fB/{db}/_find\fP, which would evaluate all instances of all JSON
fields in a selector. Mango is now tested to ensure it only considers the last instance
of a field, silently ignoring those that appear before it.
.IP \(bu 2
\fI\%#1014\fP: Correctly deduce list of indexed fields in a selector when nested
\fB$and\fP operators are specified.
.IP \(bu 2
\fI\%#1023\fP: Fix an unexpected \fB500\fP error if \fBstartkey\fP and \fBendkey\fP in a
Mango selector were reversed.
.IP \(bu 2
\fI\%#1067\fP: Prevent an \fBinvalid_cast\fP crash when the \fBcouch_proc_manager\fP soft
limit for processes is reached and mango idle processes are stopped.
.IP \(bu 2
\fI\%#1336\fP: The built\-in fields \fB_id\fP and \fBrev\fP will always be covered by any
index, and Mango now correctly ignores their presence in any index that explicitly
includes them for selector matching purposes.
.IP \(bu 2
\fI\%#1376\fP: Mango now appropriately selects some indexes as usable for queries,
even if not all columns for an index are added to the query’s sort field list.
.IP \(bu 2
Multiple fixes related to using Mango as a front\-end for full text indexing (a feature
not shipped with couch, but for which support is in place as a compile\-time addon).
.UNINDENT
.SS Other
.sp
The 2.2.0 release also includes the following minor improvements:
.INDENT 0.0
.IP \(bu 2
Developers can, at build time, enable curl libraries & disable Fauxton and documentation
builds by specifying the new \fB\-\-dev\fP option to the \fBconfigure\fP script.
.IP \(bu 2
The \fBmochiweb\fP dependency was bumped to version 2.17.0, in part to address the
difficult \fI\%#745\fP issue.
.IP \(bu 2
Improved compatibility with newer versions of Erlang (20.x)
.IP \(bu 2
Improved release process for CouchDB maintainers and PMC members.
.IP \(bu 2
Multiple test suite improvements, focused on increased coverage, speed, and
reliability.
.IP \(bu 2
Improvements to the Travis CI and Jenkins CI setups, focused on improved long\-term
project maintenance and automatability.
.IP \(bu 2
Related improvements to the CouchDB deb/rpm packaging and Docker repositories to
make deployment even easier.
.IP \(bu 2
\fI\%#1007\fP: Move \fBetc/default.ini\fP entries back into \fB[replicator]\fP section
(incorrectly moved to \fB[couch_peruser]\fP section)
.IP \(bu 2
\fI\%#1245\fP: Increased debug\-level logging for shard open errors is now available.
.IP \(bu 2
\fI\%#1296\fP: CouchDB by default now always invokes the SMP\-enabled BEAM VM, even
on single\-processor machines. A future release of Erlang will remove the non\-SMP BEAM
VM entirely.
.IP \(bu 2
A pony! OK, no, not really. If you got this far…thank you for reading.
.UNINDENT
.SS 2.1.x Branch
.INDENT 0.0
.IP \(bu 2
\fI\%Upgrade Notes\fP
.IP \(bu 2
\fI\%Version 2.1.2\fP
.IP \(bu 2
\fI\%Version 2.1.1\fP
.IP \(bu 2
\fI\%Version 2.1.0\fP
.IP \(bu 2
\fI\%Fixed Issues\fP
.UNINDENT
.SS Upgrade Notes
.INDENT 0.0
.IP \(bu 2
When upgrading from 2.x to 2.1.1, if you have not customized your
node name in \fBvm.args\fP, be sure to retain your original \fBvm.args\fP
file. The default node name has changed from \fBcouchdb@localhost\fP to
\fBcouchdb@127.0.0.1\fP, which can prevent CouchDB from accessing existing
databases on the system. You may also change the name option back to the
old value by setting \fB\-name couchdb@localhost\fP in \fBetc/vm.args\fP by
hand. The default has changed to meet new guidelines and to provide
additional functionality in the future.
.sp
If you receive errors in the logfile, such as
\fBinternal_server_error : No DB shards could be opened.\fP or in Fauxton,
such as \fBThis database failed to load.\fP you need to make this change.
.IP \(bu 2
The deprecated (and broken) OAuth 1.0 implementation has been removed.
.IP \(bu 2
If user code reads or manipulates replicator document states,
consider using the \fB[replicator] update_docs = true\fP compatibility
parameter. In that case the replicator will continue updating documents
with transient replication states. However, that will incur a
performance cost. Consider instead using the \fB_scheduler/docs\fP HTTP
endpoint.
.IP \(bu 2
The \fBstale\fP parameter for views and \fB_find\fP has been deprecated in favour
of two new parameters: \fBstable\fP and \fBupdate\fP\&. The old \fBstale=ok\fP
behaviour is equivalent to \fBstable=true&update=false\fP, and the old
\fBstale=update_after\fP behaviour is equivalent to \fBstable=true&update=lazy\fP\&.
The deprecated \fBstale\fP parameter will be removed in CouchDB 3.0.
.IP \(bu 2
The new :\fBhttpd/max_http_request_size\fP configuration parameter
was added. This has the same behavior as the old
\fI\%couchdb/max_document_size\fP configuration parameter, which
had been unfortunately misnamed, and has now been updated to behave as the
name would suggest. Both are documented in the shipped \fBdefault.ini\fP file.
.sp
Note that the default for this new parameter is 64MB instead of 4GB. If you
get errors when trying to PUT or POST and see HTTP 413 return codes in couchdb
logs, this could be the culprit. This can affect couchup in\-place upgrades as
well.
.IP \(bu 2
\fI\%#914\fP: Certain critical config sections are blacklisted from being
modified through the HTTP API. These sections can still be modified through
the standard \fBlocal.ini\fP or \fBlocal.d/*.ini\fP files.
.IP \(bu 2
\fI\%#916\fP: \fBcouchjs\fP now disables \fBeval()\fP and the \fBFunction()\fP
constructor by default. To restore the original behaviour, add the
\fB\-\-eval\fP flag to the definition of the javascript query server in your
\fBlocal.ini\fP file.
.UNINDENT
.SS Version 2.1.2
.SS Security
.INDENT 0.0
.IP \(bu 2
\fI\%CVE 2018\-8007\fP
.UNINDENT
.SS Version 2.1.1
.SS Security
.INDENT 0.0
.IP \(bu 2
\fI\%CVE 2017\-12635\fP
.IP \(bu 2
\fI\%CVE 2017\-12636\fP
.UNINDENT
.SS General
.INDENT 0.0
.IP \(bu 2
\fI\%#617\fP: CouchDB now supports compilation and running under Erlang/OTP
20.x.
.IP \(bu 2
\fI\%#756\fP: The \fBcouch_peruser\fP functionality is now \fIreally\fP fixed.
Really.
.IP \(bu 2
\fI\%#827\fP: The cookie domain for AuthSession cookies, used in a
proxy authentication configuration, can now be customized via the ini file.
.IP \(bu 2
\fI\%#858\fP: It is now possible to modify shard maps for system databases.
.IP \(bu 2
\fI\%#732\fP: Due to an Erlang bug (\fI\%ERL\-343\fP), invalid paths can be
returned if volumes are mounted containing whitespace in their name. This
problem surfaced primarily on macOS (Time Machine volumes). CouchDB now
works around this bug in unpatched versions of Erlang by skipping the free
space check performed by the compaction daemon. Erlang itself will
correctly perform free space checks in version 21.0.
.IP \(bu 2
\fI\%#824\fP: The current node’s local interface can now be accessed at
\fB/_node/_local/{endpoint}\fP as well as at
\fB/_node/<nodename>@<hostname>/{endpoint}\fP\&.
.IP \(bu 2
The Dockerfile in the source repository has been retired. For a current
Dockerfile, see the \fIcouchdb\-docker repository\fP\&.
.IP \(bu 2
Fauxton now uses a version of React with a BSD license.
.UNINDENT
.SS Performance
.INDENT 0.0
.IP \(bu 2
\fI\%#835\fP: CouchDB now no longer decompresses documents just to
determine their uncompressed size. In tests, this has lead to improvements
between 10\-40% in both CPU and wall\-clock time for database compaction.
.IP \(bu 2
The design document cache (\fBddoc_cache\fP) has been rewritten to improve
performance.
.UNINDENT
.SS Mango
.INDENT 0.0
.IP \(bu 2
\fI\%#808\fP: Mango now supports
\fI\%partial indexes\fP\&. Partial indexes allow
documents to be filtered at indexing time, potentially offering
significant performance improvements for query selectors that don’t map
cleanly to a range query on an index.
.IP \(bu 2
\fI\%#740\fP: Mango queries can now be paginated. Each query response
includes a bookmark.  The bookmark can be provided on a subsequent query to
continue from a specific key.
.IP \(bu 2
\fI\%#768\fP: Mango \fB_find\fP accepts an \fBexecution_stats\fP
parameter. If present, a new object is included in the response which
contains information about the query executed. The object contains the
count of total keys examined (0 for json indexes), total documents
examined (when \fBinclude_docs=true\fP is used), and the total quorum
documents examined (when fabric doc lookups are used).
.IP \(bu 2
\fI\%#816\fP and \fI\%#866\fP: Mango now requires that all of the fields
in a candidate index must exist in a query’s selector. Previously, this check
was incorrect, and indexes that might only contain a subset of valid
documents might be selected by the query planner if no explicit index was
specified at query time. Further, if a sort field is specified at query time,
that field needs to exist (but could be null) in the results returned.
.UNINDENT
.SS Other
.sp
The 2.1.1 release also includes the following minor improvements:
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.IP \(bu 2
\fI\%#635\fP: Stop couch_index processes on ddoc update
.IP \(bu 2
\fI\%#721\fP: Save migrated replicator checkpoint documents immediately
.IP \(bu 2
\fI\%#688\fP: Reuse http\-based replication checkpoints when upgrading
to https
.IP \(bu 2
\fI\%#729\fP: Recommend the use only of \fB\-name\fP and not \fB\-sname\fP in
\fIvm.args\fP for compatibility.
.IP \(bu 2
\fI\%#738\fP: Allow replicator application to always update replicator
docs.
.IP \(bu 2
\fI\%#605\fP: Add \fBPrefer: return=minimal\fP header options from
RFC7240 to reduce the number of headers in the response.
.IP \(bu 2
\fI\%#744\fP: Allow a 503 response to be returned to clients (with
metric support)
.IP \(bu 2
\fI\%#746\fP: Log additional information on crashes from rexi
.IP \(bu 2
\fI\%#752\fP: Allow Mango $in queries without requiring the index to
use an array
.IP \(bu 2
(multiple) Additional debugging utilities have been added.
.IP \(bu 2
(multiple) Hot code upgrades from 2.0 \-> 2.1.1 are now possible.
.IP \(bu 2
(multiple) Improvements to the test suite have been made.
.IP \(bu 2
\fI\%#765\fP: Mango \fB_explain\fP now includes view parameters as requested
by the user.
.IP \(bu 2
\fI\%#653\fP: \fI_show\fP and \fI_list\fP should now work for admin\-only
databases such as \fB_users\fP\&.
.IP \(bu 2
\fI\%#807\fP: Mango index selection should occur only once.
.IP \(bu 2
\fI\%#804\fP: Unhandled Mango errors are now logged.
.IP \(bu 2
\fI\%#659\fP: Improve accuracy of the \fBmax_document_size\fP check.
.IP \(bu 2
\fI\%#817\fP: Invalid Base64 in inline attachments is now caught.
.IP \(bu 2
\fI\%#825\fP: Replication IDs no longer need to be URL encoded when
using the \fB_scheduler/jobs/<job_id>\fP endpoint.
.IP \(bu 2
\fI\%#838\fP: Do not buffer rexi messages to disconnected nodes.
.IP \(bu 2
\fI\%#830\fP: The stats collection interval is now configurable in
an ini file, not in the application context. The default value is 10,
and the setting is reloaded every 600 seconds.
.IP \(bu 2
\fI\%#812\fP: The \fB/{db}\fP endpoint now includes a \fBcluster\fP block
with the database’s \fBq\fP, \fBn\fP, and default \fBw\fP and \fBr\fP values.
This supplements the existing \fB/{db}/_shards\fP and \fB/{db}/_shards/{id}\fP
detailed information on sharding and quorum.
.IP \(bu 2
\fI\%#810\fP: The replicator scheduler crashed counter gauge more
reliably detects replication crashes by reducing the default number
of retries from 10 to 5 (reducing the duration from 4 mins to 8 secs).
.IP \(bu 2
\fI\%COUCHDB\-3288\fP: Tolerate mixed clusters for the upcoming pluggable
storage engine work.
.IP \(bu 2
\fI\%#839\fP: Mango python tests now support Python 3 as well as 2.
.IP \(bu 2
\fI\%#845\fP: A convenience \fBremsh\fP script has been added to support
live debugging of running systems.
.IP \(bu 2
\fI\%#846\fP: Replicator logging is now less verbose and more informative
when replication terminates unexpectedly.
.IP \(bu 2
\fI\%#797\fP: Reduce overflow errors are now returned to the client,
allowing views with a single bad reduce to build while not exhausting the
server’s RAM usage.
.IP \(bu 2
\fI\%#881\fP: Mango now allows match on documents where the indexed
value is an object if a range query is issued. Previously, query results
might change in the presence of an index, and operators/selectors which
explicitly depend on a full index scan (such as \fB$exists\fP) would not
return a complete result set.
.IP \(bu 2
\fI\%#883\fP: Erlang time module compatibility has been improved for
releases of Erlang newer than 18.0.
.IP \(bu 2
\fI\%#933\fP: 410 is now returned when attempting to make a temporary
view request.
.IP \(bu 2
\fI\%#934\fP: The replicator now has a configurable delay before
retrying to retrieve a document after receiving a \fBmissing_doc\fP error.
.IP \(bu 2
\fI\%#936\fP: jiffy now deduplicates JSON keys.
.UNINDENT
.UNINDENT
.UNINDENT
.SS Version 2.1.0
.INDENT 0.0
.IP \(bu 2
The Mango \fB_find\fP endpoint supports a new combination operator,
\fB$allMatch\fP, which matches and returns all documents that contain an
array field with all its elements matching all the specified query
criteria.
.IP \(bu 2
New scheduling replicator. The core of the new replicator is a
scheduler which allows running a large number of replication
jobs by switching between them, stopping some and starting others
periodically. Jobs which fail are backed off exponentially. There is
also an improved inspection and querying API: \fB_scheduler/jobs\fP and
\fB_scheduler/docs\fP:
.INDENT 2.0
.IP \(bu 2
\fB_scheduler/jobs\fP : This endpoint shows active replication
jobs. These are jobs managed by the scheduler. Some of them might
be running, some might be waiting to run, or backed off
(penalized) because they crashed too many times. Semantically this
is somewhat equivalent to \fB_active_tasks\fP but focuses only on
replications. Jobs which have completed or which were never
created because of malformed replication documents will not be
shown here as they are not managed by the scheduler.
\fB_replicate\fP replications, started form _replicate endpoint not
from a document in a \fB_replicator\fP db, will also show up here.
.IP \(bu 2
\fB_scheduler/docs\fP : This endpoint is an improvement on having to go
back and read replication documents to query their state. It
represents the state of all the replications started from
documents in _replicator db. Unlike \fB_scheduler/jobs\fP it will also
show jobs which have failed or have completed.
.UNINDENT
.sp
By default, scheduling replicator will not update documents with
transient states like \fBtriggered\fP or \fBerror\fP anymore, instead
\fB_scheduler/docs\fP API should be used to query replication document
states.
.UNINDENT
.SS Other scheduling replicator improvements
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.IP \(bu 2
Network resource usage and performance was improved by
implementing a shared connection pool. This should help in cases
of a large number of connections to the same sources or
target. Previously connection pools were shared only within a
single replication job.
.IP \(bu 2
Improved request rate limit handling. Replicator requests will
auto\-discover rate limit capacity on targets and sources based on
a proven Additive Increase / Multiplicative Decrease feedback
control algorithm.
.IP \(bu 2
Improved performance by having exponential backoff for all
replication jobs failures.  Previously there were some scenarios
were failure led to continuous repeated retries, consuming CPU and
disk resources in the process.
.IP \(bu 2
Improved recovery from long but temporary network
failure. Currently if replications jobs fail to start 10 times in
a row, they will not be retried anymore. This is sometimes
desirable, but in some cases, for example, after a sustained DNS
failure which eventually recovers, replications reach their retry
limit, stop retrying and never recover. Previously it required
user intervention to continue. Scheduling replicator will never
give up retrying a valid scheduled replication job and so it
should recover automatically.
.IP \(bu 2
Better handling of filtered replications. Failing user filter code
fetches from the source will not block replicator manager and
stall other replications. Failing filter fetches will also be
backed off exponentially. Another improvement is when filter code
changes on the source, a running replication will detect that and
restart itself with a new replication ID automatically.
.UNINDENT
.UNINDENT
.UNINDENT
.sp
The 2.1.0 release also includes the following minor improvements:
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-1946\fP: Hibernate couch_stream after each write (up to 70% reduction
in memory usage during replication of DBs with large attachments)
.IP \(bu 2
\fI\%COUCHDB\-2964\fP: Investigate switching replicator manager change feeds to
using “normal” instead of “longpoll”
.IP \(bu 2
\fI\%COUCHDB\-2988\fP: (mango) Allow query selector as changes and replication
filter
.IP \(bu 2
\fI\%COUCHDB\-2992\fP: Add additional support for document size
.IP \(bu 2
\fI\%COUCHDB\-3046\fP: Improve reduce function overflow protection
.IP \(bu 2
\fI\%COUCHDB\-3061\fP: Use vectored reads to search for buried headers in .couch
files. “On a modern linux system with SSD, we see improvements up to 15x.”
.IP \(bu 2
\fI\%COUCHDB\-3063\fP: “stale=ok” option replaced with new “stable” and “update”
options.
.IP \(bu 2
\fI\%COUCHDB\-3180\fP: Add features list in the welcome message
.IP \(bu 2
\fI\%COUCHDB\-3203\fP: Make auth handlers configurable (in ini files)
.IP \(bu 2
\fI\%COUCHDB\-3234\fP: Track open shard timeouts with a counter instead of logging
.IP \(bu 2
\fI\%COUCHDB\-3242\fP: Make get view group info timeout in couch_indexer
configurable
.IP \(bu 2
\fI\%COUCHDB\-3249\fP: Add config to disable index all fields (text indexes)
.IP \(bu 2
\fI\%COUCHDB\-3251\fP: Remove hot loop usage of filename:rootname/1
.IP \(bu 2
\fI\%COUCHDB\-3284\fP: 8Kb read\-ahead in couch_file causes extra IO and binary
memory usage
.IP \(bu 2
\fI\%COUCHDB\-3298\fP: Optimize writing btree nodes
.IP \(bu 2
\fI\%COUCHDB\-3302\fP: (Improve) Attachment replication over low bandwidth network
connections
.IP \(bu 2
\fI\%COUCHDB\-3307\fP: Limit calls to maybe_add_sys_db_callbacks to once per db
open
.IP \(bu 2
\fI\%COUCHDB\-3318\fP: bypass couch_httpd_vhost if there are none
.IP \(bu 2
\fI\%COUCHDB\-3323\fP: Idle dbs cause excessive overhead
.IP \(bu 2
\fI\%COUCHDB\-3324\fP: Introduce couch_replicator_scheduler
.IP \(bu 2
\fI\%COUCHDB\-3337\fP: End\-point _local_docs doesn’t conform to query params of
_all_docs
.IP \(bu 2
\fI\%COUCHDB\-3358\fP: (mango) Use efficient set storage for field names
.IP \(bu 2
\fI\%COUCHDB\-3425\fP: Make _doc_ids _changes filter fast\-path limit configurable
.IP \(bu 2
\fI\%#457\fP: TeX/LaTeX/texinfo removed from default docs build chain
.IP \(bu 2
\fI\%#469\fP: (mango) Choose index based on fields match
.IP \(bu 2
\fI\%#483\fP: couchup database migration tool
.IP \(bu 2
\fI\%#582\fP: Add X\-Frame\-Options support to help protect against
clickjacking
.IP \(bu 2
\fI\%#593\fP: Allow bind address of 127.0.0.1 in \fB_cluster_setup\fP for
single nodes
.IP \(bu 2
\fI\%#624\fP: Enable compaction daemon by default
.IP \(bu 2
\fI\%#626\fP: Allow enable node decom using string “true”
.IP \(bu 2
(mango) Configurable default limit, defaults to 25.
.IP \(bu 2
(mango) _design documents ignored when querying _all_docs
.IP \(bu 2
(mango) add $allMatch selector
.IP \(bu 2
Add local.d/default.d directories by default and document
.IP \(bu 2
Improved INSTALL.* text files
.UNINDENT
.UNINDENT
.UNINDENT
.SS Fixed Issues
.sp
The 2.1.0 release includes fixes for the following issues:
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-1447\fP: X\-Couch\-Update\-NewRev header is missed if custom headers are
specified in response of _update handler (missed in 2.0 merge)
.IP \(bu 2
\fI\%COUCHDB\-2731\fP: Authentication DB was not considered a system DB
.IP \(bu 2
\fI\%COUCHDB\-3010\fP: (Superseded fix for replication exponential backoff)
.IP \(bu 2
\fI\%COUCHDB\-3090\fP: Error when handling empty “Access\-Control\-Request\-Headers”
header
.IP \(bu 2
\fI\%COUCHDB\-3100\fP: Fix documentation on require_valid_user
.IP \(bu 2
\fI\%COUCHDB\-3109\fP: 500 when include_docs=true for linked documents
.IP \(bu 2
\fI\%COUCHDB\-3113\fP: fabric:open_revs can return {ok, []}
.IP \(bu 2
\fI\%COUCHDB\-3149\fP: Exception written to the log if db deleted while there is a
change feed running
.IP \(bu 2
\fI\%COUCHDB\-3150\fP: Update all shards with stale=update_after
.IP \(bu 2
\fI\%COUCHDB\-3158\fP: Fix a crash when connection closes for _update
.IP \(bu 2
\fI\%COUCHDB\-3162\fP: Default ssl settings cause a crash
.IP \(bu 2
\fI\%COUCHDB\-3164\fP: Request fails when using
_changes?feed=eventsource&heartbeat=30000
.IP \(bu 2
\fI\%COUCHDB\-3168\fP: Replicator doesn’t handle well writing documents to a target
db which has a small max_document_size
.IP \(bu 2
\fI\%COUCHDB\-3173\fP: Views return corrupt data for text fields containing non\-BMP
characters
.IP \(bu 2
\fI\%COUCHDB\-3174\fP: max_document_size setting can by bypassed by issuing
multipart/related requests
.IP \(bu 2
\fI\%COUCHDB\-3178\fP: Fabric does not send message when filtering lots of documents
.IP \(bu 2
\fI\%COUCHDB\-3181\fP: function_clause error when adding attachment to doc in _users
db
.IP \(bu 2
\fI\%COUCHDB\-3184\fP: couch_mrview_compactor:recompact/1 does not handle errors in
spawned process
.IP \(bu 2
\fI\%COUCHDB\-3193\fP: fabric:open_revs returns multiple results when one of the
shards has stem_interactive_updates=false
.IP \(bu 2
\fI\%COUCHDB\-3199\fP: Replicator VDU function doesn’t account for an already
malformed document in replicator db
.IP \(bu 2
\fI\%COUCHDB\-3202\fP: (mango) do not allow empty field names
.IP \(bu 2
\fI\%COUCHDB\-3220\fP: Handle timeout in _revs_diff
.IP \(bu 2
\fI\%COUCHDB\-3222\fP: (Fix) HTTP code 500 instead of 400 for invalid key during
document creation
.IP \(bu 2
\fI\%COUCHDB\-3231\fP: Allow fixing users’ documents (type and roles)
.IP \(bu 2
\fI\%COUCHDB\-3232\fP: user context not passed down in fabric_view_all_docs
.IP \(bu 2
\fI\%COUCHDB\-3238\fP: os_process_limit documentation wrong
.IP \(bu 2
\fI\%COUCHDB\-3241\fP: race condition in couch_server if delete msg for a db is
received before open_result msg
.IP \(bu 2
\fI\%COUCHDB\-3245\fP: Make couchjs \-S option take effect again
.IP \(bu 2
\fI\%COUCHDB\-3252\fP: Include main\-coffee.js in release artifact (broken
CoffeeScript view server)
.IP \(bu 2
\fI\%COUCHDB\-3255\fP: Conflicts introduced by recreating docs with attachments
.IP \(bu 2
\fI\%COUCHDB\-3259\fP: Don’t trap exits in couch_file
.IP \(bu 2
\fI\%COUCHDB\-3264\fP: POST to _all_docs does not respect conflicts=true
.IP \(bu 2
\fI\%COUCHDB\-3269\fP: view response can ‘hang’ with filter and limit specified
.IP \(bu 2
\fI\%COUCHDB\-3271\fP: Replications crash with ‘kaboom’ exit
.IP \(bu 2
\fI\%COUCHDB\-3274\fP: eof in couch_file can be incorrect after error
.IP \(bu 2
\fI\%COUCHDB\-3277\fP: Replication manager crashes when it finds _replicator db
shards which are not part of a mem3 db
.IP \(bu 2
\fI\%COUCHDB\-3286\fP: Validation function throwing unexpected json crashes with
function_clause
.IP \(bu 2
\fI\%COUCHDB\-3289\fP: handle error clause when calling fabric:open_revs
.IP \(bu 2
\fI\%COUCHDB\-3291\fP: Excessively long document IDs prevent replicator from making
progress
.IP \(bu 2
\fI\%COUCHDB\-3293\fP: Allow limiting length of document ID (for CouchDB proper)
.IP \(bu 2
\fI\%COUCHDB\-3305\fP: (mango) don’t crash with invalid input to built in reducer
function
.IP \(bu 2
\fI\%COUCHDB\-3362\fP: DELETE attachment on non\-existing document creates the
document, rather than returning 404
.IP \(bu 2
\fI\%COUCHDB\-3364\fP: Don’t crash compactor when compacting process fails.
.IP \(bu 2
\fI\%COUCHDB\-3367\fP: Require server admin user for db/_compact and db_view_cleanup
endpoints
.IP \(bu 2
\fI\%COUCHDB\-3376\fP: Fix mem3_shards under load
.IP \(bu 2
\fI\%COUCHDB\-3378\fP: Fix mango full text detection
.IP \(bu 2
\fI\%COUCHDB\-3379\fP: Fix couch_auth_cache reinitialization logic
.IP \(bu 2
\fI\%COUCHDB\-3400\fP: Notify couch_index_processes on all shards when ddoc updated
.IP \(bu 2
\fI\%COUCHDB\-3402\fP: race condition in mem3 startup
.IP \(bu 2
\fI\%#511\fP: (mango) \ Return false for empty list
.IP \(bu 2
\fI\%#595\fP: Return 409 to PUT attachment with non\-existent rev
.IP \(bu 2
\fI\%#623\fP: Ensure replicator _active_tasks entry reports recent pending
changes value
.IP \(bu 2
\fI\%#627\fP: Pass UserCtx to fabric’s all_docs from mango query
.IP \(bu 2
\fI\%#631\fP: fix couchdb_os_proc_pool eunit timeouts
.IP \(bu 2
\fI\%#644\fP: Make couch_event_sup:stop/1 synchronous
.IP \(bu 2
\fI\%#645\fP: Pass db open options to fabric_view_map for _view and _list
queries on _users DB
.IP \(bu 2
\fI\%#648\fP: Fix couch_replicator_changes_reader:process_change
.IP \(bu 2
\fI\%#649\fP: Avoid a race when restarting an index updater
.IP \(bu 2
\fI\%#667\fP: Prevent a terrible race condition
.IP \(bu 2
\fI\%#677\fP: Make replication filter fetch error for _replicate return a
404
.IP \(bu 2
Fix CORS \fBmax_age\fP configuration parameter via Access\-Control\-Max\-Age
.IP \(bu 2
Chunk missing revisions before attempting to save on target (improves
replication for very conflicted, very deep revision tree documents)
.IP \(bu 2
Allow w parameter for attachments
.IP \(bu 2
Return “Bad Request” when count in \fB/_uuids\fP exceeds max
.IP \(bu 2
Fix crashes when replicator db is deleted
.IP \(bu 2
Skip internal replication if changes already replicated
.IP \(bu 2
Fix encoding issues on \fB_update/../doc_id\fP and PUT attachments
.UNINDENT
.SS 2.0.x Branch
.INDENT 0.0
.IP \(bu 2
\fI\%Version 2.0.0\fP
.IP \(bu 2
\fI\%Upgrade Notes\fP
.IP \(bu 2
\fI\%Known Issues\fP
.IP \(bu 2
\fI\%Breaking Changes\fP
.UNINDENT
.SS Version 2.0.0
.INDENT 0.0
.IP \(bu 2
Native clustering is now supported. Rather than use CouchDB replication
between multiple, distinct CouchDB servers, configure a cluster of CouchDB
nodes. These nodes will use an optimized Erlang\-driven ‘internal replication’
to ensure data durability and accessibility. Combine a clustered CouchDB with
a load balancer (such as \fBhaproxy\fP) to scale CouchDB out horizontally. More
details of the clustering feature are available in the \fI\%Cluster Management\fP\&.
.IP \(bu 2
\fIFuton\fP replaced by brand\-new, completely re\-engineered \fIFauxton\fP interface.
URL remains the same.
.IP \(bu 2
The new Mango Query Server provides a simple JSON\-based way to perform CouchDB
queries without JavaScript or MapReduce. Mango Queries have a similar indexing
speed advantage over JavaScript Queries than the Erlang Queries have (2x\-10x
faster indexing depending on doc size and system configuration). We recommend
all new apps start using Mango as a default. Further details are available
in the \fI\%_find, _index and _explain API\fP\&.
.IP \(bu 2
Mango \fI\%selectors\fP can be used in _changes
feeds instead of JavaScript MapReduce filters. Mango has been tested to be
up to an order of magnitude (10x) faster than JavaScript in this application.
.IP \(bu 2
\fI\%Rewrite rules\fP for URLs can be performed using
JavaScript functions.
.IP \(bu 2
\fI\%Multiple queries\fP can be made of a
view with a single HTTP request.
.IP \(bu 2
Views can be queried with sorting turned off ( \fBsorted=false\fP) for a
performance boost.
.IP \(bu 2
The global changes feed has been enhanced. It is now resumable and persistent.
.IP \(bu 2
New endpoints added (documentation forthcoming):
.INDENT 2.0
.IP \(bu 2
\fI\%/_membership\fP shows all nodes in a cluster
.IP \(bu 2
\fB/_bulk_get\fP speeds up the replication protocol over low\-latency
connections
.IP \(bu 2
\fB/_node/\fP api to access individual nodes’ configuration and compaction
features
.IP \(bu 2
\fB/_cluster_setup\fP api to set up a cluster from scratch.
.IP \(bu 2
\fB/_up\fP api to signal health of a node to a load\-balancer
.IP \(bu 2
\fB/db/_local_docs\fP and \fB/db/_design_docs\fP (similar to \fB/db/_all_docs\fP)
.UNINDENT
.IP \(bu 2
The \fB/_log\fP endpoint was removed.
.IP \(bu 2
“Backend” interface on port 5986 used for specific cluster admin tasks. Of
interest are the \fB_nodes\fP and \fB_dbs\fP databases visible only through this
interface.
.IP \(bu 2
Support added for Erlang/OTP 17.x, 18.x and 19
.IP \(bu 2
New streamlined build system written for Unix\-like systems and Microsoft
Windows
.IP \(bu 2
\fI\%Configuration\fP has moved from \fB/_config\fP to
\fB/_node/{node\-name}/_config\fP
.IP \(bu 2
\fBinstance_start_time\fP now always reports \fB\(dq0\(dq\fP\&.
.UNINDENT
.SS Upgrade Notes
.INDENT 0.0
.IP \(bu 2
The update sequences returned by the \fI\%/db/_changes\fP feed are no longer
integers. They can be any JSON value. Applications should treat them as opaque
values and return them to CouchDB as\-is.
.IP \(bu 2
Temporary views are no longer supported.
.IP \(bu 2
It is possible to have multiple replicator databases.
\fBreplicator/db\fP config option has been removed.
Instead \fB_replicator\fP and any database names ending
with the \fB/_replicator\fP suffix will be recognized as
replicator databases by the system.
.IP \(bu 2
Note that the semantics of some API calls have changed due to the introduction
of the clustering feature. Specifically, make note of the difference between
receiving a \fB201\fP and a \fB202\fP when storing a document.
.IP \(bu 2
\fBall_or_nothing\fP is no longer supported by the \fI\%bulk_docs\fP API
.IP \(bu 2
After updating a design document containing a \fBshow\fP, an immediate GET to
that same \fBshow\fP function may still return results from the previous
definition. This is due to design document caching, which may take a few
seconds to fully evict, or longer (up to ~30s) for a clustered installation.
.UNINDENT
.SS Known Issues
.sp
All \fI\%known issues\fP filed against the 2.0 release are contained within the
official \fICouchDB JIRA instance\fP or \fICouchDB GitHub Issues\fP\&.
.sp
The following are some highlights of known issues for which fixes did not land
in time for the 2.0.0 release:
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-2980\fP: The replicator (whether invoked via \fB_replicate\fP or a
document stored in the \fB_replicator\fP database) understands two kinds of
source and target:
.INDENT 2.0
.IP 1. 3
A URL (e.g., \fBhttps://foo:bar@foo.com/db1\fP), called a “remote” source or
target
.IP 2. 3
A database name (e.g., \fBdb1\fP), called a “local” source or target.
.UNINDENT
.sp
Whenever the latter type is used, this refers to a local unclustered
database, not a clustered one.
.sp
In a future release we hope to support “local” source or target specs to
clustered databases. For now, we recommend always using the URL format for
both source and target specifications.
.IP \(bu 2
\fI\%COUCHDB\-3034\fP: CouchDB will occasionally return 500 errors when multiple
clients attempt to PUT or DELETE the same database concurrently.
.IP \(bu 2
\fI\%COUCHDB\-3119\fP: Adding nodes to a cluster fails if the Erlang node name
is not \fBcouchdb\fP (of the form \fBcouchdb@hostname\fP\&.)
.IP \(bu 2
\fI\%COUCHDB\-3050\fP: Occasionally the \fBdev/run\fP script used for development
purposes to start a local 3\-node cluster will fail to start one or more
nodes.
.IP \(bu 2
\fI\%COUCHDB\-2817\fP: The compaction daemon will only compact views for shards
that contain the design document.
.IP \(bu 2
\fI\%COUCHDB\-2804\fP: The fast_view optimization is not enabled on the clustered
interface.
.IP \(bu 2
\fI\%#656\fP: The OAuth 1.0 support is broken and deprecated. It will be
removed in a future version of CouchDB.
.UNINDENT
.SS Breaking Changes
.sp
The following changes in 2.0 represent a significant deviation from
CouchDB 1.x and may alter behaviour of systems designed to work with
older versions of CouchDB:
.INDENT 0.0
.IP \(bu 2
\fI\%#620\fP: \fBPOST /dbname\fP no longer returns an ETag response header,
in compliance with RFC 7231, Section 7.2.
.UNINDENT
.SS 1.7.x Branch
.INDENT 0.0
.IP \(bu 2
\fI\%Version 1.7.2\fP
.IP \(bu 2
\fI\%Version 1.7.1\fP
.IP \(bu 2
\fI\%Version 1.7.0\fP
.UNINDENT
.SS Version 1.7.2
.SS Security
.INDENT 0.0
.IP \(bu 2
\fI\%CVE 2018\-8007\fP
.UNINDENT
.SS Version 1.7.1
.SS Bug Fix
.INDENT 0.0
.IP \(bu 2
\fI\%#974\fP: Fix access to /db/_all_docs for database members.
.UNINDENT
.SS Version 1.7.0
.SS Security
.INDENT 0.0
.IP \(bu 2
\fI\%CVE 2017\-12635\fP
.IP \(bu 2
\fI\%CVE 2017\-12636\fP
.UNINDENT
.SS API Changes
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-1356\fP: Return username on \fI\%POST /_session\fP\&.
.IP \(bu 2
\fI\%COUCHDB\-1876\fP: Fix duplicated Content\-Type for show/update functions.
.IP \(bu 2
\fI\%COUCHDB\-2310\fP: Implement \fI\%POST /{db}/_bulk_get\fP\&.
.IP \(bu 2
\fI\%COUCHDB\-2375\fP: \fI\%400 Bad Request\fP returned when invalid revision specified.
.IP \(bu 2
\fI\%COUCHDB\-2845\fP: \fI\%400 Bad Request\fP returned when \fIrevs\fP is not a list.
.UNINDENT
.SS Build
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-1964\fP: Replace etap test suite with EUnit.
.IP \(bu 2
\fI\%COUCHDB\-2225\fP: Enforce that shared libraries can be built by the system.
.IP \(bu 2
\fI\%COUCHDB\-2761\fP: Support glibc >= 2.20.
.IP \(bu 2
\fI\%COUCHDB\-2747\fP: Support Erlang 18.
.IP \(bu 2
\fI\%#5b9742c\fP: Support Erlang 19.
.IP \(bu 2
\fI\%#1545bf4\fP: Remove broken benchmarks.
.UNINDENT
.SS Database Core
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-2534\fP: Improve checks for db admin/member.
.IP \(bu 2
\fI\%COUCHDB\-2735\fP: Duplicate document _ids created under high edit load.
.UNINDENT
.SS Documentation
.INDENT 0.0
.IP \(bu 2
\fI\%#c3c9588\fP: Improve documentation of \fIcacert_file\fP ssl option.
.IP \(bu 2
\fI\%#3266f23\fP: Clarify the purpose of tombstones.
.IP \(bu 2
\fI\%#75887d9\fP: Improve CouchDB Replication Protocol definition.
.IP \(bu 2
\fI\%#3b1dc0f\fP: Remove mention of \fIgroup_level=exact\fP\&.
.IP \(bu 2
\fI\%#2a11daa\fP: Remove mention of “Test Suite” in Futon.
.IP \(bu 2
\fI\%#01c60f1\fP: Clarify type of key, startkey and endkey params.
.UNINDENT
.SS Futon
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-241\fP: Support document copying.
.IP \(bu 2
\fI\%COUCHDB\-1011\fP: Run replication filtered by document ids from Futon.
.IP \(bu 2
\fI\%COUCHDB\-1275\fP: Unescape database names in Futon recently used list.
.IP \(bu 2
\fI\%#f18f82a\fP: Update jquery.ui to 1.10.4 with fixes of potential
XSS issues.
.UNINDENT
.SS HTTP Server
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-2430\fP: Disable Nagle’s algorithm by default.
.IP \(bu 2
\fI\%COUCHDB\-2583\fP: Don’t drop connection by the endpoints which doesn’t require
any payload.
.IP \(bu 2
\fI\%COUCHDB\-2673\fP: Properly escape Location: HTTP header.
.IP \(bu 2
\fI\%COUCHDB\-2677\fP: Wrong Expires header weekday.
.IP \(bu 2
\fI\%COUCHDB\-2783\fP: Bind both to IPv4 and IPv6.
.IP \(bu 2
\fI\%#f30f3dd\fP: Support for user configurable SSL ciphers.
.UNINDENT
.SS Query Server
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-1447\fP: Custom response headers from design functions get merged with
default ones.
.IP \(bu 2
\fI\%#7779c11\fP: Upgrade Coffeescript to version 1.10.
.UNINDENT
.SS jquery.couch.js
.INDENT 0.0
.IP \(bu 2
\fI\%#f9095e7\fP: Fix document copying.
.UNINDENT
.SS 1.6.x Branch
.INDENT 0.0
.IP \(bu 2
\fI\%Upgrade Notes\fP
.IP \(bu 2
\fI\%Version 1.6.0\fP
.UNINDENT
.SS Upgrade Notes
.sp
The \fI\%Proxy Authentication\fP handler was renamed to
\fBproxy_authentication_handler\fP to follow the \fB*_authentication_handler\fP form
of all other handlers. The old \fBproxy_authentification_handler\fP name is marked
as deprecated and will be removed in future releases. It’s strongly recommended
to update \fBhttpd/authentication_handlers\fP option with new value
in case if you had used such handler.
.SS Version 1.6.0
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-2200\fP: support Erlang/OTP 17.0 \fI\%#35e16032\fP
.IP \(bu 2
Fauxton: many improvements in our experimental new user interface, including
switching the code editor from CodeMirror to Ace as well as better support
for various browsers.
.IP \(bu 2
Add the \fBmax_count\fP option (\fI\%UUIDs Configuration\fP) to allow rate\-limiting
the amount of UUIDs that can be requested from the \fI\%/_uuids\fP
handler in a single request (\fI\%CVE 2014\-2668\fP).
.IP \(bu 2
\fI\%COUCHDB\-1986\fP: increase socket buffer size to improve replication speed
for large documents and attachments, and fix tests on BSD\-like systems.
\fI\%#9a0e561b\fP
.IP \(bu 2
\fI\%COUCHDB\-1953\fP: improve performance of multipart/related requests.
\fI\%#ce3e89dc\fP
.IP \(bu 2
\fI\%COUCHDB\-2221\fP: verify that authentication\-related configuration settings
are well\-formed. \fI\%#dbe769c6\fP
.IP \(bu 2
\fI\%COUCHDB\-1922\fP: fix CORS exposed headers. \fI\%#4f619833\fP
.IP \(bu 2
Rename \fBproxy_authentification_handler\fP to \fBproxy_authentication_handler\fP\&.
\fI\%#c66ac4a8\fP
.IP \(bu 2
\fI\%COUCHDB\-1795\fP: ensure the startup script clears the pid file on termination.
\fI\%#818ef4f9\fP
.IP \(bu 2
\fI\%COUCHDB\-1962\fP: replication can now be performed without having write access
to the source database (\fI\%#1d5fe2aa\fP), the replication checkpoint
interval is now configurable (\fI\%#0693f98e\fP).
.IP \(bu 2
\fI\%COUCHDB\-2025\fP: add support for SOCKS5 proxies for replication.
\fI\%#fcd76c9\fP
.IP \(bu 2
\fI\%COUCHDB\-1930\fP: redirect to the correct page after submitting a new document
with a different ID than the one suggested by Futon. \fI\%#4906b591\fP
.IP \(bu 2
\fI\%COUCHDB\-1923\fP: add support for \fIattachments\fP and \fIatt_encoding_info\fP options
(formerly only available on the documents API) to the view API.
\fI\%#ca41964b\fP
.IP \(bu 2
\fI\%COUCHDB\-1647\fP: for failed replications originating from a document in the
\fI_replicator\fP database, store the failure reason in the document.
\fI\%#08cac68b\fP
.IP \(bu 2
A number of improvements for the documentation.
.UNINDENT
.SS 1.5.x Branch
.INDENT 0.0
.IP \(bu 2
\fI\%Version 1.5.1\fP
.IP \(bu 2
\fI\%Version 1.5.0\fP
.UNINDENT
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
\fI\%Version 1.5.1\fP contains important security fixes. Previous \fI1.5.x\fP
releases are not recommended for regular usage.
.UNINDENT
.UNINDENT
.SS Version 1.5.1
.INDENT 0.0
.IP \(bu 2
Add the \fBmax_count\fP option (\fI\%UUIDs Configuration\fP) to allow rate\-limiting
the amount of UUIDs that can be requested from the \fI\%/_uuids\fP
handler in a single request (\fI\%CVE 2014\-2668\fP).
.UNINDENT
.SS Version 1.5.0
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-1781\fP: The official documentation has been overhauled. A lot of
content from other sources have been merged, and the index page
has been rebuilt to make the docs much more accessible.
\fI\%#54813a7\fP
.IP \(bu 2
A new administration UI, codenamed Fauxton, has been included as an
experimental preview. It can be accessed at \fB/_utils/fauxton/\fP\&. There
are too many improvements here to list them all. We are looking for
feedback from the community on this preview release.
.IP \(bu 2
\fI\%COUCHDB\-1888\fP: Fixed an issue where admin users would be restricted by
the \fBpublic_fields\fP feature.
.IP \(bu 2
Fixed an issue with the JavaScript CLI test runner. \fI\%#be76882\fP,
\fI\%#54813a7\fP
.IP \(bu 2
\fI\%COUCHDB\-1867\fP: An experimental plugin feature has been added. See
\fBsrc/couch_plugin/README.md\fP for details. We invite the community to
test and report any findings.
.IP \(bu 2
\fI\%COUCHDB\-1894\fP: An experimental Node.js\-based query server runtime
has been added. See \fI\%Experimental Features\fP for details. We invite the
community to test and report any findings.
.IP \(bu 2
\fI\%COUCHDB\-1901\fP: Better retry mechanism for transferring attachments
during replication. \fI\%#4ca2cec\fP
.UNINDENT
.SS 1.4.x Branch
.INDENT 0.0
.IP \(bu 2
\fI\%Upgrade Notes\fP
.IP \(bu 2
\fI\%Version 1.4.0\fP
.UNINDENT
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
\fI\%1.4.x Branch\fP is affected by the issue described in \fI\%CVE\-2014\-2668: DoS (CPU and memory consumption) via the count parameter to /_uuids\fP\&.
Upgrading to a more recent release is strongly recommended.
.UNINDENT
.UNINDENT
.SS Upgrade Notes
.sp
We now support Erlang/OTP R16B and R16B01; the minimum required version is R14B.
.sp
User document role values must now be strings. Other types of values will be
refused when saving the user document.
.SS Version 1.4.0
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-1139\fP: it’s possible to apply \fI\%list\fP
functions to \fB_all_docs\fP view. \fI\%#54fd258e\fP
.IP \(bu 2
\fI\%COUCHDB\-1632\fP: Ignore epilogues in \fBmultipart/related\fP MIME attachments.
\fI\%#2b4ab67a\fP
.IP \(bu 2
\fI\%COUCHDB\-1634\fP: Reduce PBKDF2 work factor. \fI\%#f726bc4d\fP
.IP \(bu 2
\fI\%COUCHDB\-1684\fP: Support for server\-wide changes feed reporting on creation,
updates and deletion of databases. \fI\%#917d8988\fP
.IP \(bu 2
\fI\%COUCHDB\-1772\fP: Prevent invalid JSON output when using \fIall_or_nothing\fP
\fI\%of bulk API\fP\&. \fI\%#dfd39d57\fP
.IP \(bu 2
Add a \fBconfigurable whitelist\fP
of user document properties. \fI\%#8d7ab8b1\fP
.IP \(bu 2
\fI\%COUCHDB\-1852\fP: Support Last\-Event\-ID header in EventSource changes feeds.
\fI\%#dfd2199a\fP
.IP \(bu 2
Allow storing pre\-hashed admin passwords via \fI\%config API\fP\&.
\fI\%#c98ba561\fP
.IP \(bu 2
Automatic loading of CouchDB plugins. \fI\%#3fab6bb5\fP
.IP \(bu 2
Much improved documentation, including an \fI\%expanded description\fP of \fIvalidate_doc_update\fP functions (commit:\fIef9ac469\fP) and
a description of how  CouchDB handles JSON \fI\%number values\fP (\fI\%#bbd93f77\fP).
.IP \(bu 2
Split up \fIreplicator_db\fP tests into multiple independent tests.
.UNINDENT
.SS 1.3.x Branch
.INDENT 0.0
.IP \(bu 2
\fI\%Upgrade Notes\fP
.IP \(bu 2
\fI\%Version 1.3.1\fP
.IP \(bu 2
\fI\%Version 1.3.0\fP
.UNINDENT
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
\fI\%1.3.x Branch\fP is affected by the issue described in
\fI\%CVE\-2014\-2668: DoS (CPU and memory consumption) via the count parameter to /_uuids\fP\&. Upgrading to a more recent release is strongly
recommended.
.UNINDENT
.UNINDENT
.SS Upgrade Notes
.sp
You can upgrade your existing CouchDB 1.0.x installation to 1.3.0
without any specific steps or migration. When you run CouchDB, the
existing data and index files will be opened and used as normal.
.sp
The first time you run a compaction routine on your database within 1.3.0,
the data structure and indexes will be updated to the new version of the
CouchDB database format that can only be read by CouchDB 1.3.0 and later.
This step is not reversible. Once the data files have been updated and
migrated to the new version the data files will no longer work with a
CouchDB 1.0.x release.
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
If you want to retain support for opening the data files in
CouchDB 1.0.x you must back up your data files before performing the
upgrade and compaction process.
.UNINDENT
.UNINDENT
.SS Version 1.3.1
.SS Replicator
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-1788\fP: Tolerate missing source and target fields in _replicator docs.
\fI\%#869f42e2\fP
.UNINDENT
.SS Log System
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-1794\fP: Fix bug in WARN level logging from 1.3.0.
.IP \(bu 2
Don’t log about missing .compact files. \fI\%#06f1a8dc\fP
.UNINDENT
.SS View Server
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-1792\fP: Fix the \-S option to couchjs to increase memory limits.
\fI\%#cfaa66cd\fP
.UNINDENT
.SS Miscellaneous
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-1784\fP: Improvements to test suite and VPATH build system.
\fI\%#01afaa4f\fP
.IP \(bu 2
Improve documentation: better structure, improve language, less duplication.
.UNINDENT
.SS Version 1.3.0
.SS Database core
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-1512\fP: Validate bind address before assignment. \fI\%#09ead8a0\fP
.IP \(bu 2
Restore \fBmax_document_size\fP protection. \fI\%#bf1eb135\fP
.UNINDENT
.SS Documentation
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-1523\fP: Import CouchBase documentation and convert them into
\fI\%Sphinx docs\fP
.UNINDENT
.SS Futon
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-509\fP: Added view request duration to Futon. \fI\%#2d2c7d1e\fP
.IP \(bu 2
\fI\%COUCHDB\-627\fP: Support all timezones. \fI\%#b1a049bb\fP
.IP \(bu 2
\fI\%COUCHDB\-1383\fP: Futon view editor won’t allow you to save original view after
saving a revision. \fI\%#ce48342\fP
.IP \(bu 2
\fI\%COUCHDB\-1470\fP: Futon raises pop\-up on attempt to navigate to missed/deleted
document. \fI\%#5da40eef\fP
.IP \(bu 2
\fI\%COUCHDB\-1473\fP, \fI\%COUCHDB\-1472\fP: Disable buttons for actions that the user
doesn’t have permissions to. \fI\%#7156254d\fP
.UNINDENT
.SS HTTP Interface
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-431\fP: Introduce experimental \fI\%CORS support\fP\&.
\fI\%#b90e4021\fP
.IP \(bu 2
\fI\%COUCHDB\-764\fP, \fI\%COUCHDB\-514\fP, \fI\%COUCHDB\-430\fP: Fix sending HTTP headers from
\fB_list\fP function, \fI\%#2a74f88375\fP
.IP \(bu 2
\fI\%COUCHDB\-887\fP: Fix \fBbytes\fP and \fBoffset\fP parameters semantic for \fI_log\fP
resource (\fI\%explanation\fP)
\fI\%#ad700014\fP
.IP \(bu 2
\fI\%COUCHDB\-986\fP: Added Server\-Sent Events protocol to db changes API.
See \fI\%http://www.w3.org/TR/eventsource/\fP for details. \fI\%#093d2aa6\fP
.IP \(bu 2
\fI\%COUCHDB\-1026\fP: Database names are encoded with respect of special characters
in the rewriter now. \fI\%#272d6415\fP
.IP \(bu 2
\fI\%COUCHDB\-1097\fP: Allow \fIOPTIONS\fP request to shows and lists functions.
\fI\%#9f53704a\fP
.IP \(bu 2
\fI\%COUCHDB\-1210\fP: Files starting with underscore can be attached and updated now.
\fI\%#05858792\fP
.IP \(bu 2
\fI\%COUCHDB\-1277\fP: Better query parameter support and code clarity:
\fI\%#7e3c69ba\fP
.INDENT 2.0
.IP \(bu 2
Responses to documents created/modified via form data \fIPOST\fP to /db/doc or
copied with \fICOPY\fP should now include \fILocation\fP header.
.IP \(bu 2
Form data POST to /db/doc now includes an \fIETag\fP response header.
.IP \(bu 2
\fB?batch=ok\fP is now supported for \fICOPY\fP and \fIPOST\fP /db/doc updates.
.IP \(bu 2
\fB?new_edits=false\fP is now supported for more operations.
.UNINDENT
.IP \(bu 2
\fI\%COUCHDB\-1285\fP: Allow configuration of vendor and modules version in CouchDB
welcome message. \fI\%#3c24a94d\fP
.IP \(bu 2
\fI\%COUCHDB\-1321\fP: Variables in rewrite rules breaks OAuth authentication.
\fI\%#c307ba95\fP
.IP \(bu 2
\fI\%COUCHDB\-1337\fP: Use MD5 for attachment ETag header value. \fI\%#6d912c9f\fP
.IP \(bu 2
\fI\%COUCHDB\-1381\fP: Add jquery.couch support for Windows 8 Metro apps.
\fI\%#dfc5d37c\fP
.IP \(bu 2
\fI\%COUCHDB\-1441\fP: Limit recursion depth in the URL rewriter.
Defaults to a maximum of 100 invocations but is configurable.
\fI\%#d076976c\fP
.IP \(bu 2
\fI\%COUCHDB\-1442\fP: No longer rewrites the \fIX\-CouchDB\-Requested\-Path\fP during
recursive calls to the rewriter. \fI\%#56744f2f\fP
.IP \(bu 2
\fI\%COUCHDB\-1501\fP: \fI\%Changes feed\fP now can take special parameter
\fBsince=now\fP to emit changes since current point of time. \fI\%#3bbb2612\fP
.IP \(bu 2
\fI\%COUCHDB\-1502\fP: Allow users to delete own _users doc. \fI\%#f0d6f19bc8\fP
.IP \(bu 2
\fI\%COUCHDB\-1511\fP: CouchDB checks \fIroles\fP field for \fI_users\fP database documents
with more care. \fI\%#41205000\fP
.IP \(bu 2
\fI\%COUCHDB\-1537\fP: Include user name in show/list \fIETags\fP\&. \fI\%#ac320479\fP
.IP \(bu 2
Send a 202 response for \fI_restart\fP\&. \fI\%#b213e16f\fP
.IP \(bu 2
Make password hashing synchronous when using the /_config/admins API.
\fI\%#08071a80\fP
.IP \(bu 2
Add support to serve single file with CouchDB, \fI\%#2774531ff2\fP
.IP \(bu 2
Allow any 2xx code to indicate success, \fI\%#0d50103cfd\fP
.IP \(bu 2
Fix \fI_session\fP for IE7.
.IP \(bu 2
Restore 400 error for empty PUT, \fI\%#2057b895\fP
.IP \(bu 2
Return \fBX\-Couch\-Id\fP header if doc is created, \fI\%#98515bf0b9\fP
.IP \(bu 2
Support auth cookies with \fB:\fP characters, \fI\%#d9566c831d\fP
.UNINDENT
.SS Log System
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-1380\fP: Minor fixes for logrotate support.
.IP \(bu 2
Improve file I/O error logging and handling, \fI\%#4b6475da\fP
.IP \(bu 2
Module Level Logging, \fI\%#b58f069167\fP
.IP \(bu 2
Log 5xx responses at error level, \fI\%#e896b0b7\fP
.IP \(bu 2
Log problems opening database at ERROR level except for auto\-created
system dbs, \fI\%#41667642f7\fP
.UNINDENT
.SS Replicator
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-1248\fP: \fIHTTP 500\fP error now doesn’t occurs when replicating with
\fB?doc_ids=null\fP\&. \fI\%#bea76dbf\fP
.IP \(bu 2
\fI\%COUCHDB\-1259\fP: Stabilize replication id, \fI\%#c6252d6d7f\fP
.IP \(bu 2
\fI\%COUCHDB\-1323\fP: Replicator now acts as standalone application.
\fI\%#f913ca6e\fP
.IP \(bu 2
\fI\%COUCHDB\-1363\fP: Fix rarely occurred, but still race condition in changes feed
if a quick burst of changes happens while replication is starting the
replication can go stale. \fI\%#573a7bb9\fP
.IP \(bu 2
\fI\%COUCHDB\-1557\fP: Upgrade some code to use BIFs bring good improvements for
replication.
.UNINDENT
.SS Security
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-1060\fP: Passwords are now hashed using the PBKDF2 algorithm with a
configurable work factor. \fI\%#7d418134\fP
.UNINDENT
.SS Source Repository
.INDENT 0.0
.IP \(bu 2
The source repository was migrated from \fI\%SVN\fP to \fI\%Git\fP\&.
.UNINDENT
.SS Storage System
.INDENT 0.0
.IP \(bu 2
Fixed unnecessary conflict when deleting and creating a
document in the same batch.
.UNINDENT
.SS Test Suite
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-1321\fP: Moved the JS test suite to the CLI.
.IP \(bu 2
\fI\%COUCHDB\-1338\fP: Start CouchDB with \fBport=0\fP\&. While CouchDB might be already
running on the default port 5984, port number 0 let the TCP stack figure out a
free port to run. \fI\%#127cbe3\fP
.IP \(bu 2
\fI\%COUCHDB\-1339\fP: Use shell trap to catch dying beam processes during test runs.
\fI\%#2921c78\fP
.IP \(bu 2
\fI\%COUCHDB\-1389\fP: Improved tracebacks printed by the JS CLI tests.
.IP \(bu 2
\fI\%COUCHDB\-1563\fP: Ensures urlPrefix is set in all ajax requests.
\fI\%#07a6af222\fP
.IP \(bu 2
Fix race condition for test running on faster hardware.
.IP \(bu 2
Improved the reliability of a number of tests.
.UNINDENT
.SS URL Rewriter & Vhosts
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-1026\fP: Database name is encoded during rewriting
(allowing embedded /’s, etc). \fI\%#272d6415\fP
.UNINDENT
.SS UUID Algorithms
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-1373\fP: Added the utc_id algorithm \fI\%#5ab712a2\fP
.UNINDENT
.SS Query and View Server
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-111\fP: Improve the errors reported by the JavaScript view server
to provide a more friendly error report when something goes wrong.
\fI\%#0c619ed\fP
.IP \(bu 2
\fI\%COUCHDB\-410\fP: More graceful error handling for JavaScript validate_doc_update
functions.
.IP \(bu 2
\fI\%COUCHDB\-1372\fP: \fI_stats\fP built\-in reduce function no longer produces error for
empty view result.
.IP \(bu 2
\fI\%COUCHDB\-1444\fP: Fix missed_named_view error that occurs on existed design
documents and views. \fI\%#b59ac98b\fP
.IP \(bu 2
\fI\%COUCHDB\-1445\fP: CouchDB tries no more to delete view file if it couldn’t open
it, even if the error is \fIemfile\fP\&.
.IP \(bu 2
\fI\%COUCHDB\-1483\fP: Update handlers requires valid doc ids. \fI\%#72ea7e38\fP
.IP \(bu 2
\fI\%COUCHDB\-1491\fP: Clean up view tables. \fI\%#c37204b7\fP
.IP \(bu 2
Deprecate E4X support, \fI\%#cdfdda2314\fP
.UNINDENT
.SS Windows
.INDENT 0.0
.IP \(bu 2
\fI\%COUCHDB\-1482\fP: Use correct linker flag to build \fIsnappy_nif.dll\fP on Windows.
\fI\%#a6eaf9f1\fP
.IP \(bu 2
Allows building cleanly on Windows without cURL, \fI\%#fb670f5712\fP
.UNINDENT
.SS 1.2.x Branch
.INDENT 0.0
.IP \(bu 2
\fI\%Upgrade Notes\fP
.IP \(bu 2
\fI\%Version 1.2.2\fP
.IP \(bu 2
\fI\%Version 1.2.1\fP
.IP \(bu 2
\fI\%Version 1.2.0\fP
.UNINDENT
.SS Upgrade Notes
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
This version drops support for the database format that was introduced in
version 0.9.0. Compact your older databases (that have not been compacted
for a long time) before upgrading, or they will become inaccessible.
.UNINDENT
.UNINDENT
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
\fI\%Version 1.2.1\fP contains important security fixes. Previous \fI1.2.x\fP
releases are not recommended for regular usage.
.UNINDENT
.UNINDENT
.SS Security changes
.sp
The interface to the \fB_users\fP and \fB_replicator\fP databases have been
changed so that non\-administrator users can see less information:
.INDENT 0.0
.IP \(bu 2
In the \fB_users\fP database:
.INDENT 2.0
.IP \(bu 2
User documents can now only be read by the respective users, as well as
administrators. Other users cannot read these documents.
.IP \(bu 2
Views can only be defined and queried by administrator users.
.IP \(bu 2
The \fB_changes\fP feed can only be queried by administrator users.
.UNINDENT
.IP \(bu 2
In the \fB_replicator\fP database:
.INDENT 2.0
.IP \(bu 2
Documents now have a forced \fBowner\fP field that corresponds to the
authenticated user that created them.
.IP \(bu 2
Non\-owner users will not see confidential information like passwords or
OAuth tokens in replication documents; they can still see the other
contents of those documents. Administrators can see everything.
.IP \(bu 2
Views can only be defined and queried by administrators.
.UNINDENT
.UNINDENT
.SS Database Compression
.sp
The new optional (but enabled by default) compression of disk files requires
an upgrade of the on\-disk format (5 \-> 6) which occurs on creation for new
databases and views, and on compaction for existing files. This format is not
supported in previous releases, so rollback would require replication to the
previous CouchDB release or restoring from backup.
.sp
Compression can be disabled by setting \fBcompression = none\fP in your
\fBlocal.ini\fP \fB[couchdb]\fP section, but the on\-disk format will still be
upgraded.
.SS Version 1.2.2
.SS Build System
.INDENT 0.0
.IP \(bu 2
Fixed issue in \fIcouchdb\fP script where stopped status returns before process
exits.
.UNINDENT
.SS HTTP Interface
.INDENT 0.0
.IP \(bu 2
Reset rewrite counter on new request, avoiding unnecessary request failures
due to bogus rewrite limit reports.
.UNINDENT
.SS Version 1.2.1
.SS Build System
.INDENT 0.0
.IP \(bu 2
Fix couchdb start script.
.IP \(bu 2
Win: fix linker invocations.
.UNINDENT
.SS Futon
.INDENT 0.0
.IP \(bu 2
Disable buttons that aren’t available for the logged\-in user.
.UNINDENT
.SS HTTP Interface
.INDENT 0.0
.IP \(bu 2
No longer rewrites the \fBX\-CouchDB\-Requested\-Path\fP during recursive
calls to the rewriter.
.IP \(bu 2
Limit recursion depth in the URL rewriter. Defaults to a maximum
of 100 invocations but is configurable.
.UNINDENT
.SS Security
.INDENT 0.0
.IP \(bu 2
Fixed \fI\%CVE\-2012\-5641: Information disclosure via unescaped backslashes in URLs on Windows\fP
.IP \(bu 2
Fixed \fI\%CVE\-2012\-5649: JSONP arbitrary code execution with Adobe Flash\fP
.IP \(bu 2
Fixed \fI\%CVE\-2012\-5650: DOM based Cross\-Site Scripting via Futon UI\fP
.UNINDENT
.SS Replication
.INDENT 0.0
.IP \(bu 2
Fix potential timeouts.
.UNINDENT
.SS View Server
.INDENT 0.0
.IP \(bu 2
Change use of signals to avoid broken view groups.
.UNINDENT
.SS Version 1.2.0
.SS Authentication
.INDENT 0.0
.IP \(bu 2
Fix use of OAuth with VHosts and URL rewriting.
.IP \(bu 2
OAuth secrets can now be stored in the users system database
as an alternative to key value pairs in the .ini configuration.
By default this is disabled (secrets are stored in the .ini)
but can be enabled via the .ini configuration key \fIuse_users_db\fP
in the \fIcouch_httpd_oauth\fP section.
.IP \(bu 2
Documents in the _users database are no longer publicly
readable.
.IP \(bu 2
Confidential information in the _replication database is no
longer publicly readable.
.IP \(bu 2
Password hashes are now calculated by CouchDB. Clients are no
longer required to do this manually.
.IP \(bu 2
Cookies used for authentication can be made persistent by enabling
the .ini configuration key \fIallow_persistent_cookies\fP in the
\fIcouch_httpd_auth\fP section.
.UNINDENT
.SS Build System
.INDENT 0.0
.IP \(bu 2
cURL is no longer required to build CouchDB as it is only
used by the command line JS test runner. If cURL is available
when building CouchJS you can enable the HTTP bindings by
passing \-H on the command line.
.IP \(bu 2
Temporarily made \fImake check\fP pass with R15B. A more thorough
fix is in the works (\fI\%COUCHDB\-1424\fP).
.IP \(bu 2
Fixed –with\-js\-include and –with\-js\-lib options.
.IP \(bu 2
Added –with\-js\-lib\-name option.
.UNINDENT
.SS Futon
.INDENT 0.0
.IP \(bu 2
The \fIStatus\fP screen (active tasks) now displays two new task status
fields: \fIStarted on\fP and \fIUpdated on\fP\&.
.IP \(bu 2
Futon remembers view code every time it is saved, allowing to save an
edit that amounts to a revert.
.UNINDENT
.SS HTTP Interface
.INDENT 0.0
.IP \(bu 2
Added a native JSON parser.
.IP \(bu 2
The _active_tasks API now offers more granular fields. Each
task type is now able to expose different properties.
.IP \(bu 2
Added built\-in changes feed filter \fI_view\fP\&.
.IP \(bu 2
Fixes to the \fI_changes\fP feed heartbeat option which caused
heartbeats to be missed when used with a filter. This caused
timeouts of continuous pull replications with a filter.
.IP \(bu 2
Properly restart the SSL socket on configuration changes.
.UNINDENT
.SS OAuth
.INDENT 0.0
.IP \(bu 2
Updated bundled \fIerlang_oauth\fP library to the latest version.
.UNINDENT
.SS Replicator
.INDENT 0.0
.IP \(bu 2
A new replicator implementation. It offers more performance and
configuration options.
.IP \(bu 2
Passing non\-string values to query_params is now a 400 bad
request. This is to reduce the surprise that all parameters
are converted to strings internally.
.IP \(bu 2
Added optional field \fIsince_seq\fP to replication objects/documents.
It allows to bootstrap a replication from a specific source sequence
number.
.IP \(bu 2
Simpler replication cancellation. In addition to the current method,
replications can now be canceled by specifying the replication ID
instead of the original replication object/document.
.UNINDENT
.SS Storage System
.INDENT 0.0
.IP \(bu 2
Added optional database and view index file compression (using Google’s
snappy or zlib’s deflate). This feature is enabled by default, but it
can be disabled by adapting local.ini accordingly. The on\-disk format
is upgraded on compaction and new DB/view creation to support this.
.IP \(bu 2
Several performance improvements, most notably regarding database writes
and view indexing.
.IP \(bu 2
Computation of the size of the latest MVCC snapshot data and all its
supporting metadata, both for database and view index files. This
information is exposed as the \fIdata_size\fP attribute in the database and
view group information URIs.
.IP \(bu 2
The size of the buffers used for database and view compaction is now
configurable.
.IP \(bu 2
Added support for automatic database and view compaction. This feature
is disabled by default, but it can be enabled via the .ini configuration.
.IP \(bu 2
Performance improvements for the built\-in changes feed filters \fI_doc_ids\fP
and \fI_design\fP\&.
.UNINDENT
.SS View Server
.INDENT 0.0
.IP \(bu 2
Add CoffeeScript (\fI\%http://coffeescript.org/\fP) as a first class view server
language.
.IP \(bu 2
Fixed old index file descriptor leaks after a view cleanup.
.IP \(bu 2
The requested_path property keeps the pre\-rewrite path even when no VHost
configuration is matched.
.IP \(bu 2
Fixed incorrect reduce query results when using pagination parameters.
.IP \(bu 2
Made icu_driver work with Erlang R15B and later.
.UNINDENT
.SS 1.1.x Branch
.INDENT 0.0
.IP \(bu 2
\fI\%Upgrade Notes\fP
.IP \(bu 2
\fI\%Version 1.1.2\fP
.IP \(bu 2
\fI\%Version 1.1.1\fP
.IP \(bu 2
\fI\%Version 1.1.0\fP
.UNINDENT
.SS Upgrade Notes
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
\fI\%Version 1.1.2\fP contains important security fixes. Previous \fI1.1.x\fP
releases are not recommended for regular usage.
.UNINDENT
.UNINDENT
.SS Version 1.1.2
.SS Build System
.INDENT 0.0
.IP \(bu 2
Don’t \fIln\fP the \fIcouchjs\fP install target on Windows
.IP \(bu 2
Remove ICU version dependency on Windows.
.IP \(bu 2
Improve SpiderMonkey version detection.
.UNINDENT
.SS HTTP Interface
.INDENT 0.0
.IP \(bu 2
ETag of attachment changes only when the attachment changes, not
the document.
.IP \(bu 2
Fix retrieval of headers larger than 4k.
.IP \(bu 2
Allow OPTIONS HTTP method for list requests.
.IP \(bu 2
Don’t attempt to encode invalid json.
.UNINDENT
.SS Log System
.INDENT 0.0
.IP \(bu 2
Improvements to log messages for file\-related errors.
.UNINDENT
.SS Replicator
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.IP \(bu 2
Fix pull replication of documents with many revisions.
.IP \(bu 2
Fix replication from an HTTP source to an HTTP target.
.UNINDENT
.UNINDENT
.UNINDENT
.SS Security
.INDENT 0.0
.IP \(bu 2
Fixed \fI\%CVE\-2012\-5641: Information disclosure via unescaped backslashes in URLs on Windows\fP
.IP \(bu 2
Fixed \fI\%CVE\-2012\-5649: JSONP arbitrary code execution with Adobe Flash\fP
.IP \(bu 2
Fixed \fI\%CVE\-2012\-5650: DOM based Cross\-Site Scripting via Futon UI\fP
.UNINDENT
.SS View Server
.INDENT 0.0
.IP \(bu 2
Avoid invalidating view indexes when running out of file descriptors.
.UNINDENT
.SS Version 1.1.1
.INDENT 0.0
.IP \(bu 2
Support SpiderMonkey 1.8.5
.IP \(bu 2
Add configurable maximum to the number of bytes returned by _log.
.IP \(bu 2
Allow CommonJS modules to be an empty string.
.IP \(bu 2
Bump minimum Erlang version to R13B02.
.IP \(bu 2
Do not run deleted validate_doc_update functions.
.IP \(bu 2
ETags for views include current sequence if include_docs=true.
.IP \(bu 2
Fix bug where duplicates can appear in _changes feed.
.IP \(bu 2
Fix bug where update handlers break after conflict resolution.
.IP \(bu 2
Fix bug with _replicator where include “filter” could crash couch.
.IP \(bu 2
Fix crashes when compacting large views.
.IP \(bu 2
Fix file descriptor leak in _log
.IP \(bu 2
Fix missing revisions in _changes?style=all_docs.
.IP \(bu 2
Improve handling of compaction at max_dbs_open limit.
.IP \(bu 2
JSONP responses now send “text/javascript” for Content\-Type.
.IP \(bu 2
Link to ICU 4.2 on Windows.
.IP \(bu 2
Permit forward slashes in path to update functions.
.IP \(bu 2
Reap couchjs processes that hit reduce_overflow error.
.IP \(bu 2
Status code can be specified in update handlers.
.IP \(bu 2
Support provides() in show functions.
.IP \(bu 2
_view_cleanup when ddoc has no views now removes all index files.
.IP \(bu 2
max_replication_retry_count now supports “infinity”.
.IP \(bu 2
Fix replication crash when source database has a document with empty ID.
.IP \(bu 2
Fix deadlock when assigning couchjs processes to serve requests.
.IP \(bu 2
Fixes to the document multipart PUT API.
.IP \(bu 2
Fixes regarding file descriptor leaks for databases with views.
.UNINDENT
.SS Version 1.1.0
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
All CHANGES for 1.0.2 and 1.0.3 also apply to 1.1.0.
.UNINDENT
.UNINDENT
.SS Externals
.INDENT 0.0
.IP \(bu 2
Added OS Process module to manage daemons outside of CouchDB.
.IP \(bu 2
Added HTTP Proxy handler for more scalable externals.
.UNINDENT
.SS Futon
.INDENT 0.0
.IP \(bu 2
Added a “change password”\-feature to Futon.
.UNINDENT
.SS HTTP Interface
.INDENT 0.0
.IP \(bu 2
Native SSL support.
.IP \(bu 2
Added support for HTTP range requests for attachments.
.IP \(bu 2
Added built\-in filters for \fI_changes\fP: \fI_doc_ids\fP and \fI_design\fP\&.
.IP \(bu 2
Added configuration option for TCP_NODELAY aka “Nagle”.
.IP \(bu 2
Allow POSTing arguments to \fI_changes\fP\&.
.IP \(bu 2
Allow \fIkeys\fP parameter for GET requests to views.
.IP \(bu 2
Allow wildcards in vhosts definitions.
.IP \(bu 2
More granular ETag support for views.
.IP \(bu 2
More flexible URL rewriter.
.IP \(bu 2
Added support for recognizing “Q values” and media parameters in
HTTP Accept headers.
.IP \(bu 2
Validate doc ids that come from a PUT to a URL.
.UNINDENT
.SS Replicator
.INDENT 0.0
.IP \(bu 2
Added \fI_replicator\fP database to manage replications.
.IP \(bu 2
Fixed issues when an endpoint is a remote database accessible via SSL.
.IP \(bu 2
Added support for continuous by\-doc\-IDs replication.
.IP \(bu 2
Fix issue where revision info was omitted when replicating attachments.
.IP \(bu 2
Integrity of attachment replication is now verified by MD5.
.UNINDENT
.SS Storage System
.INDENT 0.0
.IP \(bu 2
Multiple micro\-optimizations when reading data.
.UNINDENT
.SS URL Rewriter & Vhosts
.INDENT 0.0
.IP \(bu 2
Fix for variable substitution
.UNINDENT
.SS View Server
.INDENT 0.0
.IP \(bu 2
Added CommonJS support to map functions.
.IP \(bu 2
Added \fIstale=update_after\fP query option that triggers a view update after
returning a \fIstale=ok\fP response.
.IP \(bu 2
Warn about empty result caused by \fIstartkey\fP and \fIendkey\fP limiting.
.IP \(bu 2
Built\-in reduce function \fI_sum\fP now accepts lists of integers as input.
.IP \(bu 2
Added view query aliases start_key, end_key, start_key_doc_id and
end_key_doc_id.
.UNINDENT
.SS 1.0.x Branch
.INDENT 0.0
.IP \(bu 2
\fI\%Upgrade Notes\fP
.IP \(bu 2
\fI\%Version 1.0.4\fP
.IP \(bu 2
\fI\%Version 1.0.3\fP
.IP \(bu 2
\fI\%Version 1.0.2\fP
.IP \(bu 2
\fI\%Version 1.0.1\fP
.IP \(bu 2
\fI\%Version 1.0.0\fP
.UNINDENT
.SS Upgrade Notes
.sp
Note, to replicate with a 1.0 CouchDB instance you must first upgrade in\-place
your current CouchDB to 1.0 or 0.11.1 – backporting so that 0.10.x can
replicate to 1.0 wouldn’t be that hard. All that is required is patching the
replicator to use the \fBapplication/json\fP content type.
.INDENT 0.0
.IP \(bu 2
\fB_log\fP and \fB_temp_views\fP are now admin\-only resources.
.IP \(bu 2
\fB_bulk_docs\fP now requires a valid \fIContent\-Type\fP header of
\fBapplication/json\fP\&.
.IP \(bu 2
\fIJSONP\fP is disabled by default. An .ini option was added to selectively
enable it.
.IP \(bu 2
The \fBkey\fP, \fBstartkey\fP and \fBendkey\fP properties of the request object
passed to \fI\%list\fP and \fI\%show\fP functions now
contain JSON objects representing the URL encoded string values in the query
string. Previously, these properties contained strings which needed to be
converted to JSON before using.
.UNINDENT
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
\fI\%Version 1.0.4\fP contains important security fixes. Previous \fI1.0.x\fP
releases are not recommended for regular usage.
.UNINDENT
.UNINDENT
.SS Version 1.0.4
.SS HTTP Interface
.INDENT 0.0
.IP \(bu 2
Fix missing revisions in \fB_changes?style=all_docs\fP\&.
.IP \(bu 2
Fix validation of attachment names.
.UNINDENT
.SS Log System
.INDENT 0.0
.IP \(bu 2
Fix file descriptor leak in \fB_log\fP\&.
.UNINDENT
.SS Replicator
.INDENT 0.0
.IP \(bu 2
Fix a race condition where replications can go stale
.UNINDENT
.SS Security
.INDENT 0.0
.IP \(bu 2
Fixed \fI\%CVE\-2012\-5641: Information disclosure via unescaped backslashes in URLs on Windows\fP
.IP \(bu 2
Fixed \fI\%CVE\-2012\-5649: JSONP arbitrary code execution with Adobe Flash\fP
.IP \(bu 2
Fixed \fI\%CVE\-2012\-5650: DOM based Cross\-Site Scripting via Futon UI\fP
.UNINDENT
.SS View System
.INDENT 0.0
.IP \(bu 2
Avoid invalidating view indexes when running out of file descriptors.
.UNINDENT
.SS Version 1.0.3
.SS General
.INDENT 0.0
.IP \(bu 2
Fixed compatibility issues with Erlang R14B02.
.UNINDENT
.SS Etap Test Suite
.INDENT 0.0
.IP \(bu 2
Etap tests no longer require use of port 5984. They now use a randomly
selected port so they won’t clash with a running CouchDB.
.UNINDENT
.SS Futon
.INDENT 0.0
.IP \(bu 2
Made compatible with jQuery 1.5.x.
.UNINDENT
.SS HTTP Interface
.INDENT 0.0
.IP \(bu 2
Fix bug that allows invalid UTF\-8 after valid escapes.
.IP \(bu 2
The query parameter \fIinclude_docs\fP now honors the parameter \fIconflicts\fP\&.
This applies to queries against map views, _all_docs and _changes.
.IP \(bu 2
Added support for inclusive_end with reduce views.
.UNINDENT
.SS Replicator
.INDENT 0.0
.IP \(bu 2
Enabled replication over IPv6.
.IP \(bu 2
Fixed for crashes in continuous and filtered changes feeds.
.IP \(bu 2
Fixed error when restarting replications in OTP R14B02.
.IP \(bu 2
Upgrade ibrowse to version 2.2.0.
.IP \(bu 2
Fixed bug when using a filter and a limit of 1.
.UNINDENT
.SS Security
.INDENT 0.0
.IP \(bu 2
Fixed OAuth signature computation in OTP R14B02.
.IP \(bu 2
Handle passwords with : in them.
.UNINDENT
.SS Storage System
.INDENT 0.0
.IP \(bu 2
More performant queries against _changes and _all_docs when using the
\fIinclude_docs\fP parameter.
.UNINDENT
.SS Windows
.INDENT 0.0
.IP \(bu 2
Windows builds now require ICU >= 4.4.0 and Erlang >= R14B03. See
\fI\%COUCHDB\-1152\fP, and \fI\%COUCHDB\-963\fP + OTP\-9139 for more information.
.UNINDENT
.SS Version 1.0.2
.SS Futon
.INDENT 0.0
.IP \(bu 2
Make test suite work with Safari and Chrome.
.IP \(bu 2
Fixed animated progress spinner.
.IP \(bu 2
Fix raw view document link due to overzealous URI encoding.
.IP \(bu 2
Spell javascript correctly in loadScript(uri).
.UNINDENT
.SS HTTP Interface
.INDENT 0.0
.IP \(bu 2
Allow reduce=false parameter in map\-only views.
.IP \(bu 2
Fix parsing of Accept headers.
.IP \(bu 2
Fix for multipart GET APIs when an attachment was created during a
local\-local replication. See \fI\%COUCHDB\-1022\fP for details.
.UNINDENT
.SS Log System
.INDENT 0.0
.IP \(bu 2
Reduce lengthy stack traces.
.IP \(bu 2
Allow logging of native <xml> types.
.UNINDENT
.SS Replicator
.INDENT 0.0
.IP \(bu 2
Updated ibrowse library to 2.1.2 fixing numerous replication issues.
.IP \(bu 2
Make sure that the replicator respects HTTP settings defined in the config.
.IP \(bu 2
Fix error when the ibrowse connection closes unexpectedly.
.IP \(bu 2
Fix authenticated replication (with HTTP basic auth) of design documents
with attachments.
.IP \(bu 2
Various fixes to make replication more resilient for edge\-cases.
.UNINDENT
.SS Storage System
.INDENT 0.0
.IP \(bu 2
Fix leaking file handles after compacting databases and views.
.IP \(bu 2
Fix databases forgetting their validation function after compaction.
.IP \(bu 2
Fix occasional timeout errors after successfully compacting large databases.
.IP \(bu 2
Fix occasional error when writing to a database that has just been compacted.
.IP \(bu 2
Fix occasional timeout errors on systems with slow or heavily loaded IO.
.IP \(bu 2
Fix for OOME when compactions include documents with many conflicts.
.IP \(bu 2
Fix for missing attachment compression when MIME types included parameters.
.IP \(bu 2
Preserve purge metadata during compaction to avoid spurious view rebuilds.
.IP \(bu 2
Fix spurious conflicts introduced when uploading an attachment after
a doc has been in a conflict. See \fI\%COUCHDB\-902\fP for details.
.IP \(bu 2
Fix for frequently edited documents in multi\-master deployments being
duplicated in _changes and _all_docs.  See \fI\%COUCHDB\-968\fP for details on how
to repair.
.IP \(bu 2
Significantly higher read and write throughput against database and
view index files.
.UNINDENT
.SS View Server
.INDENT 0.0
.IP \(bu 2
Don’t trigger view updates when requesting \fI_design/doc/_info\fP\&.
.IP \(bu 2
Fix for circular references in CommonJS requires.
.IP \(bu 2
Made isArray() function available to functions executed in the query server.
.IP \(bu 2
Documents are now sealed before being passed to map functions.
.IP \(bu 2
Force view compaction failure when duplicated document data exists. When
this error is seen in the logs users should rebuild their views from
scratch to fix the issue. See \fI\%COUCHDB\-999\fP for details.
.UNINDENT
.SS Version 1.0.1
.SS Authentication
.INDENT 0.0
.IP \(bu 2
.INDENT 2.0
.TP
.B Enable basic\-auth popup when required to access the server, to prevent
people from getting locked out.
.UNINDENT
.UNINDENT
.SS Build and System Integration
.INDENT 0.0
.IP \(bu 2
Included additional source files for distribution.
.UNINDENT
.SS Futon
.INDENT 0.0
.IP \(bu 2
User interface element for querying stale (cached) views.
.UNINDENT
.SS HTTP Interface
.INDENT 0.0
.IP \(bu 2
Expose \fIcommitted_update_seq\fP for monitoring purposes.
.IP \(bu 2
Show fields saved along with _deleted=true. Allows for auditing of deletes.
.IP \(bu 2
More robust Accept\-header detection.
.UNINDENT
.SS Replicator
.INDENT 0.0
.IP \(bu 2
Added support for replication via an HTTP/HTTPS proxy.
.IP \(bu 2
Fix pull replication of attachments from 0.11 to 1.0.x.
.IP \(bu 2
Make the _changes feed work with non\-integer seqnums.
.UNINDENT
.SS Storage System
.INDENT 0.0
.IP \(bu 2
Fix data corruption bug \fI\%COUCHDB\-844\fP\&. Please see
\fI\%http://couchdb.apache.org/notice/1.0.1.html\fP for details.
.UNINDENT
.SS Version 1.0.0
.SS Security
.INDENT 0.0
.IP \(bu 2
Added authentication caching, to avoid repeated opening and closing of the
users database for each request requiring authentication.
.UNINDENT
.SS Storage System
.INDENT 0.0
.IP \(bu 2
Small optimization for reordering result lists.
.IP \(bu 2
More efficient header commits.
.IP \(bu 2
Use O_APPEND to save lseeks.
.IP \(bu 2
Faster implementation of pread_iolist(). Further improves performance on
concurrent reads.
.UNINDENT
.SS View Server
.INDENT 0.0
.IP \(bu 2
Faster default view collation.
.IP \(bu 2
Added option to include update_seq in view responses.
.UNINDENT
.SS 0.11.x Branch
.INDENT 0.0
.IP \(bu 2
\fI\%Upgrade Notes\fP
.IP \(bu 2
\fI\%Version 0.11.2\fP
.IP \(bu 2
\fI\%Version 0.11.1\fP
.IP \(bu 2
\fI\%Version 0.11.0\fP
.UNINDENT
.SS Upgrade Notes
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
\fI\%Version 0.11.2\fP contains important security fixes. Previous \fI0.11.x\fP
releases are not recommended for regular usage.
.UNINDENT
.UNINDENT
.SS Changes Between 0.11.0 and 0.11.1
.INDENT 0.0
.IP \(bu 2
\fB_log\fP and \fB_temp_views\fP are now admin\-only resources.
.IP \(bu 2
\fB_bulk_docs\fP now requires a valid \fIContent\-Type\fP header of
\fBapplication/json\fP\&.
.IP \(bu 2
\fIJSONP\fP is disabled by default. An .ini option was added to selectively
enable it.
.IP \(bu 2
The \fBkey\fP, \fBstartkey\fP and \fBendkey\fP properties of the request object
passed to \fI\%list\fP and \fI\%show\fP functions now
contain JSON objects representing the URL encoded string values in the query
string. Previously, these properties contained strings which needed to be
converted to JSON before using.
.UNINDENT
.SS Changes Between 0.10.x and 0.11.0
.SS show, list, update and validation functions
.sp
The \fBreq\fP argument to show, list, update and validation functions now contains
the member method with the specified HTTP method of the current request.
Previously, this member was called \fBverb\fP\&. \fBmethod\fP is following \fI\%RFC 2616\fP
(HTTP 1.1) closer.
.SS _admins \-> _security
.sp
The \fI/db/_admins\fP handler has been removed and replaced with a
\fI\%/db/_security\fP object. Any existing \fI_admins\fP will be
dropped and need to be added to the security object again. The reason for this
is that the old system made no distinction between names and roles, while the
new one does, so there is no way to automatically upgrade the old admins list.
.sp
The security object has 2 special fields, \fBadmins\fP and \fBreaders\fP, which
contain lists of names and roles which are admins or readers on that database.
Anything else may be stored in other fields on the security object. The entire
object is made available to validation functions.
.SS json2.js
.sp
JSON handling in the query server has been upgraded to use \fI\%json2.js\fP\&.
This allows us to use faster native JSON serialization when it is available.
.sp
In previous versions, attempts to serialize undefined would throw an exception,
causing the doc that emitted undefined to be dropped from the view index.
The new behavior is to serialize undefined as null. Applications depending on
the old behavior will need to explicitly check for undefined.
.sp
Another change is that E4X’s XML objects will not automatically be
stringified. XML users will need to call \fBmy_xml_object.toXMLString()\fP
to return a string value. \fI\%#8d3b7ab3\fP
.SS WWW\-Authenticate
.sp
The default configuration has been changed to avoid causing basic\-auth popups
which result from sending the WWW\-Authenticate header. To enable basic\-auth
popups, uncomment the config option \fBhttpd/WWW\-Authenticate\fP line in
\fIlocal.ini\fP\&.
.SS Query server line protocol
.sp
The query server line protocol has changed for all functions except
\fI\%map\fP, \fI\%reduce\fP, and
\fI\%rereduce\fP\&. This allows us to cache the entire design
document in the query server process, which results in faster performance for
common operations. It also gives more flexibility to query server
implementers and shouldn’t require major changes in the future when adding
new query server features.
.SS UTF8 JSON
.sp
JSON request bodies are validated for proper UTF\-8 before saving, instead of
waiting to fail on subsequent read requests.
.SS _changes line format
.sp
Continuous changes are now newline delimited, instead of having each line
followed by a comma.
.SS Version 0.11.2
.SS Authentication
.INDENT 0.0
.IP \(bu 2
User documents can now be deleted by admins or the user.
.UNINDENT
.SS Futon
.INDENT 0.0
.IP \(bu 2
Add some Futon files that were missing from the Makefile.
.UNINDENT
.SS HTTP Interface
.INDENT 0.0
.IP \(bu 2
Better error messages on invalid URL requests.
.UNINDENT
.SS Replicator
.INDENT 0.0
.IP \(bu 2
Fix bug when pushing design docs by non\-admins, which was hanging the
replicator for no good reason.
.IP \(bu 2
Fix bug when pulling design documents from a source that requires
basic\-auth.
.UNINDENT
.SS Security
.INDENT 0.0
.IP \(bu 2
Avoid potential DOS attack by guarding all creation of atoms.
.IP \(bu 2
Fixed \fI\%CVE\-2010\-2234: Apache CouchDB Cross Site Request Forgery Attack\fP
.UNINDENT
.SS Version 0.11.1
.SS Build and System Integration
.INDENT 0.0
.IP \(bu 2
Output of \fIcouchdb –help\fP has been improved.
.IP \(bu 2
Fixed compatibility with the Erlang R14 series.
.IP \(bu 2
Fixed warnings on Linux builds.
.IP \(bu 2
Fixed build error when aclocal needs to be called during the build.
.IP \(bu 2
Require ICU 4.3.1.
.IP \(bu 2
Fixed compatibility with Solaris.
.UNINDENT
.SS Configuration System
.INDENT 0.0
.IP \(bu 2
Fixed timeout with large .ini files.
.UNINDENT
.SS Futon
.INDENT 0.0
.IP \(bu 2
Use “expando links” for over\-long document values in Futon.
.IP \(bu 2
Added continuous replication option.
.IP \(bu 2
Added option to replicating test results anonymously to a community
CouchDB instance.
.IP \(bu 2
Allow creation and deletion of config entries.
.IP \(bu 2
Fixed display issues with doc ids that have escaped characters.
.IP \(bu 2
Fixed various UI issues.
.UNINDENT
.SS HTTP Interface
.INDENT 0.0
.IP \(bu 2
Mask passwords in active tasks and logging.
.IP \(bu 2
Update mochijson2 to allow output of BigNums not in float form.
.IP \(bu 2
Added support for X\-HTTP\-METHOD\-OVERRIDE.
.IP \(bu 2
Better error message for database names.
.IP \(bu 2
Disable jsonp by default.
.IP \(bu 2
Accept gzip encoded standalone attachments.
.IP \(bu 2
Made max_concurrent_connections configurable.
.IP \(bu 2
Made changes API more robust.
.IP \(bu 2
Send newly generated document rev to callers of an update function.
.UNINDENT
.SS JavaScript Clients
.INDENT 0.0
.IP \(bu 2
Added tests for couch.js and jquery.couch.js
.IP \(bu 2
Added changes handler to jquery.couch.js.
.IP \(bu 2
Added cache busting to jquery.couch.js if the user agent is msie.
.IP \(bu 2
Added support for multi\-document\-fetch (via _all_docs) to jquery.couch.js.
.IP \(bu 2
Added attachment versioning to jquery.couch.js.
.IP \(bu 2
Added option to control ensure_full_commit to jquery.couch.js.
.IP \(bu 2
Added list functionality to jquery.couch.js.
.IP \(bu 2
Fixed issues where bulkSave() wasn’t sending a POST body.
.UNINDENT
.SS Log System
.INDENT 0.0
.IP \(bu 2
Log HEAD requests as HEAD, not GET.
.IP \(bu 2
Keep massive JSON blobs out of the error log.
.IP \(bu 2
Fixed a timeout issue.
.UNINDENT
.SS Replication System
.INDENT 0.0
.IP \(bu 2
Refactored various internal APIs related to attachment streaming.
.IP \(bu 2
Fixed hanging replication.
.IP \(bu 2
Fixed keepalive issue.
.UNINDENT
.SS Security
.INDENT 0.0
.IP \(bu 2
Added authentication redirect URL to log in clients.
.IP \(bu 2
Fixed query parameter encoding issue in oauth.js.
.IP \(bu 2
Made authentication timeout configurable.
.IP \(bu 2
Temporary views are now admin\-only resources.
.UNINDENT
.SS Storage System
.INDENT 0.0
.IP \(bu 2
Don’t require a revpos for attachment stubs.
.IP \(bu 2
Added checking to ensure when a revpos is sent with an attachment stub,
it’s correct.
.IP \(bu 2
Make file deletions async to avoid pauses during compaction and db
deletion.
.IP \(bu 2
Fixed for wrong offset when writing headers and converting them to blocks,
only triggered when header is larger than 4k.
.IP \(bu 2
Preserve _revs_limit and instance_start_time after compaction.
.UNINDENT
.SS Test Suite
.INDENT 0.0
.IP \(bu 2
Made the test suite overall more reliable.
.UNINDENT
.SS View Server
.INDENT 0.0
.IP \(bu 2
Provide a UUID to update functions (and all other functions) that they can
use to create new docs.
.IP \(bu 2
Upgrade CommonJS modules support to 1.1.1.
.IP \(bu 2
Fixed erlang filter funs and normalize filter fun API.
.IP \(bu 2
Fixed hang in view shutdown.
.UNINDENT
.SS URL Rewriter & Vhosts
.INDENT 0.0
.IP \(bu 2
Allow more complex keys in rewriter.
.IP \(bu 2
Allow global rewrites so system defaults are available in vhosts.
.IP \(bu 2
Allow isolation of databases with vhosts.
.IP \(bu 2
Fix issue with passing variables to query parameters.
.UNINDENT
.SS Version 0.11.0
.SS Build and System Integration
.INDENT 0.0
.IP \(bu 2
Updated and improved source documentation.
.IP \(bu 2
Fixed distribution preparation for building on Mac OS X.
.IP \(bu 2
Added support for building a Windows installer as part of ‘make dist’.
.IP \(bu 2
Bug fix for building couch.app’s module list.
.IP \(bu 2
ETap tests are now run during make distcheck. This included a number of
updates to the build system to properly support VPATH builds.
.IP \(bu 2
Gavin McDonald set up a build\-bot instance. More info can be found at
\fI\%http://ci.apache.org/buildbot.html\fP
.UNINDENT
.SS Futon
.INDENT 0.0
.IP \(bu 2
Added a button for view compaction.
.IP \(bu 2
JSON strings are now displayed as\-is in the document view, without the
escaping of new\-lines and quotes. That dramatically improves readability of
multi\-line strings.
.IP \(bu 2
Same goes for editing of JSON string values. When a change to a field value is
submitted, and the value is not valid JSON it is assumed to be a string. This
improves editing of multi\-line strings a lot.
.IP \(bu 2
Hitting tab in textareas no longer moves focus to the next form field, but
simply inserts a tab character at the current caret position.
.IP \(bu 2
Fixed some font declarations.
.UNINDENT
.SS HTTP Interface
.INDENT 0.0
.IP \(bu 2
Provide Content\-MD5 header support for attachments.
.IP \(bu 2
Added URL Rewriter handler.
.IP \(bu 2
Added virtual host handling.
.UNINDENT
.SS Replication
.INDENT 0.0
.IP \(bu 2
Added option to implicitly create replication target databases.
.IP \(bu 2
Avoid leaking file descriptors on automatic replication restarts.
.IP \(bu 2
Added option to replicate a list of documents by id.
.IP \(bu 2
Allow continuous replication to be cancelled.
.UNINDENT
.SS Runtime Statistics
.INDENT 0.0
.IP \(bu 2
Statistics are now calculated for a moving window instead of non\-overlapping
timeframes.
.IP \(bu 2
Fixed a problem with statistics timers and system sleep.
.IP \(bu 2
Moved statistic names to a term file in the priv directory.
.UNINDENT
.SS Security
.INDENT 0.0
.IP \(bu 2
Fixed CVE\-2010\-0009: Apache CouchDB Timing Attack Vulnerability.
.IP \(bu 2
Added default cookie\-authentication and users database.
.IP \(bu 2
Added Futon user interface for user signup and login.
.IP \(bu 2
Added per\-database reader access control lists.
.IP \(bu 2
Added per\-database security object for configuration data in validation
functions.
.IP \(bu 2
Added proxy authentication handler
.UNINDENT
.SS Storage System
.INDENT 0.0
.IP \(bu 2
Adds batching of multiple updating requests, to improve throughput with many
writers. Removed the now redundant couch_batch_save module.
.IP \(bu 2
Adds configurable compression of attachments.
.UNINDENT
.SS View Server
.INDENT 0.0
.IP \(bu 2
Added optional ‘raw’ binary collation for faster view builds where Unicode
collation is not important.
.IP \(bu 2
Improved view index build time by reducing ICU collation callouts.
.IP \(bu 2
Improved view information objects.
.IP \(bu 2
Bug fix for partial updates during view builds.
.IP \(bu 2
Move query server to a design\-doc based protocol.
.IP \(bu 2
Use json2.js for JSON serialization for compatibility with native JSON.
.IP \(bu 2
Major refactoring of couchjs to lay the groundwork for disabling cURL
support. The new HTTP interaction acts like a synchronous XHR. Example usage
of the new system is in the JavaScript CLI test runner.
.UNINDENT
.SS 0.10.x Branch
.INDENT 0.0
.IP \(bu 2
\fI\%Upgrade Notes\fP
.IP \(bu 2
\fI\%Version 0.10.2\fP
.IP \(bu 2
\fI\%Version 0.10.1\fP
.IP \(bu 2
\fI\%Version 0.10.0\fP
.UNINDENT
.SS Upgrade Notes
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
\fI\%Version 0.10.2\fP contains important security fixes. Previous \fI0.10.x\fP
releases are not recommended for regular usage.
.UNINDENT
.UNINDENT
.SS Modular Configuration Directories
.sp
CouchDB now loads configuration from the following places (\fI\%glob(7)\fP syntax)
in order:
.INDENT 0.0
.IP \(bu 2
PREFIX/default.ini
.IP \(bu 2
PREFIX/default.d/*
.IP \(bu 2
PREFIX/local.ini
.IP \(bu 2
PREFIX/local.d/*
.UNINDENT
.sp
The configuration options for \fIcouchdb\fP script have changed to:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\-a FILE     add configuration FILE to chain
\-A DIR      add configuration DIR to chain
\-n          reset configuration file chain (including system default)
\-c          print configuration file chain and exit
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Show and List API change
.sp
Show and List functions must have a new structure in 0.10.
See \fI\%Formatting_with_Show_and_List\fP for details.
.SS Stricter enforcing of reduciness in reduce\-functions
.sp
Reduce functions are now required to reduce the number of values for a key.
.SS View query reduce parameter strictness
.sp
CouchDB now considers the parameter \fBreduce=false\fP to be an error for queries
of map\-only views, and responds with status code 400.
.SS Version 0.10.2
.SS Build and System Integration
.INDENT 0.0
.IP \(bu 2
Fixed distribution preparation for building on Mac OS X.
.UNINDENT
.SS Security
.INDENT 0.0
.IP \(bu 2
Fixed \fI\%CVE\-2010\-0009: Apache CouchDB Timing Attack Vulnerability\fP
.UNINDENT
.SS Replicator
.INDENT 0.0
.IP \(bu 2
Avoid leaking file descriptors on automatic replication restarts.
.UNINDENT
.SS Version 0.10.1
.SS Build and System Integration
.INDENT 0.0
.IP \(bu 2
Test suite now works with the distcheck target.
.UNINDENT
.SS Replicator
.INDENT 0.0
.IP \(bu 2
Stability enhancements regarding redirects, timeouts, OAuth.
.UNINDENT
.SS Query Server
.INDENT 0.0
.IP \(bu 2
Avoid process leaks
.IP \(bu 2
Allow list and view to span languages
.UNINDENT
.SS Stats
.INDENT 0.0
.IP \(bu 2
Eliminate new process flood on system wake
.UNINDENT
.SS Version 0.10.0
.SS Build and System Integration
.INDENT 0.0
.IP \(bu 2
Changed \fIcouchdb\fP script configuration options.
.IP \(bu 2
Added default.d and local.d configuration directories to load sequence.
.UNINDENT
.SS HTTP Interface
.INDENT 0.0
.IP \(bu 2
Added optional cookie\-based authentication handler.
.IP \(bu 2
Added optional two\-legged OAuth authentication handler.
.UNINDENT
.SS Storage Format
.INDENT 0.0
.IP \(bu 2
Add move headers with checksums to the end of database files for extra robust
storage and faster storage.
.UNINDENT
.SS View Server
.INDENT 0.0
.IP \(bu 2
Added native Erlang views for high\-performance applications.
.UNINDENT
.SS 0.9.x Branch
.INDENT 0.0
.IP \(bu 2
\fI\%Upgrade Notes\fP
.IP \(bu 2
\fI\%Version 0.9.2\fP
.IP \(bu 2
\fI\%Version 0.9.1\fP
.IP \(bu 2
\fI\%Version 0.9.0\fP
.UNINDENT
.SS Upgrade Notes
.SS Response to Bulk Creation/Updates
.sp
The response to a bulk creation / update now looks like this
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[
    {\(dqid\(dq: \(dq0\(dq, \(dqrev\(dq: \(dq3682408536\(dq},
    {\(dqid\(dq: \(dq1\(dq, \(dqrev\(dq: \(dq3206753266\(dq},
    {\(dqid\(dq: \(dq2\(dq, \(dqerror\(dq: \(dqconflict\(dq, \(dqreason\(dq: \(dqDocument update conflict.\(dq}
]
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Database File Format
.sp
The database file format has changed. CouchDB itself does yet not provide any
tools for migrating your data. In the meantime, you can use third\-party scripts
to deal with the migration, such as the dump/load tools that come with the
development version (trunk) of \fI\%couchdb\-python\fP\&.
.SS Renamed “count” to “limit”
.sp
The view query API has been changed: \fBcount\fP has become \fBlimit\fP\&.
This is a better description of what the parameter does, and should be a simple
update in any client code.
.SS Moved View URLs
.sp
The view URLs have been moved to design document resources. This means that
paths that used to be like:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
http://hostname:5984/mydb/_view/designname/viewname?limit=10
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
will now look like:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
http://hostname:5984/mydb/_design/designname/_view/viewname?limit=10.
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
See the \fI\%REST, Hypermedia, and CouchApps\fP  thread on dev for details.
.SS Attachments
.sp
Names of attachments are no longer allowed to start with an underscore.
.SS Error Codes
.sp
Some refinements have been made to error handling. CouchDB will send 400 instead
of 500 on invalid query parameters. Most notably, document update conflicts now
respond with \fI409 Conflict\fP instead of \fI412 Precondition Failed\fP\&. The error code
for when attempting to create a database that already exists is now 412
instead of 409.
.SS ini file format
.sp
CouchDB 0.9 changes sections and configuration variable names in configuration
files. Old .ini files won’t work. Also note that CouchDB now ships with two .ini
files where 0.8 used couch.ini there are now \fIdefault.ini\fP and \fIlocal.ini\fP\&.
\fIdefault.ini\fP contains CouchDB’s standard configuration values. local.ini is
meant for local changes. \fIlocal.ini\fP is not overwritten on CouchDB updates, so
your edits are safe. In addition, the new runtime configuration system persists
changes to the configuration in \fIlocal.ini\fP\&.
.SS Version 0.9.2
.SS Build and System Integration
.INDENT 0.0
.IP \(bu 2
Remove branch callbacks to allow building couchjs against newer versions of
Spidermonkey.
.UNINDENT
.SS Replication
.INDENT 0.0
.IP \(bu 2
Fix replication with 0.10 servers initiated by an 0.9 server (\fI\%COUCHDB\-559\fP).
.UNINDENT
.SS Version 0.9.1
.SS Build and System Integration
.INDENT 0.0
.IP \(bu 2
PID file directory is now created by the SysV/BSD daemon scripts.
.IP \(bu 2
Fixed the environment variables shown by the configure script.
.IP \(bu 2
Fixed the build instructions shown by the configure script.
.IP \(bu 2
Updated ownership and permission advice in \fIREADME\fP for better security.
.UNINDENT
.SS Configuration and stats system
.INDENT 0.0
.IP \(bu 2
Corrected missing configuration file error message.
.IP \(bu 2
Fixed incorrect recording of request time.
.UNINDENT
.SS Database Core
.INDENT 0.0
.IP \(bu 2
Document validation for underscore prefixed variables.
.IP \(bu 2
Made attachment storage less sparse.
.IP \(bu 2
Fixed problems when a database with delayed commits pending is considered
idle, and subject to losing changes when shutdown. (\fI\%COUCHDB\-334\fP)
.UNINDENT
.SS External Handlers
.INDENT 0.0
.IP \(bu 2
Fix POST requests.
.UNINDENT
.SS Futon
.INDENT 0.0
.IP \(bu 2
Redirect when loading a deleted view URI from the cookie.
.UNINDENT
.SS HTTP Interface
.INDENT 0.0
.IP \(bu 2
Attachment requests respect the “rev” query\-string parameter.
.UNINDENT
.SS JavaScript View Server
.INDENT 0.0
.IP \(bu 2
Useful JavaScript Error messages.
.UNINDENT
.SS Replication
.INDENT 0.0
.IP \(bu 2
Added support for Unicode characters transmitted as UTF\-16 surrogate pairs.
.IP \(bu 2
URL\-encode attachment names when necessary.
.IP \(bu 2
Pull specific revisions of an attachment, instead of just the latest one.
.IP \(bu 2
Work around a rare chunk\-merging problem in ibrowse.
.IP \(bu 2
Work with documents containing Unicode characters outside the Basic
Multilingual Plane.
.UNINDENT
.SS Version 0.9.0
.SS Build and System Integration
.INDENT 0.0
.IP \(bu 2
The \fIcouchdb\fP script now supports system chainable configuration files.
.IP \(bu 2
The Mac OS X daemon script now redirects STDOUT and STDERR like SysV/BSD.
.IP \(bu 2
The build and system integration have been improved for portability.
.IP \(bu 2
Added COUCHDB_OPTIONS to etc/default/couchdb file.
.IP \(bu 2
Remove COUCHDB_INI_FILE and COUCHDB_PID_FILE from etc/default/couchdb file.
.IP \(bu 2
Updated \fIconfigure.ac\fP to manually link \fIlibm\fP for portability.
.IP \(bu 2
Updated \fIconfigure.ac\fP to extended default library paths.
.IP \(bu 2
Removed inets configuration files.
.IP \(bu 2
Added command line test runner.
.IP \(bu 2
Created dev target for make.
.UNINDENT
.SS Configuration and stats system
.INDENT 0.0
.IP \(bu 2
Separate default and local configuration files.
.IP \(bu 2
HTTP interface for configuration changes.
.IP \(bu 2
Statistics framework with HTTP query API.
.UNINDENT
.SS Database Core
.INDENT 0.0
.IP \(bu 2
Faster B\-tree implementation.
.IP \(bu 2
Changed internal JSON term format.
.IP \(bu 2
Improvements to Erlang VM interactions under heavy load.
.IP \(bu 2
User context and administrator role.
.IP \(bu 2
Update validations with design document validation functions.
.IP \(bu 2
Document purge functionality.
.IP \(bu 2
Ref\-counting for database file handles.
.UNINDENT
.SS Design Document Resource Paths
.INDENT 0.0
.IP \(bu 2
Added httpd_design_handlers config section.
.IP \(bu 2
Moved _view to httpd_design_handlers.
.IP \(bu 2
Added ability to render documents as non\-JSON content\-types with _show and
_list functions, which are also httpd_design_handlers.
.UNINDENT
.SS Futon Utility Client
.INDENT 0.0
.IP \(bu 2
Added pagination to the database listing page.
.IP \(bu 2
Implemented attachment uploading from the document page.
.IP \(bu 2
Added page that shows the current configuration, and allows modification of
option values.
.IP \(bu 2
Added a JSON “source view” for document display.
.IP \(bu 2
JSON data in view rows is now syntax highlighted.
.IP \(bu 2
Removed the use of an iframe for better integration with browser history and
bookmarking.
.IP \(bu 2
Full database listing in the sidebar has been replaced by a short list of
recent databases.
.IP \(bu 2
The view editor now allows selection of the view language if there is more
than one configured.
.IP \(bu 2
Added links to go to the raw view or document URI.
.IP \(bu 2
Added status page to display currently running tasks in CouchDB.
.IP \(bu 2
JavaScript test suite split into multiple files.
.IP \(bu 2
Pagination for reduce views.
.UNINDENT
.SS HTTP Interface
.INDENT 0.0
.IP \(bu 2
Added client side UUIDs for idempotent document creation
.IP \(bu 2
HTTP COPY for documents
.IP \(bu 2
Streaming of chunked attachment PUTs to disk
.IP \(bu 2
Remove negative count feature
.IP \(bu 2
Add include_docs option for view queries
.IP \(bu 2
Add multi\-key view post for views
.IP \(bu 2
Query parameter validation
.IP \(bu 2
Use stale=ok to request potentially cached view index
.IP \(bu 2
External query handler module for full\-text or other indexers.
.IP \(bu 2
Etags for attachments, views, shows and lists
.IP \(bu 2
Show and list functions for rendering documents and views as developer
controlled content\-types.
.IP \(bu 2
Attachment names may use slashes to allow uploading of nested directories
(useful for static web hosting).
.IP \(bu 2
Option for a view to run over design documents.
.IP \(bu 2
Added newline to JSON responses. Closes bike\-shed.
.UNINDENT
.SS Replication
.INDENT 0.0
.IP \(bu 2
Using ibrowse.
.IP \(bu 2
Checkpoint replications so failures are less expensive.
.IP \(bu 2
Automatically retry of failed replications.
.IP \(bu 2
Stream attachments in pull\-replication.
.UNINDENT
.SS 0.8.x Branch
.INDENT 0.0
.IP \(bu 2
\fI\%Version 0.8.1\-incubating\fP
.IP \(bu 2
\fI\%Version 0.8.0\-incubating\fP
.UNINDENT
.SS Version 0.8.1\-incubating
.SS Build and System Integration
.INDENT 0.0
.IP \(bu 2
The \fIcouchdb\fP script no longer uses \fIawk\fP for configuration checks as this
was causing portability problems.
.IP \(bu 2
Updated \fIsudo\fP example in \fIREADME\fP to use the \fI\-i\fP option, this fixes
problems when invoking from a directory the \fIcouchdb\fP user cannot access.
.UNINDENT
.SS Database Core
.INDENT 0.0
.IP \(bu 2
Fix for replication problems where the write queues can get backed up if the
writes aren’t happening fast enough to keep up with the reads. For a large
replication, this can exhaust memory and crash, or slow down the machine
dramatically. The fix keeps only one document in the write queue at a time.
.IP \(bu 2
Fix for databases sometimes incorrectly reporting that they contain 0
documents after compaction.
.IP \(bu 2
CouchDB now uses ibrowse instead of inets for its internal HTTP client
implementation. This means better replication stability.
.UNINDENT
.SS Futon
.INDENT 0.0
.IP \(bu 2
The view selector dropdown should now work in Opera and Internet Explorer
even when it includes optgroups for design documents. (\fI\%COUCHDB\-81\fP)
.UNINDENT
.SS JavaScript View Server
.INDENT 0.0
.IP \(bu 2
Sealing of documents has been disabled due to an incompatibility with
SpiderMonkey 1.9.
.IP \(bu 2
Improve error handling for undefined values emitted by map functions.
(\fI\%COUCHDB\-83\fP)
.UNINDENT
.SS HTTP Interface
.INDENT 0.0
.IP \(bu 2
Fix for chunked responses where chunks were always being split into multiple
TCP packets, which caused problems with the test suite under Safari, and in
some other cases.
.IP \(bu 2
Fix for an invalid JSON response body being returned for some kinds of
views. (\fI\%COUCHDB\-84\fP)
.IP \(bu 2
Fix for connections not getting closed after rejecting a chunked request.
(\fI\%COUCHDB\-55\fP)
.IP \(bu 2
CouchDB can now be bound to IPv6 addresses.
.IP \(bu 2
The HTTP \fIServer\fP header now contains the versions of CouchDB and Erlang.
.UNINDENT
.SS Version 0.8.0\-incubating
.SS Build and System Integration
.INDENT 0.0
.IP \(bu 2
CouchDB can automatically respawn following a server crash.
.IP \(bu 2
Database server no longer refuses to start with a stale PID file.
.IP \(bu 2
System logrotate configuration provided.
.IP \(bu 2
Improved handling of ICU shared libraries.
.IP \(bu 2
The \fIcouchdb\fP script now automatically enables SMP support in Erlang.
.IP \(bu 2
The \fIcouchdb\fP and \fIcouchjs\fP scripts have been improved for portability.
.IP \(bu 2
The build and system integration have been improved for portability.
.UNINDENT
.SS Database Core
.INDENT 0.0
.IP \(bu 2
The view engine has been completely decoupled from the storage engine. Index
data is now stored in separate files, and the format of the main database
file has changed.
.IP \(bu 2
Databases can now be compacted to reclaim space used for deleted documents
and old document revisions.
.IP \(bu 2
Support for incremental map/reduce views has been added.
.IP \(bu 2
To support map/reduce, the structure of design documents has changed. View
values are now JSON objects containing at least a \fImap\fP member, and
optionally a \fIreduce\fP member.
.IP \(bu 2
View servers are now identified by name (for example \fIjavascript\fP) instead of
by media type.
.IP \(bu 2
Automatically generated document IDs are now based on proper UUID generation
using the crypto module.
.IP \(bu 2
The field \fIcontent\-type\fP in the JSON representation of attachments has been
renamed to \fIcontent_type\fP (underscore).
.UNINDENT
.SS Futon
.INDENT 0.0
.IP \(bu 2
When adding a field to a document, Futon now just adds a field with an
autogenerated name instead of prompting for the name with a dialog. The name
is automatically put into edit mode so that it can be changed immediately.
.IP \(bu 2
Fields are now sorted alphabetically by name when a document is displayed.
.IP \(bu 2
Futon can be used to create and update permanent views.
.IP \(bu 2
The maximum number of rows to display per page on the database page can now
be adjusted.
.IP \(bu 2
Futon now uses the XMLHTTPRequest API asynchronously to communicate with the
CouchDB HTTP server, so that most operations no longer block the browser.
.IP \(bu 2
View results sorting can now be switched between ascending and descending by
clicking on the \fIKey\fP column header.
.IP \(bu 2
Fixed a bug where documents that contained a \fI@\fP character could not be
viewed. (\fI\%COUCHDB\-12\fP)
.IP \(bu 2
The database page now provides a \fICompact\fP button to trigger database
compaction. (\fI\%COUCHDB\-38\fP)
.IP \(bu 2
Fixed portential double encoding of document IDs and other URI segments in
many instances. (\fI\%COUCHDB\-39\fP)
.IP \(bu 2
Improved display of attachments.
.IP \(bu 2
The JavaScript Shell has been removed due to unresolved licensing issues.
.UNINDENT
.SS JavaScript View Server
.INDENT 0.0
.IP \(bu 2
SpiderMonkey is no longer included with CouchDB, but rather treated as a
normal external dependency. A simple C program (\fI_couchjs\fP) is provided that
links against an existing SpiderMonkey installation and uses the interpreter
embedding API.
.IP \(bu 2
View functions using the default JavaScript view server can now do logging
using the global \fIlog(message)\fP function. Log messages are directed into the
CouchDB log at \fIINFO\fP level. (\fI\%COUCHDB\-59\fP)
.IP \(bu 2
The global \fImap(key, value)\fP function made available to view code has been
renamed to \fIemit(key, value)\fP\&.
.IP \(bu 2
Fixed handling of exceptions raised by view functions.
.UNINDENT
.SS HTTP Interface
.INDENT 0.0
.IP \(bu 2
CouchDB now uses MochiWeb instead of inets for the HTTP server
implementation. Among other things, this means that the extra configuration
files needed for inets (such as \fIcouch_httpd.conf\fP) are no longer used.
.IP \(bu 2
The HTTP interface now completely supports the \fIHEAD\fP method. (\fI\%COUCHDB\-3\fP)
.IP \(bu 2
Improved compliance of \fIEtag\fP handling with the HTTP specification.
(\fI\%COUCHDB\-13\fP)
.IP \(bu 2
Etags are no longer included in responses to document \fIGET\fP requests that
include query string parameters causing the JSON response to change without
the revision or the URI having changed.
.IP \(bu 2
The bulk document update API has changed slightly on both the request and the
response side. In addition, bulk updates are now atomic.
.IP \(bu 2
CouchDB now uses \fITCP_NODELAY\fP to fix performance problems with persistent
connections on some platforms due to nagling.
.IP \(bu 2
Including a \fI?descending=false\fP query string parameter in requests to views
no longer raises an error.
.IP \(bu 2
Requests to unknown top\-level reserved URLs (anything with a leading
underscore) now return a \fIunknown_private_path\fP error instead of the
confusing \fIillegal_database_name\fP\&.
.IP \(bu 2
The Temporary view handling now expects a JSON request body, where the JSON
is an object with at least a \fImap\fP member, and optional \fIreduce\fP and
\fIlanguage\fP members.
.IP \(bu 2
Temporary views no longer determine the view server based on the Content\-Type
header of the \fIPOST\fP request, but rather by looking for a \fIlanguage\fP member
in the JSON body of the request.
.IP \(bu 2
The status code of responses to \fIDELETE\fP requests is now 200 to reflect that
that the deletion is performed synchronously.
.UNINDENT
.SH SECURITY ISSUES / CVES
.SS CVE\-2010\-0009: Apache CouchDB Timing Attack Vulnerability
.INDENT 0.0
.TP
.B Date
31.03.2010
.TP
.B Affected
Apache CouchDB 0.8.0 to 0.10.1
.TP
.B Severity
Important
.TP
.B Vendor
The Apache Software Foundation
.UNINDENT
.SS Description
.sp
Apache CouchDB versions prior to version \fI\%0.11.0\fP are
vulnerable to timing attacks, also known as side\-channel information leakage,
due to using simple break\-on\-inequality string comparisons when verifying hashes
and passwords.
.SS Mitigation
.sp
All users should upgrade to CouchDB \fI\%0.11.0\fP\&.
Upgrades from the \fI\%0.10.x\fP series should be seamless.
Users on earlier versions should consult with
\fI\%upgrade notes\fP\&.
.SS Example
.sp
A canonical description of the attack can be found in
\fI\%http://codahale.com/a\-lesson\-in\-timing\-attacks/\fP
.SS Credit
.sp
This issue was discovered by \fIJason Davies\fP of the Apache CouchDB development
team.
.SS CVE\-2010\-2234: Apache CouchDB Cross Site Request Forgery Attack
.INDENT 0.0
.TP
.B Date
21.02.2010
.TP
.B Affected
Apache CouchDB 0.8.0 to 0.11.1
.TP
.B Severity
Important
.TP
.B Vendor
The Apache Software Foundation
.UNINDENT
.SS Description
.sp
Apache CouchDB versions prior to version \fI\%0.11.1\fP are
vulnerable to \fI\%Cross Site Request Forgery\fP (CSRF) attacks.
.SS Mitigation
.sp
All users should upgrade to CouchDB \fI\%0.11.2\fP
or \fI\%1.0.1\fP\&.
.sp
Upgrades from the \fI\%0.11.x\fP and
\fI\%0.10.x\fP series should be seamless.
.sp
Users on earlier versions should consult with upgrade notes.
.SS Example
.sp
A malicious website can \fIPOST\fP arbitrary JavaScript code to well
known CouchDB installation URLs (like \fI\%http://localhost:5984/\fP)
and make the browser execute the injected JavaScript in the
security context of CouchDB’s admin interface Futon.
.sp
Unrelated, but in addition the JSONP API has been turned off
by default to avoid potential information leakage.
.SS Credit
.sp
This CSRF issue was discovered by a source that wishes to stay
anonymous.
.SS CVE\-2010\-3854: Apache CouchDB Cross Site Scripting Issue
.INDENT 0.0
.TP
.B Date
28.01.2011
.TP
.B Affected
Apache CouchDB 0.8.0 to 1.0.1
.TP
.B Severity
Important
.TP
.B Vendor
The Apache Software Foundation
.UNINDENT
.SS Description
.sp
Apache CouchDB versions prior to version \fI\%1.0.2\fP are
vulnerable to \fI\%Cross Site Scripting\fP (XSS) attacks.
.SS Mitigation
.sp
All users should upgrade to CouchDB \fI\%1.0.2\fP\&.
.sp
Upgrades from the \fI\%0.11.x\fP and
\fI\%0.10.x\fP series should be seamless.
.sp
Users on earlier versions should consult with upgrade notes.
.SS Example
.sp
Due to inadequate validation of request parameters and cookie data in Futon,
CouchDB’s web\-based administration UI, a malicious site can execute arbitrary
code in the context of a user’s browsing session.
.SS Credit
.sp
This XSS issue was discovered by a source that wishes to stay anonymous.
.SS CVE\-2012\-5641: Information disclosure via unescaped backslashes in URLs on Windows
.INDENT 0.0
.TP
.B Date
14.01.2013
.TP
.B Affected
All Windows\-based releases of Apache CouchDB, up to and including
1.0.3, 1.1.1, and 1.2.0 are vulnerable.
.TP
.B Severity
Moderate
.TP
.B Vendor
The Apache Software Foundation
.UNINDENT
.SS Description
.sp
A specially crafted request could be used to access content directly that
would otherwise be protected by inbuilt CouchDB security mechanisms. This
request could retrieve in binary form any CouchDB database, including the
\fI_users\fP or \fI_replication\fP databases, or any other file that the user account
used to run CouchDB might have read access to on the local filesystem. This
exploit is due to a vulnerability in the included MochiWeb HTTP library.
.SS Mitigation
.sp
Upgrade to a supported CouchDB release that includes this fix, such as:
.INDENT 0.0
.IP \(bu 2
\fI\%1.0.4\fP
.IP \(bu 2
\fI\%1.1.2\fP
.IP \(bu 2
\fI\%1.2.1\fP
.IP \(bu 2
\fI\%1.3.x\fP
.UNINDENT
.sp
All listed releases have included a specific fix for the MochiWeb component.
.SS Work\-Around
.sp
Users may simply exclude any file\-based web serving components directly
within their configuration file, typically in \fIlocal.ini\fP\&. On a default
CouchDB installation, this requires amending the
\fIhttpd_global_handlers/favicon.ico\fP and \fIhttpd_global_handlers/_utils\fP
lines within \fIhttpd_global_handlers\fP:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[httpd_global_handlers]
favicon.ico = {couch_httpd_misc_handlers, handle_welcome_req, <<\(dqForbidden\(dq>>}
_utils = {couch_httpd_misc_handlers, handle_welcome_req, <<\(dqForbidden\(dq>>}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If additional handlers have been added, such as to support Adobe’s Flash
\fIcrossdomain.xml\fP files, these would also need to be excluded.
.SS Acknowledgement
.sp
The issue was found and reported by Sriram Melkote to the upstream MochiWeb
project.
.SS References
.INDENT 0.0
.IP \(bu 2
\fI\%https://github.com/melkote/mochiweb/commit/ac2bf\fP
.UNINDENT
.SS CVE\-2012\-5649: JSONP arbitrary code execution with Adobe Flash
.INDENT 0.0
.TP
.B Date
14.01.2013
.TP
.B Affected
Releases up to and including 1.0.3, 1.1.1, and 1.2.0 are vulnerable,
if administrators have enabled JSONP.
.TP
.B Severity
Moderate
.TP
.B Vendor
The Apache Software Foundation
.UNINDENT
.SS Description
.sp
A hand\-crafted JSONP callback and response can be used to run arbitrary code
inside client\-side browsers via Adobe Flash.
.SS Mitigation
.sp
Upgrade to a supported CouchDB release that includes this fix, such as:
.INDENT 0.0
.IP \(bu 2
\fI\%1.0.4\fP
.IP \(bu 2
\fI\%1.1.2\fP
.IP \(bu 2
\fI\%1.2.1\fP
.IP \(bu 2
\fI\%1.3.x\fP
.UNINDENT
.sp
All listed releases have included a specific fix.
.SS Work\-Around
.sp
Disable JSONP or don’t enable it since it’s disabled by default.
.SS CVE\-2012\-5650: DOM based Cross\-Site Scripting via Futon UI
.INDENT 0.0
.TP
.B Date
14.01.2013
.TP
.B Affected
Apache CouchDB releases up to and including 1.0.3, 1.1.1,
and 1.2.0 are vulnerable.
.TP
.B Severity
Moderate
.TP
.B Vendor
The Apache Software Foundation
.UNINDENT
.SS Description
.sp
Query parameters passed into the browser\-based test suite are not sanitised,
and can be used to load external resources. An attacker may execute JavaScript
code in the browser, using the context of the remote user.
.SS Mitigation
.sp
Upgrade to a supported CouchDB release that includes this fix, such as:
.INDENT 0.0
.IP \(bu 2
\fI\%1.0.4\fP
.IP \(bu 2
\fI\%1.1.2\fP
.IP \(bu 2
\fI\%1.2.1\fP
.IP \(bu 2
\fI\%1.3.x\fP
.UNINDENT
.sp
All listed releases have included a specific fix.
.SS Work\-Around
.sp
Disable the Futon user interface completely, by adapting \fIlocal.ini\fP and
restarting CouchDB:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[httpd_global_handlers]
_utils = {couch_httpd_misc_handlers, handle_welcome_req, <<\(dqForbidden\(dq>>}
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Or by removing the UI test suite components:
.INDENT 0.0
.IP \(bu 2
share/www/verify_install.html
.IP \(bu 2
share/www/couch_tests.html
.IP \(bu 2
share/www/custom_test.html
.UNINDENT
.SS Acknowledgement
.sp
This vulnerability was discovered & reported to the Apache Software Foundation
by \fI\%Frederik Braun\fP\&.
.SS CVE\-2014\-2668: DoS (CPU and memory consumption) via the count parameter to /_uuids
.INDENT 0.0
.TP
.B Date
26.03.2014
.TP
.B Affected
Apache CouchDB releases up to and including 1.3.1, 1.4.0,
and 1.5.0 are vulnerable.
.TP
.B Severity
Moderate
.TP
.B Vendor
The Apache Software Foundation
.UNINDENT
.SS Description
.sp
The \fI\%/_uuids\fP resource’s \fIcount\fP query parameter is able to take
unreasonable huge numeric value which leads to exhaustion of server resources
(CPU and memory) and to DoS as the result.
.SS Mitigation
.sp
Upgrade to a supported CouchDB release that includes this fix, such as:
.INDENT 0.0
.IP \(bu 2
\fI\%1.5.1\fP
.IP \(bu 2
\fI\%1.6.0\fP
.UNINDENT
.sp
All listed releases have included a specific fix to
.SS Work\-Around
.sp
Disable the \fI\%/_uuids\fP handler completely, by adapting
\fIlocal.ini\fP and restarting CouchDB:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[httpd_global_handlers]
_uuids =
.ft P
.fi
.UNINDENT
.UNINDENT
.SS CVE\-2017\-12635: Apache CouchDB Remote Privilege Escalation
.INDENT 0.0
.TP
.B Date
14.11.2017
.TP
.B Affected
All Versions of Apache CouchDB
.TP
.B Severity
Critical
.TP
.B Vendor
The Apache Software Foundation
.UNINDENT
.SS Description
.sp
Due to differences in CouchDB’s Erlang\-based JSON parser and JavaScript\-based
JSON parser, it is possible to submit _users documents with duplicate keys for
\fIroles\fP used for access control within the database, including the special case
\fI_admin\fP role, that denotes administrative users. In combination with
\fI\%CVE\-2017\-12636\fP (Remote Code Execution), this can be used
to give non\-admin users access to arbitrary shell commands on the server as the
database system user.
.SS Mitigation
.sp
All users should upgrade to CouchDB \fI\%1.7.1\fP or
\fI\%2.1.1\fP\&.
.sp
Upgrades from previous 1.x and 2.x versions in the same series should be
seamless.
.sp
Users on earlier versions, or users upgrading from 1.x to 2.x should consult
with upgrade notes.
.SS Example
.sp
The JSON parser differences result in behaviour that if two \fIroles\fP keys
are available in the JSON, the second one will be used for authorising the
document write, but the first \fIroles\fP key is used for subsequent authorisation
for the newly created user. By design, users can not assign themselves roles.
The vulnerability allows non\-admin users to give themselves admin privileges.
.sp
We addressed this issue by updating the way CouchDB parses JSON in Erlang,
mimicking the JavaScript behaviour of picking the last key, if duplicates exist.
.SS Credit
.sp
This issue was discovered by \fI\%Max Justicz\fP\&.
.SS CVE\-2017\-12636: Apache CouchDB Remote Code Execution
.INDENT 0.0
.TP
.B Date
14.11.2017
.TP
.B Affected
All Versions of Apache CouchDB
.TP
.B Severity
Critical
.TP
.B Vendor
The Apache Software Foundation
.UNINDENT
.SS Description
.sp
CouchDB administrative users can configure the database server via HTTP(S). Some
of the configuration options include paths for operating system\-level binaries
that are subsequently launched by CouchDB. This allows a CouchDB admin user to
execute arbitrary shell commands as the CouchDB user, including downloading
and executing scripts from the public internet.
.SS Mitigation
.sp
All users should upgrade to CouchDB \fI\%1.7.1\fP or
\fI\%2.1.1\fP\&.
.sp
Upgrades from previous 1.x and 2.x versions in the same series should be
seamless.
.sp
Users on earlier versions, or users upgrading from 1.x to 2.x should consult
with upgrade notes.
.SS Credit
.sp
This issue was discovered by \fI\%Joan Touzet\fP of the CouchDB Security team during
the investigation of \fI\%CVE\-2017\-12635\fP\&.
.SS CVE\-2018\-11769: Apache CouchDB Remote Code Execution
.INDENT 0.0
.TP
.B Date
08.08.2018
.TP
.B Affected
Apache CouchDB 1.x and ≤2.1.2
.TP
.B Severity
Low
.TP
.B Vendor
The Apache Software Foundation
.UNINDENT
.SS Description
.sp
CouchDB administrative users can configure the database server via HTTP(S). Due
to insufficient validation of administrator\-supplied configuration settings via
the HTTP API, it is possible for a CouchDB administrator user to escalate their
privileges to that of the operating system’s user under which CouchDB runs, by
bypassing the blacklist of configuration settings that are not allowed to be
modified via the HTTP API.
.sp
This privilege escalation effectively allows a CouchDB admin user to gain
arbitrary remote code execution, bypassing mitigations for
\fI\%CVE\-2017\-12636\fP and \fI\%CVE\-2018\-8007\fP\&.
.SS Mitigation
.sp
All users should upgrade to CouchDB \fI\%2.2.0\fP\&.
.sp
Upgrades from previous 2.x versions in the same series should be seamless.
.sp
Users still on CouchDB 1.x should be advised that the Apache CouchDB team no
longer support 1.x.
.sp
In\-place mitigation (on any 1.x release, or 2.x prior to 2.2.0) is possible by
removing the \fB_config\fP route from the \fBdefault.ini\fP file, as follows:
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[httpd_global_handlers]
;_config = {couch_httpd_misc_handlers, handle_config_req}
.ft P
.fi
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.sp
or by blocking access to the \fI/_config\fP (1.x) or \fI/_node/*/_config\fP routes at a reverse
proxy in front of the service.
.SS CVE\-2018\-17188: Apache CouchDB Remote Privilege Escalations
.INDENT 0.0
.TP
.B Date
17.12.2018
.TP
.B Affected
All Versions of Apache CouchDB
.TP
.B Severity
Medium
.TP
.B Vendor
The Apache Software Foundation
.UNINDENT
.SS Description
.sp
Prior to CouchDB version 2.3.0, CouchDB allowed for runtime\-configuration of key
components of the database. In some cases, this lead to vulnerabilities where
CouchDB admin users could access the underlying operating system as the CouchDB
user. Together with other vulnerabilities, it allowed full system entry for
unauthenticated users.
.sp
These vulnerabilities were fixed and disclosed in the following CVE reports:
.INDENT 0.0
.IP \(bu 2
\fI\%CVE\-2018\-11769: Apache CouchDB Remote Code Execution\fP
.IP \(bu 2
\fI\%CVE\-2018\-8007: Apache CouchDB Remote Code Execution\fP
.IP \(bu 2
\fI\%CVE\-2017\-12636: Apache CouchDB Remote Code Execution\fP
.IP \(bu 2
\fI\%CVE\-2017\-12635: Apache CouchDB Remote Privilege Escalation\fP
.UNINDENT
.sp
Rather than waiting for new vulnerabilities to be discovered, and fixing them
as they come up, the CouchDB development team decided to make changes to avoid
this entire class of vulnerabilities.
.sp
With CouchDB version 2.3.0, CouchDB no longer can configure key components at
runtime. While some flexibility is needed for speciality configurations of
CouchDB, the configuration was changed from being available at runtime to
start\-up time. And as such now requires shell access to the CouchDB server.
.sp
This closes all future paths for vulnerabilities of this type.
.SS Mitigation
.sp
All users should upgrade to CouchDB \fI\%2.3.0\fP\&.
.sp
Upgrades from previous 2.x versions in the same series should be
seamless.
.sp
Users on earlier versions should consult with upgrade notes.
.SS Credit
.sp
This issue was discovered by the Apple Information Security team.
.SS CVE\-2018\-8007: Apache CouchDB Remote Code Execution
.INDENT 0.0
.TP
.B Date
30.04.2018
.TP
.B Affected
All Versions of Apache CouchDB
.TP
.B Severity
Low
.TP
.B Vendor
The Apache Software Foundation
.UNINDENT
.SS Description
.sp
CouchDB administrative users can configure the database server via HTTP(S). Due
to insufficient validation of administrator\-supplied configuration settings via
the HTTP API, it is possible for a CouchDB administrator user to escalate their
privileges to that of the operating system’s user that CouchDB runs under, by
bypassing the backlist of configuration settings that are not allowed to be
modified via the HTTP API.
.sp
This privilege escalation effectively allows a CouchDB admin user to gain
arbitrary remote code execution, bypassing
\fI\%CVE\-2017\-12636\fP
.SS Mitigation
.sp
All users should upgrade to CouchDB \fI\%1.7.2\fP or
\fI\%2.1.2\fP\&.
.sp
Upgrades from previous 1.x and 2.x versions in the same series should be
seamless.
.sp
Users on earlier versions, or users upgrading from 1.x to 2.x should consult
with upgrade notes.
.SS Credit
.sp
This issue was discovered by Francesco Oddo of \fI\%MDSec Labs\fP\&.
.SS CVE\-2020\-1955: Apache CouchDB Remote Privilege Escalation
.INDENT 0.0
.TP
.B Date
19.05.2020
.TP
.B Affected
3.0.0
.TP
.B Severity
Medium
.TP
.B Vendor
The Apache Software Foundation
.UNINDENT
.SS Description
.sp
CouchDB version 3.0.0 shipped with a new configuration setting that
governs access control to the entire database server called
\fIrequire_valid_user_except_for_up\fP\&. It was meant as an extension to the
long\-standing setting \fIrequire_valid_user\fP, which in turn requires that
any and all requests to CouchDB will have to be made with valid
credentials, effectively forbidding any anonymous requests.
.sp
The new \fIrequire_valid_user_except_for_up\fP is an off\-by\-default setting
that was meant to allow requiring valid credentials for all endpoints
except for the \fI/_up\fP endpoint.
.sp
However, the implementation of this made an error that lead to not
enforcing credentials on any endpoint, when enabled.
.sp
CouchDB versions \fI\%3.0.1\fP and \fI\%3.1.0\fP fix this issue.
.SS Mitigation
.sp
Users who have not enabled \fIrequire_valid_user_except_for_up\fP are not
affected.
.sp
Users who have it enabled can either disable it again, or upgrade to
CouchDB versions \fI\%3.0.1\fP and \fI\%3.1.0\fP
.SS Credit
.sp
This issue was discovered by Stefan Klein.
.SS CVE\-2021\-38295: Apache CouchDB Privilege Escalation
.INDENT 0.0
.TP
.B Date
12.10.2021
.TP
.B Affected
3.1.1 and below
.TP
.B Severity
Low
.TP
.B Vendor
The Apache Software Foundation
.UNINDENT
.SS Description
.sp
A malicious user with permission to create documents in a database is able
to attach a HTML attachment to a document. If a CouchDB admin opens that
attachment in a browser, e.g. via the CouchDB admin interface Fauxton,
any JavaScript code embedded in that HTML attachment will be executed within
the security context of that admin. A similar route is available with the
already deprecated \fI_show\fP and \fI_list\fP functionality.
.sp
This \fIprivilege escalation\fP vulnerability allows an attacker to add or remove
data in any database or make configuration changes.
.SS Mitigation
.sp
CouchDB \fI\%3.2.0\fP  and onwards adds \fIContent\-Security\-Policy\fP
headers for all attachment, \fI_show\fP and \fI_list\fP requests. This breaks certain
niche use\-cases and there are configuration options to restore the previous
behaviour for those who need it.
.sp
CouchDB \fI\%3.1.2\fP  defaults to the previous behaviour, but
adds configuration options to turn \fIContent\-Security\-Policy\fP headers on for
all affected requests.
.SS Credit
.sp
This issue was identified by \fI\%Cory Sabol\fP of \fI\%Secure Ideas\fP\&.
.SS CVE\-2022\-24706: Apache CouchDB Remote Privilege Escalation
.INDENT 0.0
.TP
.B Date
25.04.2022
.TP
.B Affected
3.2.1 and below
.TP
.B Severity
Critical
.TP
.B Vendor
The Apache Software Foundation
.UNINDENT
.SS Description
.sp
An attacker can access an improperly secured default installation without
authenticating and gain admin privileges.
.INDENT 0.0
.IP 1. 3
CouchDB opens a random network port, bound to all available interfaces
in anticipation of clustered operation and/or runtime introspection. A
utility process called \fIepmd\fP advertises that random port to the network.
\fIepmd\fP itself listens on a fixed port.
.IP 2. 3
CouchDB packaging previously chose a default \fIcookie\fP value for single\-node
as well as clustered installations. That cookie authenticates any
communication between Erlang nodes.
.UNINDENT
.sp
The \fI\%CouchDB documentation has always made recommendations\fP for properly securing
an installation, but not all users follow the advice.
.sp
We recommend a firewall in front of all CouchDB installations. The full CouchDB api
is available on registered port \fI5984\fP and this is the only port that needs to be
exposed for a single\-node install. Installations that do not expose the separate
distribution port to external access are not vulnerable.
.SS Mitigation
.sp
CouchDB \fI\%3.2.2\fP and onwards will refuse to start with
the former default erlang cookie value of \fImonster\fP\&. Installations that
upgrade to this versions are forced to choose a different value.
.sp
In addition, all binary packages have been updated to bind \fIepmd\fP as well
as the CouchDB distribution port to \fI127.0.0.1\fP and/or \fI::1\fP respectively.
.SS Credit
.sp
This issue was identified by \fI\%Alex Vandiver\fP\&.
.SS CVE\-2023\-26268: Apache CouchDB: Information sharing via couchjs processes
.INDENT 0.0
.TP
.B Date
02.05.2023
.TP
.B Affected
3.3.1 and below, 3.2.2 and below
.TP
.B Severity
Medium
.TP
.B Vendor
The Apache Software Foundation
.UNINDENT
.SS Description
.sp
Design documents with matching document IDs, from databases on the same
cluster, may share a mutable Javascript environment when using these design
document functions:
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.IP \(bu 2
validate_doc_update
.IP \(bu 2
list
.IP \(bu 2
filter
.IP \(bu 2
filter views (using view functions as filters)
.IP \(bu 2
rewrite
.IP \(bu 2
update
.UNINDENT
.UNINDENT
.UNINDENT
.sp
This doesn’t affect map/reduce or search (Dreyfus) index functions.
.SS Mitigation
.sp
CouchDB \fI\%3.3.2\fP and \fI\%3.2.3\fP and
onwards matches Javascript execution processes by database names in addition to
design document IDs when processing the affected design document functions.
.SS Workarounds
.sp
Avoid using design documents from untrusted sources which may attempt to cache
or store data in the Javascript environment.
.SS Credit
.sp
This issue was identified by \fI\%Nick Vatamaniuc\fP
.SH REPORTING NEW SECURITY PROBLEMS WITH APACHE COUCHDB
.sp
The Apache Software Foundation takes a very active stance in eliminating
security problems and denial of service attacks against Apache CouchDB.
.sp
We strongly encourage folks to report such problems to our private security
mailing list first, before disclosing them in a public forum.
.sp
Please note that the security mailing list should only be used for reporting
undisclosed security vulnerabilities in Apache CouchDB and managing the
process of fixing such vulnerabilities. We cannot accept regular bug reports
or other queries at this address. All mail sent to this address that does not
relate to an undisclosed security problem in the Apache CouchDB source code
will be ignored.
.sp
If you need to report a bug that isn’t an undisclosed security vulnerability,
please use the \fI\%bug reporting page\fP\&.
.sp
Questions about:
.INDENT 0.0
.IP \(bu 2
How to configure CouchDB securely
.IP \(bu 2
If a vulnerability applies to your particular application
.IP \(bu 2
Obtaining further information on a published vulnerability
.IP \(bu 2
Availability of patches and/or new releases
.UNINDENT
.sp
should be address to the \fI\%users mailing list\fP\&. Please see the \fI\%mailing
lists page\fP for details of how to subscribe.
.sp
The private security mailing address is: \fI\%security@couchdb.apache.org\fP
.sp
Please read \fI\%how the Apache Software Foundation handles security\fP reports to
know what to expect.
.sp
Note that all networked servers are subject to denial of service attacks,
and we cannot promise magic workarounds to generic problems (such as a client
streaming lots of data to your server, or re\-requesting the same URL
repeatedly). In general our philosophy is to avoid any attacks which can
cause the server to consume resources in a non\-linear relationship to the
size of inputs.
.SH ABOUT COUCHDB DOCUMENTATION
.SS License
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C

                                Apache License
                          Version 2.0, January 2004
                       http://www.apache.org/licenses/

  TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION

  1. Definitions.

     \(dqLicense\(dq shall mean the terms and conditions for use, reproduction,
     and distribution as defined by Sections 1 through 9 of this document.

     \(dqLicensor\(dq shall mean the copyright owner or entity authorized by
     the copyright owner that is granting the License.

     \(dqLegal Entity\(dq shall mean the union of the acting entity and all
     other entities that control, are controlled by, or are under common
     control with that entity. For the purposes of this definition,
     \(dqcontrol\(dq means (i) the power, direct or indirect, to cause the
     direction or management of such entity, whether by contract or
     otherwise, or (ii) ownership of fifty percent (50%) or more of the
     outstanding shares, or (iii) beneficial ownership of such entity.

     \(dqYou\(dq (or \(dqYour\(dq) shall mean an individual or Legal Entity
     exercising permissions granted by this License.

     \(dqSource\(dq form shall mean the preferred form for making modifications,
     including but not limited to software source code, documentation
     source, and configuration files.

     \(dqObject\(dq form shall mean any form resulting from mechanical
     transformation or translation of a Source form, including but
     not limited to compiled object code, generated documentation,
     and conversions to other media types.

     \(dqWork\(dq shall mean the work of authorship, whether in Source or
     Object form, made available under the License, as indicated by a
     copyright notice that is included in or attached to the work
     (an example is provided in the Appendix below).

     \(dqDerivative Works\(dq shall mean any work, whether in Source or Object
     form, that is based on (or derived from) the Work and for which the
     editorial revisions, annotations, elaborations, or other modifications
     represent, as a whole, an original work of authorship. For the purposes
     of this License, Derivative Works shall not include works that remain
     separable from, or merely link (or bind by name) to the interfaces of,
     the Work and Derivative Works thereof.

     \(dqContribution\(dq shall mean any work of authorship, including
     the original version of the Work and any modifications or additions
     to that Work or Derivative Works thereof, that is intentionally
     submitted to Licensor for inclusion in the Work by the copyright owner
     or by an individual or Legal Entity authorized to submit on behalf of
     the copyright owner. For the purposes of this definition, \(dqsubmitted\(dq
     means any form of electronic, verbal, or written communication sent
     to the Licensor or its representatives, including but not limited to
     communication on electronic mailing lists, source code control systems,
     and issue tracking systems that are managed by, or on behalf of, the
     Licensor for the purpose of discussing and improving the Work, but
     excluding communication that is conspicuously marked or otherwise
     designated in writing by the copyright owner as \(dqNot a Contribution.\(dq

     \(dqContributor\(dq shall mean Licensor and any individual or Legal Entity
     on behalf of whom a Contribution has been received by Licensor and
     subsequently incorporated within the Work.

  2. Grant of Copyright License. Subject to the terms and conditions of
     this License, each Contributor hereby grants to You a perpetual,
     worldwide, non\-exclusive, no\-charge, royalty\-free, irrevocable
     copyright license to reproduce, prepare Derivative Works of,
     publicly display, publicly perform, sublicense, and distribute the
     Work and such Derivative Works in Source or Object form.

  3. Grant of Patent License. Subject to the terms and conditions of
     this License, each Contributor hereby grants to You a perpetual,
     worldwide, non\-exclusive, no\-charge, royalty\-free, irrevocable
     (except as stated in this section) patent license to make, have made,
     use, offer to sell, sell, import, and otherwise transfer the Work,
     where such license applies only to those patent claims licensable
     by such Contributor that are necessarily infringed by their
     Contribution(s) alone or by combination of their Contribution(s)
     with the Work to which such Contribution(s) was submitted. If You
     institute patent litigation against any entity (including a
     cross\-claim or counterclaim in a lawsuit) alleging that the Work
     or a Contribution incorporated within the Work constitutes direct
     or contributory patent infringement, then any patent licenses
     granted to You under this License for that Work shall terminate
     as of the date such litigation is filed.

  4. Redistribution. You may reproduce and distribute copies of the
     Work or Derivative Works thereof in any medium, with or without
     modifications, and in Source or Object form, provided that You
     meet the following conditions:

     (a) You must give any other recipients of the Work or
         Derivative Works a copy of this License; and

     (b) You must cause any modified files to carry prominent notices
         stating that You changed the files; and

     (c) You must retain, in the Source form of any Derivative Works
         that You distribute, all copyright, patent, trademark, and
         attribution notices from the Source form of the Work,
         excluding those notices that do not pertain to any part of
         the Derivative Works; and

     (d) If the Work includes a \(dqNOTICE\(dq text file as part of its
         distribution, then any Derivative Works that You distribute must
         include a readable copy of the attribution notices contained
         within such NOTICE file, excluding those notices that do not
         pertain to any part of the Derivative Works, in at least one
         of the following places: within a NOTICE text file distributed
         as part of the Derivative Works; within the Source form or
         documentation, if provided along with the Derivative Works; or,
         within a display generated by the Derivative Works, if and
         wherever such third\-party notices normally appear. The contents
         of the NOTICE file are for informational purposes only and
         do not modify the License. You may add Your own attribution
         notices within Derivative Works that You distribute, alongside
         or as an addendum to the NOTICE text from the Work, provided
         that such additional attribution notices cannot be construed
         as modifying the License.

     You may add Your own copyright statement to Your modifications and
     may provide additional or different license terms and conditions
     for use, reproduction, or distribution of Your modifications, or
     for any such Derivative Works as a whole, provided Your use,
     reproduction, and distribution of the Work otherwise complies with
     the conditions stated in this License.

  5. Submission of Contributions. Unless You explicitly state otherwise,
     any Contribution intentionally submitted for inclusion in the Work
     by You to the Licensor shall be under the terms and conditions of
     this License, without any additional terms or conditions.
     Notwithstanding the above, nothing herein shall supersede or modify
     the terms of any separate license agreement you may have executed
     with Licensor regarding such Contributions.

  6. Trademarks. This License does not grant permission to use the trade
     names, trademarks, service marks, or product names of the Licensor,
     except as required for reasonable and customary use in describing the
     origin of the Work and reproducing the content of the NOTICE file.

  7. Disclaimer of Warranty. Unless required by applicable law or
     agreed to in writing, Licensor provides the Work (and each
     Contributor provides its Contributions) on an \(dqAS IS\(dq BASIS,
     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
     implied, including, without limitation, any warranties or conditions
     of TITLE, NON\-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
     PARTICULAR PURPOSE. You are solely responsible for determining the
     appropriateness of using or redistributing the Work and assume any
     risks associated with Your exercise of permissions under this License.

  8. Limitation of Liability. In no event and under no legal theory,
     whether in tort (including negligence), contract, or otherwise,
     unless required by applicable law (such as deliberate and grossly
     negligent acts) or agreed to in writing, shall any Contributor be
     liable to You for damages, including any direct, indirect, special,
     incidental, or consequential damages of any character arising as a
     result of this License or out of the use or inability to use the
     Work (including but not limited to damages for loss of goodwill,
     work stoppage, computer failure or malfunction, or any and all
     other commercial damages or losses), even if such Contributor
     has been advised of the possibility of such damages.

  9. Accepting Warranty or Additional Liability. While redistributing
     the Work or Derivative Works thereof, You may choose to offer,
     and charge a fee for, acceptance of support, warranty, indemnity,
     or other liability obligations and/or rights consistent with this
     License. However, in accepting such obligations, You may act only
     on Your own behalf and on Your sole responsibility, not on behalf
     of any other Contributor, and only if You agree to indemnify,
     defend, and hold each Contributor harmless for any liability
     incurred by, or claims asserted against, such Contributor by reason
     of your accepting any such warranty or additional liability.

  END OF TERMS AND CONDITIONS

  APPENDIX: How to apply the Apache License to your work.

     To apply the Apache License to your work, attach the following
     boilerplate notice, with the fields enclosed by brackets \(dq[]\(dq
     replaced with your own identifying information. (Don\(aqt include
     the brackets!)  The text should be enclosed in the appropriate
     comment syntax for the file format. We also recommend that a
     file or class name and description of purpose be included on the
     same \(dqprinted page\(dq as the copyright notice for easier
     identification within third\-party archives.

  Copyright 2020 The Apache Foundation

  Licensed under the Apache License, Version 2.0 (the \(dqLicense\(dq);
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE\-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an \(dqAS IS\(dq BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

.ft P
.fi
.UNINDENT
.UNINDENT
.SH CONTRIBUTING TO THIS DOCUMENTATION
.sp
The documentation lives in its own source tree. We’ll start by forking and
cloning the CouchDB documentation GitHub mirror. That will allow us to send the
contribution to CouchDB with a pull request.
.sp
If you don’t have a GitHub account yet, it is a good time to get one, they are
free. If you don’t want to use GitHub, there are alternate ways to
contributing back, that we’ll cover next time.
.sp
Go to \fI\%https://github.com/apache/couchdb\fP and click the “fork”
button in the top right. This will create a fork of CouchDB in your GitHub
account. If your account is \fIusername\fP, your fork lives at
\fI\%https://github.com/username/couchdb\fP\&. In the header, it tells me my
“GitHub Clone URL”. We need to copy that and start a terminal:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ git clone https://github.com/username/couchdb.git
$ cd couchdb/src/docs
$ subl .
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
I’m opening the whole CouchDB documentation source tree in my favourite editor.
It gives me the usual directory listing:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
ebin/
ext/
\&.git/
\&.gitignore
images/
LICENSE
make.bat
Makefile
NOTICE
rebar.config
src/
static/
templates/
themes/
\&.travis.yml
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The documentation sources live in \fIsrc/docs/src\fP, you can safely
ignore all the other files and directories.
.sp
First we should determine where we want to document this inside the
documentation. We can look through \fI\%http://docs.couchdb.org/en/latest/\fP
for inspiration. The \fI\%JSON Structure Reference\fP looks like a fine place to
write this up.
.sp
The current state includes mostly tables describing the JSON structure (after
all, that’s the title of this chapter), but some prose about the number
representation can’t hurt. For future reference, since the topic in the thread
includes views and different encoding in views (as opposed to the storage
engine), we should remember to make a note in the views documentation as well,
but we’ll leave this for later.
.sp
Let’s try and find the source file that builds the file
\fI\%http://docs.couchdb.org/en/latest/json\-structure.html\fP – we are in luck, under
\fIshare/doc/src\fP we find the file \fIjson\-structure.rst\fP\&. That looks promising.
\fI\&.rst\fP stands for ReStructured Text (see
\fI\%http://thomas\-cokelaer.info/tutorials/sphinx/rest_syntax.html\fP
for a markup reference), which is an ASCII format for writing
documents, documentation in this case. Let’s have a look and open it.
.sp
We see ASCII tables with some additional formatting, all looking like the
final HTML. So far so easy. For now, let’s just add to the bottom of this. We
can worry about organising this better later.
.sp
We start by adding a new headline:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
Number Handling
===============
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Now we paste in the rest of the main email of the thread. It is mostly text,
but it includes some code listings. Let’s mark them up. We’ll turn:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
ejson:encode(ejson:decode(<<\(dq1.1\(dq>>)).
<<\(dq1.1000000000000000888\(dq>>
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Into:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\&.. code\-block:: erlang

    ejson:encode(ejson:decode(<<\(dq1.1\(dq>>)).
    <<\(dq1.1000000000000000888\(dq>>
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
And we follow along with the other code samples. We turn:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
Spidermonkey

$ js \-h 2>&1 | head \-n 1
JavaScript\-C 1.8.5 2011\-03\-31
$ js
js> JSON.stringify(JSON.parse(\(dq1.01234567890123456789012345678901234567890\(dq))
\(dq1.0123456789012346\(dq
js> var f = JSON.stringify(JSON.parse(\(dq1.01234567890123456789012345678901234567890\(dq))
js> JSON.stringify(JSON.parse(f))
\(dq1.0123456789012346\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
into:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
Spidermonkey::

    $ js \-h 2>&1 | head \-n 1
    JavaScript\-C 1.8.5 2011\-03\-31
    $ js
    js> JSON.stringify(JSON.parse(\(dq1.01234567890123456789012345678901234567890\(dq))
    \(dq1.0123456789012346\(dq
    js> var f = JSON.stringify(JSON.parse(\(dq1.01234567890123456789012345678901234567890\(dq))
    js> JSON.stringify(JSON.parse(f))
    \(dq1.0123456789012346\(dq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
And then follow all the other ones.
.sp
I cleaned up the text a little but to make it sound more like a documentation
entry as opposed to a post on a mailing list.
.sp
The next step would be to validate that we got all the markup right. I’ll
leave this for later. For now we’ll contribute our change back to CouchDB.
.sp
First, we commit our changes:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ > git commit \-am \(aqdocument number encoding\(aq
[main a84b2cf] document number encoding
1 file changed, 199 insertions(+)
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Then we push the commit to our CouchDB fork:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ git push origin main
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Next, we go back to our GitHub page
\fI\%https://github.com/username/couchdb\fP and click the “Pull Request”
button. Fill in the description with something useful and hit the
“Send Pull Request” button.
.sp
And we’re done!
.SS Style Guidelines for this Documentation
.sp
When you make a change to the documentation, you should make sure that you
follow the style. Look through some files and you will see that the style is
quite straightforward. If you do not know if your formatting is in compliance
with the style, ask yourself the following question:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
Is it needed for correct syntax?
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
If the answer is \fBNo.\fP then it is probably not.
.sp
These guidelines strive be simple, without contradictions and exceptions. The
best style is the one that is followed because it seems to be the natural way of
doing it.
.SS The guidelines
.sp
The guidelines are in descending priority.
.INDENT 0.0
.IP 1. 3
Syntax
.INDENT 3.0
.IP \(bu 2
Correct syntax is always more important than style. This includes
configuration files, HTML responses, etc.
.UNINDENT
.IP 2. 3
Encoding
.INDENT 3.0
.IP \(bu 2
All files are \fBUTF\-8\fP\&.
.UNINDENT
.IP 3. 3
Line ending
.INDENT 3.0
.IP \(bu 2
All lines end with \fB\en\fP\&.
.IP \(bu 2
No trailing whitespace.
.UNINDENT
.IP 4. 3
Line length
.INDENT 3.0
.IP \(bu 2
The maximum line length is \fB90\fP characters.
.UNINDENT
.IP 5. 3
Links
.INDENT 3.0
.IP \(bu 2
All internal links are relative.
.UNINDENT
.IP 6. 3
Indentation
.INDENT 3.0
.IP \(bu 2
\fB4\fP spaces.
.UNINDENT
.IP 7. 3
Titles
.INDENT 3.0
.IP \(bu 2
The highest level titles in a file is over and underlined with \fB=\fP\&.
.IP \(bu 2
Lower level titles are underlined with the following characters in
descending order:
.INDENT 3.0
.INDENT 3.5
.sp
.nf
.ft C
= \- ^ *  + # \(ga : . \(dq ~ _
.ft P
.fi
.UNINDENT
.UNINDENT
.IP \(bu 2
Over and underline match the title length.
.UNINDENT
.IP 8. 3
Empty lines
.INDENT 3.0
.IP \(bu 2
No empty line at the end of the file.
.IP \(bu 2
Lists may separated each item with an empty line.
.UNINDENT
.UNINDENT
.SH AUTHOR
unknown
.SH COPYRIGHT
2023, Apache Software Foundation. CouchDB® is a registered trademark of the Apache Software Foundation
.\" Generated by docutils manpage writer.
.
